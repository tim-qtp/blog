---
order: 1
author: 
title: "å›¾ç‰‡ä¸Šä¼ "
category:
  - äº‘å›¾åº“
  - é¡¹ç›®

---

### 1ã€ä½¿ç”¨è…¾è®¯äº‘å¯¹è±¡å­˜å‚¨ï¼ˆCOSï¼‰

1ï¼‰å¼•å…¥ COS ä¾èµ–ï¼š

```xml
<!-- è…¾è®¯äº‘ cos æœåŠ¡ -->  
<dependency>  
    <groupId>com.qcloud</groupId>  
    <artifactId>cos_api</artifactId>  
    <version>5.6.227</version>  
</dependency>
```

2ï¼‰åœ¨é¡¹ç›®çš„ `config` åŒ…ä¸‹æ–°å»º `CosClientConfig` ç±»ã€‚è´Ÿè´£è¯»å–é…ç½®æ–‡ä»¶ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª COS å®¢æˆ·ç«¯çš„ Beanã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
@Configuration  
@ConfigurationProperties(prefix = "cos.client")  
@Data  
public class CosClientConfig {  
  
    /**  
     * åŸŸå  
     */  
    private String host;  
  
    /**  
     * secretId  
     */  
    private String secretId;  
  
    /**  
     * å¯†é’¥ï¼ˆæ³¨æ„ä¸è¦æ³„éœ²ï¼‰  
     */  
    private String secretKey;  
  
    /**  
     * åŒºåŸŸ  
     */  
    private String region;  
  
    /**  
     * æ¡¶å  
     */  
    private String bucket;  
  
    @Bean  
    public COSClient cosClient() {  
        // åˆå§‹åŒ–ç”¨æˆ·èº«ä»½ä¿¡æ¯(secretId, secretKey)  
        COSCredentials cred = new BasicCOSCredentials(secretId, secretKey);  
        // è®¾ç½®bucketçš„åŒºåŸŸ, COSåœ°åŸŸçš„ç®€ç§°è¯·å‚ç…§ https://www.qcloud.com/document/product/436/6224  
        ClientConfig clientConfig = new ClientConfig(new Region(region));  
        // ç”Ÿæˆcoså®¢æˆ·ç«¯  
        return new COSClient(cred, clientConfig);  
    }  
```

3ï¼‰å¡«å†™é…ç½®æ–‡ä»¶ã€‚

**ä¸€å®šè¦æ³¨æ„é˜²æ­¢å¯†ç æ³„éœ²ï¼** æ‰€ä»¥æˆ‘ä»¬æ–°å»º `application-local.yml` æ–‡ä»¶ï¼Œå¹¶ä¸”åœ¨ `.gitignore` ä¸­å¿½ç•¥è¯¥æ–‡ä»¶çš„æäº¤ï¼Œè¿™æ ·å°±ä¸ä¼šå°†ä»£ç ç­‰æ•æ„Ÿé…ç½®æäº¤åˆ°ä»£ç ä»“åº“äº†ã€‚

<img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503182150556.png" alt="image-20250318215046319" style="zoom:50%;" />

`application-local.yml` é…ç½®ä»£ç å¦‚ä¸‹ï¼š

```yaml
# å¯¹è±¡å­˜å‚¨é…ç½®ï¼ˆéœ€è¦ä»è…¾è®¯äº‘è·å–ï¼‰  
cos:  
  client:  
    host: xxx  
    secretId: xxx  
    secretKey: xxx  
    region: xxx  
    bucket: xxx
```

å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼åˆ†åˆ«è·å–éœ€è¦çš„é…ç½®ã€‚

host ä¸ºå­˜å‚¨æ¡¶åŸŸåï¼Œå¯ä»¥åœ¨ COS æ§åˆ¶å°çš„åŸŸåä¿¡æ¯éƒ¨åˆ†æ‰¾åˆ°ï¼š

secretIdã€secretKey å¯†é’¥å¯¹ï¼šåœ¨[è…¾è®¯äº‘è®¿é—®ç®¡ç†](https://console.cloud.tencent.com/cam/capi) => å¯†é’¥ç®¡ç†ä¸­è·å–ã€‚

region è¡¨ç¤ºåœ°åŸŸåï¼Œå¯ä»¥ [ç‚¹æ­¤è·å–](https://cloud.tencent.com/document/product/436/6224)ã€‚3n/Enp4sfaVRq/PFMJKPxPdBTxeNas/Bp33wsl/l9Wg=

bucket æ˜¯å­˜å‚¨æ¡¶åï¼Œå¯ä»¥ç‚¹è¿›å­˜å‚¨æ¡¶è¯¦æƒ…é¡µè·å–

### 2ã€é€šç”¨èƒ½åŠ›ç±»

åœ¨ `manager` åŒ…ä¸‹æ–°å»º `CosManager` ç±»ï¼Œæä¾›é€šç”¨çš„å¯¹è±¡å­˜å‚¨æ“ä½œï¼Œæ¯”å¦‚æ–‡ä»¶ä¸Šä¼ ã€æ–‡ä»¶ä¸‹è½½ç­‰ã€‚

ğŸ’¡ Manager ä¹Ÿæ˜¯äººä¸ºçº¦å®šçš„ä¸€ç§å†™æ³•ï¼Œè¡¨ç¤ºé€šç”¨çš„ã€å¯å¤ç”¨çš„èƒ½åŠ›ï¼Œå¯ä¾›å…¶ä»–ä»£ç ï¼ˆæ¯”å¦‚ Serviceï¼‰è°ƒç”¨ã€‚

è¯¥ç±»éœ€è¦å¼•å…¥å¯¹è±¡å­˜å‚¨é…ç½®å’Œ COS å®¢æˆ·ç«¯ï¼Œç”¨äºå’Œ COS è¿›è¡Œäº¤äº’ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
@Component  
public class CosManager {  
  
    @Resource  
    private CosClientConfig cosClientConfig;  
  
    @Resource  
    private COSClient cosClient;  
  
    // ... ä¸€äº›æ“ä½œ COS çš„æ–¹æ³•  
}
```

### 3ã€æ–‡ä»¶ä¸Šä¼ ä¸‹è½½

å‚è€ƒ [å®˜æ–¹æ–‡æ¡£](https://cloud.tencent.com/document/product/436/65935) çš„â€œä¸Šä¼ å¯¹è±¡â€éƒ¨åˆ†ï¼Œå¯ä»¥ç¼–å†™å‡ºæ–‡ä»¶ä¸Šä¼ çš„ä»£ç ã€‚

1ï¼‰`CosManager` æ–°å¢ä¸Šä¼ ã€ä¸‹è½½å¯¹è±¡çš„æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
/**  
 * ä¸Šä¼ å¯¹è±¡  
 *  
 * @param key  å”¯ä¸€é”®  
 * @param file æ–‡ä»¶  
 */  
public PutObjectResult putObject(String key, File file) {  
    PutObjectRequest putObjectRequest = new PutObjectRequest(cosClientConfig.getBucket(), key,  
            file);  
    return cosClient.putObject(putObjectRequest);  
}

/**
 * ä¸‹è½½å¯¹è±¡
 *
 * @param key å”¯ä¸€é”®
*/
public COSObject getObject(String key) {
    GetObjectRequest getObjectRequest = new GetObjectRequest(cosClientConfig.getBucket(), key);
    return cosClient.getObject(getObjectRequest);
}
```

2ï¼‰ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œåœ¨ `FileController` ä¸­ç¼–å†™æµ‹è¯•æ–‡ä»¶ä¸Šä¼ æ¥å£ã€‚

æ ¸å¿ƒæµç¨‹æ˜¯å…ˆæ¥å—ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ï¼ŒæŒ‡å®šä¸Šä¼ çš„è·¯å¾„ï¼Œç„¶åè°ƒç”¨ `cosManager.putObject` æ–¹æ³•ä¸Šä¼ æ–‡ä»¶åˆ° COS å¯¹è±¡å­˜å‚¨ï¼›ä¸Šä¼ æˆåŠŸåï¼Œä¼šè¿”å›ä¸€ä¸ªæ–‡ä»¶çš„ keyï¼ˆå…¶å®å°±æ˜¯æ–‡ä»¶è·¯å¾„ï¼‰ï¼Œä¾¿äºæˆ‘ä»¬è®¿é—®å’Œä¸‹è½½æ–‡ä»¶ã€‚

**éœ€è¦æ³¨æ„ï¼Œæµ‹è¯•æ¥å£ä¸€å®šè¦åŠ ä¸Šç®¡ç†å‘˜æƒé™ï¼é˜²æ­¢ä»»ä½•ç”¨æˆ·éšæ„ä¸Šä¼ æ–‡ä»¶ã€‚**

æµ‹è¯•æ–‡ä»¶ä¸Šä¼ æ¥å£ä»£ç å¦‚ä¸‹ï¼š

```java
/**  
 * æµ‹è¯•æ–‡ä»¶ä¸Šä¼   
 *  
 * @param multipartFile  
 * @return  
 */  
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)  
@PostMapping("/test/upload")  
public BaseResponse<String> testUploadFile(@RequestPart("file") MultipartFile multipartFile) {  
    // æ–‡ä»¶ç›®å½•  
    String filename = multipartFile.getOriginalFilename();  
    String filepath = String.format("/test/%s", filename);  
    File file = null;  
    try {  
        // ä¸Šä¼ æ–‡ä»¶  
        file = File.createTempFile(filepath, null);  
        multipartFile.transferTo(file);  
        cosManager.putObject(filepath, file);  
        // è¿”å›å¯è®¿é—®åœ°å€  
        return ResultUtils.success(filepath);  
    } catch (Exception e) {  
        log.error("file upload error, filepath = " + filepath, e);  
        throw new BusinessException(ErrorCode.SYSTEM_ERROR, "ä¸Šä¼ å¤±è´¥");  
    } finally {  
        if (file != null) {  
            // åˆ é™¤ä¸´æ—¶æ–‡ä»¶  
            boolean delete = file.delete();  
            if (!delete) {  
                log.error("file delete error, filepath = {}", filepath);  
            }  
        }  
    }  
}

/**
     * æµ‹è¯•æ–‡ä»¶ä¸‹è½½
     *
     * @param filepath æ–‡ä»¶è·¯å¾„
     * @param response å“åº”å¯¹è±¡
     */
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
@GetMapping("/test/download/")
public void testDownloadFile(String filepath, HttpServletResponse response) throws IOException {
    COSObjectInputStream cosObjectInput = null; //æµæ˜¯è¦å…³é—­çš„ï¼Œæ‰€ä»¥å¾—æå‡ºæ¥
    try {
        COSObject cosObject = cosManager.getObject(filepath);
        cosObjectInput = cosObject.getObjectContent(); //å¾—åˆ°å®é™…çš„å†…å®¹
        byte[] bytes = IOUtils.toByteArray(cosObjectInput); //è½¬æ¢ä¸ºå­—èŠ‚
        // è®¾ç½®å“åº”å¤´ï¼Œä¼ åˆ°å‰ç«¯ï¼Œå‰ç«¯å°±çŸ¥é“æˆ‘è¦ä¸‹è½½å›¾ç‰‡äº†
        response.setContentType("application/octet-stream;charset=UTF-8");
        response.setHeader("Content-Disposition", "attachment; filename=" + filepath);
        // å†™å…¥å“åº”
        response.getOutputStream().write(bytes);
        response.getOutputStream().flush();
    } catch (Exception e) {
        log.error("file download error, filepath = " + filepath, e);
        throw new BusinessException(ErrorCode.SYSTEM_ERROR, "ä¸‹è½½å¤±è´¥");
    } finally {
        // é‡Šæ”¾æµ
        if (cosObjectInput != null) {
            cosObjectInput.close();
        }
    }
}    
```

### 4ã€å›¾ç‰‡ä¸Šä¼ 

#### 1ã€æ•°æ®æ¨¡å‹

åœ¨ `model.dto.picture` ä¸‹æ–°å»ºç”¨äºæ¥å—è¯·æ±‚å‚æ•°çš„ç±»ã€‚ç”±äºå›¾ç‰‡éœ€è¦æ”¯æŒé‡å¤ä¸Šä¼ ï¼ˆåŸºç¡€ä¿¡æ¯ä¸å˜ï¼Œåªæ”¹å˜å›¾ç‰‡æ–‡ä»¶ï¼‰ï¼Œæ‰€ä»¥è¦æ·»åŠ å›¾ç‰‡ id å‚æ•°ï¼š

```java
@Data  
public class PictureUploadRequest implements Serializable {  
  
    /**  
     * å›¾ç‰‡ idï¼ˆç”¨äºä¿®æ”¹ï¼‰  
     */  
    private Long id;  
  
    private static final long serialVersionUID = 1L;  
}
```

åœ¨ `model.vo` ä¸‹æ–°å»ºä¸Šä¼ æˆåŠŸåè¿”å›ç»™å‰ç«¯çš„å“åº”ç±»ï¼Œè¿™æ˜¯ä¸€ä¸ªè§†å›¾åŒ…è£…ç±»ï¼Œå¯ä»¥é¢å¤–å…³è”ä¸Šä¼ å›¾ç‰‡çš„ç”¨æˆ·ä¿¡æ¯ã€‚è¿˜å¯ä»¥ç¼–å†™ Picture å®ä½“ç±»å’Œè¯¥ VO ç±»çš„è½¬æ¢æ–¹æ³•ï¼Œä¾¿äºåç»­å¿«é€Ÿä¼ å€¼ã€‚

```java
@Data  
public class PictureVO implements Serializable {  
  
    /**  
     * id  
     */  
    private Long id;  
  
    /**  
     * å›¾ç‰‡ url  
     */  
    private String url;  
  
    /**  
     * å›¾ç‰‡åç§°  
     */  
    private String name;  
  
    /**  
     * ç®€ä»‹  
     */  
    private String introduction;  
  
    /**  
     * æ ‡ç­¾  
     */  
    private List<String> tags;  
  
    /**  
     * åˆ†ç±»  
     */  
    private String category;  
  
    /**  
     * æ–‡ä»¶ä½“ç§¯  
     */  
    private Long picSize;  
  
    /**  
     * å›¾ç‰‡å®½åº¦  
     */  
    private Integer picWidth;  
  
    /**  
     * å›¾ç‰‡é«˜åº¦  
     */  
    private Integer picHeight;  
  
    /**  
     * å›¾ç‰‡æ¯”ä¾‹  
     */  
    private Double picScale;  
  
    /**  
     * å›¾ç‰‡æ ¼å¼  
     */  
    private String picFormat;  
  
    /**  
     * ç”¨æˆ· id  
     */  
    private Long userId;  
  
    /**  
     * åˆ›å»ºæ—¶é—´  
     */  
    private Date createTime;  
  
    /**  
     * ç¼–è¾‘æ—¶é—´  
     */  
    private Date editTime;  
  
    /**  
     * æ›´æ–°æ—¶é—´  
     */  
    private Date updateTime;  
  
    /**  
     * åˆ›å»ºç”¨æˆ·ä¿¡æ¯  
     */  
    private UserVO user;  
  
    private static final long serialVersionUID = 1L;  
  
    /**  
     * å°è£…ç±»è½¬å¯¹è±¡  
     */  
    public static Picture voToObj(PictureVO pictureVO) {  
        if (pictureVO == null) {  
            return null;  
        }  
        Picture picture = new Picture();  
        BeanUtils.copyProperties(pictureVO, picture);  
        // ç±»å‹ä¸åŒï¼Œéœ€è¦è½¬æ¢ï¼ˆjsonè½¬strï¼‰
        picture.setTags(JSONUtil.toJsonStr(pictureVO.getTags()));  
        return picture;  
    }  
  
    /**  
     * å¯¹è±¡è½¬å°è£…ç±»  
     */  
    public static PictureVO objToVo(Picture picture) {  
        if (picture == null) {  
            return null;  
        }  
        PictureVO pictureVO = new PictureVO();  
        BeanUtils.copyProperties(picture, pictureVO);  
        // ç±»å‹ä¸åŒï¼Œéœ€è¦è½¬æ¢ï¼ˆstrè½¬jsonï¼‰
        pictureVO.setTags(JSONUtil.toList(picture.getTags(), String.class));  
        return pictureVO;  
    }  
}
```

#### 2ã€é€šç”¨æ–‡ä»¶ä¸Šä¼ æœåŠ¡

ä¹‹å‰è™½ç„¶æˆ‘ä»¬å·²ç»ç¼–å†™äº†é€šç”¨çš„å¯¹è±¡å­˜å‚¨æ“ä½œç±» CosManagerï¼Œä½†è¿™ä¸ªç±»å¹¶ä¸èƒ½ç›´æ¥æ»¡è¶³æˆ‘ä»¬çš„å›¾ç‰‡ä¸Šä¼ éœ€æ±‚ã€‚

æ¯”å¦‚ï¼š

- å›¾ç‰‡æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Ÿéœ€è¦æ ¡éªŒ
- å°†å›¾ç‰‡ä¸Šä¼ åˆ°å“ªé‡Œï¼Ÿéœ€è¦æŒ‡å®šè·¯å¾„
- å¦‚ä½•è§£æå›¾ç‰‡ï¼Ÿéœ€è¦ä½¿ç”¨æ•°æ®ä¸‡è±¡æœåŠ¡

1ï¼‰åœ¨ `model.dto.file` ä¸­æ–°å¢ç”¨äºæ¥å—å›¾ç‰‡è§£æä¿¡æ¯çš„åŒ…è£…ç±»ï¼š

```java
â–¼javaå¤åˆ¶ä»£ç @Data  
public class UploadPictureResult {  
  
    /**  
     * å›¾ç‰‡åœ°å€  
     */  
    private String url;  
  
    /**  
     * å›¾ç‰‡åç§°  
     */  
    private String picName;  
  
    /**  
     * æ–‡ä»¶ä½“ç§¯  
     */  
    private Long picSize;  
  
    /**  
     * å›¾ç‰‡å®½åº¦  
     */  
    private int picWidth;  
  
    /**  
     * å›¾ç‰‡é«˜åº¦  
     */  
    private int picHeight;  
  
    /**  
     * å›¾ç‰‡å®½é«˜æ¯”  
     */  
    private Double picScale;  
  
    /**  
     * å›¾ç‰‡æ ¼å¼  
     */  
    private String picFormat;  
  
}
```

2ï¼‰å‚è€ƒ [æ•°æ®ä¸‡è±¡](https://cloud.tencent.com/document/product/436/55377) çš„æ–‡æ¡£ï¼Œåœ¨ CosManager ä¸­æ·»åŠ ä¸Šä¼ å›¾ç‰‡å¹¶è§£æå›¾ç‰‡çš„æ–¹æ³•ï¼š

å¦‚æœä½ ä¹‹å‰æ²¡æœ‰ä½¿ç”¨è¿‡æ•°æ®ä¸‡è±¡ï¼Œéœ€è¦å…ˆ [å¼€é€šæ•°æ®ä¸‡è±¡å¹¶æˆæƒ](https://console.cloud.tencent.com/ci)ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼š

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503182225764.png)

3ï¼‰åœ¨ FileManager ä¸­ç¼–å†™ä¸Šä¼ å›¾ç‰‡çš„æ–¹æ³•ï¼š

```java
/**  
 * ä¸Šä¼ å›¾ç‰‡  
 *  
 * @param multipartFile    æ–‡ä»¶  
 * @param uploadPathPrefix ä¸Šä¼ è·¯å¾„å‰ç¼€  
 * @return  
 */  
public UploadPictureResult uploadPicture(MultipartFile multipartFile, String uploadPathPrefix) {  
    // æ ¡éªŒå›¾ç‰‡  
    validPicture(multipartFile);  
    // å›¾ç‰‡ä¸Šä¼ åœ°å€  
    String uuid = RandomUtil.randomString(16);  
    String originFilename = multipartFile.getOriginalFilename();  
    String uploadFilename = String.format("%s_%s.%s", DateUtil.formatDate(new Date()), uuid,  
            FileUtil.getSuffix(originFilename));  
    String uploadPath = String.format("/%s/%s", uploadPathPrefix, uploadFilename);  
    File file = null;  
    try {  
        // åˆ›å»ºä¸´æ—¶æ–‡ä»¶  
        file = File.createTempFile(uploadPath, null);  
        multipartFile.transferTo(file);  
        // ä¸Šä¼ å›¾ç‰‡  
        PutObjectResult putObjectResult = cosManager.putPictureObject(uploadPath, file);  
        ImageInfo imageInfo = putObjectResult.getCiUploadResult().getOriginalInfo().getImageInfo();  
        // å°è£…è¿”å›ç»“æœ  
        UploadPictureResult uploadPictureResult = new UploadPictureResult();  
        int picWidth = imageInfo.getWidth();  
        int picHeight = imageInfo.getHeight();  
        double picScale = NumberUtil.round(picWidth * 1.0 / picHeight, 2).doubleValue();  
        uploadPictureResult.setPicName(FileUtil.mainName(originFilename));  
        uploadPictureResult.setPicWidth(picWidth);  
        uploadPictureResult.setPicHeight(picHeight);  
        uploadPictureResult.setPicScale(picScale);  
        uploadPictureResult.setPicFormat(imageInfo.getFormat());  
        uploadPictureResult.setPicSize(FileUtil.size(file));  
        uploadPictureResult.setUrl(cosClientConfig.getHost() + "/" + uploadPath);  
        return uploadPictureResult;  
    } catch (Exception e) {  
        log.error("å›¾ç‰‡ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨å¤±è´¥", e);  
        throw new BusinessException(ErrorCode.SYSTEM_ERROR, "ä¸Šä¼ å¤±è´¥");  
    } finally {  
        this.deleteTempFile(file);  
    }  
}  
  
/**  
 * æ ¡éªŒæ–‡ä»¶  
 *  
 * @param multipartFile multipart æ–‡ä»¶  
 */  
public void validPicture(MultipartFile multipartFile) {  
    ThrowUtils.throwIf(multipartFile == null, ErrorCode.PARAMS_ERROR, "æ–‡ä»¶ä¸èƒ½ä¸ºç©º");  
    // 1. æ ¡éªŒæ–‡ä»¶å¤§å°  
    long fileSize = multipartFile.getSize();  
    final long ONE_M = 1024 * 1024L;  
    ThrowUtils.throwIf(fileSize > 2 * ONE_M, ErrorCode.PARAMS_ERROR, "æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 2M");  
    // 2. æ ¡éªŒæ–‡ä»¶åç¼€  
    String fileSuffix = FileUtil.getSuffix(multipartFile.getOriginalFilename());  
    // å…è®¸ä¸Šä¼ çš„æ–‡ä»¶åç¼€  
    final List<String> ALLOW_FORMAT_LIST = Arrays.asList("jpeg", "jpg", "png", "webp");  
    ThrowUtils.throwIf(!ALLOW_FORMAT_LIST.contains(fileSuffix), ErrorCode.PARAMS_ERROR, "æ–‡ä»¶ç±»å‹é”™è¯¯");  
}  
  
/**  
 * åˆ é™¤ä¸´æ—¶æ–‡ä»¶  
 */  
public void deleteTempFile(File file) {  
    if (file == null) {  
        return;  
    }  
    // åˆ é™¤ä¸´æ—¶æ–‡ä»¶  
    boolean deleteResult = file.delete();  
    if (!deleteResult) {  
        log.error("file delete error, filepath = {}", file.getAbsolutePath());  
    }  
}
```

ä¸Šè¿°ä»£ç ä¸­æœ‰å‡ ä¸ªå®ç°å…³é”®ï¼š

1. ç”±äºæ–‡ä»¶æ ¡éªŒè§„åˆ™è¾ƒå¤æ‚ï¼Œå•ç‹¬æŠ½è±¡ä¸º validPicture æ–¹æ³•ï¼Œå¯¹æ–‡ä»¶å¤§å°ã€ç±»å‹è¿›è¡Œæ ¡éªŒã€‚
2. æ–‡ä»¶ä¸Šä¼ æ—¶ï¼Œä¼šå…ˆåœ¨æœ¬åœ°åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼Œæ— è®ºä¸Šä¼ æ˜¯å¦æˆåŠŸï¼Œéƒ½è¦è®°å¾—åˆ é™¤ä¸´æ—¶æ–‡ä»¶ï¼Œå¦åˆ™ä¼šå¯¼è‡´èµ„æºæ³„éœ²ã€‚
3. å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚å®šä¹‰æ–‡ä»¶ä¸Šä¼ åœ°å€ï¼Œæ¯”å¦‚æ­¤å¤„é±¼çš®ç»™æ–‡ä»¶åå‰å¢åŠ äº†ä¸Šä¼ æ—¥æœŸå’Œ 16 ä½ uuid éšæœºæ•°ï¼Œä¾¿äºäº†è§£æ–‡ä»¶ä¸Šä¼ æ—¶é—´å¹¶é˜²æ­¢æ–‡ä»¶é‡å¤ã€‚è¿˜é¢„ç•™äº†ä¸€ä¸ª uploadPathPrefix å‚æ•°ï¼Œç”±è°ƒç”¨æ–¹æŒ‡å®šä¸Šä¼ æ–‡ä»¶åˆ°å“ªä¸ªç›®å½•ã€‚

ğŸ’¡ å¦‚æœå¤šä¸ªé¡¹ç›®å…±äº«å­˜å‚¨æ¡¶ï¼Œå¯ä»¥ç»™ä¸Šä¼ æ–‡ä»¶è·¯å¾„å†åŠ ä¸€ä¸ª ProjectName å‰ç¼€ã€‚ä¸è¿‡å»ºè®®è¿˜æ˜¯æ¯ä¸ªé¡¹ç›®ç‹¬ç«‹åˆ†é…èµ„æºã€‚

#### 3ã€æœåŠ¡å¼€å‘

åœ¨ PictureService ä¸­ç¼–å†™ä¸Šä¼ å›¾ç‰‡çš„æ–¹æ³•ï¼š

æ¥å£ï¼š

```java
/**  
 * ä¸Šä¼ å›¾ç‰‡  
 *  
 * @param multipartFile  
 * @param pictureUploadRequest  
 * @param loginUser  
 * @return  
 */  
PictureVO uploadPicture(MultipartFile multipartFile,  
                        PictureUploadRequest pictureUploadRequest,  
                        User loginUser);
```

å®ç°ç±»ï¼š

```java
@Override  
public PictureVO uploadPicture(MultipartFile multipartFile, PictureUploadRequest pictureUploadRequest, User loginUser) {  
    ThrowUtils.throwIf(loginUser == null, ErrorCode.NO_AUTH_ERROR);  
    // ç”¨äºåˆ¤æ–­æ˜¯æ–°å¢è¿˜æ˜¯æ›´æ–°å›¾ç‰‡  
    Long pictureId = null;  
    if (pictureUploadRequest != null) {  
        pictureId = pictureUploadRequest.getId();  
    }  
    // å¦‚æœæ˜¯æ›´æ–°å›¾ç‰‡ï¼Œéœ€è¦æ ¡éªŒå›¾ç‰‡æ˜¯å¦å­˜åœ¨  
    if (pictureId != null) {  
        boolean exists = this.lambdaQuery()  
                .eq(Picture::getId, pictureId)  
                .exists();  
        ThrowUtils.throwIf(!exists, ErrorCode.NOT_FOUND_ERROR, "å›¾ç‰‡ä¸å­˜åœ¨");  
    }  
    // ä¸Šä¼ å›¾ç‰‡ï¼Œå¾—åˆ°ä¿¡æ¯  
    // æŒ‰ç…§ç”¨æˆ· id åˆ’åˆ†ç›®å½•  
    String uploadPathPrefix = String.format("public/%s", loginUser.getId());  
    UploadPictureResult uploadPictureResult = fileManager.uploadPicture(multipartFile, uploadPathPrefix);  
    // æ„é€ è¦å…¥åº“çš„å›¾ç‰‡ä¿¡æ¯  
    Picture picture = new Picture();  
    picture.setUrl(uploadPictureResult.getUrl());  
    picture.setName(uploadPictureResult.getPicName());  
    picture.setPicSize(uploadPictureResult.getPicSize());  
    picture.setPicWidth(uploadPictureResult.getPicWidth());  
    picture.setPicHeight(uploadPictureResult.getPicHeight());  
    picture.setPicScale(uploadPictureResult.getPicScale());  
    picture.setPicFormat(uploadPictureResult.getPicFormat());  
    picture.setUserId(loginUser.getId());  
    // å¦‚æœ pictureId ä¸ä¸ºç©ºï¼Œè¡¨ç¤ºæ›´æ–°ï¼Œå¦åˆ™æ˜¯æ–°å¢  
    if (pictureId != null) {  
        // å¦‚æœæ˜¯æ›´æ–°ï¼Œéœ€è¦è¡¥å…… id å’Œç¼–è¾‘æ—¶é—´  
        picture.setId(pictureId);  
        picture.setEditTime(new Date());  
    }  
    boolean result = this.saveOrUpdate(picture);  
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR, "å›¾ç‰‡ä¸Šä¼ å¤±è´¥");  
    return PictureVO.objToVo(picture);  
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œæ³¨æ„ï¼šeSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=3n/Enp4sfaVRq/PFMJKPxPdBTxeNas/Bp33wsl/l9Wg=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=J+5o58b0kn/bTqd/50F76o1L2/PhqvQWrl14ca26WW0=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=

1. æˆ‘ä»¬å°†æ‰€æœ‰å›¾ç‰‡éƒ½æ”¾åˆ°äº† public ç›®å½•ä¸‹ï¼Œå¹¶ä¸”æ¯ä¸ªç”¨æˆ·çš„å›¾ç‰‡å­˜å‚¨åˆ°å¯¹åº”ç”¨æˆ· id çš„ç›®å½•ä¸‹ï¼Œä¾¿äºç®¡ç†ã€‚
2. å¦‚æœ pictureId ä¸ä¸ºç©ºï¼Œè¡¨ç¤ºæ›´æ–°å·²æœ‰å›¾ç‰‡çš„ä¿¡æ¯ï¼Œéœ€è¦åˆ¤æ–­å¯¹åº” id çš„å›¾ç‰‡æ˜¯å¦å­˜åœ¨ï¼Œå¹¶ä¸”æ›´æ–°æ—¶è¦æŒ‡å®š editTime ç¼–è¾‘æ—¶é—´ã€‚å¯ä»¥è°ƒç”¨ MyBatis Plus æä¾›çš„ saveOrUpdate æ–¹æ³•å…¼å®¹åˆ›å»ºå’Œæ›´æ–°æ“ä½œã€‚

#### 4ã€æ¥å£å¼€å‘

åœ¨ PictureController ä¸­ç¼–å†™ä¸Šä¼ å›¾ç‰‡æ¥å£ï¼Œæ³¨æ„ä»…ç®¡ç†å‘˜å¯ç”¨ï¼š

```java
/**  
 * ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é‡æ–°ä¸Šä¼ ï¼‰  
 */  
@PostMapping("/upload")  
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)  
public BaseResponse<PictureVO> uploadPicture(  
        @RequestPart("file") MultipartFile multipartFile,  
        PictureUploadRequest pictureUploadRequest,  
        HttpServletRequest request) {  
    User loginUser = userService.getLoginUser(request);  
    PictureVO pictureVO = pictureService.uploadPicture(multipartFile, pictureUploadRequest, loginUser);  
    return ResultUtils.success(pictureVO);  
}
```

#### 5ã€æµ‹è¯•

ä½¿ç”¨ Swagger è¿›è¡Œæµ‹è¯•ï¼Œå‘ç°å½“ä¸Šä¼ å›¾ç‰‡è¿‡å¤§æ—¶ï¼Œä¼šè§¦å‘ä¸€æ®µæŠ¥é”™ã€‚ä½†è¿™ä¸ªæŠ¥é”™ä¸æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„å¼‚å¸¸å¯¼è‡´çš„ï¼Œè€Œæ˜¯ç”±äº Tomcat æœåŠ¡å™¨é»˜è®¤é™åˆ¶äº†è¯·æ±‚ä¸­æ–‡ä»¶ä¸Šä¼ çš„å¤§å°ã€‚58IUDBvyDy7G+gVMqAunJfAo72ZBX//2DD/nhaX54Xg=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=

éœ€è¦åœ¨ `application.yml` ä¸­æ›´æ”¹é…ç½®ï¼Œè°ƒå¤§å…è®¸ä¸Šä¼ çš„æ–‡ä»¶å¤§å°ï¼š

```yaml
spring:  
  # å¼€æ”¾æ›´å¤§çš„æ–‡ä»¶ä¸Šä¼ ä½“ç§¯  
  servlet:  
    multipart:  
      max-file-size: 10MB
```

#### æ‰©å±•æ€è·¯

1ï¼‰å¯ä»¥ç”¨æšä¸¾ç±»ï¼ˆFileUploadBizEnumï¼‰æ”¯æŒæ ¹æ®ä¸šåŠ¡åœºæ™¯åŒºåˆ†æ–‡ä»¶ä¸Šä¼ è·¯å¾„ã€æ ¡éªŒè§„åˆ™ç­‰ï¼Œä»è€Œå¤ç”¨ FileManagerã€‚

2ï¼‰ç›®å‰åœ¨æ–‡ä»¶ä¸Šä¼ æ—¶ï¼Œä¼šå…ˆåœ¨æœ¬åœ°åˆ›å»ºä¸´æ—¶æ–‡ä»¶ã€‚å¦‚æœä½ ä¸éœ€è¦å¯¹æ–‡ä»¶è¿›è¡Œé¢å¤–çš„å¤„ç†ã€æƒ³è¿›ä¸€æ­¥æé«˜æ€§èƒ½ï¼Œå¯ä»¥ç›´æ¥ç”¨æµçš„æ–¹å¼å°†è¯·æ±‚ä¸­çš„æ–‡ä»¶ä¸Šä¼ åˆ° COSã€‚ä»¥ä¸‹ä»£ç ä»…ä¾›å‚è€ƒï¼š

```java
// ä¸Šä¼ æ–‡ä»¶  
public static String uploadToCOS(MultipartFile multipartFile, String bucketName, String key) throws Exception {  
    // åˆ›å»º COS å®¢æˆ·ç«¯  
    COSClient cosClient = createCOSClient();  
  
    try (InputStream inputStream = multipartFile.getInputStream()) {  
        // å…ƒä¿¡æ¯é…ç½®  
        ObjectMetadata metadata = new ObjectMetadata();  
        metadata.setContentLength(multipartFile.getSize());  
        metadata.setContentType(multipartFile.getContentType());  
  
        // åˆ›å»ºä¸Šä¼ è¯·æ±‚  
        PutObjectRequest putObjectRequest = new PutObjectRequest(bucketName, key, inputStream, metadata);  
  
        // ä¸Šä¼ æ–‡ä»¶  
        cosClient.putObject(putObjectRequest);  
  
        // ç”Ÿæˆè®¿é—®é“¾æ¥  
        return "https://" + bucketName + ".cos." + cosClient.getClientConfig().getRegion().getRegionName()  
               + ".myqcloud.com/" + key;  
    } finally {  
        cosClient.shutdown();  
    }  
}
```

3ï¼‰è¡¥å……æ›´ä¸¥æ ¼çš„æ ¡éªŒï¼Œæ¯”å¦‚ä¸ºæ”¯æŒçš„å›¾ç‰‡æ ¼å¼å®šä¹‰æšä¸¾ï¼Œä»…å…è®¸ä¸Šä¼ æšä¸¾å®šä¹‰çš„æ ¼å¼ã€‚

### å›¾ç‰‡ç®¡ç†

å›¾ç‰‡ç®¡ç†åŠŸèƒ½å…·ä½“å¯ä»¥æ‹†åˆ†ä¸ºï¼š 

- ã€ç®¡ç†å‘˜ã€‘æ ¹æ® id åˆ é™¤å›¾ç‰‡
- ã€ç®¡ç†å‘˜ã€‘æ›´æ–°å›¾ç‰‡
- ã€ç®¡ç†å‘˜ã€‘åˆ†é¡µè·å–å›¾ç‰‡åˆ—è¡¨ï¼ˆä¸éœ€è¦è„±æ•å’Œé™åˆ¶æ¡æ•°ï¼‰
- ã€ç®¡ç†å‘˜ã€‘æ ¹æ® id è·å–å›¾ç‰‡ï¼ˆä¸éœ€è¦è„±æ•ï¼‰
- åˆ†é¡µè·å–å›¾ç‰‡åˆ—è¡¨ï¼ˆéœ€è¦è„±æ•å’Œé™åˆ¶æ¡æ•°ï¼‰
- æ ¹æ® id è·å–å›¾ç‰‡ï¼ˆéœ€è¦è„±æ•ï¼‰
- ä¿®æ”¹å›¾ç‰‡

#### 1ã€æ•°æ®æ¨¡å‹

æ¯ä¸ªæ“ä½œéƒ½éœ€è¦æä¾›ä¸€ä¸ªè¯·æ±‚ç±»ï¼Œéƒ½æ”¾åœ¨ `model.dto.picture` åŒ…ä¸‹ã€‚