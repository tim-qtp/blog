---
order: 11
author: 
title: "å›¾ç‰‡ååŒç¼–è¾‘"
category:
  - äº‘å›¾åº“
  - é¡¹ç›®
---

## ![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221637775.png)

## ä¸€ã€è§£å†³åä½œå†²çª

### 1ã€è§£å†³æ–¹æ¡ˆ

å‡è®¾è¿™æ ·ä¸€ç§åœºæ™¯ï¼šç§¦ä¸€å’Œæè›‹åŒæ—¶å¿«é€Ÿç‚¹å‡»äº†åæ¬¡æ—‹è½¬ï¼Œæœ€ç»ˆçš„ç»“æœä¼šæ˜¯æ€æ ·çš„å‘¢ï¼Ÿ

å¦‚æœæ‰€æœ‰äº‹ä»¶éƒ½æ˜¯æŒ‰é¡ºåºå¤„ç†çš„ï¼Œé‚£ç»“æœå°±å¾ˆæ¸…æ™°äº†ï¼Œä½†äº‹å®ä¸Šï¼Œä¸ºäº†æé«˜æ€§èƒ½å’Œå“åº”é€Ÿåº¦ï¼Œäº‹ä»¶é€šå¸¸æ˜¯ **å¹¶å‘** çš„ï¼Œè€Œä¸æ˜¯ä¸¥æ ¼çš„é¡ºåºæ‰§è¡Œã€‚è¿™ç§å¹¶å‘æ“ä½œä¼šå¼•å‘ **åä½œå†²çª**ï¼Œå¯¼è‡´å…¶ä»–ç”¨æˆ·çœ‹åˆ°çš„æ—‹è½¬æ•ˆæœæ˜¯ä¹±åºçš„ã€‚

é‚£ä¹ˆæ€ä¹ˆè§£å†³åä½œå†²çªçš„é—®é¢˜å‘¢ï¼Ÿ

å…¶å®å¯ä»¥é€šè¿‡ä¸šåŠ¡è®¾è®¡æ¥å‡å°‘å¼€å‘æˆæœ¬ï¼Œæ¯”å¦‚çº¦å®š **åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä½ç”¨æˆ·è¿›å…¥ç¼–è¾‘å›¾ç‰‡çš„çŠ¶æ€**ï¼Œæ­¤æ—¶å…¶ä»–ç”¨æˆ·åªèƒ½å®æ—¶æµè§ˆåˆ°ä¿®æ”¹æ•ˆæœï¼Œä½†ä¸èƒ½å‚ä¸ç¼–è¾‘ï¼›è¿›å…¥ç¼–è¾‘çŠ¶æ€çš„ç”¨æˆ·å¯ä»¥é€€å‡ºç¼–è¾‘ï¼Œå…¶ä»–ç”¨æˆ·æ‰å¯ä»¥è¿›å…¥ç¼–è¾‘çŠ¶æ€ã€‚ç±»ä¼¼äºç»™å›¾ç‰‡ç¼–è¾‘è¿™ä¸ªåŠ¨ä½œåŠ äº†ä¸€æŠŠé”ï¼Œç›´æ¥ä»æºå¤´ä¸Šè§£å†³äº†ç¼–è¾‘å†²çªçš„é—®é¢˜ã€‚

æ­¤æ—¶ï¼Œåä½œç¼–è¾‘çš„äº¤äº’æµç¨‹åˆè¦å¢åŠ  2 ä¸ªåŠ¨ä½œ â€”â€” è¿›å…¥ç¼–è¾‘çŠ¶æ€å’Œé€€å‡ºç¼–è¾‘çŠ¶æ€ï¼š

ä½†è¿™ç§æ–¹æ¡ˆçš„ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå‡å°‘äº†å®æ—¶åä½œçš„ä¾¿åˆ©æ€§ï¼Œå¯¹äºåä½œè®¾è®¡ã€åä½œç¼–ç ã€åä½œæ–‡æ¡£çš„åœºæ™¯ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªç”¨æˆ·ç¼–è¾‘ï¼Œæé«˜çš„æ•ˆç‡æœ‰é™ã€‚æ‰€ä»¥è¿™é‡Œå†åˆ†äº«å¦å¤–ä¸€ç§å®æ—¶ååŒç®—æ³•ä½œä¸ºæ‰©å±•çŸ¥è¯†ã€‚

### 2ã€æ‰©å±•çŸ¥è¯† - OT ç®—æ³•

å®æ—¶ååŒ OT ç®—æ³•ï¼ˆOperational Transformationï¼‰æ˜¯ä¸€ç§æ”¯æŒåˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¤šä¸ªç”¨æˆ·å®æ—¶åä½œç¼–è¾‘çš„æ ¸å¿ƒç®—æ³•ï¼Œå¹¿æ³›åº”ç”¨äºåœ¨çº¿æ–‡æ¡£åä½œç­‰åœºæ™¯ã€‚OT ç®—æ³•çš„ä¸»è¦åŠŸèƒ½æ˜¯è§£å†³å¹¶å‘ç¼–è¾‘å†²çªï¼Œ**ç¡®ä¿ç¼–è¾‘ç»“æœåœ¨æ‰€æœ‰ç”¨æˆ·ç»ˆç«¯ä¸€è‡´**ã€‚

OT ç®—æ³•å…¶å®å¾ˆå¥½ç†è§£ï¼Œå…ˆçœ‹ä¸‹ 3 ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š

- æ“ä½œ (Operation)ï¼šè¡¨ç¤ºç”¨æˆ·å¯¹åä½œå†…å®¹çš„ä¿®æ”¹ï¼Œæ¯”å¦‚æ’å…¥å­—ç¬¦ã€åˆ é™¤å­—ç¬¦ç­‰ã€‚
- è½¬åŒ– (Transformation)ï¼šå½“å¤šä¸ªç”¨æˆ·åŒæ—¶ç¼–è¾‘å†…å®¹æ—¶ï¼ŒOT ä¼šæ ¹æ®æ“ä½œçš„ä¸Šä¸‹æ–‡å°†å®ƒä»¬è½¬åŒ–ï¼Œä½¿å¾—è¿™äº›æ“ä½œå¯ä»¥æŒ‰ç…§ä¸åŒçš„é¡ºåºåº”ç”¨è€Œç»“æœä¿æŒä¸€è‡´ã€‚
- å› æœä¸€è‡´æ€§ï¼šOT ç®—æ³•ç¡®ä¿æ“ä½œæŒ‰ç…§ç”¨æˆ·çœ‹åˆ°çš„é¡ºåºè¢«æ­£ç¡®æ‰§è¡Œï¼Œå³æ¯ä¸ªç”¨æˆ·çš„æ“ä½œåŸºäºæœ€æ–°çš„å†…å®¹çŠ¶æ€ã€‚

å…¶ä¸­ï¼Œæœ€é‡è¦çš„å°±æ˜¯ **è½¬åŒ–** æ­¥éª¤äº†ï¼Œç›¸å½“äºæœ‰ä¸€ä¸ªè´Ÿè´£äººç»Ÿä¸€æ”¶é›†å¤§å®¶çš„æ“ä½œï¼Œç„¶åæŒ‰ç…§è®¾å®šçš„è§„åˆ™å’Œä¿¡æ¯è¿›è¡Œæ’åºä¸åˆå¹¶ï¼Œæœ€ç»ˆç»™å¤§å®¶ä¸€ä¸ªç»Ÿä¸€çš„ç»“æœã€‚

ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡è®¾åˆå§‹å†…å®¹æ˜¯ `"abc"`ï¼Œç”¨æˆ· A å’Œ B åŒæ—¶è¿›è¡Œç¼–è¾‘ï¼š

- ç”¨æˆ· A åœ¨ä½ç½® `1` æ’å…¥ `"x"`
- ç”¨æˆ· B åœ¨ä½ç½® `2` åˆ é™¤ `"b"`

å¦‚æœä¸ä½¿ç”¨ OT ç®—æ³•ï¼Œç»“æœæ˜¯ï¼š

1. ç”¨æˆ· A æ“ä½œåï¼Œå†…å®¹å˜ä¸º `"axbc"`
2. ç”¨æˆ· B æ“ä½œåï¼Œå†…å®¹å˜ä¸º `"ac"`

å¦‚æœç›´æ¥åº”ç”¨ B çš„æ“ä½œåˆ° A çš„ç»“æœï¼Œå¾—åˆ°çš„æ˜¯ `"ac"`ï¼Œå¯¹äº A æ¥è¯´ï¼Œç›¸å½“äºåˆ é™¤äº† `"b"`ï¼ŒA ä¼šæ„Ÿåˆ°ä¸€è„¸æ‡µé€¼ã€‚sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=

å¦‚æœä½¿ç”¨ OT ç®—æ³•ï¼Œç»“æœæ˜¯ï¼š

1. ç”¨æˆ· A çš„æ“ä½œï¼Œåº”ç”¨åå†…å®¹ä¸º `"axbc"`
2. ç”¨æˆ· B çš„æ“ä½œç»è¿‡ OT è½¬åŒ–ä¸ºåˆ é™¤ `"b"` åœ¨ `"axbc"` ä¸­çš„æ–°ä½ç½®

æœ€ç»ˆç”¨æˆ· A å’Œ B çš„å†…å®¹éƒ½ä¸€è‡´ä¸º `"axc"`ï¼Œç¬¦åˆé¢„æœŸã€‚OT ç®—æ³•ç¡®ä¿æ— è®ºç”¨æˆ·ç¼–è¾‘çš„é¡ºåºå¦‚ä½•ï¼Œæœ€ç»ˆå†…å®¹æ˜¯ä¸€è‡´çš„ã€‚

å½“ç„¶ï¼Œå…·ä½“çš„ OT ç®—æ³•è¿˜æ˜¯è¦æ ¹æ®éœ€æ±‚æ¥è®¾è®¡äº†ï¼Œåä½œå¯†åº¦è¶Šé«˜ï¼Œç®—æ³•è®¾è®¡éš¾åº¦è¶Šå¤§ã€‚

æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ç§ä¸ OT ç±»ä¼¼çš„ååŒç®—æ³• CRDTï¼ˆConflict-free Replicated Data Typeï¼‰ï¼Œå…¶é€šè¿‡æ•°å­¦æ¨¡å‹å®ç°æ— éœ€ä¸­å¿ƒåŒ–è½¬åŒ–çš„å†²çªè§£å†³ï¼Œåœ¨ç¦»çº¿åä½œåœºæ™¯ä¸­æ›´å…·ä¼˜åŠ¿ã€‚

## äºŒã€æé«˜åä½œå®æ—¶æ€§

åœ¨å®æ—¶é€šè®¯çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå¸¸ç”¨çš„æŠ€æœ¯æ–¹æ¡ˆåŒ…æ‹¬é•¿è½®è¯¢ã€SSE å’Œ WebSocketã€‚ç”±äºæˆ‘ä»¬çš„ä¸šåŠ¡éœ€æ±‚éœ€è¦å®ç°é¢‘ç¹ä¸”é«˜æ•ˆçš„åŒå‘é€šä¿¡ï¼Œå› æ­¤æˆ‘ä»¬é€‰ç”¨ WebSocket æ¥å®ç°å³æ—¶é€šè®¯ã€‚

### 1ã€ä»€ä¹ˆæ˜¯ WebSocketï¼Ÿ

WebSocket æ˜¯ä¸€ç§ **å…¨åŒå·¥é€šä¿¡åè®®**ï¼Œè®©å®¢æˆ·ç«¯ï¼ˆæ¯”å¦‚æµè§ˆå™¨ï¼‰å’ŒæœåŠ¡å™¨ä¹‹é—´èƒ½å¤Ÿä¿æŒå®æ—¶ã€æŒç»­çš„è¿æ¥ã€‚å’Œä¼ ç»Ÿçš„ HTTP è¯·æ±‚-å“åº”æ¨¡å¼ä¸åŒï¼ŒWebSocket æ˜¯ä¸€æ¡**â€œå¸¸å¼€çš„éš§é“â€**ï¼Œè¿æ¥çš„åŒæ–¹å¯ä»¥éšæ—¶å‘é€å’Œæ¥æ”¶æ•°æ®ï¼Œè€Œä¸éœ€è¦ä¸æ–­å»ºç«‹å’Œå…³é—­è¿æ¥ã€‚4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=

æ‰“ä¸ªæ¯”æ–¹ï¼š

- HTTP å°±åƒç‚¹å¤–å–ï¼š æ¯æ¬¡ä¸‹å•ï¼ˆè¯·æ±‚ï¼‰- åˆ°è´§ï¼ˆå“åº”ï¼‰éƒ½æ˜¯ä¸€æ¬¡ç‹¬ç«‹çš„æ“ä½œï¼Œå®Œæˆåè¿æ¥å…³é—­ã€‚
- WebSocket åƒæ˜¯æ‰“ç”µè¯ï¼šä½ æ‰“é€šäº†ç”µè¯ï¼ˆå»ºç«‹è¿æ¥ï¼‰ï¼Œå¯ä»¥éšæ—¶èŠå¤©ï¼ˆåŒå‘é€šä¿¡ï¼‰ï¼Œç›´åˆ°æŒ‚æ–­ï¼ˆå…³é—­è¿æ¥ï¼‰ã€‚

### 2ã€WebSocket çš„åº”ç”¨åœºæ™¯

WebSocket çš„ä¸»è¦ä½œç”¨æ˜¯ **å®ç°å®æ—¶æ•°æ®ä¼ è¾“**ï¼Œé€‚ç”¨äºéœ€è¦é¢‘ç¹äº¤äº’æˆ–è€…å®æ—¶æ›´æ–°æ•°æ®çš„åœºæ™¯ã€‚æ¯”å¦‚ï¼š

- å³æ—¶é€šè®¯ï¼ˆèŠå¤©è½¯ä»¶ã€å®æ—¶åä½œå·¥å…·ï¼‰
- å®æ—¶æ•°æ®æ›´æ–°ï¼ˆè‚¡ç¥¨è¡Œæƒ…ã€ä½“è‚²æ¯”èµ›æ¯”åˆ†ï¼‰
- åœ¨çº¿æ¸¸æˆï¼ˆå¤šäººå®æ—¶äº’åŠ¨ï¼‰
- ç‰©è”ç½‘ï¼ˆè®¾å¤‡çŠ¶æ€å®æ—¶ä¼ è¾“ï¼‰
- ååŒç¼–è¾‘ï¼ˆåƒè¯­é›€è¿™æ ·çš„å¤šäººåä½œç¼–è¾‘ï¼‰

é€šè¿‡ WebSocketï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´èƒ½å¤Ÿæ˜¾è‘—å‡å°‘æ¶ˆæ¯ä¼ è¾“çš„å»¶è¿Ÿï¼Œæé«˜é€šä¿¡æ•ˆç‡ï¼ŒåŒæ—¶é™ä½æ•°æ®ä¼ è¾“çš„å¼€é”€ã€‚

### 3ã€WebSocket å’Œ HTTP çš„å…³ç³»

WebSocket å’Œ HTTP æ˜¯ä¸¤ç§ä¸åŒçš„é€šä¿¡åè®®ï¼Œä½†å®ƒä»¬æ˜¯ç´§å¯†ç›¸å…³çš„ï¼Œéƒ½æ˜¯åŸºäº TCP åè®®ã€éƒ½å¯ä»¥åœ¨åŒæ ·çš„ç«¯å£ä¸Šå·¥ä½œï¼ˆæ¯”å¦‚ 80 å’Œ 443ï¼‰ã€‚eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=

**é¦–å…ˆè¦æ˜ç¡®ï¼ŒWebSocket æ˜¯å»ºç«‹åœ¨ HTTP åŸºç¡€ä¹‹ä¸Šçš„ï¼**WebSocket çš„è¿æ¥éœ€è¦é€šè¿‡ HTTP åè®®å‘èµ·ä¸€ä¸ªæ¡æ‰‹ï¼ˆç§°ä¸º HTTP Upgrade è¯·æ±‚ï¼‰ï¼Œè¿™ä¸ªæ¡æ‰‹è¯·æ±‚æ˜¯ WebSocket å»ºç«‹è¿æ¥çš„å‰æï¼Œè¡¨æ˜å¸Œæœ›åˆ‡æ¢åè®®ï¼›æœåŠ¡å™¨å¦‚æœæ”¯æŒ WebSocketï¼Œä¼šè¿”å›ä¸€ä¸ª HTTP 101 çŠ¶æ€ç ï¼Œè¡¨ç¤ºåè®®åˆ‡æ¢æˆåŠŸã€‚

æ¡æ‰‹å®Œæˆåï¼ŒHTTP åè®®çš„ä½œç”¨ç»“æŸï¼Œé€šä¿¡ä¼šåˆ‡æ¢ä¸º WebSocket åè®®ï¼ŒåŒæ–¹å¯ä»¥å¼€å§‹å…¨åŒå·¥é€šä¿¡ã€‚

äºŒè€…çš„åŒºåˆ«å¦‚ä¸‹ï¼Œå¤§å®¶äº†è§£ä¸€ä¸‹å°±å¥½ï¼š

| å¯¹æ¯”é¡¹       | HTTP                               | WebSocket                          |
| ------------ | ---------------------------------- | ---------------------------------- |
| é€šä¿¡æ¨¡å¼     | è¯·æ±‚-å“åº”ï¼ˆå•å‘ï¼‰                  | å…¨åŒå·¥é€šä¿¡ï¼ˆåŒå‘ï¼‰                 |
| è¿æ¥çŠ¶æ€     | æ¯æ¬¡è¯·æ±‚åˆ›å»ºæ–°çš„è¿æ¥               | æ¡æ‰‹åä¿æŒæŒç»­è¿æ¥                 |
| æ•°æ®ä¼ è¾“æ•ˆç‡ | æ¯æ¬¡é€šä¿¡éƒ½éœ€è¦å¸¦å®Œæ•´å¤´éƒ¨ï¼Œå¼€é”€å¤§   | æ•°æ®å¸§å°ï¼Œä¼ è¾“é«˜æ•ˆ                 |
| é€‚ç”¨åœºæ™¯     | é™æ€ç½‘é¡µåŠ è½½ã€API è°ƒç”¨ç­‰éå®æ—¶åœºæ™¯ | å®æ—¶äº¤äº’åœºæ™¯ï¼Œå¦‚èŠå¤©ã€æ¸¸æˆã€ç›´æ’­ç­‰ |

### 4ã€WebSocket åä½œç¼–è¾‘çš„æµç¨‹

é€šè¿‡ WebSocket å®æ—¶é€šä¿¡çš„èƒ½åŠ›ï¼Œå¯ä»¥å°†ç”¨æˆ·çš„ç¼–è¾‘æ“ä½œå‘ç»™ WebSocket æœåŠ¡å™¨ï¼Œå†ç”±æœåŠ¡å™¨è½¬å‘ç»™å…¶ä»–è¿æ¥æœåŠ¡å™¨çš„ç”¨æˆ·å‰ç«¯ï¼Œå‰ç«¯å°±å¯ä»¥æ ¹æ®æ“ä½œå¤„ç†å›¾ç‰‡ã€‚

![image-20250322170012287](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221700360.png)

å…·ä½“çš„ä¸šåŠ¡æµç¨‹ï¼š

1. å»ºç«‹è¿æ¥ä¹‹å‰ï¼Œå…ˆè¿›è¡Œç”¨æˆ·æƒé™æ ¡éªŒï¼›æ ¡éªŒé€šè¿‡åï¼Œå°†ç™»å½•ç”¨æˆ·ä¿¡æ¯ã€è¦ç¼–è¾‘çš„å›¾ç‰‡ä¿¡æ¯ä¿å­˜åˆ°è¦å»ºç«‹çš„ WebSocket è¿æ¥çš„ä¼šè¯å±æ€§ä¸­ã€‚
2. å»ºç«‹è¿æ¥æˆåŠŸåï¼Œå°† WebSocket ä¼šè¯ä¿å­˜åˆ°è¯¥å›¾ç‰‡å¯¹åº”çš„ä¼šè¯é›†åˆä¸­ï¼Œä¾¿äºåç»­åˆ†å‘æ¶ˆæ¯ç»™å…¶ä»–ä¼šè¯ã€‚
3. å‰ç«¯å°†æ¶ˆæ¯å‘é€åˆ°åç«¯ï¼Œåç«¯æ ¹æ®æ¶ˆæ¯ç±»å‹åˆ†å‘åˆ°å¯¹åº”çš„å¤„ç†å™¨ã€‚
4. å¤„ç†å™¨å¤„ç†æ¶ˆæ¯ï¼Œå°†å¤„ç†ç»“æœä½œä¸ºæ¶ˆæ¯å‘é€ç»™éœ€è¦çš„ WebSocket å®¢æˆ·ç«¯ã€‚
5. å½“å‰ç«¯æ–­å¼€è¿æ¥æ—¶ï¼Œåˆ é™¤ä¼šè¯é›†åˆä¸­çš„ WebSocket ä¼šè¯ï¼Œé‡Šæ”¾èµ„æº

å’Œ HTTP è¯·æ±‚ä¸€æ ·ï¼Œå‰ç«¯å’Œ WebSocket æœåŠ¡å™¨ä¹‹é—´ä¼ è¾“ä¿¡æ¯æ—¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ JSON æ ¼å¼å¯¹æ•°æ®è¿›è¡Œåºåˆ—åŒ–ã€‚

### 5ã€WebSocket çš„å®ç°æ–¹å¼

å¯¹äº Java Spring é¡¹ç›®ï¼Œä¸»è¦æœ‰åŸç”Ÿ WebSocketï¼ˆåŸºäº`WebSocketHandler` å®ç°ï¼‰ã€STOMPã€WebFlux è¿™ 3 ç§å®ç°æ–¹å¼ã€‚

å®ƒä»¬ä¹‹é—´çš„å¯¹æ¯”å¦‚ä¸‹ï¼š

| å®ç°æ–¹å¼                     | ç‰¹ç‚¹                          | ä¼˜ç‚¹                             | ç¼ºç‚¹                                 | é€‚ç”¨åœºæ™¯                       |
| ---------------------------- | ----------------------------- | -------------------------------- | ------------------------------------ | ------------------------------ |
| åŸç”Ÿ WebSocket               | ä½å±‚ APIï¼Œæ‰‹åŠ¨ç®¡ç†è¿æ¥ä¸æ¶ˆæ¯  | è½»é‡ã€çµæ´»ã€é€‚ç”¨äºç®€å•ç‚¹å¯¹ç‚¹é€šä¿¡ | éœ€è¦æ‰‹åŠ¨ç®¡ç†ä¼šè¯å’Œåˆ†å‘ï¼Œä¸æ”¯æŒ STOMP | ç®€å•çš„å®æ—¶æ¨é€ï¼Œä½å¹¶å‘åœºæ™¯     |
| WebSocket + STOMP + SockJS   | åŸºäº STOMPï¼Œæ”¯æŒå‘å¸ƒ/è®¢é˜…æ¨¡å¼ | æ”¯æŒ STOMPã€æ¶ˆæ¯ä»£ç†ã€é€‚é…       | ä¾èµ–å¤–éƒ¨ä»£ç†ï¼Œé…ç½®è¾ƒå¤æ‚             | èŠå¤©å®¤ã€å¤šäººåä½œï¼Œé«˜çº§å®æ—¶åº”ç”¨ |
| WebFlux + Reactive WebSocket | åŸºäº WebFlux çš„å“åº”å¼å®ç°     | é«˜å¹¶å‘ã€éé˜»å¡ã€é€‚ç”¨äºå¤§æµé‡åœº   | å­¦ä¹ æ›²çº¿é«˜ï¼Œä¸æ”¯æŒ STOMP             | é«˜å¹¶å‘åœºæ™¯ã€å¤§æ•°æ®æµæ¨é€       |

ç½‘ä¸Šçš„å»ºè®®æ˜¯ï¼šå¯¹äºå¤§å¤šæ•°ç®€å•å®æ—¶æ¨é€ï¼Œé€‰ç”¨åŸç”Ÿ WebSocketï¼›å¯¹äºå¤æ‚çš„èŠå¤©å®¤å’ŒååŒç³»ç»Ÿï¼Œé€‰ç”¨ WebSocket + STOMP + SockJSï¼›å¯¹äºé«˜å¹¶å‘ã€ä½å»¶è¿Ÿæ•°æ®æµæ¨é€ï¼Œé€‰ç”¨ WebFlux + Reactive WebSocketã€‚

å¯¹äºè¿™ä¸ªæ­Œé¡¹ç›®ï¼Œå¹¶å‘è¦æ±‚ä¸é«˜ï¼Œé€‰æ‹© Spring åŸç”Ÿçš„ WebSocket æ¥é™ä½å¼€å‘æˆæœ¬ã€‚

æ˜ç¡®æ–¹æ¡ˆåï¼Œè¿›å…¥åç«¯å¼€å‘ã€‚

## ä¸‰ã€åç«¯å¼€å‘

### 1ã€å¼•å…¥ WebSocket ä¾èµ–

å¼•å…¥ä¾èµ–ï¼š

```xml
<!-- websocket -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-websocket</artifactId>
</dependency>
```

æ–°å»º `manager.websocket` åŒ…ï¼Œæ‰€æœ‰å’Œ WebSocket ç›¸å…³çš„ä»£ç éƒ½æ”¾åˆ°è¯¥åŒ…ä¸‹ã€‚

### 2ã€å®šä¹‰æ•°æ®æ¨¡å‹

æ–°å»º `websocket.model` åŒ…ï¼Œå­˜æ”¾æ•°æ®æ¨¡å‹ï¼ŒåŒ…æ‹¬è¯·æ±‚ç±»ã€å“åº”ç±»ã€æšä¸¾ç±»ã€‚

1ï¼‰å®šä¹‰å›¾ç‰‡ç¼–è¾‘è¯·æ±‚æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯å‰ç«¯è¦å‘é€ç»™åç«¯çš„å‚æ•°ï¼š

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class PictureEditRequestMessage {

    /**
     * æ¶ˆæ¯ç±»å‹ï¼Œä¾‹å¦‚ "ENTER_EDIT", "EXIT_EDIT", "EDIT_ACTION"
     */
    private String type;

    /**
     * æ‰§è¡Œçš„ç¼–è¾‘åŠ¨ä½œï¼ˆå·¦æ—‹ã€å³æ—‹ï¼‰
     */
    private String editAction;
}
```

2ï¼‰å®šä¹‰å›¾ç‰‡ç¼–è¾‘å“åº”æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯åç«¯è¦å‘é€ç»™å‰ç«¯çš„ä¿¡æ¯ï¼š

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class PictureEditResponseMessage {

    /**
     * æ¶ˆæ¯ç±»å‹ï¼Œä¾‹å¦‚ "INFO", "ERROR", "ENTER_EDIT", "EXIT_EDIT", "EDIT_ACTION"
     */
    private String type;

    /**
     * ä¿¡æ¯
     */
    private String message;

    /**
     * æ‰§è¡Œçš„ç¼–è¾‘åŠ¨ä½œ
     */
    private String editAction;

    /**
     * ç”¨æˆ·ä¿¡æ¯
     */
    private UserVO user;
}
```

3ï¼‰å®šä¹‰å›¾ç‰‡ç¼–è¾‘==æ¶ˆæ¯ç±»å‹==æšä¸¾ï¼Œä¾¿äºåç»­æ ¹æ®æ¶ˆæ¯ç±»å‹è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼š 

```java
@Getter
public enum PictureEditMessageTypeEnum {

    INFO("å‘é€é€šçŸ¥", "INFO"),
    ERROR("å‘é€é”™è¯¯", "ERROR"),
    ENTER_EDIT("è¿›å…¥ç¼–è¾‘çŠ¶æ€", "ENTER_EDIT"),
    EXIT_EDIT("é€€å‡ºç¼–è¾‘çŠ¶æ€", "EXIT_EDIT"),
    EDIT_ACTION("æ‰§è¡Œç¼–è¾‘æ“ä½œ", "EDIT_ACTION");

    private final String text;
    private final String value;

    PictureEditMessageTypeEnum(String text, String value) {
        this.text = text;
        this.value = value;
    }

    /**
     * æ ¹æ® value è·å–æšä¸¾
     */
    public static PictureEditMessageTypeEnum getEnumByValue(String value) {
        if (value == null || value.isEmpty()) {
            return null;
        }
        for (PictureEditMessageTypeEnum typeEnum : PictureEditMessageTypeEnum.values()) {
            if (typeEnum.value.equals(value)) {
                return typeEnum;
            }
        }
        return null;
    }
}
```

4ï¼‰å®šä¹‰å›¾ç‰‡ç¼–è¾‘==æ“ä½œç±»å‹==æšä¸¾ï¼š

```java
@Getter
public enum PictureEditActionEnum {

    ZOOM_IN("æ”¾å¤§æ“ä½œ", "ZOOM_IN"),
    ZOOM_OUT("ç¼©å°æ“ä½œ", "ZOOM_OUT"),
    ROTATE_LEFT("å·¦æ—‹æ“ä½œ", "ROTATE_LEFT"),
    ROTATE_RIGHT("å³æ—‹æ“ä½œ", "ROTATE_RIGHT");

    private final String text;
    private final String value;

    PictureEditActionEnum(String text, String value) {
        this.text = text;
        this.value = value;
    }

    /**
     * æ ¹æ® value è·å–æšä¸¾
     */
    public static PictureEditActionEnum getEnumByValue(String value) {
        if (value == null || value.isEmpty()) {
            return null;
        }
        for (PictureEditActionEnum actionEnum : PictureEditActionEnum.values()) {
            if (actionEnum.value.equals(value)) {
                return actionEnum;
            }
        }
        return null;
    }
}
```

### 3ã€WebSocket æ‹¦æˆªå™¨ - æƒé™æ ¡éªŒ

åœ¨ WebSocket è¿æ¥å‰éœ€è¦è¿›è¡Œæƒé™æ ¡éªŒï¼Œå¦‚æœå‘ç°ç”¨æˆ·æ²¡æœ‰å›¢é˜Ÿç©ºé—´å†…ç¼–è¾‘å›¾ç‰‡çš„æƒé™ï¼Œåˆ™æ‹’ç»æ¡æ‰‹ï¼Œå¯ä»¥é€šè¿‡å®šä¹‰ä¸€ä¸ª WebSocket ==æ‹¦æˆªå™¨==å®ç°è¿™ä¸ªèƒ½åŠ›ã€‚

æ­¤å¤–ï¼Œç”±äº HTTP å’Œ WebSocket çš„åŒºåˆ«ï¼Œæˆ‘ä»¬ä¸èƒ½åœ¨åç»­æ”¶åˆ°å‰ç«¯æ¶ˆæ¯æ—¶ç›´æ¥ä» request å¯¹è±¡ä¸­è·å–åˆ°ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œå› æ­¤ä¹Ÿéœ€è¦é€šè¿‡ WebSocket æ‹¦æˆªå™¨ï¼Œä¸ºå³å°†å»ºç«‹è¿æ¥çš„ WebSocket ä¼šè¯æŒ‡å®šä¸€äº›å±æ€§ï¼Œæ¯”å¦‚ç™»å½•ç”¨æˆ·ä¿¡æ¯ã€ç¼–è¾‘çš„å›¾ç‰‡ id ç­‰ã€‚

ç¼–å†™æ‹¦æˆªå™¨çš„ä»£ç ï¼Œéœ€è¦å®ç° `HandshakeInterceptor` æ¥å£ï¼š

```java
@Component
@Slf4j
public class WsHandshakeInterceptor implements HandshakeInterceptor {

    @Resource
    private UserService userService;

    @Resource
    private PictureService pictureService;

    @Resource
    private SpaceService spaceService;

    @Resource
    private SpaceUserAuthManager spaceUserAuthManager;

    @Override
    public boolean beforeHandshake(@NotNull ServerHttpRequest request, @NotNull ServerHttpResponse response, @NotNull WebSocketHandler wsHandler, @NotNull Map<String, Object> attributes) {
        if (request instanceof ServletServerHttpRequest) {
            HttpServletRequest servletRequest = ((ServletServerHttpRequest) request).getServletRequest();
            // è·å–è¯·æ±‚å‚æ•°
            String pictureId = servletRequest.getParameter("pictureId");
            if (StrUtil.isBlank(pictureId)) {
                log.error("ç¼ºå°‘å›¾ç‰‡å‚æ•°ï¼Œæ‹’ç»æ¡æ‰‹");
                return false;
            }
            User loginUser = userService.getLoginUser(servletRequest);
            if (ObjUtil.isEmpty(loginUser)) {
                log.error("ç”¨æˆ·æœªç™»å½•ï¼Œæ‹’ç»æ¡æ‰‹");
                return false;
            }
            // æ ¡éªŒç”¨æˆ·æ˜¯å¦æœ‰è¯¥å›¾ç‰‡çš„æƒé™
            Picture picture = pictureService.getById(pictureId);
            if (picture == null) {
                log.error("å›¾ç‰‡ä¸å­˜åœ¨ï¼Œæ‹’ç»æ¡æ‰‹");
                return false;
            }
            Long spaceId = picture.getSpaceId();
            Space space = null;
            if (spaceId != null) {
                space = spaceService.getById(spaceId);
                if (space == null) {
                    log.error("ç©ºé—´ä¸å­˜åœ¨ï¼Œæ‹’ç»æ¡æ‰‹");
                    return false;
                }
                if (space.getSpaceType() != SpaceTypeEnum.TEAM.getValue()) {
                    log.info("ä¸æ˜¯å›¢é˜Ÿç©ºé—´ï¼Œæ‹’ç»æ¡æ‰‹");
                    return false;
                }
            }
            List<String> permissionList = spaceUserAuthManager.getPermissionList(space, loginUser);
            if (!permissionList.contains(SpaceUserPermissionConstant.PICTURE_EDIT)) {
                log.error("æ²¡æœ‰å›¾ç‰‡ç¼–è¾‘æƒé™ï¼Œæ‹’ç»æ¡æ‰‹");
                return false;
            }
            // è®¾ç½® attributes
            attributes.put("user", loginUser);
            attributes.put("userId", loginUser.getId());
            attributes.put("pictureId", Long.valueOf(pictureId)); // è®°å¾—è½¬æ¢ä¸º Long ç±»å‹
        }
        return true;
    }

    @Override
    public void afterHandshake(@NotNull ServerHttpRequest request, @NotNull ServerHttpResponse response, @NotNull WebSocketHandler wsHandler, Exception exception) {
    }
}
```

### 4ã€WebSocket å¤„ç†å™¨

æˆ‘ä»¬éœ€è¦å®šä¹‰ WebSocket å¤„ç†å™¨ç±»ï¼Œåœ¨è¿æ¥æˆåŠŸã€è¿æ¥å…³é—­ã€æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯æ—¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚

å¯ä»¥å®ç° TextWebSocketHandler æ¥å£ï¼Œè¿™æ ·å°±èƒ½ä»¥å­—ç¬¦ä¸²çš„æ–¹å¼å‘é€å’Œæ¥å—æ¶ˆæ¯äº†ï¼š

```java
@Component
public class PictureEditHandler extends TextWebSocketHandler {
}
```

1ï¼‰é¦–å…ˆåœ¨å¤„ç†å™¨ç±»ä¸­å®šä¹‰ 2 ä¸ªå¸¸é‡ï¼Œåˆ†åˆ«ä¸ºï¼š

- ä¿å­˜å½“å‰æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ· idï¼Œæ‰§è¡Œç¼–è¾‘æ“ä½œã€è¿›å…¥æˆ–é€€å‡ºç¼–è¾‘æ—¶éƒ½ä¼šæ ¡éªŒã€‚
- ä¿å­˜å‚ä¸ç¼–è¾‘å›¾ç‰‡çš„ç”¨æˆ· WebSocket ä¼šè¯çš„é›†åˆã€‚

ç”±äºæ¯ä¸ªå›¾ç‰‡çš„åä½œç¼–è¾‘éƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæ‰€ä»¥éœ€è¦ç”¨ Map æ¥åŒºåˆ†æ¯ä¸ªå›¾ç‰‡ id å¯¹åº”çš„æ•°æ®ã€‚ä»£ç å¦‚ä¸‹ï¼šDe2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=

```java
// æ¯å¼ å›¾ç‰‡çš„ç¼–è¾‘çŠ¶æ€ï¼Œkey: pictureId, value: å½“å‰æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ· ID
private final Map<Long, Long> pictureEditingUsers = new ConcurrentHashMap<>();

// ä¿å­˜æ‰€æœ‰è¿æ¥çš„ä¼šè¯ï¼Œkey: pictureId, value: ç”¨æˆ·ä¼šè¯é›†åˆ
private final Map<Long, Set<WebSocketSession>> pictureSessions = new ConcurrentHashMap<>();
```

æ³¨æ„ï¼Œç”±äºå¯èƒ½åŒæ—¶æœ‰å¤šä¸ª WebSocket å®¢æˆ·ç«¯å»ºç«‹è¿æ¥å’Œå‘é€æ¶ˆæ¯ï¼Œé›†åˆè¦ä½¿ç”¨å¹¶å‘åŒ…ï¼ˆJUCï¼‰ä¸­çš„ `ConcurrentHashMap`ï¼Œæ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

2ï¼‰ç”±äºæ¥ä¸‹æ¥å¾ˆå¤šæ¶ˆæ¯éƒ½éœ€è¦ä¼ é€’ç»™æ‰€æœ‰åä½œè€…ï¼Œæ‰€ä»¥å…ˆç¼–å†™ä¸€ä¸ª **å¹¿æ’­æ¶ˆæ¯** çš„æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¼šæ ¹æ® pictureIdï¼Œå°†å“åº”æ¶ˆæ¯å‘é€ç»™ç¼–è¾‘è¯¥å›¾ç‰‡çš„æ‰€æœ‰ä¼šè¯ã€‚è€ƒè™‘åˆ°å¯èƒ½ä¼šæœ‰æ¶ˆæ¯ä¸éœ€è¦å‘é€ç»™ç¼–è¾‘è€…æœ¬äººçš„æƒ…å†µï¼Œè¯¥æ–¹æ³•è¿˜å¯ä»¥æ¥å— excludeSession å‚æ•°ï¼Œæ”¯æŒæ’é™¤æ‰å‘æŸä¸ªä¼šè¯å‘é€æ¶ˆæ¯ã€‚4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=

ä»£ç å¦‚ä¸‹ï¼š

```java
private void broadcastToPicture(Long pictureId, PictureEditResponseMessage pictureEditResponseMessage, WebSocketSession excludeSession) throws Exception {
    Set<WebSocketSession> sessionSet = pictureSessions.get(pictureId);
    if (CollUtil.isNotEmpty(sessionSet)) {
        // åˆ›å»º ObjectMapper
        ObjectMapper objectMapper = new ObjectMapper();
        // é…ç½®åºåˆ—åŒ–ï¼šå°† Long ç±»å‹è½¬ä¸º Stringï¼Œè§£å†³ä¸¢å¤±ç²¾åº¦é—®é¢˜
        SimpleModule module = new SimpleModule();
        module.addSerializer(Long.class, ToStringSerializer.instance);
        module.addSerializer(Long.TYPE, ToStringSerializer.instance); // æ”¯æŒ long åŸºæœ¬ç±»å‹
        objectMapper.registerModule(module);
        // åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²
        String message = objectMapper.writeValueAsString(pictureEditResponseMessage);
        TextMessage textMessage = new TextMessage(message);
        for (WebSocketSession session : sessionSet) {
            // æ’é™¤æ‰çš„ session ä¸å‘é€
            if (excludeSession != null && excludeSession.equals(session)) {
                continue;
            }
            if (session.isOpen()) {
                session.sendMessage(textMessage);
            }
        }
    }
}
```

ä¸Šè¿°ä»£ç ä¸­æœ‰ä¸ªå°ç»†èŠ‚ï¼Œç”±äºå‰ç«¯ JS çš„é•¿æ•´æ•°å¯èƒ½ä¼šä¸¢å¤±ç²¾åº¦ï¼Œæ‰€ä»¥ä½¿ç”¨ Jackson è‡ªå®šä¹‰åºåˆ—åŒ–å™¨ï¼Œåœ¨å°†å¯¹è±¡è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²æ—¶ï¼Œå°† Long ç±»å‹è½¬æ¢ä¸º String ç±»å‹ã€‚58IUDBvyDy7G+gVMqAunJfAo72ZBX//2DD/nhaX54Xg=

å†ç¼–å†™ä¸€ä¸ªä¸æ’é™¤ Sessionï¼Œç»™æ‰€æœ‰ä¼šè¯å¹¿æ’­çš„æ–¹æ³•ï¼š

```java
// å…¨éƒ¨å¹¿æ’­
private void broadcastToPicture(Long pictureId, PictureEditResponseMessage pictureEditResponseMessage) throws Exception {
    broadcastToPicture(pictureId, pictureEditResponseMessage, null);
}
```

3ï¼‰å®ç°è¿æ¥å»ºç«‹æˆåŠŸåæ‰§è¡Œçš„æ–¹æ³•ï¼Œä¿å­˜ä¼šè¯åˆ°é›†åˆä¸­ï¼Œå¹¶ä¸”ç»™å…¶ä»–ä¼šè¯å‘é€æ¶ˆæ¯ï¼šeSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=

```java
@Override
public void afterConnectionEstablished(WebSocketSession session) throws Exception {
    // ä¿å­˜ä¼šè¯åˆ°é›†åˆä¸­
    User user = (User) session.getAttributes().get("user");
    Long pictureId = (Long) session.getAttributes().get("pictureId");
    pictureSessions.putIfAbsent(pictureId, ConcurrentHashMap.newKeySet());
    pictureSessions.get(pictureId).add(session);

    // æ„é€ å“åº”
    PictureEditResponseMessage pictureEditResponseMessage = new PictureEditResponseMessage();
    pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.INFO.getValue());
    String message = String.format("%såŠ å…¥ç¼–è¾‘", user.getUserName());
    pictureEditResponseMessage.setMessage(message);
    pictureEditResponseMessage.setUser(userService.getUserVO(user));
    // å¹¿æ’­ç»™åŒä¸€å¼ å›¾ç‰‡çš„ç”¨æˆ·
    broadcastToPicture(pictureId, pictureEditResponseMessage);
}
```

4ï¼‰ç¼–å†™æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯çš„æ–¹æ³•ï¼Œæ ¹æ®æ¶ˆæ¯ç±»åˆ«æ‰§è¡Œä¸åŒçš„å¤„ç†ï¼š

```java
@Override
protected void handleTextMessage(WebSocketSession session, TextMessage message) throws Exception {
    // å°†æ¶ˆæ¯è§£æä¸º PictureEditMessage
    PictureEditRequestMessage pictureEditRequestMessage = JSONUtil.toBean(message.getPayload(), PictureEditRequestMessage.class);
    String type = pictureEditRequestMessage.getType();
    PictureEditMessageTypeEnum pictureEditMessageTypeEnum = PictureEditMessageTypeEnum.valueOf(type);

    // ä» Session å±æ€§ä¸­è·å–å…¬å…±å‚æ•°
    Map<String, Object> attributes = session.getAttributes();
    User user = (User) attributes.get("user");
    Long pictureId = (Long) attributes.get("pictureId");

    // è°ƒç”¨å¯¹åº”çš„æ¶ˆæ¯å¤„ç†æ–¹æ³•
    switch (pictureEditMessageTypeEnum) {
        case ENTER_EDIT:
            handleEnterEditMessage(pictureEditRequestMessage, session, user, pictureId);
            break;
        case EDIT_ACTION:
            handleEditActionMessage(pictureEditRequestMessage, session, user, pictureId);
            break;
        case EXIT_EDIT:
            handleExitEditMessage(pictureEditRequestMessage, session, user, pictureId);
            break;
        default:
            PictureEditResponseMessage pictureEditResponseMessage = new PictureEditResponseMessage();
            pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.ERROR.getValue());
            pictureEditResponseMessage.setMessage("æ¶ˆæ¯ç±»å‹é”™è¯¯");
            pictureEditResponseMessage.setUser(userService.getUserVO(user));
            session.sendMessage(new TextMessage(JSONUtil.toJsonStr(pictureEditResponseMessage)));
    }
}
```

æ¥ä¸‹æ¥ä¾æ¬¡ç¼–å†™æ¯ä¸ªå¤„ç†æ¶ˆæ¯çš„æ–¹æ³•ã€‚é¦–å…ˆæ˜¯ç”¨æˆ·è¿›å…¥ç¼–è¾‘çŠ¶æ€ï¼Œè¦è®¾ç½®å½“å‰ç”¨æˆ·ä¸ºç¼–è¾‘ç”¨æˆ·ï¼Œå¹¶ä¸”å‘å…¶ä»–å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼š

```java
public void handleEnterEditMessage(PictureEditRequestMessage pictureEditRequestMessage, WebSocketSession session, User user, Long pictureId) throws Exception {
    // æ²¡æœ‰ç”¨æˆ·æ­£åœ¨ç¼–è¾‘è¯¥å›¾ç‰‡ï¼Œæ‰èƒ½è¿›å…¥ç¼–è¾‘
    if (!pictureEditingUsers.containsKey(pictureId)) {
        // è®¾ç½®å½“å‰ç”¨æˆ·ä¸ºç¼–è¾‘ç”¨æˆ·
        pictureEditingUsers.put(pictureId, user.getId());
        PictureEditResponseMessage pictureEditResponseMessage = new PictureEditResponseMessage();
        pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.ENTER_EDIT.getValue());
        String message = String.format("%så¼€å§‹ç¼–è¾‘å›¾ç‰‡", user.getUserName());
        pictureEditResponseMessage.setMessage(message);
        pictureEditResponseMessage.setUser(userService.getUserVO(user));
        broadcastToPicture(pictureId, pictureEditResponseMessage);
    }
}
```

ç”¨æˆ·æ‰§è¡Œç¼–è¾‘æ“ä½œæ—¶ï¼Œå°†è¯¥æ“ä½œåŒæ­¥ç»™ **é™¤äº†å½“å‰ç”¨æˆ·ä¹‹å¤–** çš„å…¶ä»–å®¢æˆ·ç«¯ï¼Œä¹Ÿå°±æ˜¯è¯´ç¼–è¾‘æ“ä½œä¸ç”¨å†åŒæ­¥ç»™è‡ªå·±ï¼šLRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=

```java
public void handleEditActionMessage(PictureEditRequestMessage pictureEditRequestMessage, WebSocketSession session, User user, Long pictureId) throws Exception {
    Long editingUserId = pictureEditingUsers.get(pictureId);
    String editAction = pictureEditRequestMessage.getEditAction();
    PictureEditActionEnum actionEnum = PictureEditActionEnum.getEnumByValue(editAction);
    if (actionEnum == null) {
        return;
    }
    // ç¡®è®¤æ˜¯å½“å‰ç¼–è¾‘è€…
    if (editingUserId != null && editingUserId.equals(user.getId())) {
        PictureEditResponseMessage pictureEditResponseMessage = new PictureEditResponseMessage();
        pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.EDIT_ACTION.getValue());
        String message = String.format("%sæ‰§è¡Œ%s", user.getUserName(), actionEnum.getText());
        pictureEditResponseMessage.setMessage(message);
        pictureEditResponseMessage.setEditAction(editAction);
        pictureEditResponseMessage.setUser(userService.getUserVO(user));
        // å¹¿æ’­ç»™é™¤äº†å½“å‰å®¢æˆ·ç«¯ä¹‹å¤–çš„å…¶ä»–ç”¨æˆ·ï¼Œå¦åˆ™ä¼šé€ æˆé‡å¤ç¼–è¾‘
        broadcastToPicture(pictureId, pictureEditResponseMessage, session);
    }
}
```

ç”¨æˆ·é€€å‡ºç¼–è¾‘æ“ä½œæ—¶ï¼Œç§»é™¤å½“å‰ç”¨æˆ·çš„ç¼–è¾‘çŠ¶æ€ï¼Œå¹¶ä¸”å‘å…¶ä»–å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼š

```java
public void handleExitEditMessage(PictureEditRequestMessage pictureEditRequestMessage, WebSocketSession session, User user, Long pictureId) throws Exception {
    Long editingUserId = pictureEditingUsers.get(pictureId);
    if (editingUserId != null && editingUserId.equals(user.getId())) {
        // ç§»é™¤å½“å‰ç”¨æˆ·çš„ç¼–è¾‘çŠ¶æ€
        pictureEditingUsers.remove(pictureId);
        // æ„é€ å“åº”ï¼Œå‘é€é€€å‡ºç¼–è¾‘çš„æ¶ˆæ¯é€šçŸ¥
        PictureEditResponseMessage pictureEditResponseMessage = new PictureEditResponseMessage();
        pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.EXIT_EDIT.getValue());
        String message = String.format("%sé€€å‡ºç¼–è¾‘å›¾ç‰‡", user.getUserName());
        pictureEditResponseMessage.setMessage(message);
        pictureEditResponseMessage.setUser(userService.getUserVO(user));
        broadcastToPicture(pictureId, pictureEditResponseMessage);
    }
}
```

5ï¼‰WebSocket è¿æ¥å…³é—­æ—¶ï¼Œéœ€è¦ç§»é™¤å½“å‰ç”¨æˆ·çš„ç¼–è¾‘çŠ¶æ€ã€å¹¶ä¸”ä»é›†åˆä¸­åˆ é™¤å½“å‰ä¼šè¯ï¼Œè¿˜å¯ä»¥ç»™å…¶ä»–å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯é€šçŸ¥ï¼š

```java
@Override
public void afterConnectionClosed(WebSocketSession session, @NotNull CloseStatus status) throws Exception {
    Map<String, Object> attributes = session.getAttributes();
    Long pictureId = (Long) attributes.get("pictureId");
    User user = (User) attributes.get("user");
    // ç§»é™¤å½“å‰ç”¨æˆ·çš„ç¼–è¾‘çŠ¶æ€
    handleExitEditMessage(null, session, user, pictureId);

    // åˆ é™¤ä¼šè¯
    Set<WebSocketSession> sessionSet = pictureSessions.get(pictureId);
    if (sessionSet != null) {
        sessionSet.remove(session);
        if (sessionSet.isEmpty()) {
            pictureSessions.remove(pictureId);
        }
    }

    // å“åº”
    PictureEditResponseMessage pictureEditResponseMessage = new PictureEditResponseMessage();
    pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.INFO.getValue());
    String message = String.format("%sç¦»å¼€ç¼–è¾‘", user.getUserName());
    pictureEditResponseMessage.setMessage(message);
    pictureEditResponseMessage.setUser(userService.getUserVO(user));
    broadcastToPicture(pictureId, pictureEditResponseMessage);
}
```

ğŸ’¡ ç”±äºå¤„ç†å™¨çš„ä»£ç å¹¶ä¸å¤æ‚ï¼Œè€Œä¸”å¤„ç†é€»è¾‘ä¸­ä½¿ç”¨åˆ°äº†å½“å‰ç±»çš„å…¨å±€å˜é‡ï¼Œæ‰€ä»¥é±¼çš®æ²¡æœ‰é€‰æ‹©å°†æ¯ä¸ªå¤„ç†å™¨å°è£…ä¸ºå•ç‹¬çš„ç±»ã€‚å¤§å®¶ä¹Ÿå¯ä»¥å°†æ¯ä¸ªå¤„ç†å™¨å°è£…ä¸ºå•ç‹¬çš„ç±»ï¼ˆç›¸å½“äºè®¾è®¡æ¨¡å¼ä¸­çš„ç­–ç•¥æ¨¡å¼ï¼‰ï¼Œå¹¶ä¸”æ ¹æ®æ¶ˆæ¯ç±»åˆ«è°ƒç”¨ä¸åŒçš„å¤„ç†å™¨ç±»ã€‚

### 5ã€WebSocket é…ç½®

ç±»ä¼¼äºç¼–å†™ Spring MVC çš„ Controller æ¥å£ï¼Œå¯ä»¥ä¸ºæŒ‡å®šçš„è·¯å¾„é…ç½®å¤„ç†å™¨å’Œæ‹¦æˆªå™¨ï¼š

```java
@Configuration
@EnableWebSocket
public class WebSocketConfig implements WebSocketConfigurer {

    @Resource
    private PictureEditHandler pictureEditHandler;

    @Resource
    private WsHandshakeInterceptor wsHandshakeInterceptor;

    @Override
    public void registerWebSocketHandlers(WebSocketHandlerRegistry registry) {
        // websocket
        registry.addHandler(pictureEditHandler, "/ws/picture/edit")
                .addInterceptors(wsHandshakeInterceptor)
                .setAllowedOrigins("*");
    }
}
```

ä¹‹åï¼Œå‰ç«¯å°±å¯ä»¥é€šè¿‡ WebSocket è¿æ¥é¡¹ç›®å¯åŠ¨ç«¯å£çš„ `/ws/picture/edit` è·¯å¾„äº†ã€‚

## å››ã€æ‰©å±•çŸ¥è¯† - Disruptor ä¼˜åŒ–

### 1ã€ç°å­˜çš„ç³»ç»Ÿé—®é¢˜

WebSocket é€šå¸¸æ˜¯é•¿è¿æ¥ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯éƒ½éœ€è¦å ç”¨æœåŠ¡å™¨èµ„æºã€‚åœ¨ Spring WebSocket ä¸­ï¼Œæ¯ä¸ª WebSocket è¿æ¥ï¼ˆå®¢æˆ·ç«¯ï¼‰å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„ `WebSocketSession`ï¼Œæ¶ˆæ¯çš„å¤„ç†æ˜¯åœ¨è¯¥ `WebSocketSession` æ‰€å±çš„çº¿ç¨‹ä¸­æ‰§è¡Œã€‚

å¦‚æœ **åŒä¸€ä¸ª** WebSocket è¿æ¥ï¼ˆå®¢æˆ·ç«¯ï¼‰è¿ç»­å‘é€å¤šæ¡æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨ä¼š **æŒ‰ç…§æ¥æ”¶çš„é¡ºåºä¾æ¬¡åŒæ­¥å¤„ç†**ï¼Œè€Œä¸æ˜¯å¹¶å‘æ‰§è¡Œã€‚è¿™æ˜¯ä¸ºäº†ä¿è¯æ¯ä¸ªå®¢æˆ·ç«¯çš„æ¶ˆæ¯å¤„ç†æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

å¯ä»¥åœ¨ `handleTextMessage` æ–¹æ³•ä¸­å¢åŠ  `Thread.sleep` æ¥æµ‹è¯•ä¸€ä¸‹ã€‚è¿ç»­ç‚¹å‡»å¤šæ¬¡ç¼–è¾‘æ“ä½œï¼Œä¼šå‘ç°æ¯éš”ä¸€æ®µæ—¶é—´æ–¹æ³•æ‰ä¼šæ‰§è¡Œä¸€æ¬¡ã€‚

è™½ç„¶å¤šä¸ªå®¢æˆ·ç«¯çš„æ¶ˆæ¯å¤„ç†æ˜¯å¯ä»¥å¹¶å‘æ‰§è¡Œçš„ï¼Œä½†æ˜¯æ¥å—æ¶ˆæ¯å’Œå…·ä½“å¤„ç†æŸä¸ªæ¶ˆæ¯ä½¿ç”¨çš„æ˜¯ **åŒä¸€ä¸ªçº¿ç¨‹**ã€‚å¦‚æœå¤„ç†æ¶ˆæ¯çš„è€—æ—¶æ¯”è¾ƒé•¿ï¼Œå¹¶å‘é‡åˆæ¯”è¾ƒé«˜ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿå“åº”æ—¶é—´å˜é•¿ï¼Œç”šè‡³å› ä¸ºèµ„æºè€—å°½è€ŒæœåŠ¡å´©æºƒã€‚

ğŸ’¡ ä¸ºäº†ä¾¿äºç†è§£ï¼Œå¯ä»¥ç±»æ¯”ä¸€ä¸‹è°ƒç”¨ Spring MVC çš„æŸä¸ªæ¥å£æ—¶ï¼Œå¦‚æœè¯¥æ¥å£å†…éƒ¨çš„è€—æ—¶è¾ƒé•¿ï¼Œè¯·æ±‚çº¿ç¨‹å°±ä¼šä¸€ç›´é˜»å¡ï¼Œæœ€ç»ˆå¯¼è‡´ Tomcat è¯·æ±‚è¿æ¥æ•°è€—å°½ã€‚

æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯å¼€ä¸€ä¸ªçº¿ç¨‹ä¸“é—¨æ¥å¼‚æ­¥å¤„ç†æ¶ˆæ¯ã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜è¦ä¿è¯æ“ä½œæ˜¯æŒ‰ç…§é¡ºåºåŒæ­¥ç»™å…¶ä»–å®¢æˆ·ç«¯çš„ï¼Œå› æ­¤è¿˜éœ€è¦å¼•å…¥ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå°†ä»»åŠ¡æŒ‰ç…§é¡ºåºæ”¾åˆ°é˜Ÿåˆ—ä¸­ï¼Œäº¤ç»™çº¿ç¨‹å»å¤„ç†ã€‚

![img](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221705296.webp)

å…¶å®ä¸Šè¿°çš„å¼‚æ­¥æ“ä½œ + ä»ä»»åŠ¡é˜Ÿåˆ—å–ä»»åŠ¡æ‰§è¡Œï¼Œä½¿ç”¨çº¿ç¨‹æ± å°±å¯ä»¥å®ç°äº†ã€‚

ä½†å¯¹äºååŒç¼–è¾‘åœºæ™¯ï¼Œéœ€è¦å°½å¯èƒ½åœ°ä¿è¯ä½å»¶è¿Ÿï¼Œå› æ­¤æˆ‘ä»¬é€‰ç”¨ä¸€ç§é«˜çº§æŠ€æœ¯ **Disruptor** æ— é”é˜Ÿåˆ—æ¥å‡å°‘çº¿ç¨‹ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ï¼Œèƒ½å¤Ÿåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä¿æŒä½å»¶è¿Ÿå’Œé«˜ååé‡ã€‚4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=

æ­¤å¤–ï¼Œä½¿ç”¨ Disruptor è¿˜æœ‰ä¸€ä¸ªä¼˜ç‚¹ï¼Œå¯ä»¥å°†ä»»åŠ¡æ”¾åˆ°é˜Ÿåˆ—ä¸­ï¼Œé€šè¿‡ä¼˜é›…åœæœºæœºåˆ¶ï¼Œåœ¨æœåŠ¡åœæ­¢å‰æ‰§è¡Œå®Œæ‰€æœ‰çš„ä»»åŠ¡ï¼Œå†é€€å‡ºæœåŠ¡ï¼Œé˜²æ­¢æ¶ˆæ¯ä¸¢å¤±ã€‚

### 2ã€Disruptor ä»‹ç»

[Disruptor](https://lmax-exchange.github.io/disruptor/#_what_is_the_disruptor) æ˜¯ä¸€ç§é«˜æ€§èƒ½çš„å¹¶å‘æ¡†æ¶ï¼Œç”± LMAXï¼ˆä¸€ä¸ªé‡‘èäº¤æ˜“ç³»ç»Ÿå…¬å¸ï¼‰å¼€å‘ï¼Œå®ƒæ˜¯ä¸€ç§ **æ— é”çš„ç¯å½¢é˜Ÿåˆ—** æ•°æ®ç»“æ„ï¼Œç”¨äºè§£å†³é«˜ååé‡å’Œä½å»¶è¿Ÿåœºæ™¯ä¸­çš„å¹¶å‘é—®é¢˜ã€‚æ”¯æŒç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œå¯ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨ï¼Œé€‚ç”¨äºé‡‘èäº¤æ˜“ã€å®æ—¶æ•°æ®å¤„ç†ã€æ¸¸æˆäº‹ä»¶ç­‰å¯¹å¹¶å‘å’Œå®æ—¶æ€§è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ã€‚

å®ƒæœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯å¿«ã€å»¶è¿Ÿä½ï¼Œéå¸¸ä½ï¼

![img](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221705303.png)

Disruptor çš„æ ¸å¿ƒæ€æƒ³æ˜¯åŸºäºå›ºå®šå¤§å°çš„ **ç¯å½¢ç¼“å†²åŒº**ï¼ˆRing Bufferï¼‰ï¼Œå¹¶é€šè¿‡åºåˆ—åŒ–æ§åˆ¶è®¿é—®ï¼Œä»¥é¿å…ä¼ ç»Ÿé˜Ÿåˆ—ä¸­å¸¸è§çš„

å®ƒä¸»è¦é€šè¿‡ä»¥ä¸‹å‡ ç‚¹å®ç°é«˜æ€§èƒ½çš„æ¶ˆæ¯ä¼ é€’æœºåˆ¶ï¼š

1. ç¯å½¢ç¼“å†²åŒºï¼šä½¿ç”¨å›ºå®šå¤§å°çš„æ•°ç»„ï¼Œå¯ä»¥å¤ç”¨å†…å­˜ï¼Œé¿å…äº†é¢‘ç¹çš„å†…å­˜åˆ†é…å’Œåƒåœ¾å›æ”¶ã€‚
2. æ— é”è®¾è®¡ï¼šä¾èµ– CASï¼ˆCompare-And-Swapï¼‰å’Œå†…å­˜å±éšœï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿçš„é”ï¼Œé™ä½äº†çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ã€‚
3. ç¼“å­˜å‹å¥½ï¼šæœ€å¤§åŒ–åˆ©ç”¨ CPU çš„ç¼“å­˜å±€éƒ¨æ€§ï¼Œæé«˜è®¿é—®é€Ÿåº¦ã€‚
4. åºåˆ—å·æœºåˆ¶ï¼šé€šè¿‡åºåˆ—å·ç®¡ç†ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„è®¿é—®ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚
5. å¤šæ¶ˆè´¹è€…æ¨¡å¼ï¼šæ”¯æŒå¤šæ¶ˆè´¹è€…å…±äº«åŒä¸€ç¯å½¢ç¼“å†²åŒºï¼Œå¹¶èƒ½é…ç½®ä¸åŒçš„æ¶ˆè´¹ç­–ç•¥ï¼ˆå¦‚ä¾èµ–å…³ç³»ã€å¹¶è¡Œæ¶ˆè´¹ç­‰ï¼‰ã€‚

Disruptor ä¸ä¼ ç»Ÿé˜Ÿåˆ—å¯¹æ¯”ï¼š

| ç‰¹æ€§     | Disruptor                  | BlockingQueue           |
| -------- | -------------------------- | ----------------------- |
| å¹¶å‘æ§åˆ¶ | æ— é”ï¼ˆCAS + å†…å­˜å±éšœï¼‰     | åŸºäºé”ï¼ˆReentrantLockï¼‰ |
| å†…å­˜ç®¡ç† | å›ºå®šé•¿åº¦çš„ç¯å½¢æ•°ç»„         | åŠ¨æ€æ•°ç»„æˆ–é“¾è¡¨          |
| æ€§èƒ½     | æé«˜ï¼ˆç™¾ä¸‡çº§åˆ«æ¶ˆæ¯/ç§’ï¼‰    | è¾ƒä½ï¼ˆæ•°ä¸‡æ¶ˆæ¯/ç§’ï¼‰     |
| å»¶è¿Ÿ     | çº³ç§’çº§åˆ«                   | æ¯«ç§’çº§åˆ«                |
| GC å‹åŠ›  | æä½ï¼ˆæ•°æ®å¤ç”¨ï¼‰           | è¾ƒé«˜ï¼ˆé¢‘ç¹åˆ›å»ºæ–°å¯¹è±¡ï¼‰  |
| é€‚ç”¨åœºæ™¯ | é«˜é¢‘å®æ—¶æ¶ˆæ¯å¤„ç†ã€é‡‘èç³»ç»Ÿ | ä¸€èˆ¬ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹    |

### 3ã€Disruptor æ ¸å¿ƒæ¦‚å¿µä¸å·¥ä½œæµç¨‹

å…ˆäº†è§£ Disruptor çš„æ ¸å¿ƒæ¦‚å¿µï¼š58IUDBvyDy7G+gVMqAunJfAo72ZBX//2DD/nhaX54Xg=

- RingBufferï¼ˆç¯å½¢ç¼“å†²åŒºï¼‰ï¼šå›ºå®šå¤§å°çš„å¾ªç¯æ•°ç»„ï¼Œç”¨äºå­˜å‚¨æ•°æ®é¡¹ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å…±äº«è¯¥æ•°æ®ç»“æ„ã€‚
- Eventï¼ˆäº‹ä»¶ï¼‰ï¼šå­˜å‚¨åœ¨ `RingBuffer` ä¸­çš„æ•°æ®å¯¹è±¡ï¼Œç”¨äºè¡¨ç¤ºè¦ä¼ é€’çš„æ¶ˆæ¯æˆ–æ•°æ®ã€‚
- Producerï¼ˆç”Ÿäº§è€…ï¼‰ï¼šè´Ÿè´£å‘ `RingBuffer` å†™å…¥æ•°æ®çš„è§’è‰²ã€‚
- Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰ï¼šä» `RingBuffer` ä¸­è¯»å–å¹¶å¤„ç†æ•°æ®çš„è§’è‰²ã€‚
- Sequencerï¼ˆåºåˆ—å™¨ï¼‰ï¼šç®¡ç†ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…çš„ç´¢å¼•ï¼Œç¡®ä¿å¹¶å‘å®‰å…¨çš„åºåˆ—ç®¡ç†ã€‚
- SequenceBarrierï¼ˆåºåˆ—å±éšœï¼‰ï¼šæ§åˆ¶æ¶ˆè´¹è€…ç­‰å¾…æ•°æ®å¯ç”¨çš„æœºåˆ¶ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§ã€‚
- WaitStrategyï¼ˆç­‰å¾…ç­–ç•¥ï¼‰ï¼šå®šä¹‰æ¶ˆè´¹è€…å¦‚ä½•ç­‰å¾…æ–°çš„æ•°æ®ï¼ˆå¦‚è‡ªæ—‹ã€è‡ªé€‚åº”ç­‰å¾…ç­‰ï¼‰ã€‚
- EventProcessorï¼ˆäº‹ä»¶å¤„ç†å™¨ï¼‰ï¼šé›†æˆäº† `Consumer` å’Œ `SequenceBarrier`ï¼Œç”¨äºæ›´é«˜çº§çš„æ¶ˆè´¹æ§åˆ¶ã€‚

è€Œ Disruptor æ˜¯å°è£…äº† `RingBuffer`ã€`Producer` å’Œ `Consumer` çš„æ ¸å¿ƒç®¡ç†ç±»ï¼Œç”¨äºåè°ƒæ‰€æœ‰ç»„ä»¶çš„è¿è¡Œã€‚

ä¸‹é¢æˆ‘ä¸¾ä¾‹æ¥è¯´æ˜ Disruptor çš„å·¥ä½œæµç¨‹ï¼šJ+5o58b0kn/bTqd/50F76o1L2/PhqvQWrl14ca26WW0=

1. ç¯å½¢é˜Ÿåˆ—åˆå§‹åŒ–ï¼šåˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°ä¸º 8 çš„ RingBufferï¼ˆç´¢å¼•èŒƒå›´ 0-7ï¼‰ï¼Œæ¯ä¸ªæ ¼å­å­˜å‚¨ä¸€ä¸ªå¯å¤ç”¨çš„äº‹ä»¶å¯¹è±¡ï¼Œåºå·åˆå§‹ä¸º 0ã€‚
2. ç”Ÿäº§è€…å†™å…¥æ•°æ®ï¼šç”Ÿäº§è€…ç”³è¯·ç´¢å¼• 0ï¼ˆåºå· 0ï¼‰ï¼Œå°†æ•°æ® "A" å†™å…¥äº‹ä»¶å¯¹è±¡ï¼Œæäº¤ååºå·é€’å¢ä¸º 1ï¼Œä¸‹ä¸€ä¸ªå†™å…¥ç´¢å¼•å˜ä¸º 1ã€‚
3. æ¶ˆè´¹è€…è¯»å–æ•°æ®ï¼šæ¶ˆè´¹è€…æ£€æŸ¥ç´¢å¼• 0ï¼ˆåºå· 0ï¼‰ï¼Œè¯»å–æ•°æ® "A"ï¼Œå¤„ç†åæäº¤ï¼Œåºå·é€’å¢ä¸º 1ï¼Œä¸‹ä¸€ä¸ªè¯»å–ç´¢å¼•å˜ä¸º 1ã€‚
4. ç¯å½¢é˜Ÿåˆ—å¾ªç¯ä½¿ç”¨ï¼šå½“ç”Ÿäº§è€…å†™å…¥åˆ°ç´¢å¼• 7ï¼ˆåºå· 7ï¼‰åï¼Œç´¢å¼•å›åˆ° 0ï¼ˆåºå· 8ï¼‰ï¼Œå½¢æˆå¾ªç¯å­˜å‚¨ï¼Œ**ä½†åºå·ä¼šæŒç»­è‡ªå¢ä»¥åŒºåˆ†æ•°æ®çš„å…ˆåé¡ºåºã€‚**
5. é˜²æ­¢æ•°æ®è¦†ç›–ï¼šå¦‚æœç”Ÿäº§è€…è¿½ä¸Šæ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…å°šæœªå¤„ç†å®Œæ•°æ®ï¼Œç”Ÿäº§è€…ä¼šç­‰å¾…ï¼Œç¡®ä¿æ•°æ®ä¸è¢«è¦†ç›–ã€‚

ä¸‹å›¾æ˜¯ä¸€ä¸ª Disruptor ç”Ÿäº§è€…çš„æ¨¡å‹ï¼Œä»…ä¾›å‚è€ƒï¼Œäº†è§£ä¸€ä¸‹å³å¯ï¼š

![img](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221705308.webp)

å…¶å®å¯¹å¤§å®¶æ¥è¯´ï¼Œå…ˆå°† Disruptor å½“åšä¸€ä¸ªé«˜æ€§èƒ½çš„é˜Ÿåˆ—æ¥ä½¿ç”¨å°±å¯ä»¥äº†ï¼Œå¯ä»¥å‘é˜Ÿåˆ—ä¸­æ·»åŠ äº‹ä»¶å¹¶å®šä¹‰å¤„ç†æ–¹å¼ã€‚æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥é˜…è¯» [è¿™ç¯‡æ–‡ç« ](https://juejin.cn/post/6844903648875528206) æ·±å…¥äº†è§£ Disruptor æ€§èƒ½é«˜çš„åŸå› ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥å¼•å…¥ Disruptor æ¥ä¼˜åŒ–ä»£ç ã€‚

### 4ã€Disruptor å®æˆ˜

1ï¼‰å¼•å…¥ Disruptor ä¾èµ–

```xml
<!-- é«˜æ€§èƒ½æ— é”é˜Ÿåˆ— -->
<dependency>
    <groupId>com.lmax</groupId>
    <artifactId>disruptor</artifactId>
    <version>3.4.2</version>
</dependency>
```

2ï¼‰å®šä¹‰äº‹ä»¶

äº‹ä»¶æ˜¯ Disruptor æ‰§è¡Œçš„æ ¸å¿ƒå•ä½ï¼Œåœ¨ `websocket.disruptor` åŒ…ä¸­æ–°å»º PictureEditEvent ç±»ï¼Œå……å½“äº†ä¸Šä¸‹æ–‡å®¹å™¨ï¼Œæ‰€æœ‰å¤„ç†æ¶ˆæ¯æ‰€éœ€çš„æ•°æ®éƒ½è¢«å°è£…åœ¨å…¶ä¸­ã€‚

```java
@Data
public class PictureEditEvent {

    /**
     * æ¶ˆæ¯
     */
    private PictureEditRequestMessage pictureEditRequestMessage;

    /**
     * å½“å‰ç”¨æˆ·çš„ session
     */
    private WebSocketSession session;
    
    /**
     * å½“å‰ç”¨æˆ·
     */
    private User user;

    /**
     * å›¾ç‰‡ id
     */
    private Long pictureId;

}
```

3ï¼‰å®šä¹‰äº‹ä»¶å¤„ç†å™¨ï¼ˆæ¶ˆè´¹è€…ï¼‰

è¿™é‡ŒåŸºæœ¬ä¸Šæ˜¯æŠŠ `PictureEditHandler` åˆ†å‘æ¶ˆæ¯çš„é€»è¾‘æ¬äº†è¿‡æ¥ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯å°†ä¸åŒç±»å‹çš„æ¶ˆæ¯åˆ†å‘åˆ°å¯¹åº”çš„å¤„ç†å™¨ä¸­ã€‚

```java
@Slf4j
@Component
public class PictureEditEventWorkHandler implements WorkHandler<PictureEditEvent> {

    @Resource
    @Lazy
    private PictureEditHandler pictureEditHandler;

    @Resource
    private UserService userService;

    @Override
    public void onEvent(PictureEditEvent event) throws Exception {
        PictureEditRequestMessage pictureEditRequestMessage = event.getPictureEditRequestMessage();
        WebSocketSession session = event.getSession();
        User user = event.getUser();
        Long pictureId = event.getPictureId();
        // è·å–åˆ°æ¶ˆæ¯ç±»åˆ«
        String type = pictureEditRequestMessage.getType();
        PictureEditMessageTypeEnum pictureEditMessageTypeEnum = PictureEditMessageTypeEnum.valueOf(type);
        // è°ƒç”¨å¯¹åº”çš„æ¶ˆæ¯å¤„ç†æ–¹æ³•
        switch (pictureEditMessageTypeEnum) {
            case ENTER_EDIT:
                pictureEditHandler.handleEnterEditMessage(pictureEditRequestMessage, session, user, pictureId);
                break;
            case EDIT_ACTION:
                pictureEditHandler.handleEditActionMessage(pictureEditRequestMessage, session, user, pictureId);
                break;
            case EXIT_EDIT:
                pictureEditHandler.handleExitEditMessage(pictureEditRequestMessage, session, user, pictureId);
                break;
            default:
                PictureEditResponseMessage pictureEditResponseMessage = new PictureEditResponseMessage();
                pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.ERROR.getValue());
                pictureEditResponseMessage.setMessage("æ¶ˆæ¯ç±»å‹é”™è¯¯");
                pictureEditResponseMessage.setUser(userService.getUserVO(user));
                session.sendMessage(new TextMessage(JSONUtil.toJsonStr(pictureEditResponseMessage)));
        }
    }
}
```

4ï¼‰æ·»åŠ  Disruptor é…ç½®ç±»ï¼Œå°†æˆ‘ä»¬åˆšå®šä¹‰çš„äº‹ä»¶åŠå¤„ç†å™¨å…³è”åˆ° Disruptor å®ä¾‹ä¸­ï¼š4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=

```java
@Configuration
public class PictureEditEventDisruptorConfig {

    @Resource
    private PictureEditEventWorkHandler pictureEditEventWorkHandler;

    @Bean("pictureEditEventDisruptor")
    public Disruptor<PictureEditEvent> messageModelRingBuffer() {
        // ringBuffer çš„å¤§å°
        int bufferSize = 1024 * 256;
        Disruptor<PictureEditEvent> disruptor = new Disruptor<>(
                PictureEditEvent::new,
                bufferSize,
                ThreadFactoryBuilder.create().setNamePrefix("pictureEditEventDisruptor").build()
        );
        // è®¾ç½®æ¶ˆè´¹è€…
        disruptor.handleEventsWithWorkerPool(pictureEditEventWorkHandler);
        // å¼€å¯ disruptor
        disruptor.start();
        return disruptor;
    }
}
```

5ã€å®šä¹‰äº‹ä»¶ç”Ÿäº§è€…

ç”Ÿäº§è€…è´Ÿè´£å°†æ•°æ®ï¼ˆäº‹ä»¶ï¼‰å‘åˆ° Disruptor çš„ç¯å½¢ç¼“å†²åŒºä¸­ã€‚ä¸ºäº†ä¿è¯åœ¨åœæœºæ—¶æ‰€æœ‰çš„æ¶ˆæ¯éƒ½èƒ½å¤Ÿè¢«å¤„ç†ï¼Œæˆ‘ä»¬é€šè¿‡ `shutdown` æ–¹æ³•å®Œæˆ Disruptor çš„ä¼˜é›…åœæœºã€‚

```java
@Component
@Slf4j
public class PictureEditEventProducer {

    @Resource
    Disruptor<PictureEditEvent> pictureEditEventDisruptor;

    public void publishEvent(PictureEditRequestMessage pictureEditRequestMessage, WebSocketSession session, User user, Long pictureId) {
        RingBuffer<PictureEditEvent> ringBuffer = pictureEditEventDisruptor.getRingBuffer();
        // è·å–å¯ä»¥ç”Ÿæˆçš„ä½ç½®
        long next = ringBuffer.next();
        PictureEditEvent pictureEditEvent = ringBuffer.get(next);
        pictureEditEvent.setSession(session);
        pictureEditEvent.setPictureEditRequestMessage(pictureEditRequestMessage);
        pictureEditEvent.setUser(user);
        pictureEditEvent.setPictureId(pictureId);
        // å‘å¸ƒäº‹ä»¶
        ringBuffer.publish(next);
    }

    /**
     * ä¼˜é›…åœæœº
     */
    @PreDestroy
    public void close() {
        pictureEditEventDisruptor.shutdown();
    }
}
```

6ã€ä¿®æ”¹ PictureEditHandler çš„åŸæœ‰é€»è¾‘ï¼Œæ”¹ä¸ºä½¿ç”¨äº‹ä»¶ç”Ÿäº§è€…ï¼š

```java
@Resource
private PictureEditEventProducer pictureEditEventProducer;

@Override
protected void handleTextMessage(WebSocketSession session, TextMessage message) throws Exception {
    // å°†æ¶ˆæ¯è§£æä¸º PictureEditMessage
    PictureEditRequestMessage pictureEditRequestMessage = JSONUtil.toBean(message.getPayload(), PictureEditRequestMessage.class);
    // ä» Session å±æ€§ä¸­è·å–å…¬å…±å‚æ•°
    Map<String, Object> attributes = session.getAttributes();
    User user = (User) attributes.get("user");
    Long pictureId = (Long) attributes.get("pictureId");
    // ç”Ÿäº§æ¶ˆæ¯
    pictureEditEventProducer.publishEvent(pictureEditRequestMessage, session, user, pictureId);
}
```

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®ç°äº†åŸºäº Disruptor çš„å¼‚æ­¥æ¶ˆæ¯å¤„ç†æœºåˆ¶ï¼Œå°†åŸæœ‰çš„åŒæ­¥æ¶ˆæ¯åˆ†å‘é€»è¾‘æ”¹é€ ä¸ºé«˜æ•ˆè§£è€¦çš„å¼‚æ­¥å¤„ç†æ¨¡å‹ï¼Œä¹Ÿæ›´æœ‰åˆ©äºä»£ç çš„æ‰©å±•ã€‚

### æ‰©å±•

1ã€ä¸ºé˜²æ­¢æ¶ˆæ¯ä¸¢å¤±ï¼Œå¯ä»¥ä½¿ç”¨ Redis ç­‰é«˜æ€§èƒ½å­˜å‚¨ä¿å­˜æ‰§è¡Œçš„æ“ä½œè®°å½•ã€‚

ç›®å‰å¦‚æœå›¾ç‰‡å·²ç»è¢«ç¼–è¾‘äº†ï¼Œæ–°ç”¨æˆ·åŠ å…¥ç¼–è¾‘æ—¶æ²¡åŠæ³•æŸ¥çœ‹åˆ°å·²ç¼–è¾‘çš„çŠ¶æ€ï¼Œè¿™ä¸€ç‚¹ä¹Ÿå¯ä»¥åˆ©ç”¨ Redis ä¿å­˜æ“ä½œè®°å½•æ¥è§£å†³ï¼Œæ–°ç”¨æˆ·åŠ å…¥ç¼–è¾‘æ—¶è¯»å– Redis çš„æ“ä½œè®°å½•å³å¯ã€‚

2ã€æ¯ç§ç±»å‹çš„æ¶ˆæ¯å¤„ç†å¯ä»¥å°è£…ä¸ºç‹¬ç«‹çš„ Handler å¤„ç†å™¨ç±»ï¼Œä¹Ÿå°±æ˜¯é‡‡ç”¨ç­–ç•¥æ¨¡å¼ã€‚

3ã€æ”¯æŒåˆ†å¸ƒå¼ WebSocketã€‚å®ç°æ€è·¯å¾ˆç®€å•ï¼Œåªéœ€è¦ä¿è¯è¦ç¼–è¾‘åŒä¸€å›¾ç‰‡çš„ç”¨æˆ·è¿æ¥çš„æ˜¯ç›¸åŒçš„æœåŠ¡å™¨å³å¯ï¼Œå’Œæ¸¸æˆåˆ†æœåŠ¡å™¨å¤§åŒºã€èŠå¤©å®¤åˆ†æˆ¿é—´æ˜¯ç±»ä¼¼çš„åŸç†ã€‚

4ã€ä¸€äº›å°é—®é¢˜çš„ä¼˜åŒ–ï¼šæ¯”å¦‚ WebSocket è¿æ¥å»ºç«‹ä¹‹åï¼Œå¦‚æœç”¨æˆ·é€€å‡ºäº†ç™»å½•ï¼Œè¿™æ—¶ WebSocket çš„è¿æ¥æ˜¯æ²¡æœ‰æ–­å¼€çš„ã€‚ä¸è¿‡å½±å“å¹¶ä¸å¤§ï¼Œå¤§å®¶å¯ä»¥æ€è€ƒä¸‹æ€ä¹ˆå¤„ç†ã€‚