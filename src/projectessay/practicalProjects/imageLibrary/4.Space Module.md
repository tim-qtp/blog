---
order: 4
author: 
title: "ç©ºé—´æ¨¡å—"
category:
  - äº‘å›¾åº“
  - é¡¹ç›®
---

### 1ã€å¯¹äºç©ºé—´æ¨¡å—ï¼Œé€šå¸¸å¾—æœ‰è¿™äº›åŠŸèƒ½ï¼š

1ï¼‰ç®¡ç†ç©ºé—´ï¼šä»…ç®¡ç†å‘˜å¯ç”¨ï¼Œå¯ä»¥å¯¹æ•´ä¸ªç³»ç»Ÿä¸­çš„ç©ºé—´è¿›è¡Œç®¡ç†ï¼Œæ¯”å¦‚æœç´¢ç©ºé—´ã€ç¼–è¾‘ç©ºé—´ã€åˆ é™¤ç©ºé—´ï¼Œç©ºé—´åˆ†æã€‚

2ï¼‰ç”¨æˆ·åˆ›å»ºç§æœ‰ç©ºé—´ï¼šç”¨æˆ·å¯ä»¥åˆ›å»º **æœ€å¤šä¸€ä¸ª** ç§æœ‰ç©ºé—´ï¼Œå¹¶ä¸”åœ¨ç§æœ‰ç©ºé—´å†…è‡ªç”±ä¸Šä¼ å’Œç®¡ç†å›¾ç‰‡ã€‚

3ï¼‰ç§æœ‰ç©ºé—´æƒé™æ§åˆ¶ï¼šç”¨æˆ·ä»…èƒ½è®¿é—®å’Œç®¡ç†è‡ªå·±çš„ç§æœ‰ç©ºé—´å’Œå…¶ä¸­çš„å›¾ç‰‡ï¼Œç§æœ‰ç©ºé—´çš„å›¾ç‰‡ä¸ä¼šå±•ç¤ºåœ¨å…¬å…±å›¾åº“ï¼Œä¹Ÿä¸éœ€è¦ç®¡ç†å‘˜å®¡æ ¸ã€‚

4ï¼‰ç©ºé—´çº§åˆ«å’Œé™é¢æ§åˆ¶ï¼šæ¯ä¸ªç©ºé—´æœ‰ä¸åŒçš„çº§åˆ«ï¼ˆå¦‚æ™®é€šç‰ˆå’Œä¸“ä¸šç‰ˆï¼‰ï¼Œå¯¹åº”äº†ä¸åŒçš„å®¹é‡å’Œå›¾ç‰‡æ•°é‡é™åˆ¶ï¼Œå¦‚æœè¶…å‡ºé™åˆ¶åˆ™æ— æ³•ç»§ç»­ä¸Šä¼ å›¾ç‰‡ã€‚

### 2ã€ç©ºé—´åº“è¡¨è®¾è®¡

#### 1ã€ç©ºé—´è¡¨

```sql
-- ç©ºé—´è¡¨
create table if not exists space
(
    id         bigint auto_increment comment 'id' primary key,
    spaceName  varchar(128)                       null comment 'ç©ºé—´åç§°',
    spaceLevel int      default 0                 null comment 'ç©ºé—´çº§åˆ«ï¼š0-æ™®é€šç‰ˆ 1-ä¸“ä¸šç‰ˆ 2-æ——èˆ°ç‰ˆ',
    maxSize    bigint   default 0                 null comment 'ç©ºé—´å›¾ç‰‡çš„æœ€å¤§æ€»å¤§å°',
    maxCount   bigint   default 0                 null comment 'ç©ºé—´å›¾ç‰‡çš„æœ€å¤§æ•°é‡',
    totalSize  bigint   default 0                 null comment 'å½“å‰ç©ºé—´ä¸‹å›¾ç‰‡çš„æ€»å¤§å°',
    totalCount bigint   default 0                 null comment 'å½“å‰ç©ºé—´ä¸‹çš„å›¾ç‰‡æ•°é‡',
    userId     bigint                             not null comment 'åˆ›å»ºç”¨æˆ· id',
    createTime datetime default CURRENT_TIMESTAMP not null comment 'åˆ›å»ºæ—¶é—´',
    editTime   datetime default CURRENT_TIMESTAMP not null comment 'ç¼–è¾‘æ—¶é—´',
    updateTime datetime default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'æ›´æ–°æ—¶é—´',
    isDelete   tinyint  default 0                 not null comment 'æ˜¯å¦åˆ é™¤',
    -- ç´¢å¼•è®¾è®¡
    index idx_userId (userId),        -- æå‡åŸºäºç”¨æˆ·çš„æŸ¥è¯¢æ•ˆç‡
    index idx_spaceName (spaceName),  -- æå‡åŸºäºç©ºé—´åç§°çš„æŸ¥è¯¢æ•ˆç‡
    index idx_spaceLevel (spaceLevel) -- æå‡æŒ‰ç©ºé—´çº§åˆ«æŸ¥è¯¢çš„æ•ˆç‡
) comment 'ç©ºé—´' collate = utf8mb4_unicode_ci;
```

#### 2ã€å›¾ç‰‡è¡¨

ç”±äºä¸€å¼ å›¾ç‰‡åªèƒ½å±äºä¸€ä¸ªç©ºé—´ï¼Œå¯ä»¥åœ¨å›¾ç‰‡è¡¨ picture ä¸­æ–°å¢å­—æ®µ spaceIdï¼Œå®ç°å›¾ç‰‡ä¸ç©ºé—´çš„å…³è”ï¼ŒåŒæ—¶å¢åŠ ç´¢å¼•ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½ã€‚

SQL å¦‚ä¸‹ï¼š

```sql
-- æ·»åŠ æ–°åˆ—
ALTER TABLE picture
    ADD COLUMN spaceId  bigint  null comment 'ç©ºé—´ idï¼ˆä¸ºç©ºè¡¨ç¤ºå…¬å…±ç©ºé—´ï¼‰';

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_spaceId ON picture (spaceId); --æˆ‘ä»¬ç»å¸¸ç”¨ç©ºé—´idæŸ¥è¯¢æœ‰å¤šå°‘æ¡å›¾ç‰‡çš„
```

é»˜è®¤æƒ…å†µä¸‹ï¼ŒspaceId ä¸ºç©ºï¼Œè¡¨ç¤ºå›¾ç‰‡ä¸Šä¼ åˆ°äº†å…¬å…±å›¾åº“ã€‚

### 3ã€ç©ºé—´ç®¡ç†

#### 1ã€æ•°æ®æ¨¡å‹

1ï¼‰åˆ©ç”¨ MyBatisX æ’ä»¶ç”Ÿæˆç©ºé—´è¡¨ç›¸å…³çš„åŸºç¡€ä»£ç ï¼ŒåŒ…æ‹¬å®ä½“ç±»ã€Mapperã€Serviceï¼Œç„¶åä¿®æ”¹å®ä½“ç±»çš„ä¸»é”®ç”Ÿæˆç­–ç•¥å¹¶æŒ‡å®šé€»è¾‘åˆ é™¤å­—æ®µï¼ŒSpace ç±»çš„ä»£ç å¦‚ä¸‹ï¼š

```java
@TableName(value ="space")
@Data
public class Space implements Serializable {
    /**
     * id
     */
    @TableId(type = IdType.ASSIGN_ID)
    private Long id;

    /**
     * ç©ºé—´åç§°
     */
    private String spaceName;

    /**
     * ç©ºé—´çº§åˆ«ï¼š0-æ™®é€šç‰ˆ 1-ä¸“ä¸šç‰ˆ 2-æ——èˆ°ç‰ˆ
     */
    private Integer spaceLevel;

    /**
     * ç©ºé—´å›¾ç‰‡çš„æœ€å¤§æ€»å¤§å°
     */
    private Long maxSize;

    /**
     * ç©ºé—´å›¾ç‰‡çš„æœ€å¤§æ•°é‡
     */
    private Long maxCount;

    /**
     * å½“å‰ç©ºé—´ä¸‹å›¾ç‰‡çš„æ€»å¤§å°
     */
    private Long totalSize;

    /**
     * å½“å‰ç©ºé—´ä¸‹çš„å›¾ç‰‡æ•°é‡
     */
    private Long totalCount;

    /**
     * åˆ›å»ºç”¨æˆ· id
     */
    private Long userId;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;

    /**
     * ç¼–è¾‘æ—¶é—´
     */
    private Date editTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    private Date updateTime;

    /**
     * æ˜¯å¦åˆ é™¤
     */
    @TableLogic
    private Integer isDelete;

    @TableField(exist = false)
    private static final long serialVersionUID = 1L;
}
```

2ï¼‰æ¯ä¸ªæ“ä½œéƒ½éœ€è¦æä¾›ä¸€ä¸ªè¯·æ±‚ç±»ï¼Œéƒ½æ”¾åœ¨ `model.dto.space` åŒ…ä¸‹

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503211149246.png)

ç©ºé—´åˆ›å»ºè¯·æ±‚ï¼š

```java
@Data
public class SpaceAddRequest implements Serializable {

    /**
     * ç©ºé—´åç§°
     */
    private String spaceName;

    /**
     * ç©ºé—´çº§åˆ«ï¼š0-æ™®é€šç‰ˆ 1-ä¸“ä¸šç‰ˆ 2-æ——èˆ°ç‰ˆ
     */
    private Integer spaceLevel;

    private static final long serialVersionUID = 1L;
}
```

ç©ºé—´ç¼–è¾‘è¯·æ±‚ï¼Œ==ç»™ç”¨æˆ·ä½¿ç”¨==ï¼Œç›®å‰ä»…å…è®¸ç¼–è¾‘ç©ºé—´åç§°ï¼š

```java
@Data
public class SpaceEditRequest implements Serializable {

    /**
     * ç©ºé—´ id
     */
    private Long id;

    /**
     * ç©ºé—´åç§°
     */
    private String spaceName;

    private static final long serialVersionUID = 1L;
}
```

ç©ºé—´æ›´æ–°è¯·æ±‚ï¼Œ==ç»™ç®¡ç†å‘˜ä½¿ç”¨==ï¼Œå¯ä»¥ä¿®æ”¹ç©ºé—´çº§åˆ«å’Œé™é¢ï¼š

```java
@Data
public class SpaceUpdateRequest implements Serializable {

    /**
     * id
     */
    private Long id;

    /**
     * ç©ºé—´åç§°
     */
    private String spaceName;

    /**
     * ç©ºé—´çº§åˆ«ï¼š0-æ™®é€šç‰ˆ 1-ä¸“ä¸šç‰ˆ 2-æ——èˆ°ç‰ˆ
     */
    private Integer spaceLevel;

    /**
     * ç©ºé—´å›¾ç‰‡çš„æœ€å¤§æ€»å¤§å°
     */
    private Long maxSize;

    /**
     * ç©ºé—´å›¾ç‰‡çš„æœ€å¤§æ•°é‡
     */
    private Long maxCount;

    private static final long serialVersionUID = 1L;
}
```

ç©ºé—´æŸ¥è¯¢è¯·æ±‚ï¼š

```java
@EqualsAndHashCode(callSuper = true)
@Data
public class SpaceQueryRequest extends PageRequest implements Serializable {

    /**
     * id
     */
    private Long id;

    /**
     * ç”¨æˆ· id
     */
    private Long userId;

    /**
     * ç©ºé—´åç§°
     */
    private String spaceName;

    /**
     * ç©ºé—´çº§åˆ«ï¼š0-æ™®é€šç‰ˆ 1-ä¸“ä¸šç‰ˆ 2-æ——èˆ°ç‰ˆ
     */
    private Integer spaceLevel;

    private static final long serialVersionUID = 1L;
}
```

3ï¼‰åœ¨ `model.dto.vo` ä¸‹æ–°å»ºç©ºé—´çš„è§†å›¾åŒ…è£…ç±»ï¼Œå¯ä»¥é¢å¤–å…³è”åˆ›å»ºç©ºé—´çš„ç”¨æˆ·ä¿¡æ¯ã€‚è¿˜å¯ä»¥ç¼–å†™ Space å®ä½“ç±»å’Œè¯¥ VO ç±»çš„è½¬æ¢æ–¹æ³•ï¼Œä¾¿äºåç»­å¿«é€Ÿä¼ å€¼ã€‚

```java
@Data
public class SpaceVO implements Serializable {
    /**
     * id
     */
    private Long id;

    /**
     * ç©ºé—´åç§°
     */
    private String spaceName;

    /**
     * ç©ºé—´çº§åˆ«ï¼š0-æ™®é€šç‰ˆ 1-ä¸“ä¸šç‰ˆ 2-æ——èˆ°ç‰ˆ
     */
    private Integer spaceLevel;

    /**
     * ç©ºé—´å›¾ç‰‡çš„æœ€å¤§æ€»å¤§å°
     */
    private Long maxSize;

    /**
     * ç©ºé—´å›¾ç‰‡çš„æœ€å¤§æ•°é‡
     */
    private Long maxCount;

    /**
     * å½“å‰ç©ºé—´ä¸‹å›¾ç‰‡çš„æ€»å¤§å°
     */
    private Long totalSize;

    /**
     * å½“å‰ç©ºé—´ä¸‹çš„å›¾ç‰‡æ•°é‡
     */
    private Long totalCount;

    /**
     * åˆ›å»ºç”¨æˆ· id
     */
    private Long userId;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;

    /**
     * ç¼–è¾‘æ—¶é—´
     */
    private Date editTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    private Date updateTime;

    /**
     * åˆ›å»ºç”¨æˆ·ä¿¡æ¯
     */
    private UserVO user;

    private static final long serialVersionUID = 1L;

    /**
     * å°è£…ç±»è½¬å¯¹è±¡
     *
     * @param spaceVO
     * @return
     */
    public static Space voToObj(SpaceVO spaceVO) {
        if (spaceVO == null) {
            return null;
        }
        Space space = new Space();
        BeanUtils.copyProperties(spaceVO, space);
        return space;
    }

    /**
     * å¯¹è±¡è½¬å°è£…ç±»
     *
     * @param space
     * @return
     */
    public static SpaceVO objToVo(Space space) {
        if (space == null) {
            return null;
        }
        SpaceVO spaceVO = new SpaceVO();
        BeanUtils.copyProperties(space, spaceVO);
        return spaceVO;
    }
}
```

4ï¼‰åœ¨ `model.enums` åŒ…ä¸‹æ–°å»ºç©ºé—´çº§åˆ«æšä¸¾ï¼Œå®šä¹‰æ¯ä¸ªçº§åˆ«çš„ç©ºé—´å¯¹åº”çš„é™é¢ï¼š

```java
@Getter
public enum SpaceLevelEnum {

    COMMON("æ™®é€šç‰ˆ", 0, 100, 100L * 1024 * 1024),
    PROFESSIONAL("ä¸“ä¸šç‰ˆ", 1, 1000, 1000L * 1024 * 1024),
    FLAGSHIP("æ——èˆ°ç‰ˆ", 2, 10000, 10000L * 1024 * 1024);

    private final String text;

    private final int value;

    private final long maxCount;

    private final long maxSize;


    /**
     * @param text æ–‡æœ¬
     * @param value å€¼
     * @param maxSize æœ€å¤§å›¾ç‰‡æ€»å¤§å°
     * @param maxCount æœ€å¤§å›¾ç‰‡æ€»æ•°é‡
     */
    SpaceLevelEnum(String text, int value, long maxCount, long maxSize) {
        this.text = text;
        this.value = value;
        this.maxCount = maxCount;
        this.maxSize = maxSize;
    }

    /**
     * æ ¹æ® value è·å–æšä¸¾
     */
    public static SpaceLevelEnum getEnumByValue(Integer value) {
        if (ObjUtil.isEmpty(value)) {
            return null;
        }
        for (SpaceLevelEnum spaceLevelEnum : SpaceLevelEnum.values()) {
            if (spaceLevelEnum.value == value) {
                return spaceLevelEnum;
            }
        }
        return null;
    }
}
```

ğŸ’¡ è¿˜æœ‰å¦å¤–ä¸€ç§å®šä¹‰ç©ºé—´çº§åˆ«é™é¢çš„æ–¹å¼ï¼Œæ¯”å¦‚å°†ç©ºé—´é™é¢é…ç½®å­˜å‚¨åœ¨å¤–éƒ¨æ–‡ä»¶ï¼ˆå¦‚ JSON æ–‡ä»¶æˆ– properties æ–‡ä»¶ï¼‰ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ç±»æ¥æ¥æ”¶å‚æ•°ã€‚è¿™æ ·åæœŸå¦‚æœæœ‰å˜åŠ¨ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯ï¼Œè€Œä¸å¿…ä¿®æ”¹ä»£ç ã€‚

#### 2ã€åŸºç¡€æœåŠ¡å¼€å‘

1ï¼‰éœ€è¦å¼€å‘æ ¡éªŒç©ºé—´æ•°æ®çš„æ–¹æ³•ï¼Œå¢åŠ  add å‚æ•°ç”¨æ¥åŒºåˆ†æ˜¯åˆ›å»ºæ•°æ®æ—¶æ ¡éªŒè¿˜æ˜¯ç¼–è¾‘æ—¶æ ¡éªŒï¼Œåˆ¤æ–­æ¡ä»¶æ˜¯ä¸ä¸€æ ·çš„ï¼š

```java
@Override
public void validSpace(Space space, boolean add) {
    ThrowUtils.throwIf(space == null, ErrorCode.PARAMS_ERROR);
    // ä»å¯¹è±¡ä¸­å–å€¼
    String spaceName = space.getSpaceName();
    Integer spaceLevel = space.getSpaceLevel();
    SpaceLevelEnum spaceLevelEnum = SpaceLevelEnum.getEnumByValue(spaceLevel);
    // è¦åˆ›å»º
    if (add) {
        if (StrUtil.isBlank(spaceName)) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç©ºé—´åç§°ä¸èƒ½ä¸ºç©º");
        }
        if (spaceLevel == null) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç©ºé—´çº§åˆ«ä¸èƒ½ä¸ºç©º");
        }
    }
    // ä¿®æ”¹æ•°æ®æ—¶ï¼Œå¦‚æœè¦æ”¹ç©ºé—´çº§åˆ«
    if (spaceLevel != null && spaceLevelEnum == null) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç©ºé—´çº§åˆ«ä¸å­˜åœ¨");
    }
    if (StrUtil.isNotBlank(spaceName) && spaceName.length() > 30) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç©ºé—´åç§°è¿‡é•¿");
    }
}
```

2ï¼‰åœ¨åˆ›å»ºæˆ–æ›´æ–°ç©ºé—´æ—¶ï¼Œéœ€è¦æ ¹æ®ç©ºé—´çº§åˆ«è‡ªåŠ¨å¡«å……é™é¢æ•°æ®ï¼Œå¯ä»¥åœ¨æœåŠ¡ä¸­ç¼–å†™æ–¹æ³•ä¾¿äºå¤ç”¨ï¼š

```java
@Override
public void fillSpaceBySpaceLevel(Space space) {
    // æ ¹æ®ç©ºé—´çº§åˆ«ï¼Œè‡ªåŠ¨å¡«å……é™é¢
    SpaceLevelEnum spaceLevelEnum = SpaceLevelEnum.getEnumByValue(space.getSpaceLevel());
    if (spaceLevelEnum != null) {
        long maxSize = spaceLevelEnum.getMaxSize();
        if (space.getMaxSize() == null) {
            space.setMaxSize(maxSize);
        }
        long maxCount = spaceLevelEnum.getMaxCount();
        if (space.getMaxCount() == null) {
            space.setMaxCount(maxCount);
        }
    }
}
```

å¦‚æœç©ºé—´æœ¬èº«æ²¡æœ‰è®¾ç½®é™é¢ï¼Œæ‰ä¼šè‡ªåŠ¨å¡«å……ï¼Œä¿è¯äº†çµæ´»æ€§ã€‚

### 4ã€ç”¨æˆ·åˆ›å»ºç§æœ‰ç©ºé—´

æµç¨‹å¦‚ä¸‹ï¼š

1. å¡«å……å‚æ•°é»˜è®¤å€¼
2. æ ¡éªŒå‚æ•°
3. æ ¡éªŒæƒé™ï¼Œéç®¡ç†å‘˜åªèƒ½åˆ›å»ºæ™®é€šçº§åˆ«çš„ç©ºé—´
4. æ§åˆ¶åŒä¸€ç”¨æˆ·åªèƒ½åˆ›å»ºä¸€ä¸ªç§æœ‰ç©ºé—´

```java
/**
     * åˆ›å»ºç©ºé—´
     *
     * @param spaceAddRequest
     * @param loginUser
     * @return
     */
@Override
public long addSpace(SpaceAddRequest spaceAddRequest, User loginUser) {
    // 1. å¡«å……å‚æ•°é»˜è®¤å€¼
    // è½¬æ¢å®ä½“ç±»å’Œ DTO
    Space space = new Space();
    BeanUtils.copyProperties(spaceAddRequest, space);
    if (StrUtil.isBlank(space.getSpaceName())) {
        space.setSpaceName("é»˜è®¤ç©ºé—´");
    }
    if (space.getSpaceLevel() == null) {
        space.setSpaceLevel(SpaceLevelEnum.COMMON.getValue());
    }
    if (space.getSpaceType() == null) {
        space.setSpaceType(SpaceTypeEnum.PRIVATE.getValue());
    }
    // å¡«å……å®¹é‡å’Œå¤§å°
    this.fillSpaceBySpaceLevel(space);
    // 2. æ ¡éªŒå‚æ•°
    this.validSpace(space, true);
    // 3. æ ¡éªŒæƒé™ï¼Œéç®¡ç†å‘˜åªèƒ½åˆ›å»ºæ™®é€šçº§åˆ«çš„ç©ºé—´
    Long userId = loginUser.getId();
    space.setUserId(userId);
    if (SpaceLevelEnum.COMMON.getValue() != space.getSpaceLevel() && !userService.isAdmin(loginUser)) {
        throw new BusinessException(ErrorCode.NO_AUTH_ERROR, "æ— æƒé™åˆ›å»ºæŒ‡å®šçº§åˆ«çš„ç©ºé—´");
    }
    // 4. æ§åˆ¶åŒä¸€ç”¨æˆ·åªèƒ½åˆ›å»ºä¸€ä¸ªç§æœ‰ç©ºé—´ã€ä»¥åŠä¸€ä¸ªå›¢é˜Ÿç©ºé—´
    String lock = String.valueOf(userId).intern();
    synchronized (lock) {
        Long newSpaceId = transactionTemplate.execute(status -> {
            // åˆ¤æ–­æ˜¯å¦å·²æœ‰ç©ºé—´
            boolean exists = this.lambdaQuery()
                .eq(Space::getUserId, userId)
                .eq(Space::getSpaceType, space.getSpaceType())
                .exists();
            // å¦‚æœå·²æœ‰ç©ºé—´ï¼Œå°±ä¸èƒ½å†åˆ›å»º
            ThrowUtils.throwIf(exists, ErrorCode.OPERATION_ERROR, "æ¯ä¸ªç”¨æˆ·æ¯ç±»ç©ºé—´åªèƒ½åˆ›å»ºä¸€ä¸ª");
            // åˆ›å»º
            boolean result = this.save(space);
            ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR, "ä¿å­˜ç©ºé—´åˆ°æ•°æ®åº“å¤±è´¥");
            // åˆ›å»ºæˆåŠŸåï¼Œå¦‚æœæ˜¯å›¢é˜Ÿç©ºé—´ï¼Œå…³è”æ–°å¢å›¢é˜Ÿæˆå‘˜è®°å½•
            if (SpaceTypeEnum.TEAM.getValue() == space.getSpaceType()) {
                SpaceUser spaceUser = new SpaceUser();
                spaceUser.setSpaceId(space.getId());
                spaceUser.setUserId(userId);
                spaceUser.setSpaceRole(SpaceRoleEnum.ADMIN.getValue());
                result = spaceUserService.save(spaceUser);
                ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR, "åˆ›å»ºå›¢é˜Ÿæˆå‘˜è®°å½•å¤±è´¥");
            }
            //                // åˆ›å»ºåˆ†è¡¨ï¼ˆä»…å¯¹å›¢é˜Ÿç©ºé—´ç”Ÿæ•ˆï¼‰ä¸ºæ–¹ä¾¿éƒ¨ç½²ï¼Œæš‚æ—¶ä¸ä½¿ç”¨
            //                dynamicShardingManager.createSpacePictureTable(space);
            // è¿”å›æ–°å†™å…¥çš„æ•°æ® id
            return space.getId();
        });
        return Optional.ofNullable(newSpaceId).orElse(-1L);
    }
}
```

æ³¨æ„ï¼Œä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æœ¬åœ° synchronized é”å¯¹ userId è¿›è¡ŒåŠ é”ï¼Œè¿™æ ·ä¸åŒçš„ç”¨æˆ·å¯ä»¥æ‹¿åˆ°ä¸åŒçš„é”ï¼Œå¯¹æ€§èƒ½çš„å½±å“è¾ƒä½ã€‚åœ¨åŠ é”çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Spring çš„ **ç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†å™¨** transactionTemplate å°è£…è·Ÿæ•°æ®åº“æœ‰å…³çš„æŸ¥è¯¢å’Œæ’å…¥æ“ä½œï¼Œè€Œä¸æ˜¯ä½¿ç”¨ @Transactional æ³¨è§£æ¥æ§åˆ¶äº‹åŠ¡ï¼Œè¿™æ ·å¯ä»¥ä¿è¯äº‹åŠ¡çš„æäº¤åœ¨åŠ é”çš„èŒƒå›´å†…ã€‚

ğŸ’¡ åªè¦æ¶‰åŠåˆ°äº‹åŠ¡æ“ä½œï¼Œå…¶å®æµ‹è¯•æ—¶è‡ªå·± new ä¸ªè¿è¡Œæ—¶å¼‚å¸¸æ¥éªŒè¯æ˜¯å¦ä¼šå›æ»šå°±ä¼šçŸ¥é“ã€‚

#### æ‰©å±• - æœ¬åœ°é”ä¼˜åŒ–

ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬æ˜¯å¯¹å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆinternï¼‰è¿›è¡ŒåŠ é”çš„ï¼Œæ•°æ®å¹¶ä¸ä¼šåŠæ—¶é‡Šæ”¾ã€‚å¦‚æœè¿˜è¦ä½¿ç”¨æœ¬åœ°é”ï¼Œå¯ä»¥æŒ‰éœ€é€‰ç”¨å¦ä¸€ç§æ–¹å¼ â€”â€” é‡‡ç”¨ `ConcurrentHashMap` æ¥å­˜å‚¨é”å¯¹è±¡ã€‚

```java
Map<Long, Object> lockMap = new ConcurrentHashMap<>();

public long addSpace(SpaceAddRequest spaceAddRequest, User user) {
    Long userId = user.getId();
    Object lock = lockMap.computeIfAbsent(userId, key -> new Object());
    synchronized (lock) {
        try {
            // æ•°æ®åº“æ“ä½œ
        } finally {
            // é˜²æ­¢å†…å­˜æ³„æ¼
            lockMap.remove(userId);
        }
    }
}
```

