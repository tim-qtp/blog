---
order: 10
author: 
title: "å›¢é˜Ÿç©ºé—´"
category:
  - äº‘å›¾åº“
  - é¡¹ç›®
tag:
  - encryption
---

## 1ã€ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶

ç›´æ¥ç”¨[Sa-Token](https://sa-token.cc/doc.html#/start/example) å®ç°ä»¥ä¸‹æƒé™

| è§’è‰²   | å¯¹åº”æƒé™é”®                                                   | å¯æ‰§è¡ŒåŠŸèƒ½                                       |
| ------ | ------------------------------------------------------------ | ------------------------------------------------ |
| æµè§ˆè€… | picture:view                                                 | æŸ¥çœ‹å›¾ç‰‡                                         |
| ç¼–è¾‘è€… | picture:view, picture:upload, picture:edit, picture:delete   | æŸ¥çœ‹å›¾ç‰‡ã€ä¸Šä¼ å›¾ç‰‡ã€ä¿®æ”¹å›¾ç‰‡ã€åˆ é™¤å›¾ç‰‡           |
| ç®¡ç†å‘˜ | spaceUser:manage, picture:view, picture:upload, picture:edit, picture:delete | æˆå‘˜ç®¡ç†ã€æŸ¥çœ‹å›¾ç‰‡ã€ä¸Šä¼ å›¾ç‰‡ã€ä¿®æ”¹å›¾ç‰‡ã€åˆ é™¤å›¾ç‰‡ |

## 2ã€ç©ºé—´æ•°æ®ç®¡ç†

è€ƒè™‘åˆ°å›¢é˜Ÿç©ºé—´çš„å›¾ç‰‡æ•°é‡å¯èƒ½æ¯”è¾ƒå¤šï¼Œå¯ä»¥å¯¹ç‰¹å®šç©ºé—´çš„æ•°æ®è¿›è¡Œå•ç‹¬çš„ç®¡ç†ã€‚

å¦‚ä½•å¯¹æ•°æ®è¿›è¡Œå•ç‹¬çš„ç®¡ç†å‘¢ï¼Ÿ

### å›¾ç‰‡ä¿¡æ¯æ•°æ®

å¯ä»¥ç»™æ¯ä¸ªå›¢é˜Ÿç©ºé—´å•ç‹¬åˆ›å»ºä¸€å¼ å›¾ç‰‡è¡¨ `picture_{spaceId}`ï¼Œä¹Ÿå°±æ˜¯åˆ†åº“åˆ†è¡¨ä¸­çš„ `åˆ†è¡¨`ï¼Œè€Œä¸æ˜¯å’Œå…¬å…±å›¾åº“ã€ç§æœ‰ç©ºé—´çš„å›¾ç‰‡æ··åœ¨ä¸€èµ·ã€‚è¿™æ ·ä¸ä»…æŸ¥è¯¢ç©ºé—´å†…çš„å›¾ç‰‡æ•ˆç‡æ›´é«˜ï¼Œè¿˜ä¾¿äºæ•´ä½“ç®¡ç†å’Œæ¸…ç†ç©ºé—´ã€‚ä½†æ˜¯è¦æ³¨æ„ï¼Œ==**ä»…å¯¹æ——èˆ°ç‰ˆç©ºé—´ç”Ÿæ•ˆï¼Œå¦åˆ™åˆ†è¡¨çš„æ•°é‡ä¼šç‰¹åˆ«å¤šï¼Œåè€Œå¯èƒ½å½±å“æ€§èƒ½**==ã€‚

æ³¨æ„ï¼Œè¦å®ç°çš„ï¼Œè¿˜==ä¸æ˜¯æ™®é€šçš„é™æ€åˆ†è¡¨==ï¼Œè€Œæ˜¯ä¼šéšç€æ–°å¢ç©ºé—´ä¸æ–­å¢åŠ åˆ†è¡¨æ•°é‡çš„==åŠ¨æ€åˆ†è¡¨==ï¼Œä¼šä½¿ç”¨åˆ†åº“åˆ†è¡¨æ¡†æ¶ [Apache ShardingSphere](https://shardingsphere.apache.org/) ã€‚

### å›¾ç‰‡æ–‡ä»¶æ•°æ®

å·²ç»å°†æ¯ä¸ªç©ºé—´çš„å›¾ç‰‡å­˜åˆ°ä¸åŒçš„è·¯å¾„ä¸­äº†ï¼Œå®ç°äº†éš”ç¦»ï¼Œæ— éœ€é¢å¤–å¼€å‘ã€‚

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221417185.png)

ğŸ’¡ åœ¨è®¾è®¡ä¸Šå°±å°†å›¢é˜Ÿç©ºé—´å’Œç§æœ‰ç©ºé—´éš”ç¦»ï¼Œä»…å¯¹å›¢é˜Ÿç©ºé—´åº”ç”¨æˆå‘˜ç®¡ç†ã€æƒé™æ§åˆ¶ã€åŠ¨æ€åˆ†è¡¨ã€‚è¿™æ ·å¯ä»¥å°½é‡å‡å°‘å¯¹åŸæœ‰ä»£ç çš„æ”¹åŠ¨ï¼Œé¿å…å‡ºç°é—®é¢˜ã€‚

## 3ã€åç«¯å¼€å‘

### åˆ›å»ºå›¢é˜Ÿå…±äº«ç©ºé—´

#### 1ã€æ•°æ®æ¨¡å‹

Spaceã€SpaceVOã€SpaceAddRequestã€SpaceQueryRequest è¡¥å…… spaceType å­—æ®µï¼š

```java
/**
 * ç©ºé—´ç±»å‹ï¼š0-ç§æœ‰ 1-å›¢é˜Ÿ
 */
private Integer spaceType;
```

å®šä¹‰ç©ºé—´ç±»å‹æšä¸¾ï¼š

```java
@Getter
public enum SpaceTypeEnum {

    PRIVATE("ç§æœ‰ç©ºé—´", 0),
    TEAM("å›¢é˜Ÿç©ºé—´", 1);

    private final String text;

    private final int value;

    SpaceTypeEnum(String text, int value) {
        this.text = text;
        this.value = value;
    }

    /**
     * æ ¹æ® value è·å–æšä¸¾
     */
    public static SpaceTypeEnum getEnumByValue(Integer value) {
        if (ObjUtil.isEmpty(value)) {
            return null;
        }
        for (SpaceTypeEnum spaceTypeEnum : SpaceTypeEnum.values()) {
            if (spaceTypeEnum.value == value) {
                return spaceTypeEnum;
            }
        }
        return null;
    }
}
```

#### 2ã€æ–°å»ºå›¢é˜Ÿç©ºé—´

å¯ä»¥ç›´æ¥å¤ç”¨åˆ›å»ºç©ºé—´çš„æ–¹æ³•ï¼Œåªéœ€è¦åšä¸€äº›æ”¹åŠ¨å³å¯ã€‚

1ï¼‰åˆ›å»ºç©ºé—´æ—¶ä¸ºç©ºé—´ç±»å‹æŒ‡å®šé»˜è®¤å€¼ï¼š

```java
// é»˜è®¤å€¼
if (StrUtil.isBlank(spaceAddRequest.getSpaceName())) {
    spaceAddRequest.setSpaceName("é»˜è®¤ç©ºé—´");
}
if (spaceAddRequest.getSpaceLevel() == null) {
    spaceAddRequest.setSpaceLevel(SpaceLevelEnum.COMMON.getValue());
}
if (spaceAddRequest.getSpaceType() == null) {
    spaceAddRequest.setSpaceType(SpaceTypeEnum.PRIVATE.getValue());
}
// åœ¨æ­¤å¤„å°†å®ä½“ç±»å’Œ DTO è¿›è¡Œè½¬æ¢
Space space = new Space();
BeanUtils.copyProperties(spaceAddRequest, space);
// å¡«å……æ•°æ®
this.fillSpaceBySpaceLevel(space);
```

2ï¼‰validSpace æ–¹æ³•è¡¥å……å¯¹ç©ºé—´ç±»å‹çš„æ ¡éªŒï¼š

```java
public void validSpace(Space space, boolean add) {
    Integer spaceType = space.getSpaceType();
    SpaceTypeEnum spaceTypeEnum = SpaceTypeEnum.getEnumByValue(spaceType);
    // è¦åˆ›å»º
    if (add) {
        if (spaceType == null) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç©ºé—´ç±»å‹ä¸èƒ½ä¸ºç©º");
        }
    }
    // ä¿®æ”¹æ•°æ®æ—¶ï¼Œå¦‚æœè¦æ”¹ç©ºé—´çº§åˆ«
    if (spaceType != null && spaceTypeEnum == null) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç©ºé—´ç±»å‹ä¸å­˜åœ¨");
    }
}
```

3ï¼‰é™åˆ¶æ¯ä¸ªæ™®é€šç”¨æˆ·ä»…èƒ½åˆ›å»ºä¸€ä¸ªå›¢é˜Ÿç©ºé—´ï¼ˆç®¡ç†å‘˜å¯ä»¥åˆ›å»ºå¤šä¸ªï¼‰ï¼Œç”±äºæ™®é€šç”¨æˆ·ä¹Ÿä»…èƒ½åˆ›å»ºä¸€ä¸ªç§æœ‰ç©ºé—´ï¼Œç›¸å½“äº **æ™®é€šç”¨æˆ·æ¯ç±»ç©ºé—´åªèƒ½åˆ›å»º 1 ä¸ªã€‚**å› æ­¤ï¼Œåªè¦åœ¨åˆ¤æ–­æ˜¯å¦å·²åˆ›å»ºç©ºé—´æ—¶ï¼Œè¡¥å…… spaceType ä½œä¸ºæŸ¥è¯¢æ¡ä»¶å³å¯ï¼š

```java
Long newSpaceId = transactionTemplate.execute(status -> {
    if (!userService.isAdmin(loginUser)) {
        boolean exists = this.lambdaQuery()
                .eq(Space::getUserId, userId)
                .eq(Space::getSpaceType, spaceAddRequest.getSpaceType())
                .exists();
        ThrowUtils.throwIf(exists, ErrorCode.OPERATION_ERROR, "æ¯ä¸ªç”¨æˆ·æ¯ç±»ç©ºé—´ä»…èƒ½åˆ›å»ºä¸€ä¸ª");
    }
    // å†™å…¥æ•°æ®åº“
    boolean result = this.save(space);
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);
    // è¿”å›æ–°å†™å…¥çš„æ•°æ® id
    return space.getId();
});
```

å½“ç„¶ï¼Œè¿™é‡Œçš„é€»è¾‘è¿˜å¯ä»¥è‡ªç”±è°ƒæ•´ï¼Œæ¯”å¦‚ä¸å…è®¸ç”¨æˆ·åˆ›å»ºå›¢é˜Ÿç©ºé—´ï¼Œéœ€è¦è”ç³»ç®¡ç†å‘˜æˆ–ä»˜è´¹å¼€é€šã€‚

#### 3ã€æŸ¥è¯¢å›¢é˜Ÿç©ºé—´

ç»™ SpaceService çš„ getQueryWrapper æ–¹æ³•è¡¥å…… spaceType çš„æŸ¥è¯¢æ¡ä»¶ï¼š

```java
Integer spaceType = spaceQueryRequest.getSpaceType();
queryWrapper.eq(ObjUtil.isNotEmpty(spaceType), "spaceType", spaceType);
```

ä¹‹åå‰ç«¯å°±èƒ½å¤ŸæŒ‰ç…§ç©ºé—´ç±»åˆ«è·å–ç©ºé—´åˆ—è¡¨äº†ã€‚

### ç©ºé—´æˆå‘˜ç®¡ç†

ç©ºé—´æˆå‘˜ç®¡ç†çš„å¼€å‘æ¯”è¾ƒç®€å•ï¼Œå…¶å®å°±æ˜¯ â€œå¢åˆ æ”¹æŸ¥â€ã€‚

éœ€è¦å¼€å‘çš„æ¥å£åŒ…æ‹¬ï¼š

- æ·»åŠ æˆå‘˜åˆ°ç©ºé—´ï¼šä»…æ‹¥æœ‰æˆå‘˜ç®¡ç†æƒé™çš„ç”¨æˆ·å¯ä½¿ç”¨ã€‚
- ä»ç©ºé—´ç§»é™¤æˆå‘˜ï¼šä»…æ‹¥æœ‰æˆå‘˜ç®¡ç†æƒé™çš„ç”¨æˆ·å¯ä½¿ç”¨ã€‚
- æŸ¥è¯¢æŸä¸ªæˆå‘˜åœ¨ç©ºé—´çš„ä¿¡æ¯ï¼šä»…æ‹¥æœ‰æˆå‘˜ç®¡ç†æƒé™çš„ç”¨æˆ·å¯ä½¿ç”¨ã€‚
- æŸ¥è¯¢ç©ºé—´æˆå‘˜åˆ—è¡¨ï¼šä»…æ‹¥æœ‰æˆå‘˜ç®¡ç†æƒé™çš„ç”¨æˆ·å¯ä½¿ç”¨ã€‚
- ç¼–è¾‘æˆå‘˜ä¿¡æ¯ï¼šä»…æ‹¥æœ‰æˆå‘˜ç®¡ç†æƒé™çš„ç”¨æˆ·å¯ä½¿ç”¨ã€‚
- æŸ¥è¯¢æˆ‘åŠ å…¥çš„å›¢é˜Ÿç©ºé—´åˆ—è¡¨ï¼šæ‰€æœ‰å·²ç™»å½•ç”¨æˆ·å¯ä½¿ç”¨ã€‚

### ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶

#### 1ã€æƒé™å®šä¹‰

æ ¹æ® RBAC æƒé™æ¨¡å‹ï¼Œéœ€è¦å®šä¹‰è§’è‰²å’Œæƒé™ã€‚

1ï¼‰æˆ‘è¿™é‡Œä¸ºäº†ç®€å•ç‚¹ï¼Œç”¨ JSON é…ç½®æ–‡ä»¶æ¥å®šä¹‰è§’è‰²ã€æƒé™ã€è§’è‰²å’Œæƒé™ä¹‹é—´çš„å…³ç³»ï¼Œç›¸æ¯”ä»æ•°æ®åº“è¡¨ä¸­è·å–ï¼Œå®ç°æ›´æ–¹ä¾¿ï¼ŒæŸ¥è¯¢ä¹Ÿæ›´é«˜æ•ˆã€‚

åœ¨ `resources/biz` ç›®å½•ä¸‹æ–°å»º JSON é…ç½®æ–‡ä»¶ `spaceUserAuthConfig.json`ï¼š

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221438160.png)

```json
{
  "permissions": [
    {
      "key": "spaceUser:manage",
      "name": "æˆå‘˜ç®¡ç†",
      "description": "ç®¡ç†ç©ºé—´æˆå‘˜ï¼Œæ·»åŠ æˆ–ç§»é™¤æˆå‘˜"
    },
    {
      "key": "picture:view",
      "name": "æŸ¥çœ‹å›¾ç‰‡",
      "description": "æŸ¥çœ‹ç©ºé—´ä¸­çš„å›¾ç‰‡å†…å®¹"
    },
    {
      "key": "picture:upload",
      "name": "ä¸Šä¼ å›¾ç‰‡",
      "description": "ä¸Šä¼ å›¾ç‰‡åˆ°ç©ºé—´ä¸­"
    },
    {
      "key": "picture:edit",
      "name": "ä¿®æ”¹å›¾ç‰‡",
      "description": "ç¼–è¾‘å·²ä¸Šä¼ çš„å›¾ç‰‡ä¿¡æ¯"
    },
    {
      "key": "picture:delete",
      "name": "åˆ é™¤å›¾ç‰‡",
      "description": "åˆ é™¤ç©ºé—´ä¸­çš„å›¾ç‰‡"
    }
  ],
  "roles": [
    {
      "key": "viewer",
      "name": "æµè§ˆè€…",
      "permissions": [
        "picture:view"
      ],
      "description": "æŸ¥çœ‹å›¾ç‰‡"
    },
    {
      "key": "editor",
      "name": "ç¼–è¾‘è€…",
      "permissions": [
        "picture:view",
        "picture:upload",
        "picture:edit",
        "picture:delete"
      ],
      "description": "æŸ¥çœ‹å›¾ç‰‡ã€ä¸Šä¼ å›¾ç‰‡ã€ä¿®æ”¹å›¾ç‰‡ã€åˆ é™¤å›¾ç‰‡"
    },
    {
      "key": "admin",
      "name": "ç®¡ç†å‘˜",
      "permissions": [
        "spaceUser:manage",
        "picture:view",
        "picture:upload",
        "picture:edit",
        "picture:delete"
      ],
      "description": "æˆå‘˜ç®¡ç†ã€æŸ¥çœ‹å›¾ç‰‡ã€ä¸Šä¼ å›¾ç‰‡ã€ä¿®æ”¹å›¾ç‰‡ã€åˆ é™¤å›¾ç‰‡"
    }
  ]
}
```

2ï¼‰åœ¨ `auth.model` åŒ…ä¸‹æ–°å»ºæ•°æ®æ¨¡å‹ï¼Œç”¨äºæ¥æ”¶é…ç½®æ–‡ä»¶çš„å€¼ã€‚

æƒé™é…ç½®ç±»ï¼š

```java
@Data
public class SpaceUserAuthConfig implements Serializable {

    /**
     * æƒé™åˆ—è¡¨
     */
    private List<SpaceUserPermission> permissions;

    /**
     * è§’è‰²åˆ—è¡¨
     */
    private List<SpaceUserRole> roles;

    private static final long serialVersionUID = 1L;
}
```

ç©ºé—´æˆå‘˜æƒé™ï¼š

```java
@Data
public class SpaceUserPermission implements Serializable {

    /**
     * æƒé™é”®
     */
    private String key;

    /**
     * æƒé™åç§°
     */
    private String name;

    /**
     * æƒé™æè¿°
     */
    private String description;

    private static final long serialVersionUID = 1L;

}
```

ç©ºé—´æˆå‘˜è§’è‰²ï¼šLeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=

```java
@Data
public class SpaceUserRole implements Serializable {

    /**
     * è§’è‰²é”®
     */
    private String key;

    /**
     * è§’è‰²åç§°
     */
    private String name;

    /**
     * æƒé™é”®åˆ—è¡¨
     */
    private List<String> permissions;

    /**
     * è§’è‰²æè¿°
     */
    private String description;

    private static final long serialVersionUID = 1L;
}
```

3ï¼‰å®šä¹‰ç©ºé—´æˆå‘˜æƒé™å¸¸é‡ç±»ï¼Œ==ä¾¿äºåç»­æ ¡éªŒæƒé™æ—¶ä½¿ç”¨==ï¼š

```java
public interface SpaceUserPermissionConstant {
    /**
     * ç©ºé—´ç”¨æˆ·ç®¡ç†æƒé™
     */
    String SPACE_USER_MANAGE = "spaceUser:manage";

    /**
     * å›¾ç‰‡æŸ¥çœ‹æƒé™
     */
    String PICTURE_VIEW = "picture:view";

    /**
     * å›¾ç‰‡ä¸Šä¼ æƒé™
     */
    String PICTURE_UPLOAD = "picture:upload";

    /**
     * å›¾ç‰‡ç¼–è¾‘æƒé™
     */
    String PICTURE_EDIT = "picture:edit";

    /**
     * å›¾ç‰‡åˆ é™¤æƒé™
     */
    String PICTURE_DELETE = "picture:delete";
}
```

4ï¼‰åœ¨ `auth` åŒ…ä¸‹æ–°å»º SpaceUserAuthManagerï¼Œå¯åŠ è½½é…ç½®æ–‡ä»¶åˆ°å¯¹è±¡ï¼Œå¹¶æä¾›æ ¹æ®è§’è‰²è·å–æƒé™åˆ—è¡¨çš„æ–¹æ³•ã€‚

```java
@Component
public class SpaceUserAuthManager {

    @Resource
    private SpaceUserService spaceUserService;

    @Resource
    private UserService userService;

    public static final SpaceUserAuthConfig SPACE_USER_AUTH_CONFIG;

    static {
        String json = ResourceUtil.readUtf8Str("biz/spaceUserAuthConfig.json");
        SPACE_USER_AUTH_CONFIG = JSONUtil.toBean(json, SpaceUserAuthConfig.class);
    }

    /**
     * æ ¹æ®è§’è‰²è·å–æƒé™åˆ—è¡¨
     */
    public List<String> getPermissionsByRole(String spaceUserRole) {
        if (StrUtil.isBlank(spaceUserRole)) {
            return new ArrayList<>();
        }
        // æ‰¾åˆ°åŒ¹é…çš„è§’è‰²
        SpaceUserRole role = SPACE_USER_AUTH_CONFIG.getRoles().stream()
                .filter(r -> spaceUserRole.equals(r.getKey()))
                .findFirst()
                .orElse(null);
        if (role == null) {
            return new ArrayList<>();
        }
        return role.getPermissions();
    }
}
```

#### 2ã€Sa-Token 

Sa-Token æ˜¯ä¸€ä¸ªè½»é‡çº§ Java æƒé™è®¤è¯æ¡†æ¶ï¼Œç›¸æ¯” Spring Security ç­‰æ›´åŠ ç®€å•æ˜“å­¦ï¼Œç”¨ä½œè€…çš„è¯è¯´ï¼Œä½¿ç”¨è¯¥æ¡†æ¶å¯ä»¥è®©é‰´æƒå˜å¾—ç®€å•ã€ä¼˜é›…~

å­¦ä¹ å¹¶ä¸éš¾ï¼Œå‚è€ƒ [å®˜æ–¹æ–‡æ¡£](https://sa-token.cc/doc.html#/start/example) å°±å¥½

1ï¼‰å¼•å…¥ Sa-Tokenï¼š

```xml
<!-- Sa-Token æƒé™è®¤è¯ -->
<dependency>
    <groupId>cn.dev33</groupId>
    <artifactId>sa-token-spring-boot-starter</artifactId>
    <version>1.39.0</version>
</dependency>
```

Sa-Token é»˜è®¤å°†æ•°æ®ï¼ˆæ¯”å¦‚ç”¨æˆ·ç™»å½•æ€ï¼‰ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œæ­¤æ¨¡å¼è¯»å†™é€Ÿåº¦æœ€å¿«ï¼Œä¸”é¿å…äº†åºåˆ—åŒ–ä¸ååºåˆ—åŒ–å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ï¼Œä½†ç¼ºç‚¹æ˜¯é‡å¯åæ•°æ®ä¼šä¸¢å¤±ã€æ— æ³•åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­å…±äº«æ•°æ®ã€‚

æˆ‘ä»¬é¡¹ç›®ä¸­æ—¢ç„¶å·²ç»ä½¿ç”¨äº† Redisï¼Œé‚£ä¹ˆå¯ä»¥ [å‚è€ƒå®˜æ–¹æ–‡æ¡£](https://sa-token.cc/doc.html#/up/integ-redis) è®© Sa-Token æ•´åˆ Redisï¼Œå°†ç”¨æˆ·çš„ç™»å½•æ€ç­‰å†…å®¹ä¿å­˜åœ¨ Redis ä¸­ã€‚

æ­¤å¤„é€‰æ‹© jackson åºåˆ—åŒ–æ–¹å¼æ•´åˆ Redisï¼Œè¿™æ ·å­˜åˆ° Redis çš„æ•°æ®æ˜¯å¯è¯»çš„ï¼š

```xml
<!-- Sa-Token æ•´åˆ Redis ï¼ˆä½¿ç”¨ jackson åºåˆ—åŒ–æ–¹å¼ï¼‰ -->
<dependency>
    <groupId>cn.dev33</groupId>
    <artifactId>sa-token-redis-jackson</artifactId>
    <version>1.39.0</version>
</dependency>
<!-- æä¾›Redisè¿æ¥æ±  -->
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-pool2</artifactId>
</dependency>
```

2ï¼‰äº†è§£ Sa-Token çš„åŸºæœ¬ç”¨æ³•

Sa-Token çš„ä½¿ç”¨æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆæ˜¯ç”¨æˆ·ç™»å½•æ—¶è°ƒç”¨ login æ–¹æ³•ï¼Œäº§ç”Ÿä¸€ä¸ªæ–°çš„ä¼šè¯ï¼š

```java
StpUtil.login(10001);
```

åªæ­¤ä¸€å¥ä»£ç ï¼Œä¾¿å¯ä»¥ä½¿ä¼šè¯ç™»å½•æˆåŠŸï¼Œå®é™…ä¸Šï¼ŒSa-Token åœ¨èƒŒååšäº†å¤§é‡çš„å·¥ä½œï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š

1. æ£€æŸ¥æ­¤è´¦å·æ˜¯å¦ä¹‹å‰å·²æœ‰ç™»å½•ï¼›
2. ä¸ºè´¦å·ç”Ÿæˆ `Token` å‡­è¯ä¸ `Session` ä¼šè¯ï¼›
3. è®°å½• Token æ´»è·ƒæ—¶é—´ï¼›
4. é€šçŸ¥å…¨å±€ä¾¦å¬å™¨ï¼Œxx è´¦å·ç™»å½•æˆåŠŸï¼›
5. å°† `Token` æ³¨å…¥åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡ï¼›
6. ç­‰ç­‰å…¶å®ƒå·¥ä½œâ€¦â€¦

ä½ æš‚æ—¶ä¸éœ€è¦å®Œæ•´äº†è§£æ•´ä¸ªç™»å½•è¿‡ç¨‹ï¼Œä½ åªéœ€è¦è®°ä½å…³é”®ä¸€ç‚¹ï¼š`Sa-Token ä¸ºè¿™ä¸ªè´¦å·åˆ›å»ºäº†ä¸€ä¸ªTokenå‡­è¯ï¼Œä¸”é€šè¿‡ Cookie ä¸Šä¸‹æ–‡è¿”å›ç»™äº†å‰ç«¯`ã€‚

è¿˜å¯ä»¥ç»™ä¼šè¯ä¿å­˜ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯ï¼š

```java
StpUtil.getSession().set("user", user)
```

æ¥ä¸‹æ¥ä½ å°±å¯ä»¥åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•ã€è·å–ç”¨æˆ·ä¿¡æ¯äº†ï¼Œå¯ä»¥é€šè¿‡ä»£ç è¿›è¡Œåˆ¤æ–­ï¼š

```java
// æ£€éªŒå½“å‰ä¼šè¯æ˜¯å¦å·²ç»ç™»å½•, å¦‚æœæœªç™»å½•ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼š`NotLoginException`
StpUtil.checkLogin();
// è·å–ç”¨æˆ·ä¿¡æ¯
StpUtil.getSession().get("user");
```

ä¹Ÿå¯ä»¥å‚è€ƒ [å®˜æ–¹æ–‡æ¡£](https://sa-token.cc/doc.html#/use/at-check)ï¼Œä½¿ç”¨æ³¨è§£è¿›è¡Œé‰´æƒï¼š

```java
// ç™»å½•æ ¡éªŒï¼šåªæœ‰ç™»å½•ä¹‹åæ‰èƒ½è¿›å…¥è¯¥æ–¹æ³• 
@SaCheckLogin                        
@RequestMapping("info")
public String info() {
    return "æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯";
}
```

è¿™æ˜¯ Sa-Token æœ€åŸºæœ¬çš„ç”¨æ³•ï¼Œä¸‹é¢æˆ‘ä»¬æ­£å¼åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ Sa-Tokenã€‚

#### 3ã€æ–°å»ºç©ºé—´è´¦å·ä½“ç³»

ç›®å‰ï¼Œé¡¹ç›®ä¸­å…¶å®å­˜åœ¨ä¸¤å¥—æƒé™æ ¡éªŒä½“ç³»ã€‚ä¸€å¥—æ˜¯æœ€å¼€å§‹å°±æœ‰çš„ï¼Œå¯¹ user è¡¨çš„è§’è‰²è¿›è¡Œæ ¡éªŒï¼Œåˆ†ä¸ºæ™®é€šç”¨æˆ·å’Œç®¡ç†å‘˜ï¼›å¦ä¸€å¥—æ˜¯ç°åœ¨å‡†å¤‡ç”¨çš„ï¼Œå¯¹å›¢é˜Ÿç©ºé—´çš„æƒé™è¿›è¡Œæ ¡éªŒã€‚

ä¸ºäº†æ›´è½»æ¾åœ°æ‰©å±•é¡¹ç›®ï¼Œå‡å°‘å¯¹åŸæœ‰ä»£ç çš„æ”¹åŠ¨ï¼Œæˆ‘ä»¬åŸæœ‰çš„ user è¡¨æƒé™æ ¡éªŒä¾ç„¶ä½¿ç”¨è‡ªå®šä¹‰æ³¨è§£ + AOP çš„æ–¹å¼å®ç°ã€‚è€Œå›¢é˜Ÿç©ºé—´æƒé™æ ¡éªŒï¼Œé‡‡ç”¨ Sa-Token æ¥ç®¡ç†ã€‚

ç›¸å½“äºæˆ‘ä»¬ä¸æ˜¯æ•´ä¸ªé¡¹ç›®éƒ½äº¤ç»™ Sa-Tokenï¼Œåªæ˜¯æŠŠ Sa-Token å½“åšå®ç°å›¢é˜Ÿç©ºé—´æƒé™ç®¡ç†çš„å·¥å…·ç½¢äº†ã€‚

è¿™ç§åŒä¸€é¡¹ç›®æœ‰å¤šè´¦å·ä½“ç³»çš„æƒ…å†µä¸‹ï¼Œä¸å»ºè®®ä½¿ç”¨ Sa-Token é»˜è®¤çš„è´¦å·ä½“ç³»ï¼Œè€Œæ˜¯ä½¿ç”¨ Sa-Token æä¾›çš„ [å¤šè´¦å·è®¤è¯ç‰¹æ€§](https://sa-token.cc/doc.html#/up/many-account?id=_5ã€kitæ¨¡å¼)ï¼Œå¯ä»¥å°†å¤šå¥—è´¦å·çš„æˆæƒç»™åŒºåˆ†å¼€ï¼Œè®©å®ƒä»¬äº’ä¸å¹²æ‰°ã€‚

> å®˜æ–¹æ–‡æ¡£ä¸­ï¼š
>
> **æ¼”è¿›æ€è·¯**
>
> å‡å¦‚è¯´æˆ‘ä»¬çš„ userè¡¨ å’Œ adminè¡¨ éƒ½æœ‰ä¸€ä¸ª id=10001 çš„è´¦å·ï¼Œå®ƒä»¬å¯¹åº”çš„ç™»å½•ä»£ç ï¼š`StpUtil.login(10001)` æ˜¯ä¸€æ ·çš„ï¼Œ é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šåœ¨`StpUtil.getLoginId()`è·å–åˆ°çš„è´¦å·idå¦‚ä½•åŒºåˆ†å®ƒæ˜¯Userç”¨æˆ·ï¼Œè¿˜æ˜¯Adminç”¨æˆ·ï¼Ÿ
>
> ä½ å¯èƒ½ä¼šæƒ³åˆ°ä¸ºä»–ä»¬åŠ ä¸€ä¸ªå›ºå®šå‰ç¼€ï¼Œæ¯”å¦‚`StpUtil.login("User_" + 10001)`ã€`StpUtil.login("Admin_" + 10001)`ï¼Œè¿™æ ·ç¡®å®æ˜¯å¯ä»¥è§£å†³é—®é¢˜çš„ï¼Œ ä½†æ˜¯åŒæ ·çš„ï¼šä½ éœ€è¦åœ¨`StpUtil.getLoginId()`æ—¶å†è£å‰ªæ‰ç›¸åº”çš„å‰ç¼€æ‰èƒ½è·å–çœŸæ­£çš„è´¦å·idï¼Œè¿™æ ·ä¸€å¢ä¸€å‡å°±è®©æˆ‘ä»¬çš„ä»£ç å˜å¾—æ— æ¯”å•°å—¦ã€‚
>
> é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰ä»æ¡†æ¶å±‚é¢æ”¯æŒçš„ï¼Œæ›´ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆå‘¢ï¼Ÿ

1ï¼‰å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œä½¿ç”¨ [Kit æ¨¡å¼](https://sa-token.cc/doc.html#/up/many-account?id=_5ã€kitæ¨¡å¼) å®ç°å¤šè´¦å·è®¤è¯ï¼Œåœ¨ `auth` åŒ…ä¸‹æ–°å»º `StpKit.java`ï¼Œå®šä¹‰ç©ºé—´è´¦å·ä½“ç³»ï¼š

```java
/**
 * StpLogic é—¨é¢ç±»ï¼Œç®¡ç†é¡¹ç›®ä¸­æ‰€æœ‰çš„ StpLogic è´¦å·ä½“ç³»
 * æ·»åŠ  @Component æ³¨è§£çš„ç›®çš„æ˜¯ç¡®ä¿é™æ€å±æ€§ DEFAULT å’Œ SPACE è¢«åˆå§‹åŒ–
 */
@Component
public class StpKit {

    public static final String SPACE_TYPE = "space";

    /**
     * é»˜è®¤åŸç”Ÿä¼šè¯å¯¹è±¡ï¼Œé¡¹ç›®ä¸­ç›®å‰æ²¡ä½¿ç”¨åˆ°
     */
    public static final StpLogic DEFAULT = StpUtil.stpLogic;

    /**
     * Space ä¼šè¯å¯¹è±¡ï¼Œç®¡ç† Space è¡¨æ‰€æœ‰è´¦å·çš„ç™»å½•ã€æƒé™è®¤è¯
     */
    public static final StpLogic SPACE = new StpLogic(SPACE_TYPE);
}
```

ä¹‹åå°±å¯ä»¥åœ¨ä»£ç ä¸­ä½¿ç”¨è´¦å·ä½“ç³»ï¼Œä»¥ä¸‹æ˜¯ç¤ºä¾‹ä»£ç ï¼š

```java
// åœ¨å½“å‰ä¼šè¯è¿›è¡Œ Space è´¦å·ç™»å½•
StpKit.SPACE.login(10001);

// æ£€æµ‹å½“å‰ä¼šè¯æ˜¯å¦ä»¥ Space è´¦å·ç™»å½•ï¼Œå¹¶å…·æœ‰ picture:edit æƒé™
StpKit.SPACE.checkPermission("picture:edit");

// è·å–å½“å‰ Space ä¼šè¯çš„ Session å¯¹è±¡ï¼Œå¹¶è¿›è¡Œå†™å€¼æ“ä½œ 
StpKit.SPACE.getSession().set("user", "ç¨‹åºå‘˜ç§¦ä¸€");
```

2ï¼‰ä¿®æ”¹ç”¨æˆ·æœåŠ¡çš„ userLogin æ–¹æ³•ï¼Œç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œä¿å­˜ç™»å½•æ€åˆ° Sa-Token çš„ç©ºé—´è´¦å·ä½“ç³»ä¸­ï¼š

```java
// 3. è®°å½•ç”¨æˆ·çš„ç™»å½•æ€
request.getSession().setAttribute(USER_LOGIN_STATE, user);
// 4. è®°å½•ç”¨æˆ·ç™»å½•æ€åˆ° Sa-tokenï¼Œä¾¿äºç©ºé—´é‰´æƒæ—¶ä½¿ç”¨ï¼Œæ³¨æ„ä¿è¯è¯¥ç”¨æˆ·ä¿¡æ¯ä¸ SpringSession ä¸­çš„ä¿¡æ¯è¿‡æœŸæ—¶é—´ä¸€è‡´
StpKit.SPACE.login(user.getId());
StpKit.SPACE.getSession().set(USER_LOGIN_STATE, user);
return this.getLoginUserVO(user);
```

#### 4ã€æƒé™è®¤è¯é€»è¾‘

Sa-Token å¼€å‘çš„æ ¸å¿ƒæ˜¯ç¼–å†™æƒé™è®¤è¯ç±»ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¯¥ç±»ä¸­å®ç° â€œå¦‚ä½•æ ¹æ®ç™»å½•ç”¨æˆ· id è·å–åˆ°ç”¨æˆ·å·²æœ‰çš„è§’è‰²å’Œæƒé™åˆ—è¡¨â€ æ–¹æ³•ã€‚å½“è¦åˆ¤æ–­æŸç”¨æˆ·æ˜¯å¦æœ‰æŸä¸ªè§’è‰²æˆ–æƒé™æ—¶ï¼ŒSa-Token ä¼šå…ˆæ‰§è¡Œæˆ‘ä»¬ç¼–å†™çš„æ–¹æ³•ï¼Œå¾—åˆ°è¯¥ç”¨æˆ·çš„è§’è‰²æˆ–æƒé™åˆ—è¡¨ï¼Œç„¶åè·Ÿéœ€è¦çš„è§’è‰²æƒé™è¿›è¡Œæ¯”å¯¹ã€‚

å‚è€ƒ [å®˜æ–¹æ–‡æ¡£](https://sa-token.cc/doc.html#/use/jur-auth)ï¼Œç¤ºä¾‹æƒé™è®¤è¯ç±»å¦‚ä¸‹ï¼š

```java
/**
 * è‡ªå®šä¹‰æƒé™åŠ è½½æ¥å£å®ç°ç±»
 */
@Component    // ä¿è¯æ­¤ç±»è¢« SpringBoot æ‰«æï¼Œå®Œæˆ Sa-Token çš„è‡ªå®šä¹‰æƒé™éªŒè¯æ‰©å±• 
public class StpInterfaceImpl implements StpInterface {

    /**
     * è¿”å›ä¸€ä¸ªè´¦å·æ‰€æ‹¥æœ‰çš„æƒé™ç é›†åˆ 
     */
    @Override
    public List<String> getPermissionList(Object loginId, String loginType) {
        // æœ¬ list ä»…åšæ¨¡æ‹Ÿï¼Œå®é™…é¡¹ç›®ä¸­è¦æ ¹æ®å…·ä½“ä¸šåŠ¡é€»è¾‘æ¥æŸ¥è¯¢æƒé™
        List<String> list = new ArrayList<String>();    
        list.add("user.add");
        list.add("user.update");
        list.add("user.get");
        list.add("art.*");
        return list;
    }

    /**
     * è¿”å›ä¸€ä¸ªè´¦å·æ‰€æ‹¥æœ‰çš„è§’è‰²æ ‡è¯†é›†åˆ (æƒé™ä¸è§’è‰²å¯åˆ†å¼€æ ¡éªŒ)
     */
    @Override
    public List<String> getRoleList(Object loginId, String loginType) {
        // æœ¬ list ä»…åšæ¨¡æ‹Ÿï¼Œå®é™…é¡¹ç›®ä¸­è¦æ ¹æ®å…·ä½“ä¸šåŠ¡é€»è¾‘æ¥æŸ¥è¯¢è§’è‰²
        List<String> list = new ArrayList<String>();    
        list.add("admin");
        list.add("super-admin");
        return list;
    }
}
```

Sa-Token æ”¯æŒæŒ‰ç…§è§’è‰²å’Œæƒé™æ ¡éªŒï¼Œå¯¹äºæƒé™ä¸å¤šçš„é¡¹ç›®ï¼ŒåŸºäºè§’è‰²æ ¡éªŒå³å¯ï¼›å¯¹äºæƒé™è¾ƒå¤šçš„é¡¹ç›®ï¼Œå»ºè®®æ ¹æ®æƒé™æ ¡éªŒã€‚å¯¹äºæœ¬é¡¹ç›®ï¼Œè™½ç„¶æƒé™å¹¶ä¸å¤šï¼Œä½†æ˜¯è€ƒè™‘åˆ°æ‰©å±•æ€§ï¼Œè¿˜æ˜¯ **é€‰æ‹©æ›´ç»†ç²’åº¦çš„æƒé™æ ¡éªŒ**ï¼Œä¸šåŠ¡å«ä¹‰ä¼šæ›´æ˜ç¡®ã€‚

è§‚å¯Ÿä¸Šè¿°ä»£ç æˆ‘ä»¬ä¼šå‘ç°ï¼Œ`getPermissionList` æ–¹æ³•åªæä¾›äº† loginIdï¼ˆç™»å½•ç”¨æˆ· idï¼‰å’Œ loginTypeï¼ˆè´¦å·ä½“ç³»ï¼‰ä¸¤ä¸ªå‚æ•°ã€‚è¿™ä¼šç»™æˆ‘ä»¬é€ æˆå¾ˆå¤§çš„éš¾åº¦ï¼š

- å…‰æœ‰ç”¨æˆ· id æ˜¯æ²¡åŠæ³•è¿›è¡Œæƒé™æ ¡éªŒçš„ï¼Œå› ä¸ºè¦ç»™å›¾ç‰‡æ“ä½œå’Œç©ºé—´æˆå‘˜æ“ä½œå¢åŠ æƒé™æ ¡éªŒé€»è¾‘ï¼Œè¿˜éœ€è¦è·å–åˆ°ç©ºé—´ idï¼Œæ‰çŸ¥é“ç”¨æˆ·æ˜¯å¦å…·æœ‰æŸä¸ªå›¢é˜Ÿç©ºé—´çš„æƒé™ã€‚**é‚£ä¹ˆå¦‚ä½•è·å–åˆ°ç©ºé—´ id å‘¢ï¼Ÿ**
- å¦‚æœè¦è¿›è¡Œç»Ÿä¸€çš„æƒé™æ ¡éªŒï¼Œä¹ŸåŒ…æ‹¬äº†å…¬å…±å›¾åº“å’Œç§æœ‰ç©ºé—´ï¼Œæ›´è¦å‘½çš„æ˜¯ï¼Œå…¬å…±å›¾åº“æ˜¯æ²¡æœ‰ç©ºé—´ id çš„ï¼**è¿™å°±æ„å‘³ç€è¦æ ¹æ®æ“ä½œçš„å›¾ç‰‡æƒ…å†µåŠ¨æ€åˆ¤æ–­ã€‚**

æ‰€ä»¥è¦è§£å†³çš„å…³é”®é—®é¢˜æœ‰ 2 ä¸ªï¼š

1. å¦‚ä½•åœ¨ Sa-Token ä¸­è·å–å½“å‰è¯·æ±‚æ“ä½œçš„å‚æ•°ï¼Ÿ
2. å¦‚ä½•ç¼–å†™ä¸€å¥—æƒé™æ ¡éªŒé€»è¾‘ï¼ŒåŒæ—¶å…¼å®¹å…¬å…±å›¾åº“ã€ç§æœ‰ç©ºé—´å’Œå›¢é˜Ÿç©ºé—´ï¼Ÿ

**1ï¼‰å…ˆçœ‹ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œä½¿ç”¨ Sa-Token æœ‰ 2 ç§æ–¹å¼ â€”â€” æ³¨è§£å¼å’Œç¼–ç¨‹å¼ã€‚**

å¦‚æœä½¿ç”¨æ³¨è§£å¼ï¼Œé‚£ä¹ˆåœ¨æ¥å£è¢«è°ƒç”¨æ—¶å°±ä¼šç«‹åˆ»è§¦å‘ Sa-Token çš„æƒé™æ ¡éªŒï¼Œæ­¤æ—¶å‚æ•°åªèƒ½é€šè¿‡ Servlet çš„è¯·æ±‚å¯¹è±¡ä¼ é€’ã€‚

å¦‚æœä½¿ç”¨ç¼–ç¨‹å¼ï¼Œå¯ä»¥åœ¨ä»£ç ä»»æ„ä½ç½®æ‰§è¡Œæƒé™æ ¡éªŒï¼Œåªè¦åœ¨æ‰§è¡Œå‰å°†å‚æ•°æ”¾åˆ°å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ ThreadLocal å¯¹è±¡ä¸­ï¼Œå°±èƒ½åœ¨é‰´æƒæ—¶è·å–åˆ°äº†ã€‚

ä¸ºäº†åç»­ç»™æ¥å£æ·»åŠ é‰´æƒæ›´ç›´è§‚æ–¹ä¾¿ï¼Œæˆ‘ä»¬é€‰æ‹©æ³¨è§£å¼é‰´æƒã€‚é‚£å°±æœ‰ä¸€ä¸ªå…³é”®é—®é¢˜ï¼Œä¸åŒæ¥å£çš„è¯·æ±‚å‚æ•°æ˜¯ä¸åŒçš„ï¼Œæœ‰çš„è¯·æ±‚å‚æ•°æœ‰ spaceIdã€æœ‰çš„åªæœ‰ pictureIdï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿ

æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ª **ä¸Šä¸‹æ–‡ç±»**ï¼Œç”¨äºç»Ÿä¸€æ¥æ”¶è¯·æ±‚ä¸­ä¼ é€’æ¥çš„å‚æ•°ï¼š

```java
/**
 * SpaceUserAuthContext
 * è¡¨ç¤ºç”¨æˆ·åœ¨ç‰¹å®šç©ºé—´å†…çš„æˆæƒä¸Šä¸‹æ–‡ï¼ŒåŒ…æ‹¬å…³è”çš„å›¾ç‰‡ã€ç©ºé—´å’Œç”¨æˆ·ä¿¡æ¯ã€‚
 */
@Data
public class SpaceUserAuthContext {

    /**
     * ä¸´æ—¶å‚æ•°ï¼Œä¸åŒè¯·æ±‚å¯¹åº”çš„ id å¯èƒ½ä¸åŒ
     */
    private Long id;

    /**
     * å›¾ç‰‡ ID
     */
    private Long pictureId;

    /**
     * ç©ºé—´ ID
     */
    private Long spaceId;

    /**
     * ç©ºé—´ç”¨æˆ· ID
     */
    private Long spaceUserId;

    /**
     * å›¾ç‰‡ä¿¡æ¯
     */
    private Picture picture;

    /**
     * ç©ºé—´ä¿¡æ¯
     */
    private Space space;

    /**
     * ç©ºé—´ç”¨æˆ·ä¿¡æ¯
     */
    private SpaceUser spaceUser;
}
```

å¦‚ä½•çŸ¥é“å“ªä¸ªè¯·æ±‚åŒ…å«äº†å“ªäº›å­—æ®µå‘¢ï¼Ÿåˆ«å¿˜äº†ï¼Œæˆ‘ä»¬æ¯ç±»æ“ä½œï¼ˆå›¾ç‰‡ / ç©ºé—´æˆå‘˜ï¼‰çš„è¯·æ±‚å‰ç¼€éƒ½æ˜¯å›ºå®šçš„ï¼Œå¯ä»¥ä»è¯·æ±‚è·¯å¾„ä¸­æå–åˆ°è¦è®¿é—®çš„æ˜¯å“ªä¸ª Controllerï¼Œè€Œæ¯ç±» Controller çš„è¯·æ±‚å‚æ•°ï¼Œéƒ½æ˜¯ä¸€è‡´çš„ã€‚sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=J+5o58b0kn/bTqd/50F76o1L2/PhqvQWrl14ca26WW0=J+5o58b0kn/bTqd/50F76o1L2/PhqvQWrl14ca26WW0=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=

ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœè®¿é—®åœ°å€æ˜¯ `/api/picture/xxx`ï¼Œé‚£ä¹ˆä¸€å®šæ˜¯è¦è°ƒç”¨ PictureController çš„æ¥å£ï¼Œè¿™äº›æ¥å£çš„ id å­—æ®µéƒ½è¡¨ç¤º pictureIdã€‚æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è®¿é—®åœ°å€æ¥å†³å®šåº”è¯¥ç»™ä¸Šä¸‹æ–‡ä¼ é€’å“ªäº›å­—æ®µï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
@Value("${server.servlet.context-path}")
private String contextPath;

/**
 * ä»è¯·æ±‚ä¸­è·å–ä¸Šä¸‹æ–‡å¯¹è±¡
 */
private SpaceUserAuthContext getAuthContextByRequest() {
    HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes()).getRequest();
    String contentType = request.getHeader(Header.CONTENT_TYPE.getValue());
    SpaceUserAuthContext authRequest;
    // å…¼å®¹ get å’Œ post æ“ä½œ
    if (ContentType.JSON.getValue().equals(contentType)) {
        String body = ServletUtil.getBody(request);
        authRequest = JSONUtil.toBean(body, SpaceUserAuthContext.class);
    } else {
        Map<String, String> paramMap = ServletUtil.getParamMap(request);
        authRequest = BeanUtil.toBean(paramMap, SpaceUserAuthContext.class);
    }
    // æ ¹æ®è¯·æ±‚è·¯å¾„åŒºåˆ† id å­—æ®µçš„å«ä¹‰
    Long id = authRequest.getId();
    if (ObjUtil.isNotNull(id)) {
        String requestUri = request.getRequestURI();
        String partUri = requestUri.replace(contextPath + "/", "");
        String moduleName = StrUtil.subBefore(partUri, "/", false);
        switch (moduleName) {
            case "picture":
                authRequest.setPictureId(id);
                break;
            case "spaceUser":
                authRequest.setSpaceUserId(id);
                break;
            case "space":
                authRequest.setSpaceId(id);
                break;
            default:
        }
    }
    return authRequest;
}
```

æ³¨æ„ï¼Œä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Hutool çš„å·¥å…·ç±» `ServletUtil` ä» HttpServletRequest ä¸­è·å–åˆ°äº†å‚æ•°ä¿¡æ¯ï¼Œä½†æ˜¯å‘çˆ¹çš„æ˜¯ï¼ŒHttpServletRequest çš„ body å€¼æ˜¯ä¸ªæµï¼Œ**åªæ”¯æŒè¯»å–ä¸€æ¬¡ï¼Œè¯»å®Œå°±æ²¡äº†ï¼**æ‰€ä»¥ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è¿˜è¦åœ¨ `config` åŒ…ä¸‹è‡ªå®šä¹‰è¯·æ±‚åŒ…è£…ç±»å’Œè¯·æ±‚åŒ…è£…ç±»è¿‡æ»¤å™¨ã€‚è¿™äº›å°±æ˜¯æ ·æ¿ä»£ç äº†ï¼Œå¤§å®¶ç›´æ¥å¤åˆ¶ç²˜è´´å³å¯ï¼Œä¸ç”¨ç¼–ç ã€‚J+5o58b0kn/bTqd/50F76o1L2/PhqvQWrl14ca26WW0=3n/Enp4sfaVRq/PFMJKPxPdBTxeNas/Bp33wsl/l9Wg=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=3n/Enp4sfaVRq/PFMJKPxPdBTxeNas/Bp33wsl/l9Wg=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=58IUDBvyDy7G+gVMqAunJfAo72ZBX//2DD/nhaX54Xg=J+5o58b0kn/bTqd/50F76o1L2/PhqvQWrl14ca26WW0=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=58IUDBvyDy7G+gVMqAunJfAo72ZBX//2DD/nhaX54Xg=3n/Enp4sfaVRq/PFMJKPxPdBTxeNas/Bp33wsl/l9Wg=

RequestWrapper è¯·æ±‚åŒ…è£…ç±»ï¼š

```java
â–¼javaå¤åˆ¶ä»£ç /**
 * åŒ…è£…è¯·æ±‚ï¼Œä½¿ InputStream å¯ä»¥é‡å¤è¯»å–
 *
 * @author pine
 */
@Slf4j
public class RequestWrapper extends HttpServletRequestWrapper {

    private final String body;

    public RequestWrapper(HttpServletRequest request) {
        super(request);
        StringBuilder stringBuilder = new StringBuilder();
        try (InputStream inputStream = request.getInputStream(); BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(inputStream))) {
            char[] charBuffer = new char[128];
            int bytesRead = -1;
            while ((bytesRead = bufferedReader.read(charBuffer)) > 0) {
                stringBuilder.append(charBuffer, 0, bytesRead);
            }
        } catch (IOException ignored) {
        }
        body = stringBuilder.toString();
    }

    @Override
    public ServletInputStream getInputStream() throws IOException {
        final ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(body.getBytes());
        return new ServletInputStream() {
            @Override
            public boolean isFinished() {
                return false;
            }

            @Override
            public boolean isReady() {
                return false;
            }

            @Override
            public void setReadListener(ReadListener readListener) {
            }

            @Override
            public int read() throws IOException {
                return byteArrayInputStream.read();
            }
        };

    }

    @Override
    public BufferedReader getReader() throws IOException {
        return new BufferedReader(new InputStreamReader(this.getInputStream()));
    }

    public String getBody() {
        return this.body;
    }

}
```

HttpRequestWrapperFilter è¯·æ±‚åŒ…è£…è¿‡æ»¤å™¨ï¼š

```java
â–¼javaå¤åˆ¶ä»£ç /**
 * è¯·æ±‚åŒ…è£…è¿‡æ»¤å™¨
 *
 * @author pine
 */
@Order(1)
@Component
public class HttpRequestWrapperFilter implements Filter {

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws ServletException, IOException {
        if (request instanceof HttpServletRequest) {
            HttpServletRequest servletRequest = (HttpServletRequest) request;
            String contentType = servletRequest.getHeader(Header.CONTENT_TYPE.getValue());
            if (ContentType.JSON.getValue().equals(contentType)) {
                // å¯ä»¥å†ç»†ç²’åº¦ä¸€äº›ï¼Œåªæœ‰éœ€è¦è¿›è¡Œç©ºé—´æƒé™æ ¡éªŒçš„æ¥å£æ‰éœ€è¦åŒ…ä¸€å±‚
                chain.doFilter(new RequestWrapper(servletRequest), response);
            } else {
                chain.doFilter(request, response);
            }
        }
    }

}
```

è¿™æ ·æˆ‘ä»¬å°±èƒ½æ­£å¸¸è·å–åˆ°è¯·æ±‚å‚æ•°äº†~

**2ï¼‰ç¼–å†™é€šç”¨çš„æƒé™æ ¡éªŒé€»è¾‘ï¼Œå…¼å®¹å…¬å…±å›¾åº“ã€ç§æœ‰ç©ºé—´å’Œå›¢é˜Ÿç©ºé—´**

è¿™ä¸ªæ²¡å•¥å¥½è¯´çš„ï¼Œå°±æ˜¯å†™ä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸”æ˜¯æ¯”è¾ƒå¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ‰€ä»¥å»ºè®®ä¸€å®šè¦å…ˆæŠŠä¸šåŠ¡æµç¨‹æ¢³ç†æ¸…æ¥šï¼Œå†ç¼–å†™ä»£ç ã€‚

ä¸šåŠ¡æµç¨‹å¦‚ä¸‹ï¼š

1. æ ¡éªŒç™»å½•ç±»å‹ï¼šå¦‚æœ `loginType` ä¸æ˜¯ `"space"`ï¼Œç›´æ¥è¿”å›ç©ºæƒé™åˆ—è¡¨ã€‚
2. ç®¡ç†å‘˜æƒé™å¤„ç†ï¼šå¦‚æœå½“å‰ç”¨æˆ·ä¸ºç®¡ç†å‘˜ï¼Œç›´æ¥è¿”å›ç®¡ç†å‘˜æƒé™åˆ—è¡¨ã€‚
3. è·å–ä¸Šä¸‹æ–‡å¯¹è±¡ï¼šä»è¯·æ±‚ä¸­è·å– `SpaceUserAuthContext` ä¸Šä¸‹æ–‡ï¼Œæ£€æŸ¥ä¸Šä¸‹æ–‡å­—æ®µæ˜¯å¦ä¸ºç©ºã€‚**å¦‚æœä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰å­—æ®µå‡ä¸ºç©ºï¼ˆå¦‚æ²¡æœ‰ç©ºé—´æˆ–å›¾ç‰‡ä¿¡æ¯ï¼‰ï¼Œè§†ä¸ºå…¬å…±å›¾åº“æ“ä½œï¼Œç›´æ¥è¿”å›ç®¡ç†å‘˜æƒé™åˆ—è¡¨ã€‚**
4. æ ¡éªŒç™»å½•çŠ¶æ€ï¼šé€šè¿‡ `loginId` è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ã€‚å¦‚æœç”¨æˆ·æœªç™»å½•ï¼ŒæŠ›å‡ºæœªæˆæƒå¼‚å¸¸ï¼›å¦åˆ™è·å–ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯† `userId`ï¼Œç”¨äºåç»­æƒé™åˆ¤æ–­ã€‚
5. ä»ä¸Šä¸‹æ–‡ä¸­ä¼˜å…ˆè·å– `SpaceUser` å¯¹è±¡ï¼šå¦‚æœä¸Šä¸‹æ–‡ä¸­å­˜åœ¨ `SpaceUser` å¯¹è±¡ï¼Œç›´æ¥æ ¹æ®å…¶è§’è‰²è·å–æƒé™ç åˆ—è¡¨ã€‚
6. é€šè¿‡ `spaceUserId` è·å–ç©ºé—´ç”¨æˆ·ä¿¡æ¯ï¼šå¦‚æœä¸Šä¸‹æ–‡ä¸­å­˜åœ¨ `spaceUserId`ï¼š

- æŸ¥è¯¢å¯¹åº”çš„ `SpaceUser` æ•°æ®ã€‚å¦‚æœæœªæ‰¾åˆ°ï¼ŒæŠ›å‡ºæ•°æ®æœªæ‰¾åˆ°å¼‚å¸¸ã€‚
- æ ¡éªŒå½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å±äºè¯¥ç©ºé—´ï¼Œå¦‚æœä¸æ˜¯ï¼Œè¿”å›ç©ºæƒé™åˆ—è¡¨ã€‚
- å¦åˆ™ï¼Œæ ¹æ®ç™»å½•ç”¨æˆ·åœ¨è¯¥ç©ºé—´çš„è§’è‰²ï¼Œè¿”å›ç›¸åº”çš„æƒé™ç åˆ—è¡¨ã€‚

1. é€šè¿‡ `spaceId` æˆ– `pictureId` è·å–ç©ºé—´æˆ–å›¾ç‰‡ä¿¡æ¯

- å¦‚æœ `spaceId` ä¸å­˜åœ¨ï¼šä½¿ç”¨ `pictureId` æŸ¥è¯¢å›¾ç‰‡ä¿¡æ¯ï¼Œå¹¶é€šè¿‡å›¾ç‰‡çš„ `spaceId` ç»§ç»­åˆ¤æ–­æƒé™ï¼›å¦‚æœ `pictureId` å’Œ `spaceId` å‡ä¸ºç©ºï¼Œé»˜è®¤è§†ä¸ºç®¡ç†å‘˜æƒé™ã€‚
- å¯¹äºå…¬å…±å›¾åº“ï¼š**å¦‚æœå›¾ç‰‡æ˜¯å½“å‰ç”¨æˆ·ä¸Šä¼ çš„ï¼Œæˆ–è€…å½“å‰ç”¨æˆ·ä¸ºç®¡ç†å‘˜**ï¼Œè¿”å›ç®¡ç†å‘˜æƒé™åˆ—è¡¨ï¼›å¦‚æœå›¾ç‰‡ä¸æ˜¯å½“å‰ç”¨æˆ·ä¸Šä¼ çš„ï¼Œè¿”å›ä»…å…è®¸æŸ¥çœ‹çš„æƒé™ç ã€‚

1. è·å– `Space` å¯¹è±¡å¹¶åˆ¤æ–­ç©ºé—´ç±»å‹ï¼šæŸ¥è¯¢ `Space` ä¿¡æ¯ï¼Œå¦‚æœæœªæ‰¾åˆ°ç©ºé—´æ•°æ®ï¼ŒæŠ›å‡ºæ•°æ®æœªæ‰¾åˆ°å¼‚å¸¸ã€‚å¦åˆ™æ ¹æ®ç©ºé—´ç±»å‹è¿›è¡Œåˆ¤æ–­

- ç§æœ‰ç©ºé—´ï¼šä»…ç©ºé—´æ‰€æœ‰è€…å’Œç®¡ç†å‘˜æœ‰æƒé™ï¼ˆå³è¿”å›å…¨éƒ¨æƒé™ï¼‰ï¼Œå…¶ä»–ç”¨æˆ·è¿”å›ç©ºæƒé™åˆ—è¡¨ã€‚
- å›¢é˜Ÿç©ºé—´ï¼šæŸ¥è¯¢ç™»å½•ç”¨æˆ·åœ¨è¯¥ç©ºé—´çš„è§’è‰²ï¼Œå¹¶è¿”å›å¯¹åº”çš„æƒé™ç åˆ—è¡¨ã€‚å¦‚æœç”¨æˆ·ä¸å±äºè¯¥ç©ºé—´ï¼Œè¿”å›ç©ºæƒé™åˆ—è¡¨ã€‚

æ ¹æ®ä¸šåŠ¡æµç¨‹ç¼–å†™ä»£ç ï¼š

```java
public List<String> getPermissionList(Object loginId, String loginType) {
    // åˆ¤æ–­ loginTypeï¼Œä»…å¯¹ç±»å‹ä¸º "space" è¿›è¡Œæƒé™æ ¡éªŒ
    if (!StpKit.SPACE_TYPE.equals(loginType)) {
        return new ArrayList<>();
    }
    // ç®¡ç†å‘˜æƒé™ï¼Œè¡¨ç¤ºæƒé™æ ¡éªŒé€šè¿‡
    List<String> ADMIN_PERMISSIONS = spaceUserAuthManager.getPermissionsByRole(SpaceRoleEnum.ADMIN.getValue());
    // è·å–ä¸Šä¸‹æ–‡å¯¹è±¡
    SpaceUserAuthContext authContext = getAuthContextByRequest();
    // å¦‚æœæ‰€æœ‰å­—æ®µéƒ½ä¸ºç©ºï¼Œè¡¨ç¤ºæŸ¥è¯¢å…¬å…±å›¾åº“ï¼Œå¯ä»¥é€šè¿‡
    if (isAllFieldsNull(authContext)) {
        return ADMIN_PERMISSIONS;
    }
    // è·å– userId
    User loginUser = (User) StpKit.SPACE.getSessionByLoginId(loginId).get(USER_LOGIN_STATE);
    if (loginUser == null) {
        throw new BusinessException(ErrorCode.NO_AUTH_ERROR, "ç”¨æˆ·æœªç™»å½•");
    }
    Long userId = loginUser.getId();
    // ä¼˜å…ˆä»ä¸Šä¸‹æ–‡ä¸­è·å– SpaceUser å¯¹è±¡
    SpaceUser spaceUser = authContext.getSpaceUser();
    if (spaceUser != null) {
        return spaceUserAuthManager.getPermissionsByRole(spaceUser.getSpaceRole());
    }
    // å¦‚æœæœ‰ spaceUserIdï¼Œå¿…ç„¶æ˜¯å›¢é˜Ÿç©ºé—´ï¼Œé€šè¿‡æ•°æ®åº“æŸ¥è¯¢ SpaceUser å¯¹è±¡
    Long spaceUserId = authContext.getSpaceUserId();
    if (spaceUserId != null) {
        spaceUser = spaceUserService.getById(spaceUserId);
        if (spaceUser == null) {
            throw new BusinessException(ErrorCode.NOT_FOUND_ERROR, "æœªæ‰¾åˆ°ç©ºé—´ç”¨æˆ·ä¿¡æ¯");
        }
        // å–å‡ºå½“å‰ç™»å½•ç”¨æˆ·å¯¹åº”çš„ spaceUser
        SpaceUser loginSpaceUser = spaceUserService.lambdaQuery()
                .eq(SpaceUser::getSpaceId, spaceUser.getSpaceId())
                .eq(SpaceUser::getUserId, userId)
                .one();
        if (loginSpaceUser == null) {
            return new ArrayList<>();
        }
        // è¿™é‡Œä¼šå¯¼è‡´ç®¡ç†å‘˜åœ¨ç§æœ‰ç©ºé—´æ²¡æœ‰æƒé™ï¼Œå¯ä»¥å†æŸ¥ä¸€æ¬¡åº“å¤„ç†
        return spaceUserAuthManager.getPermissionsByRole(loginSpaceUser.getSpaceRole());
    }
    // å¦‚æœæ²¡æœ‰ spaceUserIdï¼Œå°è¯•é€šè¿‡ spaceId æˆ– pictureId è·å– Space å¯¹è±¡å¹¶å¤„ç†
    Long spaceId = authContext.getSpaceId();
    if (spaceId == null) {
        // å¦‚æœæ²¡æœ‰ spaceIdï¼Œé€šè¿‡ pictureId è·å– Picture å¯¹è±¡å’Œ Space å¯¹è±¡
        Long pictureId = authContext.getPictureId();
        // å›¾ç‰‡ id ä¹Ÿæ²¡æœ‰ï¼Œåˆ™é»˜è®¤é€šè¿‡æƒé™æ ¡éªŒ
        if (pictureId == null) {
            return ADMIN_PERMISSIONS;
        }
        Picture picture = pictureService.lambdaQuery()
                .eq(Picture::getId, pictureId)
                .select(Picture::getId, Picture::getSpaceId, Picture::getUserId)
                .one();
        if (picture == null) {
            throw new BusinessException(ErrorCode.NOT_FOUND_ERROR, "æœªæ‰¾åˆ°å›¾ç‰‡ä¿¡æ¯");
        }
        spaceId = picture.getSpaceId();
        // å…¬å…±å›¾åº“ï¼Œä»…æœ¬äººæˆ–ç®¡ç†å‘˜å¯æ“ä½œ
        if (spaceId == null) {
            if (picture.getUserId().equals(userId) || userService.isAdmin(loginUser)) {
                return ADMIN_PERMISSIONS;
            } else {
                // ä¸æ˜¯è‡ªå·±çš„å›¾ç‰‡ï¼Œä»…å¯æŸ¥çœ‹
                return Collections.singletonList(SpaceUserPermissionConstant.PICTURE_VIEW);
            }
        }
    }
    // è·å– Space å¯¹è±¡
    Space space = spaceService.getById(spaceId);
    if (space == null) {
        throw new BusinessException(ErrorCode.NOT_FOUND_ERROR, "æœªæ‰¾åˆ°ç©ºé—´ä¿¡æ¯");
    }
    // æ ¹æ® Space ç±»å‹åˆ¤æ–­æƒé™
    if (space.getSpaceType() == SpaceTypeEnum.PRIVATE.getValue()) {
        // ç§æœ‰ç©ºé—´ï¼Œä»…æœ¬äººæˆ–ç®¡ç†å‘˜æœ‰æƒé™
        if (space.getUserId().equals(userId) || userService.isAdmin(loginUser)) {
            return ADMIN_PERMISSIONS;
        } else {
            return new ArrayList<>();
        }
    } else {
        // å›¢é˜Ÿç©ºé—´ï¼ŒæŸ¥è¯¢ SpaceUser å¹¶è·å–è§’è‰²å’Œæƒé™
        spaceUser = spaceUserService.lambdaQuery()
                .eq(SpaceUser::getSpaceId, spaceId)
                .eq(SpaceUser::getUserId, userId)
                .one();
        if (spaceUser == null) {
            return new ArrayList<>();
        }
        return spaceUserAuthManager.getPermissionsByRole(spaceUser.getSpaceRole());
    }
}
```

ä¸Šè¿°ä»£ç ä¾èµ– â€œåˆ¤æ–­æ‰€æœ‰å­—æ®µéƒ½ä¸ºç©ºâ€ çš„æ–¹æ³•ï¼Œé€šè¿‡åå°„è·å–å¯¹è±¡çš„æ‰€æœ‰å­—æ®µï¼Œè¿›è¡Œåˆ¤ç©ºï¼š

```java
private boolean isAllFieldsNull(Object object) {
    if (object == null) {
        return true; // å¯¹è±¡æœ¬èº«ä¸ºç©º
    }
    // è·å–æ‰€æœ‰å­—æ®µå¹¶åˆ¤æ–­æ˜¯å¦æ‰€æœ‰å­—æ®µéƒ½ä¸ºç©º
    return Arrays.stream(ReflectUtil.getFields(object.getClass()))
            // è·å–å­—æ®µå€¼
            .map(field -> ReflectUtil.getFieldValue(object, field))
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å­—æ®µéƒ½ä¸ºç©º
            .allMatch(ObjectUtil::isEmpty);
}
```

OKï¼Œè¿™å°±æ˜¯ Sa-Token åŠ¨æ€æƒé™æ ¡éªŒçš„æ ¸å¿ƒä»£ç ï¼Œä½ ä¼šå‘ç°ç¼–å†™ä¸€å¥—ç»Ÿä¸€çš„æƒé™æ ¡éªŒé€»è¾‘å¹¶ä¸å®¹æ˜“ï¼Œæ‰€ä»¥å®é™…é¡¹ç›®ä¸­è¦ **æŒ‰éœ€ä½¿ç”¨** ç¬¬ä¸‰æ–¹æƒé™æ ¡éªŒæ¡†æ¶ã€‚

ğŸ’¡ æ³¨æ„ï¼Œé‡‡ç”¨æ³¨è§£å¼é‰´æƒ + é€šè¿‡è¯·æ±‚å¯¹è±¡è·å–å‚æ•°æ—¶ï¼Œå¯èƒ½ä¼šé‡å¤æŸ¥è¯¢æ•°æ®åº“ã€‚æ¯”å¦‚ä¸šåŠ¡ä»£ç ä¸­å·²ç»æœ‰æ ¹æ® id æŸ¥è¯¢ç©ºé—´ä¿¡æ¯çš„ä»£ç äº†ï¼Œä½†ä¸ºäº†æƒé™æ ¡éªŒï¼Œä¹ŸæŸ¥åº“è·å–äº†ä¸€æ¬¡ç©ºé—´ä¿¡æ¯ï¼Œä¼šå¯¹æ€§èƒ½é€ æˆå½±å“ã€‚å¦‚æœæƒ³æ›´çµæ´»ã€æ›´é«˜æ€§èƒ½åœ°å®ç°é‰´æƒï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ç¼–ç¨‹å¼é‰´æƒã€‚è·å–æƒé™çš„æ–¹æ³•å’Œä¸Šä¸‹æ–‡ç±»éƒ½æ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œåªéœ€è¦å°† `getAuthContextByRequest` æ–¹æ³•çš„é€»è¾‘æ”¹ä¸ºä» ThreadLocal ä¸Šä¸‹æ–‡ä¸­è·å–å³å¯ã€‚

åŸºäº ThreadLocal å®ç°ä¸Šä¸‹æ–‡ç®¡ç†çš„ç¤ºä¾‹ä»£ç ï¼š

```java
public class SaTokenContextHolder {

    private static final ThreadLocal<Map<String, Object>> CONTEXT = ThreadLocal.withInitial(HashMap::new);

    // è®¾ç½®ä¸Šä¸‹æ–‡æ•°æ®
    public static void set(String key, Object value) {
        CONTEXT.get().put(key, value);
    }

    // è·å–ä¸Šä¸‹æ–‡æ•°æ®
    public static Object get(String key) {
        return CONTEXT.get().get(key);
    }

    // æ¸…ç†ä¸Šä¸‹æ–‡æ•°æ®ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
    public static void clear() {
        CONTEXT.remove();
    }
}
```

#### 5ã€æƒé™æ ¡éªŒæ³¨è§£

é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ [æ³¨è§£å¼é‰´æƒ](https://sa-token.cc/doc.html#/use/at-check)ï¼Œéœ€è¦æ–°å»ºé…ç½®ç±»ï¼š

![img](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221432460.webp)

ä½†ç”±äºæˆ‘ä»¬ä½¿ç”¨äº†å¤šè´¦å·ä½“ç³»ï¼Œæ¯æ¬¡ä½¿ç”¨æ³¨è§£æ—¶éƒ½è¦æŒ‡å®šè´¦å·ä½“ç³»çš„ loginTypeï¼Œä¼šæ¯”è¾ƒéº»çƒ¦ï¼š

```java
@SaCheckLogin(type = StpUserUtil.TYPE)
```

æ‰€ä»¥å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œä½¿ç”¨ [æ³¨è§£åˆå¹¶](https://sa-token.cc/doc.html#/up/many-account?id=_7ã€ä½¿ç”¨æ³¨è§£åˆå¹¶ç®€åŒ–ä»£ç ) ç®€åŒ–ä»£ç ã€‚åœ¨ `auth.annotation` åŒ…ä¸‹æ–°å»º Sa-Token é…ç½®ç±»ï¼Œå¼€å¯æ³¨è§£é‰´æƒå’Œæ³¨è§£åˆå¹¶ï¼š

```java
@Configuration
public class SaTokenConfigure implements WebMvcConfigurer {

    // æ³¨å†Œ Sa-Token æ‹¦æˆªå™¨ï¼Œæ‰“å¼€æ³¨è§£å¼é‰´æƒåŠŸèƒ½
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // æ³¨å†Œ Sa-Token æ‹¦æˆªå™¨ï¼Œæ‰“å¼€æ³¨è§£å¼é‰´æƒåŠŸèƒ½
        registry.addInterceptor(new SaInterceptor()).addPathPatterns("/**");
    }

    @PostConstruct
    public void rewriteSaStrategy() {
        // é‡å†™Sa-Tokençš„æ³¨è§£å¤„ç†å™¨ï¼Œå¢åŠ æ³¨è§£åˆå¹¶åŠŸèƒ½ 
        SaAnnotationStrategy.instance.getAnnotation = (element, annotationClass) -> {
            return AnnotatedElementUtils.getMergedAnnotation(element, annotationClass);
        };
    }
}
```

ç„¶åå‚è€ƒ [å®˜æ–¹æä¾›çš„ç¤ºä¾‹ä»£ç ](https://gitee.com/dromara/sa-token/blob/master/sa-token-demo/sa-token-demo-case/src/main/java/com/pj/satoken/merge_annotation/SaUserCheckPermission.java#)ï¼Œåœ¨ `auth.annotation` åŒ…ä¸‹æ–°å»ºç©ºé—´è´¦å·ä½“ç³»çš„é‰´æƒæ³¨è§£ï¼š

```java
/**
 * ç©ºé—´æƒé™è®¤è¯ï¼šå¿…é¡»å…·æœ‰æŒ‡å®šæƒé™æ‰èƒ½è¿›å…¥è¯¥æ–¹æ³•
 * <p> å¯æ ‡æ³¨åœ¨å‡½æ•°ã€ç±»ä¸Šï¼ˆæ•ˆæœç­‰åŒäºæ ‡æ³¨åœ¨æ­¤ç±»çš„æ‰€æœ‰æ–¹æ³•ä¸Šï¼‰
 */
@SaCheckPermission(type = StpKit.SPACE_TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.METHOD, ElementType.TYPE})
public @interface SaSpaceCheckPermission {

    /**
     * éœ€è¦æ ¡éªŒçš„æƒé™ç 
     *
     * @return éœ€è¦æ ¡éªŒçš„æƒé™ç 
     */
    @AliasFor(annotation = SaCheckPermission.class)
    String[] value() default {};

    /**
     * éªŒè¯æ¨¡å¼ï¼šAND | ORï¼Œé»˜è®¤AND
     *
     * @return éªŒè¯æ¨¡å¼
     */
    @AliasFor(annotation = SaCheckPermission.class)
    SaMode mode() default SaMode.AND;

    /**
     * åœ¨æƒé™æ ¡éªŒä¸é€šè¿‡æ—¶çš„æ¬¡è¦é€‰æ‹©ï¼Œä¸¤è€…åªè¦å…¶ä¸€æ ¡éªŒæˆåŠŸå³å¯é€šè¿‡æ ¡éªŒ
     *
     * <p>
     * ä¾‹1ï¼š@SaCheckPermission(value="user-add", orRole="admin")ï¼Œ
     * ä»£è¡¨æœ¬æ¬¡è¯·æ±‚åªè¦å…·æœ‰ user-addæƒé™ æˆ– adminè§’è‰² å…¶ä¸€å³å¯é€šè¿‡æ ¡éªŒã€‚
     * </p>
     *
     * <p>
     * ä¾‹2ï¼š orRole = {"admin", "manager", "staff"}ï¼Œå…·æœ‰ä¸‰ä¸ªè§’è‰²å…¶ä¸€å³å¯ã€‚ <br>
     * ä¾‹3ï¼š orRole = {"admin, manager, staff"}ï¼Œå¿…é¡»ä¸‰ä¸ªè§’è‰²åŒæ—¶å…·å¤‡ã€‚
     * </p>
     *
     * @return /
     */
    @AliasFor(annotation = SaCheckPermission.class)
    String[] orRole() default {};

}
```

ä¹‹åå°±å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥æ³¨è§£äº†ã€‚

#### 6ã€åº”ç”¨æƒé™æ³¨è§£

è®¤çœŸæ ¸å¯¹ä¸€éå„ä¸ªæ“ä½œæ¥å£çš„ä»£ç ã€ä»¥åŠæ¥å£è°ƒç”¨çš„ Service ä»£ç ï¼ŒåŒ…æ‹¬å›¾ç‰‡æ“ä½œ PictureController å’ŒPictureServiceã€ç©ºé—´æˆå‘˜æ“ä½œ SpaceUserController å’Œ SpaceUserServiceã€‚

1ï¼‰ç»™ Controller æ¥å£è¡¥å……ä¸Šåˆé€‚çš„æƒé™æ³¨è§£ï¼ŒPictureController å›¾ç‰‡æ¥å£ï¼š

```java
// ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é‡æ–°ä¸Šä¼ ï¼‰
@PostMapping("/upload")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.PICTURE_UPLOAD)
public BaseResponse<PictureVO> uploadPicture() {
}

// é€šè¿‡ URL ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é‡æ–°ä¸Šä¼ ï¼‰
@PostMapping("/upload/url")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.PICTURE_UPLOAD)
public BaseResponse<PictureVO> uploadPictureByUrl() {
}

// åˆ é™¤å›¾ç‰‡
@PostMapping("/delete")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.PICTURE_DELETE)
public BaseResponse<Boolean> deletePicture() {
}

// ç¼–è¾‘å›¾ç‰‡ï¼ˆç»™ç”¨æˆ·ä½¿ç”¨ï¼‰
@PostMapping("/edit")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.PICTURE_EDIT)
public BaseResponse<Boolean> editPicture() {
}

// æ ¹æ®é¢œè‰²æœç´¢å›¾ç‰‡
@PostMapping("/search/color")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.PICTURE_VIEW)
public BaseResponse<List<PictureVO>> searchPictureByColor() {
}

// æ‰¹é‡ç¼–è¾‘å›¾ç‰‡
@PostMapping("/edit/batch")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.PICTURE_EDIT)
public BaseResponse<Boolean> editPictureByBatch() {
}

// åˆ›å»º AI æ‰©å›¾ä»»åŠ¡
@PostMapping("/out_painting/create_task")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.PICTURE_EDIT)
public BaseResponse<CreateOutPaintingTaskResponse> createPictureOutPaintingTask() {
}
```

SpaceUserController æ¥å£ï¼š

```java
// æ·»åŠ æˆå‘˜åˆ°ç©ºé—´
@PostMapping("/add")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.SPACE_USER_MANAGE)
public BaseResponse<Long> addSpaceUser() {
}

// ä»ç©ºé—´ç§»é™¤æˆå‘˜
@PostMapping("/delete")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.SPACE_USER_MANAGE)
public BaseResponse<Boolean> deleteSpaceUser() {
}

// æŸ¥è¯¢æŸä¸ªæˆå‘˜åœ¨æŸä¸ªç©ºé—´çš„ä¿¡æ¯
@PostMapping("/get")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.SPACE_USER_MANAGE)
public BaseResponse<SpaceUser> getSpaceUser() {
}

// æŸ¥è¯¢æˆå‘˜ä¿¡æ¯åˆ—è¡¨
@PostMapping("/list")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.SPACE_USER_MANAGE)
public BaseResponse<List<SpaceUserVO>> listSpaceUser() {
}

// ç¼–è¾‘æˆå‘˜ä¿¡æ¯ï¼ˆè®¾ç½®æƒé™ï¼‰
@PostMapping("/edit")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.SPACE_USER_MANAGE)
public BaseResponse<Boolean> editSpaceUser() {
}
```

2ï¼‰ç§»é™¤è¿™äº›æ¥å£å’Œç›¸å…³æœåŠ¡åŸæœ¬çš„æƒé™æ ¡éªŒé€»è¾‘ï¼Œæ¯”å¦‚ `PictureService#checkPictureAuth`ï¼Œç¡®ä¿è¯¥æ–¹æ³•å˜æˆäº†ç°è‰²ï¼ˆæœªè¢«ä½¿ç”¨ï¼‰

è¿˜æœ‰ PictureServiceImpl çš„ uploadPicture æ–¹æ³•ä¸­çš„æƒé™æ ¡éªŒï¼Œä¹Ÿè¦æ³¨é‡Šæ‰ï¼š

```java
â–¼javaå¤åˆ¶ä»£ç //            // æ ¡éªŒæ˜¯å¦æœ‰ç©ºé—´çš„æƒé™ï¼Œä»…ç©ºé—´ç®¡ç†å‘˜æ‰èƒ½ä¸Šä¼ 
//            if (!loginUser.getId().equals(space.getUserId())) {
//                throw new BusinessException(ErrorCode.NO_AUTH_ERROR, "æ²¡æœ‰ç©ºé—´æƒé™");
//            }

//            // ä»…æœ¬äººæˆ–ç®¡ç†å‘˜å¯ç¼–è¾‘å›¾ç‰‡
//            if (!oldPicture.getUserId().equals(loginUser.getId()) && !userService.isAdmin(loginUser)) {
//                throw new BusinessException(ErrorCode.NO_AUTH_ERROR);
//            }
```

3ï¼‰æ³¨æ„ï¼Œåªè¦åŠ ä¸Šäº† Sa-Token æ³¨è§£ï¼Œæ¡†æ¶å°±ä¼šå¼ºåˆ¶è¦æ±‚ç”¨æˆ·ç™»å½•ï¼Œæœªç™»å½•ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚æ‰€ä»¥é’ˆå¯¹æœªç™»å½•ä¹Ÿå¯ä»¥è°ƒç”¨çš„æ¥å£ï¼Œéœ€è¦æ”¹ä¸ºç¼–ç¨‹å¼æƒé™æ ¡éªŒï¼Œæ¯”å¦‚ getPictureVOById å’Œ listPictureVOByPage æ–¹æ³•ã€‚eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=58IUDBvyDy7G+gVMqAunJfAo72ZBX//2DD/nhaX54Xg=

```java
@GetMapping("/get/vo")
public BaseResponse<PictureVO> getPictureVOById(long id, HttpServletRequest request) {
    ThrowUtils.throwIf(id <= 0, ErrorCode.PARAMS_ERROR);
    // æŸ¥è¯¢æ•°æ®åº“
    Picture picture = pictureService.getById(id);
    ThrowUtils.throwIf(picture == null, ErrorCode.NOT_FOUND_ERROR);
    // ç©ºé—´çš„å›¾ç‰‡ï¼Œéœ€è¦æ ¡éªŒæƒé™
    Space space = null;
    Long spaceId = picture.getSpaceId();
    if (spaceId != null) {
        boolean hasPermission = StpKit.SPACE.hasPermission(SpaceUserPermissionConstant.PICTURE_VIEW);
        ThrowUtils.throwIf(!hasPermission, ErrorCode.NO_AUTH_ERROR);
    }
    PictureVO pictureVO = pictureService.getPictureVO(picture, request);
    // è·å–å°è£…ç±»
    return ResultUtils.success(pictureVO);
}

@PostMapping("/list/page/vo")
public BaseResponse<Page<PictureVO>> listPictureVOByPage(@RequestBody PictureQueryRequest pictureQueryRequest, HttpServletRequest request) {
    long current = pictureQueryRequest.getCurrent();
    long size = pictureQueryRequest.getPageSize();
    // é™åˆ¶çˆ¬è™«
    ThrowUtils.throwIf(size > 20, ErrorCode.PARAMS_ERROR);
    // ç©ºé—´æƒé™æ ¡éªŒ
    Long spaceId = pictureQueryRequest.getSpaceId();
    // å…¬å¼€å›¾åº“
    if (spaceId == null) {
        // æ™®é€šç”¨æˆ·é»˜è®¤åªèƒ½æŸ¥çœ‹å·²è¿‡å®¡çš„å…¬å¼€æ•°æ®
        pictureQueryRequest.setReviewStatus(PictureReviewStatusEnum.PASS.getValue());
        pictureQueryRequest.setNullSpaceId(true);
    } else {
        boolean hasPermission = StpKit.SPACE.hasPermission(SpaceUserPermissionConstant.PICTURE_VIEW);
        ThrowUtils.throwIf(!hasPermission, ErrorCode.NO_AUTH_ERROR);
    }
    // æŸ¥è¯¢æ•°æ®åº“
    Page<Picture> picturePage = pictureService.page(new Page<>(current, size), pictureService.getQueryWrapper(pictureQueryRequest));
    // è·å–å°è£…ç±»
    return ResultUtils.success(pictureService.getPictureVOPage(picturePage, request));
}
```

#### 7ã€å…¨å±€å¼‚å¸¸å¤„ç†

å¦‚æœ Sa-Token æ ¡éªŒç”¨æˆ·æ²¡æœ‰ç¬¦åˆè¦æ±‚çš„æƒé™ã€æˆ–è€…ç”¨æˆ·æœªç™»å½•ï¼Œå°±ä¼šæŠ›å‡ºå®ƒå®šä¹‰çš„å¼‚å¸¸ï¼Œ[å‚è€ƒæ–‡æ¡£](https://sa-token.cc/doc.html#/fun/exception-code?id=è·å–å¼‚å¸¸ç»†åˆ†çŠ¶æ€ç )ã€‚

éœ€è¦å°†æ¡†æ¶çš„å¼‚å¸¸å…¨å±€å¤„ç†ä¸ºæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ä¸šåŠ¡å¼‚å¸¸ï¼Œåœ¨å…¨å±€å¼‚å¸¸å¤„ç†å™¨ä¸­æ·»åŠ ä»£ç ï¼š

```java
@ExceptionHandler(NotLoginException.class)
public BaseResponse<?> notLoginException(NotLoginException e) {
    log.error("NotLoginException", e);
    return ResultUtils.error(ErrorCode.NOT_LOGIN_ERROR, e.getMessage());
}

@ExceptionHandler(NotPermissionException.class)
public BaseResponse<?> notPermissionExceptionHandler(NotPermissionException e) {
    log.error("NotPermissionException", e);
    return ResultUtils.error(ErrorCode.NO_AUTH_ERROR, e.getMessage());
}
```

#### 8ã€è¡¥å……è·å–æƒé™çš„æ¥å£

å‰é¢å†™çš„éƒ½æ˜¯åç«¯æƒé™æ ¡éªŒçš„ä»£ç ï¼Œä½†å¯¹äºç”¨æˆ·æ¥è¯´ï¼Œå¦‚æœæ²¡æœ‰ç©ºé—´å›¾ç‰‡çš„ç¼–è¾‘æƒé™ï¼Œè¿›å…¥ç©ºé—´è¯¦æƒ…é¡µæ—¶ä¸åº”è¯¥èƒ½çœ‹åˆ°ç¼–è¾‘æŒ‰é’®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå‰ç«¯ä¹Ÿéœ€è¦æ ¹æ®ç”¨æˆ·çš„æƒé™æ¥è¿›è¡Œä¸€äº›é¡µé¢å†…å®¹çš„å±•ç¤ºå’Œéšè—ã€‚

å› æ­¤ï¼Œåç«¯éœ€è¦å°†ç”¨æˆ·å…·æœ‰çš„æƒé™è¿”å›ç»™å‰ç«¯ï¼Œå¸®åŠ©å‰ç«¯è¿›è¡Œåˆ¤æ–­ï¼Œè¿™æ ·å°±ä¸ç”¨è®©å‰ç«¯ç¼–å†™å¤æ‚çš„è§’è‰²å’Œæƒé™æ ¡éªŒé€»è¾‘äº†ã€‚

æ€è€ƒä¸‹å…·ä½“çš„ä½¿ç”¨åœºæ™¯ï¼šå¦‚æœæ˜¯å›¢é˜Ÿç©ºé—´ï¼ˆç©ºé—´è¯¦æƒ…é¡µï¼‰æˆ–å›¢é˜Ÿç©ºé—´çš„å›¾ç‰‡ï¼ˆå›¾ç‰‡è¯¦æƒ…é¡µï¼‰ï¼Œè¿”å›ç»™å‰ç«¯ç”¨æˆ·å…·æœ‰çš„æƒé™ï¼ˆæ¯”å¦‚èƒ½å¦ç¼–è¾‘ã€èƒ½å¦ä¸Šä¼ ã€èƒ½å¦åˆ é™¤ã€èƒ½å¦ç®¡ç†æˆå‘˜ï¼‰ã€‚4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=J+5o58b0kn/bTqd/50F76o1L2/PhqvQWrl14ca26WW0=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=

1ï¼‰æ¯”èµ·æ–°å†™ä¸€ä¸ªè·å–æƒé™çš„æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨è¿”å›å›¾ç‰‡æˆ–ç©ºé—´è¯¦æƒ…æ—¶ï¼Œé¢å¤–ä¼ é€’æƒé™åˆ—è¡¨ã€‚ç»™ SpaceVO å’Œ PictureVO æ–°å¢æƒé™åˆ—è¡¨å­—æ®µï¼š

```java
/**
 * æƒé™åˆ—è¡¨
 */
private List<String> permissionList = new ArrayList<>();
```

2ï¼‰åœ¨ SpaceUserAuthManager ä¸­æ–°å¢è·å–æƒé™åˆ—è¡¨çš„æ–¹æ³•ï¼Œæ³¨æ„è¦åŒºåˆ†å…¬å…±å›¾åº“ã€ç§æœ‰ç©ºé—´å’Œå›¢é˜Ÿç©ºé—´ï¼Œå¯¹äºæœ‰æƒé™çš„æƒ…å†µï¼Œå¯ä»¥è¿”å› â€œç®¡ç†å‘˜æƒé™â€ åˆ—è¡¨ã€‚

```java
public List<String> getPermissionList(Space space, User loginUser) {
    if (loginUser == null) {
        return new ArrayList<>();
    }
    // ç®¡ç†å‘˜æƒé™
    List<String> ADMIN_PERMISSIONS = getPermissionsByRole(SpaceRoleEnum.ADMIN.getValue());
    // å…¬å…±å›¾åº“
    if (space == null) {
        if (userService.isAdmin(loginUser)) {
            return ADMIN_PERMISSIONS;
        }
        return new ArrayList<>();
    }
    SpaceTypeEnum spaceTypeEnum = SpaceTypeEnum.getEnumByValue(space.getSpaceType());
    if (spaceTypeEnum == null) {
        return new ArrayList<>();
    }
    // æ ¹æ®ç©ºé—´è·å–å¯¹åº”çš„æƒé™
    switch (spaceTypeEnum) {
        case PRIVATE:
            // ç§æœ‰ç©ºé—´ï¼Œä»…æœ¬äººæˆ–ç®¡ç†å‘˜æœ‰æ‰€æœ‰æƒé™
            if (space.getUserId().equals(loginUser.getId()) || userService.isAdmin(loginUser)) {
                return ADMIN_PERMISSIONS;
            } else {
                return new ArrayList<>();
            }
        case TEAM:
            // å›¢é˜Ÿç©ºé—´ï¼ŒæŸ¥è¯¢ SpaceUser å¹¶è·å–è§’è‰²å’Œæƒé™
            SpaceUser spaceUser = spaceUserService.lambdaQuery()
                    .eq(SpaceUser::getSpaceId, space.getId())
                    .eq(SpaceUser::getUserId, loginUser.getId())
                    .one();
            if (spaceUser == null) {
                return new ArrayList<>();
            } else {
                return getPermissionsByRole(spaceUser.getSpaceRole());
            }
    }
    return new ArrayList<>();
}
```

3ï¼‰ä¿®æ”¹è·å–ç©ºé—´è¯¦æƒ…å’Œå›¾ç‰‡è¯¦æƒ…çš„æ¥å£ getSpaceVOByIdã€getPictureVOByIdï¼Œå¢åŠ è·å–æƒé™åˆ—è¡¨çš„é€»è¾‘ã€‚

è·å–ç©ºé—´è¯¦æƒ…æ¥å£ï¼šJ+5o58b0kn/bTqd/50F76o1L2/PhqvQWrl14ca26WW0=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=58IUDBvyDy7G+gVMqAunJfAo72ZBX//2DD/nhaX54Xg=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=J+5o58b0kn/bTqd/50F76o1L2/PhqvQWrl14ca26WW0=J+5o58b0kn/bTqd/50F76o1L2/PhqvQWrl14ca26WW0=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=

```java
@GetMapping("/get/vo")
public BaseResponse<SpaceVO> getSpaceVOById(long id, HttpServletRequest request) {
    ThrowUtils.throwIf(id <= 0, ErrorCode.PARAMS_ERROR);
    // æŸ¥è¯¢æ•°æ®åº“
    Space space = spaceService.getById(id);
    ThrowUtils.throwIf(space == null, ErrorCode.NOT_FOUND_ERROR);
    SpaceVO spaceVO = spaceService.getSpaceVO(space, request);
    User loginUser = userService.getLoginUser(request);
    List<String> permissionList = spaceUserAuthManager.getPermissionList(space, loginUser);
    spaceVO.setPermissionList(permissionList);
    // è·å–å°è£…ç±»
    return ResultUtils.success(spaceVO);
}
```

è·å–å›¾ç‰‡è¯¦æƒ…æ¥å£ï¼Œæ³¨æ„å³ä½¿ç©ºé—´ id ä¸å­˜åœ¨ï¼ˆå…¬å…±å›¾åº“ï¼‰ä¹Ÿè¦è·å–æƒé™åˆ—è¡¨ï¼Œç®¡ç†å‘˜ä¼šè·å–åˆ°å…¨éƒ¨æƒé™ï¼Œè¿™æ ·å‰ç«¯æ‰èƒ½é¡ºåˆ©å±•ç¤ºå‡ºæ“ä½œæŒ‰é’®ï¼š

```java
@GetMapping("/get/vo")
public BaseResponse<PictureVO> getPictureVOById(long id, HttpServletRequest request) {
    ThrowUtils.throwIf(id <= 0, ErrorCode.PARAMS_ERROR);
    // æŸ¥è¯¢æ•°æ®åº“
    Picture picture = pictureService.getById(id);
    ThrowUtils.throwIf(picture == null, ErrorCode.NOT_FOUND_ERROR);
    // ç©ºé—´çš„å›¾ç‰‡ï¼Œéœ€è¦æ ¡éªŒæƒé™
    Space space = null;
    Long spaceId = picture.getSpaceId();
    if (spaceId != null) {
        boolean hasPermission = StpKit.SPACE.hasPermission(SpaceUserPermissionConstant.PICTURE_VIEW);
        ThrowUtils.throwIf(!hasPermission, ErrorCode.NO_AUTH_ERROR);
        space = spaceService.getById(spaceId);
        ThrowUtils.throwIf(space == null, ErrorCode.NOT_FOUND_ERROR, "ç©ºé—´ä¸å­˜åœ¨");
    }
    // è·å–æƒé™åˆ—è¡¨
    User loginUser = userService.getLoginUser(request);
    List<String> permissionList = spaceUserAuthManager.getPermissionList(space, loginUser);
    PictureVO pictureVO = pictureService.getPictureVO(picture, request);
    pictureVO.setPermissionList(permissionList);
    // è·å–å°è£…ç±»
    return ResultUtils.success(pictureVO);
}
```

#### 9ã€æ¥å£æµ‹è¯•

ç»ˆäºå¼€å‘å®Œäº†ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œç»†èŠ‚å®åœ¨æ˜¯å¤ªå¤šäº†ï¼Œæ‰€ä»¥ **ä¸€å®šè¦è¿›è¡Œä¸¥æ ¼çš„æµ‹è¯•ï¼ï¼ï¼**

ç”¨ä¸åŒæƒé™çš„ç”¨æˆ·å»éªŒè¯ä¸åŒçš„ç©ºé—´ç±»åˆ«ï¼ˆå…¬å…±å›¾åº“ã€ç§æœ‰ç©ºé—´ã€å›¢é˜Ÿç©ºé—´ï¼‰ã€‚

å¦‚ä½•æµ‹è¯•å‘¢ï¼Ÿ

å¤§å®¶ç”¨çš„æ¯”è¾ƒå¤šçš„å°±æ˜¯å•å…ƒæµ‹è¯•ï¼Œä½†æ˜¯å•å…ƒæµ‹è¯•æƒ³è¦æµ‹è¯•æºå¸¦ç™»å½•æ€çš„ Controller æ¥å£æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é‡‡ç”¨è‡ªåŠ¨åŒ–æ¥å£æµ‹è¯•ï¼Œæ¯”å¦‚ Postman ç­‰ã€‚

æ­¤å¤„ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ IDEA è‡ªå¸¦çš„ REST API æµ‹è¯•ï¼Œå¯ä»¥å°†æµ‹è¯•å‚æ•°å’Œæµ‹è¯•æ¥å£ä¿å­˜ä¸ºæ–‡ä»¶ï¼Œæ¯æ¬¡ä¿®æ”¹ä»£ç åï¼Œæ”¹æ”¹å‚æ•°ï¼Œæ‰§è¡Œæ–‡ä»¶å°±èƒ½æ•´ä½“æµ‹è¯•äº†ã€‚

![img](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221432490.webp)

ç”±äºè¦æµ‹è¯•çš„æƒ…å†µè¾ƒå¤šï¼Œå‡†å¤‡å¥½äº†æµ‹è¯•ä»£ç ï¼Œç›´æ¥ä¸‹è½½ä½¿ç”¨å³å¯ï¼š[ğŸ“httpTest.zip](https://yuyuanweb.yuque.com/attachments/yuque/0/2024/zip/398476/1735475537929-926babdb-fe15-4718-a4bf-8cb1751ed754.zip)

è‡³æ­¤ï¼Œç©ºé—´æˆå‘˜æƒé™æ§åˆ¶å¼€å‘å®Œæˆï¼Œå¤§å®¶ä¼šå‘ç°è¿˜æ˜¯æŒºéº»çƒ¦çš„ã€‚å…¶å®å¦‚æœæ²¡æœ‰å…¬å…±å›¾åº“çš„æ¦‚å¿µçš„è¯ï¼Œå¼€å‘èµ·æ¥å°±è½»æ¾å¾ˆå¤šã€‚å› æ­¤ Sa-Token ç­‰æƒé™æ¡†æ¶è¦æŒ‰éœ€ä½¿ç”¨ï¼Œæ›´é€‚åˆå¤æ‚çš„ã€ä¼ä¸šå†…éƒ¨çš„æƒé™ç®¡ç†ç³»ç»Ÿã€‚

å¦‚æœä½ æƒ³å¼€å‘èµ·æ¥æ›´è½»æ¾ä¸€äº›ï¼Œæ¨èå…¶ä»–çš„å®ç°æ–¹å¼ï¼š

1. ç›´æ¥å°è£…æƒé™æ ¡éªŒæ–¹æ³•ï¼Œåœ¨ä¸šåŠ¡ä»£ç ä¸­è°ƒç”¨
2. å°†å›¢é˜Ÿç©ºé—´å›¾ç‰‡çš„å¢åˆ æ”¹æŸ¥æå–ä¸ºç‹¬ç«‹çš„æ¥å£ï¼Œå•ç‹¬è¿›è¡Œæƒé™æ ¡éªŒï¼Œä¸å½±å“å…¬å…±å›¾åº“

#### æ‰©å±•

1ï¼‰å¯ä»¥ç»™ç©ºé—´æ“ä½œï¼ˆSpaceControllerï¼‰ã€ç©ºé—´åˆ†ææ“ä½œï¼ˆSpaceAnalyzeControllerï¼‰å¢åŠ ç»Ÿä¸€çš„æƒé™æ ¡éªŒ

### ç©ºé—´æ•°æ®ç®¡ç†

æ ¹æ®éœ€æ±‚å’Œæ–¹æ¡ˆè®¾è®¡ï¼Œæˆ‘ä»¬è¦å°†æ——èˆ°ç‰ˆå›¢é˜Ÿç©ºé—´çš„å›¾ç‰‡æ•°æ®è¿›è¡Œå•ç‹¬ç®¡ç†ï¼Œæ¯ä¸ªå›¢é˜Ÿç©ºé—´çš„å›¾ç‰‡æ•°æ®å­˜å‚¨åˆ°ä¸€å¼ å•ç‹¬çš„è¡¨ä¸­ï¼Œä¹Ÿå°±æ˜¯ **åˆ†è¡¨**ã€‚

#### 1ã€ä»€ä¹ˆæ˜¯åˆ†åº“åˆ†è¡¨ï¼Ÿ

åˆ†åº“åˆ†è¡¨æ˜¯ä¸€ç§å°†æ•°æ®æ‹†åˆ†åˆ°å¤šä¸ªæ•°æ®åº“æˆ–æ•°æ®è¡¨ä¸­çš„è®¾è®¡ç­–ç•¥ï¼Œä¸»è¦ç”¨äºè§£å†³éšç€ä¸šåŠ¡æ•°æ®é‡å’Œè®¿é—®é‡å¢é•¿å¸¦æ¥çš„æ•°æ®åº“æ€§èƒ½é—®é¢˜ã€‚LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=3n/Enp4sfaVRq/PFMJKPxPdBTxeNas/Bp33wsl/l9Wg=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=

é€šè¿‡åˆ†åº“åˆ†è¡¨ï¼Œå¯ä»¥å‡å°å•åº“æˆ–å•è¡¨çš„æ•°æ®é‡å’Œè®¿é—®å‹åŠ›ï¼Œä»è€Œæé«˜æŸ¥è¯¢å’Œå†™å…¥æ•ˆç‡ã€å¢å¼ºç³»ç»Ÿçš„é«˜å¹¶å‘èƒ½åŠ›ã€ä¼˜åŒ–å¤§æ•°æ®é‡ä¸‹çš„æ€§èƒ½è¡¨ç°ï¼›åŒæ—¶é™ä½å•ç‚¹æ•…éšœé£é™©ï¼Œå®ç°æ›´å¥½çš„ç³»ç»Ÿæ‰©å±•æ€§å’Œå®¹ç¾èƒ½åŠ›ã€‚

#### 2ã€åˆ†åº“åˆ†è¡¨å®ç°

å¦‚æœè®©æˆ‘ä»¬è‡ªå·±å®ç°åˆ†åº“åˆ†è¡¨ï¼Œåº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=

æ€è·¯ä¸»è¦æ˜¯åŸºäºä¸šåŠ¡éœ€æ±‚è®¾è®¡ **æ•°æ®åˆ†ç‰‡è§„åˆ™**ï¼Œå°†æ•°æ®æŒ‰ä¸€å®šç­–ç•¥ï¼ˆå¦‚å–æ¨¡ã€å“ˆå¸Œã€èŒƒå›´æˆ–æ—¶é—´ï¼‰åˆ†æ•£å­˜å‚¨åˆ°å¤šä¸ªåº“æˆ–è¡¨ä¸­ï¼ŒåŒæ—¶å¼€å‘è·¯ç”±é€»è¾‘æ¥å†³å®šæŸ¥è¯¢æˆ–å†™å…¥æ“ä½œçš„ç›®æ ‡åº“è¡¨ã€‚

![img](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221432452.webp)

ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å°†æ•°æ®å†™åˆ°ä¸åŒçš„è¡¨ã€å¹¶ä¸”ä»ç›¸åŒçš„è¡¨è¯»å–æ•°æ®ï¼Œå…¶å®é€šè¿‡ç»™ SQL è¡¨åæ‹¼æ¥åŠ¨æ€å‚æ•°å°±èƒ½å®ç°ï¼š

```sql
select * from table_${åˆ†ç‰‡å”¯ä¸€æ ‡è¯†}
```

ä½†è¿™åªæ˜¯æœ€ç®€å•çš„æƒ…å†µï¼Œå®é™…ä¸Šï¼Œåˆ†åº“åˆ†è¡¨è¿˜æ¶‰åŠè·¨åº“è¡¨æŸ¥è¯¢ã€äº‹åŠ¡ä¸€è‡´æ€§ã€åˆ†é¡µèšåˆç­‰å¤æ‚åœºæ™¯ï¼Œè¿˜å¯èƒ½éœ€è¦é…å¥—è®¾è®¡ç›‘æ§ã€æ‰©å®¹å’Œè¿ç§»æ–¹æ¡ˆä»¥ç¡®ä¿ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚

æ‰€ä»¥ï¼Œä¸å»ºè®®è‡ªå·±å®ç°åˆ†åº“åˆ†è¡¨ã€‚æœ¬é¡¹ç›®ä¸­ï¼Œé±¼çš®å°†ä½¿ç”¨ä¸»æµçš„åˆ†åº“åˆ†è¡¨æ¡†æ¶ [Apache ShardingSphere](https://shardingsphere.apache.org/) å¸¦å¤§å®¶å®ç°ã€‚LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=

#### 3ã€ShardingSphere åˆ†åº“åˆ†è¡¨

Apache ShardingSphere æä¾›äº†å¼€ç®±å³ç”¨çš„åˆ†ç‰‡ç­–ç•¥ã€çµæ´»çš„é…ç½®èƒ½åŠ›ä»¥åŠå¯¹è·¨åº“æŸ¥è¯¢ã€äº‹åŠ¡ä¸€è‡´æ€§ã€è¯»å†™åˆ†ç¦»ç­‰å¤æ‚åŠŸèƒ½çš„å…¨é¢æ”¯æŒã€‚

å®ƒåˆåˆ†ä¸º 2 å¤§æ ¸å¿ƒæ¨¡å— ShardingSphere-JDBC å’Œ ShardingSphere-Proxyï¼Œæˆ‘ç”¨ä¸€å¼ è¡¨æ ¼æ¥åˆ—ä¸¾ 2 è€…çš„åŒºåˆ«ï¼š

| ç»´åº¦     | ShardingSphere JDBC                | ShardingSphere Proxy                 |
| -------- | ---------------------------------- | ------------------------------------ |
| è¿è¡Œæ–¹å¼ | åµŒå…¥å¼è¿è¡Œåœ¨åº”ç”¨å†…éƒ¨               | ç‹¬ç«‹ä»£ç†ï¼Œè¿è¡Œåœ¨åº”ç”¨ä¸æ•°æ®åº“ä¹‹é—´     |
| æ€§èƒ½     | ä½ç½‘ç»œå¼€é”€ï¼Œæ€§èƒ½è¾ƒé«˜               | å¼•å…¥ç½‘ç»œå¼€é”€ï¼Œæ€§èƒ½ç•¥ä½               |
| æ”¯æŒè¯­è¨€ | ä»…æ”¯æŒ Java                        | æ”¯æŒå¤šè¯­è¨€ï¼ˆJavaã€Pythonã€Go ç­‰ï¼‰    |
| é…ç½®ç®¡ç† | åˆ†å¸ƒå¼é…ç½®è¾ƒå¤æ‚                   | æ”¯æŒé›†ä¸­é…ç½®å’ŒåŠ¨æ€ç®¡ç†               |
| æ‰©å±•æ€§   | éšç€åº”ç”¨æ‰©å±•ï¼Œéœ€å•ç‹¬è°ƒæ•´é…ç½®       | ä»£ç†æœåŠ¡é›†ä¸­åŒ–ç®¡ç†ï¼Œæ‰©å±•æ€§å¼ºã€å¤šè¯­è¨€ |
| é€‚ç”¨åœºæ™¯ | å•ä½“æˆ–å°å‹ç³»ç»Ÿï¼Œå¯¹æ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯ | å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–éœ€è¦ç»Ÿä¸€ç®¡ç†çš„åœºæ™¯   |

å¯¹å¤§å¤šæ•° Java é¡¹ç›®æ¥è¯´ï¼Œé€‰æ‹© ShardingSphere-JDBC å°±è¶³å¤Ÿäº†ï¼›å¯¹äºè·¨è¯­è¨€çš„å¤§å‹åˆ†å¸ƒå¼é¡¹ç›®ã€æˆ–è€…å…¬å¸å†…æœ‰æŠ€æœ¯éƒ¨é—¨ç»Ÿä¸€ç®¡ç†åŸºç¡€è®¾æ–½çš„æƒ…å†µä¸‹ï¼Œå†è€ƒè™‘ä½¿ç”¨ ShardingSphere-Proxyã€‚

æœ¬é¡¹ç›®ä¹Ÿå°†ä½¿ç”¨ ShardingSphere-JDBCï¼Œåœ¨ä¾èµ–æ–‡ä»¶ä¸­å¼•å…¥ï¼šsh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=

```xml
<!-- åˆ†åº“åˆ†è¡¨ -->
<dependency>
    <groupId>org.apache.shardingsphere</groupId>
    <artifactId>shardingsphere-jdbc-core-spring-boot-starter</artifactId>
    <version>5.2.0</version>
</dependency>
```

#### 4ã€åˆ†åº“åˆ†è¡¨ç­–ç•¥ - é™æ€åˆ†è¡¨

åˆ†åº“åˆ†è¡¨çš„ç­–ç•¥æ€»ä½“åˆ†ä¸º 2 ç±»ï¼šé™æ€åˆ†è¡¨å’ŒåŠ¨æ€åˆ†è¡¨ï¼Œä¸‹é¢å…ˆè®²é™æ€åˆ†è¡¨ã€‚

åœ¨è®¾è®¡é˜¶æ®µï¼Œåˆ†è¡¨çš„æ•°é‡å’Œè§„åˆ™å°±æ˜¯å›ºå®šçš„ï¼Œä¸ä¼šæ ¹æ®ä¸šåŠ¡å¢é•¿åŠ¨æ€è°ƒæ•´ï¼Œæ¯”å¦‚ picture_0ã€picture_1ã€‚

åˆ†ç‰‡è§„åˆ™é€šå¸¸åŸºäºæŸä¸€å­—æ®µï¼ˆå¦‚å›¾ç‰‡ idï¼‰é€šè¿‡ç®€å•è§„åˆ™ï¼ˆå¦‚å–æ¨¡ã€èŒƒå›´ï¼‰æ¥å†³å®šæ•°æ®å­˜å‚¨åœ¨å“ªä¸ªè¡¨æˆ–åº“ä¸­ã€‚

è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹æ˜¯ç®€å•ã€å¥½ç†è§£ï¼›ç¼ºç‚¹æ˜¯ä¸åˆ©äºæ‰©å±•ï¼Œéšç€æ•°æ®é‡å¢é•¿ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨è°ƒæ•´åˆ†è¡¨æ•°é‡å¹¶è¿ç§»æ•°æ®ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå›¾ç‰‡è¡¨æŒ‰å›¾ç‰‡ id å¯¹ 4 å–æ¨¡æ‹†åˆ†ï¼š

```java
String tableName = "picture_" + (pictureId % 4); // picture_0 ~ picture_3
```

é™æ€åˆ†è¡¨çš„å®ç°å¾ˆç®€å•ï¼Œç›´æ¥åœ¨ `application.yml` ä¸­ç¼–å†™ ShardingSphere çš„é…ç½®å°±èƒ½å®Œæˆåˆ†åº“åˆ†è¡¨ï¼Œæ¯”å¦‚ï¼š

```yaml
rules:
  sharding:
    tables:
      picture:
        actualDataNodes: ds0.picture_${0..2} # 3å¼ åˆ†è¡¨ï¼špicture_0, picture_1, picture_2
        tableStrategy:
          standard:
            shardingColumn: pictureId       # æŒ‰ pictureId åˆ†ç‰‡
            shardingAlgorithmName: pictureIdMod
    shardingAlgorithms:
      pictureIdMod:
        type: INLINE
        props:
          algorithm-expression: picture_${pictureId % 3} # åˆ†ç‰‡è¡¨è¾¾å¼
```

ä½ ç”šè‡³ä¸éœ€è¦ä¿®æ”¹ä»»ä½•ä¸šåŠ¡ä»£ç ï¼Œåœ¨æŸ¥è¯¢ picture è¡¨ï¼ˆä¸€èˆ¬å«é€»è¾‘è¡¨ï¼‰æ—¶ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨å¸®ä½ ä¿®æ”¹ SQLï¼Œæ ¹æ® pictureId å°†æŸ¥è¯¢è¯·æ±‚è·¯ç”±åˆ°ä¸åŒçš„è¡¨ä¸­ã€‚å¦‚æœè¦è¿›è¡Œåˆ†é¡µå¤šæ¡æ•°æ®æŸ¥è¯¢ï¼Œä½ åªéœ€è¦å†™ä¸€æ¡æŸ¥è¯¢é€»è¾‘è¡¨çš„ SQL è¯­å¥å³å¯ï¼š

```plain
SELECT * FROM picture;
```

å®é™…ä¸Šï¼ŒShardingSphere å°†æŸ¥è¯¢é€»è¾‘è¡¨ `picture` çš„è¯·æ±‚è‡ªåŠ¨è·¯ç”±åˆ°æ‰€æœ‰å®é™…åˆ†è¡¨ picture_1ã€picture_2 ... picture_Nï¼Œè·å–åˆ°æ•°æ®åï¼Œåœ¨ä¸­é—´ä»¶å±‚è‡ªåŠ¨åˆå¹¶ç»“æœå¹¶è¿”å›ç»™åº”ç”¨ç¨‹åºã€‚

#### **5ã€åˆ†åº“åˆ†è¡¨ç­–ç•¥ - åŠ¨æ€åˆ†è¡¨**

åŠ¨æ€åˆ†è¡¨æ˜¯æŒ‡åˆ†è¡¨çš„æ•°é‡å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚æˆ–æ•°æ®é‡åŠ¨æ€å¢åŠ ï¼Œè¡¨çš„ç»“æ„å’Œè§„åˆ™æ˜¯è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆçš„ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæ ¹æ®æ—¶é—´åŠ¨æ€åˆ›å»º picture_2025_01ã€picture_2025_02ã€‚

```java
String tableName = "picture_" + LocalDate.now().format(
    DateTimeFormatter.ofPattern("yyyy_MM")
);
```

æ˜¾ç„¶ï¼ŒåŠ¨æ€åˆ†è¡¨æ›´çµæ´»ã€æ‰©å±•æ€§å¼ºï¼Œé€‚åˆæ•°æ®é‡å¿«é€Ÿå¢é•¿çš„åœºæ™¯ï¼›ä½†ç¼ºç‚¹æ˜¯å®ç°æ›´å¤æ‚ï¼Œéœ€è¦åŠ¨æ€ç”Ÿæˆè¡¨å¹¶ç»´æŠ¤è¡¨çš„å…ƒä¿¡æ¯ã€‚å¦‚æœæ²¡æœ‰æ§åˆ¶å¥½ï¼Œè¯´ä¸å®šåˆ†è¡¨ç‰¹åˆ«å¤šï¼Œåè€Œå½±å“äº†æ•°æ®åº“çš„æ€§èƒ½ã€‚

åŠ¨æ€åˆ†è¡¨çš„å®ç°å°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œé¦–å…ˆè¦è‡ªå®šä¹‰åˆ†è¡¨ç®—æ³•ç±»ï¼Œè¿˜è¦åœ¨ä»£ç ä¸­ç¼–å†™åŠ¨æ€åˆ›å»ºè¡¨çš„é€»è¾‘ã€‚

è‡ªå®šä¹‰åˆ†è¡¨ç®—æ³•ç±»ï¼š

```java
public class PictureShardingAlgorithm implements StandardShardingAlgorithm<Long> {

    @Override
    public String doSharding(Collection<String> availableTargetNames, PreciseShardingValue<Long> preciseShardingValue) {
        // ç¼–å†™åˆ†è¡¨é€»è¾‘ï¼Œè¿”å›å®é™…è¦æŸ¥è¯¢çš„è¡¨å
        // picture_0 ç‰©ç†è¡¨ï¼Œpicture é€»è¾‘è¡¨
    }

    @Override
    public Collection<String> doSharding(Collection<String> collection, RangeShardingValue<Long> rangeShardingValue) {
        return new ArrayList<>();
    }

    @Override
    public Properties getProps() {
        return null;
    }

    @Override
    public void init(Properties properties) {

    }
}
```

å¯¹äºæˆ‘ä»¬çš„é¡¹ç›®ï¼Œç”±äºç©ºé—´æ˜¯ç”¨æˆ·åŠ¨æ€åˆ›å»ºçš„ï¼Œæ˜¾ç„¶è¦ä½¿ç”¨åŠ¨æ€åˆ†è¡¨ï¼Œä¸‹é¢æ¥å®ç°ã€‚

#### 6ã€åŠ¨æ€åˆ†è¡¨ç®—æ³•å¼€å‘

æ ¹æ®éœ€æ±‚ï¼Œæˆ‘ä»¬å¸Œæœ›å°†æ¯ä¸ªæ——èˆ°ç‰ˆç©ºé—´çš„å›¾ç‰‡å•ç‹¬å­˜æ”¾åœ¨ä¸€èµ·ï¼Œæ˜¾ç„¶æ˜¯æŒ‰ç…§ `spaceId` åˆ†è¡¨ï¼Œé‚£ä¹ˆåˆ†è¡¨çš„åç§°è§„åˆ™ä¸º `picture_${spaceId}`ã€‚

1ï¼‰é¦–å…ˆç¼–å†™åŠ¨æ€åˆ†è¡¨çš„é…ç½®ï¼ŒåŒ…æ‹¬æ•°æ®åº“è¿æ¥ã€åˆ†è¡¨è§„åˆ™ã€åˆ†è¡¨ç®—æ³•ï¼šeSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=3n/Enp4sfaVRq/PFMJKPxPdBTxeNas/Bp33wsl/l9Wg=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=J+5o58b0kn/bTqd/50F76o1L2/PhqvQWrl14ca26WW0=

```yaml
spring:
  # ç©ºé—´å›¾ç‰‡åˆ†è¡¨
  shardingsphere:
    datasource:
      names: yu_picture
      yu_picture:
        type: com.zaxxer.hikari.HikariDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        url: jdbc:mysql://localhost:3306/yu_picture
        username: root
        password: 123456
    rules:
      sharding:
        tables:
          picture:
            actual-data-nodes: yu_picture.picture  # åŠ¨æ€åˆ†è¡¨
            table-strategy:
              standard:
                sharding-column: spaceId
                sharding-algorithm-name: picture_sharding_algorithm  # ä½¿ç”¨è‡ªå®šä¹‰åˆ†ç‰‡ç®—æ³•
        sharding-algorithms:
          picture_sharding_algorithm:
            type: CLASS_BASED
            props:
              strategy: standard
              algorithmClassName: com.yupi.yupicturebackend.manager.sharding.PictureShardingAlgorithm
    props:
      sql-show: true
```

å…¶ä¸­ï¼Œæœ‰å‡ ä¸ªç»†èŠ‚éœ€è¦æ³¨æ„ï¼š

1. `actual-data-nodes` ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯æŒ‡å®šä¸€æ®µåˆ†è¡¨çš„èŒƒå›´ï¼Œæ¯”å¦‚ `yu_picture.picture_${0..9999}` è¡¨ç¤ºæœ‰ picture_0 ~ picture_9999 è¿™ 10000 å¼ åˆ†è¡¨ã€‚ShardingSphere åœ¨æ‰§è¡Œåˆ†è¡¨æŸ¥è¯¢æ—¶ä¼šæ ¡éªŒè¦æŸ¥è¯¢çš„è¡¨ï¼ˆæ¯”å¦‚ picture_123456789ï¼‰æ˜¯å¦åœ¨ actual-data-nodes çš„é…ç½®èŒƒå›´å†…ã€‚ä½†æ˜¯ç”±äº spaceId æ˜¯é•¿æ•´å‹ï¼ŒèŒƒå›´å¤ªå¤§ï¼Œæ— æ³•é€šè¿‡æŒ‡å®šèŒƒå›´å°†æ‰€æœ‰åˆ†è¡¨åç§°åŒ…å«ï¼Œå¯¼è‡´æ— æ³•é€šè¿‡æ¡†æ¶å†…ç½®çš„æ ¡éªŒã€‚æ‰€ä»¥æ­¤å¤„å°† actual-data-nodes çš„å€¼è®¾ç½®ä¸ºé€»è¾‘è¡¨ `yu_picture.picture`ã€‚
2. æŒ‡å®šåˆ†è¡¨å­—æ®µä¸º spaceIdã€åˆ†è¡¨ç®—æ³•ä¸ºè‡ªå®šä¹‰çš„åˆ†ç‰‡ç®—æ³• `picture_sharding_algorithm`ã€‚
3. é…ç½®è‡ªå®šä¹‰åˆ†ç‰‡ç®—æ³•ï¼Œé‡‡ç”¨åŸºäºè‡ªå®šä¹‰ç±»çš„æ–¹å¼å®ç°ï¼Œç®—æ³•çš„ç±»åé…ç½®å¿…é¡»ä¸ºç±»çš„ç»å¯¹è·¯å¾„ã€‚

2ï¼‰ç¼–å†™å›¾ç‰‡åˆ†è¡¨ç®—æ³•ç±»ï¼Œå¿…é¡»å®ç° `StandardShardingAlgorithm` æ¥å£ã€‚æ ¸å¿ƒæ˜¯ç¼–å†™ doSharding æ–¹æ³•ï¼Œæ ¹æ® spaceId è·å–åˆ°å®é™…è¦æŸ¥è¯¢çš„åˆ†è¡¨åï¼Œå¦‚æœ spaceId ä¸å­˜åœ¨åˆ†è¡¨ï¼ˆæ¯”å¦‚æ˜¯ç§æœ‰ç©ºé—´ï¼‰æˆ–è€… spaceId ä¸ºç©ºï¼ˆå…¬å…±å›¾åº“ï¼‰ï¼Œé‚£ä¹ˆå°±ä»åŸè¡¨ï¼ˆé€»è¾‘è¡¨ï¼‰picture æŸ¥è¯¢ã€‚

ä¹‹æ‰€ä»¥è¦åšå…¼å®¹ï¼Œæ˜¯å› ä¸ºè™½ç„¶æˆ‘ä»¬è®¾è®¡ä¸Šåªå¯¹å›¢é˜Ÿç©ºé—´è¿›è¡Œåˆ†åº“åˆ†è¡¨ï¼Œä½†æ˜¯ä¸€æ—¦å¼•å…¥äº†åˆ†åº“åˆ†è¡¨æ¡†æ¶ï¼ŒæŸ¥è¯¢ picture è¡¨æ—¶å°±ä¼šè§¦å‘åˆ†è¡¨é€»è¾‘ã€‚

åœ¨ `manager.sharding` åŒ…ä¸‹æ–°å»ºåˆ†è¡¨ç®—æ³•ç±»ï¼šeSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=58IUDBvyDy7G+gVMqAunJfAo72ZBX//2DD/nhaX54Xg=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=

```java
public class PictureShardingAlgorithm implements StandardShardingAlgorithm<Long> {

    @Override
    public String doSharding(Collection<String> availableTargetNames, PreciseShardingValue<Long> preciseShardingValue) {
        Long spaceId = preciseShardingValue.getValue();
        String logicTableName = preciseShardingValue.getLogicTableName();
        // spaceId ä¸º null è¡¨ç¤ºæŸ¥è¯¢æ‰€æœ‰å›¾ç‰‡
        if (spaceId == null) {
            return logicTableName;
        }
        // æ ¹æ® spaceId åŠ¨æ€ç”Ÿæˆåˆ†è¡¨å
        String realTableName = "picture_" + spaceId;
        if (availableTargetNames.contains(realTableName)) {
            return realTableName;
        } else {
            return logicTableName;
        }
    }

    @Override
    public Collection<String> doSharding(Collection<String> collection, RangeShardingValue<Long> rangeShardingValue) {
        return new ArrayList<>();
    }

    @Override
    public Properties getProps() {
        return null;
    }

    @Override
    public void init(Properties properties) {

    }
}
```

3ï¼‰å…‰æœ‰ä¸Šè¿°ä»£ç è¿˜ä¸èƒ½å®ŒæˆåŠ¨æ€åˆ†è¡¨ï¼Œå› ä¸º availableTargetNamesï¼ˆå¯ç”¨çš„åˆ†è¡¨ï¼‰å§‹ç»ˆä¸ºé€»è¾‘è¡¨å `picture`ï¼åŸå› åœ¨äº ShardingSphere åœ¨åˆ†ç‰‡é€»è¾‘åˆå§‹åŒ–æ—¶é»˜è®¤è·å–çš„æ˜¯é…ç½®çš„ `actual-data-nodes` ä¸­çš„ç›®æ ‡è¡¨åï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å†™çš„å›ºå®šå€¼ã€‚è¿™æ ·è¿˜æ˜¯æ— æ³•é€šè¿‡ ShardingSphere çš„æŸ¥è¯¢æ ¡éªŒï¼Œæˆ‘ä»¬ä¹Ÿæ²¡åŠæ³•åˆ¤æ–­ spaceId æ˜¯å¦è¦åˆ†è¡¨ï¼š

```java
// availableTargetNames å§‹ç»ˆä¸º pictureï¼Œæ— æ³•è¿”å›çœŸå®çš„åˆ†è¡¨
if (availableTargetNames.contains(realTableName)) {
    return realTableName;
} else {
    return logicTableName;
}
```

æ—¢ç„¶æ¡†æ¶è‡ªèº«ä¸æ”¯æŒåŠ¨æ€ç»´æŠ¤åˆ†è¡¨ï¼Œé‚£æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªåˆ†è¡¨ç®¡ç†å™¨ï¼Œè‡ªå·±æ¥ç»´æŠ¤åˆ†è¡¨åˆ—è¡¨ï¼Œå¹¶æ›´æ–°åˆ° ShardingSphere çš„ `actual-data-nodes` é…ç½®ä¸­ã€‚

åœ¨ `manager.sharding` åŒ…ä¸‹æ–°å»ºåˆ†è¡¨ç®¡ç†å™¨ç±»ï¼š

```java
@Component
@Slf4j
public class DynamicShardingManager {

    @Resource
    private DataSource dataSource;

    @Resource
    private SpaceService spaceService;

    private static final String LOGIC_TABLE_NAME = "picture";

    private static final String DATABASE_NAME = "logic_db"; // é…ç½®æ–‡ä»¶ä¸­çš„æ•°æ®åº“åç§°

    @PostConstruct
    public void initialize() {
        log.info("åˆå§‹åŒ–åŠ¨æ€åˆ†è¡¨é…ç½®...");
        updateShardingTableNodes();
    }

    /**
     * è·å–æ‰€æœ‰åŠ¨æ€è¡¨åï¼ŒåŒ…æ‹¬åˆå§‹è¡¨ picture å’Œåˆ†è¡¨ picture_{spaceId}
     */
    private Set<String> fetchAllPictureTableNames() {
        // ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œç›´æ¥å¯¹æ‰€æœ‰å›¢é˜Ÿç©ºé—´åˆ†è¡¨ï¼ˆå®é™…ä¸Šçº¿æ”¹ä¸ºä»…å¯¹æ——èˆ°ç‰ˆç”Ÿæ•ˆï¼‰
        Set<Long> spaceIds = spaceService.lambdaQuery()
                .eq(Space::getSpaceType, SpaceTypeEnum.TEAM.getValue())
                .list()
                .stream()
                .map(Space::getId)
                .collect(Collectors.toSet());
        Set<String> tableNames = spaceIds.stream()
                .map(spaceId -> LOGIC_TABLE_NAME + "_" + spaceId)
                .collect(Collectors.toSet());
        tableNames.add(LOGIC_TABLE_NAME); // æ·»åŠ åˆå§‹é€»è¾‘è¡¨
        return tableNames;
    }

    /**
     * æ›´æ–° ShardingSphere çš„ actual-data-nodes åŠ¨æ€è¡¨åé…ç½®
     */
    private void updateShardingTableNodes() {
        Set<String> tableNames = fetchAllPictureTableNames();
        String newActualDataNodes = tableNames.stream()
                .map(tableName -> "yu_picture." + tableName) // ç¡®ä¿å‰ç¼€åˆæ³•
                .collect(Collectors.joining(","));
        log.info("åŠ¨æ€åˆ†è¡¨ actual-data-nodes é…ç½®: {}", newActualDataNodes);

        ContextManager contextManager = getContextManager();
        ShardingSphereRuleMetaData ruleMetaData = contextManager.getMetaDataContexts()
                .getMetaData()
                .getDatabases()
                .get(DATABASE_NAME)
                .getRuleMetaData();

        Optional<ShardingRule> shardingRule = ruleMetaData.findSingleRule(ShardingRule.class);
        if (shardingRule.isPresent()) {
            ShardingRuleConfiguration ruleConfig = (ShardingRuleConfiguration) shardingRule.get().getConfiguration();
            List<ShardingTableRuleConfiguration> updatedRules = ruleConfig.getTables()
                    .stream()
                    .map(oldTableRule -> {
                        if (LOGIC_TABLE_NAME.equals(oldTableRule.getLogicTable())) {
                            ShardingTableRuleConfiguration newTableRuleConfig = new ShardingTableRuleConfiguration(LOGIC_TABLE_NAME, newActualDataNodes);
                            newTableRuleConfig.setDatabaseShardingStrategy(oldTableRule.getDatabaseShardingStrategy());
                            newTableRuleConfig.setTableShardingStrategy(oldTableRule.getTableShardingStrategy());
                            newTableRuleConfig.setKeyGenerateStrategy(oldTableRule.getKeyGenerateStrategy());
                            newTableRuleConfig.setAuditStrategy(oldTableRule.getAuditStrategy());
                            return newTableRuleConfig;
                        }
                        return oldTableRule;
                    })
                    .collect(Collectors.toList());
            ruleConfig.setTables(updatedRules);
            contextManager.alterRuleConfiguration(DATABASE_NAME, Collections.singleton(ruleConfig));
            contextManager.reloadDatabase(DATABASE_NAME);
            log.info("åŠ¨æ€åˆ†è¡¨è§„åˆ™æ›´æ–°æˆåŠŸï¼");
        } else {
            log.error("æœªæ‰¾åˆ° ShardingSphere çš„åˆ†ç‰‡è§„åˆ™é…ç½®ï¼ŒåŠ¨æ€åˆ†è¡¨æ›´æ–°å¤±è´¥ã€‚");
        }
    }

    /**
     * è·å– ShardingSphere ContextManager
     */
    private ContextManager getContextManager() {
        try (ShardingSphereConnection connection = dataSource.getConnection().unwrap(ShardingSphereConnection.class)) {
            return connection.getContextManager();
        } catch (SQLException e) {
            throw new RuntimeException("è·å– ShardingSphere ContextManager å¤±è´¥", e);
        }
    }
}
```

ä¸Šè¿°ä»£ç è™½ç„¶çœ‹èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œä½†å…¶å®ä¸éš¾ç†è§£ï¼Œä¸»è¦åšäº†è¿™ä¹ˆå‡ ä»¶äº‹ï¼š

1. å°†ç®¡ç†å™¨æ³¨å†Œä¸º Beanï¼Œé€šè¿‡ `@PostConstruct` æ³¨è§£ï¼Œåœ¨ Bean åŠ è½½åè·å–æ‰€æœ‰çš„åˆ†è¡¨å¹¶æ›´æ–°é…ç½®ã€‚
2. ç¼–å†™è·å–åˆ†è¡¨åˆ—è¡¨çš„æ–¹æ³•ï¼Œä»æ•°æ®åº“ä¸­æŸ¥è¯¢ç¬¦åˆè¦æ±‚çš„ç©ºé—´åˆ—è¡¨ï¼Œå†è¡¥å……ä¸Šé€»è¾‘è¡¨ï¼Œå°±å¾—åˆ°äº†å®Œæ•´çš„åˆ†è¡¨åˆ—è¡¨ã€‚
3. æ›´æ–° ShardingSphere çš„ actual-data-nodes åŠ¨æ€è¡¨åé…ç½®ã€‚è·å–åˆ° ShardingSphere çš„ ContextManagerï¼Œæ‰¾åˆ°é…ç½®æ–‡ä»¶ä¸­çš„é‚£æ¡è§„åˆ™è¿›è¡Œæ›´æ–°å³å¯ã€‚

4ï¼‰åŠ¨æ€åˆ›å»ºåˆ†è¡¨

åœ¨åˆ†è¡¨ç®¡ç†å™¨ä¸­æ–°å¢åŠ¨æ€åˆ›å»ºåˆ†è¡¨çš„æ–¹æ³•ï¼Œé€šè¿‡æ‹¼æ¥ SQL çš„æ–¹å¼åˆ›å»ºå‡ºå’Œ picture è¡¨ç»“æ„ä¸€æ ·çš„åˆ†è¡¨ï¼Œåˆ›å»ºæ–°çš„åˆ†è¡¨åè®°å¾—æ›´æ–°åˆ†è¡¨èŠ‚ç‚¹ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
public void createSpacePictureTable(Space space) {
    // åŠ¨æ€åˆ›å»ºåˆ†è¡¨
    // ä»…ä¸ºæ——èˆ°ç‰ˆå›¢é˜Ÿç©ºé—´åˆ›å»ºåˆ†è¡¨
    if (space.getSpaceType() == SpaceTypeEnum.TEAM.getValue() && space.getSpaceLevel() == SpaceLevelEnum.FLAGSHIP.getValue()) {
        Long spaceId = space.getId();
        String tableName = "picture_" + spaceId;
        // åˆ›å»ºæ–°è¡¨
        String createTableSql = "CREATE TABLE " + tableName + " LIKE picture";
        try {
            SqlRunner.db().update(createTableSql);
            // æ›´æ–°åˆ†è¡¨
            updateShardingTableNodes();
        } catch (Exception e) {
            log.error("åˆ›å»ºå›¾ç‰‡ç©ºé—´åˆ†è¡¨å¤±è´¥ï¼Œç©ºé—´ id = {}", space.getId());
        }
    }
}
```

æ³¨æ„ï¼Œæƒ³è¦ä½¿ç”¨ MyBatis Plus çš„ SqlRunnerï¼Œå¿…é¡»è¦å¼€å¯é…ç½®ï¼š

```yaml
mybatis-plus:
  global-config:
    enable-sql-runner: true
```

ç„¶ååœ¨åˆ›å»ºç©ºé—´æ—¶ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ï¼š

```java
// å¦‚æœæ˜¯å›¢é˜Ÿç©ºé—´ï¼Œå…³è”æ–°å¢å›¢é˜Ÿæˆå‘˜è®°å½•
if (SpaceTypeEnum.TEAM.getValue() == spaceAddRequest.getSpaceType()) {
    SpaceUser spaceUser = new SpaceUser();
    spaceUser.setSpaceId(space.getId());
    spaceUser.setUserId(userId);
    spaceUser.setSpaceRole(SpaceRoleEnum.ADMIN.getValue());
    result = spaceUserService.save(spaceUser);
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR, "åˆ›å»ºå›¢é˜Ÿæˆå‘˜è®°å½•å¤±è´¥");
}
// åˆ›å»ºåˆ†è¡¨
dynamicShardingManager.createSpacePictureTable(space);
// è¿”å›æ–°å†™å…¥çš„æ•°æ® id
return space.getId();
```

è‡³æ­¤ï¼ŒåŠ¨æ€åˆ†è¡¨å°±å¼€å‘å®Œæˆäº†ã€‚

ğŸ’¡ å…¶å® ShardingSphere è¿˜æä¾›äº† **hint å¼ºåˆ¶åˆ†è¡¨è·¯ç”±æœºåˆ¶** æ¥å®ç°åŠ¨æ€åˆ†è¡¨ï¼Œå…è®¸åœ¨ä»£ç ä¸­å¼ºåˆ¶æŒ‡å®šå…·ä½“çš„ç‰©ç†è¡¨ï¼Œä»è€Œè§£å†³åŠ¨æ€åˆ†è¡¨é—®é¢˜ã€‚ä½†ç¼ºç‚¹æ˜¯éœ€è¦åœ¨æ¯æ¬¡æŸ¥è¯¢æˆ–è€…æ“ä½œæ•°æ®æ—¶éƒ½æ˜¾å¼è®¾ç½®è¡¨åï¼Œä¼šç»™ä»£ç å¢åŠ å¾ˆå¤šé¢å¤–é€»è¾‘ï¼Œä¸å¤Ÿä¼˜é›…ã€‚æ‰€ä»¥ä¸é‡‡ç”¨ï¼Œå¤§å®¶äº†è§£ä¸€ä¸‹å³å¯ã€‚

#### 7ã€æµ‹è¯•

åˆ†è¡¨æ˜¯ä¸ªå¯¹ç³»ç»Ÿå½±å“å¾ˆå¤§çš„æ“ä½œï¼Œæ‰€ä»¥è¦è¿›è¡Œä¸¥æ ¼çš„æµ‹è¯•ã€‚

å¦‚æœå¯åŠ¨é¡¹ç›®æ—¶å‡ºç°äº†å¾ªç¯ä¾èµ–ï¼š

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221612634.png)

å¯ä»¥æ·»åŠ  Lazy æ³¨è§£è§£å†³ï¼š

```java
@Resource
@Lazy
private DynamicShardingManager dynamicShardingManager;
```

1ï¼‰å•ç‹¬æŸ¥è¯¢æŸä¸ªå›¾ç‰‡ï¼Œä¸æŒ‡å®š spaceId æŸ¥è¯¢æ¡ä»¶æ—¶ï¼Œä¼šè‡ªåŠ¨æŸ¥æ‰€æœ‰çš„ picture è¡¨ï¼š

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221612767.png)

å†å²æ•°æ®ä¼šè‡ªåŠ¨å…¼å®¹ï¼Œåªè¦æŸ¥åˆ°çš„ spaceId æ²¡æœ‰åˆ†è¡¨ï¼Œéƒ½ä¼šæŸ¥åŸæ¥çš„ picture è¡¨ã€‚åªæœ‰æŒ‡å®š spaceId ä¸”å­˜åœ¨åˆ†è¡¨æ—¶ï¼Œæ‰ä¼šæŸ¥è¯¢ç‰¹å®šçš„å•å¼ åˆ†è¡¨ã€‚

2ï¼‰æŸ¥è¯¢å›¾ç‰‡åˆ—è¡¨ï¼Œä¸æŒ‡å®š spaceId æˆ– nullSpaceIdï¼ˆæŸ¥è¯¢ spaceId ä¸º null çš„å€¼ï¼‰æ—¶ï¼Œä¼šè‡ªåŠ¨æŸ¥æ‰€æœ‰çš„ picture è¡¨ã€‚æ‰€ä»¥æŸ¥è¯¢æ—¶é—´ä¼šéšç€åˆ†è¡¨æ•°å¢åŠ ï¼š

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221612506.png)

3ï¼‰æµ‹è¯•æ•°æ®æ’å…¥ã€‚æ’å…¥æ—¶å¦‚æœæƒ³å¾€å…¬å…±ç©ºé—´æ’å…¥ï¼ˆä¸æŒ‡å®š spaceIdï¼‰ï¼Œå°±ä¼šæŠ¥é”™ï¼Œå› ä¸º ShardingSphere ä¸çŸ¥é“è¦æŠŠæ•°æ®æ’å…¥åˆ°å“ªä¸ªè¡¨ä¸­ã€‚

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221613615.png)

**è¿™å°±æ„å‘³ç€ï¼Œå¦‚æœä½ è¦ä½¿ç”¨åˆ†è¡¨ï¼ŒspaceId å¿…é¡»ä¸èƒ½ä¸º nullï¼**

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ’å…¥æ—¶ä¸€å®šè¦æŒ‡å®š spaceIdï¼Œå¯ä»¥çº¦å®šå…¬å…±ç©ºé—´çš„ spaceId éƒ½ä¸º 0ï¼Œå¹¶ä¸”åœ¨æ’å…¥æ—¶ä¸º spaceId è®¾ç½®é»˜è®¤å€¼ 0ã€‚

```java
// è¡¥å……ç©ºé—´ idï¼Œé»˜è®¤ä¸º 0
if (spaceId == null) {
    picture.setSpaceId(0L);
}
```

**æ³¨æ„ï¼Œå¢åˆ æ”¹æŸ¥æ—¶éƒ½è¦è¡¥å…… spaceIdï¼Œæ‰èƒ½é¿å…æŠ¥é”™å’Œå¤šè¡¨æŸ¥è¯¢å½±å“æ•ˆç‡ã€‚**

æ¯”å¦‚æŸ¥è¯¢å•ä¸ªå›¾ç‰‡ï¼Œæ”¹ä¸ºé€šè¿‡ QueryWrapper æŒ‡å®š spaceId æŸ¥è¯¢ï¼š

```java
// æ„é€  QueryWrapper
QueryWrapper<Picture> queryWrapper = new QueryWrapper<>();
queryWrapper.eq("id", id)         // æ ¹æ®ä¸»é”® id æŸ¥è¯¢
            .eq("spaceId", spaceId); // é™„åŠ  spaceId æ¡ä»¶

// æ‰§è¡ŒæŸ¥è¯¢
Picture picture = pictureService.getOne(queryWrapper);
```

æ„é€ å›¾ç‰‡åˆ†é¡µæŸ¥è¯¢æ¡ä»¶æ—¶ï¼Œå¦‚æœæŸ¥è¯¢å…¬å…±å›¾åº“ï¼ŒspaceId æ”¹ä¸º 0ï¼š

```java
â–¼javaå¤åˆ¶ä»£ç queryWrapper.eq(nullSpaceId, "spaceId", 0);
// queryWrapper.isNull(nullSpaceId, "spaceId");
```

æ›´æ–° / æ‰¹é‡æ›´æ–°å›¾ç‰‡æ—¶ï¼Œè®¾ç½® spaceId ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ï¼š

```java
// æ„é€  UpdateWrapper
UpdateWrapper<Picture> updateWrapper = new UpdateWrapper<>();
updateWrapper.eq("id", picture.getId()) // æŒ‡å®šä¸»é”®æ¡ä»¶ï¼Œæ‰¹é‡æ›´æ–°åˆ™ä½¿ç”¨ in ä¼ é€’å¤šæ¡
             .eq("spaceId", xxx);      // è¡¥å……æ¡ä»¶ spaceId=xxx

// æ‰§è¡Œæ›´æ–°
boolean result = pictureService.update(picture, updateWrapper);
```

åˆ é™¤å›¾ç‰‡æ—¶ï¼Œè®¾ç½® spaceId ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ï¼š

```java
// æ„é€  QueryWrapper
QueryWrapper<Picture> queryWrapper = new QueryWrapper<>();
queryWrapper.eq("id", id)         // æŒ‡å®šä¸»é”® ID
            .eq("spaceId", spaceId); // é™„åŠ  spaceId æ¡ä»¶

// æ‰§è¡Œåˆ é™¤
boolean result = pictureService.remove(queryWrapper);
```

**æ³¨æ„ï¼Œåˆ†è¡¨åï¼Œpicture çš„ spaceId å°†ä¸èƒ½ä¿®æ”¹ï¼ï¼ï¼**

ç»è¿‡å¼€å‘å’Œæµ‹è¯•ï¼Œä½ ä¼šå‘ç°åŠ¨æ€åˆ†åº“åˆ†è¡¨çš„å®ç°éå¸¸éº»çƒ¦ã€‚æŸäº›å•è¡¨çš„æŸ¥è¯¢æ€§èƒ½æ˜¯é«˜äº†ï¼Œä½†æ•´ä½“æŸ¥è¯¢çš„æ€§èƒ½å¯èƒ½ä¼šå‡å°‘ï¼Œæ‰€ä»¥åŸåˆ™ä¸Š **éå¿…è¦ä¸åˆ†è¡¨**ï¼Œä¸€å®šè¦æ‰¾åˆ°åˆé€‚çš„åº”ç”¨åœºæ™¯ã€‚

è€ƒè™‘åˆ°è®©æ›´å¤šåŒå­¦åç»­ç›´æ¥éƒ¨ç½²é¡¹ç›®ï¼Œé™ä½ç†è§£æˆæœ¬ï¼Œæ•™ç¨‹ä¸­å°±ä¸å¸¦å¤§å®¶å®é™…æ‰§è¡Œä¸Šè¿°æ”¹é€ ç»†èŠ‚äº†ï¼Œå¹¶ä¸”æˆ‘å†æ•™å¤§å®¶ä¸€ç§å¯ä»¥å…³é—­åˆ†åº“åˆ†è¡¨çš„æ–¹æ³•ã€‚

#### 8ã€å…³é—­åˆ†åº“åˆ†è¡¨ï¼ˆå¯é€‰ï¼‰

1ï¼‰å¯åŠ¨ç±»æ’é™¤ä¾èµ–ï¼ˆé…ç½®æ–‡ä»¶å¯ä»¥ä¸æ³¨é‡Šï¼‰ï¼š

```java
@SpringBootApplication(exclude = {ShardingSphereAutoConfiguration.class})
```

2ï¼‰æ³¨é‡Šæ‰åˆ†åº“åˆ†è¡¨ç®¡ç†å™¨ç»„ä»¶ DynamicShardingManagerï¼š

![img](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221432273.webp)

3ï¼‰æ³¨é‡Šæ‰ä½¿ç”¨ DynamicShardingManager æ–¹æ³•çš„ä»£ç ï¼Œæ¯”å¦‚ç©ºé—´æœåŠ¡ä¸­å¯¹å…¶çš„å¼•ç”¨ã€åˆ›å»ºåˆ†è¡¨çš„ä»£ç ï¼š

```java
// @Resource
// @Lazy
// private DynamicShardingManager dynamicShardingManager;

// åˆ›å»ºåˆ†è¡¨
// dynamicShardingManager.createSpacePictureTable(space);
```

#### å‚è€ƒæ–‡ç« 

- å…³äºåŠ¨æ€æ›´æ–° actual-data-nodesï¼šhttps://www.yuque.com/linghengqian/meve2v/cgi5en
- ç›¸å…³ issueï¼šhttps://github.com/apache/shardingsphere/issues/21503
- å¼€æºç¤¾åŒºçš„è®¨è®ºï¼šhttps://github.com/apache/shardingsphere/discussions/12258#discussioncomment-3917927