---
order: 5
author: 
title: "åˆ†å¸ƒå¼äº‹åŠ¡+åˆ†å¸ƒå¼é”"
category:
  - ç§’æ€
  - é¡¹ç›®

---

## 1 åˆ†å¸ƒå¼é”

### 1.1 é—®é¢˜åˆ†æ

ä¸Šé¢æŠ¢å•è¿‡ç¨‹å®ç°äº†ï¼Œä½†å…¶å®è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œä¼šå‘ç”Ÿè¶…å–é—®é¢˜ï¼Œå¦‚ä¸‹å›¾ï¼š

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503050002204.png)

â€‹        åœ¨å¤šçº¿ç¨‹æ‰§è¡Œçš„æƒ…å†µä¸‹ï¼Œä¸Šé¢çš„æŠ¢å•æµç¨‹ä¼šå‘ç”Ÿè¶…å–é—®é¢˜ï¼Œæ¯”å¦‚åªå‰©ä¸‹1ä¸ªå•†å“ï¼Œå¤šçº¿ç¨‹åŒæ—¶åˆ¤æ–­æ˜¯å¦æœ‰åº“å­˜çš„æ—¶å€™ï¼Œä¼šåŒæ—¶åˆ¤æ–­æœ‰åº“å­˜ï¼Œæœ€ç»ˆå¯¼è‡´1ä¸ªå•†å“å¤šä¸ªè®¢å•çš„é—®é¢˜å‘ç”Ÿã€‚

å› ä¸ºåº“å­˜åˆ¤æ–­å’Œå‡åº“å­˜åˆ†æˆäº†ä¸¤æ­¥å»åšï¼Œè¿™ä¸æ˜¯åŸå­æ“ä½œã€‚

ä½†æ˜¯æˆ‘ä»¬ç°åœ¨ä¸æ˜¯ä½¿ç”¨SQLæ“ä½œæ•°æ®åº“ï¼Œæ‰€ä»¥ä¹‹å‰çš„æ“ä½œæ­¥éª¤æ”¾ä¸€å—è¡Œä¸é€šäº†ï¼å°±å¾—ç”¨å…¶ä»–åŠæ³•äº†ï¼

ä¸è¿‡ï¼Œå®é™…å¤„ç†çš„æ—¶å€™ï¼Œmysqlå’Œredisä¼šæœ‰æ‰€ä¸åŒã€‚

### 1.2 redissonåˆ†å¸ƒå¼é”

#### 1.2.1 åˆ†å¸ƒå¼é”ä»‹ç»

â€‹        è§£å†³ä¸Šé¢è¶…å–é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨åˆ†å¸ƒå¼é”æ¥æ§åˆ¶ï¼Œåˆ†å¸ƒå¼é”çš„åŸç†å¾ˆç®€å•ã€‚

â€‹        åˆ†å¸ƒå¼é”ä¸»è¦æ˜¯å®ç°åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚åœ¨å•è¿›ç¨‹çš„ç³»ç»Ÿä¸­ï¼Œå­˜åœ¨å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æ”¹å˜æŸä¸ªå˜é‡ï¼ˆå¯å˜å…±äº«å˜é‡ï¼‰æ—¶ï¼Œå°±éœ€è¦å¯¹å˜é‡æˆ–ä»£ç å—åšåŒæ­¥(lockâ€”synchronized)ï¼Œä½¿å…¶åœ¨ä¿®æ”¹è¿™ç§å˜é‡æ—¶èƒ½å¤Ÿçº¿æ€§æ‰§è¡Œæ¶ˆé™¤å¹¶å‘ä¿®æ”¹å˜é‡ã€‚ä½†åˆ†å¸ƒå¼ç³»ç»Ÿæ˜¯å¤šéƒ¨ç½²ã€å¤šè¿›ç¨‹çš„ï¼Œå¼€å‘è¯­è¨€æä¾›çš„å¹¶å‘å¤„ç†APIåœ¨æ­¤åœºæ™¯ä¸‹å°±æ— èƒ½ä¸ºåŠ›äº†ã€‚

ç›®å‰å¸‚é¢ä¸Šåˆ†å¸ƒå¼é”å¸¸è§çš„å®ç°æ–¹å¼æœ‰ä¸‰ç§ï¼š

```Plaintext
1.åŸºäºæ•°æ®åº“å®ç°åˆ†å¸ƒå¼é”ï¼› 
2.åŸºäºç¼“å­˜ï¼ˆRedisç­‰ï¼‰å®ç°åˆ†å¸ƒå¼é”ï¼ˆæ¨èï¼‰ï¼› 
3.åŸºäºZookeeperå®ç°åˆ†å¸ƒå¼é”ï¼›
```

ä½†æ˜¯redisé›†ç¾¤æœ‰ä¸ªå•¥åå¤„å‘¢ï¼Œå°±æ˜¯ä¸»ä»èŠ‚ç‚¹é—®é¢˜ï¼ˆä¸»æŒ‚äº†ï¼Œä»æ›¿ä»£ï¼‰ï¼Œä¸¤æŠŠé”åŒæ—¶å­˜åœ¨ï¼Œåˆæ€ä¹ˆèƒ½å®ç°æ•°æ®ä¸€è‡´æ€§å‘¢ï¼

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503050057602.png)

#### 1.2.2 Redissonä»‹ç»

â€‹        å¤§éƒ¨åˆ†ç½‘ç«™ä½¿ç”¨çš„åˆ†å¸ƒå¼é”æ˜¯åŸºäºç¼“å­˜çš„ï¼Œæœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œè€Œç¼“å­˜ä¸€èˆ¬æ˜¯ä»¥é›†ç¾¤æ–¹å¼éƒ¨ç½²ï¼Œä¿è¯äº†é«˜å¯ç”¨æ€§ã€‚è€ŒRedisåˆ†å¸ƒå¼é”å®˜æ–¹æ¨èä½¿ç”¨redissonã€‚

RedissonåŸç†å›¾å¦‚ä¸‹ï¼š

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503050002254.png)

**Redissoné”è¯´æ˜ï¼š**

```Plaintext
1ã€redissionè·å–é”é‡Šæ”¾é”çš„ä½¿ç”¨å’ŒJDKé‡Œé¢çš„lockå¾ˆç›¸ä¼¼ï¼Œåº•å±‚çš„å®ç°é‡‡ç”¨äº†ç±»ä¼¼lockçš„å¤„ç†æ–¹å¼
2ã€redisson ä¾èµ–redisï¼Œå› æ­¤ä½¿ç”¨redisson é”éœ€è¦æœåŠ¡ç«¯å®‰è£…redisï¼Œè€Œä¸”redisson æ”¯æŒå•æœºå’Œé›†ç¾¤ä¸¤ç§æ¨¡å¼ä¸‹çš„é”çš„å®ç°
3ã€redisson åœ¨å¤šçº¿ç¨‹æˆ–è€…è¯´æ˜¯åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å®ç°æœºåˆ¶ï¼Œå…¶å®æ˜¯é€šè¿‡è®¾ç½®keyçš„æ–¹å¼è¿›è¡Œå®ç°ï¼Œä¹Ÿå°±æ˜¯è¯´å¤šä¸ªçº¿ç¨‹ä¸ºäº†æŠ¢å åŒä¸€ä¸ªé”ï¼Œå…¶å®å°±æ˜¯äº‰æŠ¢è®¾ç½®keyã€‚
```

å¯é‡å…¥é”ï¼š

ä»»æ„çº¿ç¨‹åœ¨è·å–åˆ°é”ä¹‹åï¼Œå†æ¬¡è·å–è¯¥é”è€Œä¸ä¼šè¢«è¯¥é”æ‰€é˜»å¡

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503051032339.png)

`ReentrantLock`ã€`synchronized`ã€`Redisson`éƒ½æ˜¯å¯é‡å…¥é”ï¼Œä½¿ç”¨`è®¡æ•°å™¨`å®ç°

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503051036998.png)

**RedissonåŸç†ï¼š**

1)åŠ é”æºç ï¼š

```Lua
if (redis.call('exists', KEYS[1]) == 0) then --é”ä¸å­˜åœ¨
        redis.call('hset', KEYS[1], ARGV[2], 1); --è®¾ç½®å€¼è¿›å»ï¼Œkeyæ˜¯é”keyï¼ŒARGVæ˜¯ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œè¡¨ç¤ºç”¨æˆ·è·å–äº†è¿™æŠŠé”ï¼ˆä¾‹å¦‚å®¢æˆ·ç«¯ ID æˆ–çº¿ç¨‹ IDï¼‰
         redis.call('pexpire', KEYS[1], ARGV[1]); 
         return nil;
          end;
if (redis.call('hexists', KEYS[1], ARGV[2]) == 1) then --æ£€æŸ¥å“ˆå¸Œè¡¨ KEYS[1] ä¸­æ˜¯å¦å­˜åœ¨å­—æ®µ ARGV[2]ï¼Œå¦‚æœå­˜åœ¨ï¼ˆ== 1ï¼‰ï¼Œè¡¨ç¤ºå½“å‰å®¢æˆ·ç«¯å·²ç»æŒæœ‰é”ï¼Œè¿›å…¥ä¸‹ä¸€æ­¥
        redis.call('hincrby', KEYS[1], ARGV[2], 1); --è®¡æ•°å™¨åŠ 1
        redis.call('pexpire', KEYS[1], ARGV[1]); --æ›´æ–°é”® KEYS[1] çš„è¿‡æœŸæ—¶é—´
        return nil;
        end;
return redis.call('pttl', KEYS[1]);
```

å°†ä¸šåŠ¡å°è£…åœ¨luaä¸­å‘ç»™redisï¼Œä¿éšœä¸šåŠ¡æ‰§è¡Œçš„åŸå­æ€§ã€‚

> **ç¤ºä¾‹ï¼š**
>
> å‡è®¾æœ‰ä¸¤ä¸ªå®¢æˆ·ç«¯ A å’Œ Bï¼Œå°è¯•è·å–åŒä¸€æŠŠé”ï¼Œé”çš„é”®åä¸º `my_lock`ï¼Œè¿‡æœŸæ—¶é—´ä¸º 5000 æ¯«ç§’ï¼ˆ5 ç§’ï¼‰ï¼Œå®¢æˆ·ç«¯çš„å”¯ä¸€æ ‡è¯†ç¬¦åˆ†åˆ«ä¸º `client_A` å’Œ `client_B`ã€‚
>
> - **å®¢æˆ·ç«¯ A ç¬¬ä¸€æ¬¡è·å–é”ï¼š**
>   - æ‰§è¡Œè„šæœ¬ï¼Œ`KEYS[1]` ä¸º `my_lock`ï¼Œ`ARGV[1]` ä¸º `5000`ï¼Œ`ARGV[2]` ä¸º `client_A`ã€‚
>   - å› ä¸ºé”ä¸å­˜åœ¨ï¼Œå®¢æˆ·ç«¯ A æˆåŠŸè·å–é”ï¼Œå“ˆå¸Œè¡¨ `my_lock` ä¸­å­—æ®µ `client_A` çš„å€¼è¢«è®¾ç½®ä¸º `1`ï¼Œè¿‡æœŸæ—¶é—´ä¸º 5000 æ¯«ç§’ã€‚
> - **å®¢æˆ·ç«¯ A ç¬¬äºŒæ¬¡è·å–é”ï¼ˆé‡å…¥ï¼‰ï¼š**
>   - æ‰§è¡Œè„šæœ¬ï¼Œå‚æ•°åŒä¸Šã€‚
>   - å› ä¸ºå®¢æˆ·ç«¯ A å·²æŒæœ‰é”ï¼Œå±äºé‡å…¥æ“ä½œï¼Œå“ˆå¸Œè¡¨ `my_lock` ä¸­å­—æ®µ `client_A` çš„å€¼è¢«åŠ  1ï¼ˆå˜ä¸º 2ï¼‰ï¼Œè¿‡æœŸæ—¶é—´é‡æ–°è®¾ç½®ä¸º 5000 æ¯«ç§’ã€‚
> - **å®¢æˆ·ç«¯ B å°è¯•è·å–é”ï¼š**
>   - æ‰§è¡Œè„šæœ¬ï¼Œ`KEYS[1]` ä¸º `my_lock`ï¼Œ`ARGV[1]` ä¸º `5000`ï¼Œ`ARGV[2]` ä¸º `client_B`ã€‚
>   - å› ä¸ºé”å·²è¢«å®¢æˆ·ç«¯ A æŒæœ‰ï¼Œå®¢æˆ·ç«¯ B è·å–é”å¤±è´¥ï¼Œè„šæœ¬è¿”å› `my_lock` çš„å‰©ä½™ç”Ÿå­˜æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ã€‚

2)é‡Šæ”¾é”ï¼š

```Lua
if (redis.call('exists', KEYS[1]) == 0) then
       redis.call('publish', KEYS[2], ARGV[1]);
        return 1; 
        end;
if (redis.call('hexists', KEYS[1], ARGV[3]) == 0) then 
     return nil;
     end;
local counter = redis.call('hincrby', KEYS[1], ARGV[3], -1); 
if (counter > 0) then
     redis.call('pexpire', KEYS[1], ARGV[2]); 
     return 0; 
else redis.call('del', KEYS[1]); 
     redis.call('publish', KEYS[2], ARGV[1]); 
     return 1;
     end;
return nil;
```

> ### å‚æ•°è¯´æ˜
>
> - `KEYS[1]`ï¼šé”çš„åç§°ï¼ˆRedis é”®åï¼‰ã€‚
> - `KEYS[2]`ï¼šç”¨äºå‘å¸ƒé€šçŸ¥çš„é¢‘é“åç§°ã€‚
> - `ARGV[1]`ï¼šå‘å¸ƒåˆ°é¢‘é“çš„æ¶ˆæ¯å†…å®¹ï¼ˆé€šå¸¸æ˜¯é”çš„åç§°æˆ–å…¶ä»–æ ‡è¯†ï¼‰ã€‚
> - `ARGV[2]`ï¼šé”çš„è¿‡æœŸæ—¶é—´ï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰ã€‚
> - `ARGV[3]`ï¼šå®¢æˆ·ç«¯çš„å”¯ä¸€æ ‡è¯†ï¼ˆç”¨äºåŒºåˆ†é”çš„æŒæœ‰è€…ï¼‰ã€‚
>
> 1ã€**`exists`**ï¼šæ£€æŸ¥é”ï¼ˆ`KEYS[1]`ï¼‰æ˜¯å¦å­˜åœ¨ã€‚
>
> - å¦‚æœé”ä¸å­˜åœ¨ï¼ˆ`exists` è¿”å› 0ï¼‰ï¼Œè¯´æ˜==é”å·²ç»è¢«é‡Šæ”¾æˆ–è¿‡æœŸ==ã€‚
> - æ­¤æ—¶ï¼Œè„šæœ¬ä¼šé€šè¿‡ `publish` å‘é¢‘é“ `KEYS[2]` å‘é€ä¸€æ¡æ¶ˆæ¯ï¼ˆ`ARGV[1]`ï¼‰ï¼Œé€šçŸ¥å…¶ä»–å®¢æˆ·ç«¯é”å·²é‡Šæ”¾ã€‚
> - è¿”å› `1`ï¼Œè¡¨ç¤ºé”ä¸å­˜åœ¨ï¼Œæ— éœ€è¿›ä¸€æ­¥æ“ä½œã€‚
>
> 2ã€**`hexists`**ï¼šæ£€æŸ¥é”æ˜¯å¦ç”±å½“å‰å®¢æˆ·ç«¯æŒæœ‰ï¼Œæ£€æŸ¥é”ï¼ˆ`KEYS[1]`ï¼‰çš„å“ˆå¸Œè¡¨ä¸­æ˜¯å¦å­˜åœ¨å½“å‰å®¢æˆ·ç«¯çš„æ ‡è¯†ï¼ˆ`ARGV[3]`ï¼‰ã€‚
>
> - å¦‚æœä¸å­˜åœ¨ï¼ˆ`hexists` è¿”å› 0ï¼‰ï¼Œè¯´æ˜å½“å‰å®¢æˆ·ç«¯å¹¶æœªæŒæœ‰é”ã€‚
> - è¿”å› `nil`ï¼Œè¡¨ç¤ºæ— æ³•é‡Šæ”¾é”ï¼ˆ==å› ä¸ºé”ä¸æ˜¯å½“å‰å®¢æˆ·ç«¯æŒæœ‰çš„==ï¼‰ã€‚
>
> 3ã€**`hincrby`**ï¼šå‡å°‘é”çš„æŒæœ‰è®¡æ•°ï¼Œå°†é”çš„æŒæœ‰è®¡æ•°å‡ 1ï¼Œ==åˆ°äº†è¿™ä¸€æ­¥ï¼Œè¯´æ˜ä¸Šä¸€æ­¥`ARGV[3]`æ˜¯æŒæœ‰é”çš„==ã€‚
>
> - å¦‚æœé”æ˜¯å¯é‡å…¥çš„ï¼ˆå³åŒä¸€ä¸ªå®¢æˆ·ç«¯å¯ä»¥å¤šæ¬¡è·å–é”ï¼‰ï¼Œæ¯æ¬¡é‡Šæ”¾é”æ—¶ï¼Œè®¡æ•°ä¼šå‡å°‘ã€‚
> - `counter` æ˜¯å‡å°‘åçš„è®¡æ•°ã€‚
>
> 4ã€åˆ¤æ–­é”æ˜¯å¦éœ€è¦åˆ é™¤
>
> - **`counter > 0`**ï¼šå¦‚æœé”çš„æŒæœ‰è®¡æ•°ä»ç„¶å¤§äº 0ï¼Œè¯´æ˜é”è¿˜æœªå®Œå…¨é‡Šæ”¾ã€‚
>   - æ›´æ–°é”çš„è¿‡æœŸæ—¶é—´ï¼ˆ`pexpire`ï¼‰ï¼Œé˜²æ­¢é”è¿‡æ—©è¿‡æœŸã€‚
>   - è¿”å› `0`ï¼Œè¡¨ç¤ºé”æœªå®Œå…¨é‡Šæ”¾ã€‚
> - **`counter <= 0`**ï¼šå¦‚æœé”çš„æŒæœ‰è®¡æ•°å½’é›¶ï¼Œè¯´æ˜é”å·²ç»å®Œå…¨é‡Šæ”¾ã€‚
>   - åˆ é™¤é”ï¼ˆ`del`ï¼‰ã€‚
>   - é€šè¿‡ `publish` å‘é¢‘é“ `KEYS[2]` å‘é€ä¸€æ¡æ¶ˆæ¯ï¼ˆ`ARGV[1]`ï¼‰ï¼Œé€šçŸ¥å…¶ä»–å®¢æˆ·ç«¯é”å·²é‡Šæ”¾ã€‚
>   - è¿”å› `1`ï¼Œè¡¨ç¤ºé”å·²å®Œå…¨é‡Šæ”¾ã€‚

æ‰§è¡Œlock.unlock(),æ¯æ¬¡éƒ½å¯¹myLockæ•°æ®ç»“æ„ä¸­çš„é‚£ä¸ªåŠ é”æ¬¡æ•°å‡1ã€‚å¦‚æœå‘ç°åŠ é”æ¬¡æ•°æ˜¯0äº†ï¼Œè¯´æ˜è¿™ä¸ªå®¢æˆ·ç«¯å·²ç»ä¸å†æŒæœ‰é”äº†ï¼Œæ­¤æ—¶å°±ä¼šç”¨ï¼š`del myLock`å‘½ä»¤ï¼Œä»redisé‡Œåˆ é™¤è¿™ä¸ªkey,å¦å¤–çš„å®¢æˆ·ç«¯2å°±å¯ä»¥å°è¯•å®ŒæˆåŠ é”äº†ã€‚

3)ç¼ºç‚¹ï¼š

Redissonå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚æœä½ å¯¹æŸä¸ªredis masterå®ä¾‹ï¼Œå†™å…¥äº†myLockè¿™ç§é”keyçš„valueï¼Œæ­¤æ—¶ä¼šå¼‚æ­¥å¤åˆ¶ç»™å¯¹åº”çš„master slaveå®ä¾‹ã€‚ä½†æ˜¯è¿™ä¸ªè¿‡ç¨‹ä¸­ä¸€æ—¦å‘ç”Ÿredis masterå®•æœºï¼Œä¸»å¤‡åˆ‡æ¢ï¼Œredis slaveå˜ä¸ºäº†redis masterã€‚æ¥ç€å°±ä¼šå¯¼è‡´ï¼Œå®¢æˆ·ç«¯2æ¥å°è¯•åŠ é”çš„æ—¶å€™ï¼Œåœ¨æ–°çš„redis masterä¸Šå®Œæˆäº†åŠ é”ï¼Œè€Œå®¢æˆ·ç«¯1ä¹Ÿä»¥ä¸ºè‡ªå·±æˆåŠŸåŠ äº†é”ã€‚æ­¤æ—¶å°±ä¼šå¯¼è‡´å¤šä¸ªå®¢æˆ·ç«¯å¯¹ä¸€ä¸ªåˆ†å¸ƒå¼é”å®Œæˆäº†åŠ é”ã€‚è¿™æ—¶ç³»ç»Ÿåœ¨ä¸šåŠ¡ä¸Šä¸€å®šä¼šå‡ºç°é—®é¢˜ï¼Œå¯¼è‡´è„æ•°æ®çš„äº§ç”Ÿã€‚

#### 1.2.3 Redissoné…ç½®

**1)å¼•å…¥ä¾èµ–**

åœ¨`seckill-order`çš„pom.xmlä¸­å¼•å…¥ä¾èµ–ï¼š

```XML
<dependency>
    <groupId>org.redisson</groupId>
    <artifactId>redisson-spring-boot-starter</artifactId>
    <version>3.11.0</version>
</dependency>
```

**2)é…ç½®Redisé“¾æ¥**

åœ¨`seckill-order`çš„resourcesä¸‹æ–°å»ºæ–‡ä»¶`redisson.yml`ï¼Œä¸»è¦ç”¨äºé…ç½®redisé›†ç¾¤èŠ‚ç‚¹é“¾æ¥é…ç½®ï¼Œä»£ç å¦‚ä¸‹ï¼š

```YAML
clusterServersConfig:
  # è¿æ¥ç©ºé—²è¶…æ—¶ï¼Œå•ä½ï¼šæ¯«ç§’ é»˜è®¤10000
  idleConnectionTimeout: 10000
  pingTimeout: 1000
  # åŒä»»ä½•èŠ‚ç‚¹å»ºç«‹è¿æ¥æ—¶çš„ç­‰å¾…è¶…æ—¶ã€‚æ—¶é—´å•ä½æ˜¯æ¯«ç§’ é»˜è®¤10000
  connectTimeout: 10000
  # ç­‰å¾…èŠ‚ç‚¹å›å¤å‘½ä»¤çš„æ—¶é—´ã€‚è¯¥æ—¶é—´ä»å‘½ä»¤å‘é€æˆåŠŸæ—¶å¼€å§‹è®¡æ—¶ã€‚é»˜è®¤3000
  timeout: 3000
  # å‘½ä»¤å¤±è´¥é‡è¯•æ¬¡æ•°
  retryAttempts: 3
  # å‘½ä»¤é‡è¯•å‘é€æ—¶é—´é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’
  retryInterval: 1500
  # é‡æ–°è¿æ¥æ—¶é—´é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’
  reconnectionTimeout: 3000
  # æ‰§è¡Œå¤±è´¥æœ€å¤§æ¬¡æ•°
  failedAttempts: 3
  # å¯†ç 
  #password: test1234
  # å•ä¸ªè¿æ¥æœ€å¤§è®¢é˜…æ•°é‡
  subscriptionsPerConnection: 5
  clientName: null
  # loadBalancer è´Ÿè½½å‡è¡¡ç®—æ³•ç±»çš„é€‰æ‹©
  loadBalancer: !<org.redisson.connection.balancer.RoundRobinLoadBalancer> {}
  #ä»èŠ‚ç‚¹å‘å¸ƒå’Œè®¢é˜…è¿æ¥çš„æœ€å°ç©ºé—²è¿æ¥æ•°
  slaveSubscriptionConnectionMinimumIdleSize: 1
  #ä»èŠ‚ç‚¹å‘å¸ƒå’Œè®¢é˜…è¿æ¥æ± å¤§å° é»˜è®¤å€¼50
  slaveSubscriptionConnectionPoolSize: 50
  # ä»èŠ‚ç‚¹æœ€å°ç©ºé—²è¿æ¥æ•° é»˜è®¤å€¼32
  slaveConnectionMinimumIdleSize: 32
  # ä»èŠ‚ç‚¹è¿æ¥æ± å¤§å° é»˜è®¤64
  slaveConnectionPoolSize: 64
  # ä¸»èŠ‚ç‚¹æœ€å°ç©ºé—²è¿æ¥æ•° é»˜è®¤32
  masterConnectionMinimumIdleSize: 32
  # ä¸»èŠ‚ç‚¹è¿æ¥æ± å¤§å° é»˜è®¤64
  masterConnectionPoolSize: 64
  # è®¢é˜…æ“ä½œçš„è´Ÿè½½å‡è¡¡æ¨¡å¼
  subscriptionMode: SLAVE
  # åªåœ¨ä»æœåŠ¡å™¨è¯»å–
  readMode: SLAVE
  # é›†ç¾¤åœ°å€
  nodeAddresses:
    - "redis://redis-server:7001"
    - "redis://redis-server:7002"
    - "redis://redis-server:7003"
    - "redis://redis-server:7004"
    - "redis://redis-server:7005"
    - "redis://redis-server:7006"
  # å¯¹Redisé›†ç¾¤èŠ‚ç‚¹çŠ¶æ€æ‰«æçš„æ—¶é—´é—´éš”ã€‚å•ä½æ˜¯æ¯«ç§’ã€‚é»˜è®¤1000
  scanInterval: 1000
  #è¿™ä¸ªçº¿ç¨‹æ± æ•°é‡è¢«æ‰€æœ‰RTopicå¯¹è±¡ç›‘å¬å™¨ï¼ŒRRemoteServiceè°ƒç”¨è€…å’ŒRExecutorServiceä»»åŠ¡å…±åŒå…±äº«ã€‚é»˜è®¤2
threads: 0
#è¿™ä¸ªçº¿ç¨‹æ± æ•°é‡æ˜¯åœ¨ä¸€ä¸ªRedissonå®ä¾‹å†…ï¼Œè¢«å…¶åˆ›å»ºçš„æ‰€æœ‰åˆ†å¸ƒå¼æ•°æ®ç±»å‹å’ŒæœåŠ¡ï¼Œä»¥åŠåº•å±‚å®¢æˆ·ç«¯æ‰€ä¸€åŒå…±äº«çš„çº¿ç¨‹æ± é‡Œä¿å­˜çš„çº¿ç¨‹æ•°é‡ã€‚é»˜è®¤2
nettyThreads: 0
# ç¼–ç æ–¹å¼ é»˜è®¤org.redisson.codec.JsonJacksonCodec
codec: !<org.redisson.codec.JsonJacksonCodec> {}
#ä¼ è¾“æ¨¡å¼
transportMode: NIO
# åˆ†å¸ƒå¼é”è‡ªåŠ¨è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”ï¼Œé»˜è®¤30000
lockWatchdogTimeout: 30000
# é€šè¿‡è¯¥å‚æ•°æ¥ä¿®æ”¹æ˜¯å¦æŒ‰è®¢é˜…å‘å¸ƒæ¶ˆæ¯çš„æ¥æ”¶é¡ºåºå‡ºæ¥æ¶ˆæ¯ï¼Œå¦‚æœé€‰å¦å°†å¯¹æ¶ˆæ¯å®è¡Œå¹¶è¡Œå¤„ç†ï¼Œè¯¥å‚æ•°åªé€‚ç”¨äºè®¢é˜…å‘å¸ƒæ¶ˆæ¯çš„æƒ…å†µ, é»˜è®¤true
keepPubSubOrder: true
# ç”¨æ¥æŒ‡å®šé«˜æ€§èƒ½å¼•æ“çš„è¡Œä¸ºã€‚ç”±äºè¯¥å˜é‡å€¼çš„é€‰ç”¨ä¸ä½¿ç”¨åœºæ™¯æ¯æ¯ç›¸å…³ï¼ˆNORMALé™¤å¤–ï¼‰æˆ‘ä»¬å»ºè®®å¯¹æ¯ä¸ªå‚æ•°å€¼éƒ½è¿›è¡Œå°è¯•ã€‚
#
#è¯¥å‚æ•°ä»…é™äºRedisson PROç‰ˆæœ¬ã€‚
#performanceMode: HIGHER_THROUGHPUT
```

**3)åˆ›å»ºRedissonç®¡ç†å¯¹è±¡**

â€‹        Redissonç®¡ç†å¯¹è±¡æœ‰2ä¸ªï¼Œåˆ†åˆ«ä¸º`RedissonClient`å’Œ`RedissonConnectionFactory`ï¼Œæˆ‘ä»¬åªç”¨åœ¨é¡¹ç›®çš„`RedisConfig`ä¸­é…ç½®ä¸€ä¸‹è¿™2ä¸ªå¯¹è±¡å³å¯ï¼Œåœ¨`com.seckill.order.config.RedisConfig`ä¸­æ·»åŠ çš„ä»£ç å¦‚ä¸‹ï¼š

```Java
/**
 * Redissonå®¢æˆ·ç«¯
 */
@Bean
public RedissonClient redisson() throws IOException {
    ClassPathResource resource = new ClassPathResource("redisson.yml");
    Config config = Config.fromYAML(resource.getInputStream());
    RedissonClient redisson = Redisson.create(config);
    return redisson;
}

/**
 * Redissonå·¥å‚å¯¹è±¡
 */
@Bean
public RedissonConnectionFactory redissonConnectionFactory(RedissonClient redisson) {
    return new RedissonConnectionFactory(redisson);
}
```

**4)é”æ“ä½œæ–¹æ³•å®ç°**

è¦æƒ³ç”¨åˆ°åˆ†å¸ƒå¼é”ï¼Œæˆ‘ä»¬å°±å¿…é¡»è¦å®ç°è·å–é”å’Œé‡Šæ”¾é”ï¼Œè·å–é”å’Œé‡Šæ”¾é”å¯ä»¥ç¼–å†™`com.seckill.order.config.DistributedLocker`æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
public interface DistributedLocker {
    /**
     * lock(), æ‹¿ä¸åˆ°lockå°±ä¸ç½¢ä¼‘ï¼Œä¸ç„¶çº¿ç¨‹å°±ä¸€ç›´block
     */
    RLock lock(String lockKey);
    /**
     * timeoutä¸ºåŠ é”æ—¶é—´ï¼Œå•ä½ä¸ºç§’
     */
    RLock lock(String lockKey, long timeout);
    /**
     * timeoutä¸ºåŠ é”æ—¶é—´ï¼Œæ—¶é—´å•ä½ç”±unitç¡®å®š
     */
    RLock lock(String lockKey, TimeUnit unit, long timeout);
    /**
     * tryLock()ï¼Œé©¬ä¸Šè¿”å›ï¼Œæ‹¿åˆ°lockå°±è¿”å›trueï¼Œä¸ç„¶è¿”å›falseã€‚
     * å¸¦æ—¶é—´é™åˆ¶çš„tryLock()ï¼Œæ‹¿ä¸åˆ°lockï¼Œå°±ç­‰ä¸€æ®µæ—¶é—´ï¼Œè¶…æ—¶è¿”å›false.
     */
    boolean tryLock(String lockKey, TimeUnit unit, long waitTime, long leaseTime);
    /**
     * è§£é”
     */
    void unLock(String lockKey);
    /**
     * è§£é”
     */
    void unLock(RLock lock);
}
```

å®ç°ä¸Šé¢æ¥å£ä¸­å¯¹åº”çš„é”ç®¡ç†æ–¹æ³•,ç¼–å†™é”ç®¡ç†ç±»`com.seckill.order.config.RedissonDistributedLocker`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
@Component
public class RedissonDistributedLocker implements DistributedLocker {

    @Autowired
    private RedissonClient redissonClient;

    /**
     * lock(), æ‹¿ä¸åˆ°lockå°±ä¸ç½¢ä¼‘ï¼Œä¸ç„¶çº¿ç¨‹å°±ä¸€ç›´block
     */
    @Override
    public RLock lock(String lockKey) {
        RLock lock = redissonClient.getLock(lockKey);
        lock.lock();
        return lock;
    }

    /**
     * timeoutä¸ºåŠ é”æ—¶é—´ï¼Œå•ä½ä¸ºç§’
     */
    @Override
    public RLock lock(String lockKey, long timeout) {
        RLock lock = redissonClient.getLock(lockKey);
        lock.lock(timeout, TimeUnit.SECONDS);
        return lock;
    }

    /**
     * timeoutä¸ºåŠ é”æ—¶é—´ï¼Œæ—¶é—´å•ä½ç”±unitç¡®å®š
     */
    @Override
    public RLock lock(String lockKey, TimeUnit unit, long timeout) {
        RLock lock = redissonClient.getLock(lockKey);
        lock.lock(timeout, unit);
        return lock;
    }

    /**
     * tryLock()ï¼Œé©¬ä¸Šè¿”å›ï¼Œæ‹¿åˆ°lockå°±è¿”å›trueï¼Œä¸ç„¶è¿”å›falseã€‚
     * å¸¦æ—¶é—´é™åˆ¶çš„tryLock()ï¼Œæ‹¿ä¸åˆ°lockï¼Œå°±ç­‰ä¸€æ®µæ—¶é—´ï¼Œè¶…æ—¶è¿”å›false.
     */
    @Override
    public boolean tryLock(String lockKey, TimeUnit unit, long waitTime, long leaseTime) {
        RLock lock = redissonClient.getLock(lockKey);
        try {
            return lock.tryLock(waitTime, leaseTime, unit);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        return false;
    }

    /**
     * è§£é”
     */
    @Override
    public void unLock(String lockKey) {
        RLock lock = redissonClient.getLock(lockKey);
        lock.unlock();
    }

    /**
     * è§£é”
     */
    @Override
    public void unLock(RLock lock) {
        lock.unlock();
    }
}
```

**5)æµ‹è¯•ä»£ç **

æµ‹è¯•Redissonåˆ†å¸ƒå¼é”çš„ä»£ç å¦‚ä¸‹ï¼š

```Java
@RestController
@RequestMapping(value = "/redisson")
public class RedissonController {

    @Autowired
    private RedissonDistributedLocker distributedLocker;

    /**
     * å¤šä¸ªç”¨æˆ·å®ç°åŠ é”æ“ä½œï¼Œåªå…è®¸æœ‰ä¸€ä¸ªç”¨æˆ·å¯ä»¥è·å–åˆ°å¯¹åº”é”
     */
    @GetMapping(value = "/lock/{time}")
    public String lock(@PathVariable(value = "time") Long time) throws InterruptedException {
        System.out.println("å½“å‰ä¼‘çœ æ ‡è¯†æ—¶é—´ï¼š" + time);

        //è·å–é”
        RLock rlock = distributedLocker.lock("UUUUU");
        System.out.println("æ‰§è¡Œä¼‘çœ ï¼š" + time);

        TimeUnit.SECONDS.sleep(time);

        System.out.println("===========ä¼‘çœ å®Œæˆï¼Œå‡†å¤‡é‡Šæ”¾é”ï¼š" + time);
        //é‡Šæ”¾é”
        distributedLocker.unLock(rlock);
        return "OK";
    }
}
```

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503051236807.png)

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503051237195.png)

### 1.3 Redissonåˆ†å¸ƒå¼é”æ§åˆ¶è¶…å–

â€‹        æˆ‘ä»¬æŠŠä¸Šé¢ç§’æ€ä¸‹å•ä¼šå‡ºç°è¶…å–çš„éƒ¨åˆ†ä»£ç ç”¨Redissonåˆ†å¸ƒå¼é”æ¥æ§åˆ¶ä¸€ä¸‹ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
@Autowired
private RedissonDistributedLocker distributedLocker;

/**
 * ç§’æ€ä¸‹å•
 *
 * @param orderMap
 */
@Override
public void addHotOrder(Map<String, String> orderMap) {
    String id = orderMap.get("id");
    String username = orderMap.get("username");
    //key
    String key = "SKU_" + id;
    
    //åˆ†å¸ƒå¼é”çš„key
    String lockkey = "LOCKSKU_" + id;

    //ç”¨æˆ·è´­ä¹°çš„key
    String userKey = "USER" + username + "ID" + id;

    //å°è¯•è·å–é”ï¼Œç­‰å¾…10ç§’ï¼Œè‡ªå·±è·å¾—é”åä¸€ç›´ä¸è§£é”åˆ™10ç§’åè‡ªåŠ¨è§£é”
    boolean bo = distributedLocker.tryLock(lockkey, TimeUnit.SECONDS, 10L, 10L);

    if (bo) {
        if (redisTemplate.hasKey(key)) {
            //æ•°é‡
            Integer num = Integer.parseInt(redisTemplate.boundHashOps(key).get("num").toString());

            //æ‹¥æœ‰åº“å­˜ï¼Œæ‰§è¡Œé€’å‡æ“ä½œ
            if (num > 0) {
                //æŸ¥è¯¢å•†å“
                Result<Sku> result = skuFeign.findById(id);
                Sku sku = result.getData();
                Order order = new Order();
                order.setCreateTime(new Date());
                order.setUpdateTime(order.getCreateTime());
                order.setUsername(username);
                order.setSkuId(id);
                order.setName(sku.getName());
                order.setPrice(sku.getSeckillPrice());
                order.setId("No" + idWorker.nextId());
                order.setOrderStatus("0");
                order.setPayStatus("0");
                order.setConsignStatus("0");
                orderMapper.insertSelective(order);

                //åº“å­˜é€’å‡
                num--;

                if (num == 0) {
                    //åŒæ­¥æ•°æ®åˆ°æ•°æ®åº“ï¼Œç§’æ€æ•°é‡å½’é›¶
                    skuFeign.zero(id);
                }

                //æ›´æ–°æ•°æ®
                Map<String, Object> dataMap = new HashMap<String, Object>();
                dataMap.put("num", num);
                dataMap.put(userKey, 0);

                //å­˜æ•°æ®
                redisTemplate.boundHashOps(key).putAll(dataMap);
            }

            //è®°å½•è¯¥å•†å“ç”¨æˆ·24å°æ—¶å†…æ— æ³•å†æ¬¡è´­ä¹°,æµ‹è¯•ç¯å¢ƒï¼Œæˆ‘ä»¬åªé…ç½®æˆ1åˆ†é’Ÿ
            redisTemplate.boundValueOps(userKey).set("");
            redisTemplate.expire(userKey, 1, TimeUnit.MINUTES);
        }
        distributedLocker.unLock(lockkey);
    }
}
```

## 2 åˆ†å¸ƒå¼äº‹åŠ¡

### 2.1 åˆ†å¸ƒå¼äº‹åŠ¡ä»‹ç»

**1)äº‹åŠ¡**

â€‹        äº‹åŠ¡æä¾›ä¸€ç§æœºåˆ¶å°†ä¸€ä¸ªä¸šåŠ¡æ¶‰åŠçš„æ‰€æœ‰æ“ä½œçº³å…¥åˆ°ä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ‰§è¡Œå•å…ƒï¼Œç»„æˆäº‹åŠ¡çš„æ‰€æœ‰æ“ä½œåªæœ‰åœ¨æ‰€æœ‰æ“ä½œå‡èƒ½æ­£å¸¸æ‰§è¡Œçš„æƒ…å†µä¸‹æ–¹èƒ½æäº¤ï¼Œåªè¦å…¶ä¸­ä»»ä¸€æ“ä½œæ‰§è¡Œå¤±è´¥ï¼Œéƒ½å°†å¯¼è‡´æ•´ä¸ªäº‹åŠ¡çš„å›æ»šã€‚ç®€å•åœ°è¯´ï¼Œäº‹åŠ¡æä¾›ä¸€ç§â€œè¦ä¹ˆä»€ä¹ˆéƒ½ä¸åšï¼Œè¦ä¹ˆåšå…¨å¥—ï¼ˆAll or Nothingï¼‰â€æœºåˆ¶ã€‚

**2)æœ¬åœ°äº‹åŠ¡4å¤§ç‰¹æ€§**

**CAIDï¼š**

```Plaintext
Aï¼šåŸå­æ€§(Atomicity)ï¼Œä¸€ä¸ªäº‹åŠ¡(transaction)ä¸­çš„æ‰€æœ‰æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå…¨éƒ¨ä¸å®Œæˆï¼Œä¸ä¼šç»“æŸåœ¨ä¸­é—´æŸä¸ªç¯èŠ‚ã€‚
äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œä¼šè¢«å›æ»šï¼ˆRollbackï¼‰åˆ°äº‹åŠ¡å¼€å§‹å‰çš„çŠ¶æ€ï¼Œå°±åƒè¿™ä¸ªäº‹åŠ¡ä»æ¥æ²¡æœ‰æ‰§è¡Œè¿‡ä¸€æ ·ã€‚
å°±åƒä½ ä¹°ä¸œè¥¿è¦ä¹ˆäº¤é’±æ”¶è´§ä¸€èµ·éƒ½æ‰§è¡Œï¼Œè¦ä¹ˆå‘ä¸å‡ºè´§ï¼Œå°±é€€é’±ã€‚

Cï¼šä¸€è‡´æ€§(Consistency)ï¼Œäº‹åŠ¡çš„ä¸€è‡´æ€§æŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œä¹‹å‰å’Œæ‰§è¡Œä¹‹åæ•°æ®åº“éƒ½å¿…é¡»å¤„äºä¸€è‡´æ€§çŠ¶æ€ã€‚
å¦‚æœäº‹åŠ¡æˆåŠŸåœ°å®Œæˆï¼Œé‚£ä¹ˆç³»ç»Ÿä¸­æ‰€æœ‰å˜åŒ–å°†æ­£ç¡®åœ°åº”ç”¨ï¼Œç³»ç»Ÿå¤„äºæœ‰æ•ˆçŠ¶æ€ã€‚
å¦‚æœåœ¨äº‹åŠ¡ä¸­å‡ºç°é”™è¯¯ï¼Œé‚£ä¹ˆç³»ç»Ÿä¸­çš„æ‰€æœ‰å˜åŒ–å°†è‡ªåŠ¨åœ°å›æ»šï¼Œç³»ç»Ÿè¿”å›åˆ°åŸå§‹çŠ¶æ€ã€‚

Iï¼šéš”ç¦»æ€§(Isolation)ï¼ŒæŒ‡çš„æ˜¯åœ¨å¹¶å‘ç¯å¢ƒä¸­ï¼Œå½“ä¸åŒçš„äº‹åŠ¡åŒæ—¶æ“çºµç›¸åŒçš„æ•°æ®æ—¶ï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½æœ‰å„è‡ªçš„å®Œæ•´æ•°æ®ç©ºé—´ã€‚
ç”±å¹¶å‘äº‹åŠ¡æ‰€åšçš„ä¿®æ”¹å¿…é¡»ä¸ä»»ä½•å…¶ä»–å¹¶å‘äº‹åŠ¡æ‰€åšçš„ä¿®æ”¹éš”ç¦»ã€‚äº‹åŠ¡æŸ¥çœ‹æ•°æ®æ›´æ–°æ—¶ï¼Œæ•°æ®æ‰€å¤„çš„çŠ¶æ€è¦ä¹ˆæ˜¯å¦ä¸€äº‹åŠ¡ä¿®æ”¹å®ƒä¹‹å‰çš„çŠ¶æ€ï¼Œè¦ä¹ˆæ˜¯å¦ä¸€äº‹åŠ¡ä¿®æ”¹å®ƒä¹‹åçš„çŠ¶æ€ï¼Œäº‹åŠ¡ä¸ä¼šæŸ¥çœ‹åˆ°ä¸­é—´çŠ¶æ€çš„æ•°æ®ã€‚
æ‰“ä¸ªæ¯”æ–¹ï¼Œä½ ä¹°ä¸œè¥¿è¿™ä¸ªäº‹æƒ…ï¼Œæ˜¯ä¸å½±å“å…¶ä»–äººçš„ã€‚

Dï¼šæŒä¹…æ€§(Durability)ï¼ŒæŒ‡çš„æ˜¯åªè¦äº‹åŠ¡æˆåŠŸç»“æŸï¼Œå®ƒå¯¹æ•°æ®åº“æ‰€åšçš„æ›´æ–°å°±å¿…é¡»ä¿å­˜ä¸‹æ¥ã€‚
å³ä½¿å‘ç”Ÿç³»ç»Ÿå´©æºƒï¼Œé‡æ–°å¯åŠ¨æ•°æ®åº“ç³»ç»Ÿåï¼Œæ•°æ®åº“è¿˜èƒ½æ¢å¤åˆ°äº‹åŠ¡æˆåŠŸç»“æŸæ—¶çš„çŠ¶æ€ã€‚
æ‰“ä¸ªæ¯”æ–¹ï¼Œä½ ä¹°ä¸œè¥¿çš„æ—¶å€™éœ€è¦è®°å½•åœ¨è´¦æœ¬ä¸Šï¼Œå³ä½¿è€æ¿å¿˜è®°äº†é‚£ä¹Ÿæœ‰æ®å¯æŸ¥ã€‚
```

**3)åˆ†å¸ƒå¼äº‹åŠ¡**

â€‹        åˆ†å¸ƒå¼äº‹åŠ¡æŒ‡äº‹åŠ¡çš„å‚ä¸è€…ã€æ”¯æŒäº‹åŠ¡çš„æœåŠ¡å™¨ã€èµ„æºæœåŠ¡å™¨ä»¥åŠäº‹åŠ¡ç®¡ç†å™¨åˆ†åˆ«ä½äºä¸åŒçš„åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸åŒèŠ‚ç‚¹ä¹‹ä¸Šã€‚ç®€å•çš„è¯´ï¼Œå°±æ˜¯ä¸€æ¬¡å¤§çš„æ“ä½œç”±ä¸åŒçš„å°æ“ä½œç»„æˆï¼Œè¿™äº›å°çš„æ“ä½œåˆ†å¸ƒåœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œä¸”å±äºä¸åŒçš„åº”ç”¨ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡éœ€è¦ä¿è¯è¿™äº›å°æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚æœ¬è´¨ä¸Šæ¥è¯´ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡å°±æ˜¯ä¸ºäº†ä¿è¯ä¸åŒæ•°æ®åº“çš„æ•°æ®ä¸€è‡´æ€§ã€‚

ä»€ä¹ˆæ—¶å€™ä¼šäº§ç”Ÿåˆ†å¸ƒå¼äº‹åŠ¡å‘¢ï¼Ÿ

1.å¤šä¸ªService

2.å¤šä¸ªResource

å¦‚ä¸‹è®¢å•æ”¯ä»˜ä¸šåŠ¡æµç¨‹ï¼š

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503050002081.png)

**4)CAPå®šç†**

CAP å®šç†ï¼Œåˆè¢«å«ä½œå¸ƒé²å°”å®šç†ã€‚

**C (ä¸€è‡´æ€§)**ï¼šå¯¹äºæ•°æ®åˆ†å¸ƒåœ¨ä¸åŒèŠ‚ç‚¹ä¸Šçš„æ•°æ®æ¥è¯´ï¼Œå¦‚æœåœ¨æŸä¸ªèŠ‚ç‚¹æ›´æ–°äº†æ•°æ®ï¼Œé‚£ä¹ˆåœ¨å…¶ä»–èŠ‚ç‚¹å¦‚æœéƒ½èƒ½è¯»å–åˆ°è¿™ä¸ªçš„æ•°æ®ï¼Œé‚£ä¹ˆå°±ç§°ä¸ºå¼ºä¸€è‡´ï¼Œå¦‚æœæœ‰æŸä¸ªèŠ‚ç‚¹æ²¡æœ‰è¯»å–åˆ°ï¼Œé‚£å°±æ˜¯åˆ†å¸ƒå¼ä¸ä¸€è‡´ã€‚

**A (å¯ç”¨æ€§)**ï¼šéæ•…éšœçš„èŠ‚ç‚¹åœ¨åˆç†çš„æ—¶é—´å†…è¿”å›åˆç†çš„å“åº”(ä¸æ˜¯é”™è¯¯å’Œè¶…æ—¶çš„å“åº”)ã€‚å¯ç”¨æ€§çš„ä¸¤ä¸ªå…³é”®ä¸€ä¸ªæ˜¯åˆç†çš„æ—¶é—´ï¼Œä¸€ä¸ªæ˜¯åˆç†çš„å“åº”ã€‚

åˆç†çš„æ—¶é—´æŒ‡çš„æ˜¯è¯·æ±‚ä¸èƒ½è¢«é˜»å¡ï¼Œåº”è¯¥åœ¨åˆç†çš„æ—¶é—´ç»™å‡ºè¿”å›ã€‚åˆç†çš„å“åº”æŒ‡çš„æ˜¯ç³»ç»Ÿåº”è¯¥æ˜ç¡®è¿”å›ç»“æœå¹¶ä¸”ç»“æœæ˜¯æ­£ç¡®çš„ï¼Œè¿™é‡Œçš„æ­£ç¡®æŒ‡çš„æ˜¯æ¯”å¦‚åº”è¯¥è¿”å› 50ï¼Œè€Œä¸æ˜¯è¿”å› 40ã€‚

**P (åˆ†åŒºå®¹é”™æ€§)**ï¼šå½“å‡ºç°ç½‘ç»œåˆ†åŒºåï¼Œç³»ç»Ÿèƒ½å¤Ÿç»§ç»­å·¥ä½œã€‚æ‰“ä¸ªæ¯”æ–¹ï¼Œè¿™é‡Œé›†ç¾¤æœ‰å¤šå°æœºå™¨ï¼Œæœ‰å°æœºå™¨ç½‘ç»œå‡ºç°äº†é—®é¢˜ï¼Œä½†æ˜¯è¿™ä¸ªé›†ç¾¤ä»ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œã€‚

ç†Ÿæ‚‰ CAP çš„äººéƒ½çŸ¥é“ï¼Œä¸‰è€…ä¸èƒ½å…±æœ‰ï¼Œå¦‚æœæ„Ÿå…´è¶£å¯ä»¥æœç´¢ CAP çš„è¯æ˜ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç½‘ç»œæ— æ³• 100% å¯é ï¼Œåˆ†åŒºå…¶å®æ˜¯ä¸€ä¸ªå¿…ç„¶ç°è±¡ã€‚

å¦‚æœæˆ‘ä»¬é€‰æ‹©äº† CA è€Œæ”¾å¼ƒäº† Pï¼Œé‚£ä¹ˆå½“å‘ç”Ÿåˆ†åŒºç°è±¡æ—¶ï¼Œä¸ºäº†ä¿è¯ä¸€è‡´æ€§ï¼Œè¿™ä¸ªæ—¶å€™å¿…é¡»æ‹’ç»è¯·æ±‚ï¼Œä½†æ˜¯ A åˆä¸å…è®¸ï¼Œæ‰€ä»¥åˆ†å¸ƒå¼ç³»ç»Ÿç†è®ºä¸Šä¸å¯èƒ½é€‰æ‹© CA æ¶æ„ï¼Œåªèƒ½é€‰æ‹© CP æˆ–è€… AP æ¶æ„ã€‚

å¯¹äº CP æ¥è¯´ï¼Œæ”¾å¼ƒå¯ç”¨æ€§ï¼Œè¿½æ±‚ä¸€è‡´æ€§å’Œåˆ†åŒºå®¹é”™æ€§ï¼Œæˆ‘ä»¬çš„ ZooKeeper å…¶å®å°±æ˜¯è¿½æ±‚çš„å¼ºä¸€è‡´ã€‚

å¯¹äº AP æ¥è¯´ï¼Œæ”¾å¼ƒä¸€è‡´æ€§(è¿™é‡Œè¯´çš„ä¸€è‡´æ€§æ˜¯å¼ºä¸€è‡´æ€§)ï¼Œè¿½æ±‚åˆ†åŒºå®¹é”™æ€§å’Œå¯ç”¨æ€§ï¼Œè¿™æ˜¯å¾ˆå¤šåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡æ—¶çš„é€‰æ‹©ï¼Œåé¢çš„ BASE ä¹Ÿæ˜¯æ ¹æ® AP æ¥æ‰©å±•ã€‚

é¡ºä¾¿ä¸€æï¼ŒCAP ç†è®ºä¸­æ˜¯å¿½ç•¥ç½‘ç»œå»¶è¿Ÿï¼Œä¹Ÿå°±æ˜¯å½“äº‹åŠ¡æäº¤æ—¶ï¼Œä»èŠ‚ç‚¹ A å¤åˆ¶åˆ°èŠ‚ç‚¹ B æ²¡æœ‰å»¶è¿Ÿï¼Œä½†æ˜¯åœ¨ç°å®ä¸­è¿™ä¸ªæ˜¯æ˜æ˜¾ä¸å¯èƒ½çš„ï¼Œæ‰€ä»¥æ€»ä¼šæœ‰ä¸€å®šçš„æ—¶é—´æ˜¯ä¸ä¸€è‡´ã€‚

åŒæ—¶ CAP ä¸­é€‰æ‹©ä¸¤ä¸ªï¼Œæ¯”å¦‚ä½ é€‰æ‹©äº† CPï¼Œå¹¶ä¸æ˜¯å«ä½ æ”¾å¼ƒ Aã€‚å› ä¸º P å‡ºç°çš„æ¦‚ç‡å®åœ¨æ˜¯å¤ªå°äº†ï¼Œå¤§éƒ¨åˆ†çš„æ—¶é—´ä½ ä»ç„¶éœ€è¦ä¿è¯ CAã€‚

å°±ç®—åˆ†åŒºå‡ºç°äº†ä½ ä¹Ÿè¦ä¸ºåæ¥çš„ A åšå‡†å¤‡ï¼Œæ¯”å¦‚é€šè¿‡ä¸€äº›æ—¥å¿—çš„æ‰‹æ®µï¼Œæ˜¯å…¶ä»–æœºå™¨å›å¤è‡³å¯ç”¨ã€‚

### 2.2 åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ

â€‹        æœ‰äº†ä¸Šé¢çš„ç†è®ºåŸºç¡€åï¼Œè¿™é‡Œå¼€å§‹ä»‹ç»å‡ ç§å¸¸è§çš„åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆã€‚

#### 2.2.1 2PC

ä¸¤é˜¶æ®µæäº¤åè®®(Two Phase Commitment Protocol)ä¸­ï¼Œæ¶‰åŠåˆ°ä¸¤ç§è§’è‰²

ä¸€ä¸ªäº‹åŠ¡åè°ƒè€…ï¼ˆcoordinatorï¼‰ï¼šè´Ÿè´£åè°ƒå¤šä¸ªå‚ä¸è€…è¿›è¡Œäº‹åŠ¡æŠ•ç¥¨åŠæäº¤(å›æ»š) å¤šä¸ªäº‹åŠ¡å‚ä¸è€…ï¼ˆparticipantsï¼‰ï¼šå³æœ¬åœ°äº‹åŠ¡æ‰§è¡Œè€…

æ€»å…±å¤„ç†æ­¥éª¤æœ‰ä¸¤ä¸ª 1ï¼‰æŠ•ç¥¨é˜¶æ®µï¼ˆvoting phaseï¼‰ï¼šåè°ƒè€…å°†é€šçŸ¥äº‹åŠ¡å‚ä¸è€…å‡†å¤‡æäº¤æˆ–å–æ¶ˆäº‹åŠ¡ï¼Œç„¶åè¿›å…¥è¡¨å†³è¿‡ç¨‹ã€‚å‚ä¸è€…å°†å‘ŠçŸ¥åè°ƒè€…è‡ªå·±çš„å†³ç­–ï¼šåŒæ„ï¼ˆäº‹åŠ¡å‚ä¸è€…æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œä½†æœªæäº¤ï¼‰æˆ–å–æ¶ˆï¼ˆæœ¬åœ°äº‹åŠ¡æ‰§è¡Œæ•…éšœï¼‰ï¼› 2ï¼‰æäº¤é˜¶æ®µï¼ˆcommit phaseï¼‰ï¼šæ”¶åˆ°å‚ä¸è€…çš„é€šçŸ¥åï¼Œåè°ƒè€…å†å‘å‚ä¸è€…å‘å‡ºé€šçŸ¥ï¼Œæ ¹æ®åé¦ˆæƒ…å†µå†³å®šå„å‚ä¸è€…æ˜¯å¦è¦æäº¤è¿˜æ˜¯å›æ»šï¼›

å¦‚æœæ‰€ç¤º 1-2ä¸ºç¬¬ä¸€é˜¶æ®µï¼Œ2-3ä¸ºç¬¬äºŒé˜¶æ®µ

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503050002033.png)

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503050002909.png)

**ä¼˜ç‚¹ï¼š** å°½é‡ä¿è¯äº†æ•°æ®çš„å¼ºä¸€è‡´ï¼Œé€‚åˆå¯¹æ•°æ®å¼ºä¸€è‡´è¦æ±‚å¾ˆé«˜çš„å…³é”®é¢†åŸŸã€‚

**ç¼ºç‚¹ï¼š** ç‰ºç‰²äº†å¯ç”¨æ€§ï¼Œå¯¹æ€§èƒ½å½±å“è¾ƒå¤§ï¼Œ==ä¸é€‚åˆé«˜å¹¶å‘é«˜æ€§èƒ½åœºæ™¯==ï¼Œå¦‚æœåˆ†å¸ƒå¼ç³»ç»Ÿè·¨æ¥å£è°ƒç”¨ï¼Œç›®å‰ .NET ç•Œè¿˜æ²¡æœ‰å®ç°æ–¹æ¡ˆã€‚

#### 2.2.2 TCC

TCCæ˜¯ä¸€ç§æ¯”è¾ƒæˆç†Ÿçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œå¯ç”¨äºè§£å†³è·¨åº“æ“ä½œçš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼› TCCæ˜¯æœåŠ¡åŒ–çš„ä¸¤é˜¶æ®µç¼–ç¨‹æ¨¡å‹ï¼Œå…¶Tryã€Confirmã€Cancel 3ä¸ªæ–¹æ³•å‡ç”±ä¸šåŠ¡ç¼–ç å®ç°ï¼›

å…¶ä¸­Tryæ“ä½œä½œä¸ºä¸€é˜¶æ®µï¼Œè´Ÿè´£èµ„æºçš„æ£€æŸ¥å’Œé¢„ç•™ï¼Œ

Confirmæ“ä½œä½œä¸ºäºŒé˜¶æ®µæäº¤æ“ä½œï¼Œæ‰§è¡ŒçœŸæ­£çš„ä¸šåŠ¡ï¼Œ

Cancelæ˜¯é¢„ç•™èµ„æºçš„å–æ¶ˆï¼›

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸šåŠ¡å®ç°TCCæœåŠ¡ä¹‹åï¼Œè¯¥TCCæœåŠ¡å°†ä½œä¸ºåˆ†å¸ƒå¼äº‹åŠ¡çš„å…¶ä¸­ä¸€ä¸ªèµ„æºï¼Œå‚ä¸åˆ°æ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ä¸­ï¼›äº‹åŠ¡ç®¡ç†å™¨åˆ†2é˜¶æ®µåè°ƒTCCæœåŠ¡ï¼Œåœ¨ç¬¬ä¸€é˜¶æ®µè°ƒç”¨æ‰€æœ‰TCCæœåŠ¡çš„Tryæ–¹æ³•ï¼Œåœ¨ç¬¬äºŒé˜¶æ®µæ‰§è¡Œæ‰€æœ‰TCCæœåŠ¡çš„Confirmæˆ–è€…Cancelæ–¹æ³•ï¼›

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503050002263.png)

| æ“ä½œæ–¹æ³• | å«ä¹‰                                                         |
| -------- | ------------------------------------------------------------ |
| Try      | é¢„ç•™ä¸šåŠ¡èµ„æº/æ•°æ®æ•ˆéªŒ-å°è¯•æ£€æŸ¥å½“å‰æ“ä½œæ˜¯å¦å¯æ‰§è¡Œ             |
| Confirm  | ç¡®è®¤æ‰§è¡Œä¸šåŠ¡æ“ä½œï¼Œå®é™…æäº¤æ•°æ®ï¼Œä¸åšä»»ä½•ä¸šåŠ¡æ£€æŸ¥ï¼ŒtryæˆåŠŸï¼Œconfirmå¿…å®šæˆåŠŸï¼Œéœ€ä¿è¯å¹‚ç­‰ |
| Cancel   | å–æ¶ˆæ‰§è¡Œä¸šåŠ¡æ“ä½œï¼Œå®é™…å›æ»šæ•°æ®ï¼Œéœ€ä¿è¯å¹‚ç­‰                   |

**ä¼˜ç‚¹ï¼š** è·Ÿ2PCæ¯”èµ·æ¥ï¼Œå®ç°ä»¥åŠæµç¨‹ç›¸å¯¹ç®€å•äº†ä¸€äº›ï¼Œä½†æ•°æ®çš„ä¸€è‡´æ€§æ¯”2PCä¹Ÿè¦å·®ä¸€äº›

**ç¼ºç‚¹ï¼š** ç¼ºç‚¹è¿˜æ˜¯æ¯”è¾ƒæ˜æ˜¾çš„ï¼Œåœ¨2,3æ­¥ä¸­éƒ½æœ‰å¯èƒ½å¤±è´¥ã€‚TCCå±äºåº”ç”¨å±‚çš„ä¸€ç§è¡¥å¿æ–¹å¼ï¼Œæ‰€ä»¥éœ€è¦ç¨‹åºå‘˜åœ¨å®ç°çš„æ—¶å€™å¤šå†™å¾ˆå¤šè¡¥å¿çš„ä»£ç ï¼Œåœ¨ä¸€äº›åœºæ™¯ä¸­ï¼Œä¸€äº›ä¸šåŠ¡æµç¨‹å¯èƒ½ç”¨TCCä¸å¤ªå¥½å®šä¹‰åŠå¤„ç†ã€‚è¿˜å­˜åœ¨éå¹‚ç­‰é—®é¢˜ã€‚

## 3 Seataåˆ†å¸ƒå¼äº‹åŠ¡

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503051656797.png)

### 3.1 Seataä»‹ç»

â€‹        Seata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºåœ¨å¾®æœåŠ¡æ¶æ„ä¸‹æä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚åœ¨ Seata å¼€æºä¹‹å‰ï¼ŒSeata å¯¹åº”çš„å†…éƒ¨ç‰ˆæœ¬åœ¨é˜¿é‡Œç»æµä½“å†…éƒ¨ä¸€ç›´æ‰®æ¼”ç€åˆ†å¸ƒå¼ä¸€è‡´æ€§ä¸­é—´ä»¶çš„è§’è‰²ï¼Œå¸®åŠ©ç»æµä½“å¹³ç¨³çš„åº¦è¿‡å†å¹´çš„åŒ11ï¼Œå¯¹å„BUä¸šåŠ¡è¿›è¡Œäº†æœ‰åŠ›çš„æ”¯æ’‘ã€‚ç»è¿‡å¤šå¹´æ²‰æ·€ä¸ç§¯ç´¯ï¼Œå•†ä¸šåŒ–äº§å“å…ˆååœ¨é˜¿é‡Œäº‘ã€é‡‘èäº‘è¿›è¡Œå”®å–ã€‚

å­¦ä¹ æ–‡æ¡£ï¼šhttps://seata.apache.org/zh-cn/docs/overview/what-is-seata/

Seataç‰¹è‰²åŠŸèƒ½

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503050003120.png)

### 3.2 Seataæ¨¡å¼è®²è§£

â€‹        Seata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºæä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚Seata å°†ä¸ºç”¨æˆ·æä¾›äº† ATã€TCCã€SAGA å’Œ XA äº‹åŠ¡æ¨¡å¼ï¼Œä¸ºç”¨æˆ·æ‰“é€ ä¸€ç«™å¼çš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆã€‚

ç›¸å…³æœ¯è¯­ï¼š

```Plaintext
TC - äº‹åŠ¡åè°ƒè€…
ç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œé©±åŠ¨å…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚

TM - äº‹åŠ¡ç®¡ç†å™¨
å®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ï¼šå¼€å§‹å…¨å±€äº‹åŠ¡ã€æäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡ã€‚

RM - èµ„æºç®¡ç†å™¨
ç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æºï¼Œä¸TCäº¤è°ˆä»¥æ³¨å†Œåˆ†æ”¯äº‹åŠ¡å’ŒæŠ¥å‘Šåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶é©±åŠ¨åˆ†æ”¯äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚
```

#### 3.2.1 ATæ¨¡å¼

å‰æï¼š

```Plaintext
1.åŸºäºæ”¯æŒæœ¬åœ° ACID äº‹åŠ¡çš„å…³ç³»å‹æ•°æ®åº“ã€‚
2.Java åº”ç”¨ï¼Œé€šè¿‡ JDBC è®¿é—®æ•°æ®åº“ã€‚
```

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503051723925.png)

**æ•´ä½“æœºåˆ¶ï¼š**

ä¸¤é˜¶æ®µæäº¤åè®®çš„æ¼”å˜ï¼š

```Plaintext
ä¸€é˜¶æ®µï¼šä¸šåŠ¡æ•°æ®å’Œå›æ»šæ—¥å¿—è®°å½•åœ¨åŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­æäº¤ï¼Œé‡Šæ”¾æœ¬åœ°é”å’Œè¿æ¥èµ„æºã€‚

äºŒé˜¶æ®µï¼š
        æäº¤å¼‚æ­¥åŒ–ï¼Œéå¸¸å¿«é€Ÿåœ°å®Œæˆã€‚
        å›æ»šé€šè¿‡ä¸€é˜¶æ®µçš„å›æ»šæ—¥å¿—è¿›è¡Œåå‘è¡¥å¿ã€‚
```

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503050003165.png)

**å†™éš”ç¦»ï¼ˆ==å†™æ“ä½œï¼Œäº’ç›¸æ²¡æœ‰å¹²æ‰°==ï¼‰ï¼š**

```Plaintext
1.ä¸€é˜¶æ®µæœ¬åœ°äº‹åŠ¡æäº¤å‰ï¼Œéœ€è¦ç¡®ä¿å…ˆæ‹¿åˆ° å…¨å±€é” ã€‚
2.æ‹¿ä¸åˆ° å…¨å±€é” ï¼Œä¸èƒ½æäº¤æœ¬åœ°äº‹åŠ¡ã€‚
3.æ‹¿å…¨å±€é”çš„å°è¯•è¢«é™åˆ¶åœ¨ä¸€å®šèŒƒå›´å†…ï¼Œè¶…å‡ºèŒƒå›´å°†æ”¾å¼ƒï¼Œå¹¶å›æ»šæœ¬åœ°äº‹åŠ¡ï¼Œé‡Šæ”¾æœ¬åœ°é”ã€‚
```

ä»¥ä¸€ä¸ªç¤ºä¾‹æ¥è¯´æ˜ï¼š

ä¸¤ä¸ªå…¨å±€äº‹åŠ¡ tx1 å’Œ tx2ï¼Œåˆ†åˆ«å¯¹ a è¡¨çš„ m å­—æ®µè¿›è¡Œæ›´æ–°æ“ä½œï¼Œm çš„åˆå§‹å€¼ 1000ã€‚

tx1 å…ˆå¼€å§‹ï¼Œå¼€å¯æœ¬åœ°äº‹åŠ¡ï¼Œæ‹¿åˆ°æœ¬åœ°é”ï¼Œæ›´æ–°æ“ä½œ m = 1000 - 100 = 900ã€‚æœ¬åœ°äº‹åŠ¡æäº¤å‰ï¼Œå…ˆæ‹¿åˆ°è¯¥è®°å½•çš„**å…¨å±€é”** ï¼Œæœ¬åœ°æäº¤é‡Šæ”¾æœ¬åœ°é”ã€‚ tx2 åå¼€å§‹ï¼Œå¼€å¯æœ¬åœ°äº‹åŠ¡ï¼Œæ‹¿åˆ°æœ¬åœ°é”ï¼Œæ›´æ–°æ“ä½œ m = 900 - 100 = 800ã€‚æœ¬åœ°äº‹åŠ¡æäº¤å‰ï¼Œå°è¯•æ‹¿è¯¥è®°å½•çš„ **å…¨å±€é”** ï¼Œtx1 å…¨å±€æäº¤å‰ï¼Œè¯¥è®°å½•çš„å…¨å±€é”è¢« tx1 æŒæœ‰ï¼Œtx2 éœ€è¦é‡è¯•ç­‰å¾… **å…¨å±€é”** ã€‚

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503050003322.png)

tx1 äºŒé˜¶æ®µå…¨å±€æäº¤ï¼Œé‡Šæ”¾ **å…¨å±€é”** ã€‚tx2 æ‹¿åˆ° **å…¨å±€é”** æäº¤æœ¬åœ°äº‹åŠ¡ã€‚

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503050003588.png)

å¦‚æœ tx1 çš„äºŒé˜¶æ®µ å…¨å±€å›æ»šï¼Œåˆ™ tx1 éœ€è¦é‡æ–°è·å–è¯¥æ•°æ®çš„æœ¬åœ°é”ï¼Œè¿›è¡Œåå‘è¡¥å¿çš„æ›´æ–°æ“ä½œï¼Œå®ç°åˆ†æ”¯çš„å›æ»šã€‚

æ­¤æ—¶ï¼Œå¦‚æœ tx2 ä»åœ¨ç­‰å¾…è¯¥æ•°æ®çš„ **å…¨å±€é”**ï¼ŒåŒæ—¶æŒæœ‰æœ¬åœ°é”ï¼Œåˆ™ tx1 çš„åˆ†æ”¯å›æ»šä¼šå¤±è´¥ã€‚

==ä¸¤è¾¹éƒ½éœ€è¦è‡ªå·±çš„é”ï¼==

åˆ†æ”¯çš„å›æ»šä¼šä¸€ç›´é‡è¯•ï¼Œç›´åˆ° tx2 çš„ **å…¨å±€é”** ç­‰é”è¶…æ—¶ï¼Œæ”¾å¼ƒ **å…¨å±€é”** å¹¶å›æ»šæœ¬åœ°äº‹åŠ¡==é‡Šæ”¾æœ¬åœ°é”==ï¼Œtx1çš„åˆ†æ”¯å›æ»šæœ€ç»ˆæˆåŠŸã€‚

å› ä¸ºæ•´ä¸ªè¿‡ç¨‹ **å…¨å±€é”** åœ¨ tx1 ç»“æŸå‰ä¸€ç›´æ˜¯è¢« tx1 æŒæœ‰çš„ï¼Œæ‰€ä»¥ä¸ä¼šå‘ç”Ÿ **è„å†™** çš„é—®é¢˜ã€‚

å†æ¬¡æ¥å›é¡¾ä¸€ä¸‹ï¼š

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503052122863.png)



**è¯»éš”ç¦»ï¼š**

åœ¨æ•°æ®åº“æœ¬åœ°äº‹åŠ¡éš”ç¦»çº§åˆ« **è¯»å·²æäº¤ï¼ˆRead Committedï¼‰** æˆ–ä»¥ä¸Šçš„åŸºç¡€ä¸Šï¼ŒSeataï¼ˆAT æ¨¡å¼ï¼‰çš„é»˜è®¤å…¨å±€éš”ç¦»çº§åˆ«æ˜¯ **è¯»æœªæäº¤ï¼ˆRead Uncommittedï¼‰**ã€‚

ä»€ä¹ˆæ˜¯è¯»å·²æäº¤ï¼Œè¯»æœªæäº¤å‘¢ï¼Ÿ

> è¿™é‡Œåšä¸ªå°ç§‘æ™®ï¼š
>
> ### **1. è¯»æœªæäº¤ï¼ˆRead Uncommittedï¼‰**
>
> **å¤§ç™½è¯ï¼š**
> åˆ«äººå†™å…¥çš„æ•°æ®**è¿˜æ²¡æäº¤ï¼Œä½ å°±èƒ½çœ‹åˆ°äº†**ï¼Œä½†è¿™äº›æ•°æ®å¯èƒ½**ä¼šè¢«å›æ»š**ï¼Œä½ è¯»åˆ°çš„æ•°æ®å¯èƒ½æ˜¯å‡çš„ï¼Œå«åš**è„è¯»ï¼ˆDirty Readï¼‰**ã€‚
>
> **ä¾‹å­ï¼š**
>
> 1. å¼ ä¸‰æ‰“å¼€äº†ä¸€æœ¬è´¦æœ¬ï¼ˆå¼€å§‹ä¸€ä¸ªäº‹åŠ¡ï¼‰ã€‚
> 2. æå››æ­£åœ¨æ”¹è´¦æœ¬çš„ä½™é¢ï¼Œä» 100 æ”¹æˆ 200ï¼ˆä½†è¿˜æ²¡æäº¤ï¼‰ã€‚
> 3. å¼ ä¸‰çœ‹äº†ä¸€çœ¼ï¼Œå‘ç°ä½™é¢æ˜¯ 200ï¼Œè®°ä¸‹æ¥äº†ã€‚
> 4. æå››çªç„¶**åæ‚”äº†ï¼Œå›æ»š**ï¼ˆæ’¤é”€ä¿®æ”¹ï¼‰ã€‚
> 5. ä½†å¼ ä¸‰å·²ç»æŠŠ 200 è®°åˆ°è‡ªå·±çš„æœ¬å­ä¸Šäº†ï¼Œç„¶è€ŒçœŸæ­£çš„ä½™é¢è¿˜æ˜¯ 100ã€‚
>
> **é—®é¢˜ï¼š**
> å¼ ä¸‰è¯»åˆ°äº†ä¸€ä¸ªä¸å­˜åœ¨çš„æ•°æ®ï¼Œè¿™å°±æ˜¯â€œè„è¯»â€ã€‚
>
> ------
>
> ### **2. è¯»å·²æäº¤ï¼ˆRead Committedï¼‰**
>
> **å¤§ç™½è¯ï¼š**
> åˆ«äººä¿®æ”¹çš„æ•°æ®**å¿…é¡»æäº¤äº†ï¼Œä½ æ‰èƒ½çœ‹åˆ°**ï¼Œä¸ä¼šå‡ºç°â€œè„è¯»â€ï¼Œä½†æ˜¯å¯èƒ½ä¼š**åå¤è¯»å–åˆ°ä¸åŒçš„æ•°æ®**ï¼Œå«åš**ä¸å¯é‡å¤è¯»ï¼ˆNon-repeatable Readï¼‰**ã€‚
>
> **ä¾‹å­ï¼š**
>
> 1. å¼ ä¸‰æ‰“å¼€ä¸€æœ¬è´¦æœ¬ï¼ˆå¼€å§‹ä¸€ä¸ªäº‹åŠ¡ï¼‰ã€‚
> 2. è¿™æ—¶æå››ä¿®æ”¹äº†ä½™é¢ï¼Œä» 100 æ”¹æˆ 200ï¼Œå¹¶**æäº¤**äº†ã€‚
> 3. å¼ ä¸‰æŸ¥äº†ä¸€æ¬¡ä½™é¢ï¼Œçœ‹åˆ°æ˜¯ 200ã€‚
> 4. è¿‡äº†ä¸€ä¼šï¼Œæå››åˆæ”¹äº†ä¸€æ¬¡ä½™é¢ï¼Œä» 200 æ”¹æˆ 300ï¼Œå¹¶**æäº¤**äº†ã€‚
> 5. å¼ ä¸‰å†æŸ¥ä¸€æ¬¡ä½™é¢ï¼Œçœ‹åˆ°å˜æˆ 300 äº†ã€‚
>
> **é—®é¢˜ï¼š**
> åŒæ ·çš„æŸ¥è¯¢ï¼Œåœ¨åŒä¸€ä¸ªäº‹åŠ¡é‡Œï¼Œè¯»åˆ°çš„å€¼**ä¸ä¸€æ ·**ï¼Œæ•°æ®ä¸ç¨³å®šï¼Œè¿™å°±æ˜¯â€œä¸å¯é‡å¤è¯»â€ã€‚

å¦‚æœåº”ç”¨åœ¨ç‰¹å®šåœºæ™¯ä¸‹ï¼Œå¿…éœ€è¦æ±‚å…¨å±€çš„ **è¯»å·²æäº¤** ï¼Œç›®å‰ Seata çš„æ–¹å¼æ˜¯é€šè¿‡ SELECT FOR UPDATE è¯­å¥çš„ä»£ç†ã€‚

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503050003659.png)

SELECT FOR UPDATE è¯­å¥çš„æ‰§è¡Œä¼šç”³è¯· **å…¨å±€é”** ï¼Œå¦‚æœ **å…¨å±€é”** è¢«å…¶ä»–äº‹åŠ¡æŒæœ‰ï¼Œåˆ™é‡Šæ”¾æœ¬åœ°é”ï¼ˆå›æ»š SELECT FOR UPDATE è¯­å¥çš„æœ¬åœ°æ‰§è¡Œï¼‰å¹¶é‡è¯•ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒæŸ¥è¯¢æ˜¯è¢« block ä½çš„ï¼Œç›´åˆ° **å…¨å±€é”** æ‹¿åˆ°ï¼Œå³è¯»å–çš„ç›¸å…³æ•°æ®æ˜¯ **å·²æäº¤** çš„ï¼Œæ‰è¿”å›ã€‚

ä»€ä¹ˆæ„æ€å‘¢

:::tip

**å¤§ç™½è¯è§£é‡Š**

1. **é»˜è®¤æ˜¯â€œè¯»æœªæäº¤â€**
   - Seata AT æ¨¡å¼é»˜è®¤å…è®¸ä¸€ä¸ªäº‹åŠ¡**è¯»åˆ°å¦ä¸€ä¸ªäº‹åŠ¡å°šæœªæäº¤çš„ä¿®æ”¹**ï¼ˆå¯èƒ½æ˜¯é”™è¯¯æ•°æ®ï¼‰ã€‚
   - è¿™æ„å‘³ç€ï¼Œä½ å¯èƒ½ä¼šè¯»åˆ°ä¸€ä¸ªäº‹åŠ¡**è¿˜æ²¡æäº¤**çš„æ•°æ®ï¼Œä½†è¿™ä¸ªäº‹åŠ¡æœ€ç»ˆå¯èƒ½ä¼š**å›æ»š**ï¼Œå¯¼è‡´ä½ è¯»åˆ°çš„æ•°æ®å¤±æ•ˆã€‚
2. **å¦‚æœä½ æƒ³è¦â€œè¯»å·²æäº¤â€**ï¼ˆç¡®ä¿åªèƒ½è¯»åˆ°å·²ç»æäº¤çš„æ•°æ®ï¼‰
   - ä½ éœ€è¦åœ¨æŸ¥è¯¢æ—¶åŠ ä¸Š **`SELECT FOR UPDATE`**ã€‚
   - è¿™ä¸ªè¯­å¥çš„ä½œç”¨æ˜¯ï¼š**é”ä½è¿™æ¡æ•°æ®ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡ä¿®æ”¹**ã€‚
3. **å…¨å±€é”çš„ä½œç”¨**
   - **æŸ¥è¯¢çš„æ—¶å€™ç”³è¯·â€œå…¨å±€é”â€**ï¼Œè¿™ä¸ªé”ç›¸å½“äºå¯¹æ•°æ®åŠ äº†â€œé—¨é—©â€ï¼Œè®©å…¶ä»–äº‹åŠ¡**ä¸èƒ½ä¿®æ”¹**è¿™æ¡æ•°æ®ã€‚
   - **å¦‚æœåˆ«äººå·²ç»åŠ äº†é”**ï¼Œä½ çš„æŸ¥è¯¢ä¼š**ç­‰ç€**ï¼Œç›´åˆ°åˆ«äººé‡Šæ”¾é”ï¼Œä½ æ‰èƒ½ç»§ç»­ã€‚
   - **å¦‚æœåŠ é”å¤±è´¥äº†**ï¼ˆæ¯”å¦‚åˆ«äººä¸€ç›´å ç€ï¼‰ï¼Œä½ çš„äº‹åŠ¡ä¼šé‡è¯•ã€‚

**æ‰“ä¸ªæ¯”æ–¹**

å‡è®¾ä½ å’Œæœ‹å‹å»é“¶è¡Œå–é’±ï¼š

- **é»˜è®¤ Seata AT è¯»æœªæäº¤ï¼ˆå¯èƒ½æœ‰é—®é¢˜ï¼‰**
  ä½ é—®é“¶è¡Œï¼šâ€œæˆ‘è´¦æˆ·é‡Œæœ‰å¤šå°‘é’±ï¼Ÿâ€
  - è¿™æ—¶ï¼Œé“¶è¡Œç³»ç»Ÿæ­£åœ¨æ›´æ–°ä½ çš„ä½™é¢ï¼ŒæŠŠ 1000 å…ƒæ”¹æˆ 5000 å…ƒï¼Œä½†è¿˜æ²¡æäº¤ã€‚
  - ä½ æŸ¥è¯¢æ—¶ï¼Œé“¶è¡Œå‘Šè¯‰ä½ ä½™é¢æ˜¯ 5000 å…ƒã€‚
  - ä½†ç³»ç»Ÿåˆ**å›æ»šäº†**ï¼Œä½ çš„çœŸå®ä½™é¢è¿˜æ˜¯ 1000 å…ƒã€‚
  - ä½ æœ¬ä»¥ä¸ºæœ‰ 5000ï¼Œå¯ä»¥èŠ±é’±äº†ï¼Œç»“æœé’±æ ¹æœ¬ä¸å­˜åœ¨ï¼ğŸ’¥ **è„è¯»ï¼**
- **ç”¨ `SELECT FOR UPDATE` è®©å®ƒå˜æˆâ€œè¯»å·²æäº¤â€**
  ä½ å»é“¶è¡Œé—®ï¼šâ€œæˆ‘è´¦æˆ·é‡Œæœ‰å¤šå°‘é’±ï¼Ÿâ€ï¼ˆä½†è¿™æ¬¡ä½ è¦æ±‚é“¶è¡Œ**é”ä½è¿™ç¬”æŸ¥è¯¢**ï¼‰
  - è¿™æ—¶ï¼Œé“¶è¡Œå‘ç°å¦ä¸€ä¸ªå‘˜å·¥æ­£åœ¨æ›´æ–°ä½ çš„ä½™é¢ï¼Œå®ƒè®©ä½ **ç­‰ä¸€ä¼šå„¿**ã€‚
  - ç›´åˆ°ä½™é¢ä¿®æ”¹å®Œæˆå¹¶æäº¤äº†ï¼Œé“¶è¡Œæ‰å‘Šè¯‰ä½ çœŸå®ä½™é¢æ˜¯å¤šå°‘ã€‚
  - è¿™æ ·ï¼Œä½ å°±ä¸ä¼šè¯»åˆ°**é”™è¯¯æ•°æ®**äº†ã€‚

:::

å‡ºäºæ€»ä½“æ€§èƒ½ä¸Šçš„è€ƒè™‘ï¼ŒSeata ç›®å‰çš„æ–¹æ¡ˆå¹¶æ²¡æœ‰å¯¹æ‰€æœ‰ SELECT è¯­å¥éƒ½è¿›è¡Œä»£ç†ï¼Œä»…é’ˆå¯¹ FOR UPDATE çš„ SELECT è¯­å¥ã€‚

#### 3.2.2 TCCæ¨¡å¼

å›é¡¾æ€»è§ˆä¸­çš„æè¿°ï¼šä¸€ä¸ªåˆ†å¸ƒå¼çš„å…¨å±€äº‹åŠ¡ï¼Œæ•´ä½“æ˜¯ **ä¸¤é˜¶æ®µæäº¤** çš„æ¨¡å‹ã€‚å…¨å±€äº‹åŠ¡æ˜¯ç”±è‹¥å¹²åˆ†æ”¯äº‹åŠ¡ç»„æˆçš„ï¼Œåˆ†æ”¯äº‹åŠ¡è¦æ»¡è¶³ **ä¸¤é˜¶æ®µæäº¤** çš„æ¨¡å‹è¦æ±‚ï¼Œå³éœ€è¦æ¯ä¸ªåˆ†æ”¯äº‹åŠ¡éƒ½å…·å¤‡è‡ªå·±çš„ï¼š

- ä¸€é˜¶æ®µ prepare è¡Œä¸º
- äºŒé˜¶æ®µ commit æˆ– rollback è¡Œä¸º

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503050003037.png)

æ ¹æ®ä¸¤é˜¶æ®µè¡Œä¸ºæ¨¡å¼çš„ä¸åŒï¼Œæˆ‘ä»¬å°†åˆ†æ”¯äº‹åŠ¡åˆ’åˆ†ä¸º **Automatic (Branch) Transaction Mode** å’Œ **Manual (Branch) Transaction Mode**.

AT æ¨¡å¼ï¼ŒåŸºäº ==**æ”¯æŒæœ¬åœ° ACID äº‹åŠ¡**== çš„ **å…³ç³»å‹æ•°æ®åº“**ï¼š

- ä¸€é˜¶æ®µ prepare è¡Œä¸ºï¼šåœ¨æœ¬åœ°äº‹åŠ¡ä¸­ï¼Œä¸€å¹¶æäº¤ä¸šåŠ¡æ•°æ®æ›´æ–°å’Œç›¸åº”å›æ»šæ—¥å¿—è®°å½•ã€‚
- äºŒé˜¶æ®µ commit è¡Œä¸ºï¼šé©¬ä¸ŠæˆåŠŸç»“æŸï¼Œ==**è‡ªåŠ¨**== å¼‚æ­¥æ‰¹é‡æ¸…ç†å›æ»šæ—¥å¿—ã€‚
- äºŒé˜¶æ®µ rollback è¡Œä¸ºï¼šé€šè¿‡å›æ»šæ—¥å¿—ï¼Œ==**è‡ªåŠ¨**== ç”Ÿæˆè¡¥å¿æ“ä½œï¼Œå®Œæˆæ•°æ®å›æ»šã€‚

ç›¸åº”çš„ï¼ŒTCC æ¨¡å¼ï¼Œä¸ä¾èµ–äºåº•å±‚æ•°æ®èµ„æºçš„äº‹åŠ¡æ”¯æŒï¼š

- ä¸€é˜¶æ®µ prepare è¡Œä¸ºï¼šè°ƒç”¨ **è‡ªå®šä¹‰** çš„ prepare é€»è¾‘ã€‚
- äºŒé˜¶æ®µ commit è¡Œä¸ºï¼šè°ƒç”¨ **è‡ªå®šä¹‰** çš„ commit é€»è¾‘ã€‚
- äºŒé˜¶æ®µ rollback è¡Œä¸ºï¼šè°ƒç”¨ **è‡ªå®šä¹‰** çš„ rollback é€»è¾‘ã€‚

æ‰€è°“ TCC æ¨¡å¼ï¼Œæ˜¯æŒ‡æ”¯æŒæŠŠ ==**è‡ªå®šä¹‰**== çš„åˆ†æ”¯äº‹åŠ¡çº³å…¥åˆ°å…¨å±€äº‹åŠ¡çš„ç®¡ç†ä¸­ã€‚

#### 3.2.3 Sagaæ¨¡å¼

Sagaæ¨¡å¼æ˜¯Seataæä¾›çš„==é•¿äº‹åŠ¡==è§£å†³æ–¹æ¡ˆï¼Œåœ¨Sagaæ¨¡å¼ä¸­ï¼Œä¸šåŠ¡æµç¨‹ä¸­æ¯ä¸ªå‚ä¸è€…éƒ½æäº¤æœ¬åœ°äº‹åŠ¡ï¼Œå½“å‡ºç°æŸä¸€ä¸ªå‚ä¸è€…å¤±è´¥åˆ™è¡¥å¿å‰é¢å·²ç»æˆåŠŸçš„å‚ä¸è€…ï¼Œä¸€é˜¶æ®µæ­£å‘æœåŠ¡å’ŒäºŒé˜¶æ®µè¡¥å¿æœåŠ¡éƒ½ç”±ä¸šåŠ¡å¼€å‘å®ç°ã€‚

:::info

ç®€å•æ¥è¯´ï¼Œè°åšçš„äº‹ï¼Œè°ä¼šæ»šçš„æ—¶å€™å°±æŠŠè‡ªå·±çš„äº‹æå¹²å‡€ï¼Œå¦‚æœæ¯ä¸ªäººéƒ½èƒ½å°†è‡ªå·±äº‹å›æ»šå®Œæˆï¼Œé‚£ä¹ˆæ•°æ®æœ€ç»ˆä¼šè¿˜åŸï¼

:::

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503050003315.png)

**ä½¿ç”¨åœºæ™¯ï¼š**

- ä¸šåŠ¡æµç¨‹é•¿ã€ä¸šåŠ¡æµç¨‹å¤š
- å‚ä¸è€…åŒ…å«å…¶å®ƒå…¬å¸æˆ–é—ç•™ç³»ç»ŸæœåŠ¡ï¼Œæ— æ³•æä¾› TCC æ¨¡å¼è¦æ±‚çš„ä¸‰ä¸ªæ¥å£

**ä¼˜åŠ¿ï¼š**

- ä¸€é˜¶æ®µæäº¤æœ¬åœ°äº‹åŠ¡ï¼Œæ— é”ï¼Œé«˜æ€§èƒ½
- äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œå‚ä¸è€…å¯å¼‚æ­¥æ‰§è¡Œï¼Œé«˜åå
- è¡¥å¿æœåŠ¡æ˜“äºå®ç°ï¼ˆ==ç›®å‰çœŸå¬ä¸æ‡‚ï¼Œå“ˆå“ˆå“ˆ==ï¼‰

**ç¼ºç‚¹ï¼š**

- ä¸ä¿è¯éš”ç¦»æ€§

### 3.3 æŠ¢å•åˆ†å¸ƒå¼äº‹åŠ¡å®ç°

â€‹        ==éçƒ­ç‚¹å•†å“==æŠ¢å•çš„æ—¶å€™ï¼Œè¿™é‡Œé‡‡ç”¨Seataåˆ†å¸ƒå¼äº‹åŠ¡æ§åˆ¶åº“å­˜å‡å°‘ï¼Œå½“åº“å­˜é€’å‡æˆåŠŸçš„æ—¶å€™ï¼Œæ‰§è¡Œåˆ›å»ºè®¢å•ï¼Œå½“åº“å­˜å‡å°‘å¤±è´¥çš„æ—¶å€™ï¼Œä¸æ‰§è¡Œåˆ›å»ºè®¢å•ã€‚

ä½†æœ‰å¯èƒ½å­˜åœ¨è¿™ä¹ˆä¸€ç§ç°è±¡ï¼Œåº“å­˜å‡å°‘æˆåŠŸäº†ï¼Œä½†åˆ›å»ºè®¢å•å¤±è´¥äº†ï¼Œæ­¤æ—¶éœ€è¦å›æ»šåº“å­˜ï¼Œè¿™æ—¶éœ€è¦è·¨åº”ç”¨ç®¡ç†äº‹åŠ¡ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨Seataå®ç°ã€‚

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503050003571.png)

æ²¡æ”¹ä¹‹å‰çš„æƒ…å†µ

ç¨‹åºé‡Œæ•…æ„åˆ¶é€ ä¸€ä¸ªé”™è¯¯

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503052331712.png)

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503052326928.png)

æ­¤æ—¶ä¸‹å•å‡ºç°é”™è¯¯

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060054297.png)

ä½†è¿˜æ˜¯å‘ç”Ÿäº†æ‰£å‡

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060056052.png)

ä½†æ˜¯è®¢å•æ²¡æœ‰åˆ›å»ºæˆåŠŸï¼Œè¿˜æ˜¯ä»¥å‰çš„æ•°æ®

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060057765.png)

æ‰€ä»¥å¾—å¼•å…¥åˆ†å¸ƒå¼äº‹åŠ¡æ¥ä¿®æ”¹bugï¼

#### 3.3.1 åˆ†å¸ƒå¼äº‹åŠ¡å®ç°

Seataåˆ†å¸ƒå¼äº‹åŠ¡å®ç°ï¼Œåˆ†å¦‚ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

```Plaintext
1.åœ¨æ¯ä¸ªéœ€è¦æ§åˆ¶åˆ†å¸ƒå¼äº‹åŠ¡çš„æ•°æ®åº“ä¸­æ·»åŠ æ—¥å¿—è¡¨undo_log
2.å®‰è£…TC
3.é…ç½®æ•°æ®æº-ä»£ç†æ•°æ®æº
4.é…ç½®å¾®æœåŠ¡ä¸Seataçš„TCäº¤äº’ä¿¡æ¯ä»¥åŠæ³¨å†Œåœ°å€
5.ä½¿ç”¨å…¨å±€åˆ†å¸ƒå¼äº‹åŠ¡çš„æ–¹æ³•ä¸Šæ·»åŠ æ³¨è§£@GlobalTransactional
```

1)æ—¥å¿—è¡¨æ·»åŠ 

åœ¨`seckill-goods`å’Œ`seckill-order`æ•°æ®åº“ä¸­æ·»åŠ æ—¥å¿—è¡¨ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```SQL
CREATE TABLE `undo_log` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `branch_id` bigint(20) NOT NULL,
  `xid` varchar(100) NOT NULL,
  `context` varchar(128) NOT NULL,
  `rollback_info` longblob NOT NULL,
  `log_status` int(11) NOT NULL,
  `log_created` datetime NOT NULL,
  `log_modified` datetime NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;
```

2)å®‰è£…TC

æˆ‘ä»¬è¿™é‡Œé‡‡ç”¨Dockerå®‰è£…ï¼Œå®‰è£…å‘½ä»¤å¦‚ä¸‹ï¼š

```Plaintext
docker run -d --name seata-server -p 8191:8191 -e SEATA_PORT=8191 seataio/seata-server:1.4.1
```

3)é…ç½®æ•°æ®æº

åœ¨éœ€è¦æ‰§è¡Œåˆ†å¸ƒå¼äº‹åŠ¡æ§åˆ¶çš„å·¥ç¨‹`seckill-seata`çš„`pom.xml`ä¸­æ·»åŠ å¦‚ä¸‹ä¾èµ–ï¼š

```XML
<!--Seata-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
</dependency>
```

åœ¨`seckill-seata`ä¸­æ·»åŠ é…ç½®ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
@Configuration
public class DataSourceConfig {

    /**
     * 1.é…ç½®DataSource
     */
    @Bean
    @ConfigurationProperties(prefix = "spring.datasource")
    public DruidDataSource dataSource(){
        return new DruidDataSource();
    }

    /**
     * 2.é…ç½®ä»£ç†æ•°æ®æº
     */
    @Bean
    public DataSourceProxy dataSourceProxy(DruidDataSource dataSource){
        return new DataSourceProxy(dataSource);
    }

    /**
     * 3.æŒä¹…å±‚ç”¨çš„æ˜¯MyBatis
     *   SqlSessionFactoryéœ€è¦æ³¨å…¥DataSourceï¼Œå°†æ³¨å…¥çš„DataSourceæ¢æˆä»£ç†æ•°æ®æº
     */
    @Bean
    public SqlSessionFactory sqlSessionFactory(DataSourceProxy dataSourceProxy) throws Exception {
        SqlSessionFactoryBean sqlSessionFactoryBean = new SqlSessionFactoryBean();
        sqlSessionFactoryBean.setDataSource(dataSourceProxy);
        return sqlSessionFactoryBean.getObject();
    }
}
```

4)é…ç½®æ³¨å†Œä¿¡æ¯

åœ¨`seckill-seata`ä¸­æ·»åŠ æ–‡ä»¶`registry.conf`ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```Properties
registry {
  # file ã€nacos ã€eurekaã€redisã€zkã€consulã€etcd3ã€sofa
  type = "file"

  file {
    name = "file.conf"
  }
}

config {
  # fileã€nacos ã€apolloã€zkã€consulã€etcd3
  type = "file"

  file {
    name = "file.conf"
  }
}
```

åœ¨`seckill-seata`ä¸­æ·»åŠ æ–‡ä»¶`file.conf`ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```Properties
transport {
  # tcp udt unix-domain-socket
  type = "TCP"
  #NIO NATIVE
  server = "NIO"
  #enable heartbeat
  heartbeat = true
  #thread factory for netty
  thread-factory {
    boss-thread-prefix = "NettyBoss"
    worker-thread-prefix = "NettyServerNIOWorker"
    server-executor-thread-prefix = "NettyServerBizHandler"
    share-boss-worker = false
    client-selector-thread-prefix = "NettyClientSelector"
    client-selector-thread-size = 1
    client-worker-thread-prefix = "NettyClientWorkerThread"
    # netty boss thread size,will not be used for UDT
    boss-thread-size = 1
    #auto default pin or 8
    worker-thread-size = 8
  }
  shutdown {
    # when destroy server, wait seconds
    wait = 3
  }
  serialization = "seata"
  compressor = "none"
}
service {
  #vgroup->rgroup
  vgroup_mapping.seata_seckill_transaction = "default"
  #only support single node
  default.grouplist = "seata-server:8191"
  #degrade current not support
  enableDegrade = false
  #disable
  disable = false
  #unit ms,s,m,h,d represents milliseconds, seconds, minutes, hours, days, default permanent
  max.commit.retry.timeout = "-1"
  max.rollback.retry.timeout = "-1"
}

client {
  async.commit.buffer.limit = 10000
  lock {
    retry.internal = 10
    retry.times = 30
  }
  report.retry.count = 5
}

## transaction log store
store {
  ## store mode: fileã€db
  mode = "file"

  ## file store
  file {
    dir = "sessionStore"

    # branch session size , if exceeded first try compress lockkey, still exceeded throws exceptions
    max-branch-session-size = 16384
    # globe session size , if exceeded throws exceptions
    max-global-session-size = 512
    # file buffer size , if exceeded allocate new buffer
    file-write-buffer-cache-size = 16384
    # when recover batch read size
    session.reload.read_size = 100
    # async, sync
    flush-disk-mode = async
  }
}
lock {
  ## the lock store mode: localã€remote
  mode = "remote"
  remote {
    ## store locks in the seata's server
  }
}
recovery {
  committing-retry-delay = 30
  asyn-committing-retry-delay = 30
  rollbacking-retry-delay = 30
  timeout-retry-delay = 30
}

transaction {
  undo.data.validation = true
  undo.log.serialization = "jackson"
}

## metrics settings
metrics {
  enabled = false
  registry-type = "compact"
  # multi exporters use comma divided
  exporter-list = "prometheus"
  exporter-prometheus-port = 9898
}
```

5)é…ç½®äº‹åŠ¡åˆ†ç»„ä¿¡æ¯

åœ¨`seckill-goods`å’Œ`seckill-order`çš„pom.xmlä¸­æ·»å¦‚ä¸‹ä¾èµ–ï¼š

```XML
<dependency>
    <groupId>com.seckill</groupId>
    <artifactId>seckill-seata</artifactId>
    <version>0.0.1-SNAPSHOT</version>
</dependency>
```

åœ¨`seckill-goods`å’Œ`seckill-order`çš„bootstrap.ymlä¸­æ·»å¦‚ä¸‹ä»£ç ï¼š

```YAML
spring:
  cloud:
    alibaba:
      seata:
        tx-service-group: seata_seckill_transaction
```

6)æ–¹æ³•å¼€å¯å…¨å±€äº‹åŠ¡

åœ¨`seckill-order`çš„`com.seckill.order.service.impl.OrderServiceImpl#add`ä¸Š`@GlobalTransactional`å…¨å±€äº‹åŠ¡æ³¨è§£ï¼Œä»£ç å¦‚ä¸‹ï¼š

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503050003324.png)

#### 3.3.2 å…¨å±€å¼‚å¸¸å¤„ç†

æ­¤æ—¶éœ€è¦åˆ›å»ºä¸€ä¸ªå…¨å±€å¼‚å¸¸å¤„ç†å™¨æ¥å¤„ç†è¯¥é—®é¢˜ï¼Œåˆ›å»º`com.seckill.order.controller.BaseExceptionHandler`,ä»£ç å¦‚ä¸‹ï¼š

```Java
@Slf4j
@ControllerAdvice   //æ‰€æœ‰è¯·æ±‚è·¯å¾„ï¼Œéƒ½å°†è¢«è¯¥ç±»å¤„ç†->è¿‡æ»¤å™¨/(æ‹¦æˆªå™¨)
public class BaseExceptionHandler {

    /**
     * å¼‚å¸¸å¤„ç†
     * å½“å‰è¯·æ±‚å‘ç”Ÿäº†æŒ‡å®šå¼‚å¸¸ï¼Œåˆ™æ‰§è¡Œè¯¥æ–¹æ³•å¤„ç†å¼‚å¸¸
     */
    @ExceptionHandler(Exception.class)
    @ResponseBody
    public Result error(Exception ex){
        StringWriter stringWriter = new StringWriter();
        PrintWriter writer = new PrintWriter(stringWriter);
        ex.printStackTrace(writer);
        ex.printStackTrace();
        log.error(stringWriter.toString());
        return new Result(false, StatusCode.ERROR,ex.getMessage(),stringWriter.toString());
    }
}
```

æ­¤æ—¶å¼‚å¸¸ä¿¡æ¯å¦‚ä¸‹ï¼š

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060120157.png)

æ•°æ®åº“è¿˜æ˜¯1000æ²¡æœ‰å˜

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060146489.png)

è®¢å•è¡¨æ²¡æœ‰å˜åŒ–ï¼ŒæˆåŠŸï¼

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060147840.png)

## 4 WebSocketï¼ˆé€šçŸ¥ç”¨æˆ·æŠ¢å•æˆåŠŸï¼‰

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060151232.png)

â€‹        ç›®å‰ç”¨æˆ·æŠ¢å•æ“ä½œå·²ç»å®Œæˆï¼Œæ— è®ºæ˜¯éçƒ­ç‚¹å•†å“è¿˜æ˜¯çƒ­ç‚¹å•†å“æŠ¢å•ï¼ŒæŠ¢å•å®Œæˆåï¼Œæˆ‘ä»¬åº”è¯¥è¦é€šçŸ¥ç”¨æˆ·æŠ¢å•çŠ¶æ€ï¼Œéçƒ­ç‚¹å•†å“å¯ä»¥ç›´æ¥å“åº”æŠ¢å•ç»“æœï¼Œä½†çƒ­ç‚¹å•†å“ç›®å‰è¿˜æ²¡æœ‰å®ç°é€šçŸ¥å“åº”ï¼Œé€šçŸ¥ç”¨æˆ·æŠ¢å•çŠ¶æ€ç”¨æˆ·å¯ä»¥é€šè¿‡é¡µé¢å®šæ—¶å‘åå°å‘å‡ºè¯·æ±‚æŸ¥è¯¢å®ç°ï¼Œä½†è¿™ç§çŸ­è¿æ¥æ–¹å¼æ•ˆç‡ä½ï¼Œä¼šå’ŒæœåŠ¡å™¨è¿›è¡Œå¤šæ¬¡é€šä¿¡ï¼Œè¿™å—æˆ‘ä»¬å¯ä»¥ä½¿ç”¨é•¿è¿æ¥websocketå®ç°ã€‚

### 4.1 WebSocketä»‹ç»

WebSocket æ˜¯ HTML5 å¼€å§‹æä¾›çš„ä¸€ç§åœ¨å•ä¸ª TCP è¿æ¥ä¸Šè¿›è¡Œå…¨åŒå‘é€šè®¯çš„åè®®ã€‚

WebSocket ä½¿å¾—å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®äº¤æ¢å˜å¾—æ›´åŠ ç®€å•ï¼Œå…è®¸æœåŠ¡ç«¯ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ã€‚åœ¨ WebSocket API ä¸­ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨åªéœ€è¦å®Œæˆä¸€æ¬¡æ¡æ‰‹ï¼Œä¸¤è€…ä¹‹é—´å°±ç›´æ¥å¯ä»¥åˆ›å»ºæŒä¹…æ€§çš„è¿æ¥ï¼Œå¹¶è¿›è¡ŒåŒå‘æ•°æ®ä¼ è¾“ã€‚

ç°åœ¨ï¼Œå¾ˆå¤šç½‘ç«™ä¸ºäº†å®ç°æ¨é€æŠ€æœ¯ï¼Œæ‰€ç”¨çš„æŠ€æœ¯éƒ½æ˜¯ Ajax è½®è¯¢ã€‚è½®è¯¢æ˜¯åœ¨ç‰¹å®šçš„çš„æ—¶é—´é—´éš”ï¼ˆå¦‚æ¯1ç§’ï¼‰ï¼Œç”±æµè§ˆå™¨å¯¹æœåŠ¡å™¨å‘å‡ºHTTPè¯·æ±‚ï¼Œç„¶åç”±æœåŠ¡å™¨è¿”å›æœ€æ–°çš„æ•°æ®ç»™å®¢æˆ·ç«¯çš„æµè§ˆå™¨ã€‚è¿™ç§ä¼ ç»Ÿçš„æ¨¡å¼å¸¦æ¥å¾ˆæ˜æ˜¾çš„ç¼ºç‚¹ï¼Œå³æµè§ˆå™¨éœ€è¦ä¸æ–­çš„å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œç„¶è€ŒHTTPè¯·æ±‚å¯èƒ½åŒ…å«è¾ƒé•¿çš„å¤´éƒ¨ï¼Œå…¶ä¸­çœŸæ­£æœ‰æ•ˆçš„æ•°æ®å¯èƒ½åªæ˜¯å¾ˆå°çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¾ç„¶è¿™æ ·ä¼šæµªè´¹å¾ˆå¤šçš„å¸¦å®½ç­‰èµ„æºã€‚

HTML5 å®šä¹‰çš„ WebSocket åè®®ï¼Œèƒ½æ›´å¥½çš„èŠ‚çœæœåŠ¡å™¨èµ„æºå’Œå¸¦å®½ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ›´å®æ—¶åœ°è¿›è¡Œé€šè®¯ã€‚

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060155011.png)

æµè§ˆå™¨é€šè¿‡ JavaScript å‘æœåŠ¡å™¨å‘å‡ºå»ºç«‹ WebSocket è¿æ¥çš„è¯·æ±‚ï¼Œè¿æ¥å»ºç«‹ä»¥åï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯å°±å¯ä»¥é€šè¿‡ TCP è¿æ¥ç›´æ¥äº¤æ¢æ•°æ®ã€‚

å½“ä½ è·å– WebSocket è¿æ¥åï¼Œä½ å¯ä»¥é€šè¿‡ **send()** æ–¹æ³•æ¥å‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼Œå¹¶é€šè¿‡ **onmessage** äº‹ä»¶æ¥æ¥æ”¶æœåŠ¡å™¨è¿”å›çš„æ•°æ®ã€‚

### 4.2 Websocket API

åˆ›å»º WebSocket å¯¹è±¡ï¼š

```Plaintext
var socket = new WebSocket(url, [protocol] );
```

**WebSocketå±æ€§ï¼š**

| å±æ€§                  | æè¿°                                                         |
| --------------------- | ------------------------------------------------------------ |
| socket.readyState     | åªè¯»å±æ€§ **readyState** è¡¨ç¤ºè¿æ¥çŠ¶æ€ï¼Œå¯ä»¥æ˜¯ä»¥ä¸‹å€¼ï¼š0 - è¡¨ç¤ºè¿æ¥å°šæœªå»ºç«‹ã€‚1 - è¡¨ç¤ºè¿æ¥å·²å»ºç«‹ï¼Œå¯ä»¥è¿›è¡Œé€šä¿¡ã€‚2 - è¡¨ç¤ºè¿æ¥æ­£åœ¨è¿›è¡Œå…³é—­ã€‚3 - è¡¨ç¤ºè¿æ¥å·²ç»å…³é—­æˆ–è€…è¿æ¥ä¸èƒ½æ‰“å¼€ã€‚ |
| socket.bufferedAmount | åªè¯»å±æ€§ **bufferedAmount** å·²è¢« send() æ”¾å…¥æ­£åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ä¼ è¾“ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰å‘å‡ºçš„ UTF-8 æ–‡æœ¬å­—èŠ‚æ•°ã€‚ |

**WebSocketäº‹ä»¶ï¼š**

| äº‹ä»¶    | äº‹ä»¶å¤„ç†ç¨‹åº     | æè¿°                       |
| ------- | ---------------- | -------------------------- |
| open    | socket.onopen    | è¿æ¥å»ºç«‹æ—¶è§¦å‘             |
| message | socket.onmessage | å®¢æˆ·ç«¯æ¥æ”¶æœåŠ¡ç«¯æ•°æ®æ—¶è§¦å‘ |
| error   | socket.onerror   | é€šä¿¡å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘         |
| close   | socket.onclose   | è¿æ¥å…³é—­æ—¶è§¦å‘             |

**WebSocketæ–¹æ³•ï¼š**

| æ–¹æ³•           | æè¿°             |
| -------------- | ---------------- |
| socket.send()  | ä½¿ç”¨è¿æ¥å‘é€æ•°æ® |
| socket.close() | å…³é—­è¿æ¥         |

### 4.3 WebSocketå®ä¾‹

æ­¥éª¤å¦‚ä¸‹ï¼š

1.ä½¿ç”¨WebSocketçš„APIç¼–å†™htmlé¡µé¢ï¼Œä½œä¸ºå®¢æˆ·ç«¯
2.seckill-orderä¸­æ·»åŠ ä¾èµ–
3.åœ¨å¼•å¯¼ç±»é‡Œåˆ›å»ºServerEndpointExporter
4.ç¼–å†™WebSocketServerï¼Œä½œä¸ºæœåŠ¡ç«¯
5.ç¼–å†™WebSocketControlleræ¥å£ï¼Œå®ç°æ¶ˆæ¯å‘é€

#### 4.3.1 å®¢æˆ·ç«¯

â€‹        WebSocket åè®®æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåŸºäº TCP çš„åè®®ã€‚ä¸ºäº†å»ºç«‹ä¸€ä¸ª WebSocket è¿æ¥ï¼Œå®¢æˆ·ç«¯æµè§ˆå™¨é¦–å…ˆè¦å‘æœåŠ¡å™¨å‘èµ·ä¸€ä¸ª HTTP è¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚å’Œé€šå¸¸çš„ HTTP è¯·æ±‚ä¸åŒï¼ŒåŒ…å«äº†ä¸€äº›é™„åŠ å¤´ä¿¡æ¯ï¼Œå…¶ä¸­é™„åŠ å¤´ä¿¡æ¯"Upgrade: WebSocket"è¡¨æ˜è¿™æ˜¯ä¸€ä¸ªç”³è¯·åè®®å‡çº§çš„ HTTP è¯·æ±‚ï¼ŒæœåŠ¡å™¨ç«¯è§£æè¿™äº›é™„åŠ çš„å¤´ä¿¡æ¯ç„¶åäº§ç”Ÿåº”ç­”ä¿¡æ¯è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯çš„ WebSocket è¿æ¥å°±å»ºç«‹èµ·æ¥äº†ï¼ŒåŒæ–¹å°±å¯ä»¥é€šè¿‡è¿™ä¸ªè¿æ¥é€šé“è‡ªç”±çš„ä¼ é€’ä¿¡æ¯ï¼Œå¹¶ä¸”è¿™ä¸ªè¿æ¥ä¼šæŒç»­å­˜åœ¨ç›´åˆ°å®¢æˆ·ç«¯æˆ–è€…æœåŠ¡å™¨ç«¯çš„æŸä¸€æ–¹ä¸»åŠ¨çš„å…³é—­è¿æ¥ã€‚

â€‹        æˆ‘ä»¬æŒ‰ç…§ä¸Šé¢çš„APIå®ç°å®¢æˆ·ç«¯ä»£ç å¦‚ä¸‹ï¼š

```HTML
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>websocket</title>
    <script src="js/jquery-3.5.1.min.js"></script>
    <script>
        var socket;
        if(typeof(WebSocket) == "undefined") {
            console.log("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWebSocket");
        }else{
            console.log("æ‚¨çš„æµè§ˆå™¨æ”¯æŒWebSocket");

            //å®ç°åŒ–WebSocketå¯¹è±¡ï¼ŒæŒ‡å®šè¦è¿æ¥çš„æœåŠ¡å™¨åœ°å€ä¸ç«¯å£  å»ºç«‹è¿æ¥
            socket = new WebSocket("ws://localhost:18085/socket/zhangsan");
            //æ‰“å¼€äº‹ä»¶
            socket.onopen = function() {
                console.log("Socket å·²æ‰“å¼€");
            };
            //è·å¾—æ¶ˆæ¯äº‹ä»¶
            socket.onmessage = function(msg) {
                console.log(msg.data);
                //å‘ç°æ¶ˆæ¯è¿›å…¥    è°ƒåå°è·å–
                //getCallingList();
                $("#msg").append(msg.data+"</br>");
            };
            //å…³é—­äº‹ä»¶
            socket.onclose = function() {
                console.log("Socketå·²å…³é—­");
            };
            //å‘ç”Ÿäº†é”™è¯¯äº‹ä»¶
            socket.onerror = function() {
                alert("Socketå‘ç”Ÿäº†é”™è¯¯");
            }

            //å…³é—­è¿æ¥
            function closeWebSocket() {
                socket.close();
            }

            //å‘é€æ¶ˆæ¯
            function send() {
                var message = document.getElementById('text').value;
                socket.send(message);
            }
        }
    </script>
</head>
<body>
<div id="msg"></div>
</body>
</html>
```

#### 4.3.2 æœåŠ¡ç«¯

1)å¼•å…¥ä¾èµ–åŒ…

åœ¨`seckill-order`å¼•å…¥å¦‚ä¸‹ä¾èµ–ï¼š

```XML
<!--websocket-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-websocket</artifactId>
</dependency>
```

2)åœ¨å¼•å¯¼ç±»é‡Œä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```Java
@Bean
public ServerEndpointExporter serverEndpointExporter() {
    return new ServerEndpointExporter();
}
```

3)websocketæ¶ˆæ¯å¤„ç†

â€‹        åœ¨`seckill-order`æœåŠ¡ç«¯ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªç±»`com.seckill.order.websocket.WebSocketServer`ï¼Œå¹¶æš´éœ²websocketåœ°å€å‡ºå»ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
@Slf4j
@ServerEndpoint("/socket/{userid}")
@Component
public class WebSocketServer {

    // å­˜æ”¾æ¯ä¸ªå®¢æˆ·ç«¯å¯¹åº”çš„WebSocketServerï¼Œä½¿ç”¨ç°æˆå®‰å…¨çš„Setå®¹å™¨
    private static CopyOnWriteArraySet<WebSocketServer> webSocketServerSet = new CopyOnWriteArraySet<>();

    // å­˜æ”¾å®¢æˆ·ç«¯çš„è¿æ¥ä¼šè¯ï¼Œéœ€è¦ä½¿ç”¨ä¼šè¯æ¥å‘é€æ•°æ®ç»™å®¢æˆ·ç«¯
    private static Map<String, Session> sessionMap = new HashMap<>();

    //ç”¨æˆ·å”¯ä¸€æ ‡è¯†ç¬¦
    private String userid;

    //è¿æ¥å»ºç«‹æˆåŠŸè°ƒç”¨çš„æ–¹æ³•
    @OnOpen
    public void onOpen(@PathParam("userid") String userid, Session session) {
        this.userid = userid;
        sessionMap.put(userid, session);

        webSocketServerSet.add(this);

        try {
            sendMessage("è¿æ¥æˆåŠŸ", userid);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    //è¿æ¥å…³é—­è°ƒç”¨çš„æ–¹æ³•
    @OnClose
    public void onClose() {
        webSocketServerSet.remove(this);
        sessionMap.remove(userid);
    }

    /**
     * æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯åè°ƒç”¨çš„æ–¹æ³•
     *
     * @param message æ¥å—åˆ°çš„å®¢æˆ·ç«¯çš„æ¶ˆæ¯
     */
    @OnMessage
    public void onMessage(String message) {
        log.info("æ”¶åˆ°çš„å®¢æˆ·ç«¯æ¶ˆæ¯ï¼š" + message);
    }

    //å‘ç”Ÿå¼‚å¸¸å¤„ç†æ–¹æ³•
    @OnError
    public void onError(Session session, Throwable error) {
        error.printStackTrace();
    }

    //ç¾¤å‘æ¶ˆæ¯
    public void sendMessage(String message) throws IOException {
        for (Map.Entry<String, Session> sessionEntry : sessionMap.entrySet()) {
            sessionEntry.getValue().getBasicRemote().sendText(message);
        }
    }

    //ç»™æŒ‡å®šç”¨æˆ·å‘æ¶ˆæ¯
    public void sendMessage(String message, String userid) throws IOException {
        sessionMap.get(userid).getBasicRemote().sendText(message);
    }
}
```

ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ

1. **`@OnOpen` æ³¨è§£çš„æ–¹æ³• `onOpen`**ï¼š
   - å½“å®¢æˆ·ç«¯ä¸ WebSocket æœåŠ¡å™¨å»ºç«‹è¿æ¥æ—¶è°ƒç”¨ã€‚
   - å°†å½“å‰çš„ WebSocket æœåŠ¡å™¨å®ä¾‹æ·»åŠ åˆ° `webSocketServerSet` é›†åˆä¸­ã€‚
   - å°†ç”¨æˆ·æ ‡è¯†ç¬¦å’Œ WebSocket ä¼šè¯æ·»åŠ åˆ° `sessionMap` ä¸­ã€‚
   - å‘è¿æ¥çš„å®¢æˆ·ç«¯å‘é€ä¸€æ¡æ¶ˆæ¯ï¼ˆ"è¿æ¥æˆåŠŸ"ï¼‰ã€‚
2. **`@OnClose` æ³¨è§£çš„æ–¹æ³• `onClose`**ï¼š
   - å½“å®¢æˆ·ç«¯ä¸ WebSocket æœåŠ¡å™¨å…³é—­è¿æ¥æ—¶è°ƒç”¨ã€‚
   - ä» `webSocketServerSet` é›†åˆä¸­ç§»é™¤å½“å‰çš„ WebSocket æœåŠ¡å™¨å®ä¾‹ã€‚
   - ä» `sessionMap` ä¸­ç§»é™¤å¯¹åº”çš„ç”¨æˆ·æ ‡è¯†ç¬¦å’Œä¼šè¯ã€‚
3. **`@OnMessage` æ³¨è§£çš„æ–¹æ³• `onMessage`**ï¼š
   - å½“æœåŠ¡å™¨ä»å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶è°ƒç”¨ã€‚
   - æ‰“å°æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼ˆåœ¨æ—¥å¿—ä¸­è®°å½•ï¼‰ã€‚
4. **`@OnError` æ³¨è§£çš„æ–¹æ³• `onError`**ï¼š
   - å½“ WebSocket è¿æ¥å‘ç”Ÿé”™è¯¯æ—¶è°ƒç”¨ã€‚
   - æ‰“å°é”™è¯¯å †æ ˆè·Ÿè¸ªã€‚
5. **`sendMessage` æ–¹æ³•**ï¼š
   - å‘æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯å¹¿æ’­æ¶ˆæ¯ã€‚
6. **`sendMessage(String message, String userid)` æ–¹æ³•**ï¼š
   - å‘æŒ‡å®šç”¨æˆ·æ ‡è¯†ç¬¦çš„å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ã€‚

æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªæµ‹è¯•ç±»`com.seckill.order.controller.WebSocketController`ï¼Œç”¨äºå®ç°ç»™æŒ‡å®šç”¨æˆ·å‘æ¶ˆæ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
@RestController
@RequestMapping(value = "/ws")
public class WebSocketController {

    @Autowired
    private WebSocketServer webSocketServer;

    /***
     * æ¨¡æ‹Ÿç»™æŒ‡å®šç”¨æˆ·å‘æ¶ˆæ¯
     */
    @GetMapping(value = "/send/{userid}")
    public Result sendMessage(@PathVariable(value = "userid")String userid, String msg) throws IOException {
        webSocketServer.sendMessage(msg,userid);
        return new Result(true, StatusCode.OK,"å‘é€æ¶ˆæ¯æˆåŠŸ@");
    }
}
```

è®¿é—®é¡µé¢ï¼š

http://127.0.0.1:18085/wsDemo.html

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060221948.png)

è®¿é—®æˆåŠŸåï¼Œå³å¯å‘é¡µé¢å‘é€æ¶ˆæ¯ï¼Œè¯·æ±‚åœ°å€ï¼š

http://127.0.0.1:18085/ws/send/zhangsan?msg=xxx

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060224715.png)

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060225758.png)

## 5 Netty

â€‹        åœ¨å¼€å§‹ä½¿ç”¨Nettyä¹‹å‰ï¼Œå…ˆæ¥äº†è§£ä¸€ä¸‹ä¼ ç»Ÿçš„BIOç¼–ç¨‹å’Œä½¿ç”¨NIOç¼–ç¨‹æœ‰ä»€ä¹ˆä¸ä¸€æ ·ã€‚

### 5.1 BIOç¼–ç¨‹

æ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥è¿‡æ¥åï¼ŒæœåŠ¡ç«¯éƒ½ä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†è¯¥å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚é˜»å¡I/Oçš„é€šä¿¡æ¨¡å‹ç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503050003867.jpeg)

ä¸šåŠ¡åœºæ™¯ï¼šå®¢æˆ·ç«¯æ¯éš”ä¸¤ç§’å‘é€å­—ç¬¦ä¸²ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°ä¹‹åæ‰“å°åˆ°æ§åˆ¶å°ã€‚

æœåŠ¡ç«¯å®ç°ï¼š

```Java
public class IOServer {
    public static void main(String[] args) throws Exception {

        ServerSocket serverSocket = new ServerSocket(8000);

        while (true) {
            // (1) é˜»å¡æ–¹æ³•è·å–æ–°çš„è¿æ¥
            Socket socket = serverSocket.accept();

            new Thread() {
                @Override
                public void run() {
                    String name = Thread.currentThread().getName();

                    try {
                        // (2) æ¯ä¸€ä¸ªæ–°çš„è¿æ¥éƒ½åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œè´Ÿè´£è¯»å–æ•°æ®
                        byte[] data = new byte[1024];
                        InputStream inputStream = socket.getInputStream();
                        while (true) {
                            int len;
                            // (3) æŒ‰å­—èŠ‚æµæ–¹å¼è¯»å–æ•°æ®
                            while ((len = inputStream.read(data)) != -1) {
                                System.out.println("çº¿ç¨‹" + name + ":" + new String(data, 0, len));
                            }
                        }
                    } catch (Exception e) {
                    }
                }
            }.start();
        }
    }
}
```

å®¢æˆ·ç«¯å®ç°ï¼š

```Java
public class MyClient {

    public static void main(String[] args) {
        //æµ‹è¯•ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ•°è¿›è¡Œè®¿é—®
        for (int i = 0; i < 5; i++) {
            new ClientDemo().start();
        }
    }

    static class ClientDemo extends Thread {
        @Override
        public void run() {
            try {
                Socket socket = new Socket("127.0.0.1", 8000);
                while (true) {
                    socket.getOutputStream().write(("æµ‹è¯•æ•°æ®").getBytes());
                    socket.getOutputStream().flush();
                    Thread.sleep(2000);
                }
            } catch (Exception e) {
            }
        }
    }
}
```

â€‹        ä»æœåŠ¡ç«¯ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä¼ ç»Ÿçš„IOæ¨¡å‹ä¸­ï¼Œæ¯ä¸ªè¿æ¥åˆ›å»ºæˆåŠŸä¹‹åéƒ½éœ€è¦ä¸€ä¸ªçº¿ç¨‹æ¥ç»´æŠ¤ï¼Œæ¯ä¸ªçº¿ç¨‹åŒ…å«ä¸€ä¸ªwhileæ­»å¾ªç¯ã€‚

â€‹        å¦‚æœåœ¨ç”¨æˆ·æ•°é‡è¾ƒå°‘çš„æƒ…å†µä¸‹è¿è¡Œæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯å¯¹äºç”¨æˆ·æ•°é‡æ¯”è¾ƒå¤šçš„ä¸šåŠ¡æ¥è¯´ï¼ŒæœåŠ¡ç«¯å¯èƒ½éœ€è¦æ”¯æ’‘æˆåƒä¸Šä¸‡çš„è¿æ¥ï¼ŒIOæ¨¡å‹å¯èƒ½å°±ä¸å¤ªåˆé€‚äº†ã€‚

å¦‚æœæœ‰1ä¸‡ä¸ªè¿æ¥å°±å¯¹åº”1ä¸‡ä¸ªçº¿ç¨‹ï¼Œç»§è€Œ1ä¸‡ä¸ªwhileæ­»å¾ªç¯ï¼Œè¿™ç§æ¨¡å‹å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

- å½“å®¢æˆ·ç«¯è¶Šå¤šï¼Œå°±ä¼šåˆ›å»ºè¶Šå¤šçš„å¤„ç†çº¿ç¨‹ã€‚çº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿä¸­éå¸¸å®è´µçš„èµ„æºï¼ŒåŒä¸€æ—¶åˆ»æœ‰å¤§é‡çš„çº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€æ˜¯éå¸¸ä¸¥é‡çš„èµ„æºæµªè´¹ã€‚å¹¶ä¸”å¦‚æœåŠ¡å™¨é­é‡æ´ªå³°æµé‡å†²å‡»ï¼Œä¾‹å¦‚åŒåä¸€æ´»åŠ¨ï¼Œçº¿ç¨‹æ± ä¼šç¬é—´è¢«è€—å°½ï¼Œå¯¼è‡´æœåŠ¡å™¨ç˜«ç—ªã€‚
- å› ä¸ºæ˜¯é˜»å¡å¼é€šä¿¡ï¼Œçº¿ç¨‹çˆ†ç‚¸ä¹‹åæ“ä½œç³»ç»Ÿé¢‘ç¹è¿›è¡Œçº¿ç¨‹åˆ‡æ¢ï¼Œåº”ç”¨æ€§èƒ½æ€¥å‰§ä¸‹é™ã€‚
- IOç¼–ç¨‹ä¸­æ•°æ®è¯»å†™æ˜¯ä»¥å­—èŠ‚æµä¸ºå•ä½ï¼Œæ•ˆç‡ä¸é«˜ã€‚

### 5.2 NIOç¼–ç¨‹

â€‹        NIOï¼Œä¹Ÿå«åšnew-IOæˆ–è€…non-blocking-IOï¼Œå¯ç†è§£ä¸ºéé˜»å¡IOã€‚NIOç¼–ç¨‹æ¨¡å‹ä¸­ï¼Œæ–°æ¥ä¸€ä¸ªè¿æ¥ä¸å†åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œè€Œæ˜¯å¯ä»¥æŠŠè¿™æ¡è¿æ¥ç›´æ¥ç»‘å®šåˆ°æŸä¸ªå›ºå®šçš„çº¿ç¨‹ï¼Œç„¶åè¿™æ¡è¿æ¥æ‰€æœ‰çš„è¯»å†™éƒ½ç”±è¿™ä¸ªçº¿ç¨‹æ¥è´Ÿè´£ï¼Œæˆ‘ä»¬ç”¨ä¸€å¹…å›¾æ¥å¯¹æ¯”ä¸€ä¸‹IOä¸NIOï¼š

â€‹        è€Œåœ¨NIOæ¨¡å‹ä¸­ï¼Œå¯ä»¥æŠŠè¿™ä¹ˆå¤šçš„whileæ­»å¾ªç¯å˜æˆä¸€ä¸ªæ­»å¾ªç¯ï¼Œè¿™ä¸ªæ­»å¾ªç¯ç”±ä¸€ä¸ªçº¿ç¨‹æ§åˆ¶ã€‚è¿™å°±æ˜¯NIOæ¨¡å‹ä¸­é€‰æ‹©å™¨ï¼ˆSelectorï¼‰çš„ä½œç”¨ï¼Œä¸€æ¡è¿æ¥æ¥äº†ä¹‹åï¼Œç°åœ¨ä¸åˆ›å»ºä¸€ä¸ªwhileæ­»å¾ªç¯å»ç›‘å¬æ˜¯å¦æœ‰æ•°æ®å¯è¯»äº†ï¼Œè€Œæ˜¯ç›´æ¥æŠŠè¿™æ¡è¿æ¥æ³¨å†Œåˆ°**é€‰æ‹©å™¨**ä¸Šï¼Œé€šè¿‡æ£€æŸ¥è¿™ä¸ª**é€‰æ‹©å™¨**ï¼Œå°±å¯ä»¥æ‰¹é‡ç›‘æµ‹å‡ºæœ‰æ•°æ®å¯è¯»çš„è¿æ¥ï¼Œè¿›è€Œè¯»å–æ•°æ®ã€‚

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060230032.png)

ä¸¾ä¸ªæ —å­ï¼Œåœ¨ä¸€å®¶é¤å…é‡Œï¼Œå®¢äººæœ‰ç‚¹èœçš„éœ€æ±‚ï¼Œä¸€å…±æœ‰100æ¡Œå®¢äººï¼Œæœ‰ä¸¤ç§æ–¹æ¡ˆå¯ä»¥è§£å†³å®¢äººç‚¹èœçš„é—®é¢˜ï¼š

- æ–¹æ¡ˆä¸€ï¼š
- æ¯æ¡Œå®¢äººé…ä¸€ä¸ªæœåŠ¡ç”Ÿï¼Œæ¯ä¸ªæœåŠ¡ç”Ÿå°±åœ¨é¤æ¡Œæ—ç»™å®¢äººæä¾›æœåŠ¡ã€‚å¦‚æœå®¢äººè¦ç‚¹èœï¼ŒæœåŠ¡ç”Ÿå°±å¯ä»¥ç«‹åˆ»æä¾›ç‚¹èœçš„æœåŠ¡ã€‚é‚£ä¹ˆ100æ¡Œå®¢äººå°±éœ€è¦100ä¸ªæœåŠ¡ç”Ÿæä¾›æœåŠ¡ï¼Œè¿™å°±æ˜¯BIOæ¨¡å‹ï¼Œä¸€ä¸ªè¿æ¥å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ã€‚
- æ–¹æ¡ˆäºŒï¼š
- ä¸€ä¸ªé¤å…åªæœ‰ä¸€ä¸ªæœåŠ¡ç”Ÿï¼ˆå‡è®¾æœåŠ¡ç”Ÿå¯ä»¥å¿™çš„è¿‡æ¥ï¼‰ã€‚è¿™ä¸ªæœåŠ¡ç”Ÿéš”æ®µæ—¶é—´å°±è¯¢é—®æ‰€æœ‰çš„å®¢äººæ˜¯å¦éœ€è¦ç‚¹èœï¼Œç„¶åæ¯ä¸€æ—¶åˆ»å¤„ç†æ‰€æœ‰å®¢äººçš„ç‚¹èœè¦æ±‚ã€‚è¿™å°±æ˜¯NIOæ¨¡å‹ï¼Œæ‰€æœ‰å®¢äººéƒ½æ³¨å†Œåˆ°åŒä¸€ä¸ªæœåŠ¡ç”Ÿï¼Œå¯¹åº”çš„å°±æ˜¯æ‰€æœ‰çš„è¿æ¥éƒ½æ³¨å†Œåˆ°ä¸€ä¸ªçº¿ç¨‹ï¼Œç„¶åæ‰¹é‡è½®è¯¢ã€‚

è¿™å°±æ˜¯NIOæ¨¡å‹è§£å†³çº¿ç¨‹èµ„æºå—é™çš„æ–¹æ¡ˆï¼Œå®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šå¼€å¤šä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ç®¡ç†ç€ä¸€æ‰¹è¿æ¥ï¼Œç›¸å¯¹äºBIOæ¨¡å‹ä¸­ä¸€ä¸ªçº¿ç¨‹ç®¡ç†ä¸€æ¡è¿æ¥ï¼Œæ¶ˆè€—çš„çº¿ç¨‹èµ„æºå¤§å¹…å‡å°‘ã€‚

### 5.3 Nettyä»‹ç»

æˆ‘ä»¬å·²ç»æœ‰äº†NIOèƒ½å¤Ÿæé«˜ç¨‹åºæ•ˆç‡äº†ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ä½¿ç”¨Nettyï¼Ÿ

ç®€å•çš„è¯´ï¼šNettyå°è£…äº†JDKçš„NIOï¼Œè®©ä½ ç”¨å¾—æ›´çˆ½ï¼Œä½ ä¸ç”¨å†å†™ä¸€å¤§å †å¤æ‚çš„ä»£ç äº†ã€‚

å®˜æ–¹æœ¯è¯­ï¼šNettyæ˜¯ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨æ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤çš„é«˜æ€§èƒ½æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ã€‚

Netty æ˜¯ä¸€ä¸ªå¹¿æ³›ä½¿ç”¨çš„ Java ç½‘ç»œç¼–ç¨‹æ¡†æ¶,å®ƒæä¾›äº†ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„ API å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ï¼Œå®ƒæ´»è·ƒå’Œæˆé•¿äºç”¨æˆ·ç¤¾åŒºï¼Œåƒå¤§å‹å…¬å¸ Facebook ä»¥åŠæµè¡Œ å¼€æºé¡¹ç›®å¦‚ Infinispan, HornetQ, Vert.x, Apache Cassandra å’Œ Elasticsearch ç­‰ï¼Œéƒ½åˆ©ç”¨å…¶å¼ºå¤§çš„å¯¹äºç½‘ç»œæŠ½è±¡çš„æ ¸å¿ƒä»£ç ã€‚

â€‹        Nettyå—åˆ°å¤§å…¬å¸é’ççš„åŸå› ï¼š

```Plaintext
1.å¹¶å‘é«˜
2.ä¼ è¾“å¿«
3.å°è£…å¥½
```

**å¹¶å‘é«˜ï¼š**

â€‹        Nettyæ˜¯ä¸€æ¬¾åŸºäºNIOï¼ˆNonblocking I/Oï¼Œéé˜»å¡IOï¼‰å¼€å‘çš„ç½‘ç»œé€šä¿¡æ¡†æ¶ï¼Œå¯¹æ¯”äºBIOï¼ˆBlocking I/Oï¼Œé˜»å¡IOï¼‰ï¼Œä»–çš„å¹¶å‘æ€§èƒ½å¾—åˆ°äº†å¾ˆå¤§æé«˜ã€‚

**ä¼ è¾“å¿«ï¼š**

â€‹        Nettyçš„ä¼ è¾“å¿«å…¶å®ä¹Ÿæ˜¯ä¾èµ–äº†NIOçš„ä¸€ä¸ªç‰¹æ€§â€”â€”*é›¶æ‹·è´*ã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒJavaçš„å†…å­˜æœ‰å †å†…å­˜ã€æ ˆå†…å­˜å’Œå­—ç¬¦ä¸²å¸¸é‡æ± ç­‰ç­‰ï¼Œå…¶ä¸­å †å†…å­˜æ˜¯å ç”¨å†…å­˜ç©ºé—´æœ€å¤§çš„ä¸€å—ï¼Œä¹Ÿæ˜¯Javaå¯¹è±¡å­˜æ”¾çš„åœ°æ–¹ï¼Œä¸€èˆ¬æˆ‘ä»¬çš„æ•°æ®å¦‚æœéœ€è¦ä»IOè¯»å–åˆ°å †å†…å­˜ï¼Œä¸­é—´éœ€è¦ç»è¿‡Socketç¼“å†²åŒºï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªæ•°æ®ä¼šè¢«æ‹·è´ä¸¤æ¬¡æ‰èƒ½åˆ°è¾¾ä»–çš„çš„ç»ˆç‚¹ï¼Œå¦‚æœæ•°æ®é‡å¤§ï¼Œå°±ä¼šé€ æˆä¸å¿…è¦çš„èµ„æºæµªè´¹ã€‚Nettyé’ˆå¯¹è¿™ç§æƒ…å†µï¼Œä½¿ç”¨äº†NIOä¸­çš„å¦ä¸€å¤§ç‰¹æ€§â€”â€”é›¶æ‹·è´ï¼Œå½“ä»–éœ€è¦æ¥æ”¶æ•°æ®çš„æ—¶å€™ï¼Œä»–ä¼šåœ¨å †å†…å­˜ä¹‹å¤–å¼€è¾Ÿä¸€å—å†…å­˜ï¼Œæ•°æ®å°±ç›´æ¥ä»IOè¯»åˆ°äº†é‚£å—å†…å­˜ä¸­å»ï¼Œåœ¨nettyé‡Œé¢é€šè¿‡ByteBufå¯ä»¥ç›´æ¥å¯¹è¿™äº›æ•°æ®è¿›è¡Œç›´æ¥æ“ä½œï¼Œä»è€ŒåŠ å¿«äº†ä¼ è¾“é€Ÿåº¦ã€‚

å…³äºé›¶æ‹·è´ç†è§£å¯ä»¥å‚è€ƒï¼šhttps://my.oschina.net/plucury/blog/192577

**å°è£…å¥½ï¼š**

â€‹        Nettyå¯¹NIOè¿›è¡Œäº†å°è£…ï¼Œä»£ç ç®€æ´ï¼Œè¿œè¿œä¼˜äºä¼ ç»ŸSocketç¼–ç¨‹ã€‚

### 5.2 Netty+WebSocket

â€‹        æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªNetty+WebSocketé›†æˆæ¡ˆä¾‹ï¼Œç”±äºNetty+WebSocketé›†æˆä»£ç æ¯”è¾ƒéº»çƒ¦ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ç›®å‰å¼€æºçš„é¡¹ç›®`netty-websocket-spring-boot-starter`è½»æ¾å®ç°Nettyå’ŒWebSocketçš„é›†æˆã€‚

æ­¥éª¤ï¼š
1.åˆ›å»ºseckill--message
2.æ·»åŠ ä¾èµ–
3.æ·»åŠ é…ç½®æ–‡ä»¶
4.æ·»åŠ Redisié…ç½®ï¼Œç”¨äºå­˜å‚¨WebSocket:ä¼šè¯ä¿¡æ¯
5.ç¼–å†™NettyWebSocketServer,.ä½œä¸ºæœåŠ¡ç«¯
6.ç¼–å†™SendMessageController,è¿›è¡Œæ¶ˆæ¯å‘é€
7.ç¼–å†™WebSocketé¡µé¢

æˆ‘ä»¬æœ‰ä¸€ä¸ªé¡¹ç›®ï¼Œé¡¹ç›®å«`seckill-message`ï¼Œç”¨äºå¤„ç†é€šçŸ¥ç”¨æˆ·æŠ¢å•çŠ¶æ€ã€‚

1)pom.xmléœ€è¦åŒ…å«çš„ä¾èµ–

```XML
<dependencies>
    <!--dbä¾èµ–-->
    <dependency>
        <groupId>com.seckill</groupId>
        <artifactId>seckill-db</artifactId>
        <version>0.0.1-SNAPSHOT</version>
    </dependency>

    <!--Netty Websocket-->
    <dependency>
        <groupId>org.yeauty</groupId>
        <artifactId>netty-websocket-spring-boot-starter</artifactId>
        <version>0.9.5</version>
    </dependency>
</dependencies>
```

2)bootstrap.yml

```YAML
#websocketé…ç½®
ws:
  port: 28082
  host: 0.0.0.0
```

3)Redisé…ç½®

åœ¨é¡¹ç›®ä¸­æ·»åŠ redisé…ç½®ï¼Œè¿™é‡Œä¸»è¦ç”¨äºå­˜å‚¨websocketä¼šè¯éƒ¨åˆ†ä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
@Configuration
public class RedisConfig {

    /**
     * æ¨¡æ¿æ“ä½œå¯¹è±¡åºåˆ—åŒ–è®¾ç½®
     */
    @Bean("redisTemplate")
    public RedisTemplate getRedisTemplate(RedisConnectionFactory redissonConnectionFactory) {
        RedisTemplate<Object, Object> redisTemplate = new RedisTemplate();
        redisTemplate.setConnectionFactory(redissonConnectionFactory);
        redisTemplate.setValueSerializer(valueSerializer());
        redisTemplate.setKeySerializer(keySerializer());
        redisTemplate.setHashKeySerializer(keySerializer());
        redisTemplate.setHashValueSerializer(valueSerializer());
        redisTemplate.setEnableTransactionSupport(true);
        return redisTemplate;
    }

    /**
     * åºåˆ—åŒ–è®¾ç½®
     */
    @Bean
    public StringRedisSerializer keySerializer() {
        return new StringRedisSerializer();
    }

    /**
     * åºåˆ—åŒ–è®¾ç½®
     */
    @Bean
    public RedisSerializer valueSerializer() {
        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class);
        ObjectMapper objectMapper = new ObjectMapper();
        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
        objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);
        jackson2JsonRedisSerializer.setObjectMapper(objectMapper);
        return jackson2JsonRedisSerializer;
    }
}
```

4)WebSocketä¼šè¯å¤„ç†

WebSocketä¼šè¯å¤„ç†æˆ‘ä»¬ä½¿ç”¨äº†`netty-websocket-spring-boot-starter`ç›¸å…³çš„æ³¨è§£ã€‚

ç¼–å†™`com.seckill.message.config.NettyWebSocketServer`ä»£ç å¦‚ä¸‹ï¼š

```Java
@Component
@ServerEndpoint(path = "/ws/{userid}", port = "${ws.port}", host = "${ws.host}")
public class NettyWebSocketServer {

    @Autowired
    private RedisTemplate redisTemplate;

    /**
     * å®šä¹‰ä¸€ä¸ªMapå­˜å‚¨æ‰€æœ‰ä¼šè¯
     */
    private static Map<String, Session> sessionMap = new HashMap<String, Session>();

    /**
     * 1.å»ºç«‹è¿æ¥
     */
    @OnOpen
    public void onOpen(@PathVariable(value = "userid") String userid, Session session) {
        //è·å–Sessionçš„ID
        String id = session.channel().id().toString();

        //è·å–ç”¨æˆ·å¯¹åº”çš„ä¼šè¯å¯¹è±¡
        Session userSession = sessionMap.get(userid);
        if (userSession != null) {
            //æ¸…ç†ä¼šè¯ä¿¡æ¯
            sessionMap.remove(userid);
            redisTemplate.boundHashOps("NettyWebSocketUser").delete(userSession.channel().id().toString());
        }

        //å­˜å‚¨ç”¨æˆ·ä¼šè¯ä¿¡æ¯
        sessionMap.put(userid, session);
        //å­˜å‚¨SessionIDå’Œuseridçš„æ˜ å°„å…³ç³»
        redisTemplate.boundHashOps("NettyWebSocketUser").put(id, userid);
    }

    /**
     * 2.å…³é—­å…³é—­
     */
    @OnClose
    public void onClose(Session session) {
        //æ ¹æ®SessionIDä»Redisä¸­æŸ¥æ‰¾userid
        String userid = redisTemplate.boundHashOps("NettyWebSocketUser").get(session.channel().id().toString()).toString();

        //æ ¹æ®useridåˆ é™¤SessionMapä¸­çš„Session
        sessionMap.remove(userid);
        //åˆ é™¤Redisä¸­useridçš„æ˜ å°„ä¿¡æ¯
        redisTemplate.boundHashOps("NettyWebSocketUser").delete(session.channel().id().toString());
    }

    /**
     * 3.å‘ç”Ÿå¼‚å¸¸
     */
    @OnError
    public void onError(Session session, Throwable throwable) {
        Object userid = redisTemplate.boundHashOps("NettyWebSocketUser").get(session.channel().id().toString());
        System.out.println("ç”¨æˆ·ID" + userid + ",é€šä¿¡å‘ç”Ÿå¼‚å¸¸ï¼");
    }

    /**
     * 4.æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯
     */
    @OnMessage
    public void onMessage(String message, Session session) {
        Object userid = redisTemplate.boundHashOps("NettyWebSocketUser").get(session.channel().id().toString());
        System.out.println("ç”¨æˆ·ID" + userid + "å‘é€çš„æ¶ˆæ¯æ˜¯ï¼š" + message);

        //å›å¤å®¢æˆ·ç«¯
        session.sendText("æ‚¨å‘é€çš„æ¶ˆæ¯æ˜¯ï¼š" + message);
    }

    /**
     * 5.ä¸»åŠ¨ç»™å®¢æˆ·ç«¯å‘æ¶ˆæ¯
     */
    public void sendMessage(String userid, String message) {
        //è·å–ç”¨æˆ·ä¼šè¯
        Session session = sessionMap.get(userid);

        //å‘é€æ¶ˆæ¯
        if (session != null) {
            session.sendText(message);
        }
    }
}
```

å¹¶ä¸”æˆ‘ä»¬éœ€è¦åœ¨å¼•å¯¼ç±»åˆ›å»º`ServerEndpointExporter`å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
@SpringBootApplication(exclude = DataSourceAutoConfiguration.class)
public class NettyWebSocketApplication {

    public static void main(String[] args) {
        SpringApplication.run(NettyWebSocketApplication.class,args);
    }

    /**
     * åˆ›å»ºServerEndpointExportå¯¹è±¡
     */
    @Bean
    public ServerEndpointExporter serverEndpointExporter(){
        return new ServerEndpointExporter();
    }
}
```

ä¸»åŠ¨å‘å®¢æˆ·ç«¯å‘æ¶ˆæ¯ï¼š

```Java
@RestController
@CrossOrigin
@RequestMapping(value = "/msg")
public class SendMessageController {

    @Autowired
    private NettyWebSocketServer nettyWebSocketServer;

    /**
     * å‘é€æ¶ˆæ¯
     */
    @GetMapping(value = "/{userid}")
    public String send(@PathVariable(value = "userid")String userid,@RequestParam(value = "msg") String msg) {
        nettyWebSocketServer.sendMessage(userid,msg);
        return "OK";
    }
}
```

æˆ‘ä»¬è¿™é‡Œç¼–å†™äº†2ä¸ªWebSocketé¡µé¢ï¼š

```HTML
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>websocket</title>
    <script>
        var socket;
        if(typeof(WebSocket) == "undefined") {
            console.log("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWebSocket");
        }else{
            console.log("æ‚¨çš„æµè§ˆå™¨æ”¯æŒWebSocket");

            //å®ç°åŒ–WebSocketå¯¹è±¡ï¼ŒæŒ‡å®šè¦è¿æ¥çš„æœåŠ¡å™¨åœ°å€ä¸ç«¯å£  å»ºç«‹è¿æ¥
            socket = new WebSocket("ws://localhost:28082/ws/wangwu");
            //æ‰“å¼€äº‹ä»¶
            socket.onopen = function() {
                console.log("Socket å·²æ‰“å¼€");
            };
            //è·å¾—æ¶ˆæ¯äº‹ä»¶
            socket.onmessage = function(msg) {
                console.log(msg.data+"</br>");
                //å‘ç°æ¶ˆæ¯è¿›å…¥    è°ƒåå°è·å–
                //getCallingList();
                document.getElementById('msg').innerHTML+=msg.data;
            };
            //å…³é—­äº‹ä»¶
            socket.onclose = function() {
                console.log("Socketå·²å…³é—­");
            };
            //å‘ç”Ÿäº†é”™è¯¯äº‹ä»¶
            socket.onerror = function() {
                alert("Socketå‘ç”Ÿäº†é”™è¯¯");
            }

            //å…³é—­è¿æ¥
            function closeWebSocket() {
                socket.close();
            }

            //å‘é€æ¶ˆæ¯
            function send() {
                var message = document.getElementById('text').value;
                socket.send(message);
            }
        }
    </script>
</head>
<body>
<div id="msg"></div>

<input id="text" /><button type="button" onclick="send()">å‘é€æ¶ˆæ¯</button>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>websocket</title>
    <script>
        var socket;
        if(typeof(WebSocket) == "undefined") {
            console.log("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWebSocket");
        }else{
            console.log("æ‚¨çš„æµè§ˆå™¨æ”¯æŒWebSocket");

            //å®ç°åŒ–WebSocketå¯¹è±¡ï¼ŒæŒ‡å®šè¦è¿æ¥çš„æœåŠ¡å™¨åœ°å€ä¸ç«¯å£  å»ºç«‹è¿æ¥
            socket = new WebSocket("ws://localhost:28082/ws/itheima");
            //æ‰“å¼€äº‹ä»¶
            socket.onopen = function() {
                console.log("Socket å·²æ‰“å¼€");
            };
            //è·å¾—æ¶ˆæ¯äº‹ä»¶
            socket.onmessage = function(msg) {
                console.log(msg.data+"</br>");
                //å‘ç°æ¶ˆæ¯è¿›å…¥    è°ƒåå°è·å–
                //getCallingList();
                document.getElementById('msg').innerHTML+=msg.data+"<br/>";
            };
            //å…³é—­äº‹ä»¶
            socket.onclose = function() {
                console.log("Socketå·²å…³é—­");
            };
            //å‘ç”Ÿäº†é”™è¯¯äº‹ä»¶
            socket.onerror = function() {
                alert("Socketå‘ç”Ÿäº†é”™è¯¯");
            }

            //å…³é—­è¿æ¥
            function closeWebSocket() {
                socket.close();
            }

            //å‘é€æ¶ˆæ¯
            function send() {
                var message = document.getElementById('text').value;
                socket.send(message);
            }
        }
    </script>
</head>
<body>
<div id="msg"></div>

<input id="text" /><button type="button" onclick="send()">å‘é€æ¶ˆæ¯</button>
</body>
</html>
```

æµ‹è¯•æ•ˆæœå¦‚ä¸‹ï¼š

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060402636.png)

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060402404.png)

æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ä¹ŸæˆåŠŸ

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060406278.png)

### 5.3 è®¢å•çŠ¶æ€æ›´æ–°é€šçŸ¥

æˆ‘ä»¬ä¸ºåˆšæ‰ç¼–å†™çš„WebSocketç¼–å†™ä¸€ä¸ªFeignï¼Œå¹¶åœ¨çƒ­ç‚¹æŠ¢å•æˆåŠŸçš„åœ°æ–¹è°ƒç”¨é€šçŸ¥ç”¨æˆ·æŠ¢å•æˆåŠŸå³å¯ã€‚

**1)Feignç¼–å†™**

æˆ‘ä»¬å…ˆæŠŠæ¥æ”¶æ¶ˆæ¯çš„æ–¹æ³•æ”¹ä¸€ä¸‹ï¼Œæ¥æ”¶ä¸€ä¸ªMapæ¶ˆæ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
@RestController
@CrossOrigin
@RequestMapping(value = "/msg")
public class SendMessageController {

    @Autowired
    private NettyWebSocketServer nettyWebSocketServer;

    /**
     * å‘é€æ¶ˆæ¯
     */
    @GetMapping(value = "/{userid}")
    public String send(@PathVariable(value = "userid")String userid,@RequestParam Map<String,Object> dataMap) {
        nettyWebSocketServer.sendMessage(userid,JSON.toJSONString(dataMap));
        return "å‘é€æˆåŠŸ";
    }
}
```

åˆ›å»ºfeignï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
@FeignClient(value = "seckill-message")
public interface MessageFeign {

    /**
     * å‘é€æ¶ˆæ¯
     */
    @GetMapping(value = "/msg/{userid}")
    String send(@PathVariable(value = "userid") String userid, @RequestParam Map<String, Object> dataMap);
}
```

**2)æŠ¢å•æ¶ˆæ¯é€šçŸ¥**

ä¿®æ”¹çƒ­ç‚¹å•†å“ä¸‹å•ï¼Œåœ¨è¿™é‡Œæ ¹æ®ç”¨æˆ·åè¿›è¡Œé€šçŸ¥ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
@Autowired
private MessageFeign messageFeign;

/***
 * ç§’æ€ä¸‹å•
 * @param orderMap
 */
@Override
public void addHotOrder(Map<String, String> orderMap) {
    String id = orderMap.get("id");
    String username = orderMap.get("username");
    //key
    String key = "SKU_" + id;
    //åˆ†å¸ƒå¼é”çš„key
    String lockkey = "LOCKSKU_" + id;
    //ç”¨æˆ·è´­ä¹°çš„key
    String userKey = "USER" + username + "ID" + id;

    //å°è¯•è·å–é”ï¼Œç­‰å¾…10ç§’ï¼Œè‡ªå·±è·å¾—é”åä¸€ç›´ä¸è§£é”åˆ™10ç§’åè‡ªåŠ¨è§£é”
    boolean bo = distributedLocker.tryLock(lockkey, TimeUnit.SECONDS, 10L, 10L);
    if(bo){
        if (redisTemplate.hasKey(key)) {
            //...ç•¥
        }
        //è§£é”
        distributedLocker.unlock(lockkey);

        //é€šçŸ¥ç”¨æˆ·æŠ¢å•æˆåŠŸ
        Map<String,Object> dataMap = new HashMap<String,Object>();
        dataMap.put("code",200);
        dataMap.put("message","æŠ¢å•æˆåŠŸï¼");
        messageFeign.send(username,dataMap);
    }else{
        Map<String,Object> dataMap = new HashMap<String,Object>();
        dataMap.put("code",20001);
        dataMap.put("message","æŠ¢å•å¤±è´¥ï¼");
        messageFeign.send(username,dataMap);
    }
}
```

æµ‹è¯•çƒ­ç‚¹å•†å“æŠ¢å•çš„æ—¶å€™ï¼Œè¿”å›æ•°æ®å¦‚ä¸‹ï¼š

```Properties
{"code":"200","message":"æŠ¢å•æˆåŠŸ"}
```

å‰ç«¯é¡µé¢ä¹Ÿæ”¶åˆ°æŠ¢å•æˆåŠŸé€šçŸ¥ï¼

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060419956.png)