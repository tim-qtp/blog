---
order: 4
author: 
title: "ThreadLocal"
category:
  - å¤šçº¿ç¨‹

---

### ğŸŒŸThreadLocal æ˜¯ä»€ä¹ˆï¼Ÿ

ThreadLocal æ˜¯ä¸€ç§ç”¨äºå®ç°çº¿ç¨‹å±€éƒ¨å˜é‡çš„å·¥å…·ç±»ã€‚å®ƒå…è®¸æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±çš„ç‹¬ç«‹å‰¯æœ¬ï¼Œä»è€Œå®ç°çº¿ç¨‹éš”ç¦»ã€‚

![ThreadLocalçº¿ç¨‹å‰¯æœ¬](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503112042604.png)

ä½¿ç”¨ ThreadLocal é€šå¸¸åˆ†ä¸ºå››æ­¥ï¼š

â‘ ã€åˆ›å»º ThreadLocal

```java
//åˆ›å»ºä¸€ä¸ªThreadLocalå˜é‡
public static ThreadLocal<String> localVariable = new ThreadLocal<>();
```

â‘¡ã€è®¾ç½® ThreadLocal çš„å€¼

```java
//è®¾ç½®ThreadLocalå˜é‡çš„å€¼
localVariable.set("æ²‰é»˜ç‹äºŒæ˜¯æ²™é›•");
```

â‘¢ã€è·å– ThreadLocal çš„å€¼

```java
//è·å–ThreadLocalå˜é‡çš„å€¼
String value = localVariable.get();
```

â‘£ã€åˆ é™¤ ThreadLocal çš„å€¼

```java
//åˆ é™¤ThreadLocalå˜é‡çš„å€¼
localVariable.remove();
```

åœ¨ Web åº”ç”¨ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ ThreadLocal å­˜å‚¨ç”¨æˆ·ä¼šè¯ä¿¡æ¯ï¼Œè¿™æ ·æ¯ä¸ªçº¿ç¨‹åœ¨å¤„ç†ç”¨æˆ·è¯·æ±‚æ—¶éƒ½èƒ½æ–¹ä¾¿åœ°è®¿é—®å½“å‰ç”¨æˆ·çš„ä¼šè¯ä¿¡æ¯ã€‚

åœ¨æ•°æ®åº“æ“ä½œä¸­ï¼Œå¯ä»¥ä½¿ç”¨ ThreadLocal å­˜å‚¨æ•°æ®åº“è¿æ¥å¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±ç‹¬ç«‹çš„æ•°æ®åº“è¿æ¥ï¼Œä»è€Œé¿å…äº†å¤šçº¿ç¨‹ç«äº‰åŒä¸€æ•°æ®åº“è¿æ¥çš„é—®é¢˜ã€‚

åœ¨æ ¼å¼åŒ–æ“ä½œä¸­ï¼Œä¾‹å¦‚æ—¥æœŸæ ¼å¼åŒ–ï¼Œå¯ä»¥ä½¿ç”¨ ThreadLocal å­˜å‚¨ SimpleDateFormat å®ä¾‹ï¼Œé¿å…å¤šçº¿ç¨‹å…±äº«åŒä¸€å®ä¾‹å¯¼è‡´çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

### ThreadLocal æœ‰å“ªäº›ä¼˜ç‚¹ï¼Ÿ

æ¯ä¸ªçº¿ç¨‹è®¿é—®çš„å˜é‡å‰¯æœ¬éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œé¿å…äº†å…±äº«å˜é‡å¼•èµ·çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ç”±äº ThreadLocal å®ç°äº†å˜é‡çš„çº¿ç¨‹ç‹¬å ï¼Œä½¿å¾—å˜é‡ä¸éœ€è¦åŒæ­¥å¤„ç†ï¼Œå› æ­¤èƒ½å¤Ÿé¿å…èµ„æºç«äº‰ã€‚

ThreadLocal å¯ç”¨äºè·¨æ–¹æ³•ã€è·¨ç±»æ—¶ä¼ é€’ä¸Šä¸‹æ–‡æ•°æ®ï¼Œä¸éœ€è¦åœ¨æ–¹æ³•é—´ä¼ é€’å‚æ•°ã€‚

### å®é™…é¡¹ç›®ä¸­ç”¨åˆ°çš„ ThreadLocal ï¼Ÿ

ç”¨æ¥å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œç™»å½•åçš„ç”¨æˆ·æ¯æ¬¡è®¿é—®æ¥å£ï¼Œéƒ½ä¼šåœ¨è¯·æ±‚å¤´ä¸­æºå¸¦ä¸€ä¸ª tokenï¼Œåœ¨æ§åˆ¶å±‚å¯ä»¥æ ¹æ®è¿™ä¸ª tokenï¼Œè§£æå‡ºç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ã€‚

å‡å¦‚åœ¨æœåŠ¡å±‚å’ŒæŒä¹…å±‚ä¹Ÿè¦ç”¨åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œå°±å¯ä»¥åœ¨æ§åˆ¶å±‚æ‹¦æˆªè¯·æ±‚æŠŠç”¨æˆ·ä¿¡æ¯å­˜å…¥ ThreadLocalã€‚

è¿™æ ·æˆ‘ä»¬åœ¨ä»»ä½•ä¸€ä¸ªåœ°æ–¹ï¼Œéƒ½å¯ä»¥å–å‡º ThreadLocal ä¸­å­˜çš„ç”¨æˆ·ä¿¡æ¯

å¾ˆå¤šå…¶å®ƒåœºæ™¯çš„ cookieã€session ç­‰ç­‰æ•°æ®éš”ç¦»éƒ½å¯ä»¥é€šè¿‡ ThreadLocal å»å®ç°ã€‚

![ThreadLocaå­˜æ”¾ç”¨æˆ·ä¸Šä¸‹æ–‡](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503112047687.png)

### ThreadLocal æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ

å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª ThreadLocal å¯¹è±¡å¹¶è°ƒç”¨ set æ–¹æ³•æ—¶ï¼Œå…¶å®æ˜¯åœ¨å½“å‰çº¿ç¨‹ä¸­åˆå§‹åŒ–äº†ä¸€ä¸ª ThreadLocalMapã€‚

![ThreadLocalMap](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503112047996.png)

ThreadLocalMap æ˜¯ ThreadLocal çš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œå®ƒå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª Entry æ•°ç»„ï¼Œkey æ˜¯ ThreadLocal å¯¹è±¡ï¼Œvalue æ˜¯çº¿ç¨‹çš„å±€éƒ¨å˜é‡ï¼Œè¿™æ ·å°±ç›¸å½“äºä¸ºæ¯ä¸ªçº¿ç¨‹ç»´æŠ¤äº†ä¸€ä¸ªå˜é‡å‰¯æœ¬ã€‚

![ThreadLocaç»“æ„å›¾](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503112048408.png)

Entry ç»§æ‰¿äº† WeakReferenceï¼Œå®ƒé™å®šäº† key æ˜¯ä¸€ä¸ªå¼±å¼•ç”¨ï¼Œå¼±å¼•ç”¨çš„å¥½å¤„æ˜¯å½“å†…å­˜ä¸è¶³æ—¶ï¼ŒJVM ä¼šå›æ”¶ ThreadLocal å¯¹è±¡ï¼Œå¹¶ä¸”å°†å…¶å¯¹åº”çš„ Entry.value è®¾ç½®ä¸º nullï¼Œè¿™æ ·å¯ä»¥åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šé¿å…å†…å­˜æ³„æ¼ã€‚

```java
static class Entry extends WeakReference<ThreadLocal<?>> {
    /** The value associated with this ThreadLocal. */
    Object value;

    //èŠ‚ç‚¹ç±»
    Entry(ThreadLocal<?> k, Object v) {
        //keyèµ‹å€¼
        super(k);
        //valueèµ‹å€¼
        value = v;
    }
}
```

æ€»ç»“ä¸€ä¸‹ï¼š

ThreadLocal çš„å®ç°åŸç†æ˜¯ï¼Œæ¯ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸€ä¸ª Mapï¼Œkey ä¸º ThreadLocal å¯¹è±¡ï¼Œvalue ä¸ºæƒ³è¦å®ç°çº¿ç¨‹éš”ç¦»çš„å˜é‡ï¼ˆå¯¹è±¡ï¼‰ã€‚

1ã€é€šè¿‡ ThreadLocal çš„ set æ–¹æ³•å°†å¯¹è±¡å­˜å…¥ Map ä¸­ã€‚

2ã€é€šè¿‡ ThreadLocal çš„ get æ–¹æ³•ä» Map ä¸­å–å‡ºå¯¹è±¡ã€‚

3ã€Map çš„å¤§å°ç”± ThreadLocal å¯¹è±¡çš„å¤šå°‘å†³å®šã€‚

<img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503112113995.png" style="zoom:50%;" />

### ä»€ä¹ˆæ˜¯å¼±å¼•ç”¨ï¼Œä»€ä¹ˆæ˜¯å¼ºå¼•ç”¨ï¼Ÿ

å…ˆè¯´ä¸€ä¸‹å¼ºå¼•ç”¨ï¼Œæ¯”å¦‚ `User user = new User("ç§¦ä¸€")` ä¸­ï¼Œuser å°±æ˜¯ä¸€ä¸ªå¼ºå¼•ç”¨ï¼Œ`new User("ç§¦ä¸€")` å°±æ˜¯å¼ºå¼•ç”¨å¯¹è±¡ã€‚

å½“ user è¢«ç½®ä¸º null æ—¶ï¼ˆ`user = null`ï¼‰ï¼Œ`new User("ç§¦ä¸€")` å¯¹è±¡å°±ä¼šè¢«åƒåœ¾å›æ”¶ï¼›å¦åˆ™å³ä¾¿æ˜¯å†…å­˜ç©ºé—´ä¸è¶³ï¼ŒJVM ä¹Ÿä¸ä¼šå›æ”¶ `new User("ç§¦ä¸€")` è¿™ä¸ªå¼ºå¼•ç”¨å¯¹è±¡ï¼Œå®æ„¿æŠ›å‡º OutOfMemoryErrorã€‚

å¼±å¼•ç”¨ï¼Œæ¯”å¦‚è¯´åœ¨ä½¿ç”¨ ThreadLocal ä¸­ï¼ŒEntry çš„ key å°±æ˜¯ä¸€ä¸ªå¼±å¼•ç”¨å¯¹è±¡ã€‚

```java
ThreadLocal<User> userThreadLocal = new ThreadLocal<>();
userThreadLocal.set(new User("æ²‰é»˜ç‹äºŒ"));
```

userThreadLocal æ˜¯ä¸€ä¸ªå¼ºå¼•ç”¨ï¼Œ`new ThreadLocal<>()` æ˜¯ä¸€ä¸ªå¼ºå¼•ç”¨å¯¹è±¡ï¼›

`new User("ç§¦ä¸€")` æ˜¯ä¸€ä¸ªå¼ºå¼•ç”¨å¯¹è±¡ã€‚

è°ƒç”¨ set æ–¹æ³•åï¼Œä¼šå°† `key = new ThreadLocal<>()` æ”¾å…¥ ThreadLocalMap ä¸­ï¼Œæ­¤æ—¶çš„ key æ˜¯ä¸€ä¸ªå¼±å¼•ç”¨å¯¹è±¡ã€‚å½“ JVM è¿›è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œå¦‚æœå‘ç°äº†å¼±å¼•ç”¨å¯¹è±¡ï¼Œå°±ä¼šå°†å…¶å›æ”¶ã€‚

### **ä¸ºä»€ä¹ˆä½¿ç”¨å¼±å¼•ç”¨ï¼Ÿ**

åœ¨ `ThreadLocal` ä¸­ä½¿ç”¨å¼±å¼•ç”¨çš„åŸå› æ˜¯ï¼š

- **é¿å…å†…å­˜æ³„æ¼**ï¼šå¦‚æœ `ThreadLocal` å¯¹è±¡æ˜¯å¼ºå¼•ç”¨ï¼Œé‚£ä¹ˆçº¿ç¨‹ç»“æŸæ—¶ï¼Œ`ThreadLocalMap` ä¸­çš„æ¡ç›®å¯èƒ½ä¸ä¼šè¢«æ¸…ç†ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚
- **è‡ªåŠ¨æ¸…ç†**ï¼šä½¿ç”¨å¼±å¼•ç”¨å¯ä»¥è®© JVM åœ¨å›æ”¶ `ThreadLocal` å¯¹è±¡æ—¶ï¼Œè‡ªåŠ¨æ¸…ç†å¯¹åº”çš„æ¡ç›®ï¼Œå‡å°‘å†…å­˜æ³„æ¼çš„é£é™©ã€‚

### çˆ¶çº¿ç¨‹èƒ½ç”¨ ThreadLocal ç»™å­çº¿ç¨‹ä¼ å€¼å—ï¼Ÿ

ä¸èƒ½ã€‚

å› ä¸º ThreadLocal å˜é‡å­˜å‚¨åœ¨æ¯ä¸ªçº¿ç¨‹çš„ ThreadLocalMap ä¸­ï¼Œè€Œå­çº¿ç¨‹==ä¸ä¼šç»§æ‰¿çˆ¶çº¿ç¨‹çš„ ThreadLocalMap==ã€‚

å¯ä»¥ä½¿ç”¨ `InheritableThreadLocal`æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

å­çº¿ç¨‹åœ¨åˆ›å»ºçš„æ—¶å€™ä¼šæ‹·è´çˆ¶çº¿ç¨‹çš„ InheritableThreadLocal å˜é‡ã€‚

```java
class InheritableThreadLocalExample {
    private static final InheritableThreadLocal<String> inheritableThreadLocal = new InheritableThreadLocal<>();

    public static void main(String[] args) {
        inheritableThreadLocal.set("çˆ¶çº¿ç¨‹çš„å€¼");

        new Thread(() -> {
            System.out.println("å­çº¿ç¨‹è·å–çš„å€¼ï¼š" + inheritableThreadLocal.get()); // ç»§æ‰¿äº†çˆ¶çº¿ç¨‹çš„å€¼
        }).start();
    }
}
```

### InheritableThreadLocalçš„åŸç†

åœ¨ Thread ç±»çš„å®šä¹‰ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸¤ä¸ª ThreadLocalMapï¼š

```java
public class Thread {
    /* æ™®é€š ThreadLocal å˜é‡å­˜å‚¨çš„åœ°æ–¹ */
    ThreadLocal.ThreadLocalMap threadLocals = null;

    /* InheritableThreadLocal å˜é‡å­˜å‚¨çš„åœ°æ–¹ */
    ThreadLocal.ThreadLocalMap inheritableThreadLocals = null;
}
```

æ™®é€š ThreadLocal å˜é‡å­˜å‚¨åœ¨ threadLocals ä¸­ï¼Œä¸ä¼šè¢«å­çº¿ç¨‹ç»§æ‰¿ã€‚

InheritableThreadLocal å˜é‡å­˜å‚¨åœ¨ inheritableThreadLocals ä¸­ï¼Œå½“ `new Thread()` åˆ›å»ºä¸€ä¸ªå­çº¿ç¨‹æ—¶ï¼ŒThread çš„ `init()` æ–¹æ³•ä¼šæ£€æŸ¥çˆ¶çº¿ç¨‹æ˜¯å¦æœ‰ inheritableThreadLocalsï¼Œå¦‚æœæœ‰ï¼Œå°±ä¼šæ‹·è´ InheritableThreadLocal å˜é‡åˆ°å­çº¿ç¨‹ï¼š









