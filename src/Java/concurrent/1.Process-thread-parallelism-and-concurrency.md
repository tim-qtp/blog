---
order: 2
author: 
title: "ç‹‚ç¥JUCå¹¶å‘"
category:
  - å¤šçº¿ç¨‹

---

## å¼€å§‹ä¹‹å‰ï¼šè¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«ï¼Ÿ

è¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…å’Œè°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œæ˜¯ä¸€ä¸ªç¨‹åºçš„è¿è¡Œå®ä¾‹ï¼Œæ‹¥æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ã€‚

ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åŒ…å«å¤šä¸ªçº¿ç¨‹ï¼Œæ˜¯CPUè°ƒåº¦å’Œæ‰§è¡Œçš„æœ€å°å•ä½ï¼Œå¯ä»¥å…±äº«å±äºåŒä¸€è¿›ç¨‹çš„èµ„æºã€‚ç®€è€Œè¨€ä¹‹ï¼Œè¿›ç¨‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œè€Œçº¿ç¨‹é—´å¯ä»¥å…±äº«å†…å­˜å’Œèµ„æºã€‚

## å‡†å¤‡å·¥ä½œ

æ–°å»ºä¸€ä¸ªMavené¡¹ç›®ï¼Œå¼•å…¥ä¸€ä¸ªlombokä¾èµ–.

```xml
 <dependencies>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <version>1.18.8</version>
        </dependency>
    </dependencies>

```

## 1\. ä»€ä¹ˆæ˜¯JUC

JUCå°±æ˜¯java.util.concurrentä¸‹é¢çš„ç±»åŒ…ï¼Œä¸“é—¨ç”¨äºå¤šçº¿ç¨‹çš„å¼€å‘ã€‚

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/04d2c9e34c79f598003bdd5b36ae76c0.png)

### 1.1 è¿›ç¨‹

ä¸€ä¸ªç¨‹åºï¼ŒQQ.exe Music.exe ç¨‹åºçš„é›†åˆï¼›  
ä¸€ä¸ªè¿›ç¨‹å¾€å¾€å¯ä»¥åŒ…å«å¤šä¸ªçº¿ç¨‹ï¼Œè‡³å°‘åŒ…å«ä¸€ä¸ªï¼  
Javaé»˜è®¤æœ‰å‡ ä¸ªçº¿ç¨‹ï¼Ÿ 2 ä¸ª mianã€GC

### 1.2 çº¿ç¨‹

å¼€äº†ä¸€ä¸ªè¿›ç¨‹ Typoraï¼Œå†™å­—ï¼Œè‡ªåŠ¨ä¿å­˜ï¼ˆçº¿ç¨‹è´Ÿè´£çš„ï¼‰

å¯¹äºJavaè€Œè¨€ï¼šThreadã€Runableã€Callableè¿›è¡Œå¼€å¯çº¿ç¨‹çš„ã€‚

**æé—®ï¼ŸJAVAçœŸçš„å¯ä»¥å¼€å¯çº¿ç¨‹å—ï¼Ÿ å¼€ä¸äº†çš„ï¼**

Javaæ˜¯æ²¡æœ‰æƒé™å»å¼€å¯çº¿ç¨‹ã€æ“ä½œç¡¬ä»¶çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªnativeçš„ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œå®ƒè°ƒç”¨çš„åº•å±‚çš„C++ä»£ç ã€‚

```java
    public synchronized void start() {
        /**
         * This method is not invoked for the main method thread or "system"
         * group threads created/set up by the VM. Any new functionality added
         * to this method in the future may have to also be added to the VM.
         *
         * A zero status value corresponds to state "NEW".
         */
        if (threadStatus != 0)
            throw new IllegalThreadStateException();

        /* Notify the group that this thread is about to be started
         * so that it can be added to the group's list of threads
         * and the group's unstarted count can be decremented. */
        group.add(this);

        boolean started = false;
        try {
            start0();
            started = true;
        } finally {
            try {
                if (!started) {
                    group.threadStartFailed(this);
                }
            } catch (Throwable ignore) {
                /* do nothing. If start0 threw a Throwable then
                  it will be passed up the call stack */
            }
        }
    }
	//è¿™æ˜¯ä¸€ä¸ªC++åº•å±‚ï¼ŒJavaæ˜¯æ²¡æœ‰æƒé™æ“ä½œåº•å±‚ç¡¬ä»¶çš„
    private native void start0();


```

é¦–å…ˆã€‚start()æ˜¯ä¸€ä¸ªsynchronizedæ–¹æ³•ï¼ŒåŒæ­¥æ–¹æ³•ï¼Œå®‰å…¨çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šæŠŠå½“å‰çº¿ç¨‹åŠ å…¥ä¸€ä¸ªçº¿ç¨‹ç»„ï¼Œè°ƒç”¨äº†start0()æ–¹æ³•ï¼Œè¿™ä¸ªstart0(),æ˜¯ç”¨nativeä¿®é¥°çš„ï¼Œä¹Ÿå°±æ˜¯æœ¬åœ°æ–¹æ³•ã€‚

æ‰€ä»¥æœ€åæ˜¯è°ƒç”¨äº†æœ¬åœ°æ–¹æ³•ï¼ŒJAVAæ˜¯æ²¡æœ‰æƒé™å¼€å¯çº¿ç¨‹çš„ã€‚start()è°ƒç”¨äº†æœ¬åœ°çš„C++æ–¹æ³•ï¼Œå› ä¸ºjavaæ˜¯è¿è¡Œåœ¨è™šæ‹Ÿæœºä¹‹ä¸Šçš„ï¼Œæ— æ³•ç›´æ¥æ“ä½œç¡¬ä»¶

### 1.3 å¹¶å‘

å¤šçº¿ç¨‹æ“ä½œåŒä¸€ä¸ªèµ„æºã€‚

+   CPU åªæœ‰ä¸€æ ¸ï¼Œæ¨¡æ‹Ÿå‡ºæ¥å¤šæ¡çº¿ç¨‹ï¼Œå¤©ä¸‹æ­¦åŠŸï¼Œå”¯å¿«ä¸ç ´ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨CPUå¿«é€Ÿäº¤æ›¿ï¼Œæ¥æ¨¡æ‹Ÿå¤šçº¿ç¨‹ã€‚
+   å¹¶å‘ç¼–ç¨‹çš„æœ¬è´¨ï¼š**å……åˆ†åˆ©ç”¨CPUçš„èµ„æºï¼**

### 1.4 å¹¶è¡Œ

**å¹¶è¡Œï¼š** å¤šä¸ªäººä¸€èµ·è¡Œèµ°

+   CPUå¤šæ ¸ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æ‰§è¡Œã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨çº¿ç¨‹æ± ï¼

**è·å–cpuçš„æ ¸æ•°**

```java
public class Test1 {
    public static void main(String[] args) {
        //è·å–cpuçš„æ ¸æ•°
        System.out.println(Runtime.getRuntime().availableProcessors());
    }
}

```

### 1.5 çº¿ç¨‹çš„çŠ¶æ€

```java
public enum State {

    	//æ–°ç”Ÿ
        NEW,

    	//è¿è¡Œ
        RUNNABLE,

    	//é˜»å¡
        BLOCKED,

    	//ç­‰å¾…
        WAITING,

    	//è¶…æ—¶ç­‰å¾…
        TIMED_WAITING,

    	//ç»ˆæ­¢
        TERMINATED;
    }
```

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250213112721176.png)

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-tread.png)

### 1.7 çº¿ç¨‹run/startçš„åŒºåˆ«

runæ˜¯çº¿ç¨‹æ™®é€šæ–¹æ³•ï¼Œçº¿ç¨‹å®é™…æ‰§è¡Œè¿è¡Œçš„ä»£ç ï¼Œstartæ˜¯å¯åŠ¨æ–¹æ³•ï¼Œå¯åŠ¨æ–¹æ³•ä¸­ä¼šè°ƒç”¨runæ–¹æ³•

### 1.7 wait/sleepçš„åŒºåˆ«

**1ã€æ¥è‡ªä¸åŒçš„ç±»**

wait => Object

sleep => Thread

ä¸€èˆ¬æƒ…å†µä¼ä¸šä¸­ä½¿ç”¨ä¼‘çœ æ˜¯ï¼š

```java
TimeUnit.DAYS.sleep(1); //ä¼‘çœ 1å¤©
TimeUnit.SECONDS.sleep(1); //ä¼‘çœ 1s
```

**2ã€å…³äºé”çš„é‡Šæ”¾**

wait ä¼šé‡Šæ”¾å¯¹è±¡çš„é”ï¼Œä½¿å¾—å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹è°ƒç”¨notify()æˆ–notifyAll()æ–¹æ³•å”¤é†’ï¼›

sleepä½¿å¾—å½“å‰çº¿ç¨‹æš‚åœæ‰§è¡Œä¸€æ®µæ—¶é—´ï¼Œä¸ä¼šé‡Šæ”¾é”ï¼›

**3ã€ä½¿ç”¨çš„èŒƒå›´æ˜¯ä¸åŒçš„**

wait å¿…é¡»åœ¨synchronized==åŒæ­¥ä»£ç å—==ä¸­ï¼›

sleep å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ç¡ï¼

**4ã€æ˜¯å¦éœ€è¦æ•è·å¼‚å¸¸**

waitæ˜¯ä¸éœ€è¦æ•è·å¼‚å¸¸ï¼›

sleepå¿…é¡»è¦æ•è·å¼‚å¸¸ï¼›  

**5ã€ä½¿ç”¨åœºæ™¯ä¸åŒ**

waitç”¨äºå¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„åä½œé€šä¿¡ï¼Œsleepç”¨äºçº¿ç¨‹çš„ä¼‘çœ 

## 2.Lock

### 2.1 ä¼ ç»Ÿçš„ synchronized

```java
//åŸºæœ¬çš„å–ç¥¨ä¾‹å­

//çœŸæ­£çš„å¤šçº¿ç¨‹å¼€å‘ï¼Œå…¬å¸ä¸­çš„å¼€å‘,é™ä½è€¦åˆæ€§
//çº¿ç¨‹å°±æ˜¯ä¸€ä¸ªå•ç‹¬çš„èµ„æºç±»ï¼Œæ²¡æœ‰ä»»ä½•é™„å±çš„æ“ä½œï¼
//1ã€å±æ€§ã€æ–¹æ³•
public class SaleTicketDemo01 {

  public static void main(String[] args) {
    //å¹¶å‘ï¼šå¤šçº¿ç¨‹æ“ä½œåŒä¸€ä¸ªèµ„æºç±»ï¼ŒæŠŠèµ„æºç±»ä¸¢å…¥çº¿ç¨‹
    final Ticket ticket = new Ticket();
 
    ///@FunctionalInterfaceå‡½æ•°å¼æ¥å£ï¼Œjdk1.8 Lambdaè¡¨è¾¾å¼ï¼ˆå‚æ•°ï¼‰->{ ä»£ç  }
    new Thread(()->{
      for (int i = 0; i < 40; i++) {
        ticket.sale();
      }
    },"A").start();
    new Thread(()->{
      for (int i = 0; i < 40; i++) {
        ticket.sale();
      }
    },"B").start();
    new Thread(()->{
      for (int i = 0; i < 40; i++) {
        ticket.sale();
      }
    },"C").start();
  }
}
// èµ„æºç±» OOP å±æ€§ã€æ–¹æ³•
class Ticket {
  private int number = 30;

  //å–ç¥¨çš„æ–¹å¼
  public synchronized void sale() {
    if (number > 0) {
      System.out.println(Thread.currentThread().getName() + "å–å‡ºäº†ç¬¬" + (number--) + "å¼ ç¥¨å‰©ä½™" + number + "å¼ ç¥¨");
    }
  } 
}

```

### 2.2   Lock

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/10c01d2378fbf600d8593cee306c1080.png)

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/298337182664e257220386bb2e319c12.png)

å…¬å¹³é”ï¼šååˆ†å…¬å¹³ï¼Œå…ˆæ¥ååˆ°ï¼Œæ’é˜Ÿ.  
éå…¬å¹³é”ï¼šä¸å…¬å¹³ï¼Œå¯ä»¥æ’é˜Ÿ  
é»˜è®¤æ˜¯éå…¬å¹³é”ï¼Œæ˜¯ä¸ºäº†å…¬å¹³ï¼Œæ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹è¦3sï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è¦3h,éš¾é“ä¸€å®šè¦è®©3hçš„é”å…ˆæ¥å°±å…ˆæ‰§è¡Œå—

```java
public class SaleTicketDemo02  {

  public static void main(String[] args) {
    final Ticket ticket = new Ticket();

    new Thread(()->{
      for (int i = 0; i < 40; i++) {
        ticket.sale();
      }
    },"A").start();
    new Thread(()->{
      for (int i = 0; i < 40; i++) {
        ticket.sale();
      }
    },"B").start();
    new Thread(()->{
      for (int i = 0; i < 40; i++) {
        ticket.sale();
      }
    },"C").start();
  }
}

// èµ„æºç±» OOP å±æ€§ã€æ–¹æ³•
//Lockä¸‰éƒ¨æ›²
//1ã€new ReentrantLock();
//2ã€Lock.Lock();//åŠ é”
//3ã€finally=>Lock.unLock(); //è§£é”
class Ticket2 {
  private int number = 30;
  Lock lock=new ReentrantLock();
  //å–ç¥¨çš„æ–¹å¼
  public void sale() {
    lock.lock(); 
    try {
      if (number > 0) {
        System.out.println(Thread.currentThread().getName() + "å–å‡ºäº†ç¬¬" + (number--) + "å¼ ç¥¨å‰©ä½™" + number + "å¼ ç¥¨");
      }
    } catch (Exception e) {
      e.printStackTrace();
    } finally {
      lock.unlock();
    }
  }
}

```

### 2.3 Synchronized ä¸Lock çš„åŒºåˆ«

1ã€Synchronized å†…ç½®çš„Java==å…³é”®å­—==ï¼ŒLockæ˜¯ä¸€ä¸ª==Javaæ¥å£==ï¼Œæœ‰å¾ˆå¤šå®ç°

2ã€Synchronized æ— æ³•åˆ¤æ–­è·å–é”çš„çŠ¶æ€ï¼ŒLockå¯ä»¥åˆ¤æ–­ï¼ˆæä¾›äº† `tryLock()` æ–¹æ³•ï¼Œå¯ä»¥å°è¯•è·å–é”å¹¶è¿”å›æˆåŠŸæˆ–å¤±è´¥ï¼‰

3ã€Synchronized ä¼šè‡ªåŠ¨é‡Šæ”¾é”ï¼Œlockå¿…é¡»è¦æ‰‹åŠ¨åŠ é”å’Œæ‰‹åŠ¨é‡Šæ”¾é”ï¼å¯èƒ½ä¼šé‡åˆ°æ­»é”

4ã€`Synchronized` åœ¨è·å–é”æ—¶ï¼Œå¦‚æœé”è¢«å ç”¨ï¼Œçº¿ç¨‹ä¼šä¸€ç›´é˜»å¡ç­‰å¾…ã€‚ï¼›lockå°±ä¸ä¸€å®šä¼šä¸€ç›´ç­‰å¾…ä¸‹å»ï¼Œ==lockä¼šæœ‰ä¸€ä¸ªtrylock==å»å°è¯•è·å–é”ï¼Œè‹¥å¤±è´¥ä¸ä¼šä¸€ç›´ç­‰å¾…ï¼Œæä¾›äº†æ›´å¤§çš„çµæ´»æ€§ã€‚

5ã€`synchronized` æ˜¯éå…¬å¹³é”ï¼Œç­‰å¾…é”çš„çº¿ç¨‹ä¸ä¿è¯æŒ‰ç…§å…ˆæ¥ååˆ°çš„é¡ºåºè·å–é”ã€‚`lock` å¯ä»¥é€šè¿‡æ„é€ å‡½æ•°è®¾ç½®ä¸ºå…¬å¹³é”ï¼ˆ`new ReentrantLock(true)`ï¼‰ï¼Œä¿è¯ç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹ä¼˜å…ˆè·å–é”ã€‚

6ã€Synchronized é€‚åˆé”å°‘é‡çš„ä»£ç åŒæ­¥é—®é¢˜ï¼ŒLocké€‚åˆé”å¤§é‡çš„åŒæ­¥ä»£ç ï¼›

### 2.4 ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å…³ç³»

> é¢è¯•é«˜é¢‘: å•ä¾‹æ¨¡å¼ï¼Œç”Ÿäº§è€…æ¶ˆè´¹è€…ï¼Œæ­»é”

#### 1ï¼‰Synchronzied ç‰ˆæœ¬

```java
/*
çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡é—®é¢˜ï¼šç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é—®é¢˜
çº¿ç¨‹äº¤æ›¿æ‰§è¡Œ A Bæ“ä½œåŒä¸€ä¸ªå˜é‡ num=0 Aè®©num+1ï¼ŒBè®©num-1;
 **/
public class ConsumeAndProduct {
  public static void main(String[] args) {
    Data data = new Data();

    new Thread(() -> {
      for (int i = 0; i < 10; i++) {
        try {
          data.increment();
        } catch (InterruptedException e) {
          e.printStackTrace();
        }
      }
    }, "A").start();
    new Thread(() -> {
      for (int i = 0; i < 10; i++) {
        try {
          data.decrement();
        } catch (InterruptedException e) {
          e.printStackTrace();
        }
      }
    }, "B").start();
  }
}
// ç­‰å¾…ï¼Œä¸šåŠ¡ï¼Œé€šçŸ¥
class Data {
  private int num = 0;

  // +1
  public synchronized void increment() throws InterruptedException {
    // åˆ¤æ–­éœ€ä¸éœ€è¦ç­‰å¾…
    if (num != 0) { //ä¸ç­‰äº0ï¼Œç­‰å¾…è¢«äººå‡æ‰ï¼› å¦‚æœä¸º0ï¼Œé‚£å°±åŠ ä¸Šï¼›
      this.wait();
    }
    num++;
    System.out.println(Thread.currentThread().getName() + "=>" + num);
    // é€šçŸ¥å…¶ä»–çº¿ç¨‹ +1 æ‰§è¡Œå®Œæ¯•
    this.notifyAll();
  }

  // -1
  public synchronized void decrement() throws InterruptedException {
    // åˆ¤æ–­ç­‰å¾…
    if (num == 0) {
      this.wait();
    }
    num--;
    System.out.println(Thread.currentThread().getName() + "=>" + num);
    // é€šçŸ¥å…¶ä»–çº¿ç¨‹ -1 æ‰§è¡Œå®Œæ¯•
    this.notifyAll();
  }
}
```

#### 2ï¼‰å­˜åœ¨é—®é¢˜ï¼ˆè™šå‡å”¤é†’ï¼‰

**é—®é¢˜ï¼Œå¦‚æœæœ‰å››ä¸ªçº¿ç¨‹**ï¼Œä¼šå‡ºç°è™šå‡å”¤é†’

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/addc1ee304924a5bdee264405ec56e8c.png)

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/a8ed2e53b2d63ae04edd4b16b94ee954.png)

è§£å†³æ–¹å¼ ï¼Œ**if æ”¹ä¸ºwhileå³å¯ï¼Œé˜²æ­¢è™šå‡å”¤é†’**

> ç»“è®ºï¼šå°±æ˜¯ç”¨ifåˆ¤æ–­çš„è¯ï¼Œ==å”¤é†’åçº¿ç¨‹ä¼šä»waitä¹‹åçš„ä»£ç å¼€å§‹è¿è¡Œ==ï¼Œä½†æ˜¯==ä¸ä¼š==é‡æ–°åˆ¤æ–­ifæ¡ä»¶ï¼Œç›´æ¥ç»§ç»­è¿è¡Œifä»£ç å—ä¹‹åçš„ä»£ç ï¼Œè€Œå¦‚æœä½¿ç”¨whileçš„è¯ï¼Œä¹Ÿä¼šä»waitä¹‹åçš„ä»£ç è¿è¡Œï¼Œä½†æ˜¯å”¤é†’åä¼šé‡æ–°åˆ¤æ–­å¾ªç¯æ¡ä»¶ï¼Œå¦‚æœä¸æˆç«‹å†æ‰§è¡Œwhileä»£ç å—ä¹‹åçš„ä»£ç å—ï¼Œæˆç«‹çš„è¯ç»§ç»­waitã€‚
>
> è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆç”¨whileè€Œä¸ç”¨ifçš„åŸå› äº†ï¼Œå› ä¸ºçº¿ç¨‹è¢«å”¤é†’åï¼Œæ‰§è¡Œå¼€å§‹çš„åœ°æ–¹æ˜¯waitä¹‹å

ifæƒ…å†µï¼šè¢«å”¤é†’æ—¶ï¼Œæ— è„‘æ‰§è¡Œåé¢ä»£ç 

whileï¼šè¿˜ä¼šå†æ¬¡åˆ¤æ–­ä¸€ä¸‹

#### 3ï¼‰Lockç‰ˆ

![image-20200811094721678](https://i-blog.csdnimg.cn/blog_migrate/f174406c46292de1f4d30b8682948980.png)

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250106193232961.png)

```java
public class LockCAP {
  public static void main(String[] args) {
    Data2 data = new Data2();

    new Thread(() -> {
      for (int i = 0; i < 10; i++) {

        try {
          data.increment();
        } catch (InterruptedException e) {
          e.printStackTrace();
        }

      }
    }, "A").start();
    new Thread(() -> {
      for (int i = 0; i < 10; i++) {
        try {
          data.decrement();
        } catch (InterruptedException e) {
          e.printStackTrace();
        }
      }
    }, "B").start();
    new Thread(() -> {
      for (int i = 0; i < 10; i++) {
        try {
          data.increment();
        } catch (InterruptedException e) {
          e.printStackTrace();
        }
      }
    }, "C").start();
    new Thread(() -> {
      for (int i = 0; i < 10; i++) {
        try {
          data.decrement();
        } catch (InterruptedException e) {
          e.printStackTrace();
        }
      }
    }, "D").start();
  }
}

class Data2 {
  private int num = 0;
  Lock lock = new ReentrantLock();
  Condition condition = lock.newCondition();
  // +1
  public  void increment() throws InterruptedException {
    lock.lock();
    try {
      // åˆ¤æ–­ç­‰å¾…
      while (num != 0) {
        condition.await(); //ç­‰å¾…
      }
      num++;
      System.out.println(Thread.currentThread().getName() + "=>" + num);
      // é€šçŸ¥å…¶ä»–çº¿ç¨‹ +1 æ‰§è¡Œå®Œæ¯•
      condition.signalAll(); //å”¤é†’å…¨éƒ¨
    }finally {
      lock.unlock();
    }

  }

  // -1
  public  void decrement() throws InterruptedException {
    lock.lock();
    try {
      // åˆ¤æ–­ç­‰å¾…
      while (num == 0) {
        condition.await();
      }
      num--;
      System.out.println(Thread.currentThread().getName() + "=>" + num);
      // é€šçŸ¥å…¶ä»–çº¿ç¨‹ +1 æ‰§è¡Œå®Œæ¯•
      condition.signalAll();
    }finally {
      lock.unlock();
    }

  }
}
```

#### 4ï¼‰Conditionçš„ä¼˜åŠ¿

ç²¾å‡†çš„é€šçŸ¥å’Œå”¤é†’çš„çº¿ç¨‹ï¼

**å¦‚æœæˆ‘ä»¬è¦æŒ‡å®šé€šçŸ¥çš„ä¸‹ä¸€ä¸ªè¿›è¡Œé¡ºåºæ€ä¹ˆåŠå‘¢ï¼Ÿ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Conditionæ¥æŒ‡å®šé€šçŸ¥è¿›ç¨‹~**

ä»»ä½•ä¸€ä¸ªæ–°çš„æŠ€æœ¯ï¼Œç»å¯¹ä¸æ˜¯ä»…ä»…åªæ˜¯è¦†ç›–äº†åŸæ¥çš„æŠ€æœ¯ï¼Œä¼˜åŠ¿å’Œè¡¥å……ï¼

```java
/**
 * Descriptionï¼š
 * A æ‰§è¡Œå®Œ è°ƒç”¨B
 * B æ‰§è¡Œå®Œ è°ƒç”¨C
 * C æ‰§è¡Œå®Œ è°ƒç”¨A
 *
 * @author jiaoqianjin
 * Date: 2020/8/11 9:58
 **/

public class C {
  public static void main(String[] args) {
    Data3 data3 = new Data3();

    new Thread(()  -> {
      for (int i = 0; i < 10; i++) {
        data3.printA();
      }
    },"A").start();
    new Thread(() -> {
      for (int i = 0; i < 10; i++) {
        data3.printB();
      }
    },"B").start();
    new Thread(() -> {
      for (int i = 0; i < 10; i++) {
        data3.printC();
      }
    },"C").start();
  }

}
class Data3 {
  private Lock lock = new ReentrantLock();
  private Condition condition1 = lock.newCondition();
  private Condition condition2 = lock.newCondition();
  private Condition condition3 = lock.newCondition();
  private int num = 1; // 1A 2B 3C

  public void printA() {
    lock.lock();
    try {
      // ä¸šåŠ¡ä»£ç  åˆ¤æ–­ -> æ‰§è¡Œ -> é€šçŸ¥
      while (num != 1) {
        condition1.await();
      }
      System.out.println(Thread.currentThread().getName() + "==> AAAA" );
      num = 2;
      condition2.signal();
    }catch (Exception e) {
      e.printStackTrace();
    }finally {
      lock.unlock();
    }
  }
  public void printB() {
    lock.lock();
    try {
      // ä¸šåŠ¡ä»£ç  åˆ¤æ–­ -> æ‰§è¡Œ -> é€šçŸ¥
      while (num != 2) {
        condition2.await();
      }
      System.out.println(Thread.currentThread().getName() + "==> BBBB" );
      num = 3;
      condition3.signal();
    }catch (Exception e) {
      e.printStackTrace();
    }finally {
      lock.unlock();
    }
  }
  public void printC() {
    lock.lock();
    try {
      // ä¸šåŠ¡ä»£ç  åˆ¤æ–­ -> æ‰§è¡Œ -> é€šçŸ¥
      while (num != 3) {
        condition3.await();
      }
      System.out.println(Thread.currentThread().getName() + "==> CCCC" );
      num = 1;
      condition1.signal();
    }catch (Exception e) {
      e.printStackTrace();
    }finally {
      lock.unlock();
    }
  }
}
/*
A==> AAAA
B==> BBBB
C==> CCCC
A==> AAAA
B==> BBBB
C==> CCCC
...
*/
```

### 2.5 8é”ç°è±¡

å¦‚ä½•åˆ¤æ–­é”çš„æ˜¯è°ï¼é”åˆ°åº•é”çš„æ˜¯è°ï¼Ÿ

é”ä¼šé”ä½ï¼šå¯¹è±¡ã€Class

æ·±åˆ»ç†è§£æˆ‘ä»¬çš„é”

**é—®é¢˜1**

ä¸¤ä¸ªåŒæ­¥æ–¹æ³•ï¼Œå…ˆæ‰§è¡Œå‘çŸ­ä¿¡è¿˜æ˜¯æ‰“ç”µè¯

```java
public class dome01 {
    public static void main(String[] args) {
        Phone phone = new Phone();

        new Thread(() -> { phone.sendMs(); }).start();
        TimeUnit.SECONDS.sleep(1);
        new Thread(() -> { phone.call(); }).start();
    }
}

class Phone {
    public synchronized void sendMs() {
        System.out.println("å‘çŸ­ä¿¡");
    }
    public synchronized void call() {
        System.out.println("æ‰“ç”µè¯");
    }
}

```

**è¾“å‡ºç»“æœä¸º**

å‘çŸ­ä¿¡

æ‰“ç”µè¯

**ä¸ºä»€ä¹ˆï¼Ÿ å¦‚æœä½ è®¤ä¸ºæ¯æ¬¡éƒ½ä¸ä¸€æ ·ï¼Ÿ è¿™ä¸ªç­”æ¡ˆæ˜¯é”™è¯¯çš„ï¼**

**é—®é¢˜2ï¼š**

**æˆ‘ä»¬å†æ¥çœ‹ï¼šæˆ‘ä»¬è®©å‘çŸ­ä¿¡ å»¶è¿Ÿ4s**

```java
public class dome0 {
    public static void main(String[] args) throws InterruptedException {
        Phone phone = new Phone();

        new Thread(() -> {
            try {
                phone.sendMs();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
        TimeUnit.SECONDS.sleep(1);
        new Thread(() -> { phone.call(); }).start();
    }
}

class Phone {
    public synchronized void sendMs() throws InterruptedException {
        TimeUnit.SECONDS.sleep(4);
        System.out.println("å‘çŸ­ä¿¡");
    }
    public synchronized void call() {
        System.out.println("æ‰“ç”µè¯");
    }
}

```

ç°åœ¨ç»“æœæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

ç»“æœï¼š**è¿˜æ˜¯å…ˆå‘çŸ­ä¿¡ï¼Œç„¶åå†æ‰“ç”µè¯ï¼**

> åŸå› ï¼šå¹¶ä¸æ˜¯é¡ºåºæ‰§è¡Œï¼Œè€Œæ˜¯synchronized é”ä½çš„å¯¹è±¡æ˜¯æ–¹æ³•çš„è°ƒç”¨è€…ï¼Œä¹Ÿå°±æ˜¯`phone`ï¼å¯¹äºä¸¤ä¸ªæ–¹æ³•ç”¨çš„æ˜¯åŒä¸€ä¸ªé”ï¼Œ==è°å…ˆæ‹¿åˆ°è°å…ˆæ‰§è¡Œ==ï¼Œå¦å¤–ä¸€ä¸ªç­‰å¾…

**é—®é¢˜ä¸‰**

åŠ ä¸€ä¸ªæ™®é€šæ–¹æ³•

```java
public class dome03 {
    public static void main(String[] args) throws InterruptedException {
        Phone phone = new Phone();

        new Thread(() -> {
            try {
                phone.sendMs();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
        TimeUnit.SECONDS.sleep(1);
        new Thread(() -> { phone.hello(); }).start();
    }
}

class Phone {
    public synchronized void sendMs() throws InterruptedException {
        TimeUnit.SECONDS.sleep(4);
        System.out.println("å‘çŸ­ä¿¡");
    }
    public synchronized void call() {
        System.out.println("æ‰“ç”µè¯");
    }
    public void hello() {
        System.out.println("hello");
    }
}

```

è¾“å‡ºç»“æœä¸º

hello

å‘çŸ­ä¿¡

> åŸå› ï¼šhelloæ˜¯ä¸€ä¸ªæ™®é€šæ–¹æ³•ï¼Œä¸å—synchronizedé”çš„å½±å“ï¼Œä¸ç”¨ç­‰å¾…é”çš„é‡Šæ”¾

**é—®é¢˜å››**

**å¦‚æœæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ä¸¤ä¸ªå¯¹è±¡ï¼Œä¸€ä¸ªè°ƒç”¨å‘çŸ­ä¿¡ï¼Œä¸€ä¸ªè°ƒç”¨æ‰“ç”µè¯ï¼Œé‚£ä¹ˆæ•´ä¸ªé¡ºåºæ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿ**

```java
public class dome04 {
    public static void main(String[] args) throws InterruptedException {
        Phone phone1 = new Phone();
        Phone phone2 = new Phone();

        new Thread(() -> {
            try {
                phone1.sendMs();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
        TimeUnit.SECONDS.sleep(1);
        new Thread(() -> { phone2.call(); }).start();
    }
}

class Phone {
    public synchronized void sendMs() throws InterruptedException {
        TimeUnit.SECONDS.sleep(4);
        System.out.println("å‘çŸ­ä¿¡");
    }
    public synchronized void call() {
        System.out.println("æ‰“ç”µè¯");
    }
    public void hello() {
        System.out.println("hello");
    }
}

```

è¾“å‡ºç»“æœ

æ‰“ç”µè¯

å‘çŸ­ä¿¡

> åŸå› ï¼šä¸¤ä¸ªå¯¹è±¡ä¸¤æŠŠé”ï¼Œä¸ä¼šå‡ºç°ç­‰å¾…çš„æƒ…å†µï¼Œå‘çŸ­ä¿¡ç¡äº†4s,æ‰€ä»¥å…ˆæ‰§è¡Œæ‰“ç”µè¯

**é—®é¢˜äº”ã€å…­**

**å¦‚æœæˆ‘ä»¬æŠŠsynchronizedçš„æ–¹æ³•åŠ ä¸Šstaticå˜æˆé™æ€æ–¹æ³•ï¼é‚£ä¹ˆé¡ºåºåˆæ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿ**

ï¼ˆ1ï¼‰æˆ‘ä»¬å…ˆæ¥ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡è°ƒç”¨ä¸¤ä¸ªæ–¹æ³•ï¼

ç­”æ¡ˆæ˜¯ï¼šå…ˆå‘çŸ­ä¿¡,åæ‰“ç”µè¯

ï¼ˆ2ï¼‰å¦‚æœæˆ‘ä»¬ä½¿ç”¨ä¸¤ä¸ªå¯¹è±¡è°ƒç”¨ä¸¤ä¸ªæ–¹æ³•ï¼

ç­”æ¡ˆæ˜¯ï¼šè¿˜æ˜¯å…ˆå‘çŸ­ä¿¡ï¼Œåæ‰“ç”µè¯

åŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ ä¸ºä»€ä¹ˆåŠ äº†staticå°±å§‹ç»ˆå‰é¢ä¸€ä¸ªå¯¹è±¡å…ˆæ‰§è¡Œå‘¢ï¼ä¸ºä»€ä¹ˆåé¢ä¼šç­‰å¾…å‘¢ï¼Ÿ

åŸå› æ˜¯ï¼š**å¯¹äºstaticé™æ€æ–¹æ³•æ¥è¯´ï¼Œå¯¹äºæ•´ä¸ªç±»Classæ¥è¯´åªæœ‰ä¸€ä»½ï¼Œç±»ä¸€åŠ è½½å°±æœ‰äº†ï¼Œ==å¯¹äºä¸åŒçš„å¯¹è±¡ä½¿ç”¨çš„æ˜¯åŒä¸€ä»½æ–¹æ³•==ï¼Œç›¸å½“äºè¿™ä¸ªæ–¹æ³•æ˜¯å±äºè¿™ä¸ªç±»çš„ï¼Œå¦‚æœé™æ€staticæ–¹æ³•ä½¿ç”¨synchronizedé”å®šï¼Œé‚£ä¹ˆè¿™ä¸ªsynchronizedé”ä¼šé”ä½æ•´ä¸ªå¯¹è±¡ï¼==ä¸ç®¡å¤šå°‘ä¸ªå¯¹è±¡ï¼Œå¯¹äºé™æ€çš„é”éƒ½åªæœ‰ä¸€æŠŠé”==ï¼Œè°å…ˆæ‹¿åˆ°è¿™ä¸ªé”å°±å…ˆæ‰§è¡Œï¼Œå…¶ä»–çš„è¿›ç¨‹éƒ½éœ€è¦ç­‰å¾…ï¼**

**é—®é¢˜ä¸ƒ**

**å¦‚æœæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªé™æ€åŒæ­¥æ–¹æ³•ã€ä¸€ä¸ªåŒæ­¥æ–¹æ³•ã€ä¸€ä¸ªå¯¹è±¡è°ƒç”¨é¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ**

```java
public class dome07 {
    public static void main(String[] args) throws InterruptedException {
        Phone phone1 = new Phone();
//        Phone phone2 = new Phone();

        new Thread(() -> { 
            try {
                phone1.sendMs();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
        TimeUnit.SECONDS.sleep(1);
        new Thread(() -> { phone1.call(); }).start();
    }
}

class Phone {
    public static synchronized void sendMs() throws InterruptedException {
        TimeUnit.SECONDS.sleep(4);
        System.out.println("å‘çŸ­ä¿¡");
    }
    public synchronized void call() {
        System.out.println("æ‰“ç”µè¯");
    }
    public void hello() {
        System.out.println("hello");
    }
}

```

è¾“å‡ºç»“æœ

æ‰“ç”µè¯

å‘çŸ­ä¿¡

> åŸå› ï¼šå› ä¸ºä¸€ä¸ªé”çš„æ˜¯Classç±»çš„æ¨¡æ¿ï¼Œä¸€ä¸ªé”çš„æ˜¯å¯¹è±¡çš„è°ƒç”¨è€…ã€‚æ‰€ä»¥ä¸å­˜åœ¨ç­‰å¾…ï¼Œç›´æ¥è¿è¡Œã€‚

**é—®é¢˜å…«**

**å¦‚æœæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªé™æ€åŒæ­¥æ–¹æ³•ã€ä¸€ä¸ªåŒæ­¥æ–¹æ³•ã€ä¸¤ä¸ªå¯¹è±¡è°ƒç”¨é¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ**

```java
public class dome08 {
    public static void main(String[] args) throws InterruptedException {
        Phone phone1 = new Phone();
        Phone phone2 = new Phone();

        new Thread(() -> {
            try {
                phone1.sendMs();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
        TimeUnit.SECONDS.sleep(1);
        new Thread(() -> { phone2.call(); }).start();
    }
}

class Phone {
    public static synchronized void sendMs() throws InterruptedException {
        TimeUnit.SECONDS.sleep(4);
        System.out.println("å‘çŸ­ä¿¡");
    }
    public synchronized void call() {
        System.out.println("æ‰“ç”µè¯");
    }
    public void hello() {
        System.out.println("hello");
    }
}

```

è¾“å‡ºç»“æœ

æ‰“ç”µè¯

å‘çŸ­ä¿¡

> åŸå› ï¼šä¸¤æŠŠé”é”çš„ä¸æ˜¯åŒä¸€ä¸ªä¸œè¥¿

**å°ç»“**

**new** å‡ºæ¥çš„ this æ˜¯å…·ä½“çš„ä¸€ä¸ªå¯¹è±¡ï¼ˆæ‰‹æœºï¼‰

**static Class** æ˜¯å”¯ä¸€çš„ä¸€ä¸ªæ¨¡æ¿



## 3. é›†åˆä¸å®‰å…¨

### 3.1 List ä¸å®‰å…¨

```java
//java.util.ConcurrentModificationException å¹¶å‘ä¿®æ”¹å¼‚å¸¸ï¼
public class ListTest {
    public static void main(String[] args) {

        List<Object> arrayList = new ArrayList<>();

        for(int i=1;i<=10;i++){
            new Thread(()->{
                arrayList.add(UUID.randomUUID().toString().substring(0,5));
                System.out.println(arrayList);
            },String.valueOf(i)).start();
        }

    }
}

```

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250106232846376.png)

ä¼šå¯¼è‡´ java.util.ConcurrentModificationException å¹¶å‘ä¿®æ”¹å¼‚å¸¸ï¼

**ArrayList åœ¨å¹¶å‘æƒ…å†µä¸‹æ˜¯ä¸å®‰å…¨çš„**

`ArrayList` æ²¡æœ‰åŒæ­¥å¼€é”€ï¼Œæ€§èƒ½æ›´é«˜ï¼Œåœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œ`ArrayList` æ˜¯æ›´å¥½çš„é€‰æ‹©ï¼›å¦‚æœéœ€è¦çº¿ç¨‹å®‰å…¨ï¼Œå¯ä»¥ä½¿ç”¨ `Collections.synchronizedList()` æˆ– `CopyOnWriteArrayList`ã€‚

è§£å†³æ–¹æ¡ˆï¼š

```java
public class ListTest2 {
    public static void main(String[] args) {
        /**
         * è§£å†³æ–¹æ¡ˆ
         * 1. List<String> list = new Vector<>();
         * 2. List<String> list = Collections.synchronizedList(new ArrayList<>());
         * 3. List<String> list = new CopyOnWriteArrayList<>();
         */
        List<String> list = new CopyOnWriteArrayList<>();
        

        for (int i = 1; i <=10; i++) {
            new Thread(() -> {
                list.add(UUID.randomUUID().toString().substring(0,5));
                System.out.println(list);
            },String.valueOf(i)).start();
        }
    }
}

```

**CopyOnWriteArrayListï¼šå†™å…¥æ—¶å¤åˆ¶ï¼ COW è®¡ç®—æœºç¨‹åºè®¾è®¡é¢†åŸŸçš„ä¸€ç§ä¼˜åŒ–ç­–ç•¥**

æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå¦‚æœæœ‰å¤šä¸ªè°ƒç”¨è€…ï¼ˆCallersï¼‰åŒæ—¶è¦æ±‚ç›¸åŒçš„èµ„æºï¼ˆå¦‚å†…å­˜æˆ–è€…æ˜¯ç£ç›˜ä¸Šçš„æ•°æ®å­˜å‚¨ï¼‰ï¼Œä»–ä»¬ä¼šå…±åŒè·å–ç›¸åŒçš„æŒ‡é’ˆæŒ‡å‘ç›¸åŒçš„èµ„æºï¼Œç›´åˆ°æŸä¸ªè°ƒç”¨è€…è§†å›¾ä¿®æ”¹èµ„æºå†…å®¹æ—¶ï¼Œç³»ç»Ÿæ‰ä¼šçœŸæ­£å¤åˆ¶ä¸€ä»½ä¸“ç”¨å‰¯æœ¬ï¼ˆprivate copyï¼‰ç»™è¯¥è°ƒç”¨è€…ï¼Œè€Œå…¶ä»–è°ƒç”¨è€…æ‰€è§åˆ°çš„æœ€åˆçš„èµ„æºä»ç„¶ä¿æŒä¸å˜ã€‚è¿™è¿‡ç¨‹å¯¹å…¶ä»–çš„è°ƒç”¨è€…éƒ½æ˜¯é€æ˜çš„ï¼ˆtransparentlyï¼‰ã€‚æ­¤åšæ³•ä¸»è¦çš„ä¼˜ç‚¹æ˜¯å¦‚æœè°ƒç”¨è€…æ²¡æœ‰ä¿®æ”¹èµ„æºï¼Œå°±ä¸ä¼šæœ‰å‰¯æœ¬ï¼ˆprivate copyï¼‰è¢«åˆ›å»ºï¼Œå› æ­¤å¤šä¸ªè°ƒç”¨è€…åªæ˜¯è¯»å–æ“ä½œæ—¶å¯ä»¥å…±äº«åŒä¸€ä»½èµ„æºã€‚

è¯»çš„æ—¶å€™ä¸éœ€è¦åŠ é”ï¼Œå¦‚æœè¯»çš„æ—¶å€™æœ‰å¤šä¸ªçº¿ç¨‹æ­£åœ¨å‘CopyOnWriteArrayListæ·»åŠ æ•°æ®ï¼Œè¯»è¿˜æ˜¯ä¼šè¯»åˆ°æ—§çš„æ•°æ®ï¼Œå› ä¸º==å†™çš„æ—¶å€™ä¸ä¼šé”ä½æ—§çš„CopyOnWriteArrayList==ã€‚

å¤šä¸ªçº¿ç¨‹è°ƒç”¨çš„æ—¶å€™ï¼Œlistï¼Œè¯»å–çš„æ—¶å€™ï¼Œå›ºå®šçš„ï¼Œå†™å…¥ï¼ˆå­˜åœ¨è¦†ç›–æ“ä½œï¼‰ï¼›åœ¨å†™å…¥çš„æ—¶å€™é¿å…è¦†ç›–ï¼Œé€ æˆæ•°æ®é”™ä¹±çš„é—®é¢˜ï¼›

> **CopyOnWriteArrayList**æ¯”**Vector**å‰å®³åœ¨å“ªé‡Œï¼Ÿ

**Vector**åº•å±‚æ˜¯ä½¿ç”¨**synchronized**å…³é”®å­—æ¥å®ç°çš„ï¼šæ•ˆç‡ç‰¹åˆ«ä½ä¸‹ã€‚

![image-20200811144549151](https://i-blog.csdnimg.cn/blog_migrate/0416989100c4f7a96c92e57d55fc7847.png)

**CopyOnWriteArrayList**ä½¿ç”¨çš„æ˜¯Locké”ï¼Œæ•ˆç‡ä¼šæ›´åŠ é«˜æ•ˆï¼

![image-20200811144447781](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/e0f9043074bdd316f04392ef6f7695a9.png)

### 3.1 set ä¸å®‰å…¨

**Setå’ŒListåŒç†å¯å¾—:** å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œæ™®é€šçš„Seté›†åˆæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼›

è§£å†³æ–¹æ¡ˆè¿˜æ˜¯ä¸¤ç§ï¼š

+   ä½¿ç”¨Collectionså·¥å…·ç±»çš„**synchronized**åŒ…è£…çš„Setç±»
+   ä½¿ç”¨CopyOnWriteArraySet å†™å…¥å¤åˆ¶çš„**JUC**è§£å†³æ–¹æ¡ˆ

```java
public class SetTest {
    public static void main(String[] args) {
        /**
         * 1. Set<String> set = Collections.synchronizedSet(new HashSet<>());
         * 2. Set<String> set = new CopyOnWriteArraySet<>();
         */
//        Set<String> set = new HashSet<>();
        Set<String> set = new CopyOnWriteArraySet<>();

        for (int i = 1; i <= 30; i++) {
            new Thread(() -> {
                set.add(UUID.randomUUID().toString().substring(0,5));
                System.out.println(set);
            },String.valueOf(i)).start();
        }
    }
}

```

**HashSetåº•å±‚æ˜¯ä»€ä¹ˆï¼Ÿ**

hashSetåº•å±‚å°±æ˜¯ä¸€ä¸ª**HashMap**ï¼›

![image-20200811150415187](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/ec4dd386dc4c13efa5744e1c7eeb1caa.png)

### 3.3 Mapä¸å®‰å…¨

```java
//map æ˜¯è¿™æ ·ç”¨çš„å—ï¼Ÿ  ä¸æ˜¯ï¼Œå·¥ä½œä¸­ä¸ä½¿ç”¨è¿™ä¸ª
//é»˜è®¤ç­‰ä»·ä»€ä¹ˆï¼Ÿ new HashMap<>(16,0.75);
Map<String, String> map = new HashMap<>();
//åŠ è½½å› å­ã€åˆå§‹åŒ–å®¹é‡

```

é»˜è®¤**åŠ è½½å› å­æ˜¯0.75**,é»˜è®¤çš„**åˆå§‹å®¹é‡æ˜¯16**

![image-20200811150700927](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/9e8d6c23617731b1d38f2d9abc3ac226.png)

åŒæ ·çš„HashMapåŸºç¡€ç±»ä¹Ÿå­˜åœ¨**å¹¶å‘ä¿®æ”¹å¼‚å¸¸**ï¼

```java
public class MapTest {
    public static void main(String[] args) {
        //map æ˜¯è¿™æ ·ç”¨çš„å—ï¼Ÿ  ä¸æ˜¯ï¼Œå·¥ä½œä¸­ä¸ä½¿ç”¨è¿™ä¸ª
        //é»˜è®¤ç­‰ä»·ä»€ä¹ˆï¼Ÿ new HashMap<>(16,0.75);
        /**
         * è§£å†³æ–¹æ¡ˆ
         * 1. Map<String, String> map = Collections.synchronizedMap(new HashMap<>());
         *  Map<String, String> map = new ConcurrentHashMap<>();
         */
        Map<String, String> map = new ConcurrentHashMap<>();
        //åŠ è½½å› å­ã€åˆå§‹åŒ–å®¹é‡
        for (int i = 1; i < 100; i++) {
            new Thread(()->{
                map.put(Thread.currentThread().getName(), UUID.randomUUID().toString().substring(0,5));
                System.out.println(map);
            },String.valueOf(i)).start();
        }
    }
}

```

## 4. Callable

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/620ba134794217421f96814f8cdc53eb.png)

**1ã€å¯ä»¥æœ‰è¿”å›å€¼ï¼›  
2ã€å¯ä»¥æŠ›å‡ºå¼‚å¸¸ï¼›  
3ã€æ–¹æ³•ä¸åŒï¼Œrun()/call()**

- åœ¨å¾ªç¯ä¸­ï¼Œæ¯æ¬¡åˆ›å»ºä¸€ä¸ª `MyThread1` å®ä¾‹ï¼Œå¹¶å°†å…¶åŒ…è£…åˆ° `FutureTask` ä¸­ã€‚
- å°† `FutureTask` æ”¾å…¥ `Thread` ä¸­å¯åŠ¨çº¿ç¨‹ã€‚
- è°ƒç”¨ `futureTask.get()` è·å– `call` æ–¹æ³•çš„è¿”å›å€¼ã€‚

```java
package com.qtp.callable;

import java.util.concurrent.Callable;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.FutureTask;

public class CallableTest {
    public static void main(String[] args) throws ExecutionException, InterruptedException {
//        for (int i = 1; i < 10; i++) {
//            MyThread1 myThread1 = new MyThread1();
//
//            FutureTask<Integer> futureTask = new FutureTask<>(myThread1);
//            // æ”¾å…¥Threadä¸­ä½¿ç”¨ï¼Œç»“æœä¼šè¢«ç¼“å­˜
//            new Thread(futureTask,String.valueOf(i)).start();
//            // è¿™ä¸ªgetæ–¹æ³•å¯èƒ½ä¼šè¢«é˜»å¡ï¼Œå¦‚æœåœ¨callæ–¹æ³•ä¸­æ˜¯ä¸€ä¸ªè€—æ—¶çš„æ–¹æ³•ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µæˆ‘ä»¬ä¼šæŠŠè¿™ä¸ªæ”¾åœ¨æœ€åï¼Œæˆ–è€…ä½¿ç”¨å¼‚æ­¥é€šä¿¡
//            int a = futureTask.get();
//            System.out.println("è¿”å›å€¼:" + a);
//        }
        MyThread1 myThread1 = new MyThread1();
        FutureTask<String> futureTask = new FutureTask<>(myThread1);
        new Thread(futureTask,"A").start();
        new Thread(futureTask,"B").start();
        System.out.println(futureTask.get());//è¿™ä¸ªgetæ–¹æ³•å¯èƒ½ä¼šäº§ç”Ÿé˜»å¡ï¼æŠŠä»–æ”¾åˆ°æœ€åï¼Œæˆ–è€…ä½¿ç”¨å¼‚æ­¥é€šä¿¡æ¥å¤„ç†
    }
}
class MyThread1 implements Callable<String> {

    @Override
    public String call() throws Exception {
        System.out.println("å½“å‰çº¿ç¨‹åç§°: " + Thread.currentThread().getName());
        return 1024+":"+Thread.currentThread().getName();

    }
}

```

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250107174217104.png)

å¦‚æœå¤šä¸ªçº¿ç¨‹å…±äº«åŒä¸€ä¸ª `FutureTask` å®ä¾‹ï¼Œ`FutureTask` å†…éƒ¨çš„ `call` æ–¹æ³•åªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚è¿™æ˜¯å› ä¸º `FutureTask` çš„è®¾è®¡æ˜¯ä¸ºäº†ç¡®ä¿ä»»åŠ¡åªæ‰§è¡Œä¸€æ¬¡ï¼Œå¹¶å°†ç»“æœç¼“å­˜èµ·æ¥ï¼Œä¾›åç»­çš„ `get` æ–¹æ³•è°ƒç”¨ã€‚

ç»†èŠ‚ï¼š

1. æœ‰ç¼“å­˜
2. ç»“æœå¯èƒ½éœ€è¦ç­‰å¾…ï¼Œä¼šé˜»å¡

## 5. å¸¸ç”¨çš„è¾…åŠ©ç±»

### 1ï¼‰CountDownLatch

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250107175005677.png)

```java
public class CountDownLatchDemo {
    public static void main(String[] args) throws InterruptedException {
        // æ€»æ•°æ˜¯6
        CountDownLatch countDownLatch = new CountDownLatch(6);

        for (int i = 1; i <= 6; i++) {
            new Thread(() -> {
                System.out.println(Thread.currentThread().getName() + "==> Go Out");
                countDownLatch.countDown(); // æ¯ä¸ªçº¿ç¨‹éƒ½æ•°é‡ -1
            },String.valueOf(i)).start();
        }
        countDownLatch.await(); // ç­‰å¾…è®¡æ•°å™¨å½’é›¶ ç„¶åå‘ä¸‹æ‰§è¡Œ
        System.out.println("close door");
    }
}

```

ä¸»è¦æ–¹æ³•ï¼š

+   countDown å‡ä¸€æ“ä½œï¼›
+   await ç­‰å¾…è®¡æ•°å™¨å½’é›¶

await ç­‰å¾…è®¡æ•°å™¨å½’é›¶ï¼Œå°±å”¤é†’ï¼Œå†ç»§ç»­å‘ä¸‹è¿è¡Œ

å¦‚æœè®¡æ•°å™¨æ˜¯6ï¼Œåªå‡äº†5æ¬¡ï¼Œé‚£ä¼šä¸€ç›´ç­‰å¾…ã€‚

### 2ï¼‰CyclickBarrier

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250108095236184.png)

```java
public class CyclicBarrierDemo {
    public static void main(String[] args) {
        // ä¸»çº¿ç¨‹
        CyclicBarrier cyclicBarrier = new CyclicBarrier(7,() -> {
            System.out.println("å¬å”¤ç¥é¾™");
        });

        for (int i = 1; i <= 7; i++) {
            // å­çº¿ç¨‹
            int finalI = i;
            new Thread(() -> {
                System.out.println(Thread.currentThread().getName() + "æ”¶é›†äº†ç¬¬" + finalI + "é¢—é¾™ç ");
                try {
                    /**
                    æ¯ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œåˆ° await() æ–¹æ³•æ—¶ï¼Œä¼šé˜»å¡å¹¶ç­‰å¾…å…¶ä»–çº¿ç¨‹ä¹Ÿè°ƒç”¨ await() æ–¹æ³•ã€‚æ¯å½“ä¸€ä¸ªçº¿ç¨‹è°ƒ				    ç”¨ await() æ–¹æ³•æ—¶ï¼ŒCyclicBarrier çš„å†…éƒ¨è®¡æ•°å™¨ä¼šå‡ä¸€ï¼ˆè€Œä¸æ˜¯åŠ ä¸€ï¼‰ï¼Œç›´åˆ°è®¡æ•°å™¨å‡åˆ° 0ï¼Œå±   					éšœæ‰ä¼šæ‰“å¼€ã€‚
                    */
                    cyclicBarrier.await(); // åŠ æ³•è®¡æ•° ç­‰å¾…
                } catch (InterruptedException e) {
                    e.printStackTrace();
                } catch (BrokenBarrierException e) {
                    e.printStackTrace();
                }
            }).start();
        }
    }
}

```

### 3ï¼‰Semaphore

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250108100236315.png)

```java
public class SemaphoreDemo {
    public static void main(String[] args) {

        // çº¿ç¨‹æ•°é‡ï¼Œåœè½¦ä½ï¼Œé™æµ
        // æœ‰é™çš„æ¡ä»¶ä¸‹ï¼Œæœ‰åºï¼
        Semaphore semaphore = new Semaphore(3);
        for (int i = 0; i <= 6; i++) {
            new Thread(() -> {
                // acquire() å¾—åˆ°
                try {
                    semaphore.acquire();
                    System.out.println(Thread.currentThread().getName() + "æŠ¢åˆ°è½¦ä½");
                    TimeUnit.SECONDS.sleep(2);
                    System.out.println(Thread.currentThread().getName() + "ç¦»å¼€è½¦ä½");
                }catch (Exception e) {
                    e.printStackTrace();
                }finally {
                    semaphore.release(); // release() é‡Šæ”¾
                }
            }).start();
        }
    }
}

```

åŸç†ï¼š

**semaphore.acquire()è·å¾—èµ„æºï¼Œå¦‚æœèµ„æºå·²ç»ä½¿ç”¨å®Œäº†ï¼Œå°±ç­‰å¾…èµ„æºé‡Šæ”¾åå†è¿›è¡Œä½¿ç”¨ï¼**

**semaphore.release()é‡Šæ”¾ï¼Œä¼šå°†å½“å‰çš„ä¿¡å·é‡é‡Šæ”¾+1ï¼Œç„¶åå”¤é†’ç­‰å¾…çš„çº¿ç¨‹ï¼**

ä½œç”¨ï¼š å¤šä¸ªå…±äº«èµ„æºäº’æ–¥çš„ä½¿ç”¨ï¼ å¹¶å‘é™æµï¼Œæ§åˆ¶æœ€å¤§çš„çº¿ç¨‹æ•°ï¼

## 6. è¯»å†™é”

```java
public class ReadWriteLockDemo {
    public static void main(String[] args) {
        MyCache myCache = new MyCache();
        int num = 6;
        for (int i = 1; i <= num; i++) {
            int finalI = i;
            new Thread(() -> {

                myCache.write(String.valueOf(finalI), String.valueOf(finalI));

            },String.valueOf(i)).start();
        }

        for (int i = 1; i <= num; i++) {
            int finalI = i;
            new Thread(() -> {

                myCache.read(String.valueOf(finalI));

            },String.valueOf(i)).start();
        }
    }
}

/**
 *  æ–¹æ³•æœªåŠ é”ï¼Œå¯¼è‡´å†™çš„æ—¶å€™è¢«æ’é˜Ÿ
 */
class MyCache {
    private volatile Map<String, String> map = new HashMap<>();

    public void write(String key, String value) {
        System.out.println(Thread.currentThread().getName() + "çº¿ç¨‹å¼€å§‹å†™å…¥");
        map.put(key, value);
        System.out.println(Thread.currentThread().getName() + "çº¿ç¨‹å†™å…¥ok");
    }

    public void read(String key) {
        System.out.println(Thread.currentThread().getName() + "çº¿ç¨‹å¼€å§‹è¯»å–");
        map.get(key);
        System.out.println(Thread.currentThread().getName() + "çº¿ç¨‹å†™è¯»å–ok");
    }
}


```

```

2çº¿ç¨‹å¼€å§‹å†™å…¥
2çº¿ç¨‹å†™å…¥ok
3çº¿ç¨‹å¼€å§‹å†™å…¥
3çº¿ç¨‹å†™å…¥ok
1çº¿ç¨‹å¼€å§‹å†™å…¥    # æ’å…¥äº†å…¶ä»–çº¿ç¨‹çš„å†™å…¥ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´
4çº¿ç¨‹å¼€å§‹å†™å…¥
4çº¿ç¨‹å†™å…¥ok
1çº¿ç¨‹å†™å…¥ok
6çº¿ç¨‹å¼€å§‹å†™å…¥
6çº¿ç¨‹å†™å…¥ok
5çº¿ç¨‹å¼€å§‹å†™å…¥
5çº¿ç¨‹å†™å…¥ok
1çº¿ç¨‹å¼€å§‹è¯»å–
1çº¿ç¨‹å†™è¯»å–ok
2çº¿ç¨‹å¼€å§‹è¯»å–
2çº¿ç¨‹å†™è¯»å–ok
3çº¿ç¨‹å¼€å§‹è¯»å–
3çº¿ç¨‹å†™è¯»å–ok
4çº¿ç¨‹å¼€å§‹è¯»å–
4çº¿ç¨‹å†™è¯»å–ok
5çº¿ç¨‹å¼€å§‹è¯»å–
6çº¿ç¨‹å¼€å§‹è¯»å–
6çº¿ç¨‹å†™è¯»å–ok
5çº¿ç¨‹å†™è¯»å–ok

Process finished with exit code 0

```

<img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250108105002494.png" alt="image-20250108105002494" style="zoom:80%;" />

æ‰€ä»¥å¦‚æœæˆ‘ä»¬ä¸åŠ é”çš„æƒ…å†µï¼Œå¤šçº¿ç¨‹çš„è¯»å†™ä¼šé€ æˆæ•°æ®ä¸å¯é çš„é—®é¢˜ã€‚

ä½ å†™å…¥1çš„æ—¶å€™ï¼Œå†™å¦‚okä¹Ÿè¦è¾“å‡ºæ‰ç®—å®Œæˆï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™æ’å…¥è¿›æ¥äº†ä¸€ä¸ªçº¿ç¨‹2ã€‚

æˆ‘ä»¬ä¹Ÿå¯ä»¥é‡‡ç”¨**synchronized**è¿™ç§é‡é‡é”å’Œè½»é‡é” **lock**å»ä¿è¯æ•°æ®çš„å¯é ã€‚

ä½†æ˜¯è¿™æ¬¡æˆ‘ä»¬é‡‡ç”¨æ›´ç»†ç²’åº¦çš„é”ï¼š**ReadWriteLock** è¯»å†™é”æ¥ä¿è¯

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/ce8087d0b38209517e3b2ba36c798d29.png)

```java
public class ReadWriteLockDemo {
    public static void main(String[] args) {
        MyCache2 myCache = new MyCache2();
        int num = 6;
        for (int i = 1; i <= num; i++) {
            int finalI = i;
            new Thread(() -> {

                myCache.write(String.valueOf(finalI), String.valueOf(finalI));

            },String.valueOf(i)).start();
        }

        for (int i = 1; i <= num; i++) {
            int finalI = i;
            new Thread(() -> {

                myCache.read(String.valueOf(finalI));

            },String.valueOf(i)).start();
        }
    }

}
class MyCache2 {
    private volatile Map<String, String> map = new HashMap<>();
    private ReadWriteLock lock = new ReentrantReadWriteLock();

    public void write(String key, String value) {
        lock.writeLock().lock(); // å†™é”
        try {
            System.out.println(Thread.currentThread().getName() + "çº¿ç¨‹å¼€å§‹å†™å…¥");
            map.put(key, value);
            System.out.println(Thread.currentThread().getName() + "çº¿ç¨‹å†™å…¥ok");

        }finally {
            lock.writeLock().unlock(); // é‡Šæ”¾å†™é”
        }
    }

    public void read(String key) {
        lock.readLock().lock(); // è¯»é”
        try {
            System.out.println(Thread.currentThread().getName() + "çº¿ç¨‹å¼€å§‹è¯»å–");
            map.get(key);
            System.out.println(Thread.currentThread().getName() + "çº¿ç¨‹å†™è¯»å–ok");
        }finally {
            lock.readLock().unlock(); // é‡Šæ”¾è¯»é”
        }
    }
}

```

```
1çº¿ç¨‹å¼€å§‹å†™å…¥
1çº¿ç¨‹å†™å…¥ok
6çº¿ç¨‹å¼€å§‹å†™å…¥
6çº¿ç¨‹å†™å…¥ok
3çº¿ç¨‹å¼€å§‹å†™å…¥
3çº¿ç¨‹å†™å…¥ok
2çº¿ç¨‹å¼€å§‹å†™å…¥
2çº¿ç¨‹å†™å…¥ok
5çº¿ç¨‹å¼€å§‹å†™å…¥
5çº¿ç¨‹å†™å…¥ok
4çº¿ç¨‹å¼€å§‹å†™å…¥
4çº¿ç¨‹å†™å…¥ok
    
1çº¿ç¨‹å¼€å§‹è¯»å–
5çº¿ç¨‹å¼€å§‹è¯»å–
2çº¿ç¨‹å¼€å§‹è¯»å–
1çº¿ç¨‹å†™è¯»å–ok
3çº¿ç¨‹å¼€å§‹è¯»å–
2çº¿ç¨‹å†™è¯»å–ok
6çº¿ç¨‹å¼€å§‹è¯»å–
6çº¿ç¨‹å†™è¯»å–ok
5çº¿ç¨‹å†™è¯»å–ok
4çº¿ç¨‹å¼€å§‹è¯»å–
4çº¿ç¨‹å†™è¯»å–ok
3çº¿ç¨‹å†™è¯»å–ok

Process finished with exit code 0

```

ä¼šå‘ç°ï¼Œå…¨å†™å®Œï¼Œæ‰ä¼šè¿›è¡Œè¯»æ“ä½œï¼è€Œä¸”è¯»é¡ºåºæ— 

```
ReadWriteLock
ç‹¬å é”ï¼ˆå†™é”ï¼‰ä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹å æœ‰
å…±äº«é”ï¼ˆè¯»é”ï¼‰å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶å æœ‰
è¯»-è¯» å¯ä»¥å…±å­˜ï¼
è¯»-å†™ ä¸èƒ½å…±å­˜ï¼
å†™-å†™ ä¸èƒ½å…±å­˜ï¼
```



## 7. é˜»å¡é˜Ÿåˆ—

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/82aa2f3cb2a37409f817d8e8dad94459.png)

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/c8320f088a84611df736f8d9731b3a0c.png)

### 1ï¼‰BlockQueue

æ˜¯Collectionçš„ä¸€ä¸ªå­ç±»

ä»€ä¹ˆæƒ…å†µä¸‹æˆ‘ä»¬ä¼šä½¿ç”¨é˜»å¡é˜Ÿåˆ—

ğŸš€ **1. ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹**

ğŸš€ **2. çº¿ç¨‹æ± çš„ä»»åŠ¡é˜Ÿåˆ—**ï¼Œå½“æœ‰æ–°çš„ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»–ä»¬ä¼šæ·»åŠ åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œå½“çº¿ç¨‹æ± æœ‰ç©ºé—²çº¿ç¨‹æ—¶ï¼ˆçª—å£ï¼‰ï¼Œä¼šä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡å¹¶æ‰§è¡Œã€‚

ğŸš€ **3.çº¿ç¨‹åŒæ­¥çš„åŒæ­¥é˜Ÿåˆ—**ï¼Œä¸€ä¸ªæ”¾è¿›å»ï¼Œä¸€ä¸ªæ‰èƒ½å–ã€‚

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/1752930ed6d3e27f9e7185f9dba1487e.png)

BlockingQueue æœ‰å››ç»„api

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/30e7ca63c8a2cfe01b8d8f0c36ee70e1.png)

```java
/**
     * æŠ›å‡ºå¼‚å¸¸
     */
    public static void test1(){
        //éœ€è¦åˆå§‹åŒ–é˜Ÿåˆ—çš„å¤§å°
        ArrayBlockingQueue blockingQueue = new ArrayBlockingQueue<>(3);

        System.out.println(blockingQueue.add("a"));
        System.out.println(blockingQueue.add("b"));
        System.out.println(blockingQueue.add("c"));
        //æŠ›å‡ºå¼‚å¸¸ï¼šjava.lang.IllegalStateException: Queue full
//        System.out.println(blockingQueue.add("d"));
        System.out.println(blockingQueue.remove());
        System.out.println(blockingQueue.remove());
        System.out.println(blockingQueue.remove());
        //å¦‚æœå¤šç§»é™¤ä¸€ä¸ª
        //è¿™ä¹Ÿä¼šé€ æˆ java.util.NoSuchElementException æŠ›å‡ºå¼‚å¸¸
        System.out.println(blockingQueue.remove());
    }
=======================================================================================
/**
     * ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œæœ‰è¿”å›å€¼
     */
    public static void test2(){
        ArrayBlockingQueue blockingQueue = new ArrayBlockingQueue<>(3);
        System.out.println(blockingQueue.offer("a"));
        System.out.println(blockingQueue.offer("b"));
        System.out.println(blockingQueue.offer("c"));
        //æ·»åŠ  ä¸€ä¸ªä¸èƒ½æ·»åŠ çš„å…ƒç´  ä½¿ç”¨offeråªä¼šè¿”å›false ä¸ä¼šæŠ›å‡ºå¼‚å¸¸
        System.out.println(blockingQueue.offer("d"));

        System.out.println(blockingQueue.poll());
        System.out.println(blockingQueue.poll());
        System.out.println(blockingQueue.poll());
        //å¼¹å‡º å¦‚æœæ²¡æœ‰å…ƒç´  åªä¼šè¿”å›null ä¸ä¼šæŠ›å‡ºå¼‚å¸¸
        System.out.println(blockingQueue.poll());
    }
=======================================================================================
/**
     * ç­‰å¾… ä¸€ç›´é˜»å¡
     */
    public static void test3() throws InterruptedException {
        ArrayBlockingQueue blockingQueue = new ArrayBlockingQueue<>(3);

        //ä¸€ç›´é˜»å¡ ä¸ä¼šè¿”å›
        blockingQueue.put("a");
        blockingQueue.put("b");
        blockingQueue.put("c");

        //å¦‚æœé˜Ÿåˆ—å·²ç»æ»¡äº†ï¼Œ å†è¿›å»ä¸€ä¸ªå…ƒç´   è¿™ç§æƒ…å†µä¼šä¸€ç›´ç­‰å¾…è¿™ä¸ªé˜Ÿåˆ— ä»€ä¹ˆæ—¶å€™æœ‰äº†ä½ç½®å†è¿›å»ï¼Œç¨‹åºä¸ä¼šåœæ­¢
//        blockingQueue.put("d");

        System.out.println(blockingQueue.take());
        System.out.println(blockingQueue.take());
        System.out.println(blockingQueue.take());
        //å¦‚æœæˆ‘ä»¬å†æ¥ä¸€ä¸ª  è¿™ç§æƒ…å†µä¹Ÿä¼šç­‰å¾…ï¼Œç¨‹åºä¼šä¸€ç›´è¿è¡Œ é˜»å¡
        System.out.println(blockingQueue.take());
    }
=======================================================================================
/**
     * ç­‰å¾… è¶…æ—¶é˜»å¡
     *  è¿™ç§æƒ…å†µä¹Ÿä¼šç­‰å¾…é˜Ÿåˆ—æœ‰ä½ç½® æˆ–è€…æœ‰äº§å“ ä½†æ˜¯ä¼šè¶…æ—¶ç»“æŸ
     */
    public static void test4() throws InterruptedException {
        ArrayBlockingQueue blockingQueue = new ArrayBlockingQueue<>(3);
        blockingQueue.offer("a");
        blockingQueue.offer("b");
        blockingQueue.offer("c");
        System.out.println("å¼€å§‹ç­‰å¾…");
        blockingQueue.offer("d",2, TimeUnit.SECONDS);  //è¶…æ—¶æ—¶é—´2s ç­‰å¾…å¦‚æœè¶…è¿‡2så°±ç»“æŸç­‰å¾…
        System.out.println("ç»“æŸç­‰å¾…");
        System.out.println("===========å–å€¼==================");
        System.out.println(blockingQueue.poll());
        System.out.println(blockingQueue.poll());
        System.out.println(blockingQueue.poll());
        System.out.println("å¼€å§‹ç­‰å¾…");
        blockingQueue.poll(2,TimeUnit.SECONDS); //è¶…è¿‡ä¸¤ç§’ æˆ‘ä»¬å°±ä¸è¦ç­‰å¾…äº†
        System.out.println("ç»“æŸç­‰å¾…");
    }


```

### 2ï¼‰åŒæ­¥é˜Ÿåˆ—(SynchronousQueue)

åŒæ­¥é˜Ÿåˆ— æ²¡æœ‰å®¹é‡ï¼Œä¹Ÿå¯ä»¥è§†ä¸º**å®¹é‡ä¸º1çš„é˜Ÿåˆ—**ï¼›

è¿›å»ä¸€ä¸ªå…ƒç´ ï¼Œå¿…é¡»ç­‰å¾…å–å‡ºæ¥ä¹‹åï¼Œæ‰èƒ½å†å¾€é‡Œé¢æ”¾å…¥ä¸€ä¸ªå…ƒç´ ï¼›

**put**æ–¹æ³• å’Œ **take**æ–¹æ³•ï¼›

**Synchronized** å’Œ å…¶ä»–çš„**BlockingQueue** ä¸ä¸€æ · å®ƒä¸å­˜å‚¨å…ƒç´ ï¼›

putäº†ä¸€ä¸ªå…ƒç´ ï¼Œå°±å¿…é¡»ä»é‡Œé¢å…ˆtakeå‡ºæ¥ï¼Œå¦åˆ™ä¸èƒ½å†putè¿›å»å€¼ï¼

å¹¶ä¸”SynchronousQueue çš„takeæ˜¯ä½¿ç”¨äº†**locké”ä¿è¯çº¿ç¨‹å®‰å…¨**çš„ã€‚

```java

public class SynchronousQueue {
    public static void main(String[] args) {
        BlockingQueue<String> synchronousQueue = new java.util.concurrent.SynchronousQueue<>();
        // ç½‘queueä¸­æ·»åŠ å…ƒç´ 
        new Thread(() -> {
            try {
                System.out.println(Thread.currentThread().getName() + "put 01");
                synchronousQueue.put("1");
                System.out.println(Thread.currentThread().getName() + "put 02");
                synchronousQueue.put("2");
                System.out.println(Thread.currentThread().getName() + "put 03");
                synchronousQueue.put("3");
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
        // å–å‡ºå…ƒç´ 
        new Thread(()-> {
            try {
                System.out.println(Thread.currentThread().getName() + "take" + synchronousQueue.take());
                System.out.println(Thread.currentThread().getName() + "take" + synchronousQueue.take());
                System.out.println(Thread.currentThread().getName() + "take" + synchronousQueue.take());
            }catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
    }
}
```

```Thread-0put
Thread-0:put 01
Thread-1:take1
Thread-0:put 02
Thread-1:take2
Thread-0:put 03
Thread-1:take3

Process finished with exit code 0
```

### 3ï¼‰æ‰‹å†™ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—

- **é”æœºåˆ¶**ï¼šä½¿ç”¨ `ReentrantLock` æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚
- **æ¡ä»¶å˜é‡**ï¼šä½¿ç”¨ `Condition` æ¥å®ç°é˜»å¡å’Œå”¤é†’æœºåˆ¶ã€‚

```java
import java.util.LinkedList;
import java.util.Queue;
import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.ReentrantLock;

public class SimpleBlockingQueue<T> {
    private final Queue<T> queue = new LinkedList<>(); // ä½¿ç”¨LinkedListä½œä¸ºåº•å±‚é˜Ÿåˆ—
    private final int capacity; // é˜Ÿåˆ—å®¹é‡
    private final ReentrantLock lock = new ReentrantLock(); // é”
    private final Condition notEmpty = lock.newCondition(); // éç©ºæ¡ä»¶
    private final Condition notFull = lock.newCondition(); // éæ»¡æ¡ä»¶

    public SimpleBlockingQueue(int capacity) {
        this.capacity = capacity;
    }

    // æ·»åŠ å…ƒç´ ï¼ˆé˜»å¡ï¼‰
    public void put(T item) throws InterruptedException {
        lock.lock();
        try {
            while (queue.size() == capacity) {
                notFull.await(); // é˜Ÿåˆ—å·²æ»¡ï¼Œç­‰å¾…
            }
            queue.add(item);
            notEmpty.signal(); // å”¤é†’æ¶ˆè´¹è€…
        } finally {
            lock.unlock();
        }
    }

    // ç§»é™¤å…ƒç´ ï¼ˆé˜»å¡ï¼‰
    public T take() throws InterruptedException {
        lock.lock();
        try {
            while (queue.isEmpty()) {
                notEmpty.await(); // é˜Ÿåˆ—ä¸ºç©ºï¼Œç­‰å¾…
            }
            T item = queue.poll();
            notFull.signal(); // å”¤é†’ç”Ÿäº§è€…
            return item;
        } finally {
            lock.unlock();
        }
    }

    // è·å–é˜Ÿåˆ—å¤§å°
    public int size() {
        lock.lock();
        try {
            return queue.size();
        } finally {
            lock.unlock();
        }
    }
}
```

#### æµ‹è¯•ä»£ç 

```java
public class SimpleBlockingQueueTest {
    public static void main(String[] args) {
        SimpleBlockingQueue<Integer> queue = new SimpleBlockingQueue<>(5);

        // ç”Ÿäº§è€…çº¿ç¨‹
        Thread producer = new Thread(() -> {
            try {
                for (int i = 0; i < 10; i++) {
                    queue.put(i);
                    System.out.println("Produced: " + i);
                }
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        });

        // æ¶ˆè´¹è€…çº¿ç¨‹
        Thread consumer = new Thread(() -> {
            try {
                for (int i = 0; i < 10; i++) {
                    int value = queue.take();
                    System.out.println("Consumed: " + value);
                }
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        });

        producer.start();
        consumer.start();
    }
}
```

## 8. çº¿ç¨‹æ± (é‡è¦)

**çº¿ç¨‹æ± ï¼šä¸‰å¤§æ–¹å¼ã€ä¸ƒå¤§å‚æ•°ã€å››ç§æ‹’ç»ç­–ç•¥**

ç¨‹åºçš„è¿è¡Œï¼Œæœ¬è´¨ï¼šå ç”¨ç³»ç»Ÿçš„èµ„æºï¼æˆ‘ä»¬éœ€è¦å»ä¼˜åŒ–èµ„æºçš„ä½¿ç”¨ ===> æ± åŒ–æŠ€æœ¯

çº¿ç¨‹æ± ã€JDBCçš„è¿æ¥æ± ã€å†…å­˜æ± ã€å¯¹è±¡æ±  ç­‰ç­‰ã€‚ã€‚ã€‚ã€‚

èµ„æºçš„åˆ›å»ºã€é”€æ¯ååˆ†æ¶ˆè€—èµ„æº

**æ± åŒ–æŠ€æœ¯**ï¼šäº‹å…ˆå‡†å¤‡å¥½ä¸€äº›èµ„æºï¼Œå¦‚æœæœ‰äººè¦ç”¨ï¼Œå°±æ¥æˆ‘è¿™é‡Œæ‹¿ï¼Œç”¨å®Œä¹‹åè¿˜ç»™æˆ‘ï¼Œä»¥æ­¤æ¥æé«˜æ•ˆç‡ã€‚

### 1ï¼‰çº¿ç¨‹æ± çš„å¥½å¤„ï¼š

1ã€é™ä½èµ„æºçš„æ¶ˆè€—ï¼ˆé¢‘ç¹åˆ›å»ºé”€æ¯ï¼‰ï¼›

2ã€æé«˜å“åº”çš„é€Ÿåº¦ï¼›

3ã€æ–¹ä¾¿ç®¡ç†ï¼›

**çº¿ç¨‹å¤ç”¨ã€å¯ä»¥æ§åˆ¶æœ€å¤§å¹¶å‘æ•°ã€ç®¡ç†çº¿ç¨‹ï¼›**

é˜¿é‡Œå·´å·´æ‰‹å†Œè§„çº¦ï¼š

ã€å¼ºåˆ¶ã€‘çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨`Executors`å»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡`ThreadPoolExecutor`çš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼è®©å†™çš„åŒå­¦æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™è§„é¿èµ„æºè€—å°½çš„é£é™©ã€‚
è¯´æ˜ï¼š`Executors`è¿”å›çš„çº¿ç¨‹æ± å¯¹è±¡çš„å¼Šç«¯å¦‚ä¸‹ï¼š
`FixedThreadPool` å’Œ `SingleThreadPool`:
å…è®¸çš„è¯·æ±‚é˜Ÿåˆ—é•¿åº¦ä¸º`Integer.MAX_VALUE`(çº¦ä¸º21äº¿)ï¼Œå¯èƒ½ä¼šå †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´OOMã€‚
`CachedThreadPool` å’Œ `ScheduledThreadPool`:
å…è®¸çš„åˆ›å»ºçº¿ç¨‹æ•°é‡ä¸º`Integer.MAX_VALUE`,å¯èƒ½ä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´OOMã€‚

### 2ï¼‰çº¿ç¨‹æ± ï¼šä¸‰å¤§æ–¹æ³•

+   **ExecutorService threadPool = Executors.newSingleThreadExecutor();//å•ä¸ªçº¿ç¨‹**
+   **ExecutorService threadPool2 = Executors.newFixedThreadPool(5); //åˆ›å»ºä¸€ä¸ªå›ºå®šçš„çº¿ç¨‹æ± çš„å¤§å°**
+   **ExecutorService threadPool3 = Executors.newCachedThreadPool(); //å¯ä¼¸ç¼©çš„**

```java
//å·¥å…·ç±» Executors ä¸‰å¤§æ–¹æ³•ï¼›
public class Demo01 {
    public static void main(String[] args) {

        ExecutorService threadPool = Executors.newSingleThreadExecutor();//å•ä¸ªçº¿ç¨‹
        ExecutorService threadPool2 = Executors.newFixedThreadPool(5); //åˆ›å»ºä¸€ä¸ªå›ºå®šçš„çº¿ç¨‹æ± çš„å¤§å°
        ExecutorService threadPool3 = Executors.newCachedThreadPool(); //å¯ä¼¸ç¼©çš„

        //çº¿ç¨‹æ± ç”¨å®Œå¿…é¡»è¦å…³é—­çº¿ç¨‹æ± 
        try {

            for (int i = 1; i <=100 ; i++) {
                //é€šè¿‡çº¿ç¨‹æ± åˆ›å»ºçº¿ç¨‹
                threadPool.execute(()->{
                    System.out.println(Thread.currentThread().getName()+ " ok");
                });
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            threadPool.shutdown();
        }
    }
}

```

### 3ï¼‰ä¸ƒå¤§å‚æ•°

newSingleThreadExecutor()**æºç åˆ†æ**

```java
 /**
     * Creates an Executor that uses a single worker thread operating
     * off an unbounded queue. (Note however that if this single
     * thread terminates due to a failure during execution prior to
     * shutdown, a new one will take its place if needed to execute
     * subsequent tasks.)  Tasks are guaranteed to execute
     * sequentially, and no more than one task will be active at any
     * given time. Unlike the otherwise equivalent
     * {@code newFixedThreadPool(1)} the returned executor is
     * guaranteed not to be reconfigurable to use additional threads.
     *
     * @return the newly created single-threaded Executor
     */
    public static ExecutorService newSingleThreadExecutor() {
        return new FinalizableDelegatedExecutorService
            (new ThreadPoolExecutor(1, 1,
                                    0L, TimeUnit.MILLISECONDS,
                                    new LinkedBlockingQueue<Runnable>()));
    }


```

newFixedThreadPool()æºç åˆ†æ

```java
 /**
     * Creates a thread pool that reuses a fixed number of threads
     * operating off a shared unbounded queue.  At any point, at most
     * {@code nThreads} threads will be active processing tasks.
     * If additional tasks are submitted when all threads are active,
     * they will wait in the queue until a thread is available.
     * If any thread terminates due to a failure during execution
     * prior to shutdown, a new one will take its place if needed to
     * execute subsequent tasks.  The threads in the pool will exist
     * until it is explicitly {@link ExecutorService#shutdown shutdown}.
     *
     * @param nThreads the number of threads in the pool
     * @return the newly created thread pool
     * @throws IllegalArgumentException if {@code nThreads <= 0}
     */
    public static ExecutorService newFixedThreadPool(int nThreads) {
        return new ThreadPoolExecutor(nThreads, nThreads,
                                      0L, TimeUnit.MILLISECONDS,
                                      new LinkedBlockingQueue<Runnable>());
    }

```

newCachedThreadPool()æºç åˆ†æ

```java
 /**
     * Creates a thread pool that creates new threads as needed, but
     * will reuse previously constructed threads when they are
     * available.  These pools will typically improve the performance
     * of programs that execute many short-lived asynchronous tasks.
     * Calls to {@code execute} will reuse previously constructed
     * threads if available. If no existing thread is available, a new
     * thread will be created and added to the pool. Threads that have
     * not been used for sixty seconds are terminated and removed from
     * the cache. Thus, a pool that remains idle for long enough will
     * not consume any resources. Note that pools with similar
     * properties but different details (for example, timeout parameters)
     * may be created using {@link ThreadPoolExecutor} constructors.
     *
     * @return the newly created thread pool
     */
    public static ExecutorService newCachedThreadPool() {
        return new ThreadPoolExecutor(0, Integer.MAX_VALUE,
                                      60L, TimeUnit.SECONDS,
                                      new SynchronousQueue<Runnable>());
    }

```

å¯ä»¥çœ‹åˆ°ï¼Œä¸‰ä¸ªæ–¹æ³•çš„åº•å±‚éƒ½æ˜¯new ThreadPoolExecutor

```java
public ThreadPoolExecutor(int corePoolSize,  //æ ¸å¿ƒçº¿ç¨‹æ± å¤§å°
                          int maximumPoolSize, //æœ€å¤§çš„çº¿ç¨‹æ± å¤§å°
                          long keepAliveTime,  //è¶…æ—¶äº†æ²¡æœ‰äººè°ƒç”¨å°±ä¼šé‡Šæ”¾
                          TimeUnit unit, //è¶…æ—¶å•ä½
                          BlockingQueue<Runnable> workQueue, //é˜»å¡é˜Ÿåˆ—
                          ThreadFactory threadFactory, //çº¿ç¨‹å·¥å‚ åˆ›å»ºçº¿ç¨‹çš„ ä¸€èˆ¬ä¸ç”¨åŠ¨
                          RejectedExecutionHandler handler //æ‹’ç»ç­–ç•¥
                         ) {
    if (corePoolSize < 0 ||
        maximumPoolSize <= 0 ||
        maximumPoolSize < corePoolSize ||
        keepAliveTime < 0)
        throw new IllegalArgumentException();
    if (workQueue == null || threadFactory == null || handler == null)
        throw new NullPointerException();
    this.corePoolSize = corePoolSize;
    this.maximumPoolSize = maximumPoolSize;
    this.workQueue = workQueue;
    this.keepAliveTime = unit.toNanos(keepAliveTime);
    this.threadFactory = threadFactory;
    this.handler = handler;
}
```

![image-20200812114142750](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/942cca6a0ef21326a30ac95a7f872ca9.png)

é˜¿é‡Œå·´å·´çš„Javaæ“ä½œæ‰‹å†Œä¸­æ˜ç¡®è¯´æ˜ï¼šå¯¹äºInteger.MAX\_VALUEåˆå§‹å€¼è¾ƒå¤§ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µæˆ‘ä»¬è¦ä½¿ç”¨åº•å±‚çš„**ThreadPoolExecutor**æ¥åˆ›å»ºçº¿ç¨‹æ± ã€‚  

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250108195653656.png)

æ¨¡æ‹Ÿä¸Šé¢çš„é“¶è¡Œä¸šåŠ¡  
æ ¸å¿ƒçº¿ç¨‹å¤§å°è®¾ä¸º2ï¼šå°±æ˜¯ä¸€ç›´å·¥ä½œçš„çª—å£  
æœ€å¤§çº¿ç¨‹è®¾ä¸º5ï¼šå°±æ˜¯é“¶è¡Œæœ€å¤šçš„å·¥ä½œçª—å£  
keepAliveTimeè®¾ç½®ä¸º1å°æ—¶ï¼šå¦‚æœ1å°æ—¶éƒ½æ²¡æœ‰ä¸šåŠ¡ï¼Œå°±å…³é—­çª—å£  
å€™å®¢åŒºï¼šnew LinkedBlockingQueue(3),å‡è®¾å€™å®¢åŒºæœ€å¤š3ä¸ªäºº  
çº¿ç¨‹å·¥å‚ï¼šå°±ç”¨é»˜è®¤çš„ï¼ŒExecutors.defaultThreaFactory()  
æ‹’ç»ç­–ç•¥ï¼š å¯ä»¥å‘ç°æœ‰4ç§æ‹’ç»ç­–ç•¥ï¼Œç”¨é»˜è®¤çš„AbortPolicy()//é“¶è¡Œæ»¡äº†ï¼Œä½†æ˜¯è¿˜æœ‰äººè¿›æ¥ï¼Œå°±ä¸å¤„ç†è¿™ä¸ªäººï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸

:::tip

é…ç½®æ—¶éœ€è¦æ ¹æ®ä¸šåŠ¡åœºæ™¯è¿›è¡Œè°ƒæ•´ï¼Œæ¯”å¦‚å¯¹äºCPUå¯†é›†å‹ä»»åŠ¡ï¼Œ`corePoolSize`å¯ä»¥è®¾ç½®ä¸º`CPUæ ¸å¿ƒæ•° + 1`ï¼Œè€Œå¯¹äºI/Oå¯†é›†å‹ä»»åŠ¡ï¼Œå¯ä»¥è®¾ç½®æ›´å¤§çš„çº¿ç¨‹æ•°ã€‚

:::

```java
public class PollDemo {
    public static void main(String[] args) {
          // è·å–cpu çš„æ ¸æ•°
        int max = Runtime.getRuntime().availableProcessors();
        ExecutorService service =new ThreadPoolExecutor(
                2,
                max,
                3,
                TimeUnit.SECONDS,
                new LinkedBlockingDeque<>(3),
                Executors.defaultThreadFactory(),
                new ThreadPoolExecutor.AbortPolicy()
        );
        try {
            for (int i = 1; i <= 10; i++) {
                service.execute(() -> {
                    System.out.println(Thread.currentThread().getName() + "ok");
                });
            }
        }catch (Exception e) {
            e.printStackTrace();
        }
        finally {
            service.shutdown();
        }
    }
}

```

è¾“å‡ºç»“æœï¼š

```java
//5:ä¸¤ä¸ªåœ¨åŠç†ï¼Œä¸‰ä¸ªåœ¨ç­‰å€™åŒº
pool-1-thread-1:ok
pool-1-thread-2:ok
pool-1-thread-1:ok
pool-1-thread-2:ok
pool-1-thread-1:ok

//6:6ä¸ªäººé˜Ÿåˆ—ï¼ˆ3ä¸ªï¼‰ä¼šæ»¡ï¼Œæ‰€ä»¥æ–°èµ·1ä¸ªçº¿ç¨‹ï¼Œæ€»å…±3ä¸ªçº¿ç¨‹
pool-1-thread-2:ok
pool-1-thread-2:ok
pool-1-thread-1:ok
pool-1-thread-3:ok
pool-1-thread-2:ok
pool-1-thread-1:ok

//7:6ä¸ªäººé˜Ÿåˆ—ï¼ˆ3ä¸ªï¼‰ä¼šæ»¡ï¼Œæ‰€ä»¥æ–°èµ·2ä¸ªçº¿ç¨‹ï¼Œæ€»å…±4ä¸ªçº¿ç¨‹
//8:6ä¸ªäººé˜Ÿåˆ—ï¼ˆ3ä¸ªï¼‰ä¼šæ»¡ï¼Œæ‰€ä»¥æ–°èµ·3ä¸ªçº¿ç¨‹ï¼Œæ€»å…±5ä¸ªçº¿ç¨‹ï¼Œè¾¾åˆ°æœ€å¤§äº†ï¼
//9:æŠ›å‡ºæ‹’ç»å¼‚å¸¸
```



### 4ï¼‰å››ç§æ‹’ç»ç­–ç•¥

1.  `new ThreadPoolExecutor.AbortPolicy()`ï¼š //è¯¥æ‹’ç»ç­–ç•¥ä¸ºï¼šé“¶è¡Œæ»¡äº†ï¼Œè¿˜æœ‰äººè¿›æ¥ï¼Œä¸å¤„ç†è¿™ä¸ªäººçš„ï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸

è¶…å‡ºæœ€å¤§æ‰¿è½½ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼šé˜Ÿåˆ—å®¹é‡å¤§å°+maxPoolSize

2. `new ThreadPoolExecutor.CallerRunsPolicy()`ï¼š //è¯¥æ‹’ç»ç­–ç•¥ä¸ºï¼šå“ªæ¥çš„å»å“ªé‡Œ mainçº¿ç¨‹è¿›è¡Œå¤„ç†

   ```java
   pool-1-thread-1:ok
   main:ok
   pool-1-thread-1:ok
   pool-1-thread-2:ok
   pool-1-thread-1:ok
   pool-1-thread-5:ok
   pool-1-thread-4:ok
   pool-1-thread-3:ok
   pool-1-thread-2:ok
   ```

3. `new ThreadPoolExecutor.DiscardPolicy()`: //è¯¥æ‹’ç»ç­–ç•¥ä¸ºï¼šé˜Ÿåˆ—æ»¡äº†,ä¸¢æ‰å¼‚å¸¸ï¼Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚

4. `new ThreadPoolExecutor.DiscardOldestPolicy()`ï¼š//è¯¥æ‹’ç»ç­–ç•¥ä¸ºï¼šé˜Ÿåˆ—æ»¡äº†ï¼Œå°è¯•å»å’Œæœ€æ—©çš„è¿›ç¨‹ç«äº‰ï¼Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸

   ```java
   Disconnected from the target VM, address: '127.0.0.1:51839', transport: 'socket'
   ```

### 5ï¼‰å¦‚ä½•è®¾ç½®çº¿ç¨‹æ± çš„å¤§å°

**1ã€CPUå¯†é›†å‹ï¼ˆæ¯”å¦‚æ‰¾å‡º1-1000000ä¸­çš„ç´ æ•°ï¼‰ï¼šç”µè„‘çš„æ ¸æ•°æ˜¯å‡ å°±é€‰æ‹©å‡ å†+1ï¼›**

åªä¸è¿‡ï¼Œä¸ºäº†åº”å¯¹çº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹å‘ç”Ÿç¼ºé¡µä¸­æ–­æˆ–å…¶ä»–å¼‚å¸¸å¯¼è‡´çº¿ç¨‹é˜»å¡çš„è¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥é¢å¤–åœ¨å¤šè®¾ç½®ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™æ ·å½“æŸä¸ªçº¿ç¨‹æš‚æ—¶ä¸éœ€è¦CPUæ—¶ï¼Œå¯ä»¥æœ‰æ›¿è¡¥çº¿ç¨‹æ¥ç»§ç»­å……åˆ†åˆ©ç”¨CPUã€‚

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250108210046805.png)

å¯ä»¥é€šè¿‡ä»¥ä¸‹APæ‹¿åˆ°ä½ ç”µè„‘çš„æ ¸å¿ƒæ•°ï¼š

```java
Runtime.getRuntime().availableProcessors()
```

```java
// è·å–cpu çš„æ ¸æ•°
int max = Runtime.getRuntime().availableProcessors();
ExecutorService service =new ThreadPoolExecutor(
    2,
    max,
    3,
    TimeUnit.SECONDS,
    new LinkedBlockingDeque<>(3),
    Executors.defaultThreadFactory(),
    new ThreadPoolExecutor.AbortPolicy()
);

```

**2ã€I/Oå¯†é›†å‹ï¼ˆæ¯”å¦‚æ–‡ä»¶1Oã€ç½‘ç»œ1Oï¼‰ï¼š**

æˆ‘ä»¬åœ¨æ¥çœ‹1Oå‹ä»»åŠ¡ï¼Œçº¿ç¨‹åœ¨æ‰§è¡ŒIOå‹ä»»åŠ¡æ—¶ï¼Œå¯èƒ½å¤§éƒ¨åˆ†æ—¶é—´éƒ½é˜»å¡åœ¨10ä¸Šï¼Œå‡å¦‚ç°åœ¨æœ‰10ä¸ªCPUï¼Œå¦‚æœæˆ‘ä»¬åªè®¾ç½®äº†10ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œ1Oå‹ä»»åŠ¡ï¼Œé‚£ä¹ˆå¾ˆæœ‰å¯èƒ½è¿™10ä¸ªçº¿ç¨‹éƒ½é˜»å¡åœ¨äº†IOä¸Šï¼Œè¿™æ ·è¿™10ä¸ªCPUå°±éƒ½æ²¡æ´»å¹²äº†ï¼Œæ‰€ä»¥ï¼Œå¯¹äºIOå‹ä»»åŠ¡ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šè®¾ç½®çº¿ç¨‹æ•°ä¸ºï¼š==2*CPUæ ¸å¿ƒæ•°==ã€‚

## 9\. å››å¤§å‡½æ•°å¼æ¥å£

æ–°æ—¶ä»£çš„ç¨‹åºå‘˜ï¼š**lambdaè¡¨è¾¾ å¼ã€é“¾å¼ç¼–ç¨‹ã€å‡½æ•°å¼æ¥å£ã€Streamæµå¼è®¡ç®—**

å‡½æ•°å¼æ¥å£ï¼šåªæœ‰ä¸€ä¸ªæ–¹æ³•çš„æ¥å£

ç®€åŒ–ç¼–ç¨‹æ¨¡å‹ï¼Œåœ¨æ–°ç‰ˆæœ¬çš„æ¡†æ¶åº•å±‚å¤§é‡åº”ç”¨

foreach(æ¶ˆè´¹è€…ç±»å‹çš„å‡½æ•°å¼æ¥å£)

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/1c0d9b48a37cfd2fd06261ca15c37f60.png)

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/65eb336c105791f0a7a17bb7b2d7a07f.png)

### 1ï¼‰Function å‡½æ•°å‹æ¥å£

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/fde53f33a9e4909aaf6b129ccab5846a.png)

```java
//Functionå‡½æ•°å‹æ¥å£ï¼Œæœ‰ä¸€ä¸ªè¾“å…¥å‚æ•°ï¼Œæœ‰ä¸€ä¸ªè¾“å‡º
//åªè¦æ˜¯å‡½æ•°å‹æ¥å£å¯ä»¥ç”¨Lambdaè¡¨è¾¾å¼ç®€åŒ–
public class Demo1{
    public static void main(String[] args) {
        Function function = new Function<String,String>() {
            @Override
            public String apply(String str) {
                return str;
            }
        };
        System.out.println(function.apply("asd"));
    }
}
```

```java
public class FunctionDemo {
    public static void main(String[] args) {
        Function<String, String> function = (str) -> {return str;};
        System.out.println(function.apply("aaaaaaaaaa"));
    }
}
```

### 2ï¼‰Predicate æ–­å®šå‹æ¥å£

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/e658ace0f5d5e3913dbac600e607819c.png)

```java
//æ–­å®šå‹æ¥å£ï¼šæœ‰ä¸€ä¸ªè¾“å…¥å‚æ•°ï¼Œ
public class Demo02{
    public static void main(String[]args) {
        //åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©º
        Predicate<String> predicate = new Predicate<String>() {
            @Override
            public boolean test(String str) {
                return str.isEmpty();
            }
        };
        System.out.println(predicate.test("hello"));
    }
}
```

```java
public class PredicateDemo {
    public static void main(String[] args) {
        Predicate<String> predicate = (str) -> {return str.isEmpty();};
        // false
        System.out.println(predicate.test("aaa"));
        // true
        System.out.println(predicate.test(""));
    }
}
```

### 3ï¼‰Suppier ä¾›ç»™å‹æ¥å£

![image-20200812144653640](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/c663f32a07a8f0dde688adb3f8850abc.png)

```java
/**
 * ä¾›ç»™å‹æ¥å£ï¼Œåªè¿”å›ï¼Œä¸è¾“å…¥
 */
public class Demo3 {
    public static void main(String[] args) {
        Supplier<Integer> supplier = new Supplier<Integer>() {
            @Override
            public Integer get() {
                System.out.println("get()");
                return 1024;
            }
        };
        Supplier supplier2 = ()->{return "1024";};
        System.out.println(supplier2.get());
    }
}
```

```java
/**
 * ä¾›ç»™å‹æ¥å£ï¼Œåªè¿”å›ï¼Œä¸è¾“å…¥
 */
public class Demo4 {
    public static void main(String[] args) {
        Supplier<String> supplier = ()->{return "1024";};
        System.out.println(supplier.get());
    }
}


```

### 4ï¼‰Consummer æ¶ˆè´¹å‹æ¥å£

![image-20200812144803229](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/c5641402010af463e285685614c2a92a.png)

```java
public class Demo4 {
    public static void main(String[] args) {
        Consumer<String> consumer = new Consumer<String>() {
            @Override
            public void accept(String str) {
                System.out.println(str);
            }
        };
        consumer.accept("sad");
    }
}
```

```java
/**
 * æ¶ˆè´¹å‹æ¥å£ æ²¡æœ‰è¿”å›å€¼ï¼åªæœ‰è¾“å…¥ï¼
 */
public class Demo4 {
    public static void main(String[] args) {
        Consumer<String> consumer = (str)->{
            System.out.println(str);
        };
        consumer.accept("abc");
    }
}


```

## 10. Stream æµå¼è®¡ç®—

> ä»€ä¹ˆå•ŠStreamæµå¼è®¡ç®—

å¤§æ•°æ®ï¼šå­˜å‚¨+è®¡ç®—

é›†åˆã€Mysqlæœ¬è´¨è®¡ç®—å­˜å‚¨ä¸œè¥¿çš„

è®¡ç®—éƒ½åº”è¯¥äº¤ç»™æµæ¥æ“ä½œ

```java
/**
 * Descriptionï¼š
 * é¢˜ç›®è¦æ±‚ï¼š ç”¨ä¸€è¡Œä»£ç å®ç°
 * 1. Id å¿…é¡»æ˜¯å¶æ•°
 * 2.å¹´é¾„å¿…é¡»å¤§äº23
 * 3. ç”¨æˆ·åè½¬ä¸ºå¤§å†™
 * 4. ç”¨æˆ·åå€’åº
 * 5. åªèƒ½è¾“å‡ºä¸€ä¸ªç”¨æˆ·
 *
 * @author jiaoqianjin
 * Date: 2020/8/12 14:55
 **/

public class StreamDemo {
    public static void main(String[] args) {
        User u1 = new User(1, "a", 23);
        User u2 = new User(2, "b", 23);
        User u3 = new User(3, "c", 23);
        User u4 = new User(6, "d", 24);
        User u5 = new User(4, "e", 25);

        List<User> list = Arrays.asList(u1, u2, u3, u4, u5);
        // lambdaã€é“¾å¼ç¼–ç¨‹ã€å‡½æ•°å¼æ¥å£ã€æµå¼è®¡ç®—
        list.stream()
                .filter(user -> {return user.getId()%2 == 0;})
                .filter(user -> {return user.getAge() > 23;})
                .map(user -> {return user.getName().toUpperCase();})
                .sorted((user1, user2) -> {return user2.compareTo(user1);})
                .limit(1)
                .forEach(System.out::println);
    }
}

```

## 11. ForkJoinï¼ˆåˆ†æ”¯åˆå¹¶ï¼‰

ForkJoin åœ¨JDK1.7ï¼Œå¹¶è¡Œæ‰§è¡Œä»»åŠ¡ï¼æé«˜æ•ˆç‡~ã€‚åœ¨å¤§æ•°æ®é‡é€Ÿç‡ä¼šæ›´å¿«ï¼

å¤§æ•°æ®ä¸­ï¼š**MapReduce æ ¸å¿ƒæ€æƒ³->æŠŠå¤§ä»»åŠ¡æ‹†åˆ†ä¸ºå°ä»»åŠ¡ï¼**

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250108214955744.png)

### 1ï¼‰ForkJoin ç‰¹ç‚¹ï¼š å·¥ä½œçªƒå–ï¼

å®ç°åŸç†æ˜¯ï¼š**åŒç«¯é˜Ÿåˆ—**ï¼ä»ä¸Šé¢å’Œä¸‹é¢éƒ½å¯ä»¥å»æ‹¿åˆ°ä»»åŠ¡è¿›è¡Œæ‰§è¡Œï¼

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250108215757672.png)

### 2ï¼‰å¦‚ä½•ä½¿ç”¨ForkJoin?

+   1ã€é€šè¿‡**ForkJoinPool**æ¥æ‰§è¡Œ
    
+   2ã€è®¡ç®—ä»»åŠ¡ **execute(ForkJoinTask<?> task)**
    
+   3ã€è®¡ç®—ç±»è¦å»ç»§æ‰¿**ForkJoinTask**ï¼›
    

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/3fb53ab3c8edd0c7aa795c7496ae2d80.png)

**ForkJoin çš„è®¡ç®—ç±»**

```java
public class ForkJoinDemo extends RecursiveTask<Long> {
    private long star;
    private long end;
    /** ä¸´ç•Œå€¼ */
    private long temp = 1000000L;

    public ForkJoinDemo(long star, long end) {
        this.star = star;
        this.end = end;
    }

    /**
     * è®¡ç®—æ–¹æ³•
     * @return
     */
    @Override
    protected Long compute() {
        if ((end - star) < temp) {
            Long sum = 0L;
            for (Long i = star; i < end; i++) {
                sum += i;
            }
            return sum;
        }else {
            // ä½¿ç”¨ForkJoin åˆ†è€Œæ²»ä¹‹ è®¡ç®—
            //1 . è®¡ç®—å¹³å‡å€¼
            long middle = (star + end) / 2;
            ForkJoinDemo forkJoinDemo1 = new ForkJoinDemo(star, middle);
            // æ‹†åˆ†ä»»åŠ¡ï¼ŒæŠŠçº¿ç¨‹å‹å…¥çº¿ç¨‹é˜Ÿåˆ—
            forkJoinDemo1.fork();
            ForkJoinDemo forkJoinDemo2 = new ForkJoinDemo(middle+1,end);
            forkJoinDemo2.fork();

            long taskSum = forkJoinDemo1.join() + forkJoinDemo2.join();
            return taskSum;
        }
    }
}

```

**æµ‹è¯•ç±»**

```java


public class ForkJoinTest {
    private static final long SUM = 20_0000_0000;

    public static void main(String[] args) throws ExecutionException, InterruptedException {
        test1();
        test2();
        test3();
    }

    /**
     * ä½¿ç”¨æ™®é€šæ–¹æ³•
     */
    public static void test1() {
        long star = System.currentTimeMillis();
        long sum = 0L;
        for (long i = 1; i < SUM ; i++) {
            sum += i;
        }
        long end = System.currentTimeMillis();
        System.out.println(sum);
        System.out.println("æ—¶é—´ï¼š" + (end - star));
        System.out.println("----------------------");
    }
    /**
     * ä½¿ç”¨ForkJoin æ–¹æ³•
     */
    public static void test2() throws ExecutionException, InterruptedException {
        long star = System.currentTimeMillis();

        ForkJoinPool forkJoinPool = new ForkJoinPool();
        ForkJoinTask<Long> task = new ForkJoinDemo(0L, SUM);
        ForkJoinTask<Long> submit = forkJoinPool.submit(task);
        Long along = submit.get();

        System.out.println(along);
        long end = System.currentTimeMillis();
        System.out.println("æ—¶é—´ï¼š" + (end - star));
        System.out.println("-----------");
    }
    /**
     * ä½¿ç”¨ Stream æµè®¡ç®—
     */
    public static void test3() {
        long star = System.currentTimeMillis();

        long sum = LongStream.range(0L, 20_0000_0000L).parallel().reduce(0, Long::sum);
        System.out.println(sum);
        long end = System.currentTimeMillis();
        System.out.println("æ—¶é—´ï¼š" + (end - star));
        System.out.println("-----------");
    }
}

```

![image-20200813090527527](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/41c9d932202cd400c14d4c4cffdcd213.png)

**.parallel().reduce(0, Long::sum)ä½¿ç”¨ä¸€ä¸ªå¹¶è¡Œæµå»è®¡ç®—æ•´ä¸ªè®¡ç®—ï¼Œæé«˜æ•ˆç‡ã€‚**

![image-20200812164023833](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/d6462fdfcd3f129313cd823a75f09ceb.png)

## 12. å¼‚æ­¥å›è°ƒ

> Future è®¾è®¡çš„åˆè¡·ï¼šå¯¹å°†æ¥çš„æŸä¸ªäº‹ä»¶ç»“æœè¿›è¡Œå»ºæ¨¡ï¼

å…¶å®å°±æ˜¯å‰ç«¯ --> å‘é€ajaxå¼‚æ­¥è¯·æ±‚ç»™åç«¯

![image-20200812215150294](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/e1341d08ca9cedca499ece9827a68e80.png)

ä½†æ˜¯æˆ‘ä»¬å¹³æ—¶éƒ½ä½¿ç”¨**CompletableFuture**

### ï¼ˆ1ï¼‰æ²¡æœ‰è¿”å›å€¼çš„runAsyncå¼‚æ­¥å›è°ƒ

```java
public static void main(String[] args) throws ExecutionException, InterruptedException 
{
        // å‘èµ· ä¸€ä¸ª è¯·æ±‚

        System.out.println(System.currentTimeMillis());
        System.out.println("---------------------");
        CompletableFuture<Void> future = CompletableFuture.runAsync(()->{
            //å‘èµ·ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡
            try { 
                TimeUnit.SECONDS.sleep(2);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            System.out.println(Thread.currentThread().getName()+".....");
        });
        System.out.println(System.currentTimeMillis());
        System.out.println("------------------------------");
        //è¾“å‡ºæ‰§è¡Œç»“æœ
        System.out.println(future.get());  //è·å–æ‰§è¡Œç»“æœ
 }

```

### ï¼ˆ2ï¼‰æœ‰è¿”å›å€¼çš„å¼‚æ­¥å›è°ƒsupplyAsync

```java
//æœ‰è¿”å›å€¼çš„å¼‚æ­¥å›è°ƒ
CompletableFuture<Integer> completableFuture=CompletableFuture.supplyAsync(()->{
    System.out.println(Thread.currentThread().getName());
    try {
        TimeUnit.SECONDS.sleep(2);
        int i=1/0;
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    return 1024;
});
System.out.println(completableFuture.whenComplete((t, u) -> {
    //success å›è°ƒ
    System.out.println("t=>" + t); //æ­£å¸¸çš„è¿”å›ç»“æœ
    System.out.println("u=>" + u); //æŠ›å‡ºå¼‚å¸¸çš„ é”™è¯¯ä¿¡æ¯
}).exceptionally((e) -> {
    //errorå›è°ƒ
    System.out.println(e.getMessage());
    return 404;
}).get());

```

**whenComplete**: æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯t ä¸€ä¸ªæ˜¯u

Tï¼šæ˜¯ä»£è¡¨çš„ **æ­£å¸¸è¿”å›çš„ç»“æœ**ï¼›

Uï¼šæ˜¯ä»£è¡¨çš„ **æŠ›å‡ºå¼‚å¸¸çš„é”™è¯¯ä¿¡æ¯**ï¼›

å¦‚æœå‘ç”Ÿäº†å¼‚å¸¸ï¼Œgetå¯ä»¥è·å–åˆ°**exceptionally**è¿”å›çš„å€¼ï¼›

## 13. JMM

### 1ï¼‰å¯¹Volatile çš„ç†è§£

**Volatile** æ˜¯ Java è™šæ‹Ÿæœºæä¾› **è½»é‡çº§çš„åŒæ­¥æœºåˆ¶**

**1ã€ä¿è¯å¯è§æ€§  
2ã€ä¸ä¿è¯åŸå­æ€§  
3ã€ç¦æ­¢æŒ‡ä»¤é‡æ’**

**å¦‚ä½•å®ç°å¯è§æ€§**

volatileå˜é‡ä¿®é¥°çš„å…±äº«å˜é‡åœ¨è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™å›å¤šå‡ºä¸€è¡Œæ±‡ç¼–ï¼š

0x01a3de1d:movb $0Ã—0ï¼Œ0Ã—1104800ï¼ˆ%esiï¼‰;0x01a3de24\*\*:lock\*\* addl $0Ã—0,(%esp);

Lockå‰ç¼€çš„æŒ‡ä»¤åœ¨å¤šæ ¸å¤„ç†å™¨ä¸‹ä¼šå¼•å‘ä¸¤ä»¶äº‹æƒ…ã€‚

1ï¼‰å°†å½“å‰å¤„ç†å™¨ç¼“å­˜è¡Œçš„æ•°æ®å†™å›åˆ°ç³»ç»Ÿå†…å­˜ã€‚

2ï¼‰è¿™ä¸ªå†™å›å†…å­˜çš„æ“ä½œä¼šä½¿å…¶ä»–cpué‡Œç¼“å­˜äº†è¯¥å†…å­˜åœ°å€çš„æ•°æ®æ— æ•ˆã€‚

**å¤šå¤„ç†å™¨æ€»çº¿å—…æ¢ï¼š**

ä¸ºäº†æé«˜å¤„ç†é€Ÿåº¦ï¼Œå¤„ç†å™¨ä¸ç›´æ¥å’Œå†…å­˜è¿›è¡Œé€šä¿¡ï¼Œè€Œæ˜¯å…ˆå°†ç³»ç»Ÿå†…å­˜çš„æ•°æ®è¯»åˆ°å†…éƒ¨ç¼“å­˜åå†è¿›è¡Œæ“ä½œï¼Œä½†æ“ä½œä¸çŸ¥é“ä½•æ—¶ä¼šå†™åˆ°å†…å­˜ã€‚å¦‚æœå¯¹å£°æ˜äº†volatileçš„å˜é‡è¿›è¡Œå†™æ“ä½œï¼ŒJVMå°±ä¼šå‘å¤„ç†å™¨å‘é€ä¸€æ¡lockå‰ç¼€çš„æŒ‡ä»¤ï¼Œå°†è¿™ä¸ªå˜é‡æ‰€åœ¨ç¼“å­˜è¡Œçš„æ•°æ®å†™å›åˆ°ç³»ç»Ÿå†…å­˜ã€‚ä½†æ˜¯åœ¨å¤šå¤„ç†å™¨ä¸‹ï¼Œä¸ºäº†ä¿è¯å„ä¸ªå¤„ç†å™¨çš„ç¼“å­˜æ˜¯ä¸€è‡´çš„ï¼Œå°±ä¼šå®ç°ç¼“å­˜ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼Œ**æ¯ä¸ªå¤„ç†å™¨é€šè¿‡å—…æ¢åœ¨æ€»çº¿ä¸Šä¼ æ’­çš„æ•°æ®æ¥æ£€æŸ¥è‡ªå·±çš„ç¼“å­˜å€¼æ˜¯ä¸æ˜¯è¿‡æœŸäº†ï¼Œå¦‚æœå¤„ç†å™¨å‘ç°è‡ªå·±ç¼“å­˜è¡Œå¯¹åº”çš„å†…å­˜åœ°å€å‘—ä¿®æ”¹ï¼Œå°±ä¼šå°†å½“å‰å¤„ç†å™¨çš„ç¼“å­˜è¡Œè®¾ç½®æ— æ•ˆçŠ¶æ€**ï¼Œå½“å¤„ç†å™¨å¯¹è¿™ä¸ªæ•°æ®è¿›è¡Œä¿®æ”¹æ“ä½œçš„æ—¶å€™ï¼Œä¼šé‡æ–°ä»ç³»ç»Ÿå†…å­˜ä¸­æŠŠæ•°æ®åº“è¯»åˆ°å¤„ç†å™¨ç¼“å­˜ä¸­ã€‚

### 2ï¼‰ä»€ä¹ˆæ˜¯JMMï¼Ÿ

JMMï¼šJAVAå†…å­˜æ¨¡å‹ï¼Œä¸å­˜åœ¨çš„ä¸œè¥¿ï¼Œæ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œä¹Ÿæ˜¯ä¸€ä¸ªçº¦å®šï¼

**å…³äºJMMçš„ä¸€äº›åŒæ­¥çš„çº¦å®šï¼š**

1ã€çº¿ç¨‹è§£é”å‰ï¼Œå¿…é¡»æŠŠå…±äº«å˜é‡**ç«‹åˆ»**åˆ·å›ä¸»å­˜ï¼›

2ã€çº¿ç¨‹åŠ é”å‰ï¼Œå¿…é¡»**è¯»å–ä¸»å­˜**ä¸­çš„æœ€æ–°å€¼åˆ°å·¥ä½œå†…å­˜ä¸­ï¼›

3ã€åŠ é”å’Œè§£é”æ˜¯åŒä¸€æŠŠé”ï¼›

çº¿ç¨‹ä¸­åˆ†ä¸º **å·¥ä½œå†…å­˜ã€ä¸»å†…å­˜**

**8ç§æ“ä½œ**:

+   **Readï¼ˆè¯»å–ï¼‰**ï¼šä½œç”¨äºä¸»å†…å­˜å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªå˜é‡çš„å€¼ä»ä¸»å†…å­˜ä¼ è¾“åˆ°çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåçš„loadåŠ¨ä½œä½¿ç”¨ï¼›
+   **loadï¼ˆè½½å…¥ï¼‰**ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠreadæ“ä½œä»ä¸»å­˜ä¸­å˜é‡æ”¾å…¥å·¥ä½œå†…å­˜ä¸­ï¼›
+   **Useï¼ˆä½¿ç”¨ï¼‰**ï¼šä½œç”¨äºå·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œå®ƒæŠŠå·¥ä½œå†…å­˜ä¸­çš„å˜é‡ä¼ è¾“ç»™æ‰§è¡Œå¼•æ“ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªéœ€è¦ä½¿ç”¨åˆ°å˜é‡çš„å€¼ï¼Œå°±ä¼šä½¿ç”¨åˆ°è¿™ä¸ªæŒ‡ä»¤ï¼›
+   **assignï¼ˆèµ‹å€¼ï¼‰**ï¼šä½œç”¨äºå·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªä»æ‰§è¡Œå¼•æ“ä¸­æ¥å—åˆ°çš„å€¼æ”¾å…¥å·¥ä½œå†…å­˜çš„å˜é‡å‰¯æœ¬ä¸­ï¼›
+   **storeï¼ˆå­˜å‚¨ï¼‰**ï¼šä½œç”¨äºä¸»å†…å­˜ä¸­çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªä»å·¥ä½œå†…å­˜ä¸­ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€åˆ°ä¸»å†…å­˜ä¸­ï¼Œä»¥ä¾¿åç»­çš„writeä½¿ç”¨ï¼›
+   **writeï¼ˆå†™å…¥ï¼‰**ï¼šä½œç”¨äºä¸»å†…å­˜ä¸­çš„å˜é‡ï¼Œå®ƒæŠŠstoreæ“ä½œä»å·¥ä½œå†…å­˜ä¸­å¾—åˆ°çš„å˜é‡çš„å€¼æ”¾å…¥ä¸»å†…å­˜çš„å˜é‡ä¸­ï¼›
+   **lockï¼ˆé”å®šï¼‰**ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼ŒæŠŠä¸€ä¸ªå˜é‡æ ‡è¯†ä¸ºçº¿ç¨‹ç‹¬å çŠ¶æ€ï¼›
+   **unlockï¼ˆè§£é”ï¼‰**ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªå¤„äºé”å®šçŠ¶æ€çš„å˜é‡é‡Šæ”¾å‡ºæ¥ï¼Œé‡Šæ”¾åçš„å˜é‡æ‰å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹é”å®šï¼›

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/ca9a70e9d80cf1653b9786c75ea6d4d0.png)

![image-20200812215606080](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/12f62bb1227e5b924d845d4c79711972.png)

**æœ‰å¯èƒ½ä¼šå‡ºç°çº¿ç¨‹Bä¿®æ”¹äº†å€¼åˆ·æ–°å›ä¸»å†…å­˜ï¼Œä½†æ˜¯çº¿ç¨‹Aæ²¡æœ‰å–åˆ°è¿™ä¸ªæœ€æ–°çš„å€¼**

**JMMå¯¹è¿™8ç§æ“ä½œç»™äº†ç›¸åº”çš„è§„å®šï¼š**

+   ä¸å…è®¸readå’Œloadã€storeå’Œwriteæ“ä½œä¹‹ä¸€å•ç‹¬å‡ºç°ã€‚å³ä½¿ç”¨äº†readå¿…é¡»loadï¼Œä½¿ç”¨äº†storeå¿…é¡»write
+   ä¸å…è®¸çº¿ç¨‹ä¸¢å¼ƒä»–æœ€è¿‘çš„assignæ“ä½œï¼Œå³å·¥ä½œå˜é‡çš„æ•°æ®æ”¹å˜äº†ä¹‹åï¼Œå¿…é¡»å‘ŠçŸ¥ä¸»å­˜
+   ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹å°†æ²¡æœ‰assignçš„æ•°æ®ä»å·¥ä½œå†…å­˜åŒæ­¥å›ä¸»å†…å­˜
+   ä¸€ä¸ªæ–°çš„å˜é‡å¿…é¡»åœ¨ä¸»å†…å­˜ä¸­è¯ç”Ÿï¼Œä¸å…è®¸å·¥ä½œå†…å­˜ç›´æ¥ä½¿ç”¨ä¸€ä¸ªæœªè¢«åˆå§‹åŒ–çš„å˜é‡ã€‚å°±æ˜¯å¯¹å˜é‡å®æ–½useã€storeæ“ä½œä¹‹å‰ï¼Œå¿…é¡»ç»è¿‡assignå’Œloadæ“ä½œ
+   ä¸€ä¸ªå˜é‡åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¯¹å…¶è¿›è¡Œlockã€‚å¤šæ¬¡lockåï¼Œå¿…é¡»æ‰§è¡Œç›¸åŒæ¬¡æ•°çš„unlockæ‰èƒ½è§£é”
+   å¦‚æœå¯¹ä¸€ä¸ªå˜é‡è¿›è¡Œlockæ“ä½œï¼Œä¼šæ¸…ç©ºæ‰€æœ‰å·¥ä½œå†…å­˜ä¸­æ­¤å˜é‡çš„å€¼ï¼Œåœ¨æ‰§è¡Œå¼•æ“ä½¿ç”¨è¿™ä¸ªå˜é‡å‰ï¼Œå¿…é¡»é‡æ–°loadæˆ–assignæ“ä½œåˆå§‹åŒ–å˜é‡çš„å€¼
+   å¦‚æœä¸€ä¸ªå˜é‡æ²¡æœ‰è¢«lockï¼Œå°±ä¸èƒ½å¯¹å…¶è¿›è¡Œunlockæ“ä½œã€‚ä¹Ÿä¸èƒ½unlockä¸€ä¸ªè¢«å…¶ä»–çº¿ç¨‹é”ä½çš„å˜é‡
+   å¯¹ä¸€ä¸ªå˜é‡è¿›è¡Œunlockæ“ä½œä¹‹å‰ï¼Œå¿…é¡»æŠŠæ­¤å˜é‡åŒæ­¥å›ä¸»å†…å­˜  
    ![img](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/30845b75bc0ac76e105ef2b1700cd494.png)

## 14 volatile

### 1ï¼‰ä¿è¯å¯è§æ€§

```java
public class JMMDemo {
    // ä¸åŠ  volatile ç¨‹åºå°±ä¼šæ­»å¾ªç¯ï¼
    // åŠ  volatile å¯ä»¥ä¿è¯å¯è§æ€§
   // private volatile static int num = 0;
    private  static int num = 0;

    public static void main(String[] args) { // main

        new Thread(()->{ // çº¿ç¨‹ 1 å¯¹ä¸»å†…å­˜çš„å˜åŒ–ä¸çŸ¥é“çš„
            while (num==0){

            }
        }).start();

        try {
            TimeUnit.SECONDS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        num = 1;
        System.out.println(num);

    }
}


```

ä½†æ˜¯å¦‚æœåœ¨whileå¾ªç¯é‡Œé¢æ·»åŠ äº†æ‰“å°içš„è¯­å¥

```java
while(num==0)
 {
  System.out.println(num);
 }

```

ç¨‹åºè¿è¡Œä¸€ä¼šå°±åœæ­¢äº†

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/ab7727519911faba7b1bdfdbc6d97968.gif)

è¿™æ˜¯å› ä¸ºå­çº¿ç¨‹å¼ºåˆ¶è¯»äº†ä¸€éiçš„å€¼

åœ¨å¾ªç¯ä½“ä¸­æ‰“å°è¾“å‡ºè¯­å¥æ—¶ï¼Œprintlnæ–¹æ³•ä¸­æœ‰synchronizedåŒæ­¥ä»£ç å—ï¼Œè€Œsynchronizedä¹Ÿèƒ½ä¿è¯å¯¹å˜é‡çš„ä¿®æ”¹å¯è§æ€§ï¼Œå¯¹å˜é‡numè¿›è¡Œæ“ä½œä»¥å,numçš„å€¼ä¹Ÿä¼šç«‹å³åˆ·å›ä¸»å­˜

åœ¨å­çº¿ç¨‹åŠ äº†è¾“å‡ºè¯­å¥ä¼šå¯¼è‡´runæ–¹æ³•é‡Œé¢çš„å¾ªç¯æ¯è¾“å‡ºä¸€æ¬¡è¿›è¡Œä¸€æ¬¡åˆ¤æ–­ï¼Œå½“å†…å­˜æ•°æ®ä¿®æ”¹ï¼Œç­‰ç¼“å­˜ä¸€è‡´æ€§åè®®ç”Ÿæ•ˆ å†åˆ¤æ–­ å°±ä¼šé€€å‡ºå¾ªç¯

### 2ï¼‰ä¸ä¿è¯åŸå­æ€§

åŸå­æ€§ï¼š ä¸å¯åˆ†å‰²  
çº¿ç¨‹Aåœ¨æ‰§è¡Œä»»åŠ¡çš„æ—¶å€™ï¼Œæ˜¯ä¸èƒ½è¢«æ‰“æ‰°çš„ï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥

```java

public class Vdemo02 {
    private static int num=0;
    public static void add()
    {
        num++;
    }
    public static void main(String[] args) {
        for(int i=0;i<20;i++)
        {
            new Thread(()->{
                for(int j=0;j<1000;j++)
                {
                    add();
                }
            }).start();
        }

        while(Thread.activeCount()>2)//å› ä¸ºç¨‹åºé‡Œé¢å§‹ç»ˆæ˜¯æœ‰2ä¸ªçº¿ç¨‹çš„ï¼Œmainçº¿ç¨‹å’Œgcçº¿ç¨‹
        {
            Thread.yield();
            //Thread.yield()æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œæ„æ€æ˜¯è¿˜æœ‰å‡ºè·¯GCå’Œmainä¹‹å¤–çš„å…¶ä»–çº¿ç¨‹åœ¨è·‘ï¼Œä¸»çº¿ç¨‹å°±è®©å‡ºcpuä¸å¾€ä¸‹æ‰§è¡Œï¼Œè®©å‡ºç„¶åé‡æ–°ç«äº‰cpuçš„æ‰§è¡Œæƒï¼Œæœ‰å¯èƒ½è¿˜æ˜¯mainæŠ¢åˆ°ï¼Œä¸è¿‡è¿™é‡Œæ˜¯å¾ªç¯ï¼ŒæŠ¢åˆ°ç»§ç»­è®©å‡ºï¼Œç›´åˆ°åªæœ‰2ä¸ªçº¿ç¨‹
        }
        //ç†è®ºä¸Šæ‰“å°å‡ºæ¥åº”è¯¥æ˜¯20000
        System.out.println(Thread.currentThread().getName()+" "+num);//è‚¯å®šä¸èƒ½ç›´æ¥
    }
}

```

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/1fb33ed6e46d694378e73cbc5026303f.png)

è§£å†³æ–¹æ³•  
æˆ‘ä»¬å¯ä»¥åŠ synchronized

```java
 public synchronized static void add()
    {
        num++;
    }

```

å¦‚æœåªæ˜¯ç»™å˜é‡åŠ ä¸Švolatile

```java
  private volatile static int num=0;

```

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/aabbf601959bcd8a29b4832249b17c03.png)

æ³¨æ„++ä¸æ˜¯åŸå­æ“ä½œ  
**ä¸åŠ lockå’Œsynchronizedï¼Œæ€ä¹ˆä¿è¯åŸå­æ€§ï¼Ÿ**

æˆ‘ä»¬æ¥çœ‹çœ‹å¯¹äº++,jvmåº•å±‚æ˜¯æ€ä¹ˆæ“ä½œçš„

æ–¹æ³•1ï¼š

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/5145bbf12157faf5d009497cd6adc6db.png)

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/119edc54fcd5547c09468259fc3f3087.png)

![image-20200812215844788](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/91cbec5068448ebec5a35317624f2d42.png)

æ–¹æ³•2ï¼š  
åœ¨outç›®å½•ä¸‹é€‰ä¸­classæ–‡ä»¶ï¼Œç„¶åé€‰æ‹©show byteCodeï¼Œæ²¡æœ‰è¿™ä¸ªé€‰é¡¹çš„è¯ï¼Œä½ éœ€è¦å®‰è£…è¿™ä¸ªæ’ä»¶

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/cbd7ea3cbb4f280ed1952eb8e163a5cf.png)

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/7104137da2016f0a8923c6b03398fef2.png)

æ–¹æ³•3ï¼š

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/bb34fa6c84f594391da7f4a193cdd65c.png)

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/3436eee0e9c46814160e028960534f77.png)

```java
public static void add();
    Code:
       0: getstatic     #2                  // Field num:I
       3: iconst_1
       4: iadd
       5: putstatic     #2                  // Field num:I
       8: return

```

æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹++çš„å­—èŠ‚ç æ“ä½œ

ç¬¬ä¸€æ­¥ï¼šè·å¾— numçš„å€¼  
ç¬¬äºŒæ­¥ï¼š numçš„å€¼åŠ 1  
ç¬¬ä¸‰æ­¥ï¼š å†™å›num

åœ¨å¤šçº¿ç¨‹æ“ä½œçš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½åŠ 1åçš„å€¼è¿˜æ²¡æ¥å¾—åŠæ›´æ–°ï¼Œå°±è¢«å¦ä¸€ä¸ªçº¿ç¨‹è¯»åˆ°è¿›è¡ŒåŠ 1ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæœ‰ä¸€äº›çº¿ç¨‹ç”¨çš„æ˜¯ä»¥å‰çš„å€¼ï¼Œæ‰€ä»¥æ•´ä½“åŠ èµ·æ¥ä¼šå°äº20000

ä¹‹æ‰€ä»¥å°äºç†è®ºå€¼ï¼Œæ˜¯å› ä¸ºçº¿ç¨‹å›å†™æ•°æ®åˆ°ä¸»å†…å­˜çš„æ—¶å€™ï¼Œè¦†ç›–äº†å·²ç»è¢«å…¶ä»–æ›´å¿«çš„çº¿ç¨‹æ‰§è¡Œçš„ç»“æœ

å‡å¦‚numæ˜¯0ï¼Œå°±å¯èƒ½çº¿ç¨‹1åŠ äº†1ï¼Œè¿˜æ²¡å†™å›ï¼Œçº¿ç¨‹2å°±æ‹¿åˆ°äº†ï¼Œæ­¤æ—¶numè¿˜æ˜¯0ï¼Œæ‰€ä»¥ä¸¤ä¸ªçº¿ç¨‹éƒ½æ“ä½œäº†numï¼Œä½†æ˜¯numçš„å€¼æ˜¯1ï¼Œç›¸å½“äºåªåŠ äº†ä¸€æ¬¡

å¯¹çº¿ç¨‹æ¥è®²åªä¿è¯æ¯æ¬¡åŠ ä¹‹å‰ï¼Œä»ä¸»å­˜å–ä¸€ä¸‹å½“å‰å€¼  
åŠ çš„æ¬¡æ•°æ˜¯å›ºå®šçš„ï¼Œæœ‰çš„çº¿ç¨‹å–çš„æ˜¯æ—§å€¼ï¼Œç»“æœè‚¯å®šå°äº†

å›åˆ°åˆšåˆšçš„é—®é¢˜ï¼Œä¸åŠ lockå’Œsynchronizedï¼Œæ€ä¹ˆä¿è¯åŸå­æ€§ï¼Ÿ

##### ä½¿ç”¨åŸå­ç±»è§£å†³åŸå­æ€§é—®é¢˜

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/b5ef586fceeb771e4ceff52edd25ddb8.png)

```java
 private  static AtomicInteger num=new AtomicInteger();
    public  static void add()
    {
        num.getAndIncrement(); //cas
        //num=num+1;
    }

```

å› ä¸ºåŸå­ç±»åº•å±‚åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå°†èµ‹å€¼ç»™äº†ä¸€ä¸ªvolatielå±æ€§  
åŸå­ç±»çš„åº•å±‚éƒ½ç›´æ¥å’Œæ“ä½œç³»ç»ŸæŒ‚é’©ï¼Œåœ¨å†…å­˜ä¸­ä¿®æ”¹å€¼ï¼ŒUnsafeç±»æ˜¯å¾ˆç‰¹æ®Šçš„å­˜åœ¨

```java
 public final int getAndIncrement() {
        return unsafe.getAndAddInt(this, valueOffset, 1);
    }

```

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/bce9f34aff01b2e63f49e15a154347a3.png)

### 3ï¼‰ç¦æ­¢æŒ‡ä»¤é‡æ’

**ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’ï¼Ÿ**

æˆ‘ä»¬å†™çš„ç¨‹åºï¼Œè®¡ç®—æœºå¹¶ä¸æ˜¯æŒ‰ç…§æˆ‘ä»¬è‡ªå·±å†™çš„é‚£æ ·å»æ‰§è¡Œçš„

æºä»£ç â€“>ç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’â€“>æŒ‡ä»¤å¹¶è¡Œä¹Ÿå¯èƒ½ä¼šé‡æ’â€“>å†…å­˜ç³»ç»Ÿä¹Ÿä¼šé‡æ’â€“>æ‰§è¡Œ

**å¤„ç†å™¨åœ¨è¿›è¡ŒæŒ‡ä»¤é‡æ’çš„æ—¶å€™ï¼Œä¼šè€ƒè™‘æ•°æ®ä¹‹é—´çš„ä¾èµ–æ€§ï¼**

```java
int x=1; //1
int y=2; //2
x=x+5;   //3
y=x*x;   //4

//æˆ‘ä»¬æœŸæœ›çš„æ‰§è¡Œé¡ºåºæ˜¯ 1_2_3_4  å¯èƒ½æ‰§è¡Œçš„é¡ºåºä¼šå˜æˆ2134 1324
//å¯ä¸å¯èƒ½æ˜¯ 4123ï¼Ÿ ä¸å¯èƒ½çš„
```

å¯èƒ½é€ æˆçš„å½±å“ç»“æœï¼šå‰æï¼ša b x yè¿™å››ä¸ªå€¼ é»˜è®¤éƒ½æ˜¯0

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/3739ea67826b8a24d42824e863121f2b.png)

**volatileå¯ä»¥é¿å…æŒ‡ä»¤é‡æ’ï¼š**

**volatileä¸­ä¼šåŠ ä¸€é“å†…å­˜çš„å±éšœï¼Œè¿™ä¸ªå†…å­˜å±éšœå¯ä»¥ä¿è¯åœ¨è¿™ä¸ªå±éšœä¸­çš„æŒ‡ä»¤é¡ºåºã€‚**

å†…å­˜å±éšœï¼šCPUæŒ‡ä»¤ã€‚ä½œç”¨ï¼š

1ã€ä¿è¯ç‰¹å®šçš„æ“ä½œçš„æ‰§è¡Œé¡ºåºï¼›

2ã€å¯ä»¥ä¿è¯æŸäº›å˜é‡çš„å†…å­˜å¯è§æ€§ï¼ˆåˆ©ç”¨è¿™äº›ç‰¹æ€§ï¼Œå°±å¯ä»¥ä¿è¯volatileå®ç°çš„å¯è§æ€§ï¼‰

**volatileæ ‡æ³¨åï¼Œç¼–è¯‘å™¨ç”Ÿæˆä»£ç ä¼šä¸ä¼˜åŒ–**

![image-20200812220019582](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/ee0dbf2b7b4a33175b15601fc4f4e726.png)

volatileå†™å‰åŠ SSå±éšœå†™ååŠ SLå±éšœï¼Œè¯»å‰åŠ LLå±éšœï¼Œè¯»ååŠ LSå±éšœ

### 4ï¼‰æ€»ç»“

+   **volatileå¯ä»¥ä¿è¯å¯è§æ€§ï¼›**
+   **ä¸èƒ½ä¿è¯åŸå­æ€§**
+   **ç”±äºå†…å­˜å±éšœï¼Œå¯ä»¥ä¿è¯é¿å…æŒ‡ä»¤é‡æ’çš„ç°è±¡äº§ç”Ÿ**

é¢è¯•å®˜ï¼šé‚£ä¹ˆä½ çŸ¥é“åœ¨å“ªé‡Œç”¨è¿™ä¸ªå†…å­˜å±éšœç”¨å¾—æœ€å¤šå‘¢ï¼Ÿ**å•ä¾‹æ¨¡å¼**

### 15. ç©è½¬å•ä¾‹æ¨¡å¼

é¥¿æ±‰å¼ã€DCLæ‡’æ±‰å¼

è¯´åˆ°volatileçš„é˜²æ­¢æŒ‡ä»¤é‡æ’ï¼Œé‚£ä¹ˆvolatileçš„å†…å­˜å±éšœåœ¨å“ªé‡Œä½¿ç”¨çš„æœ€å¤šï¼Œå°±æ˜¯å•ä¾‹æ¨¡å¼äº†ã€‚

### 1ï¼‰é¥¿æ±‰å¼

é¥¿æ±‰å¼çš„é—®é¢˜ï¼šå¯èƒ½ä¼šæµªè´¹å†…å­˜  
é¥¿æ±‰å¼ä¸€ä¸Šæ¥å°±ä¼šæŠŠæ‰€æœ‰çš„ä¸œè¥¿åŠ è½½åˆ°å†…å­˜ï¼Œå¯¹è±¡å°±å·²ç»å­˜åœ¨äº†ï¼Œå¯¹è±¡æ²¡æœ‰ä½¿ç”¨çš„è¯ï¼Œå¯èƒ½ä¼šæµªè´¹å†…å­˜

**ä¸»è¦ç‰¹ç‚¹æœ‰ï¼š**

æ„é€ å‡½æ•°ç§æœ‰ï¼Œé¿å…åœ¨å¤–éƒ¨è¢«åˆ›å»ºå¯¹è±¡  
æå‰åˆ›å»ºå¥½å¯¹è±¡  
æä¾›å…¬æœ‰çš„æ¥å£ï¼Œè¿”å›åœ¨ç±»å†…éƒ¨æå‰åˆ›å»ºå¥½çš„å¯¹è±¡  
é™æ€å˜é‡éšç€ç±»çš„åŠ è½½å°±å·²ç»å®ä¾‹åŒ–äº†ï¼Œè·Ÿæ˜¯å¦è°ƒç”¨é™æ€æ–¹æ³•æ²¡æœ‰å…³ç³»  
é¥¿æ±‰å¼åŠ è½½æ—¶å°±ä¼šåˆå§‹åŒ–ï¼Œæ‡’æ±‰å¼åªæœ‰åœ¨è·å–å•ä¾‹çš„æ—¶å€™æ‰ä¼šåˆå§‹åŒ–  
ç±»åŠ è½½æ—¶ï¼Œæˆå‘˜å˜é‡ä¼šè¢«åˆå§‹åŒ–ï¼Œå±€éƒ¨å˜é‡ä¸ä¼š

```java
/**
 * é¥¿æ±‰å¼å•ä¾‹
 */
public class Hungry {

    /**
     * å¯èƒ½ä¼šæµªè´¹ç©ºé—´
     */
    private byte[] data1=new byte[1024*1024];
    private byte[] data2=new byte[1024*1024];
    private byte[] data3=new byte[1024*1024];
    private byte[] data4=new byte[1024*1024];



    private Hungry(){

    }
    private final static Hungry hungry = new Hungry();

    public static Hungry getInstance(){
        return hungry;
    }

}

```

### 2ï¼‰DCLæ‡’æ±‰å¼

é’ˆå¯¹é¥¿æ±‰å¼å•ä¾‹çš„æµªè´¹å†…å­˜çš„é—®é¢˜ï¼Œæå‡ºäº†æ‡’æ±‰å¼å•ä¾‹ï¼Œè¦ç”¨çš„æ—¶å€™å†åˆ›å»ºå¯¹è±¡

```java

public class LazyMan {
    private LazyMan(){

    }
    private static LazyMan lazyman;//è¿˜æ²¡æœ‰åˆ›å»ºå¯¹è±¡ï¼Œåªæ˜¯å£°æ˜ï¼Œæ²¡æœ‰new

    public static LazyMan getInstance()
    {
      if(lazyman==null)
       {
         lazyman=new LazyMan();//å¦‚æœè¿™ä¸ªå¯¹è±¡ä¸ºç©ºï¼Œå°±å®ä¾‹åŒ–è¿™ä¸ªå¯¹è±¡
       }
      return lazyman;
    }
}

```

åœ¨å¤šä¸ªçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œæ‡’æ±‰å¼å•ä¾‹å¯èƒ½ä¼šå‡ºç°å®‰å…¨é—®é¢˜ï¼Œå°±æ˜¯çº¿ç¨‹1è¿›å…¥äº†ifåˆ¤æ–­ï¼Œå¹¶å¼€å§‹æ„é€ å¯¹è±¡

```java
public class LazyMan {
    private LazyMan(){
        System.out.println(Thread.currentThread().getName()+"ok");
    }
    private static LazyMan lazyman;//è¿˜æ²¡æœ‰åˆ›å»ºå¯¹è±¡ï¼Œåªæ˜¯å£°æ˜ï¼Œæ²¡æœ‰new

    public static LazyMan getInstance()
    {
      if(lazyman==null)
       {
         lazyman=new LazyMan();//å¦‚æœè¿™ä¸ªå¯¹è±¡ä¸ºç©ºï¼Œå°±å®ä¾‹åŒ–è¿™ä¸ªå¯¹è±¡
       }
      return lazyman;
    }

    public static void main(String[] args) {
        for (int i = 0; i < 10; i++) {
            new Thread(()->{
                LazyMan.getInstance();
            }).start();

        }
    }
}


```

å¯ä»¥çœ‹åˆ°ï¼Œæœ‰3ä¸ªçº¿ç¨‹è°ƒç”¨äº†æ„é€ å‡½æ•°ï¼Œè¿™è¯´æ˜ç¨‹åºä¸­ç°åœ¨æœ‰3ä¸ªLazymanå¯¹è±¡ï¼Œå°±ä¸æ˜¯å•ä¾‹äº†ï¼Œæ‰€ä»¥ä¸å®‰å…¨

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/f11b7124bd00ab53050cff8ee40ec08a.png)

##### åŒé‡é”æœºåˆ¶

```java

public class LazyMan {
    private LazyMan(){
        System.out.println(Thread.currentThread().getName()+"ok");
    }
    private static LazyMan lazyman;//è¿˜æ²¡æœ‰åˆ›å»ºå¯¹è±¡ï¼Œåªæ˜¯å£°æ˜ï¼Œæ²¡æœ‰new

    public static LazyMan getInstance()
    {
        //åŒé‡æ£€æµ‹é”æ¨¡å¼ DCL
        if(lazyman==null)
        {
            //å¦‚æœä¸ºç©ºï¼Œå…ˆä¸Šä¸€å±‚é”ï¼Œé”LazyManå½“å‰å¯¹è±¡
            synchronized (LazyMan.class){//é™æ€æ–¹æ³•æ˜¯ç±»é”
              //å¦‚æœsynchronizedç›´æ¥å†™åœ¨æ–¹æ³•ä¸Šï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½è¦æŠ¢é”ï¼Œæ•ˆç‡ä½ï¼Œè¿™ä¸ªåªæœ‰ä¸ºç©ºæ—¶æ‰ä¼šæŠ¢é”
                if(lazyman==null)//åœ¨é”é‡Œé¢å†åˆ¤æ–­ä¸€æ¬¡
                {
                    lazyman=new LazyMan();//å¦‚æœè¿™ä¸ªå¯¹è±¡ä¸ºç©ºï¼Œå°±å®ä¾‹åŒ–è¿™ä¸ªå¯¹è±¡
                }
            }
        }

      return lazyman;
    }

    public static void main(String[] args) {
        for (int i = 0; i < 10; i++) {
            new Thread(()->{
             LazyMan.getInstance();
              //  System.out.println(LazyMan.getInstance());
            }).start();

        }
    }
}



```

å¯ä»¥çœ‹åˆ°åªåˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/e9710661af9e6f8f93e762c8a08e5881.png)

ä½†æ˜¯è¿˜æ˜¯æœ‰å¯èƒ½å‡ºç°é—®é¢˜

åˆ›å»ºå¯¹è±¡çš„è¿‡ç¨‹åœ¨æç«¯æƒ…å†µä¸‹è‚¯å®šæ˜¯ä¼šå‡ºç°é—®é¢˜çš„ï¼Œå› ä¸ºä¸æ˜¯åŸå­æ€§æ“ä½œï¼Œä¼šç»å†  
1 åˆ†é…å†…å­˜ç©ºé—´ï¼Œ  
2æ‰§è¡Œæ„é€ æ–¹æ³•ï¼ˆåˆå§‹åŒ–å¯¹è±¡ï¼‰  
3æŠŠå¯¹è±¡æŒ‡å‘åˆ†é…çš„ç©ºé—´

ä½†æ˜¯å¯èƒ½ä¼šå‘ç”ŸæŒ‡ä»¤é‡æ’ï¼Œå¯èƒ½ä¼šæŒ‰132çš„é¡ºåºæ‰§è¡Œï¼Œå°±æ˜¯å…ˆåˆ†é…å†…å­˜ç©ºé—´ï¼Œç„¶åç”¨ç©ºå¯¹è±¡å…ˆå ç”¨å†…å­˜ç©ºé—´ï¼Œå ç”¨ä¹‹åå†æ‰§è¡Œæ„é€ æ–¹æ³•

å¦‚ä¸‹å›¾ï¼Œ**å¾ˆæœ‰å¯èƒ½Aæ‰§è¡Œäº†13è¿˜æ²¡æ‰§è¡Œ2ï¼Œä½†æ˜¯ç°åœ¨lazymanå·²ç»ä¸æ˜¯nulläº†ï¼Œå¦‚æœç°åœ¨è¿›æ¥ä¸€ä¸ªBçº¿ç¨‹ï¼Œå¤–å±‚åˆ¤æ–­ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆBçº¿ç¨‹ä¼šç›´æ¥è¿”å›lazymanï¼Œä½†lazymanå®é™…ä¸Šè¿˜æ²¡æœ‰å®Œæˆæ„é€ **ï¼Œæ‰€ä»¥ä¸å®‰å…¨ï¼ˆnewåªæ˜¯æŠŠåº”ç”¨åŠ ä¸Šäº†ï¼Œä½†æ˜¯å †è¿˜æ²¡æœ‰åˆ›å»ºå®Œï¼Œreturnå°±ä¼šæœ‰é—®é¢˜ï¼‰

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/d694a68f7e50e7e499c0eabafdb7170b.png)

æ‰€ä»¥è¦ç”¨volatileä¿®é¥°é˜²æ­¢æŒ‡ä»¤é‡æ’ï¼ˆé˜²æ­¢ç¬¬äºŒä¸ªçº¿ç¨‹æŠ¢å…ˆæ‰§è¡Œï¼ŒæŠ¢å…ˆè¿”å›ä¸€ä¸ªå°šæœªåˆå§‹åŒ–å®Œæˆçš„å¼•ç”¨ï¼‰  
æ‰€ä»¥è¿™é‡Œæ˜¯åŒæ­¥ä»£ç å—ä¿è¯äº†æ“ä½œçš„åŸå­æ€§ï¼Œvolatileç¦æ­¢äº†æŒ‡ä»¤é‡æ’  
æŒ‡ä»¤é‡æ’çš„åŸç†æ˜¯ä¸ºäº†æå‡CPUå¤šæ®µæµæ°´çš„æ•ˆç‡ï¼Œä½†å¹¶ä¸æ˜¯æŒ‡ä»¤ä»»æ„é‡æ’ï¼Œå¤„ç†å™¨å¿…é¡»èƒ½æ­£ç¡®å¤„ç†æŒ‡ä»¤ä¾èµ–å…³ç³»ä¿éšœç¨‹åºå¾—å‡ºæ­£ç¡®çš„æ‰§è¡Œç»“æœã€‚

**æ€»ç»“ï¼šsynchronizedä¿è¯çš„æ˜¯ifåˆ¤æ–­å’Œnewä¸€ä¸ªå¯¹è±¡èƒ½åŒæ—¶æˆåŠŸæˆ–åŒæ—¶å¤±è´¥ï¼Œä½†æ˜¯newä¸€ä¸ªå¯¹è±¡ä¸æ˜¯åŸå­æ“ä½œï¼Œæ‰§è¡Œ13åï¼Œç¬¬äºŒä¸ªçº¿ç¨‹è®¤ä¸ºå·²ç»newå¯¹è±¡æˆåŠŸäº†ï¼Œæœ€ä¸Šé¢çš„ifåˆ¤æ–­ä¸ç­‰äºnull**

### 3ï¼‰é™æ€å†…éƒ¨ç±»

åœ¨ä¸€ä¸ªç±»é‡Œé¢å†™ä¸€ä¸ªé™æ€çš„ç±»  
é¦–å…ˆåªè¦å•ä¾‹ä¸€å®šè¦å…ˆæ„é€ å™¨ç§æœ‰  
åŠ è½½å¤–éƒ¨ç±»æ—¶ï¼Œä¸ä¼šåŠ è½½é™æ€å†…éƒ¨ç±»  
çº¿ç¨‹å®‰å…¨ä¸”æ‡’åŠ è½½  
ä½†æ˜¯é™æ€å†…éƒ¨ç±»å•ä¾‹ä¹Ÿæ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºåå°„å¯ä»¥ç ´åå•ä¾‹

```java
//é™æ€å†…éƒ¨ç±»
public class Holder {
    private Holder(){

    }
    public static Holder getInstance(){
        return InnerClass.holder;
    }
    public static class InnerClass{
        private static final Holder holder = new Holder();
    }
}

```

æµ‹è¯•

```java
public class Holder {
    private Holder() {
        System.out.println(Thread.currentThread().getName()+"ok");
    }

    public static Holder getInstance() {
        return InnerClass.HOLDER;
    }

    public static class InnerClass {
        private static final Holder HOLDER = new Holder();
    }

    public static void main(String[] args) {
       for(int i=0;i<10;i++)
       {
           new Thread(()->{
               Holder.getInstance();
           }).start();
       }
    }
}

```

å¯ä»¥çœ‹åˆ°ï¼Œå†…å­˜ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå°±æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥äº†æ„é€ å‡½æ•°ï¼Œå› ä¸ºé™æ€ç±»åªåŠ è½½ä¸€æ¬¡

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/bd2cbc3d881649b992f9c1c9bd508dce.png)

ä½†æ˜¯åªè¦æœ‰åå°„ï¼Œä»»ä½•ç§æœ‰çš„éƒ½æ˜¯çº¸è€è™ï¼Œæˆ‘ä»¬ä»¥DCLçš„å•ä¾‹ä¸ºä¾‹ï¼Œæ¥è¯•è¯•åå°„

```java
    public static void main(String[] args) throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException {
//        for (int i = 0; i < 10; i++) {
//            new Thread(()->{
//             LazyMan.getInstance();
//              //  System.out.println(LazyMan.getInstance());
//            }).start();
    //    }
        LazyMan instance = LazyMan.getInstance();
        //è·å¾—ç©ºå‚æ„é€ å™¨
        Constructor<LazyMan> declaredConstructor = LazyMan.class.getDeclaredConstructor(null);
        //æ— è§†ç§æœ‰æ„é€ å™¨
        declaredConstructor.setAccessible(true);
        //é€šè¿‡åå°„åˆ›å»ºå¯¹è±¡
        LazyMan lazyMan = declaredConstructor.newInstance();

        //æµ‹è¯•ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ä¸€æ ·
        System.out.println( instance );
        System.out.println(lazyMan);
    }

```

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/caf6565c92c0bf195b2474218607b35d.png)

å¯ä»¥ç ´è§£ï¼š

```java
private LazyMan(){
                synchronized (LazyMan.class){

                    if(lazyman!=null)
                    {
                        throw new RuntimeException("ä¸è¦è¯•å›¾é€šè¿‡åå°„ç ´åå•ä¾‹");
                    }
                    System.out.println(Thread.currentThread().getName()+"ok");

        }

```

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/08842d65dd348c0886d1af03a9fe0c5e.png)

çœ‹å®Œæ•´ä»£ç   
ç›¸å½“äºåœ¨DCLçš„åŸºç¡€ä¸Šåˆåœ¨æ„é€ å‡½æ•°é‡Œé¢åŠ äº†ä¸€é‡æ£€æµ‹

```java
public class LazyMan {

    private LazyMan() {
        synchronized (LazyMan.class) {

            if (lazyman != null) {
                throw new RuntimeException("ä¸è¦è¯•å›¾é€šè¿‡åå°„ç ´åå•ä¾‹");
            }
            System.out.println(Thread.currentThread().getName() + "ok");
        }
        //
    }

    private static volatile LazyMan lazyman;//è¿˜æ²¡æœ‰åˆ›å»ºå¯¹è±¡ï¼Œåªæ˜¯å£°æ˜ï¼Œæ²¡æœ‰new

    public static LazyMan getInstance() {
        //åŒé‡æ£€æµ‹é”æ¨¡å¼ DCL
        if (lazyman == null) {
            //å¦‚æœä¸ºç©ºï¼Œå…ˆä¸Šä¸€å±‚é”ï¼Œé”LazyManå½“å‰å¯¹è±¡
            synchronized (LazyMan.class) {//é™æ€æ–¹æ³•æ˜¯ç±»é”
                //å¦‚æœsynchronizedç›´æ¥å†™åœ¨æ–¹æ³•ä¸Šï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½è¦æŠ¢é”ï¼Œæ•ˆç‡ä½ï¼Œè¿™ä¸ªåªæœ‰ä¸ºç©ºæ—¶æ‰ä¼šæŠ¢é”
                if (lazyman == null)//åœ¨é”é‡Œé¢å†åˆ¤æ–­ä¸€æ¬¡
                {
                    lazyman = new LazyMan();//å¦‚æœè¿™ä¸ªå¯¹è±¡ä¸ºç©ºï¼Œå°±å®ä¾‹åŒ–è¿™ä¸ªå¯¹è±¡
                }
            }
        }

        return lazyman;
    }

    public static void main(String[] args) throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException {
//        for (int i = 0; i < 10; i++) {
//            new Thread(()->{
//             LazyMan.getInstance();
//              //  System.out.println(LazyMan.getInstance());
//            }).start();
        //    }
        LazyMan instance = LazyMan.getInstance();
        //è·å¾—ç©ºå‚æ„é€ å™¨
        Constructor<LazyMan> declaredConstructor = LazyMan.class.getDeclaredConstructor(null);
        //æ— è§†ç§æœ‰æ„é€ å™¨
        declaredConstructor.setAccessible(true);
        //é€šè¿‡åå°„åˆ›å»ºå¯¹è±¡
        LazyMan lazyMan = declaredConstructor.newInstance();

        //æµ‹è¯•ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ä¸€æ ·
        System.out.println(instance);
        System.out.println(lazyMan);
    }
}

```

ç°åœ¨æˆ‘ä»¬ä¸ç”¨getInstance()å»è·å–å¯¹è±¡ï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡åå°„åˆ›å»ºä¸¤ä¸ªå¯¹è±¡

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/8a3851859a8300242191aca84819adcf.png)

å¯ä»¥å‘ç°ï¼Œå•ä¾‹åˆè¢«ç ´åäº†ï¼Œå› ä¸ºæ„é€ å‡½æ•°é‡Œé¢åˆ¤æ–­çš„æ˜¯

```java
 if (lazyman == null)//åœ¨é”é‡Œé¢å†åˆ¤æ–­ä¸€æ¬¡
                {
                }

```

ä½†æ˜¯æ³¨æ„ï¼Œæˆ‘ä»¬ç”¨åå°„new çš„å¯¹è±¡è·Ÿç±»é‡Œé¢çš„lazymanå¯¹è±¡è‚¯å®šæ˜¯ä¸ä¸€æ ·çš„å•Šï¼Œæ²¡æœ‰è°ƒç”¨getInstance(),ç±»é‡Œé¢çš„lazymanå°±ä¸€ç›´ä¸ºç©ºï¼Œæ‰€ä»¥å•ä¾‹åˆè¢«ç ´åäº†

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/580f59654c716ac8932237ef37094534.png)

è§£å†³æ–¹æ³•ï¼Œç”¨ä¸ªæ ‡å¿—ä½

```java
private static boolean flag=false;
    private LazyMan() {
        synchronized (LazyMan.class) {

            if( flag==false)
            {
                flag=true;
            }
            else
            {
                throw new RuntimeException("ä¸è¦è¯•å›¾é€šè¿‡åå°„ç ´åå•ä¾‹");
            }
        }
    }

```

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/97c05ea3028ed90844b05cc7b9904571.png)

æ¥æˆ‘ä»¬ç»§ç»­ç ´åå•ä¾‹ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªflagå­—æ®µç»™å®ƒç ´åäº†

```java
  Field  flag=LazyMan.class.getDeclaredField("flag");
        flag.setAccessible(true);
        Constructor<LazyMan> declaredConstructor = LazyMan.class.getDeclaredConstructor(null);
        //æ— è§†ç§æœ‰æ„é€ å™¨
        declaredConstructor.setAccessible(true);
        //é€šè¿‡åå°„åˆ›å»ºå¯¹è±¡
        LazyMan lazyMan = declaredConstructor.newInstance();
        flag.set(lazyMan,false);//æŠŠç¬¬ä¸€ä¸ªå¯¹è±¡çš„flagé‡æ–°æ”¹æˆfalse
        LazyMan lazyMan2 = declaredConstructor.newInstance();

        //æµ‹è¯•ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ä¸€æ ·
       // System.out.println(instance);
        System.out.println(lazyMan);
        System.out.println(lazyMan2);

```

å¯ä»¥å‘ç°å•ä¾‹åˆè¢«ç ´åäº†ã€‚ã€‚ã€‚ã€‚

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/7f65168922944ab7342b5ef08cf3dc62.png)

```java

public class LazyMan {
private static boolean flag=false;
    private LazyMan() {
        synchronized (LazyMan.class) {

            if( flag==false)
            {
                flag=true;
            }
            else
            {
                throw new RuntimeException("ä¸è¦è¯•å›¾é€šè¿‡åå°„ç ´åå•ä¾‹");
            }
        }
    }

    private static volatile LazyMan lazyman;//è¿˜æ²¡æœ‰åˆ›å»ºå¯¹è±¡ï¼Œåªæ˜¯å£°æ˜ï¼Œæ²¡æœ‰new

    public static LazyMan getInstance() {
        //åŒé‡æ£€æµ‹é”æ¨¡å¼ DCL
        if (lazyman == null) {
            //å¦‚æœä¸ºç©ºï¼Œå…ˆä¸Šä¸€å±‚é”ï¼Œé”LazyManå½“å‰å¯¹è±¡
            synchronized (LazyMan.class) {//é™æ€æ–¹æ³•æ˜¯ç±»é”
                //å¦‚æœsynchronizedç›´æ¥å†™åœ¨æ–¹æ³•ä¸Šï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½è¦æŠ¢é”ï¼Œæ•ˆç‡ä½ï¼Œè¿™ä¸ªåªæœ‰ä¸ºç©ºæ—¶æ‰ä¼šæŠ¢é”
                if (lazyman == null)//åœ¨é”é‡Œé¢å†åˆ¤æ–­ä¸€æ¬¡
                {
                    lazyman = new LazyMan();//å¦‚æœè¿™ä¸ªå¯¹è±¡ä¸ºç©ºï¼Œå°±å®ä¾‹åŒ–è¿™ä¸ªå¯¹è±¡
                }
            }
        }
        return lazyman;
    }

    public static void main(String[] args) throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, NoSuchFieldException {
//        for (int i = 0; i < 10; i++) {
//            new Thread(()->{
//             LazyMan.getInstance();
//              //  System.out.println(LazyMan.getInstance());
//            }).start();
        //    }
        // LazyMan instance = LazyMan.getInstance();
//è·å¾—ç©ºå‚æ„é€ å™¨

        Field  flag=LazyMan.class.getDeclaredField("flag");
        flag.setAccessible(true);
        Constructor<LazyMan> declaredConstructor = LazyMan.class.getDeclaredConstructor(null);
        //æ— è§†ç§æœ‰æ„é€ å™¨
        declaredConstructor.setAccessible(true);
        //é€šè¿‡åå°„åˆ›å»ºå¯¹è±¡
        LazyMan lazyMan = declaredConstructor.newInstance();
        flag.set(lazyMan,false);//æŠŠç¬¬ä¸€ä¸ªå¯¹è±¡çš„flagé‡æ–°æ”¹æˆfalse
        LazyMan lazyMan2 = declaredConstructor.newInstance();

        //æµ‹è¯•ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ä¸€æ ·
       // System.out.println(instance);
        System.out.println(lazyMan);
        System.out.println(lazyMan2);
    }
}



```

é‚£æ€ä¹ˆè§£å†³å‘¢ï¼Ÿæˆ‘ä»¬ç‚¹è¿›å»åå°„çš„newInstance()çœ‹çœ‹å‘¢

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœç±»æ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹çš„è¯ï¼Œå°±ä¼šå‘Šè¯‰ä½ ä¸èƒ½ä½¿ç”¨åå°„ç ´åæšä¸¾ï¼Œæšä¸¾æ˜¯jdk 1.5 å¼€å§‹å‡ºç°çš„ï¼Œè‡ªå¸¦å•ä¾‹æ¨¡å¼

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/2760e7946582449319f348f273c6dab8.png)

### 4ï¼‰æšä¸¾

**æšä¸¾æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªç±»**

```java
public enum EnumSingle {
    INSTANCE;
   public static EnumSingle getInstance()
   {
       return INSTANCE;
   }
}
 class Test{
     public static void main(String[] args) {
         EnumSingle  instance1=EnumSingle.INSTANCE;
         EnumSingle  instance2=EnumSingle.INSTANCE;
         EnumSingle  instance3=EnumSingle.getInstance();
         System.out.println( instance1);
         System.out.println( instance2);
         System.out.println( instance3);
     }
 }

```

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/4ff02294c6697c4acbde43f34087214f.png)

æˆ‘ä»¬æ¥è¯•è¯•ç”¨åå°„ç ´åæšä¸¾å•ä¾‹

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/9b684d854b93dd98be64c43be57c24af.png)

```java
   

public enum EnumSingle {
    INSTANCE;
   public static EnumSingle getInstance()
   {
       return INSTANCE;
   }
 }
 class Test{
    public static void main(String[] args) throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException {
		EnumSingle  instance1=EnumSingle.INSTANCE;
//         EnumSingle  instance2=EnumSingle.INSTANCE;
//         EnumSingle  instance3=EnumSingle.getInstance();

         Constructor<EnumSingle> declaredConstructor = EnumSingle.class.getDeclaredConstructor(null);
         declaredConstructor.setAccessible(true);//å…ˆæŠŠæ„é€ å™¨çš„ç§æœ‰æƒé™ç ´é™¤ï¼Œä½¿å¾—åå°„å¯ä»¥è®¿é—®ï¼Œåˆ›å»ºå¯¹è±¡
         EnumSingle instance2= declaredConstructor.newInstance();
         System.out.println( instance1);
         System.out.println( instance2);
     }
 }
```

ä¸‹é¢çš„é”™è¯¯æç¤ºæ˜¯æšä¸¾ç±»æ²¡æœ‰ç©ºå‚çš„æ„é€ æ–¹æ³•  
ä¹Ÿå°±æ˜¯ä¸‹é¢è¿™å¥è¯å‡ºé”™äº†ideaéª—äº†æˆ‘ä»¬

```java
 Constructor<EnumSingle> declaredConstructor = EnumSingle.class.getDeclaredConstructor(null);

```

æ­£å¸¸ç ´åå•ä¾‹æ˜¯åº”è¯¥æŠ¥é”™ä¸èƒ½ä½¿ç”¨åå°„ç ´åæšä¸¾

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/460faa4cc259396aee307e72accdd6b9.png)

é€šè¿‡åç¼–è¯‘æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæšä¸¾æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªclassï¼Œå®ƒç»§æ‰¿äº†ä¸€ä¸ªæšä¸¾ç±»  
ç„¶è€Œæ„é€ å™¨è¿˜æ˜¯ç©ºå‚çš„å•Šï¼Œè¯´æ˜æˆ‘ä»¬è¿˜æ˜¯è¢«éª—äº†

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/2fe48f19c1375ee4018a765d32fd43c0.png)

ç°åœ¨æˆ‘ä»¬ç”¨jad.exeåç¼–è¯‘è¯•è¯•

æˆ‘ä»¬æŠŠclasså­—èŠ‚ç ç”Ÿæˆjavaæ–‡ä»¶çœ‹çœ‹

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/51825f1f4c294fa9681d928168bd42c4.png)

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/58cf85756e26715574c252ff9036d9c1.png)

```java
// Decompiled by Jad v1.5.8g. Copyright 2001 Pavel Kouznetsov.
// Jad home page: http://www.kpdus.com/jad.html
// Decompiler options: packimports(3) 
// Source File Name:   EnumSingle.java

package juc.single;


public final class EnumSingle extends Enum
{

    public static EnumSingle[] values()
    {
        return (EnumSingle[])$VALUES.clone();
    }

    public static EnumSingle valueOf(String name)
    {
        return (EnumSingle)Enum.valueOf(juc/single/EnumSingle, name);
    }

    private EnumSingle(String s, int i)
    {
        super(s, i);
    }

    public static EnumSingle getInstance()
    {
        return INSTANCE;
    }

    public static final EnumSingle INSTANCE;
    private static final EnumSingle $VALUES[];

    static 
    {
        INSTANCE = new EnumSingle("INSTANCE", 0);
        $VALUES = (new EnumSingle[] {
            INSTANCE
        });
    }
}


```

å¯ä»¥çœ‹åˆ°ï¼Œä¸æ˜¯æ— å‚æ„é€ å™¨å“¦ï¼Œè€Œæ˜¯æœ‰å‚æ„é€ å™¨ï¼Œæœ‰ä¸€ä¸ªString,ä¸€ä¸ªInt

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/163b237683ff24b0009bef27db1d98d9.png)

ç°åœ¨æˆ‘ä»¬ä¿®æ”¹åå°„ä»£ç 

```java
 Constructor<EnumSingle> declaredConstructor = EnumSingle.class.getDeclaredConstructor(String.class,int.class);

```

å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ç»“æœäº†ï¼ŒæŠ›å‡ºåå°„ä¸èƒ½ç ´åæšä¸¾çš„å•ä¾‹å¼‚å¸¸

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/5685536d8dc8de165cb56d2059a444d5.png)

```java

public enum EnumSingle {
    INSTANCE;
   public static EnumSingle getInstance()
   {
       return INSTANCE;
   }
}
 class Test{
     public static void main(String[] args) throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException {
         EnumSingle  instance1=EnumSingle.INSTANCE;
//         EnumSingle  instance2=EnumSingle.INSTANCE;
//         EnumSingle  instance3=EnumSingle.getInstance();

        // Constructor<EnumSingle> declaredConstructor = EnumSingle.class.getDeclaredConstructor(null);
         Constructor<EnumSingle> declaredConstructor = EnumSingle.class.getDeclaredConstructor(String.class,int.class);
         declaredConstructor.setAccessible(true);//å…ˆæŠŠæ„é€ å™¨çš„ç§æœ‰æƒé™ç ´é™¤ï¼Œä½¿å¾—åå°„å¯ä»¥è®¿é—®ï¼Œåˆ›å»ºå¯¹è±¡
         EnumSingle instance2= declaredConstructor.newInstance();
         System.out.println( instance1);
         System.out.println( instance2);
     }
 }

```

## 15. ç†è§£CAS

### 1ï¼‰ä»€ä¹ˆæ˜¯CASï¼Ÿ

CAS æ˜¯ä¸€ç§**ç¡¬ä»¶çº§åˆ«çš„åŸå­æ“ä½œ**ï¼Œå®ƒæ¯”è¾ƒå†…å­˜ä¸­çš„æŸä¸ªå€¼æ˜¯å¦ä¸ºé¢„æœŸå€¼ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ›´æ–°ä¸ºæ–°å€¼ï¼Œå¦åˆ™ä¸åšä¿®æ”¹ã€‚

**å·¥ä½œåŸç†**ï¼š

- æ¯”è¾ƒï¼ˆCompareï¼‰ï¼šCAS ä¼šæ£€æŸ¥å†…å­˜ä¸­çš„æŸä¸ªå€¼æ˜¯å¦ä¸é¢„æœŸå€¼ç›¸ç­‰ã€‚
- äº¤æ¢ï¼ˆSwapï¼‰ï¼šå¦‚æœç›¸ç­‰ï¼Œåˆ™å°†å†…å­˜ä¸­çš„å€¼æ›´æ–°ä¸ºæ–°å€¼ã€‚
- å¤±è´¥é‡è¯•ï¼šå¦‚æœä¸ç›¸ç­‰ï¼Œè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹å·²ç»ä¿®æ”¹äº†è¯¥å€¼ï¼ŒCAS æ“ä½œå¤±è´¥ï¼Œä¸€èˆ¬ä¼šåˆ©ç”¨é‡è¯•ï¼Œç›´åˆ°æˆåŠŸã€‚

### ä¸¾ä¾‹è¯´æ˜

æˆ‘ä»¬ç»å¸¸æœ‰ç´¯åŠ éœ€æ±‚ï¼Œæ¯”è¾ƒä¸€ä¸ªå€¼æ˜¯å¦ç­‰äº 1ï¼Œå¦‚æœç­‰äº 1 æˆ‘ä»¬å°†å®ƒæ›¿æ¢æˆ 2ï¼Œå¦‚æœç­‰äº 2 æ›¿æ¢æˆ 3ã€‚

è¿™ç§æ¯”è¾ƒåœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹å°±ä¸å®‰å…¨ï¼Œæ¯”å¦‚æ­¤æ—¶åŒæ—¶æœ‰ä¸¤ä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°æ¯”è¾ƒå€¼æ˜¯å¦ç­‰äº 1ï¼Œç„¶åä¸¤ä¸ªçº¿ç¨‹å‘ç°éƒ½ç­‰äº 1ã€‚

ç„¶åä¸¤ä¸ªçº¿ç¨‹éƒ½å°†å®ƒå˜æˆäº† 2ï¼Œè¿™æ ·æ˜æ˜åŠ äº†ä¸¤æ¬¡ï¼Œå€¼å´ç­‰äº 2ã€‚

è¿™ç§æƒ…å†µå…¶å®åŠ é”å¯ä»¥è§£å†³ï¼Œä½†æ˜¯åŠ é”æ˜¯æ¯”è¾ƒæ¶ˆè€—èµ„æºçš„ã€‚

å› æ­¤ç¡¬ä»¶å±‚é¢å°±ç»™äºˆæ”¯æŒï¼Œå°†è¿™ä¸ªæ¯”è¾ƒå’Œäº¤æ¢çš„åŠ¨ä½œå°è£…æˆä¸€ä¸ªæŒ‡ä»¤ï¼Œè¿™æ ·å°±ä¿è¯äº†åŸå­æ€§ï¼Œä¸ä¼šåˆ¤æ–­å€¼ç¡®å®ç­‰äº 1ï¼Œä½†æ˜¯æ›¿æ¢çš„æ—¶å€™å€¼å·²ç»ä¸ç­‰äº 1äº†ã€‚

è¿™æŒ‡ä»¤å°±æ˜¯ CASã€‚

```java
public class casDemo {
    //CAS : compareAndSet æ¯”è¾ƒå¹¶äº¤æ¢
    public static void main(String[] args) {
        AtomicInteger atomicInteger = new AtomicInteger(2020);

        //boolean compareAndSet(int expect, int update)
        //æœŸæœ›å€¼ã€æ›´æ–°å€¼
        //å¦‚æœå®é™…å€¼ å’Œ æˆ‘çš„æœŸæœ›å€¼ç›¸åŒï¼Œé‚£ä¹ˆå°±æ›´æ–°
        //å¦‚æœå®é™…å€¼ å’Œ æˆ‘çš„æœŸæœ›å€¼ä¸åŒï¼Œé‚£ä¹ˆå°±ä¸æ›´æ–°
        System.out.println(atomicInteger.compareAndSet(2020, 2021));
        System.out.println(atomicInteger.get());

        //å› ä¸ºæœŸæœ›å€¼æ˜¯2020  å®é™…å€¼å´å˜æˆäº†2021  æ‰€ä»¥ä¼šä¿®æ”¹å¤±è´¥
        //CAS æ˜¯CPUçš„å¹¶å‘åŸè¯­
        atomicInteger.getAndIncrement(); //++æ“ä½œ
        System.out.println(atomicInteger.compareAndSet(2020, 2021));
        System.out.println(atomicInteger.get());
    }
}

```

Javaæ— æ³•æ“ä½œå†…å­˜ï¼Œä½†æ˜¯C++å¯ä»¥æ“ä½œå†…å­˜ï¼ŒJavaå¯ä»¥é€šè¿‡nativeæ–¹æ³•è°ƒç”¨c++ä»è€Œæ“ä½œå†…å­˜

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/e46b5ec936ae2fe1a597d7ac99519eab.png)

Unsafe ç±»

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/cd5c1fc6fe4cd04a1864b2d4eddee19b.png)

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/f3de334d8d1f554b36615566fa2cfda9.png)

**æ€»ç»“ï¼šCAS:æ¯”è¾ƒå½“å‰å·¥ä½œå†…å­˜ä¸­çš„å€¼å’Œä¸»å†…å­˜ä¸­çš„å€¼ï¼Œå¦‚æœè¿™ä¸ªå€¼æ˜¯æœŸæœ›çš„ï¼Œé‚£ä¹ˆåˆ™æ‰§è¡Œæ“ä½œï¼Œå¦‚æœä¸æ˜¯ï¼Œå°±ä¸€ç›´å¾ªç¯**ï¼Œä½¿ç”¨çš„æ˜¯è‡ªæ—‹é”ã€‚å› ä¸ºæ¯”è¾ƒå¹¶äº¤æ¢çš„è¿‡ç¨‹æ˜¯å¿…é¡»æ˜¯åŸå­æ€§çš„ï¼Œæ‰€ä»¥åº•å±‚æ˜¯é€šè¿‡åœ¨cpuæŒ‡ä»¤ä¸Šå®Œæˆcasæ“ä½œçš„ï¼›

å¥½å¤„:æ˜¯ä¸ç”¨åˆ‡æ¢çº¿ç¨‹çŠ¶æ€ï¼Œå› ä¸ºåˆ‡æ¢çº¿ç¨‹çŠ¶æ€æ€§èƒ½æ¶ˆè€—æ¯”è¾ƒå¤§  
ç¼ºç‚¹ï¼š  
1ï¼šç”±äºåº•å±‚æ˜¯è‡ªæ—‹é”ï¼Œå¾ªç¯ä¼šæµªè´¹æ—¶é—´  
2ï¼šå› ä¸ºæ˜¯åº•å±‚çš„cpuæ“ä½œï¼Œä¸€æ¬¡åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ€§  
3ï¼šABAé—®é¢˜

## 16.åŸå­å¼•ç”¨è§£å†³ABAé—®é¢˜

> CASï¼šABAé—®é¢˜ï¼Ÿ(ç‹¸çŒ«æ¢å¤ªå­)

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/367daf81c6954d227b5ac98222a296e6.png)

çº¿ç¨‹1ï¼šæœŸæœ›å€¼æ˜¯1ï¼Œè¦å˜æˆ2ï¼›

çº¿ç¨‹2ï¼šä¸¤ä¸ªæ“ä½œï¼š

+   1ã€æœŸæœ›å€¼æ˜¯1ï¼Œå˜æˆ3
+   2ã€æœŸæœ›æ˜¯3ï¼Œå˜æˆ1

æ‰€ä»¥å¯¹äºçº¿ç¨‹1æ¥è¯´ï¼ŒAçš„å€¼è¿˜æ˜¯1ï¼Œæ‰€ä»¥å°±å‡ºç°äº†é—®é¢˜ï¼Œéª—è¿‡äº†çº¿ç¨‹1ï¼›

```java
public class casDemo {
    //CAS : compareAndSet æ¯”è¾ƒå¹¶äº¤æ¢
    public static void main(String[] args) {
        AtomicInteger atomicInteger = new AtomicInteger(2020);

        System.out.println(atomicInteger.compareAndSet(2020, 2021));
        System.out.println(atomicInteger.get());

        //boolean compareAndSet(int expect, int update)
        //æœŸæœ›å€¼ã€æ›´æ–°å€¼
        //å¦‚æœå®é™…å€¼ å’Œ æˆ‘çš„æœŸæœ›å€¼ç›¸åŒï¼Œé‚£ä¹ˆå°±æ›´æ–°
        //å¦‚æœå®é™…å€¼ å’Œ æˆ‘çš„æœŸæœ›å€¼ä¸åŒï¼Œé‚£ä¹ˆå°±ä¸æ›´æ–°
        System.out.println(atomicInteger.compareAndSet(2021, 2020));
        System.out.println(atomicInteger.get());

        //å› ä¸ºæœŸæœ›å€¼æ˜¯2020  å®é™…å€¼å´å˜æˆäº†2021  æ‰€ä»¥ä¼šä¿®æ”¹å¤±è´¥
        //CAS æ˜¯CPUçš„å¹¶å‘åŸè¯­
//        atomicInteger.getAndIncrement(); //++æ“ä½œ
        System.out.println(atomicInteger.compareAndSet(2020, 2021));
        System.out.println(atomicInteger.get());
    }
}

```

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/befdae51a04e980bca270356aa43b676.png)

```java

public class CASDemo {
    /**AtomicStampedReference æ³¨æ„ï¼Œå¦‚æœæ³›å‹æ˜¯ä¸€ä¸ªåŒ…è£…ç±»ï¼Œæ³¨æ„å¯¹è±¡çš„å¼•ç”¨é—®é¢˜
     * æ­£å¸¸åœ¨ä¸šåŠ¡æ“ä½œï¼Œè¿™é‡Œé¢æ¯”è¾ƒçš„éƒ½æ˜¯ä¸€ä¸ªä¸ªå¯¹è±¡
     */
    static AtomicStampedReference<Integer> atomicStampedReference = new
            AtomicStampedReference<>(1, 1);

    // CAS compareAndSet : æ¯”è¾ƒå¹¶äº¤æ¢ï¼
    public static void main(String[] args) {
        new Thread(() -> {
            int stamp = atomicStampedReference.getStamp(); // è·å¾—ç‰ˆæœ¬å·
            System.out.println("a1=>" + stamp);
            
            try {
                TimeUnit.SECONDS.sleep(1);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            // ä¿®æ”¹æ“ä½œæ—¶ï¼Œç‰ˆæœ¬å·æ›´æ–° + 1
            atomicStampedReference.compareAndSet(1, 2,
                    atomicStampedReference.getStamp(),
                    atomicStampedReference.getStamp() + 1);
            
            System.out.println("a2=>" + atomicStampedReference.getStamp());
            // é‡æ–°æŠŠå€¼æ”¹å›å»ï¼Œ ç‰ˆæœ¬å·æ›´æ–° + 1
            System.out.println(atomicStampedReference.compareAndSet(2, 1,
                    atomicStampedReference.getStamp(),
                    atomicStampedReference.getStamp() + 1));
            System.out.println("a3=>" + atomicStampedReference.getStamp());
        }, "a").start();
        
        // ä¹è§‚é”çš„åŸç†ç›¸åŒï¼
        new Thread(() -> {
            int stamp = atomicStampedReference.getStamp(); // è·å¾—ç‰ˆæœ¬å·
            System.out.println("b1=>" + stamp);
            try {
                TimeUnit.SECONDS.sleep(2);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            System.out.println(atomicStampedReference.compareAndSet(1, 3,
                    stamp, stamp + 1));
            System.out.println("b2=>" + atomicStampedReference.getStamp());
        }, "b").start();
    }
}


```

## 17. å„ç§é”çš„ç†è§£

### 1ï¼‰å…¬å¹³é”ï¼Œéå…¬å¹³é”

1.  å…¬å¹³é”ï¼šéå¸¸å…¬å¹³ï¼Œä¸èƒ½æ’é˜Ÿï¼Œå¿…é¡»å…ˆæ¥ååˆ°

```java
/**
 * Creates an instance of {@code ReentrantLock}.
 * This is equivalent to using {@code ReentrantLock(false)}.
 */
public ReentrantLock() {
    sync = new NonfairSync();
}

```

2.  éå…¬å¹³é”ï¼šéå¸¸ä¸å…¬å¹³ï¼Œå…è®¸æ’é˜Ÿï¼Œå¯ä»¥æ”¹å˜é¡ºåº,**synchronizedå’Œlocké»˜è®¤éƒ½æ˜¯éå…¬å¹³é”**

```java
/**
 * Creates an instance of {@code ReentrantLock} with the
 * given fairness policy.
 *
 * @param fair {@code true} if this lock should use a fair ordering policy
 */
public ReentrantLock(boolean fair) {
    sync = fair ? new FairSync() : new NonfairSync();
}

```

### 2ï¼‰å¯é‡å…¥é”

æ‰€æœ‰çš„é”éƒ½æ˜¯å¯é‡å…¥é”ï¼Œæœ‰äº›åœ°æ–¹å«åšé€’å½’é”

ä½ è¿›å…¥ä½ å®¶ï¼Œæ‹¿åˆ°äº†å¤§é—¨çš„é”ï¼Œä¹Ÿå°±è‡ªåŠ¨æ‹¿åˆ°äº†é‡Œé¢å°é—¨çš„é”

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/96c04760e13e393233639ce126b09b9a.png)

1.  Synchonized é”

```java
public class Demo01 {
    public static void main(String[] args) {
        Phone phone = new Phone();
        new Thread(()->{
            phone.sms();
        },"A").start();
        new Thread(()->{
            phone.sms();
        },"B").start();
    }

}

class Phone{
    public synchronized void sms(){
        System.out.println(Thread.currentThread().getName()+"=> sms");
        call();//è¿™é‡Œä¹Ÿæœ‰ä¸€æŠŠé”
    }
    public synchronized void call(){
        System.out.println(Thread.currentThread().getName()+"=> call");
    }
}

```

2.  Lock é”

```java
//lock
public class Demo02 {

    public static void main(String[] args) {
        Phone2 phone = new Phone2();
        new Thread(()->{
            phone.sms();
        },"A").start();
        new Thread(()->{
            phone.sms();
        },"B").start();
    }

}
class Phone2{

    Lock lock=new ReentrantLock();

    public void sms(){
        lock.lock(); //ç»†èŠ‚ï¼šè¿™ä¸ªæ˜¯ä¸¤æŠŠé”ï¼Œä¸¤ä¸ªé’¥åŒ™
        //locké”å¿…é¡»é…å¯¹ï¼Œå¦åˆ™å°±ä¼šæ­»é”åœ¨é‡Œé¢
        try {
            System.out.println(Thread.currentThread().getName()+"=> sms");
            call();//è¿™é‡Œä¹Ÿæœ‰ä¸€æŠŠé”
        } catch (Exception e) {
            e.printStackTrace();
        }finally {
            lock.unlock();
        }
    }
    public void call(){
        lock.lock();
        try {
            System.out.println(Thread.currentThread().getName() + "=> call");
        }catch (Exception e){
            e.printStackTrace();
        }
        finally {
            lock.unlock();
        }
    }
}

```

+   locké”å¿…é¡»é…å¯¹ï¼Œç›¸å½“äºlockå’Œ unlock å¿…é¡»æ•°é‡ç›¸åŒï¼›
+   åœ¨å¤–é¢åŠ çš„é”ï¼Œä¹Ÿå¯ä»¥åœ¨é‡Œé¢è§£é”ï¼›åœ¨é‡Œé¢åŠ çš„é”ï¼Œåœ¨å¤–é¢ä¹Ÿå¯ä»¥è§£é”ï¼›

### 3ï¼‰è‡ªæ—‹é”

1.  spinlock

```java
public final int getAndAddInt(Object var1, long var2, int var4) {
    int var5;
    do {
        var5 = this.getIntVolatile(var1, var2);
    } while(!this.compareAndSwapInt(var1, var2, var5, var5 + var4));
    return var5;
}

```

2.  è‡ªæˆ‘è®¾è®¡è‡ªæ—‹é”

```java
public class SpinlockDemo {

    // é»˜è®¤
    // int 0
    //thread null
    AtomicReference<Thread> atomicReference=new AtomicReference<>();

    //åŠ é”
    public void myLock(){
        Thread thread = Thread.currentThread();
        System.out.println(thread.currentThread().getName()+"===> mylock");

        //è‡ªæ—‹é”
        while (!atomicReference.compareAndSet(null,thread)){
            System.out.println(Thread.currentThread().getName()+" ==> è‡ªæ—‹ä¸­~");
        }
    }


    //è§£é”
    public void myUnlock(){
        Thread thread=Thread.currentThread();
        System.out.println(thread.currentThread().getName()+"===> myUnlock");
        atomicReference.compareAndSet(thread,null);
    }

}

```

```java
public class TestSpinLock {
    public static void main(String[] args) throws InterruptedException {
        //ReentrantLock reentrantLock = new ReentrantLock();
        //reentrantLock.lock();
        //reentrantLock.unlock();


        //ä½¿ç”¨CASå®ç°è‡ªæ—‹é”
        SpinlockDemo spinlockDemo=new SpinlockDemo();
        new Thread(()->{
            spinlockDemo.myLock();
            try {
                TimeUnit.SECONDS.sleep(3);
            } catch (Exception e) {
                e.printStackTrace();
            } finally {
                spinlockDemo.myUnlock();
            }
        },"t1").start();

        TimeUnit.SECONDS.sleep(1);


        new Thread(()->{
            spinlockDemo.myLock();
            try {
                TimeUnit.SECONDS.sleep(3);
            } catch (Exception e) {
                e.printStackTrace();
            } finally {
                spinlockDemo.myUnlock();
            }
        },"t2").start();
    }
}

```

**t2è¿›ç¨‹å¿…é¡»ç­‰å¾…t1è¿›ç¨‹Unlockåï¼Œæ‰èƒ½Unlockï¼Œåœ¨è¿™ä¹‹å‰è¿›è¡Œè‡ªæ—‹ç­‰å¾…**

### 4ï¼‰æ­»é”

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/a888c6e5944c54d7ff77e867e68a6417.png)

```java

public class DeadLock {
    public static void main(String[] args) {
        String lockA= "lockA";
        String lockB= "lockB";

        new Thread(new MyThread(lockA,lockB),"t1").start();
        new Thread(new MyThread(lockB,lockA),"t2").start();
    }
}

class MyThread implements Runnable{

    private String lockA;
    private String lockB;

    public MyThread(String lockA, String lockB) {
        this.lockA = lockA;
        this.lockB = lockB;
    }

    @Override
    public void run() {
        synchronized (lockA){
            System.out.println(Thread.currentThread().getName()+" lock"+lockA+"===>get"+lockB);
            try {
                TimeUnit.SECONDS.sleep(2);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            synchronized (lockB){
                System.out.println(Thread.currentThread().getName()+" lock"+lockB+"===>get"+lockA);
            }
        }
    }
}

```

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/ba218d01fb0436786c25757dab599ff1.png)

jpså®šä½è¿›ç¨‹å·ï¼ŒæŸ¥çœ‹å“ªä¸€ä¸ªè¿›ç¨‹å‡ºäº†é—®é¢˜

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/493beda51c36536d2cf55bb424353cca.png)  
g var2, int var4) {  
int var5;  
do {  
var5 = this.getIntVolatile(var1, var2);  
} while(!this.compareAndSwapInt(var1, var2, var5, var5 + var4));  
return var5;  
}

```

2. è‡ªæˆ‘è®¾è®¡è‡ªæ—‹é”

â€‹```java
public class SpinlockDemo {

    // é»˜è®¤
    // int 0
    //thread null
    AtomicReference<Thread> atomicReference=new AtomicReference<>();

    //åŠ é”
    public void myLock(){
        Thread thread = Thread.currentThread();
        System.out.println(thread.currentThread().getName()+"===> mylock");

        //è‡ªæ—‹é”
        while (!atomicReference.compareAndSet(null,thread)){
            System.out.println(Thread.currentThread().getName()+" ==> è‡ªæ—‹ä¸­~");
        }
    }


    //è§£é”
    public void myUnlock(){
        Thread thread=Thread.currentThread();
        System.out.println(thread.currentThread().getName()+"===> myUnlock");
        atomicReference.compareAndSet(thread,null);
    }

}

```

```java
public class TestSpinLock {
    public static void main(String[] args) throws InterruptedException {
        //ReentrantLock reentrantLock = new ReentrantLock();
        //reentrantLock.lock();
        //reentrantLock.unlock();


        //ä½¿ç”¨CASå®ç°è‡ªæ—‹é”
        SpinlockDemo spinlockDemo=new SpinlockDemo();
        new Thread(()->{
            spinlockDemo.myLock();
            try {
                TimeUnit.SECONDS.sleep(3);
            } catch (Exception e) {
                e.printStackTrace();
            } finally {
                spinlockDemo.myUnlock();
            }
        },"t1").start();

        TimeUnit.SECONDS.sleep(1);


        new Thread(()->{
            spinlockDemo.myLock();
            try {
                TimeUnit.SECONDS.sleep(3);
            } catch (Exception e) {
                e.printStackTrace();
            } finally {
                spinlockDemo.myUnlock();
            }
        },"t2").start();
    }
}

```

**t2è¿›ç¨‹å¿…é¡»ç­‰å¾…t1è¿›ç¨‹Unlockåï¼Œæ‰èƒ½Unlockï¼Œåœ¨è¿™ä¹‹å‰è¿›è¡Œè‡ªæ—‹ç­‰å¾…**

#### 4ï¼‰æ­»é”

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/a888c6e5944c54d7ff77e867e68a6417.png)

```java

public class DeadLock {
    public static void main(String[] args) {
        String lockA= "lockA";
        String lockB= "lockB";

        new Thread(new MyThread(lockA,lockB),"t1").start();
        new Thread(new MyThread(lockB,lockA),"t2").start();
    }
}

class MyThread implements Runnable{

    private String lockA;
    private String lockB;

    public MyThread(String lockA, String lockB) {
        this.lockA = lockA;
        this.lockB = lockB;
    }

    @Override
    public void run() {
        synchronized (lockA){
            System.out.println(Thread.currentThread().getName()+" lock"+lockA+"===>get"+lockB);
            try {
                TimeUnit.SECONDS.sleep(2);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            synchronized (lockB){
                System.out.println(Thread.currentThread().getName()+" lock"+lockB+"===>get"+lockA);
            }
        }
    }
}

```

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/ba218d01fb0436786c25757dab599ff1.png)

jpså®šä½è¿›ç¨‹å·ï¼ŒæŸ¥çœ‹å“ªä¸€ä¸ªè¿›ç¨‹å‡ºäº†é—®é¢˜

![](https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/493beda51c36536d2cf55bb424353cca.png)