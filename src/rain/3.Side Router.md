---
order: 3
author: 
title: "旁路由"
category:
  - 计网
  - 旁路由

---

开始之前，有几个存在的问题。

如果我只想让手机能科学上网，其他设备全都不能科学上网。

或者只想让手机不能科学上网，其他设备全都能科学上网。

这种情况需要你去调整代理工具的分流配置，每个代理工具的设置方式都不太一样，比较繁琐，

并且你每次改动主路由的配置都可能造成全家设备短暂断网，也可能改崩了导致长时间断网，

另外如果你的软路由需要运行很多插件，相互之间可能有冲突导致工作不稳定，这些都是负责连接互联网的主路由应该避免的问题。

这里回顾一下家庭网络吧：使用网线将路由器的WAN口与光猫相连，路由器通过PPPoP拨号获取运营商分配的公网IP，假设为2.2.2.2。除了wan口，路由器还有多个颜色一样的LAN口，为了思路清晰，这里将单独提取出这4个lan口，把它当作一台交换机，并且和路由器这个虚拟的网口建立了连接，路由器连接交换机的这个网口有一个ip地址，假设为192.168.2.1，这个是路由器的内网IP，访问这个ip可以进入路由器的管理界面，同时也是你家里整个局域网的网关ip，你家里所有的网络设备通过网线或者wifi的方式连接到这台交换机，路由器开启了DHCP服务，负责为每一台设备分配ip地址网关等信息，这是大部分家庭的网络拓扑，



#### 1. 旁路由的基本概念
旁路由是一种在不改变原有家庭网络结构的情况下，通过在主路由旁边接入一台负责科学上网的路由设备（通常刷入`OpenWrt`系统），来实现特定设备科学上网的方式。主路由仍然负责原有的网络连接工作，而旁路由则处理科学上网等额外任务。

#### 2. 旁路由的配置步骤
1. **确定局域网网段**：首先查看当前电脑的IP地址，确定局域网网段（如`192.168.2.x`），并记住默认网关（如`192.168.2.1`）。
2. **连接软路由**：将电脑连接到刷好`OpenWrt`的软路由`LAN`口，等待电脑通过`DHCP`获取到软路由分配的IP地址和网关。
3. **配置软路由**：
   - 删除默认的`WAN`口。
   - 编辑`LAN`口，设置静态IP地址（如`192.168.2.2`），网关设置为主路由的IP（如`192.168.2.1`），并设置DNS为主路由的IP。
   - 确保`DHCP`服务开启。
4. **连接主路由**：将旁路由连接到主路由的`LAN`口，确保旁路由能够正常上网。
5. **关闭主路由的`DHCP`服务**：为了避免`DHCP`冲突，关闭主路由的`DHCP`服务，让旁路由负责分配IP地址。
6. **安装科学上网插件**：在旁路由上安装科学上网插件（如`Passwall`），并导入节点配置。

#### 3. 按设备分配网关
通过`dnsmasq`的`DHCP`高级设置，可以为不同设备分配不同的网关和DNS：
- **标签为`direct`的设备**：网关和DNS指向主路由（如`192.168.2.1`），不经过旁路由。
- **标签为`proxy`的设备**：网关和DNS指向旁路由（如`192.168.2.2`），经过旁路由科学上网。

#### 4. 旁路由的常见问题
1. **非对称路由问题**：当数据包的往返路径不一致时，可能会导致某些网站无法访问。可以通过关闭“丢弃无效数据包”选项来解决。
2. **WiFi设备无法访问国内网站**：某些路由器会将WiFi数据交给`iptables`处理，导致数据包无法正常进行`NAT`。可以通过开启`IP动态伪装`（`Masquerade`）来解决。
3. **IPv6问题**：由于`IPv6`不通过`DHCP`下发网关，可能会导致设备直接通过主路由访问互联网，绕过旁路由。建议关闭`IPv6`以避免此类问题。

#### 5. 旁路由的争议
旁路由并非标准的网络拓扑结构，可能会出现各种问题，尤其是在网络结构复杂的情况下。然而，对于大多数家庭用户来说，旁路由配置简单、灵活，能够满足科学上网的需求。因此，旁路由是否适合使用，主要取决于个人的网络需求和结构。

#### 6. 其他类似旁路由的方案
- **安卓手机共享科学上网**：通过开启`IP`转发，安卓手机可以作为旁路由使用。
- **Windows/Linux共享科学上网**：通过配置透明代理，实现类似旁路由的功能。
- **Apple TV/Mac Mini共享**：使用`Surge`等工具的网关模式，实现旁路由的功能。

