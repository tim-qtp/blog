import{_ as e,W as i,X as n,$ as o,a0 as c,Z as r,a2 as a,D as p}from"./framework-28eb7fba.js";const s={},g=a('<figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250116011641002.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_1-家庭网络的基本设置" tabindex="-1"><a class="header-anchor" href="#_1-家庭网络的基本设置" aria-hidden="true">#</a> 1. <strong>家庭网络的基本设置</strong></h3><p>你在运营商拉了一条宽带，运营商会给你分配一个光猫。你通常会单独再买一台路由器，使用网线将路由器的 WAN 口与光猫相连。通常情况下，颜色不一样的接口就是路由器的WAN口。路由器通过 PPPoE 拨号获取运营商分配的公网 IP（假设为 <code>2.2.2.2</code>），或者光猫负责拨号，路由器获取内网 IP（如 <code>192.168.0.2</code>）。</p><p>总之不管怎样，你的路由器WAN口会获取到一个IP。</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250116012735730.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>除了WAN口，路由器还有多个颜色一样的LAN口，为了思路清晰，我这里直接单独提取出这4个LAN口，把它当做一台交换机，并且和路由器这个虚拟的网口<code>LAN</code>建立了连接，路由器连接交换机的这个网口有一个IP地址，假设为<code>192.168.1.1</code>，这个是路由器的内网IP。</p><p>访问这个IP可以进入路由器的<strong>管理页面</strong>，同时也是你家里整个局域网的网关，你家里所有的网络设备，都会通过网线或者WIFI的方式，连接到这台交换机，这是大部分家庭的网络拓扑，装宽带的师傅会帮你配置好，确保你能正常上网。</p><p>路由器的虚拟LAN口连接交换机，交换机连接家中的其他设备（如电脑、手机等）。路由器的内网 IP 通常是 <code>192.168.1.1</code>，这是局域网的网关。</p><hr><h3 id="_2-电脑获取-ip-地址-dhcp-协议" tabindex="-1"><a class="header-anchor" href="#_2-电脑获取-ip-地址-dhcp-协议" aria-hidden="true">#</a> 2. <strong>电脑获取 IP 地址（DHCP 协议）</strong></h3><p>当电脑通过网线或 Wi-Fi 连接到网络时，会通过 DHCP（动态主机配置协议）自动获取 IP 地址。</p><p>电脑的 DHCP 客户端（<strong>操作系统内置了</strong>）会发起一个 DHCP 请求，找DHCP服务器获取IP地址，这个请求会被一层层的封装。</p><p>以TCP/IP四层网络模型为例，每一层都有其特定的任务。</p><ul><li>传输层管端口</li><li>网络层管IP</li><li>网络接口层管MAC</li></ul><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250116130747581.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><mark>数据来到传输层</mark>，传输层会指定这个DHCP请求-通过什么传输协议发往什么端口。DHCP规定客户端默认使用68号UDP端口，服务端默认使用67号UDP端口，使用UDP的方式传输，这些都是规定好的。</p><p><mark>接着数据来到网络层</mark>，网络层需要确定，数据包发给哪个网络设备，也就是负责封装IP地址。电脑现在的目的，是找DHCP服务器要IP地址，但他并不知道现在谁是DHCP服务器，不知道该发给谁，所以干脆一不做二不休，直接发给这个网络里的所有设备，所以目标IP是一个广播IP，<code>255.255.255.255</code>，同时接收方也需要知道是谁发给他的数据，所以还需要加上<strong>源IP</strong>，<strong>但是电脑现在还没有IP</strong>，于是会直接用<code>0.0.0.0</code>这个未指定的IP。</p><p>接着数据会继续向下</p><p><mark>来到网络接口层</mark>，这一层会封装MAC地址，每个网卡都有唯一的MAC地址，也叫物理地址，源MAC是你电脑网卡的MAC地址，这里假设<code>CC:CC:CC:CC:CC:CC</code>，同样由于不知道数据该发给谁，所以目标MAC是一个全F的广播MAC地址，然后这个经过层层封装的数据包，会从电脑的网卡接口发出。</p><p><span style="color:#008000;">顺着网线来到了交换机的1号接口</span>，普通的家用交换机是一个<strong>只能解析网络接口层数据</strong>的设备，也就是说他<strong>只能看懂MAC</strong>地址，里面的IP和端口等信息，对他来说就是一堆无规则的数据，他看不懂也没必要看懂，交换机内部有一个MAC地址映射表，他会根据MAC地址对数据进行转发，至于你转发的什么内容，它并不关心。</p><p><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250120134130135.png" style="zoom:80%;"><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250120134148979.png" style="zoom:80%;"><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250120134236606.png" style="zoom:80%;"></p><p>交换机从LAN1收到数据后，会将LAN1对应的MAC地址保存到映射表中，然后查看目标MAC，发现是全F的广播MAC地址，于是交换机会将电脑的数据，给每一个连接的LAN口（Wifi也算）发送一份。</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250120134409726.png" alt="image-20250120134409726" tabindex="0" loading="lazy"><figcaption>image-20250120134409726</figcaption></figure><p>当这台电脑收到数据包的时候，会根据网络模型一层一层的解封装，首先网络接口层会查看目标MAC地址是不是发给自己的，发现是全F，虽然不是自己的MAC地址DD，但这是一个广播MAC地址，所以会接受它。继续向上来到网络层，查看目标IP是全255，虽然不是自己的IP，但这是一个广播IP，广播就类似学校的广播，当广播里说全体注意的时候，<strong>你肯定要听一下广播里他在讲啥</strong>，所以电脑为了看里面的内容，也会接受这个数据包。</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250120134503318.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><mark>来到传输层</mark>，发现是通过UDP的方式发给67号端口，<strong>由于这台电脑没有运行DHCP服务</strong>，所以并没有监听67号端口，于是会将这个数据包<s>丢弃</s>。</p><p>同样的数据来到路由器，一般的家用路由器会提供很多服务，比如DHCP DNS DDNS Qos UPnP DMZ 端口转发 防火墙等等，<strong>接口层</strong>会接受这个目标MAC全F的广播，同样<strong>网络层</strong>会接受这个目标IP是全255的广播，向上来到传输层，发现目标端口是UDP的67，一般情况下路由器默认就开启了DHCP服务，而DHCP默认的监听端口就是UDP的67，于是这个数据包将会交给DHCP服务，DHCP服务收到数据后，将会从自己的IP地址池中，选择一个未被占用的IP地址。</p><p>假设为<code>192.168.1.3</code>，除了IP地址，还会包含子网掩码 网关 DNS服务器租约等信息。假设租约为12个小时，然后重新封装数据包，源端口是本机的DHCP服务67端口，目标端口是对方发过来的端口也就是68，并且通过UDP传输，网络层封装源IP地址为路由器自己的IP，也就是192.168.1.1，由于对方没有IP，所以目标IP还是全255的广播IP。</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250120135247313.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>来到网络接口层，源MAC是路由器LAN口的MAC地址，路由器从刚才电脑发过来的数据包中，已经知道了电脑的MAC地址，所以目标MAC是电脑的MAC地址，数据来到交换机，刚才说过<span style="color:#008000;">交换机只能解析MAC地址</span>，当他看到目标MAC是CC的时候，会查看自己的MAC地址映射表，发现CC插在接口1上，于是会将这个数据包从接口1发送出去。电脑收到数据后会一层层的解封装。接口层发现目标MAC是自己。</p><p>于是接受该数据。网络层发现目标IP是广播IP，同样也接受了，传输层发现是发往UDP的68号端口，而DHCP客户端监听了该端口，于是数据将会由DHCP应用程序处理，DHCP会拿着这些信息，给电脑进行相关配置，于是我们的电脑就有了IP地址 网关DNS等信息了，并且在6个小时之后，也就是租约的1/2，会再次发起DHCP请求续约IP地址，<strong>续约成功</strong>的话，租期就会再次变成12个小时。</p><p><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250116133729319.png" alt="" loading="lazy"><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250116133842328.png" alt="" loading="lazy"></p><p>如果DHCP服务器没有回应的话。会在时间剩余1/4 1/8的时候，再尝试发送续约请求，如果续约成功，将会再次变成12个小时。如果失败了。说明路由器提供的DHCP<mark>服务挂了</mark>。等到租约到期之后。将会自动释放IP。然后重新发起DHCP获取IP的广播请求。</p><p>但是由于这个局域网内，唯一的DHCP服务器挂了，所以电脑永远也得不到DHCP回应，当尝试多次都没有收到回复之后，DHCP客户端会给电脑，自动分配一个全球统一的网段，IP地址为169.254.X.X，确保和局域网的其他设备还能正常通信，所以当你发现电脑获取到了169.254开头的IP，说明你家里的局域网中，没有提供DHCP服务的设备，建议检查网络。</p><p>除了一台都没有的情况，还有可能配置不当，导致整个局域网中，存在多台DHCP服务器的情况，这也会出现网络问题，这里存在<strong>DHCP攻击</strong>。</p><p>如果电脑关机了，没有再次发送续约请求，租约到期后，路由器的DHCP服务就会释放掉这个IP，重新放回地址池，再分配给其他有需要的人，所以像是<strong>机场或者商场之类的公共场所，WIFI设置的DHCP租期都会比较短，一般十来分钟</strong>，确保你人走后，IP能够尽快的释放出来给别人用，防止地址池被占满，家庭网络的话可以设置的久一点，一般默认是720分钟，也就是12个小时，这就是DHCP的整个执行流程。</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250116135453759.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>实际的DHCP要更复杂。</p><p><mark>所以简单一点流程就是</mark>：广播（目标 IP 为 <code>255.255.255.255</code>，目标 MAC 为 <code>FF:FF:FF:FF:FF:FF</code>）。路由器收到请求后，从 IP 地址池中分配一个 IP（如 <code>192.168.1.3</code>）给电脑，并附带子网掩码、网关和 DNS 信息。DHCP 分配的 IP 有租期（通常为 12 小时），电脑会在租期过半时尝试续约。如果续约失败，IP 会被释放，电脑会重新发起 DHCP 请求。</p><p>除了DHCP分配IP，还可以手动配置IP，但需要提前知道家里的局域网是在哪个网段，比如路由器的地址为<code>192.168.1.1</code>，那你的设备就要在<code>192.168.1.2</code>到<code>192.168.1.254</code>之间，子网掩码默认为255.255.255.0，网关和DNS一般设置为路由器的IP，这样就不需要DHCP分配，保证IP地址固定不变。</p><p>DHCP也可以通过绑定MAC地址实现每次都给电脑分配同样的IP，路由器都有这个功能，叫做DHCP静态IP分配。</p><hr><h3 id="_3-域名解析-dns-协议" tabindex="-1"><a class="header-anchor" href="#_3-域名解析-dns-协议" aria-hidden="true">#</a> 3. <strong>域名解析（DNS 协议）</strong></h3><p>当你在浏览器输入 <code>baidu.com</code> 时，浏览器需要将域名转换为 IP 地址。电脑向路由器的 DNS 服务发送 DNS 请求（目标端口为 UDP 53）。路由器作为 DNS 中继，将请求转发给运营商提供的上游 DNS 服务器。上游 DNS 服务器返回 <code>baidu.com</code> 的 IP 地址（如 <code>220.181.38.148</code>）。路由器将 IP 地址缓存一段时间，局域网内的其他设备再次访问 <code>baidu.com</code> 时，可以直接从缓存中获取 IP。</p><hr><h3 id="_4-地址解析协议-arp-协议" tabindex="-1"><a class="header-anchor" href="#_4-地址解析协议-arp-协议" aria-hidden="true">#</a> 4. <strong>地址解析协议（ARP 协议）</strong></h3><p>ARP协议就是根据IP地址查询Mac地址的协议</p><p>我是<code>192.168.1.3</code></p><p>谁是<code>192.168.1.1</code></p><p>这里贴一个YouTube地址，讲的非常好，</p>',50),P={href:"https://www.youtube.com/watch?v=P38FmPAq09E&t=183s",target:"_blank",rel:"noopener noreferrer"},d=a('<hr><h3 id="_5-访问百度服务器-http-请求" tabindex="-1"><a class="header-anchor" href="#_5-访问百度服务器-http-请求" aria-hidden="true">#</a> 5. <strong>访问百度服务器（HTTP 请求）</strong></h3><p>拿到百度服务器的 IP 地址后，浏览器向这个IP发起一条 HTTP 请求（目标端口为 TCP 80）。电脑发现目标 IP 不在同一网段（通过子网掩码判断），于是将数据包发送给默认网关（路由器）。路由器通过 NAT（<code>Network Address Translation</code>网络地址转换）将内网 IP（<code>192.168.1.3</code>）转换为路由器WAN口公网 IP（<code>2.2.2.2</code>），并随机选择一个空闲端口，替换掉源端口，假设将<code>9526-&gt;4134</code>，然后将修改前后的对应关系保存到路由器的NAT映射表中，并记录端口映射，此时数据就可以在公网上路由了。</p><p><mark>转换</mark>叫做NAT（Network Address Translation 网络地址转换）。</p><p>接着封装MAC地址，源MAC是路由器WAN的MAC地址，目标MAC是吓一跳某个路由设备的MAC，然后数据从WAN口发送到了互联网，经过十几个路由设备转发，最终到达百度服务器。百度服务器处理请求后，将网页数据返回给路由器，路由器通过 NAT 将数据转发给电脑。</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/image-20250120160304407.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><h3 id="_6-关键技术与协议" tabindex="-1"><a class="header-anchor" href="#_6-关键技术与协议" aria-hidden="true">#</a> 6. <strong>关键技术与协议</strong></h3><ul><li><strong>DHCP</strong>：动态分配 IP 地址，简化网络配置。</li><li><strong>DNS</strong>：将域名转换为 IP 地址，方便用户访问网站。</li><li><strong>NAT</strong>：将内网 IP 转换为公网 IP，实现多设备共享公网 IP。</li><li><strong>ARP</strong>：通过广播获取目标设备的 MAC 地址。</li></ul>',9);function l(h,C){const t=p("ExternalLinkIcon");return i(),n("div",null,[g,o("p",null,[o("a",P,[c("https://www.youtube.com/watch?v=P38FmPAq09E&t=183s"),r(t)])]),d])}const I=e(s,[["render",l],["__file","5.Soft Router Prerequisite Home Network Communication.html.vue"]]);export{I as default};
