<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.61" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://tim-qtp.github.io/blog/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html"><meta property="og:site_name" content="Qtp"><meta property="og:title" content="图片协同编辑"><meta property="og:description" content="一、解决协作冲突 1、解决方案 假设这样一种场景：秦一和李蛋同时快速点击了十次旋转，最终的结果会是怎样的呢？ 如果所有事件都是按顺序处理的，那结果就很清晰了，但事实上，为了提高性能和响应速度，事件通常是 并发 的，而不是严格的顺序执行。这种并发操作会引发 协作冲突，导致其他用户看到的旋转效果是乱序的。 那么怎么解决协作冲突的问题呢？ 其实可以通过业务设..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-03-22T13:49:25.000Z"><meta property="article:author" content="tim-qtp"><meta property="article:modified_time" content="2025-03-22T13:49:25.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"图片协同编辑","image":[""],"dateModified":"2025-03-22T13:49:25.000Z","author":[{"@type":"Person","name":"tim-qtp","url":"https://github.com/tim-qtp/"}]}</script><link rel="icon" href="/blog/favicon.ico"><link rel="icon" href="/blog/assets/icon/chrome-mask-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/blog/assets/icon/chrome-mask-192.png" type="image/png" sizes="192x192"><link rel="icon" href="/blog/assets/icon/chrome-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/blog/assets/icon/chrome-192.png" type="image/png" sizes="192x192"><link rel="manifest" href="/blog/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><link rel="apple-touch-icon" href="/blog/assets/icon/apple-icon-152.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/blog/assets/icon/ms-icon-144.png"><meta name="msapplication-TileColor" content="#ffffff"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"><title>图片协同编辑 | Qtp</title><meta name="description" content="一、解决协作冲突 1、解决方案 假设这样一种场景：秦一和李蛋同时快速点击了十次旋转，最终的结果会是怎样的呢？ 如果所有事件都是按顺序处理的，那结果就很清晰了，但事实上，为了提高性能和响应速度，事件通常是 并发 的，而不是严格的顺序执行。这种并发操作会引发 协作冲突，导致其他用户看到的旋转效果是乱序的。 那么怎么解决协作冲突的问题呢？ 其实可以通过业务设...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/blog/assets/style-dcdd17d8.css" as="style"><link rel="stylesheet" href="/blog/assets/style-dcdd17d8.css">
    <link rel="modulepreload" href="/blog/assets/app-ea5774d5.js"><link rel="modulepreload" href="/blog/assets/framework-6a3aa88c.js"><link rel="modulepreload" href="/blog/assets/11.Collaborative photo editing.html-15b42c15.js"><link rel="modulepreload" href="/blog/assets/11.Collaborative photo editing.html-8e30d126.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button type="button" class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/blog/" class="brand"><img class="logo" src="/blog/logo.svg" alt="Qtp"><!----><span class="site-name hide-in-pad">Qtp</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/blog/" class="nav-link" aria-label="主页"><span class="font-icon icon iconfont icon-home" style=""></span>主页<!----></a></div><div class="nav-item hide-in-mobile"><a href="/blog/intro/" class="nav-link" aria-label="笔记"><span class="font-icon icon iconfont icon-discover" style=""></span>笔记<!----></a></div><div class="nav-item hide-in-mobile"><a href="/blog/life/" class="nav-link" aria-label="生活"><span class="font-icon icon iconfont icon-life" style=""></span>生活<!----></a></div><div class="nav-item hide-in-mobile"><a href="/blog/about/" class="nav-link" aria-label="关于我"><span class="font-icon icon iconfont icon-about" style=""></span>关于我<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/tim-qtp/blog" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="placeholder">搜索</div><div class="key-hints"><kbd class="key">Ctrl</kbd><kbd class="key">K</kbd></div></button><!--]--><!--[--><!----><!--]--><button type="button" class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-computer" style=""></span><span class="title">一、计算机基础</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-vscode" style=""></span><span class="title">二、前端</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-java" style=""></span><span class="title">三、Java</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-rust" style=""></span><span class="title">四、Rust</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-framework" style=""></span><span class="title">五、框架</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-microservices" style=""></span><span class="title">六、微服务中间件</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-interview" style=""></span><span class="title">七、面试</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active" type="button"><span class="font-icon icon iconfont icon-essay" style=""></span><span class="title">八、项目随笔</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-experience" style=""></span><span class="title">技术细节</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active" type="button"><span class="font-icon icon iconfont icon-project3" style=""></span><span class="title">实战项目</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-shortlink" style=""></span><span class="title">短链接</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active" type="button"><span class="font-icon icon iconfont icon-imageLibrary" style=""></span><span class="title">智能图库</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/blog/projectessay/practicalProjects/imageLibrary/1.Image%20upload.html" class="nav-link sidebar-link sidebar-page" aria-label="图片上传"><!---->图片上传<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/imageLibrary/2.Audit%20logic.html" class="nav-link sidebar-link sidebar-page" aria-label="审核逻辑"><!---->审核逻辑<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/imageLibrary/3.Capture%20Packet%20Batch%20Creation.html" class="nav-link sidebar-link sidebar-page" aria-label="抓包批量创建"><!---->抓包批量创建<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/imageLibrary/4.Space%20Module.html" class="nav-link sidebar-link sidebar-page" aria-label="空间模块"><!---->空间模块<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/imageLibrary/5.Similar%20Color%20Search.html" class="nav-link sidebar-link sidebar-page" aria-label="相似颜色搜索"><!---->相似颜色搜索<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/imageLibrary/6.Photo%20Sharing.html" class="nav-link sidebar-link sidebar-page" aria-label="图片分享"><!---->图片分享<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/imageLibrary/7.Batch%20management%20of%20pictures.html" class="nav-link sidebar-link sidebar-page" aria-label="图片批量管理"><!---->图片批量管理<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/imageLibrary/8.AI%20Image%20Enlargement.html" class="nav-link sidebar-link sidebar-page" aria-label="AI扩图+裁剪编辑"><!---->AI扩图+裁剪编辑<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/imageLibrary/9.Gallery%20Analysis.html" class="nav-link sidebar-link sidebar-page" aria-label="图库分析"><!---->图库分析<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html" class="nav-link sidebar-link sidebar-page" aria-label="团队空间"><!---->团队空间<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="图片协同编辑"><!---->图片协同编辑<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label><!----><!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#一、解决协作冲突" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="一、解决协作冲突"><!---->一、解决协作冲突<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_1、解决方案" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1、解决方案"><!---->1、解决方案<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_2、扩展知识-ot-算法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2、扩展知识 - OT 算法"><!---->2、扩展知识 - OT 算法<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#二、提高协作实时性" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="二、提高协作实时性"><!---->二、提高协作实时性<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_1、什么是-websocket" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1、什么是 WebSocket？"><!---->1、什么是 WebSocket？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_2、websocket-的应用场景" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2、WebSocket 的应用场景"><!---->2、WebSocket 的应用场景<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_3、websocket-和-http-的关系" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3、WebSocket 和 HTTP 的关系"><!---->3、WebSocket 和 HTTP 的关系<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_4、websocket-协作编辑的流程" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4、WebSocket 协作编辑的流程"><!---->4、WebSocket 协作编辑的流程<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_5、websocket-的实现方式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5、WebSocket 的实现方式"><!---->5、WebSocket 的实现方式<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#三、后端开发" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="三、后端开发"><!---->三、后端开发<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_1、引入-websocket-依赖" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1、引入 WebSocket 依赖"><!---->1、引入 WebSocket 依赖<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_2、定义数据模型" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2、定义数据模型"><!---->2、定义数据模型<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_3、websocket-拦截器-权限校验" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3、WebSocket 拦截器 - 权限校验"><!---->3、WebSocket 拦截器 - 权限校验<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_4、websocket-处理器" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4、WebSocket 处理器"><!---->4、WebSocket 处理器<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_5、websocket-配置" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5、WebSocket 配置"><!---->5、WebSocket 配置<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#四、扩展知识-disruptor-优化" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="四、扩展知识 - Disruptor 优化"><!---->四、扩展知识 - Disruptor 优化<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_1、现存的系统问题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1、现存的系统问题"><!---->1、现存的系统问题<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_2、disruptor-介绍" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2、Disruptor 介绍"><!---->2、Disruptor 介绍<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_3、disruptor-核心概念与工作流程" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3、Disruptor 核心概念与工作流程"><!---->3、Disruptor 核心概念与工作流程<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_4、disruptor-实战" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4、Disruptor 实战"><!---->4、Disruptor 实战<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#扩展" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="扩展"><!---->扩展<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-logistics" style=""></span><span class="title">神领物流</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-oj" style=""></span><span class="title">刷题OJ平台</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-onlineEducation" style=""></span><span class="title">学成在线</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-flashSale" style=""></span><span class="title">秒杀系统</span><span class="arrow end"></span></button><!----></section></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-bug" style=""></span><span class="title">bug修复</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-rocket" style=""></span><span class="title">经验教训</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-scaffold" style=""></span><span class="title">脚手架</span><span class="arrow end"></span></button><!----></section></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-github" style=""></span><span class="title">九、开源推荐</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-xiayu" style=""></span><span class="title">十、技术琐碎</span><span class="arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->图片协同编辑</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://github.com/tim-qtp/" target="_blank" rel="noopener noreferrer">tim-qtp</a></span><span property="author" content="tim-qtp"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2025-03-22T13:49:25.000Z"></span><span class="page-pageview-info" aria-label="访问量🔢" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon eye-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="eye icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z"></path></svg><span class="waline-pageview-count" id="ArtalkPV" data-path="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html">...</span></span><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 24 分钟</span><meta property="timeRequired" content="PT24M"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><span class="page-category-item category7" role>云图库</span><span class="page-category-item category2" role>项目</span><meta property="articleSection" content="云图库,项目"></span><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#" class="router-link-active router-link-exact-active toc-link level2"></a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#一、解决协作冲突" class="router-link-active router-link-exact-active toc-link level2">一、解决协作冲突</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_1、解决方案" class="router-link-active router-link-exact-active toc-link level3">1、解决方案</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_2、扩展知识-ot-算法" class="router-link-active router-link-exact-active toc-link level3">2、扩展知识 - OT 算法</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#二、提高协作实时性" class="router-link-active router-link-exact-active toc-link level2">二、提高协作实时性</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_1、什么是-websocket" class="router-link-active router-link-exact-active toc-link level3">1、什么是 WebSocket？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_2、websocket-的应用场景" class="router-link-active router-link-exact-active toc-link level3">2、WebSocket 的应用场景</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_3、websocket-和-http-的关系" class="router-link-active router-link-exact-active toc-link level3">3、WebSocket 和 HTTP 的关系</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_4、websocket-协作编辑的流程" class="router-link-active router-link-exact-active toc-link level3">4、WebSocket 协作编辑的流程</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_5、websocket-的实现方式" class="router-link-active router-link-exact-active toc-link level3">5、WebSocket 的实现方式</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#三、后端开发" class="router-link-active router-link-exact-active toc-link level2">三、后端开发</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_1、引入-websocket-依赖" class="router-link-active router-link-exact-active toc-link level3">1、引入 WebSocket 依赖</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_2、定义数据模型" class="router-link-active router-link-exact-active toc-link level3">2、定义数据模型</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_3、websocket-拦截器-权限校验" class="router-link-active router-link-exact-active toc-link level3">3、WebSocket 拦截器 - 权限校验</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_4、websocket-处理器" class="router-link-active router-link-exact-active toc-link level3">4、WebSocket 处理器</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_5、websocket-配置" class="router-link-active router-link-exact-active toc-link level3">5、WebSocket 配置</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#四、扩展知识-disruptor-优化" class="router-link-active router-link-exact-active toc-link level2">四、扩展知识 - Disruptor 优化</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_1、现存的系统问题" class="router-link-active router-link-exact-active toc-link level3">1、现存的系统问题</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_2、disruptor-介绍" class="router-link-active router-link-exact-active toc-link level3">2、Disruptor 介绍</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_3、disruptor-核心概念与工作流程" class="router-link-active router-link-exact-active toc-link level3">3、Disruptor 核心概念与工作流程</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#_4、disruptor-实战" class="router-link-active router-link-exact-active toc-link level3">4、Disruptor 实战</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html#扩展" class="router-link-active router-link-exact-active toc-link level3">扩展</a></li><!----><!--]--></ul></li><!--]--></ul></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h2 id="" tabindex="-1"><a class="header-anchor" href="#" aria-hidden="true">#</a> <img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221637775.png" alt="" loading="lazy"></h2><h2 id="一、解决协作冲突" tabindex="-1"><a class="header-anchor" href="#一、解决协作冲突" aria-hidden="true">#</a> 一、解决协作冲突</h2><h3 id="_1、解决方案" tabindex="-1"><a class="header-anchor" href="#_1、解决方案" aria-hidden="true">#</a> 1、解决方案</h3><p>假设这样一种场景：秦一和李蛋同时快速点击了十次旋转，最终的结果会是怎样的呢？</p><p>如果所有事件都是按顺序处理的，那结果就很清晰了，但事实上，为了提高性能和响应速度，事件通常是 <strong>并发</strong> 的，而不是严格的顺序执行。这种并发操作会引发 <strong>协作冲突</strong>，导致其他用户看到的旋转效果是乱序的。</p><p>那么怎么解决协作冲突的问题呢？</p><p>其实可以通过业务设计来减少开发成本，比如约定 <strong>同一时刻只允许一位用户进入编辑图片的状态</strong>，此时其他用户只能实时浏览到修改效果，但不能参与编辑；进入编辑状态的用户可以退出编辑，其他用户才可以进入编辑状态。类似于给图片编辑这个动作加了一把锁，直接从源头上解决了编辑冲突的问题。</p><p>此时，协作编辑的交互流程又要增加 2 个动作 —— 进入编辑状态和退出编辑状态：</p><p>但这种方案的缺点也很明显，减少了实时协作的便利性，对于协作设计、协作编码、协作文档的场景，同一时间只能有一个用户编辑，提高的效率有限。所以这里再分享另外一种实时协同算法作为扩展知识。</p><h3 id="_2、扩展知识-ot-算法" tabindex="-1"><a class="header-anchor" href="#_2、扩展知识-ot-算法" aria-hidden="true">#</a> 2、扩展知识 - OT 算法</h3><p>实时协同 OT 算法（Operational Transformation）是一种支持分布式系统中多个用户实时协作编辑的核心算法，广泛应用于在线文档协作等场景。OT 算法的主要功能是解决并发编辑冲突，<strong>确保编辑结果在所有用户终端一致</strong>。</p><p>OT 算法其实很好理解，先看下 3 个核心概念：</p><ul><li>操作 (Operation)：表示用户对协作内容的修改，比如插入字符、删除字符等。</li><li>转化 (Transformation)：当多个用户同时编辑内容时，OT 会根据操作的上下文将它们转化，使得这些操作可以按照不同的顺序应用而结果保持一致。</li><li>因果一致性：OT 算法确保操作按照用户看到的顺序被正确执行，即每个用户的操作基于最新的内容状态。</li></ul><p>其中，最重要的就是 <strong>转化</strong> 步骤了，相当于有一个负责人统一收集大家的操作，然后按照设定的规则和信息进行排序与合并，最终给大家一个统一的结果。</p><p>举一个简单的例子，假设初始内容是 <code>&quot;abc&quot;</code>，用户 A 和 B 同时进行编辑：</p><ul><li>用户 A 在位置 <code>1</code> 插入 <code>&quot;x&quot;</code></li><li>用户 B 在位置 <code>2</code> 删除 <code>&quot;b&quot;</code></li></ul><p>如果不使用 OT 算法，结果是：</p><ol><li>用户 A 操作后，内容变为 <code>&quot;axbc&quot;</code></li><li>用户 B 操作后，内容变为 <code>&quot;ac&quot;</code></li></ol><p>如果直接应用 B 的操作到 A 的结果，得到的是 <code>&quot;ac&quot;</code>，对于 A 来说，相当于删除了 <code>&quot;b&quot;</code>，A 会感到一脸懵逼。sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=</p><p>如果使用 OT 算法，结果是：</p><ol><li>用户 A 的操作，应用后内容为 <code>&quot;axbc&quot;</code></li><li>用户 B 的操作经过 OT 转化为删除 <code>&quot;b&quot;</code> 在 <code>&quot;axbc&quot;</code> 中的新位置</li></ol><p>最终用户 A 和 B 的内容都一致为 <code>&quot;axc&quot;</code>，符合预期。OT 算法确保无论用户编辑的顺序如何，最终内容是一致的。</p><p>当然，具体的 OT 算法还是要根据需求来设计了，协作密度越高，算法设计难度越大。</p><p>此外，还有一种与 OT 类似的协同算法 CRDT（Conflict-free Replicated Data Type），其通过数学模型实现无需中心化转化的冲突解决，在离线协作场景中更具优势。</p><h2 id="二、提高协作实时性" tabindex="-1"><a class="header-anchor" href="#二、提高协作实时性" aria-hidden="true">#</a> 二、提高协作实时性</h2><p>在实时通讯的业务场景中，常用的技术方案包括长轮询、SSE 和 WebSocket。由于我们的业务需求需要实现频繁且高效的双向通信，因此我们选用 WebSocket 来实现即时通讯。</p><h3 id="_1、什么是-websocket" tabindex="-1"><a class="header-anchor" href="#_1、什么是-websocket" aria-hidden="true">#</a> 1、什么是 WebSocket？</h3><p>WebSocket 是一种 <strong>全双工通信协议</strong>，让客户端（比如浏览器）和服务器之间能够保持实时、持续的连接。和传统的 HTTP 请求-响应模式不同，WebSocket 是一条**“常开的隧道”**，连接的双方可以随时发送和接收数据，而不需要不断建立和关闭连接。4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=</p><p>打个比方：</p><ul><li>HTTP 就像点外卖： 每次下单（请求）- 到货（响应）都是一次独立的操作，完成后连接关闭。</li><li>WebSocket 像是打电话：你打通了电话（建立连接），可以随时聊天（双向通信），直到挂断（关闭连接）。</li></ul><h3 id="_2、websocket-的应用场景" tabindex="-1"><a class="header-anchor" href="#_2、websocket-的应用场景" aria-hidden="true">#</a> 2、WebSocket 的应用场景</h3><p>WebSocket 的主要作用是 <strong>实现实时数据传输</strong>，适用于需要频繁交互或者实时更新数据的场景。比如：</p><ul><li>即时通讯（聊天软件、实时协作工具）</li><li>实时数据更新（股票行情、体育比赛比分）</li><li>在线游戏（多人实时互动）</li><li>物联网（设备状态实时传输）</li><li>协同编辑（像语雀这样的多人协作编辑）</li></ul><p>通过 WebSocket，客户端与服务器之间能够显著减少消息传输的延迟，提高通信效率，同时降低数据传输的开销。</p><h3 id="_3、websocket-和-http-的关系" tabindex="-1"><a class="header-anchor" href="#_3、websocket-和-http-的关系" aria-hidden="true">#</a> 3、WebSocket 和 HTTP 的关系</h3><p>WebSocket 和 HTTP 是两种不同的通信协议，但它们是紧密相关的，都是基于 TCP 协议、都可以在同样的端口上工作（比如 80 和 443）。eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=</p><p>**首先要明确，WebSocket 是建立在 HTTP 基础之上的！**WebSocket 的连接需要通过 HTTP 协议发起一个握手（称为 HTTP Upgrade 请求），这个握手请求是 WebSocket 建立连接的前提，表明希望切换协议；服务器如果支持 WebSocket，会返回一个 HTTP 101 状态码，表示协议切换成功。</p><p>握手完成后，HTTP 协议的作用结束，通信会切换为 WebSocket 协议，双方可以开始全双工通信。</p><p>二者的区别如下，大家了解一下就好：</p><table><thead><tr><th>对比项</th><th>HTTP</th><th>WebSocket</th></tr></thead><tbody><tr><td>通信模式</td><td>请求-响应（单向）</td><td>全双工通信（双向）</td></tr><tr><td>连接状态</td><td>每次请求创建新的连接</td><td>握手后保持持续连接</td></tr><tr><td>数据传输效率</td><td>每次通信都需要带完整头部，开销大</td><td>数据帧小，传输高效</td></tr><tr><td>适用场景</td><td>静态网页加载、API 调用等非实时场景</td><td>实时交互场景，如聊天、游戏、直播等</td></tr></tbody></table><h3 id="_4、websocket-协作编辑的流程" tabindex="-1"><a class="header-anchor" href="#_4、websocket-协作编辑的流程" aria-hidden="true">#</a> 4、WebSocket 协作编辑的流程</h3><p>通过 WebSocket 实时通信的能力，可以将用户的编辑操作发给 WebSocket 服务器，再由服务器转发给其他连接服务器的用户前端，前端就可以根据操作处理图片。</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221700360.png" alt="image-20250322170012287" tabindex="0" loading="lazy"><figcaption>image-20250322170012287</figcaption></figure><p>具体的业务流程：</p><ol><li>建立连接之前，先进行用户权限校验；校验通过后，将登录用户信息、要编辑的图片信息保存到要建立的 WebSocket 连接的会话属性中。</li><li>建立连接成功后，将 WebSocket 会话保存到该图片对应的会话集合中，便于后续分发消息给其他会话。</li><li>前端将消息发送到后端，后端根据消息类型分发到对应的处理器。</li><li>处理器处理消息，将处理结果作为消息发送给需要的 WebSocket 客户端。</li><li>当前端断开连接时，删除会话集合中的 WebSocket 会话，释放资源</li></ol><p>和 HTTP 请求一样，前端和 WebSocket 服务器之间传输信息时，也可以通过 JSON 格式对数据进行序列化。</p><h3 id="_5、websocket-的实现方式" tabindex="-1"><a class="header-anchor" href="#_5、websocket-的实现方式" aria-hidden="true">#</a> 5、WebSocket 的实现方式</h3><p>对于 Java Spring 项目，主要有原生 WebSocket（基于<code>WebSocketHandler</code> 实现）、STOMP、WebFlux 这 3 种实现方式。</p><p>它们之间的对比如下：</p><table><thead><tr><th>实现方式</th><th>特点</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td>原生 WebSocket</td><td>低层 API，手动管理连接与消息</td><td>轻量、灵活、适用于简单点对点通信</td><td>需要手动管理会话和分发，不支持 STOMP</td><td>简单的实时推送，低并发场景</td></tr><tr><td>WebSocket + STOMP + SockJS</td><td>基于 STOMP，支持发布/订阅模式</td><td>支持 STOMP、消息代理、适配</td><td>依赖外部代理，配置较复杂</td><td>聊天室、多人协作，高级实时应用</td></tr><tr><td>WebFlux + Reactive WebSocket</td><td>基于 WebFlux 的响应式实现</td><td>高并发、非阻塞、适用于大流量场</td><td>学习曲线高，不支持 STOMP</td><td>高并发场景、大数据流推送</td></tr></tbody></table><p>网上的建议是：对于大多数简单实时推送，选用原生 WebSocket；对于复杂的聊天室和协同系统，选用 WebSocket + STOMP + SockJS；对于高并发、低延迟数据流推送，选用 WebFlux + Reactive WebSocket。</p><p>对于这个歌项目，并发要求不高，选择 Spring 原生的 WebSocket 来降低开发成本。</p><p>明确方案后，进入后端开发。</p><h2 id="三、后端开发" tabindex="-1"><a class="header-anchor" href="#三、后端开发" aria-hidden="true">#</a> 三、后端开发</h2><h3 id="_1、引入-websocket-依赖" tabindex="-1"><a class="header-anchor" href="#_1、引入-websocket-依赖" aria-hidden="true">#</a> 1、引入 WebSocket 依赖</h3><p>引入依赖：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- websocket --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-websocket<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>新建 <code>manager.websocket</code> 包，所有和 WebSocket 相关的代码都放到该包下。</p><h3 id="_2、定义数据模型" tabindex="-1"><a class="header-anchor" href="#_2、定义数据模型" aria-hidden="true">#</a> 2、定义数据模型</h3><p>新建 <code>websocket.model</code> 包，存放数据模型，包括请求类、响应类、枚举类。</p><p>1）定义图片编辑请求消息，也就是前端要发送给后端的参数：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PictureEditRequestMessage</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 消息类型，例如 &quot;ENTER_EDIT&quot;, &quot;EXIT_EDIT&quot;, &quot;EDIT_ACTION&quot;
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 执行的编辑动作（左旋、右旋）
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> editAction<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）定义图片编辑响应消息，也就是后端要发送给前端的信息：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PictureEditResponseMessage</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 消息类型，例如 &quot;INFO&quot;, &quot;ERROR&quot;, &quot;ENTER_EDIT&quot;, &quot;EXIT_EDIT&quot;, &quot;EDIT_ACTION&quot;
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 信息
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 执行的编辑动作
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> editAction<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 用户信息
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">UserVO</span> user<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3）定义图片编辑<mark>消息类型</mark>枚举，便于后续根据消息类型进行相应的处理：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Getter</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">PictureEditMessageTypeEnum</span> <span class="token punctuation">{</span>

    <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">&quot;发送通知&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;INFO&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">&quot;发送错误&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ERROR&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">ENTER_EDIT</span><span class="token punctuation">(</span><span class="token string">&quot;进入编辑状态&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ENTER_EDIT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">EXIT_EDIT</span><span class="token punctuation">(</span><span class="token string">&quot;退出编辑状态&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;EXIT_EDIT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">EDIT_ACTION</span><span class="token punctuation">(</span><span class="token string">&quot;执行编辑操作&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;EDIT_ACTION&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> text<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> value<span class="token punctuation">;</span>

    <span class="token class-name">PictureEditMessageTypeEnum</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>text <span class="token operator">=</span> text<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 根据 value 获取枚举
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">PictureEditMessageTypeEnum</span> <span class="token function">getEnumByValue</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> value<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">PictureEditMessageTypeEnum</span> typeEnum <span class="token operator">:</span> <span class="token class-name">PictureEditMessageTypeEnum</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>typeEnum<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> typeEnum<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4）定义图片编辑<mark>操作类型</mark>枚举：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Getter</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">PictureEditActionEnum</span> <span class="token punctuation">{</span>

    <span class="token function">ZOOM_IN</span><span class="token punctuation">(</span><span class="token string">&quot;放大操作&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ZOOM_IN&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">ZOOM_OUT</span><span class="token punctuation">(</span><span class="token string">&quot;缩小操作&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ZOOM_OUT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">ROTATE_LEFT</span><span class="token punctuation">(</span><span class="token string">&quot;左旋操作&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ROTATE_LEFT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">ROTATE_RIGHT</span><span class="token punctuation">(</span><span class="token string">&quot;右旋操作&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ROTATE_RIGHT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> text<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> value<span class="token punctuation">;</span>

    <span class="token class-name">PictureEditActionEnum</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>text <span class="token operator">=</span> text<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 根据 value 获取枚举
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">PictureEditActionEnum</span> <span class="token function">getEnumByValue</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> value<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">PictureEditActionEnum</span> actionEnum <span class="token operator">:</span> <span class="token class-name">PictureEditActionEnum</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>actionEnum<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> actionEnum<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3、websocket-拦截器-权限校验" tabindex="-1"><a class="header-anchor" href="#_3、websocket-拦截器-权限校验" aria-hidden="true">#</a> 3、WebSocket 拦截器 - 权限校验</h3><p>在 WebSocket 连接前需要进行权限校验，如果发现用户没有团队空间内编辑图片的权限，则拒绝握手，可以通过定义一个 WebSocket <mark>拦截器</mark>实现这个能力。</p><p>此外，由于 HTTP 和 WebSocket 的区别，我们不能在后续收到前端消息时直接从 request 对象中获取到登录用户信息，因此也需要通过 WebSocket 拦截器，为即将建立连接的 WebSocket 会话指定一些属性，比如登录用户信息、编辑的图片 id 等。</p><p>编写拦截器的代码，需要实现 <code>HandshakeInterceptor</code> 接口：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WsHandshakeInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandshakeInterceptor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">PictureService</span> pictureService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">SpaceService</span> spaceService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">SpaceUserAuthManager</span> spaceUserAuthManager<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">beforeHandshake</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NotNull</span> <span class="token class-name">ServerHttpRequest</span> request<span class="token punctuation">,</span> <span class="token annotation punctuation">@NotNull</span> <span class="token class-name">ServerHttpResponse</span> response<span class="token punctuation">,</span> <span class="token annotation punctuation">@NotNull</span> <span class="token class-name">WebSocketHandler</span> wsHandler<span class="token punctuation">,</span> <span class="token annotation punctuation">@NotNull</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>request <span class="token keyword">instanceof</span> <span class="token class-name">ServletServerHttpRequest</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">HttpServletRequest</span> servletRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ServletServerHttpRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServletRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取请求参数</span>
            <span class="token class-name">String</span> pictureId <span class="token operator">=</span> servletRequest<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;pictureId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>pictureId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;缺少图片参数，拒绝握手&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">User</span> loginUser <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;用户未登录，拒绝握手&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 校验用户是否有该图片的权限</span>
            <span class="token class-name">Picture</span> picture <span class="token operator">=</span> pictureService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>pictureId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>picture <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;图片不存在，拒绝握手&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Long</span> spaceId <span class="token operator">=</span> picture<span class="token punctuation">.</span><span class="token function">getSpaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Space</span> space <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>spaceId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                space <span class="token operator">=</span> spaceService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>spaceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>space <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;空间不存在，拒绝握手&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>space<span class="token punctuation">.</span><span class="token function">getSpaceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">SpaceTypeEnum</span><span class="token punctuation">.</span><span class="token constant">TEAM</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;不是团队空间，拒绝握手&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> permissionList <span class="token operator">=</span> spaceUserAuthManager<span class="token punctuation">.</span><span class="token function">getPermissionList</span><span class="token punctuation">(</span>space<span class="token punctuation">,</span> loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>permissionList<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">SpaceUserPermissionConstant</span><span class="token punctuation">.</span><span class="token constant">PICTURE_EDIT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;没有图片编辑权限，拒绝握手&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 设置 attributes</span>
            attributes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
            attributes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">,</span> loginUser<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            attributes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;pictureId&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>pictureId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记得转换为 Long 类型</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterHandshake</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NotNull</span> <span class="token class-name">ServerHttpRequest</span> request<span class="token punctuation">,</span> <span class="token annotation punctuation">@NotNull</span> <span class="token class-name">ServerHttpResponse</span> response<span class="token punctuation">,</span> <span class="token annotation punctuation">@NotNull</span> <span class="token class-name">WebSocketHandler</span> wsHandler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4、websocket-处理器" tabindex="-1"><a class="header-anchor" href="#_4、websocket-处理器" aria-hidden="true">#</a> 4、WebSocket 处理器</h3><p>我们需要定义 WebSocket 处理器类，在连接成功、连接关闭、接收到客户端消息时进行相应的处理。</p><p>可以实现 TextWebSocketHandler 接口，这样就能以字符串的方式发送和接受消息了：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PictureEditHandler</span> <span class="token keyword">extends</span> <span class="token class-name">TextWebSocketHandler</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1）首先在处理器类中定义 2 个常量，分别为：</p><ul><li>保存当前正在编辑的用户 id，执行编辑操作、进入或退出编辑时都会校验。</li><li>保存参与编辑图片的用户 WebSocket 会话的集合。</li></ul><p>由于每个图片的协作编辑都是相互独立的，所以需要用 Map 来区分每个图片 id 对应的数据。代码如下：De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 每张图片的编辑状态，key: pictureId, value: 当前正在编辑的用户 ID</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> pictureEditingUsers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 保存所有连接的会话，key: pictureId, value: 用户会话集合</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">WebSocketSession</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> pictureSessions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意，由于可能同时有多个 WebSocket 客户端建立连接和发送消息，集合要使用并发包（JUC）中的 <code>ConcurrentHashMap</code>，来保证线程安全。</p><p>2）由于接下来很多消息都需要传递给所有协作者，所以先编写一个 <strong>广播消息</strong> 的方法。该方法会根据 pictureId，将响应消息发送给编辑该图片的所有会话。考虑到可能会有消息不需要发送给编辑者本人的情况，该方法还可以接受 excludeSession 参数，支持排除掉向某个会话发送消息。4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=</p><p>代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">broadcastToPicture</span><span class="token punctuation">(</span><span class="token class-name">Long</span> pictureId<span class="token punctuation">,</span> <span class="token class-name">PictureEditResponseMessage</span> pictureEditResponseMessage<span class="token punctuation">,</span> <span class="token class-name">WebSocketSession</span> excludeSession<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WebSocketSession</span><span class="token punctuation">&gt;</span></span> sessionSet <span class="token operator">=</span> pictureSessions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pictureId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>sessionSet<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建 ObjectMapper</span>
        <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置序列化：将 Long 类型转为 String，解决丢失精度问题</span>
        <span class="token class-name">SimpleModule</span> <span class="token keyword">module</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function">addSerializer</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ToStringSerializer</span><span class="token punctuation">.</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function">addSerializer</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">,</span> <span class="token class-name">ToStringSerializer</span><span class="token punctuation">.</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 支持 long 基本类型</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">registerModule</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 序列化为 JSON 字符串</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>pictureEditResponseMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TextMessage</span> textMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">WebSocketSession</span> session <span class="token operator">:</span> sessionSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 排除掉的 session 不发送</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>excludeSession <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> excludeSession<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                session<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>textMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述代码中有个小细节，由于前端 JS 的长整数可能会丢失精度，所以使用 Jackson 自定义序列化器，在将对象转换为 JSON 字符串时，将 Long 类型转换为 String 类型。58IUDBvyDy7G+gVMqAunJfAo72ZBX//2DD/nhaX54Xg=</p><p>再编写一个不排除 Session，给所有会话广播的方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 全部广播</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">broadcastToPicture</span><span class="token punctuation">(</span><span class="token class-name">Long</span> pictureId<span class="token punctuation">,</span> <span class="token class-name">PictureEditResponseMessage</span> pictureEditResponseMessage<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token function">broadcastToPicture</span><span class="token punctuation">(</span>pictureId<span class="token punctuation">,</span> pictureEditResponseMessage<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3）实现连接建立成功后执行的方法，保存会话到集合中，并且给其他会话发送消息：eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterConnectionEstablished</span><span class="token punctuation">(</span><span class="token class-name">WebSocketSession</span> session<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 保存会话到集合中</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> pictureId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;pictureId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pictureSessions<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>pictureId<span class="token punctuation">,</span> <span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">.</span><span class="token function">newKeySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pictureSessions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pictureId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 构造响应</span>
    <span class="token class-name">PictureEditResponseMessage</span> pictureEditResponseMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PictureEditResponseMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token class-name">PictureEditMessageTypeEnum</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%s加入编辑&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>userService<span class="token punctuation">.</span><span class="token function">getUserVO</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 广播给同一张图片的用户</span>
    <span class="token function">broadcastToPicture</span><span class="token punctuation">(</span>pictureId<span class="token punctuation">,</span> pictureEditResponseMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4）编写接收客户端消息的方法，根据消息类别执行不同的处理：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">handleTextMessage</span><span class="token punctuation">(</span><span class="token class-name">WebSocketSession</span> session<span class="token punctuation">,</span> <span class="token class-name">TextMessage</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将消息解析为 PictureEditMessage</span>
    <span class="token class-name">PictureEditRequestMessage</span> pictureEditRequestMessage <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PictureEditRequestMessage</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> type <span class="token operator">=</span> pictureEditRequestMessage<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">PictureEditMessageTypeEnum</span> pictureEditMessageTypeEnum <span class="token operator">=</span> <span class="token class-name">PictureEditMessageTypeEnum</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 从 Session 属性中获取公共参数</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> attributes <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> attributes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> pictureId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span> attributes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;pictureId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 调用对应的消息处理方法</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>pictureEditMessageTypeEnum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token constant">ENTER_EDIT</span><span class="token operator">:</span>
            <span class="token function">handleEnterEditMessage</span><span class="token punctuation">(</span>pictureEditRequestMessage<span class="token punctuation">,</span> session<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pictureId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">EDIT_ACTION</span><span class="token operator">:</span>
            <span class="token function">handleEditActionMessage</span><span class="token punctuation">(</span>pictureEditRequestMessage<span class="token punctuation">,</span> session<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pictureId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">EXIT_EDIT</span><span class="token operator">:</span>
            <span class="token function">handleExitEditMessage</span><span class="token punctuation">(</span>pictureEditRequestMessage<span class="token punctuation">,</span> session<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pictureId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token class-name">PictureEditResponseMessage</span> pictureEditResponseMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PictureEditResponseMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token class-name">PictureEditMessageTypeEnum</span><span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">&quot;消息类型错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>userService<span class="token punctuation">.</span><span class="token function">getUserVO</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            session<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>pictureEditResponseMessage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来依次编写每个处理消息的方法。首先是用户进入编辑状态，要设置当前用户为编辑用户，并且向其他客户端发送消息：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleEnterEditMessage</span><span class="token punctuation">(</span><span class="token class-name">PictureEditRequestMessage</span> pictureEditRequestMessage<span class="token punctuation">,</span> <span class="token class-name">WebSocketSession</span> session<span class="token punctuation">,</span> <span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">Long</span> pictureId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 没有用户正在编辑该图片，才能进入编辑</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pictureEditingUsers<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>pictureId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 设置当前用户为编辑用户</span>
        pictureEditingUsers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pictureId<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PictureEditResponseMessage</span> pictureEditResponseMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PictureEditResponseMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token class-name">PictureEditMessageTypeEnum</span><span class="token punctuation">.</span><span class="token constant">ENTER_EDIT</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%s开始编辑图片&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>userService<span class="token punctuation">.</span><span class="token function">getUserVO</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">broadcastToPicture</span><span class="token punctuation">(</span>pictureId<span class="token punctuation">,</span> pictureEditResponseMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>用户执行编辑操作时，将该操作同步给 <strong>除了当前用户之外</strong> 的其他客户端，也就是说编辑操作不用再同步给自己：LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleEditActionMessage</span><span class="token punctuation">(</span><span class="token class-name">PictureEditRequestMessage</span> pictureEditRequestMessage<span class="token punctuation">,</span> <span class="token class-name">WebSocketSession</span> session<span class="token punctuation">,</span> <span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">Long</span> pictureId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Long</span> editingUserId <span class="token operator">=</span> pictureEditingUsers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pictureId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> editAction <span class="token operator">=</span> pictureEditRequestMessage<span class="token punctuation">.</span><span class="token function">getEditAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">PictureEditActionEnum</span> actionEnum <span class="token operator">=</span> <span class="token class-name">PictureEditActionEnum</span><span class="token punctuation">.</span><span class="token function">getEnumByValue</span><span class="token punctuation">(</span>editAction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>actionEnum <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 确认是当前编辑者</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>editingUserId <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> editingUserId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">PictureEditResponseMessage</span> pictureEditResponseMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PictureEditResponseMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token class-name">PictureEditMessageTypeEnum</span><span class="token punctuation">.</span><span class="token constant">EDIT_ACTION</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%s执行%s&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> actionEnum<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setEditAction</span><span class="token punctuation">(</span>editAction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>userService<span class="token punctuation">.</span><span class="token function">getUserVO</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 广播给除了当前客户端之外的其他用户，否则会造成重复编辑</span>
        <span class="token function">broadcastToPicture</span><span class="token punctuation">(</span>pictureId<span class="token punctuation">,</span> pictureEditResponseMessage<span class="token punctuation">,</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>用户退出编辑操作时，移除当前用户的编辑状态，并且向其他客户端发送消息：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleExitEditMessage</span><span class="token punctuation">(</span><span class="token class-name">PictureEditRequestMessage</span> pictureEditRequestMessage<span class="token punctuation">,</span> <span class="token class-name">WebSocketSession</span> session<span class="token punctuation">,</span> <span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">Long</span> pictureId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Long</span> editingUserId <span class="token operator">=</span> pictureEditingUsers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pictureId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>editingUserId <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> editingUserId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 移除当前用户的编辑状态</span>
        pictureEditingUsers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>pictureId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 构造响应，发送退出编辑的消息通知</span>
        <span class="token class-name">PictureEditResponseMessage</span> pictureEditResponseMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PictureEditResponseMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token class-name">PictureEditMessageTypeEnum</span><span class="token punctuation">.</span><span class="token constant">EXIT_EDIT</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%s退出编辑图片&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>userService<span class="token punctuation">.</span><span class="token function">getUserVO</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">broadcastToPicture</span><span class="token punctuation">(</span>pictureId<span class="token punctuation">,</span> pictureEditResponseMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>5）WebSocket 连接关闭时，需要移除当前用户的编辑状态、并且从集合中删除当前会话，还可以给其他客户端发送消息通知：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterConnectionClosed</span><span class="token punctuation">(</span><span class="token class-name">WebSocketSession</span> session<span class="token punctuation">,</span> <span class="token annotation punctuation">@NotNull</span> <span class="token class-name">CloseStatus</span> status<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> attributes <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> pictureId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span> attributes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;pictureId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> attributes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 移除当前用户的编辑状态</span>
    <span class="token function">handleExitEditMessage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> session<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pictureId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 删除会话</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WebSocketSession</span><span class="token punctuation">&gt;</span></span> sessionSet <span class="token operator">=</span> pictureSessions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pictureId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionSet <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sessionSet<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionSet<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pictureSessions<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>pictureId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 响应</span>
    <span class="token class-name">PictureEditResponseMessage</span> pictureEditResponseMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PictureEditResponseMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token class-name">PictureEditMessageTypeEnum</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%s离开编辑&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>userService<span class="token punctuation">.</span><span class="token function">getUserVO</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">broadcastToPicture</span><span class="token punctuation">(</span>pictureId<span class="token punctuation">,</span> pictureEditResponseMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>💡 由于处理器的代码并不复杂，而且处理逻辑中使用到了当前类的全局变量，所以鱼皮没有选择将每个处理器封装为单独的类。大家也可以将每个处理器封装为单独的类（相当于设计模式中的策略模式），并且根据消息类别调用不同的处理器类。</p><h3 id="_5、websocket-配置" tabindex="-1"><a class="header-anchor" href="#_5、websocket-配置" aria-hidden="true">#</a> 5、WebSocket 配置</h3><p>类似于编写 Spring MVC 的 Controller 接口，可以为指定的路径配置处理器和拦截器：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSocket</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebSocketConfigurer</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">PictureEditHandler</span> pictureEditHandler<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">WsHandshakeInterceptor</span> wsHandshakeInterceptor<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerWebSocketHandlers</span><span class="token punctuation">(</span><span class="token class-name">WebSocketHandlerRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// websocket</span>
        registry<span class="token punctuation">.</span><span class="token function">addHandler</span><span class="token punctuation">(</span>pictureEditHandler<span class="token punctuation">,</span> <span class="token string">&quot;/ws/picture/edit&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addInterceptors</span><span class="token punctuation">(</span>wsHandshakeInterceptor<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setAllowedOrigins</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>之后，前端就可以通过 WebSocket 连接项目启动端口的 <code>/ws/picture/edit</code> 路径了。</p><h2 id="四、扩展知识-disruptor-优化" tabindex="-1"><a class="header-anchor" href="#四、扩展知识-disruptor-优化" aria-hidden="true">#</a> 四、扩展知识 - Disruptor 优化</h2><h3 id="_1、现存的系统问题" tabindex="-1"><a class="header-anchor" href="#_1、现存的系统问题" aria-hidden="true">#</a> 1、现存的系统问题</h3><p>WebSocket 通常是长连接，每个客户端都需要占用服务器资源。在 Spring WebSocket 中，每个 WebSocket 连接（客户端）对应一个独立的 <code>WebSocketSession</code>，消息的处理是在该 <code>WebSocketSession</code> 所属的线程中执行。</p><p>如果 <strong>同一个</strong> WebSocket 连接（客户端）连续发送多条消息，服务器会 <strong>按照接收的顺序依次同步处理</strong>，而不是并发执行。这是为了保证每个客户端的消息处理是线程安全的。</p><p>可以在 <code>handleTextMessage</code> 方法中增加 <code>Thread.sleep</code> 来测试一下。连续点击多次编辑操作，会发现每隔一段时间方法才会执行一次。</p><p>虽然多个客户端的消息处理是可以并发执行的，但是接受消息和具体处理某个消息使用的是 <strong>同一个线程</strong>。如果处理消息的耗时比较长，并发量又比较高，可能会导致系统响应时间变长，甚至因为资源耗尽而服务崩溃。</p><p>💡 为了便于理解，可以类比一下调用 Spring MVC 的某个接口时，如果该接口内部的耗时较长，请求线程就会一直阻塞，最终导致 Tomcat 请求连接数耗尽。</p><p>怎么解决这个问题呢？最简单的方法就是开一个线程专门来异步处理消息。但是我们还要保证操作是按照顺序同步给其他客户端的，因此还需要引入一个队列，将任务按照顺序放到队列中，交给线程去处理。</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221705296.webp" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>其实上述的异步操作 + 从任务队列取任务执行，使用线程池就可以实现了。</p><p>但对于协同编辑场景，需要尽可能地保证低延迟，因此我们选用一种高级技术 <strong>Disruptor</strong> 无锁队列来减少线程上下文的切换，能够在高并发场景下保持低延迟和高吞吐量。4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=</p><p>此外，使用 Disruptor 还有一个优点，可以将任务放到队列中，通过优雅停机机制，在服务停止前执行完所有的任务，再退出服务，防止消息丢失。</p><h3 id="_2、disruptor-介绍" tabindex="-1"><a class="header-anchor" href="#_2、disruptor-介绍" aria-hidden="true">#</a> 2、Disruptor 介绍</h3><p><a href="https://lmax-exchange.github.io/disruptor/#_what_is_the_disruptor" target="_blank" rel="noopener noreferrer">Disruptor<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 是一种高性能的并发框架，由 LMAX（一个金融交易系统公司）开发，它是一种 <strong>无锁的环形队列</strong> 数据结构，用于解决高吞吐量和低延迟场景中的并发问题。支持生产者-消费者模式，可作为消息队列使用，适用于金融交易、实时数据处理、游戏事件等对并发和实时性要求较高的场景。</p><p>它最大的特点就是快、延迟低，非常低！</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221705303.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>Disruptor 的核心思想是基于固定大小的 <strong>环形缓冲区</strong>（Ring Buffer），并通过序列化控制访问，以避免传统队列中常见的</p><p>它主要通过以下几点实现高性能的消息传递机制：</p><ol><li>环形缓冲区：使用固定大小的数组，可以复用内存，避免了频繁的内存分配和垃圾回收。</li><li>无锁设计：依赖 CAS（Compare-And-Swap）和内存屏障，而不是传统的锁，降低了线程切换的开销。</li><li>缓存友好：最大化利用 CPU 的缓存局部性，提高访问速度。</li><li>序列号机制：通过序列号管理生产者和消费者的访问，保证数据一致性。</li><li>多消费者模式：支持多消费者共享同一环形缓冲区，并能配置不同的消费策略（如依赖关系、并行消费等）。</li></ol><p>Disruptor 与传统队列对比：</p><table><thead><tr><th>特性</th><th>Disruptor</th><th>BlockingQueue</th></tr></thead><tbody><tr><td>并发控制</td><td>无锁（CAS + 内存屏障）</td><td>基于锁（ReentrantLock）</td></tr><tr><td>内存管理</td><td>固定长度的环形数组</td><td>动态数组或链表</td></tr><tr><td>性能</td><td>极高（百万级别消息/秒）</td><td>较低（数万消息/秒）</td></tr><tr><td>延迟</td><td>纳秒级别</td><td>毫秒级别</td></tr><tr><td>GC 压力</td><td>极低（数据复用）</td><td>较高（频繁创建新对象）</td></tr><tr><td>适用场景</td><td>高频实时消息处理、金融系统</td><td>一般生产者消费者模型</td></tr></tbody></table><h3 id="_3、disruptor-核心概念与工作流程" tabindex="-1"><a class="header-anchor" href="#_3、disruptor-核心概念与工作流程" aria-hidden="true">#</a> 3、Disruptor 核心概念与工作流程</h3><p>先了解 Disruptor 的核心概念：58IUDBvyDy7G+gVMqAunJfAo72ZBX//2DD/nhaX54Xg=</p><ul><li>RingBuffer（环形缓冲区）：固定大小的循环数组，用于存储数据项，生产者和消费者共享该数据结构。</li><li>Event（事件）：存储在 <code>RingBuffer</code> 中的数据对象，用于表示要传递的消息或数据。</li><li>Producer（生产者）：负责向 <code>RingBuffer</code> 写入数据的角色。</li><li>Consumer（消费者）：从 <code>RingBuffer</code> 中读取并处理数据的角色。</li><li>Sequencer（序列器）：管理生产者与消费者的索引，确保并发安全的序列管理。</li><li>SequenceBarrier（序列屏障）：控制消费者等待数据可用的机制，确保数据完整性。</li><li>WaitStrategy（等待策略）：定义消费者如何等待新的数据（如自旋、自适应等待等）。</li><li>EventProcessor（事件处理器）：集成了 <code>Consumer</code> 和 <code>SequenceBarrier</code>，用于更高级的消费控制。</li></ul><p>而 Disruptor 是封装了 <code>RingBuffer</code>、<code>Producer</code> 和 <code>Consumer</code> 的核心管理类，用于协调所有组件的运行。</p><p>下面我举例来说明 Disruptor 的工作流程：J+5o58b0kn/bTqd/50F76o1L2/PhqvQWrl14ca26WW0=</p><ol><li>环形队列初始化：创建一个固定大小为 8 的 RingBuffer（索引范围 0-7），每个格子存储一个可复用的事件对象，序号初始为 0。</li><li>生产者写入数据：生产者申请索引 0（序号 0），将数据 &quot;A&quot; 写入事件对象，提交后序号递增为 1，下一个写入索引变为 1。</li><li>消费者读取数据：消费者检查索引 0（序号 0），读取数据 &quot;A&quot;，处理后提交，序号递增为 1，下一个读取索引变为 1。</li><li>环形队列循环使用：当生产者写入到索引 7（序号 7）后，索引回到 0（序号 8），形成循环存储，<strong>但序号会持续自增以区分数据的先后顺序。</strong></li><li>防止数据覆盖：如果生产者追上消费者，消费者尚未处理完数据，生产者会等待，确保数据不被覆盖。</li></ol><p>下图是一个 Disruptor 生产者的模型，仅供参考，了解一下即可：</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221705308.webp" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>其实对大家来说，先将 Disruptor 当做一个高性能的队列来使用就可以了，可以向队列中添加事件并定义处理方式。感兴趣的同学可以阅读 <a href="https://juejin.cn/post/6844903648875528206" target="_blank" rel="noopener noreferrer">这篇文章<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 深入了解 Disruptor 性能高的原因。</p><p>下面我们来引入 Disruptor 来优化代码。</p><h3 id="_4、disruptor-实战" tabindex="-1"><a class="header-anchor" href="#_4、disruptor-实战" aria-hidden="true">#</a> 4、Disruptor 实战</h3><p>1）引入 Disruptor 依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- 高性能无锁队列 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.lmax<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>disruptor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.4.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）定义事件</p><p>事件是 Disruptor 执行的核心单位，在 <code>websocket.disruptor</code> 包中新建 PictureEditEvent 类，充当了上下文容器，所有处理消息所需的数据都被封装在其中。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PictureEditEvent</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 消息
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">PictureEditRequestMessage</span> pictureEditRequestMessage<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 当前用户的 session
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">WebSocketSession</span> session<span class="token punctuation">;</span>
    
    <span class="token doc-comment comment">/**
     * 当前用户
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">User</span> user<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 图片 id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> pictureId<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3）定义事件处理器（消费者）</p><p>这里基本上是把 <code>PictureEditHandler</code> 分发消息的逻辑搬了过来，它的作用就是将不同类型的消息分发到对应的处理器中。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PictureEditEventWorkHandler</span> <span class="token keyword">implements</span> <span class="token class-name">WorkHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PictureEditEvent</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token annotation punctuation">@Lazy</span>
    <span class="token keyword">private</span> <span class="token class-name">PictureEditHandler</span> pictureEditHandler<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token class-name">PictureEditEvent</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">PictureEditRequestMessage</span> pictureEditRequestMessage <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getPictureEditRequestMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WebSocketSession</span> session <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> pictureId <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getPictureId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取到消息类别</span>
        <span class="token class-name">String</span> type <span class="token operator">=</span> pictureEditRequestMessage<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PictureEditMessageTypeEnum</span> pictureEditMessageTypeEnum <span class="token operator">=</span> <span class="token class-name">PictureEditMessageTypeEnum</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 调用对应的消息处理方法</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>pictureEditMessageTypeEnum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">ENTER_EDIT</span><span class="token operator">:</span>
                pictureEditHandler<span class="token punctuation">.</span><span class="token function">handleEnterEditMessage</span><span class="token punctuation">(</span>pictureEditRequestMessage<span class="token punctuation">,</span> session<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pictureId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">EDIT_ACTION</span><span class="token operator">:</span>
                pictureEditHandler<span class="token punctuation">.</span><span class="token function">handleEditActionMessage</span><span class="token punctuation">(</span>pictureEditRequestMessage<span class="token punctuation">,</span> session<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pictureId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">EXIT_EDIT</span><span class="token operator">:</span>
                pictureEditHandler<span class="token punctuation">.</span><span class="token function">handleExitEditMessage</span><span class="token punctuation">(</span>pictureEditRequestMessage<span class="token punctuation">,</span> session<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pictureId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token class-name">PictureEditResponseMessage</span> pictureEditResponseMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PictureEditResponseMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token class-name">PictureEditMessageTypeEnum</span><span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">&quot;消息类型错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pictureEditResponseMessage<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>userService<span class="token punctuation">.</span><span class="token function">getUserVO</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                session<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>pictureEditResponseMessage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4）添加 Disruptor 配置类，将我们刚定义的事件及处理器关联到 Disruptor 实例中：4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PictureEditEventDisruptorConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">PictureEditEventWorkHandler</span> pictureEditEventWorkHandler<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;pictureEditEventDisruptor&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Disruptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PictureEditEvent</span><span class="token punctuation">&gt;</span></span> <span class="token function">messageModelRingBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ringBuffer 的大小</span>
        <span class="token keyword">int</span> bufferSize <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">256</span><span class="token punctuation">;</span>
        <span class="token class-name">Disruptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PictureEditEvent</span><span class="token punctuation">&gt;</span></span> disruptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Disruptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                <span class="token class-name">PictureEditEvent</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">,</span>
                bufferSize<span class="token punctuation">,</span>
                <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNamePrefix</span><span class="token punctuation">(</span><span class="token string">&quot;pictureEditEventDisruptor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置消费者</span>
        disruptor<span class="token punctuation">.</span><span class="token function">handleEventsWithWorkerPool</span><span class="token punctuation">(</span>pictureEditEventWorkHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 开启 disruptor</span>
        disruptor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> disruptor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>5、定义事件生产者</p><p>生产者负责将数据（事件）发到 Disruptor 的环形缓冲区中。为了保证在停机时所有的消息都能够被处理，我们通过 <code>shutdown</code> 方法完成 Disruptor 的优雅停机。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PictureEditEventProducer</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">Disruptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PictureEditEvent</span><span class="token punctuation">&gt;</span></span> pictureEditEventDisruptor<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token class-name">PictureEditRequestMessage</span> pictureEditRequestMessage<span class="token punctuation">,</span> <span class="token class-name">WebSocketSession</span> session<span class="token punctuation">,</span> <span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">Long</span> pictureId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RingBuffer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PictureEditEvent</span><span class="token punctuation">&gt;</span></span> ringBuffer <span class="token operator">=</span> pictureEditEventDisruptor<span class="token punctuation">.</span><span class="token function">getRingBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取可以生成的位置</span>
        <span class="token keyword">long</span> next <span class="token operator">=</span> ringBuffer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PictureEditEvent</span> pictureEditEvent <span class="token operator">=</span> ringBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pictureEditEvent<span class="token punctuation">.</span><span class="token function">setSession</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pictureEditEvent<span class="token punctuation">.</span><span class="token function">setPictureEditRequestMessage</span><span class="token punctuation">(</span>pictureEditRequestMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pictureEditEvent<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pictureEditEvent<span class="token punctuation">.</span><span class="token function">setPictureId</span><span class="token punctuation">(</span>pictureId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 发布事件</span>
        ringBuffer<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 优雅停机
     */</span>
    <span class="token annotation punctuation">@PreDestroy</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pictureEditEventDisruptor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>6、修改 PictureEditHandler 的原有逻辑，改为使用事件生产者：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">PictureEditEventProducer</span> pictureEditEventProducer<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">handleTextMessage</span><span class="token punctuation">(</span><span class="token class-name">WebSocketSession</span> session<span class="token punctuation">,</span> <span class="token class-name">TextMessage</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将消息解析为 PictureEditMessage</span>
    <span class="token class-name">PictureEditRequestMessage</span> pictureEditRequestMessage <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PictureEditRequestMessage</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 从 Session 属性中获取公共参数</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> attributes <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> attributes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> pictureId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span> attributes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;pictureId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 生产消息</span>
    pictureEditEventProducer<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span>pictureEditRequestMessage<span class="token punctuation">,</span> session<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pictureId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样，我们就实现了基于 Disruptor 的异步消息处理机制，将原有的同步消息分发逻辑改造为高效解耦的异步处理模型，也更有利于代码的扩展。</p><h3 id="扩展" tabindex="-1"><a class="header-anchor" href="#扩展" aria-hidden="true">#</a> 扩展</h3><p>1、为防止消息丢失，可以使用 Redis 等高性能存储保存执行的操作记录。</p><p>目前如果图片已经被编辑了，新用户加入编辑时没办法查看到已编辑的状态，这一点也可以利用 Redis 保存操作记录来解决，新用户加入编辑时读取 Redis 的操作记录即可。</p><p>2、每种类型的消息处理可以封装为独立的 Handler 处理器类，也就是采用策略模式。</p><p>3、支持分布式 WebSocket。实现思路很简单，只需要保证要编辑同一图片的用户连接的是相同的服务器即可，和游戏分服务器大区、聊天室分房间是类似的原理。</p><p>4、一些小问题的优化：比如 WebSocket 连接建立之后，如果用户退出了登录，这时 WebSocket 的连接是没有断开的。不过影响并不大，大家可以思考下怎么处理。</p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/tim-qtp/blog/edit/main/demo/theme-docs/src/projectessay/practicalProjects/imageLibrary/11.Collaborative photo editing.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 2469100031@qq.com">tim-qtp</span><!--]--><!--]--></div></div></footer><nav class="page-nav"><a href="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html" class="nav-link prev" aria-label="团队空间"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->团队空间</div></a><!----></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">默认页脚</div><div class="copyright">Copyright © 2025 tim-qtp</div></footer></div><!--]--><!----><!----><!----><!--]--></div>
    <script type="module" src="/blog/assets/app-ea5774d5.js" defer></script>
  </body>
</html>
