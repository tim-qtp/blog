<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.61" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://tim-qtp.github.io/blog/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html"><meta property="og:site_name" content="Qtp"><meta property="og:title" content="å›¢é˜Ÿç©ºé—´"><meta property="og:description" content="1ã€ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶ ç›´æ¥ç”¨Sa-Token (https://sa-token.cc/doc.html#/start/example) å®ç°ä»¥ä¸‹æƒé™ è§’è‰² å¯¹åº”æƒé™é”® å¯æ‰§è¡ŒåŠŸèƒ½ ------ ------------------------------------------------------------ ------------------..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-03-22T13:49:25.000Z"><meta property="article:author" content="tim-qtp"><meta property="article:tag" content="encryption"><meta property="article:modified_time" content="2025-03-22T13:49:25.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"å›¢é˜Ÿç©ºé—´","image":[""],"dateModified":"2025-03-22T13:49:25.000Z","author":[{"@type":"Person","name":"tim-qtp","url":"https://github.com/tim-qtp/"}]}</script><link rel="icon" href="/blog/favicon.ico"><link rel="icon" href="/blog/assets/icon/chrome-mask-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/blog/assets/icon/chrome-mask-192.png" type="image/png" sizes="192x192"><link rel="icon" href="/blog/assets/icon/chrome-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/blog/assets/icon/chrome-192.png" type="image/png" sizes="192x192"><link rel="manifest" href="/blog/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><link rel="apple-touch-icon" href="/blog/assets/icon/apple-icon-152.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/blog/assets/icon/ms-icon-144.png"><meta name="msapplication-TileColor" content="#ffffff"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"><title>å›¢é˜Ÿç©ºé—´ | Qtp</title><meta name="description" content="1ã€ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶ ç›´æ¥ç”¨Sa-Token (https://sa-token.cc/doc.html#/start/example) å®ç°ä»¥ä¸‹æƒé™ è§’è‰² å¯¹åº”æƒé™é”® å¯æ‰§è¡ŒåŠŸèƒ½ ------ ------------------------------------------------------------ ------------------...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/blog/assets/style-dcdd17d8.css" as="style"><link rel="stylesheet" href="/blog/assets/style-dcdd17d8.css">
    <link rel="modulepreload" href="/blog/assets/app-ea5774d5.js"><link rel="modulepreload" href="/blog/assets/framework-6a3aa88c.js"><link rel="modulepreload" href="/blog/assets/10.Team Space.html-ea566060.js"><link rel="modulepreload" href="/blog/assets/10.Team Space.html-d2b3d669.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button type="button" class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/blog/" class="brand"><img class="logo" src="/blog/logo.svg" alt="Qtp"><!----><span class="site-name hide-in-pad">Qtp</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/blog/" class="nav-link" aria-label="ä¸»é¡µ"><span class="font-icon icon iconfont icon-home" style=""></span>ä¸»é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><a href="/blog/intro/" class="nav-link" aria-label="ç¬”è®°"><span class="font-icon icon iconfont icon-discover" style=""></span>ç¬”è®°<!----></a></div><div class="nav-item hide-in-mobile"><a href="/blog/life/" class="nav-link" aria-label="ç”Ÿæ´»"><span class="font-icon icon iconfont icon-life" style=""></span>ç”Ÿæ´»<!----></a></div><div class="nav-item hide-in-mobile"><a href="/blog/about/" class="nav-link" aria-label="å…³äºæˆ‘"><span class="font-icon icon iconfont icon-about" style=""></span>å…³äºæˆ‘<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/tim-qtp/blog" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" role="search" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="placeholder">æœç´¢</div><div class="key-hints"><kbd class="key">Ctrl</kbd><kbd class="key">K</kbd></div></button><!--]--><!--[--><!----><!--]--><button type="button" class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-computer" style=""></span><span class="title">ä¸€ã€è®¡ç®—æœºåŸºç¡€</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-vscode" style=""></span><span class="title">äºŒã€å‰ç«¯</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-java" style=""></span><span class="title">ä¸‰ã€Java</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-rust" style=""></span><span class="title">å››ã€Rust</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-framework" style=""></span><span class="title">äº”ã€æ¡†æ¶</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-microservices" style=""></span><span class="title">å…­ã€å¾®æœåŠ¡ä¸­é—´ä»¶</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-interview" style=""></span><span class="title">ä¸ƒã€é¢è¯•</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active" type="button"><span class="font-icon icon iconfont icon-essay" style=""></span><span class="title">å…«ã€é¡¹ç›®éšç¬”</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-experience" style=""></span><span class="title">æŠ€æœ¯ç»†èŠ‚</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active" type="button"><span class="font-icon icon iconfont icon-project3" style=""></span><span class="title">å®æˆ˜é¡¹ç›®</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-shortlink" style=""></span><span class="title">çŸ­é“¾æ¥</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active" type="button"><span class="font-icon icon iconfont icon-imageLibrary" style=""></span><span class="title">æ™ºèƒ½å›¾åº“</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/blog/projectessay/practicalProjects/imageLibrary/1.Image%20upload.html" class="nav-link sidebar-link sidebar-page" aria-label="å›¾ç‰‡ä¸Šä¼ "><!---->å›¾ç‰‡ä¸Šä¼ <!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/imageLibrary/2.Audit%20logic.html" class="nav-link sidebar-link sidebar-page" aria-label="å®¡æ ¸é€»è¾‘"><!---->å®¡æ ¸é€»è¾‘<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/imageLibrary/3.Capture%20Packet%20Batch%20Creation.html" class="nav-link sidebar-link sidebar-page" aria-label="æŠ“åŒ…æ‰¹é‡åˆ›å»º"><!---->æŠ“åŒ…æ‰¹é‡åˆ›å»º<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/imageLibrary/4.Space%20Module.html" class="nav-link sidebar-link sidebar-page" aria-label="ç©ºé—´æ¨¡å—"><!---->ç©ºé—´æ¨¡å—<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/imageLibrary/5.Similar%20Color%20Search.html" class="nav-link sidebar-link sidebar-page" aria-label="ç›¸ä¼¼é¢œè‰²æœç´¢"><!---->ç›¸ä¼¼é¢œè‰²æœç´¢<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/imageLibrary/6.Photo%20Sharing.html" class="nav-link sidebar-link sidebar-page" aria-label="å›¾ç‰‡åˆ†äº«"><!---->å›¾ç‰‡åˆ†äº«<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/imageLibrary/7.Batch%20management%20of%20pictures.html" class="nav-link sidebar-link sidebar-page" aria-label="å›¾ç‰‡æ‰¹é‡ç®¡ç†"><!---->å›¾ç‰‡æ‰¹é‡ç®¡ç†<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/imageLibrary/8.AI%20Image%20Enlargement.html" class="nav-link sidebar-link sidebar-page" aria-label="AIæ‰©å›¾+è£å‰ªç¼–è¾‘"><!---->AIæ‰©å›¾+è£å‰ªç¼–è¾‘<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/imageLibrary/9.Gallery%20Analysis.html" class="nav-link sidebar-link sidebar-page" aria-label="å›¾åº“åˆ†æ"><!---->å›¾åº“åˆ†æ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="å›¢é˜Ÿç©ºé—´"><!---->å›¢é˜Ÿç©ºé—´<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html#_1ã€ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1ã€ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶"><!---->1ã€ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html#_2ã€ç©ºé—´æ•°æ®ç®¡ç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2ã€ç©ºé—´æ•°æ®ç®¡ç†"><!---->2ã€ç©ºé—´æ•°æ®ç®¡ç†<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html#å›¾ç‰‡ä¿¡æ¯æ•°æ®" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="å›¾ç‰‡ä¿¡æ¯æ•°æ®"><!---->å›¾ç‰‡ä¿¡æ¯æ•°æ®<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html#å›¾ç‰‡æ–‡ä»¶æ•°æ®" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="å›¾ç‰‡æ–‡ä»¶æ•°æ®"><!---->å›¾ç‰‡æ–‡ä»¶æ•°æ®<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html#_3ã€åç«¯å¼€å‘" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3ã€åç«¯å¼€å‘"><!---->3ã€åç«¯å¼€å‘<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html#åˆ›å»ºå›¢é˜Ÿå…±äº«ç©ºé—´" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="åˆ›å»ºå›¢é˜Ÿå…±äº«ç©ºé—´"><!---->åˆ›å»ºå›¢é˜Ÿå…±äº«ç©ºé—´<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html#ç©ºé—´æˆå‘˜ç®¡ç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ç©ºé—´æˆå‘˜ç®¡ç†"><!---->ç©ºé—´æˆå‘˜ç®¡ç†<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html#ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶"><!---->ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html#ç©ºé—´æ•°æ®ç®¡ç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ç©ºé—´æ•°æ®ç®¡ç†"><!---->ç©ºé—´æ•°æ®ç®¡ç†<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html" class="nav-link sidebar-link sidebar-page" aria-label="å›¾ç‰‡ååŒç¼–è¾‘"><!---->å›¾ç‰‡ååŒç¼–è¾‘<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-logistics" style=""></span><span class="title">ç¥é¢†ç‰©æµ</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-oj" style=""></span><span class="title">åˆ·é¢˜OJå¹³å°</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-onlineEducation" style=""></span><span class="title">å­¦æˆåœ¨çº¿</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-flashSale" style=""></span><span class="title">ç§’æ€ç³»ç»Ÿ</span><span class="arrow end"></span></button><!----></section></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-bug" style=""></span><span class="title">bugä¿®å¤</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-rocket" style=""></span><span class="title">ç»éªŒæ•™è®­</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-scaffold" style=""></span><span class="title">è„šæ‰‹æ¶</span><span class="arrow end"></span></button><!----></section></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-github" style=""></span><span class="title">ä¹ã€å¼€æºæ¨è</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-xiayu" style=""></span><span class="title">åã€æŠ€æœ¯çç¢</span><span class="arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->å›¢é˜Ÿç©ºé—´</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://github.com/tim-qtp/" target="_blank" rel="noopener noreferrer">tim-qtp</a></span><span property="author" content="tim-qtp"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2025-03-22T13:49:25.000Z"></span><span class="page-pageview-info" aria-label="è®¿é—®é‡ğŸ”¢" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon eye-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="eye icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z"></path></svg><span class="waline-pageview-count" id="ArtalkPV" data-path="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html">...</span></span><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 43 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT43M"></span><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><span class="page-category-item category7" role>äº‘å›¾åº“</span><span class="page-category-item category2" role>é¡¹ç›®</span><meta property="articleSection" content="äº‘å›¾åº“,é¡¹ç›®"></span><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><span class="page-tag-item tag6" role>encryption</span><meta property="keywords" content="encryption"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html#_1ã€ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶" class="router-link-active router-link-exact-active toc-link level2">1ã€ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html#_2ã€ç©ºé—´æ•°æ®ç®¡ç†" class="router-link-active router-link-exact-active toc-link level2">2ã€ç©ºé—´æ•°æ®ç®¡ç†</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html#å›¾ç‰‡ä¿¡æ¯æ•°æ®" class="router-link-active router-link-exact-active toc-link level3">å›¾ç‰‡ä¿¡æ¯æ•°æ®</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html#å›¾ç‰‡æ–‡ä»¶æ•°æ®" class="router-link-active router-link-exact-active toc-link level3">å›¾ç‰‡æ–‡ä»¶æ•°æ®</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html#_3ã€åç«¯å¼€å‘" class="router-link-active router-link-exact-active toc-link level2">3ã€åç«¯å¼€å‘</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html#åˆ›å»ºå›¢é˜Ÿå…±äº«ç©ºé—´" class="router-link-active router-link-exact-active toc-link level3">åˆ›å»ºå›¢é˜Ÿå…±äº«ç©ºé—´</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html#ç©ºé—´æˆå‘˜ç®¡ç†" class="router-link-active router-link-exact-active toc-link level3">ç©ºé—´æˆå‘˜ç®¡ç†</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html#ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶" class="router-link-active router-link-exact-active toc-link level3">ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/imageLibrary/10.Team%20Space.html#ç©ºé—´æ•°æ®ç®¡ç†" class="router-link-active router-link-exact-active toc-link level3">ç©ºé—´æ•°æ®ç®¡ç†</a></li><!----><!--]--></ul></li><!--]--></ul></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h2 id="_1ã€ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶" tabindex="-1"><a class="header-anchor" href="#_1ã€ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶" aria-hidden="true">#</a> 1ã€ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶</h2><p>ç›´æ¥ç”¨<a href="https://sa-token.cc/doc.html#/start/example" target="_blank" rel="noopener noreferrer">Sa-Token<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> å®ç°ä»¥ä¸‹æƒé™</p><table><thead><tr><th>è§’è‰²</th><th>å¯¹åº”æƒé™é”®</th><th>å¯æ‰§è¡ŒåŠŸèƒ½</th></tr></thead><tbody><tr><td>æµè§ˆè€…</td><td>picture:view</td><td>æŸ¥çœ‹å›¾ç‰‡</td></tr><tr><td>ç¼–è¾‘è€…</td><td>picture:view, picture:upload, picture:edit, picture:delete</td><td>æŸ¥çœ‹å›¾ç‰‡ã€ä¸Šä¼ å›¾ç‰‡ã€ä¿®æ”¹å›¾ç‰‡ã€åˆ é™¤å›¾ç‰‡</td></tr><tr><td>ç®¡ç†å‘˜</td><td>spaceUser:manage, picture:view, picture:upload, picture:edit, picture:delete</td><td>æˆå‘˜ç®¡ç†ã€æŸ¥çœ‹å›¾ç‰‡ã€ä¸Šä¼ å›¾ç‰‡ã€ä¿®æ”¹å›¾ç‰‡ã€åˆ é™¤å›¾ç‰‡</td></tr></tbody></table><h2 id="_2ã€ç©ºé—´æ•°æ®ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#_2ã€ç©ºé—´æ•°æ®ç®¡ç†" aria-hidden="true">#</a> 2ã€ç©ºé—´æ•°æ®ç®¡ç†</h2><p>è€ƒè™‘åˆ°å›¢é˜Ÿç©ºé—´çš„å›¾ç‰‡æ•°é‡å¯èƒ½æ¯”è¾ƒå¤šï¼Œå¯ä»¥å¯¹ç‰¹å®šç©ºé—´çš„æ•°æ®è¿›è¡Œå•ç‹¬çš„ç®¡ç†ã€‚</p><p>å¦‚ä½•å¯¹æ•°æ®è¿›è¡Œå•ç‹¬çš„ç®¡ç†å‘¢ï¼Ÿ</p><h3 id="å›¾ç‰‡ä¿¡æ¯æ•°æ®" tabindex="-1"><a class="header-anchor" href="#å›¾ç‰‡ä¿¡æ¯æ•°æ®" aria-hidden="true">#</a> å›¾ç‰‡ä¿¡æ¯æ•°æ®</h3><p>å¯ä»¥ç»™æ¯ä¸ªå›¢é˜Ÿç©ºé—´å•ç‹¬åˆ›å»ºä¸€å¼ å›¾ç‰‡è¡¨ <code>picture_{spaceId}</code>ï¼Œä¹Ÿå°±æ˜¯åˆ†åº“åˆ†è¡¨ä¸­çš„ <code>åˆ†è¡¨</code>ï¼Œè€Œä¸æ˜¯å’Œå…¬å…±å›¾åº“ã€ç§æœ‰ç©ºé—´çš„å›¾ç‰‡æ··åœ¨ä¸€èµ·ã€‚è¿™æ ·ä¸ä»…æŸ¥è¯¢ç©ºé—´å†…çš„å›¾ç‰‡æ•ˆç‡æ›´é«˜ï¼Œè¿˜ä¾¿äºæ•´ä½“ç®¡ç†å’Œæ¸…ç†ç©ºé—´ã€‚ä½†æ˜¯è¦æ³¨æ„ï¼Œ<mark><strong>ä»…å¯¹æ——èˆ°ç‰ˆç©ºé—´ç”Ÿæ•ˆï¼Œå¦åˆ™åˆ†è¡¨çš„æ•°é‡ä¼šç‰¹åˆ«å¤šï¼Œåè€Œå¯èƒ½å½±å“æ€§èƒ½</strong></mark>ã€‚</p><p>æ³¨æ„ï¼Œè¦å®ç°çš„ï¼Œè¿˜<mark>ä¸æ˜¯æ™®é€šçš„é™æ€åˆ†è¡¨</mark>ï¼Œè€Œæ˜¯ä¼šéšç€æ–°å¢ç©ºé—´ä¸æ–­å¢åŠ åˆ†è¡¨æ•°é‡çš„<mark>åŠ¨æ€åˆ†è¡¨</mark>ï¼Œä¼šä½¿ç”¨åˆ†åº“åˆ†è¡¨æ¡†æ¶ <a href="https://shardingsphere.apache.org/" target="_blank" rel="noopener noreferrer">Apache ShardingSphere<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ã€‚</p><h3 id="å›¾ç‰‡æ–‡ä»¶æ•°æ®" tabindex="-1"><a class="header-anchor" href="#å›¾ç‰‡æ–‡ä»¶æ•°æ®" aria-hidden="true">#</a> å›¾ç‰‡æ–‡ä»¶æ•°æ®</h3><p>å·²ç»å°†æ¯ä¸ªç©ºé—´çš„å›¾ç‰‡å­˜åˆ°ä¸åŒçš„è·¯å¾„ä¸­äº†ï¼Œå®ç°äº†éš”ç¦»ï¼Œæ— éœ€é¢å¤–å¼€å‘ã€‚</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221417185.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ğŸ’¡ åœ¨è®¾è®¡ä¸Šå°±å°†å›¢é˜Ÿç©ºé—´å’Œç§æœ‰ç©ºé—´éš”ç¦»ï¼Œä»…å¯¹å›¢é˜Ÿç©ºé—´åº”ç”¨æˆå‘˜ç®¡ç†ã€æƒé™æ§åˆ¶ã€åŠ¨æ€åˆ†è¡¨ã€‚è¿™æ ·å¯ä»¥å°½é‡å‡å°‘å¯¹åŸæœ‰ä»£ç çš„æ”¹åŠ¨ï¼Œé¿å…å‡ºç°é—®é¢˜ã€‚</p><h2 id="_3ã€åç«¯å¼€å‘" tabindex="-1"><a class="header-anchor" href="#_3ã€åç«¯å¼€å‘" aria-hidden="true">#</a> 3ã€åç«¯å¼€å‘</h2><h3 id="åˆ›å»ºå›¢é˜Ÿå…±äº«ç©ºé—´" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºå›¢é˜Ÿå…±äº«ç©ºé—´" aria-hidden="true">#</a> åˆ›å»ºå›¢é˜Ÿå…±äº«ç©ºé—´</h3><h4 id="_1ã€æ•°æ®æ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#_1ã€æ•°æ®æ¨¡å‹" aria-hidden="true">#</a> 1ã€æ•°æ®æ¨¡å‹</h4><p>Spaceã€SpaceVOã€SpaceAddRequestã€SpaceQueryRequest è¡¥å…… spaceType å­—æ®µï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * ç©ºé—´ç±»å‹ï¼š0-ç§æœ‰ 1-å›¢é˜Ÿ
 */</span>
<span class="token keyword">private</span> <span class="token class-name">Integer</span> spaceType<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®šä¹‰ç©ºé—´ç±»å‹æšä¸¾ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Getter</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">SpaceTypeEnum</span> <span class="token punctuation">{</span>

    <span class="token function">PRIVATE</span><span class="token punctuation">(</span><span class="token string">&quot;ç§æœ‰ç©ºé—´&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">TEAM</span><span class="token punctuation">(</span><span class="token string">&quot;å›¢é˜Ÿç©ºé—´&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> text<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>

    <span class="token class-name">SpaceTypeEnum</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>text <span class="token operator">=</span> text<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * æ ¹æ® value è·å–æšä¸¾
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SpaceTypeEnum</span> <span class="token function">getEnumByValue</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SpaceTypeEnum</span> spaceTypeEnum <span class="token operator">:</span> <span class="token class-name">SpaceTypeEnum</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>spaceTypeEnum<span class="token punctuation">.</span>value <span class="token operator">==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> spaceTypeEnum<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2ã€æ–°å»ºå›¢é˜Ÿç©ºé—´" tabindex="-1"><a class="header-anchor" href="#_2ã€æ–°å»ºå›¢é˜Ÿç©ºé—´" aria-hidden="true">#</a> 2ã€æ–°å»ºå›¢é˜Ÿç©ºé—´</h4><p>å¯ä»¥ç›´æ¥å¤ç”¨åˆ›å»ºç©ºé—´çš„æ–¹æ³•ï¼Œåªéœ€è¦åšä¸€äº›æ”¹åŠ¨å³å¯ã€‚</p><p>1ï¼‰åˆ›å»ºç©ºé—´æ—¶ä¸ºç©ºé—´ç±»å‹æŒ‡å®šé»˜è®¤å€¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// é»˜è®¤å€¼</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>spaceAddRequest<span class="token punctuation">.</span><span class="token function">getSpaceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    spaceAddRequest<span class="token punctuation">.</span><span class="token function">setSpaceName</span><span class="token punctuation">(</span><span class="token string">&quot;é»˜è®¤ç©ºé—´&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>spaceAddRequest<span class="token punctuation">.</span><span class="token function">getSpaceLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    spaceAddRequest<span class="token punctuation">.</span><span class="token function">setSpaceLevel</span><span class="token punctuation">(</span><span class="token class-name">SpaceLevelEnum</span><span class="token punctuation">.</span><span class="token constant">COMMON</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>spaceAddRequest<span class="token punctuation">.</span><span class="token function">getSpaceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    spaceAddRequest<span class="token punctuation">.</span><span class="token function">setSpaceType</span><span class="token punctuation">(</span><span class="token class-name">SpaceTypeEnum</span><span class="token punctuation">.</span><span class="token constant">PRIVATE</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// åœ¨æ­¤å¤„å°†å®ä½“ç±»å’Œ DTO è¿›è¡Œè½¬æ¢</span>
<span class="token class-name">Space</span> space <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Space</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>spaceAddRequest<span class="token punctuation">,</span> space<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å¡«å……æ•°æ®</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fillSpaceBySpaceLevel</span><span class="token punctuation">(</span>space<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2ï¼‰validSpace æ–¹æ³•è¡¥å……å¯¹ç©ºé—´ç±»å‹çš„æ ¡éªŒï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">validSpace</span><span class="token punctuation">(</span><span class="token class-name">Space</span> space<span class="token punctuation">,</span> <span class="token keyword">boolean</span> add<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Integer</span> spaceType <span class="token operator">=</span> space<span class="token punctuation">.</span><span class="token function">getSpaceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SpaceTypeEnum</span> spaceTypeEnum <span class="token operator">=</span> <span class="token class-name">SpaceTypeEnum</span><span class="token punctuation">.</span><span class="token function">getEnumByValue</span><span class="token punctuation">(</span>spaceType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¦åˆ›å»º</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>add<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>spaceType <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">PARAMS_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;ç©ºé—´ç±»å‹ä¸èƒ½ä¸ºç©º&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ä¿®æ”¹æ•°æ®æ—¶ï¼Œå¦‚æœè¦æ”¹ç©ºé—´çº§åˆ«</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>spaceType <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> spaceTypeEnum <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">PARAMS_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;ç©ºé—´ç±»å‹ä¸å­˜åœ¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3ï¼‰é™åˆ¶æ¯ä¸ªæ™®é€šç”¨æˆ·ä»…èƒ½åˆ›å»ºä¸€ä¸ªå›¢é˜Ÿç©ºé—´ï¼ˆç®¡ç†å‘˜å¯ä»¥åˆ›å»ºå¤šä¸ªï¼‰ï¼Œç”±äºæ™®é€šç”¨æˆ·ä¹Ÿä»…èƒ½åˆ›å»ºä¸€ä¸ªç§æœ‰ç©ºé—´ï¼Œç›¸å½“äº **æ™®é€šç”¨æˆ·æ¯ç±»ç©ºé—´åªèƒ½åˆ›å»º 1 ä¸ªã€‚**å› æ­¤ï¼Œåªè¦åœ¨åˆ¤æ–­æ˜¯å¦å·²åˆ›å»ºç©ºé—´æ—¶ï¼Œè¡¥å…… spaceType ä½œä¸ºæŸ¥è¯¢æ¡ä»¶å³å¯ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Long</span> newSpaceId <span class="token operator">=</span> transactionTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>status <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userService<span class="token punctuation">.</span><span class="token function">isAdmin</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> exists <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">Space</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">Space</span><span class="token operator">::</span><span class="token function">getSpaceType</span><span class="token punctuation">,</span> spaceAddRequest<span class="token punctuation">.</span><span class="token function">getSpaceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThrowUtils</span><span class="token punctuation">.</span><span class="token function">throwIf</span><span class="token punctuation">(</span>exists<span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">OPERATION_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;æ¯ä¸ªç”¨æˆ·æ¯ç±»ç©ºé—´ä»…èƒ½åˆ›å»ºä¸€ä¸ª&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å†™å…¥æ•°æ®åº“</span>
    <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>space<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThrowUtils</span><span class="token punctuation">.</span><span class="token function">throwIf</span><span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">OPERATION_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿”å›æ–°å†™å…¥çš„æ•°æ® id</span>
    <span class="token keyword">return</span> space<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ç„¶ï¼Œè¿™é‡Œçš„é€»è¾‘è¿˜å¯ä»¥è‡ªç”±è°ƒæ•´ï¼Œæ¯”å¦‚ä¸å…è®¸ç”¨æˆ·åˆ›å»ºå›¢é˜Ÿç©ºé—´ï¼Œéœ€è¦è”ç³»ç®¡ç†å‘˜æˆ–ä»˜è´¹å¼€é€šã€‚</p><h4 id="_3ã€æŸ¥è¯¢å›¢é˜Ÿç©ºé—´" tabindex="-1"><a class="header-anchor" href="#_3ã€æŸ¥è¯¢å›¢é˜Ÿç©ºé—´" aria-hidden="true">#</a> 3ã€æŸ¥è¯¢å›¢é˜Ÿç©ºé—´</h4><p>ç»™ SpaceService çš„ getQueryWrapper æ–¹æ³•è¡¥å…… spaceType çš„æŸ¥è¯¢æ¡ä»¶ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Integer</span> spaceType <span class="token operator">=</span> spaceQueryRequest<span class="token punctuation">.</span><span class="token function">getSpaceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ObjUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>spaceType<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;spaceType&quot;</span><span class="token punctuation">,</span> spaceType<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¹‹åå‰ç«¯å°±èƒ½å¤ŸæŒ‰ç…§ç©ºé—´ç±»åˆ«è·å–ç©ºé—´åˆ—è¡¨äº†ã€‚</p><h3 id="ç©ºé—´æˆå‘˜ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#ç©ºé—´æˆå‘˜ç®¡ç†" aria-hidden="true">#</a> ç©ºé—´æˆå‘˜ç®¡ç†</h3><p>ç©ºé—´æˆå‘˜ç®¡ç†çš„å¼€å‘æ¯”è¾ƒç®€å•ï¼Œå…¶å®å°±æ˜¯ â€œå¢åˆ æ”¹æŸ¥â€ã€‚</p><p>éœ€è¦å¼€å‘çš„æ¥å£åŒ…æ‹¬ï¼š</p><ul><li>æ·»åŠ æˆå‘˜åˆ°ç©ºé—´ï¼šä»…æ‹¥æœ‰æˆå‘˜ç®¡ç†æƒé™çš„ç”¨æˆ·å¯ä½¿ç”¨ã€‚</li><li>ä»ç©ºé—´ç§»é™¤æˆå‘˜ï¼šä»…æ‹¥æœ‰æˆå‘˜ç®¡ç†æƒé™çš„ç”¨æˆ·å¯ä½¿ç”¨ã€‚</li><li>æŸ¥è¯¢æŸä¸ªæˆå‘˜åœ¨ç©ºé—´çš„ä¿¡æ¯ï¼šä»…æ‹¥æœ‰æˆå‘˜ç®¡ç†æƒé™çš„ç”¨æˆ·å¯ä½¿ç”¨ã€‚</li><li>æŸ¥è¯¢ç©ºé—´æˆå‘˜åˆ—è¡¨ï¼šä»…æ‹¥æœ‰æˆå‘˜ç®¡ç†æƒé™çš„ç”¨æˆ·å¯ä½¿ç”¨ã€‚</li><li>ç¼–è¾‘æˆå‘˜ä¿¡æ¯ï¼šä»…æ‹¥æœ‰æˆå‘˜ç®¡ç†æƒé™çš„ç”¨æˆ·å¯ä½¿ç”¨ã€‚</li><li>æŸ¥è¯¢æˆ‘åŠ å…¥çš„å›¢é˜Ÿç©ºé—´åˆ—è¡¨ï¼šæ‰€æœ‰å·²ç™»å½•ç”¨æˆ·å¯ä½¿ç”¨ã€‚</li></ul><h3 id="ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶" tabindex="-1"><a class="header-anchor" href="#ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶" aria-hidden="true">#</a> ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶</h3><h4 id="_1ã€æƒé™å®šä¹‰" tabindex="-1"><a class="header-anchor" href="#_1ã€æƒé™å®šä¹‰" aria-hidden="true">#</a> 1ã€æƒé™å®šä¹‰</h4><p>æ ¹æ® RBAC æƒé™æ¨¡å‹ï¼Œéœ€è¦å®šä¹‰è§’è‰²å’Œæƒé™ã€‚</p><p>1ï¼‰æˆ‘è¿™é‡Œä¸ºäº†ç®€å•ç‚¹ï¼Œç”¨ JSON é…ç½®æ–‡ä»¶æ¥å®šä¹‰è§’è‰²ã€æƒé™ã€è§’è‰²å’Œæƒé™ä¹‹é—´çš„å…³ç³»ï¼Œç›¸æ¯”ä»æ•°æ®åº“è¡¨ä¸­è·å–ï¼Œå®ç°æ›´æ–¹ä¾¿ï¼ŒæŸ¥è¯¢ä¹Ÿæ›´é«˜æ•ˆã€‚</p><p>åœ¨ <code>resources/biz</code> ç›®å½•ä¸‹æ–°å»º JSON é…ç½®æ–‡ä»¶ <code>spaceUserAuthConfig.json</code>ï¼š</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221438160.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;spaceUser:manage&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;æˆå‘˜ç®¡ç†&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ç®¡ç†ç©ºé—´æˆå‘˜ï¼Œæ·»åŠ æˆ–ç§»é™¤æˆå‘˜&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;picture:view&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;æŸ¥çœ‹å›¾ç‰‡&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;æŸ¥çœ‹ç©ºé—´ä¸­çš„å›¾ç‰‡å†…å®¹&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;picture:upload&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ä¸Šä¼ å›¾ç‰‡&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ä¸Šä¼ å›¾ç‰‡åˆ°ç©ºé—´ä¸­&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;picture:edit&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ä¿®æ”¹å›¾ç‰‡&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ç¼–è¾‘å·²ä¸Šä¼ çš„å›¾ç‰‡ä¿¡æ¯&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;picture:delete&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;åˆ é™¤å›¾ç‰‡&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;åˆ é™¤ç©ºé—´ä¸­çš„å›¾ç‰‡&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;roles&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;viewer&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;æµè§ˆè€…&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;picture:view&quot;</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;æŸ¥çœ‹å›¾ç‰‡&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;editor&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ç¼–è¾‘è€…&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;picture:view&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;picture:upload&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;picture:edit&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;picture:delete&quot;</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;æŸ¥çœ‹å›¾ç‰‡ã€ä¸Šä¼ å›¾ç‰‡ã€ä¿®æ”¹å›¾ç‰‡ã€åˆ é™¤å›¾ç‰‡&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ç®¡ç†å‘˜&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;spaceUser:manage&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;picture:view&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;picture:upload&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;picture:edit&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;picture:delete&quot;</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;æˆå‘˜ç®¡ç†ã€æŸ¥çœ‹å›¾ç‰‡ã€ä¸Šä¼ å›¾ç‰‡ã€ä¿®æ”¹å›¾ç‰‡ã€åˆ é™¤å›¾ç‰‡&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2ï¼‰åœ¨ <code>auth.model</code> åŒ…ä¸‹æ–°å»ºæ•°æ®æ¨¡å‹ï¼Œç”¨äºæ¥æ”¶é…ç½®æ–‡ä»¶çš„å€¼ã€‚</p><p>æƒé™é…ç½®ç±»ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpaceUserAuthConfig</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * æƒé™åˆ—è¡¨
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpaceUserPermission</span><span class="token punctuation">&gt;</span></span> permissions<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * è§’è‰²åˆ—è¡¨
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpaceUserRole</span><span class="token punctuation">&gt;</span></span> roles<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç©ºé—´æˆå‘˜æƒé™ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpaceUserPermission</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * æƒé™é”®
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> key<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æƒé™åç§°
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æƒé™æè¿°
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> description<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç©ºé—´æˆå‘˜è§’è‰²ï¼šLeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpaceUserRole</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * è§’è‰²é”®
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> key<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * è§’è‰²åç§°
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æƒé™é”®åˆ—è¡¨
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> permissions<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * è§’è‰²æè¿°
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> description<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3ï¼‰å®šä¹‰ç©ºé—´æˆå‘˜æƒé™å¸¸é‡ç±»ï¼Œ<mark>ä¾¿äºåç»­æ ¡éªŒæƒé™æ—¶ä½¿ç”¨</mark>ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SpaceUserPermissionConstant</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * ç©ºé—´ç”¨æˆ·ç®¡ç†æƒé™
     */</span>
    <span class="token class-name">String</span> <span class="token constant">SPACE_USER_MANAGE</span> <span class="token operator">=</span> <span class="token string">&quot;spaceUser:manage&quot;</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * å›¾ç‰‡æŸ¥çœ‹æƒé™
     */</span>
    <span class="token class-name">String</span> <span class="token constant">PICTURE_VIEW</span> <span class="token operator">=</span> <span class="token string">&quot;picture:view&quot;</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * å›¾ç‰‡ä¸Šä¼ æƒé™
     */</span>
    <span class="token class-name">String</span> <span class="token constant">PICTURE_UPLOAD</span> <span class="token operator">=</span> <span class="token string">&quot;picture:upload&quot;</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * å›¾ç‰‡ç¼–è¾‘æƒé™
     */</span>
    <span class="token class-name">String</span> <span class="token constant">PICTURE_EDIT</span> <span class="token operator">=</span> <span class="token string">&quot;picture:edit&quot;</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * å›¾ç‰‡åˆ é™¤æƒé™
     */</span>
    <span class="token class-name">String</span> <span class="token constant">PICTURE_DELETE</span> <span class="token operator">=</span> <span class="token string">&quot;picture:delete&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4ï¼‰åœ¨ <code>auth</code> åŒ…ä¸‹æ–°å»º SpaceUserAuthManagerï¼Œå¯åŠ è½½é…ç½®æ–‡ä»¶åˆ°å¯¹è±¡ï¼Œå¹¶æä¾›æ ¹æ®è§’è‰²è·å–æƒé™åˆ—è¡¨çš„æ–¹æ³•ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpaceUserAuthManager</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">SpaceUserService</span> spaceUserService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">SpaceUserAuthConfig</span> <span class="token constant">SPACE_USER_AUTH_CONFIG</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token class-name">ResourceUtil</span><span class="token punctuation">.</span><span class="token function">readUtf8Str</span><span class="token punctuation">(</span><span class="token string">&quot;biz/spaceUserAuthConfig.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">SPACE_USER_AUTH_CONFIG</span> <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">SpaceUserAuthConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * æ ¹æ®è§’è‰²è·å–æƒé™åˆ—è¡¨
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPermissionsByRole</span><span class="token punctuation">(</span><span class="token class-name">String</span> spaceUserRole<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>spaceUserRole<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// æ‰¾åˆ°åŒ¹é…çš„è§’è‰²</span>
        <span class="token class-name">SpaceUserRole</span> role <span class="token operator">=</span> <span class="token constant">SPACE_USER_AUTH_CONFIG</span><span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> spaceUserRole<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>role <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> role<span class="token punctuation">.</span><span class="token function">getPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2ã€sa-token" tabindex="-1"><a class="header-anchor" href="#_2ã€sa-token" aria-hidden="true">#</a> 2ã€Sa-Token</h4><p>Sa-Token æ˜¯ä¸€ä¸ªè½»é‡çº§ Java æƒé™è®¤è¯æ¡†æ¶ï¼Œç›¸æ¯” Spring Security ç­‰æ›´åŠ ç®€å•æ˜“å­¦ï¼Œç”¨ä½œè€…çš„è¯è¯´ï¼Œä½¿ç”¨è¯¥æ¡†æ¶å¯ä»¥è®©é‰´æƒå˜å¾—ç®€å•ã€ä¼˜é›…~</p><p>å­¦ä¹ å¹¶ä¸éš¾ï¼Œå‚è€ƒ <a href="https://sa-token.cc/doc.html#/start/example" target="_blank" rel="noopener noreferrer">å®˜æ–¹æ–‡æ¡£<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> å°±å¥½</p><p>1ï¼‰å¼•å…¥ Sa-Tokenï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- Sa-Token æƒé™è®¤è¯ --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.dev33<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sa-token-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.39.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Sa-Token é»˜è®¤å°†æ•°æ®ï¼ˆæ¯”å¦‚ç”¨æˆ·ç™»å½•æ€ï¼‰ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œæ­¤æ¨¡å¼è¯»å†™é€Ÿåº¦æœ€å¿«ï¼Œä¸”é¿å…äº†åºåˆ—åŒ–ä¸ååºåˆ—åŒ–å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ï¼Œä½†ç¼ºç‚¹æ˜¯é‡å¯åæ•°æ®ä¼šä¸¢å¤±ã€æ— æ³•åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­å…±äº«æ•°æ®ã€‚</p><p>æˆ‘ä»¬é¡¹ç›®ä¸­æ—¢ç„¶å·²ç»ä½¿ç”¨äº† Redisï¼Œé‚£ä¹ˆå¯ä»¥ <a href="https://sa-token.cc/doc.html#/up/integ-redis" target="_blank" rel="noopener noreferrer">å‚è€ƒå®˜æ–¹æ–‡æ¡£<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> è®© Sa-Token æ•´åˆ Redisï¼Œå°†ç”¨æˆ·çš„ç™»å½•æ€ç­‰å†…å®¹ä¿å­˜åœ¨ Redis ä¸­ã€‚</p><p>æ­¤å¤„é€‰æ‹© jackson åºåˆ—åŒ–æ–¹å¼æ•´åˆ Redisï¼Œè¿™æ ·å­˜åˆ° Redis çš„æ•°æ®æ˜¯å¯è¯»çš„ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- Sa-Token æ•´åˆ Redis ï¼ˆä½¿ç”¨ jackson åºåˆ—åŒ–æ–¹å¼ï¼‰ --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.dev33<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sa-token-redis-jackson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.39.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- æä¾›Redisè¿æ¥æ±  --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2ï¼‰äº†è§£ Sa-Token çš„åŸºæœ¬ç”¨æ³•</p><p>Sa-Token çš„ä½¿ç”¨æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆæ˜¯ç”¨æˆ·ç™»å½•æ—¶è°ƒç”¨ login æ–¹æ³•ï¼Œäº§ç”Ÿä¸€ä¸ªæ–°çš„ä¼šè¯ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">StpUtil</span><span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token number">10001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>åªæ­¤ä¸€å¥ä»£ç ï¼Œä¾¿å¯ä»¥ä½¿ä¼šè¯ç™»å½•æˆåŠŸï¼Œå®é™…ä¸Šï¼ŒSa-Token åœ¨èƒŒååšäº†å¤§é‡çš„å·¥ä½œï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š</p><ol><li>æ£€æŸ¥æ­¤è´¦å·æ˜¯å¦ä¹‹å‰å·²æœ‰ç™»å½•ï¼›</li><li>ä¸ºè´¦å·ç”Ÿæˆ <code>Token</code> å‡­è¯ä¸ <code>Session</code> ä¼šè¯ï¼›</li><li>è®°å½• Token æ´»è·ƒæ—¶é—´ï¼›</li><li>é€šçŸ¥å…¨å±€ä¾¦å¬å™¨ï¼Œxx è´¦å·ç™»å½•æˆåŠŸï¼›</li><li>å°† <code>Token</code> æ³¨å…¥åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡ï¼›</li><li>ç­‰ç­‰å…¶å®ƒå·¥ä½œâ€¦â€¦</li></ol><p>ä½ æš‚æ—¶ä¸éœ€è¦å®Œæ•´äº†è§£æ•´ä¸ªç™»å½•è¿‡ç¨‹ï¼Œä½ åªéœ€è¦è®°ä½å…³é”®ä¸€ç‚¹ï¼š<code>Sa-Token ä¸ºè¿™ä¸ªè´¦å·åˆ›å»ºäº†ä¸€ä¸ªTokenå‡­è¯ï¼Œä¸”é€šè¿‡ Cookie ä¸Šä¸‹æ–‡è¿”å›ç»™äº†å‰ç«¯</code>ã€‚</p><p>è¿˜å¯ä»¥ç»™ä¼šè¯ä¿å­˜ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">StpUtil</span><span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥ä½ å°±å¯ä»¥åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•ã€è·å–ç”¨æˆ·ä¿¡æ¯äº†ï¼Œå¯ä»¥é€šè¿‡ä»£ç è¿›è¡Œåˆ¤æ–­ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// æ£€éªŒå½“å‰ä¼šè¯æ˜¯å¦å·²ç»ç™»å½•, å¦‚æœæœªç™»å½•ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼š`NotLoginException`</span>
<span class="token class-name">StpUtil</span><span class="token punctuation">.</span><span class="token function">checkLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// è·å–ç”¨æˆ·ä¿¡æ¯</span>
<span class="token class-name">StpUtil</span><span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¹Ÿå¯ä»¥å‚è€ƒ <a href="https://sa-token.cc/doc.html#/use/at-check" target="_blank" rel="noopener noreferrer">å®˜æ–¹æ–‡æ¡£<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼Œä½¿ç”¨æ³¨è§£è¿›è¡Œé‰´æƒï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ç™»å½•æ ¡éªŒï¼šåªæœ‰ç™»å½•ä¹‹åæ‰èƒ½è¿›å…¥è¯¥æ–¹æ³• </span>
<span class="token annotation punctuation">@SaCheckLogin</span>                        
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;info&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ˜¯ Sa-Token æœ€åŸºæœ¬çš„ç”¨æ³•ï¼Œä¸‹é¢æˆ‘ä»¬æ­£å¼åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ Sa-Tokenã€‚</p><h4 id="_3ã€æ–°å»ºç©ºé—´è´¦å·ä½“ç³»" tabindex="-1"><a class="header-anchor" href="#_3ã€æ–°å»ºç©ºé—´è´¦å·ä½“ç³»" aria-hidden="true">#</a> 3ã€æ–°å»ºç©ºé—´è´¦å·ä½“ç³»</h4><p>ç›®å‰ï¼Œé¡¹ç›®ä¸­å…¶å®å­˜åœ¨ä¸¤å¥—æƒé™æ ¡éªŒä½“ç³»ã€‚ä¸€å¥—æ˜¯æœ€å¼€å§‹å°±æœ‰çš„ï¼Œå¯¹ user è¡¨çš„è§’è‰²è¿›è¡Œæ ¡éªŒï¼Œåˆ†ä¸ºæ™®é€šç”¨æˆ·å’Œç®¡ç†å‘˜ï¼›å¦ä¸€å¥—æ˜¯ç°åœ¨å‡†å¤‡ç”¨çš„ï¼Œå¯¹å›¢é˜Ÿç©ºé—´çš„æƒé™è¿›è¡Œæ ¡éªŒã€‚</p><p>ä¸ºäº†æ›´è½»æ¾åœ°æ‰©å±•é¡¹ç›®ï¼Œå‡å°‘å¯¹åŸæœ‰ä»£ç çš„æ”¹åŠ¨ï¼Œæˆ‘ä»¬åŸæœ‰çš„ user è¡¨æƒé™æ ¡éªŒä¾ç„¶ä½¿ç”¨è‡ªå®šä¹‰æ³¨è§£ + AOP çš„æ–¹å¼å®ç°ã€‚è€Œå›¢é˜Ÿç©ºé—´æƒé™æ ¡éªŒï¼Œé‡‡ç”¨ Sa-Token æ¥ç®¡ç†ã€‚</p><p>ç›¸å½“äºæˆ‘ä»¬ä¸æ˜¯æ•´ä¸ªé¡¹ç›®éƒ½äº¤ç»™ Sa-Tokenï¼Œåªæ˜¯æŠŠ Sa-Token å½“åšå®ç°å›¢é˜Ÿç©ºé—´æƒé™ç®¡ç†çš„å·¥å…·ç½¢äº†ã€‚</p><p>è¿™ç§åŒä¸€é¡¹ç›®æœ‰å¤šè´¦å·ä½“ç³»çš„æƒ…å†µä¸‹ï¼Œä¸å»ºè®®ä½¿ç”¨ Sa-Token é»˜è®¤çš„è´¦å·ä½“ç³»ï¼Œè€Œæ˜¯ä½¿ç”¨ Sa-Token æä¾›çš„ <a href="https://sa-token.cc/doc.html#/up/many-account?id=_5%E3%80%81kit%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener noreferrer">å¤šè´¦å·è®¤è¯ç‰¹æ€§<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼Œå¯ä»¥å°†å¤šå¥—è´¦å·çš„æˆæƒç»™åŒºåˆ†å¼€ï¼Œè®©å®ƒä»¬äº’ä¸å¹²æ‰°ã€‚</p><blockquote><p>å®˜æ–¹æ–‡æ¡£ä¸­ï¼š</p><p><strong>æ¼”è¿›æ€è·¯</strong></p><p>å‡å¦‚è¯´æˆ‘ä»¬çš„ userè¡¨ å’Œ adminè¡¨ éƒ½æœ‰ä¸€ä¸ª id=10001 çš„è´¦å·ï¼Œå®ƒä»¬å¯¹åº”çš„ç™»å½•ä»£ç ï¼š<code>StpUtil.login(10001)</code> æ˜¯ä¸€æ ·çš„ï¼Œ é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šåœ¨<code>StpUtil.getLoginId()</code>è·å–åˆ°çš„è´¦å·idå¦‚ä½•åŒºåˆ†å®ƒæ˜¯Userç”¨æˆ·ï¼Œè¿˜æ˜¯Adminç”¨æˆ·ï¼Ÿ</p><p>ä½ å¯èƒ½ä¼šæƒ³åˆ°ä¸ºä»–ä»¬åŠ ä¸€ä¸ªå›ºå®šå‰ç¼€ï¼Œæ¯”å¦‚<code>StpUtil.login(&quot;User_&quot; + 10001)</code>ã€<code>StpUtil.login(&quot;Admin_&quot; + 10001)</code>ï¼Œè¿™æ ·ç¡®å®æ˜¯å¯ä»¥è§£å†³é—®é¢˜çš„ï¼Œ ä½†æ˜¯åŒæ ·çš„ï¼šä½ éœ€è¦åœ¨<code>StpUtil.getLoginId()</code>æ—¶å†è£å‰ªæ‰ç›¸åº”çš„å‰ç¼€æ‰èƒ½è·å–çœŸæ­£çš„è´¦å·idï¼Œè¿™æ ·ä¸€å¢ä¸€å‡å°±è®©æˆ‘ä»¬çš„ä»£ç å˜å¾—æ— æ¯”å•°å—¦ã€‚</p><p>é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰ä»æ¡†æ¶å±‚é¢æ”¯æŒçš„ï¼Œæ›´ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆå‘¢ï¼Ÿ</p></blockquote><p>1ï¼‰å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œä½¿ç”¨ <a href="https://sa-token.cc/doc.html#/up/many-account?id=_5%E3%80%81kit%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener noreferrer">Kit æ¨¡å¼<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> å®ç°å¤šè´¦å·è®¤è¯ï¼Œåœ¨ <code>auth</code> åŒ…ä¸‹æ–°å»º <code>StpKit.java</code>ï¼Œå®šä¹‰ç©ºé—´è´¦å·ä½“ç³»ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * StpLogic é—¨é¢ç±»ï¼Œç®¡ç†é¡¹ç›®ä¸­æ‰€æœ‰çš„ StpLogic è´¦å·ä½“ç³»
 * æ·»åŠ  @Component æ³¨è§£çš„ç›®çš„æ˜¯ç¡®ä¿é™æ€å±æ€§ DEFAULT å’Œ SPACE è¢«åˆå§‹åŒ–
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StpKit</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SPACE_TYPE</span> <span class="token operator">=</span> <span class="token string">&quot;space&quot;</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * é»˜è®¤åŸç”Ÿä¼šè¯å¯¹è±¡ï¼Œé¡¹ç›®ä¸­ç›®å‰æ²¡ä½¿ç”¨åˆ°
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">StpLogic</span> <span class="token constant">DEFAULT</span> <span class="token operator">=</span> <span class="token class-name">StpUtil</span><span class="token punctuation">.</span>stpLogic<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * Space ä¼šè¯å¯¹è±¡ï¼Œç®¡ç† Space è¡¨æ‰€æœ‰è´¦å·çš„ç™»å½•ã€æƒé™è®¤è¯
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">StpLogic</span> <span class="token constant">SPACE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StpLogic</span><span class="token punctuation">(</span><span class="token constant">SPACE_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¹‹åå°±å¯ä»¥åœ¨ä»£ç ä¸­ä½¿ç”¨è´¦å·ä½“ç³»ï¼Œä»¥ä¸‹æ˜¯ç¤ºä¾‹ä»£ç ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// åœ¨å½“å‰ä¼šè¯è¿›è¡Œ Space è´¦å·ç™»å½•</span>
<span class="token class-name">StpKit</span><span class="token punctuation">.</span><span class="token constant">SPACE</span><span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token number">10001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// æ£€æµ‹å½“å‰ä¼šè¯æ˜¯å¦ä»¥ Space è´¦å·ç™»å½•ï¼Œå¹¶å…·æœ‰ picture:edit æƒé™</span>
<span class="token class-name">StpKit</span><span class="token punctuation">.</span><span class="token constant">SPACE</span><span class="token punctuation">.</span><span class="token function">checkPermission</span><span class="token punctuation">(</span><span class="token string">&quot;picture:edit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è·å–å½“å‰ Space ä¼šè¯çš„ Session å¯¹è±¡ï¼Œå¹¶è¿›è¡Œå†™å€¼æ“ä½œ </span>
<span class="token class-name">StpKit</span><span class="token punctuation">.</span><span class="token constant">SPACE</span><span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ç¨‹åºå‘˜ç§¦ä¸€&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2ï¼‰ä¿®æ”¹ç”¨æˆ·æœåŠ¡çš„ userLogin æ–¹æ³•ï¼Œç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œä¿å­˜ç™»å½•æ€åˆ° Sa-Token çš„ç©ºé—´è´¦å·ä½“ç³»ä¸­ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 3. è®°å½•ç”¨æˆ·çš„ç™»å½•æ€</span>
request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">USER_LOGIN_STATE</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 4. è®°å½•ç”¨æˆ·ç™»å½•æ€åˆ° Sa-tokenï¼Œä¾¿äºç©ºé—´é‰´æƒæ—¶ä½¿ç”¨ï¼Œæ³¨æ„ä¿è¯è¯¥ç”¨æˆ·ä¿¡æ¯ä¸ SpringSession ä¸­çš„ä¿¡æ¯è¿‡æœŸæ—¶é—´ä¸€è‡´</span>
<span class="token class-name">StpKit</span><span class="token punctuation">.</span><span class="token constant">SPACE</span><span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">StpKit</span><span class="token punctuation">.</span><span class="token constant">SPACE</span><span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">USER_LOGIN_STATE</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLoginUserVO</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4ã€æƒé™è®¤è¯é€»è¾‘" tabindex="-1"><a class="header-anchor" href="#_4ã€æƒé™è®¤è¯é€»è¾‘" aria-hidden="true">#</a> 4ã€æƒé™è®¤è¯é€»è¾‘</h4><p>Sa-Token å¼€å‘çš„æ ¸å¿ƒæ˜¯ç¼–å†™æƒé™è®¤è¯ç±»ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¯¥ç±»ä¸­å®ç° â€œå¦‚ä½•æ ¹æ®ç™»å½•ç”¨æˆ· id è·å–åˆ°ç”¨æˆ·å·²æœ‰çš„è§’è‰²å’Œæƒé™åˆ—è¡¨â€ æ–¹æ³•ã€‚å½“è¦åˆ¤æ–­æŸç”¨æˆ·æ˜¯å¦æœ‰æŸä¸ªè§’è‰²æˆ–æƒé™æ—¶ï¼ŒSa-Token ä¼šå…ˆæ‰§è¡Œæˆ‘ä»¬ç¼–å†™çš„æ–¹æ³•ï¼Œå¾—åˆ°è¯¥ç”¨æˆ·çš„è§’è‰²æˆ–æƒé™åˆ—è¡¨ï¼Œç„¶åè·Ÿéœ€è¦çš„è§’è‰²æƒé™è¿›è¡Œæ¯”å¯¹ã€‚</p><p>å‚è€ƒ <a href="https://sa-token.cc/doc.html#/use/jur-auth" target="_blank" rel="noopener noreferrer">å®˜æ–¹æ–‡æ¡£<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼Œç¤ºä¾‹æƒé™è®¤è¯ç±»å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * è‡ªå®šä¹‰æƒé™åŠ è½½æ¥å£å®ç°ç±»
 */</span>
<span class="token annotation punctuation">@Component</span>    <span class="token comment">// ä¿è¯æ­¤ç±»è¢« SpringBoot æ‰«æï¼Œå®Œæˆ Sa-Token çš„è‡ªå®šä¹‰æƒé™éªŒè¯æ‰©å±• </span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StpInterfaceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">StpInterface</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * è¿”å›ä¸€ä¸ªè´¦å·æ‰€æ‹¥æœ‰çš„æƒé™ç é›†åˆ 
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPermissionList</span><span class="token punctuation">(</span><span class="token class-name">Object</span> loginId<span class="token punctuation">,</span> <span class="token class-name">String</span> loginType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æœ¬ list ä»…åšæ¨¡æ‹Ÿï¼Œå®é™…é¡¹ç›®ä¸­è¦æ ¹æ®å…·ä½“ä¸šåŠ¡é€»è¾‘æ¥æŸ¥è¯¢æƒé™</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;user.add&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;user.update&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;user.get&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;art.*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * è¿”å›ä¸€ä¸ªè´¦å·æ‰€æ‹¥æœ‰çš„è§’è‰²æ ‡è¯†é›†åˆ (æƒé™ä¸è§’è‰²å¯åˆ†å¼€æ ¡éªŒ)
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getRoleList</span><span class="token punctuation">(</span><span class="token class-name">Object</span> loginId<span class="token punctuation">,</span> <span class="token class-name">String</span> loginType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æœ¬ list ä»…åšæ¨¡æ‹Ÿï¼Œå®é™…é¡¹ç›®ä¸­è¦æ ¹æ®å…·ä½“ä¸šåŠ¡é€»è¾‘æ¥æŸ¥è¯¢è§’è‰²</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;super-admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Sa-Token æ”¯æŒæŒ‰ç…§è§’è‰²å’Œæƒé™æ ¡éªŒï¼Œå¯¹äºæƒé™ä¸å¤šçš„é¡¹ç›®ï¼ŒåŸºäºè§’è‰²æ ¡éªŒå³å¯ï¼›å¯¹äºæƒé™è¾ƒå¤šçš„é¡¹ç›®ï¼Œå»ºè®®æ ¹æ®æƒé™æ ¡éªŒã€‚å¯¹äºæœ¬é¡¹ç›®ï¼Œè™½ç„¶æƒé™å¹¶ä¸å¤šï¼Œä½†æ˜¯è€ƒè™‘åˆ°æ‰©å±•æ€§ï¼Œè¿˜æ˜¯ <strong>é€‰æ‹©æ›´ç»†ç²’åº¦çš„æƒé™æ ¡éªŒ</strong>ï¼Œä¸šåŠ¡å«ä¹‰ä¼šæ›´æ˜ç¡®ã€‚</p><p>è§‚å¯Ÿä¸Šè¿°ä»£ç æˆ‘ä»¬ä¼šå‘ç°ï¼Œ<code>getPermissionList</code> æ–¹æ³•åªæä¾›äº† loginIdï¼ˆç™»å½•ç”¨æˆ· idï¼‰å’Œ loginTypeï¼ˆè´¦å·ä½“ç³»ï¼‰ä¸¤ä¸ªå‚æ•°ã€‚è¿™ä¼šç»™æˆ‘ä»¬é€ æˆå¾ˆå¤§çš„éš¾åº¦ï¼š</p><ul><li>å…‰æœ‰ç”¨æˆ· id æ˜¯æ²¡åŠæ³•è¿›è¡Œæƒé™æ ¡éªŒçš„ï¼Œå› ä¸ºè¦ç»™å›¾ç‰‡æ“ä½œå’Œç©ºé—´æˆå‘˜æ“ä½œå¢åŠ æƒé™æ ¡éªŒé€»è¾‘ï¼Œè¿˜éœ€è¦è·å–åˆ°ç©ºé—´ idï¼Œæ‰çŸ¥é“ç”¨æˆ·æ˜¯å¦å…·æœ‰æŸä¸ªå›¢é˜Ÿç©ºé—´çš„æƒé™ã€‚<strong>é‚£ä¹ˆå¦‚ä½•è·å–åˆ°ç©ºé—´ id å‘¢ï¼Ÿ</strong></li><li>å¦‚æœè¦è¿›è¡Œç»Ÿä¸€çš„æƒé™æ ¡éªŒï¼Œä¹ŸåŒ…æ‹¬äº†å…¬å…±å›¾åº“å’Œç§æœ‰ç©ºé—´ï¼Œæ›´è¦å‘½çš„æ˜¯ï¼Œå…¬å…±å›¾åº“æ˜¯æ²¡æœ‰ç©ºé—´ id çš„ï¼<strong>è¿™å°±æ„å‘³ç€è¦æ ¹æ®æ“ä½œçš„å›¾ç‰‡æƒ…å†µåŠ¨æ€åˆ¤æ–­ã€‚</strong></li></ul><p>æ‰€ä»¥è¦è§£å†³çš„å…³é”®é—®é¢˜æœ‰ 2 ä¸ªï¼š</p><ol><li>å¦‚ä½•åœ¨ Sa-Token ä¸­è·å–å½“å‰è¯·æ±‚æ“ä½œçš„å‚æ•°ï¼Ÿ</li><li>å¦‚ä½•ç¼–å†™ä¸€å¥—æƒé™æ ¡éªŒé€»è¾‘ï¼ŒåŒæ—¶å…¼å®¹å…¬å…±å›¾åº“ã€ç§æœ‰ç©ºé—´å’Œå›¢é˜Ÿç©ºé—´ï¼Ÿ</li></ol><p><strong>1ï¼‰å…ˆçœ‹ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œä½¿ç”¨ Sa-Token æœ‰ 2 ç§æ–¹å¼ â€”â€” æ³¨è§£å¼å’Œç¼–ç¨‹å¼ã€‚</strong></p><p>å¦‚æœä½¿ç”¨æ³¨è§£å¼ï¼Œé‚£ä¹ˆåœ¨æ¥å£è¢«è°ƒç”¨æ—¶å°±ä¼šç«‹åˆ»è§¦å‘ Sa-Token çš„æƒé™æ ¡éªŒï¼Œæ­¤æ—¶å‚æ•°åªèƒ½é€šè¿‡ Servlet çš„è¯·æ±‚å¯¹è±¡ä¼ é€’ã€‚</p><p>å¦‚æœä½¿ç”¨ç¼–ç¨‹å¼ï¼Œå¯ä»¥åœ¨ä»£ç ä»»æ„ä½ç½®æ‰§è¡Œæƒé™æ ¡éªŒï¼Œåªè¦åœ¨æ‰§è¡Œå‰å°†å‚æ•°æ”¾åˆ°å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ ThreadLocal å¯¹è±¡ä¸­ï¼Œå°±èƒ½åœ¨é‰´æƒæ—¶è·å–åˆ°äº†ã€‚</p><p>ä¸ºäº†åç»­ç»™æ¥å£æ·»åŠ é‰´æƒæ›´ç›´è§‚æ–¹ä¾¿ï¼Œæˆ‘ä»¬é€‰æ‹©æ³¨è§£å¼é‰´æƒã€‚é‚£å°±æœ‰ä¸€ä¸ªå…³é”®é—®é¢˜ï¼Œä¸åŒæ¥å£çš„è¯·æ±‚å‚æ•°æ˜¯ä¸åŒçš„ï¼Œæœ‰çš„è¯·æ±‚å‚æ•°æœ‰ spaceIdã€æœ‰çš„åªæœ‰ pictureIdï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ª <strong>ä¸Šä¸‹æ–‡ç±»</strong>ï¼Œç”¨äºç»Ÿä¸€æ¥æ”¶è¯·æ±‚ä¸­ä¼ é€’æ¥çš„å‚æ•°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * SpaceUserAuthContext
 * è¡¨ç¤ºç”¨æˆ·åœ¨ç‰¹å®šç©ºé—´å†…çš„æˆæƒä¸Šä¸‹æ–‡ï¼ŒåŒ…æ‹¬å…³è”çš„å›¾ç‰‡ã€ç©ºé—´å’Œç”¨æˆ·ä¿¡æ¯ã€‚
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpaceUserAuthContext</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * ä¸´æ—¶å‚æ•°ï¼Œä¸åŒè¯·æ±‚å¯¹åº”çš„ id å¯èƒ½ä¸åŒ
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * å›¾ç‰‡ ID
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> pictureId<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * ç©ºé—´ ID
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> spaceId<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * ç©ºé—´ç”¨æˆ· ID
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> spaceUserId<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * å›¾ç‰‡ä¿¡æ¯
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Picture</span> picture<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * ç©ºé—´ä¿¡æ¯
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Space</span> space<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * ç©ºé—´ç”¨æˆ·ä¿¡æ¯
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">SpaceUser</span> spaceUser<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚ä½•çŸ¥é“å“ªä¸ªè¯·æ±‚åŒ…å«äº†å“ªäº›å­—æ®µå‘¢ï¼Ÿåˆ«å¿˜äº†ï¼Œæˆ‘ä»¬æ¯ç±»æ“ä½œï¼ˆå›¾ç‰‡ / ç©ºé—´æˆå‘˜ï¼‰çš„è¯·æ±‚å‰ç¼€éƒ½æ˜¯å›ºå®šçš„ï¼Œå¯ä»¥ä»è¯·æ±‚è·¯å¾„ä¸­æå–åˆ°è¦è®¿é—®çš„æ˜¯å“ªä¸ª Controllerï¼Œè€Œæ¯ç±» Controller çš„è¯·æ±‚å‚æ•°ï¼Œéƒ½æ˜¯ä¸€è‡´çš„ã€‚sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=J+5o58b0kn/bTqd/50F76o1L2/PhqvQWrl14ca26WW0=J+5o58b0kn/bTqd/50F76o1L2/PhqvQWrl14ca26WW0=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœè®¿é—®åœ°å€æ˜¯ <code>/api/picture/xxx</code>ï¼Œé‚£ä¹ˆä¸€å®šæ˜¯è¦è°ƒç”¨ PictureController çš„æ¥å£ï¼Œè¿™äº›æ¥å£çš„ id å­—æ®µéƒ½è¡¨ç¤º pictureIdã€‚æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è®¿é—®åœ°å€æ¥å†³å®šåº”è¯¥ç»™ä¸Šä¸‹æ–‡ä¼ é€’å“ªäº›å­—æ®µï¼Œä»£ç å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${server.servlet.context-path}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> contextPath<span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * ä»è¯·æ±‚ä¸­è·å–ä¸Šä¸‹æ–‡å¯¹è±¡
 */</span>
<span class="token keyword">private</span> <span class="token class-name">SpaceUserAuthContext</span> <span class="token function">getAuthContextByRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">currentRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> contentType <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">Header</span><span class="token punctuation">.</span><span class="token constant">CONTENT_TYPE</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SpaceUserAuthContext</span> authRequest<span class="token punctuation">;</span>
    <span class="token comment">// å…¼å®¹ get å’Œ post æ“ä½œ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>contentType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token class-name">ServletUtil</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        authRequest <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token class-name">SpaceUserAuthContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> paramMap <span class="token operator">=</span> <span class="token class-name">ServletUtil</span><span class="token punctuation">.</span><span class="token function">getParamMap</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        authRequest <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>paramMap<span class="token punctuation">,</span> <span class="token class-name">SpaceUserAuthContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ ¹æ®è¯·æ±‚è·¯å¾„åŒºåˆ† id å­—æ®µçš„å«ä¹‰</span>
    <span class="token class-name">Long</span> id <span class="token operator">=</span> authRequest<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjUtil</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> requestUri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> partUri <span class="token operator">=</span> requestUri<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>contextPath <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> moduleName <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">subBefore</span><span class="token punctuation">(</span>partUri<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">&quot;picture&quot;</span><span class="token operator">:</span>
                authRequest<span class="token punctuation">.</span><span class="token function">setPictureId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">&quot;spaceUser&quot;</span><span class="token operator">:</span>
                authRequest<span class="token punctuation">.</span><span class="token function">setSpaceUserId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">&quot;space&quot;</span><span class="token operator">:</span>
                authRequest<span class="token punctuation">.</span><span class="token function">setSpaceId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> authRequest<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„ï¼Œä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Hutool çš„å·¥å…·ç±» <code>ServletUtil</code> ä» HttpServletRequest ä¸­è·å–åˆ°äº†å‚æ•°ä¿¡æ¯ï¼Œä½†æ˜¯å‘çˆ¹çš„æ˜¯ï¼ŒHttpServletRequest çš„ body å€¼æ˜¯ä¸ªæµï¼Œ**åªæ”¯æŒè¯»å–ä¸€æ¬¡ï¼Œè¯»å®Œå°±æ²¡äº†ï¼**æ‰€ä»¥ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è¿˜è¦åœ¨ <code>config</code> åŒ…ä¸‹è‡ªå®šä¹‰è¯·æ±‚åŒ…è£…ç±»å’Œè¯·æ±‚åŒ…è£…ç±»è¿‡æ»¤å™¨ã€‚è¿™äº›å°±æ˜¯æ ·æ¿ä»£ç äº†ï¼Œå¤§å®¶ç›´æ¥å¤åˆ¶ç²˜è´´å³å¯ï¼Œä¸ç”¨ç¼–ç ã€‚J+5o58b0kn/bTqd/50F76o1L2/PhqvQWrl14ca26WW0=3n/Enp4sfaVRq/PFMJKPxPdBTxeNas/Bp33wsl/l9Wg=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=3n/Enp4sfaVRq/PFMJKPxPdBTxeNas/Bp33wsl/l9Wg=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=58IUDBvyDy7G+gVMqAunJfAo72ZBX//2DD/nhaX54Xg=J+5o58b0kn/bTqd/50F76o1L2/PhqvQWrl14ca26WW0=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=58IUDBvyDy7G+gVMqAunJfAo72ZBX//2DD/nhaX54Xg=3n/Enp4sfaVRq/PFMJKPxPdBTxeNas/Bp33wsl/l9Wg=</p><p>RequestWrapper è¯·æ±‚åŒ…è£…ç±»ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>â–¼javaå¤åˆ¶ä»£ç <span class="token doc-comment comment">/**
 * åŒ…è£…è¯·æ±‚ï¼Œä½¿ InputStream å¯ä»¥é‡å¤è¯»å–
 *
 * <span class="token keyword">@author</span> pine
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RequestWrapper</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServletRequestWrapper</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> body<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RequestWrapper</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StringBuilder</span> stringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">BufferedReader</span> bufferedReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> charBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> bytesRead <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bytesRead <span class="token operator">=</span> bufferedReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>charBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>charBuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bytesRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        body <span class="token operator">=</span> stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ServletInputStream</span> <span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">ByteArrayInputStream</span> byteArrayInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServletInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setReadListener</span><span class="token punctuation">(</span><span class="token class-name">ReadListener</span> readListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> byteArrayInputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">BufferedReader</span> <span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>HttpRequestWrapperFilter è¯·æ±‚åŒ…è£…è¿‡æ»¤å™¨ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>â–¼javaå¤åˆ¶ä»£ç <span class="token doc-comment comment">/**
 * è¯·æ±‚åŒ…è£…è¿‡æ»¤å™¨
 *
 * <span class="token keyword">@author</span> pine
 */</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpRequestWrapperFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>request <span class="token keyword">instanceof</span> <span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">HttpServletRequest</span> servletRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">;</span>
            <span class="token class-name">String</span> contentType <span class="token operator">=</span> servletRequest<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">Header</span><span class="token punctuation">.</span><span class="token constant">CONTENT_TYPE</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>contentType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å¯ä»¥å†ç»†ç²’åº¦ä¸€äº›ï¼Œåªæœ‰éœ€è¦è¿›è¡Œç©ºé—´æƒé™æ ¡éªŒçš„æ¥å£æ‰éœ€è¦åŒ…ä¸€å±‚</span>
                chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RequestWrapper</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·æˆ‘ä»¬å°±èƒ½æ­£å¸¸è·å–åˆ°è¯·æ±‚å‚æ•°äº†~</p><p><strong>2ï¼‰ç¼–å†™é€šç”¨çš„æƒé™æ ¡éªŒé€»è¾‘ï¼Œå…¼å®¹å…¬å…±å›¾åº“ã€ç§æœ‰ç©ºé—´å’Œå›¢é˜Ÿç©ºé—´</strong></p><p>è¿™ä¸ªæ²¡å•¥å¥½è¯´çš„ï¼Œå°±æ˜¯å†™ä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸”æ˜¯æ¯”è¾ƒå¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ‰€ä»¥å»ºè®®ä¸€å®šè¦å…ˆæŠŠä¸šåŠ¡æµç¨‹æ¢³ç†æ¸…æ¥šï¼Œå†ç¼–å†™ä»£ç ã€‚</p><p>ä¸šåŠ¡æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>æ ¡éªŒç™»å½•ç±»å‹ï¼šå¦‚æœ <code>loginType</code> ä¸æ˜¯ <code>&quot;space&quot;</code>ï¼Œç›´æ¥è¿”å›ç©ºæƒé™åˆ—è¡¨ã€‚</li><li>ç®¡ç†å‘˜æƒé™å¤„ç†ï¼šå¦‚æœå½“å‰ç”¨æˆ·ä¸ºç®¡ç†å‘˜ï¼Œç›´æ¥è¿”å›ç®¡ç†å‘˜æƒé™åˆ—è¡¨ã€‚</li><li>è·å–ä¸Šä¸‹æ–‡å¯¹è±¡ï¼šä»è¯·æ±‚ä¸­è·å– <code>SpaceUserAuthContext</code> ä¸Šä¸‹æ–‡ï¼Œæ£€æŸ¥ä¸Šä¸‹æ–‡å­—æ®µæ˜¯å¦ä¸ºç©ºã€‚<strong>å¦‚æœä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰å­—æ®µå‡ä¸ºç©ºï¼ˆå¦‚æ²¡æœ‰ç©ºé—´æˆ–å›¾ç‰‡ä¿¡æ¯ï¼‰ï¼Œè§†ä¸ºå…¬å…±å›¾åº“æ“ä½œï¼Œç›´æ¥è¿”å›ç®¡ç†å‘˜æƒé™åˆ—è¡¨ã€‚</strong></li><li>æ ¡éªŒç™»å½•çŠ¶æ€ï¼šé€šè¿‡ <code>loginId</code> è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ã€‚å¦‚æœç”¨æˆ·æœªç™»å½•ï¼ŒæŠ›å‡ºæœªæˆæƒå¼‚å¸¸ï¼›å¦åˆ™è·å–ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯† <code>userId</code>ï¼Œç”¨äºåç»­æƒé™åˆ¤æ–­ã€‚</li><li>ä»ä¸Šä¸‹æ–‡ä¸­ä¼˜å…ˆè·å– <code>SpaceUser</code> å¯¹è±¡ï¼šå¦‚æœä¸Šä¸‹æ–‡ä¸­å­˜åœ¨ <code>SpaceUser</code> å¯¹è±¡ï¼Œç›´æ¥æ ¹æ®å…¶è§’è‰²è·å–æƒé™ç åˆ—è¡¨ã€‚</li><li>é€šè¿‡ <code>spaceUserId</code> è·å–ç©ºé—´ç”¨æˆ·ä¿¡æ¯ï¼šå¦‚æœä¸Šä¸‹æ–‡ä¸­å­˜åœ¨ <code>spaceUserId</code>ï¼š</li></ol><ul><li>æŸ¥è¯¢å¯¹åº”çš„ <code>SpaceUser</code> æ•°æ®ã€‚å¦‚æœæœªæ‰¾åˆ°ï¼ŒæŠ›å‡ºæ•°æ®æœªæ‰¾åˆ°å¼‚å¸¸ã€‚</li><li>æ ¡éªŒå½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å±äºè¯¥ç©ºé—´ï¼Œå¦‚æœä¸æ˜¯ï¼Œè¿”å›ç©ºæƒé™åˆ—è¡¨ã€‚</li><li>å¦åˆ™ï¼Œæ ¹æ®ç™»å½•ç”¨æˆ·åœ¨è¯¥ç©ºé—´çš„è§’è‰²ï¼Œè¿”å›ç›¸åº”çš„æƒé™ç åˆ—è¡¨ã€‚</li></ul><ol><li>é€šè¿‡ <code>spaceId</code> æˆ– <code>pictureId</code> è·å–ç©ºé—´æˆ–å›¾ç‰‡ä¿¡æ¯</li></ol><ul><li>å¦‚æœ <code>spaceId</code> ä¸å­˜åœ¨ï¼šä½¿ç”¨ <code>pictureId</code> æŸ¥è¯¢å›¾ç‰‡ä¿¡æ¯ï¼Œå¹¶é€šè¿‡å›¾ç‰‡çš„ <code>spaceId</code> ç»§ç»­åˆ¤æ–­æƒé™ï¼›å¦‚æœ <code>pictureId</code> å’Œ <code>spaceId</code> å‡ä¸ºç©ºï¼Œé»˜è®¤è§†ä¸ºç®¡ç†å‘˜æƒé™ã€‚</li><li>å¯¹äºå…¬å…±å›¾åº“ï¼š<strong>å¦‚æœå›¾ç‰‡æ˜¯å½“å‰ç”¨æˆ·ä¸Šä¼ çš„ï¼Œæˆ–è€…å½“å‰ç”¨æˆ·ä¸ºç®¡ç†å‘˜</strong>ï¼Œè¿”å›ç®¡ç†å‘˜æƒé™åˆ—è¡¨ï¼›å¦‚æœå›¾ç‰‡ä¸æ˜¯å½“å‰ç”¨æˆ·ä¸Šä¼ çš„ï¼Œè¿”å›ä»…å…è®¸æŸ¥çœ‹çš„æƒé™ç ã€‚</li></ul><ol><li>è·å– <code>Space</code> å¯¹è±¡å¹¶åˆ¤æ–­ç©ºé—´ç±»å‹ï¼šæŸ¥è¯¢ <code>Space</code> ä¿¡æ¯ï¼Œå¦‚æœæœªæ‰¾åˆ°ç©ºé—´æ•°æ®ï¼ŒæŠ›å‡ºæ•°æ®æœªæ‰¾åˆ°å¼‚å¸¸ã€‚å¦åˆ™æ ¹æ®ç©ºé—´ç±»å‹è¿›è¡Œåˆ¤æ–­</li></ol><ul><li>ç§æœ‰ç©ºé—´ï¼šä»…ç©ºé—´æ‰€æœ‰è€…å’Œç®¡ç†å‘˜æœ‰æƒé™ï¼ˆå³è¿”å›å…¨éƒ¨æƒé™ï¼‰ï¼Œå…¶ä»–ç”¨æˆ·è¿”å›ç©ºæƒé™åˆ—è¡¨ã€‚</li><li>å›¢é˜Ÿç©ºé—´ï¼šæŸ¥è¯¢ç™»å½•ç”¨æˆ·åœ¨è¯¥ç©ºé—´çš„è§’è‰²ï¼Œå¹¶è¿”å›å¯¹åº”çš„æƒé™ç åˆ—è¡¨ã€‚å¦‚æœç”¨æˆ·ä¸å±äºè¯¥ç©ºé—´ï¼Œè¿”å›ç©ºæƒé™åˆ—è¡¨ã€‚</li></ul><p>æ ¹æ®ä¸šåŠ¡æµç¨‹ç¼–å†™ä»£ç ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPermissionList</span><span class="token punctuation">(</span><span class="token class-name">Object</span> loginId<span class="token punctuation">,</span> <span class="token class-name">String</span> loginType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤æ–­ loginTypeï¼Œä»…å¯¹ç±»å‹ä¸º &quot;space&quot; è¿›è¡Œæƒé™æ ¡éªŒ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StpKit</span><span class="token punctuation">.</span><span class="token constant">SPACE_TYPE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>loginType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ç®¡ç†å‘˜æƒé™ï¼Œè¡¨ç¤ºæƒé™æ ¡éªŒé€šè¿‡</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token constant">ADMIN_PERMISSIONS</span> <span class="token operator">=</span> spaceUserAuthManager<span class="token punctuation">.</span><span class="token function">getPermissionsByRole</span><span class="token punctuation">(</span><span class="token class-name">SpaceRoleEnum</span><span class="token punctuation">.</span><span class="token constant">ADMIN</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–ä¸Šä¸‹æ–‡å¯¹è±¡</span>
    <span class="token class-name">SpaceUserAuthContext</span> authContext <span class="token operator">=</span> <span class="token function">getAuthContextByRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœæ‰€æœ‰å­—æ®µéƒ½ä¸ºç©ºï¼Œè¡¨ç¤ºæŸ¥è¯¢å…¬å…±å›¾åº“ï¼Œå¯ä»¥é€šè¿‡</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAllFieldsNull</span><span class="token punctuation">(</span>authContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">ADMIN_PERMISSIONS</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è·å– userId</span>
    <span class="token class-name">User</span> loginUser <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> <span class="token class-name">StpKit</span><span class="token punctuation">.</span><span class="token constant">SPACE</span><span class="token punctuation">.</span><span class="token function">getSessionByLoginId</span><span class="token punctuation">(</span>loginId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">USER_LOGIN_STATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loginUser <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">NO_AUTH_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;ç”¨æˆ·æœªç™»å½•&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> loginUser<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä¼˜å…ˆä»ä¸Šä¸‹æ–‡ä¸­è·å– SpaceUser å¯¹è±¡</span>
    <span class="token class-name">SpaceUser</span> spaceUser <span class="token operator">=</span> authContext<span class="token punctuation">.</span><span class="token function">getSpaceUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>spaceUser <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> spaceUserAuthManager<span class="token punctuation">.</span><span class="token function">getPermissionsByRole</span><span class="token punctuation">(</span>spaceUser<span class="token punctuation">.</span><span class="token function">getSpaceRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¦‚æœæœ‰ spaceUserIdï¼Œå¿…ç„¶æ˜¯å›¢é˜Ÿç©ºé—´ï¼Œé€šè¿‡æ•°æ®åº“æŸ¥è¯¢ SpaceUser å¯¹è±¡</span>
    <span class="token class-name">Long</span> spaceUserId <span class="token operator">=</span> authContext<span class="token punctuation">.</span><span class="token function">getSpaceUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>spaceUserId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        spaceUser <span class="token operator">=</span> spaceUserService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>spaceUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>spaceUser <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">NOT_FOUND_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;æœªæ‰¾åˆ°ç©ºé—´ç”¨æˆ·ä¿¡æ¯&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å–å‡ºå½“å‰ç™»å½•ç”¨æˆ·å¯¹åº”çš„ spaceUser</span>
        <span class="token class-name">SpaceUser</span> loginSpaceUser <span class="token operator">=</span> spaceUserService<span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SpaceUser</span><span class="token operator">::</span><span class="token function">getSpaceId</span><span class="token punctuation">,</span> spaceUser<span class="token punctuation">.</span><span class="token function">getSpaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SpaceUser</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loginSpaceUser <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è¿™é‡Œä¼šå¯¼è‡´ç®¡ç†å‘˜åœ¨ç§æœ‰ç©ºé—´æ²¡æœ‰æƒé™ï¼Œå¯ä»¥å†æŸ¥ä¸€æ¬¡åº“å¤„ç†</span>
        <span class="token keyword">return</span> spaceUserAuthManager<span class="token punctuation">.</span><span class="token function">getPermissionsByRole</span><span class="token punctuation">(</span>loginSpaceUser<span class="token punctuation">.</span><span class="token function">getSpaceRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¦‚æœæ²¡æœ‰ spaceUserIdï¼Œå°è¯•é€šè¿‡ spaceId æˆ– pictureId è·å– Space å¯¹è±¡å¹¶å¤„ç†</span>
    <span class="token class-name">Long</span> spaceId <span class="token operator">=</span> authContext<span class="token punctuation">.</span><span class="token function">getSpaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>spaceId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœæ²¡æœ‰ spaceIdï¼Œé€šè¿‡ pictureId è·å– Picture å¯¹è±¡å’Œ Space å¯¹è±¡</span>
        <span class="token class-name">Long</span> pictureId <span class="token operator">=</span> authContext<span class="token punctuation">.</span><span class="token function">getPictureId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å›¾ç‰‡ id ä¹Ÿæ²¡æœ‰ï¼Œåˆ™é»˜è®¤é€šè¿‡æƒé™æ ¡éªŒ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pictureId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant">ADMIN_PERMISSIONS</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Picture</span> picture <span class="token operator">=</span> pictureService<span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">Picture</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">,</span> pictureId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">Picture</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">,</span> <span class="token class-name">Picture</span><span class="token operator">::</span><span class="token function">getSpaceId</span><span class="token punctuation">,</span> <span class="token class-name">Picture</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>picture <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">NOT_FOUND_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;æœªæ‰¾åˆ°å›¾ç‰‡ä¿¡æ¯&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        spaceId <span class="token operator">=</span> picture<span class="token punctuation">.</span><span class="token function">getSpaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å…¬å…±å›¾åº“ï¼Œä»…æœ¬äººæˆ–ç®¡ç†å‘˜å¯æ“ä½œ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>spaceId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>picture<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span> <span class="token operator">||</span> userService<span class="token punctuation">.</span><span class="token function">isAdmin</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token constant">ADMIN_PERMISSIONS</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// ä¸æ˜¯è‡ªå·±çš„å›¾ç‰‡ï¼Œä»…å¯æŸ¥çœ‹</span>
                <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token class-name">SpaceUserPermissionConstant</span><span class="token punctuation">.</span><span class="token constant">PICTURE_VIEW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è·å– Space å¯¹è±¡</span>
    <span class="token class-name">Space</span> space <span class="token operator">=</span> spaceService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>spaceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>space <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">NOT_FOUND_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;æœªæ‰¾åˆ°ç©ºé—´ä¿¡æ¯&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ ¹æ® Space ç±»å‹åˆ¤æ–­æƒé™</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>space<span class="token punctuation">.</span><span class="token function">getSpaceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">SpaceTypeEnum</span><span class="token punctuation">.</span><span class="token constant">PRIVATE</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç§æœ‰ç©ºé—´ï¼Œä»…æœ¬äººæˆ–ç®¡ç†å‘˜æœ‰æƒé™</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>space<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span> <span class="token operator">||</span> userService<span class="token punctuation">.</span><span class="token function">isAdmin</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant">ADMIN_PERMISSIONS</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// å›¢é˜Ÿç©ºé—´ï¼ŒæŸ¥è¯¢ SpaceUser å¹¶è·å–è§’è‰²å’Œæƒé™</span>
        spaceUser <span class="token operator">=</span> spaceUserService<span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SpaceUser</span><span class="token operator">::</span><span class="token function">getSpaceId</span><span class="token punctuation">,</span> spaceId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SpaceUser</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>spaceUser <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> spaceUserAuthManager<span class="token punctuation">.</span><span class="token function">getPermissionsByRole</span><span class="token punctuation">(</span>spaceUser<span class="token punctuation">.</span><span class="token function">getSpaceRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ä»£ç ä¾èµ– â€œåˆ¤æ–­æ‰€æœ‰å­—æ®µéƒ½ä¸ºç©ºâ€ çš„æ–¹æ³•ï¼Œé€šè¿‡åå°„è·å–å¯¹è±¡çš„æ‰€æœ‰å­—æ®µï¼Œè¿›è¡Œåˆ¤ç©ºï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isAllFieldsNull</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// å¯¹è±¡æœ¬èº«ä¸ºç©º</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è·å–æ‰€æœ‰å­—æ®µå¹¶åˆ¤æ–­æ˜¯å¦æ‰€æœ‰å­—æ®µéƒ½ä¸ºç©º</span>
    <span class="token keyword">return</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token class-name">ReflectUtil</span><span class="token punctuation">.</span><span class="token function">getFields</span><span class="token punctuation">(</span>object<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// è·å–å­—æ®µå€¼</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>field <span class="token operator">-&gt;</span> <span class="token class-name">ReflectUtil</span><span class="token punctuation">.</span><span class="token function">getFieldValue</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å­—æ®µéƒ½ä¸ºç©º</span>
            <span class="token punctuation">.</span><span class="token function">allMatch</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token operator">::</span><span class="token function">isEmpty</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>OKï¼Œè¿™å°±æ˜¯ Sa-Token åŠ¨æ€æƒé™æ ¡éªŒçš„æ ¸å¿ƒä»£ç ï¼Œä½ ä¼šå‘ç°ç¼–å†™ä¸€å¥—ç»Ÿä¸€çš„æƒé™æ ¡éªŒé€»è¾‘å¹¶ä¸å®¹æ˜“ï¼Œæ‰€ä»¥å®é™…é¡¹ç›®ä¸­è¦ <strong>æŒ‰éœ€ä½¿ç”¨</strong> ç¬¬ä¸‰æ–¹æƒé™æ ¡éªŒæ¡†æ¶ã€‚</p><p>ğŸ’¡ æ³¨æ„ï¼Œé‡‡ç”¨æ³¨è§£å¼é‰´æƒ + é€šè¿‡è¯·æ±‚å¯¹è±¡è·å–å‚æ•°æ—¶ï¼Œå¯èƒ½ä¼šé‡å¤æŸ¥è¯¢æ•°æ®åº“ã€‚æ¯”å¦‚ä¸šåŠ¡ä»£ç ä¸­å·²ç»æœ‰æ ¹æ® id æŸ¥è¯¢ç©ºé—´ä¿¡æ¯çš„ä»£ç äº†ï¼Œä½†ä¸ºäº†æƒé™æ ¡éªŒï¼Œä¹ŸæŸ¥åº“è·å–äº†ä¸€æ¬¡ç©ºé—´ä¿¡æ¯ï¼Œä¼šå¯¹æ€§èƒ½é€ æˆå½±å“ã€‚å¦‚æœæƒ³æ›´çµæ´»ã€æ›´é«˜æ€§èƒ½åœ°å®ç°é‰´æƒï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ç¼–ç¨‹å¼é‰´æƒã€‚è·å–æƒé™çš„æ–¹æ³•å’Œä¸Šä¸‹æ–‡ç±»éƒ½æ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œåªéœ€è¦å°† <code>getAuthContextByRequest</code> æ–¹æ³•çš„é€»è¾‘æ”¹ä¸ºä» ThreadLocal ä¸Šä¸‹æ–‡ä¸­è·å–å³å¯ã€‚</p><p>åŸºäº ThreadLocal å®ç°ä¸Šä¸‹æ–‡ç®¡ç†çš„ç¤ºä¾‹ä»£ç ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SaTokenContextHolder</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token constant">CONTEXT</span> <span class="token operator">=</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token class-name">HashMap</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è®¾ç½®ä¸Šä¸‹æ–‡æ•°æ®</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">CONTEXT</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è·å–ä¸Šä¸‹æ–‡æ•°æ®</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">CONTEXT</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ¸…ç†ä¸Šä¸‹æ–‡æ•°æ®ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">CONTEXT</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5ã€æƒé™æ ¡éªŒæ³¨è§£" tabindex="-1"><a class="header-anchor" href="#_5ã€æƒé™æ ¡éªŒæ³¨è§£" aria-hidden="true">#</a> 5ã€æƒé™æ ¡éªŒæ³¨è§£</h4><p>é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ <a href="https://sa-token.cc/doc.html#/use/at-check" target="_blank" rel="noopener noreferrer">æ³¨è§£å¼é‰´æƒ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼Œéœ€è¦æ–°å»ºé…ç½®ç±»ï¼š</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221432460.webp" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>ä½†ç”±äºæˆ‘ä»¬ä½¿ç”¨äº†å¤šè´¦å·ä½“ç³»ï¼Œæ¯æ¬¡ä½¿ç”¨æ³¨è§£æ—¶éƒ½è¦æŒ‡å®šè´¦å·ä½“ç³»çš„ loginTypeï¼Œä¼šæ¯”è¾ƒéº»çƒ¦ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SaCheckLogin</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">StpUserUtil</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ‰€ä»¥å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œä½¿ç”¨ <a href="https://sa-token.cc/doc.html#/up/many-account?id=_7%E3%80%81%E4%BD%BF%E7%94%A8%E6%B3%A8%E8%A7%A3%E5%90%88%E5%B9%B6%E7%AE%80%E5%8C%96%E4%BB%A3%E7%A0%81" target="_blank" rel="noopener noreferrer">æ³¨è§£åˆå¹¶<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ç®€åŒ–ä»£ç ã€‚åœ¨ <code>auth.annotation</code> åŒ…ä¸‹æ–°å»º Sa-Token é…ç½®ç±»ï¼Œå¼€å¯æ³¨è§£é‰´æƒå’Œæ³¨è§£åˆå¹¶ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SaTokenConfigure</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>

    <span class="token comment">// æ³¨å†Œ Sa-Token æ‹¦æˆªå™¨ï¼Œæ‰“å¼€æ³¨è§£å¼é‰´æƒåŠŸèƒ½</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ³¨å†Œ Sa-Token æ‹¦æˆªå™¨ï¼Œæ‰“å¼€æ³¨è§£å¼é‰´æƒåŠŸèƒ½</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SaInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rewriteSaStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é‡å†™Sa-Tokençš„æ³¨è§£å¤„ç†å™¨ï¼Œå¢åŠ æ³¨è§£åˆå¹¶åŠŸèƒ½ </span>
        <span class="token class-name">SaAnnotationStrategy</span><span class="token punctuation">.</span>instance<span class="token punctuation">.</span>getAnnotation <span class="token operator">=</span> <span class="token punctuation">(</span>element<span class="token punctuation">,</span> annotationClass<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">AnnotatedElementUtils</span><span class="token punctuation">.</span><span class="token function">getMergedAnnotation</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> annotationClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åå‚è€ƒ <a href="https://gitee.com/dromara/sa-token/blob/master/sa-token-demo/sa-token-demo-case/src/main/java/com/pj/satoken/merge_annotation/SaUserCheckPermission.java#" target="_blank" rel="noopener noreferrer">å®˜æ–¹æä¾›çš„ç¤ºä¾‹ä»£ç <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼Œåœ¨ <code>auth.annotation</code> åŒ…ä¸‹æ–°å»ºç©ºé—´è´¦å·ä½“ç³»çš„é‰´æƒæ³¨è§£ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * ç©ºé—´æƒé™è®¤è¯ï¼šå¿…é¡»å…·æœ‰æŒ‡å®šæƒé™æ‰èƒ½è¿›å…¥è¯¥æ–¹æ³•
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span> å¯æ ‡æ³¨åœ¨å‡½æ•°ã€ç±»ä¸Šï¼ˆæ•ˆæœç­‰åŒäºæ ‡æ³¨åœ¨æ­¤ç±»çš„æ‰€æœ‰æ–¹æ³•ä¸Šï¼‰
 */</span>
<span class="token annotation punctuation">@SaCheckPermission</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">StpKit</span><span class="token punctuation">.</span><span class="token constant">SPACE_TYPE</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">SaSpaceCheckPermission</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * éœ€è¦æ ¡éªŒçš„æƒé™ç 
     *
     * <span class="token keyword">@return</span> éœ€è¦æ ¡éªŒçš„æƒé™ç 
     */</span>
    <span class="token annotation punctuation">@AliasFor</span><span class="token punctuation">(</span>annotation <span class="token operator">=</span> <span class="token class-name">SaCheckPermission</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * éªŒè¯æ¨¡å¼ï¼šAND | ORï¼Œé»˜è®¤AND
     *
     * <span class="token keyword">@return</span> éªŒè¯æ¨¡å¼
     */</span>
    <span class="token annotation punctuation">@AliasFor</span><span class="token punctuation">(</span>annotation <span class="token operator">=</span> <span class="token class-name">SaCheckPermission</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token class-name">SaMode</span> <span class="token function">mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">SaMode</span><span class="token punctuation">.</span><span class="token constant">AND</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * åœ¨æƒé™æ ¡éªŒä¸é€šè¿‡æ—¶çš„æ¬¡è¦é€‰æ‹©ï¼Œä¸¤è€…åªè¦å…¶ä¸€æ ¡éªŒæˆåŠŸå³å¯é€šè¿‡æ ¡éªŒ
     *
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
     * ä¾‹1ï¼š@SaCheckPermission(value=&quot;user-add&quot;, orRole=&quot;admin&quot;)ï¼Œ
     * ä»£è¡¨æœ¬æ¬¡è¯·æ±‚åªè¦å…·æœ‰ user-addæƒé™ æˆ– adminè§’è‰² å…¶ä¸€å³å¯é€šè¿‡æ ¡éªŒã€‚
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
     *
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
     * ä¾‹2ï¼š orRole = <span class="token punctuation">{</span>&quot;admin&quot;, &quot;manager&quot;, &quot;staff&quot;<span class="token punctuation">}</span>ï¼Œå…·æœ‰ä¸‰ä¸ªè§’è‰²å…¶ä¸€å³å¯ã€‚ <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
     * ä¾‹3ï¼š orRole = <span class="token punctuation">{</span>&quot;admin, manager, staff&quot;<span class="token punctuation">}</span>ï¼Œå¿…é¡»ä¸‰ä¸ªè§’è‰²åŒæ—¶å…·å¤‡ã€‚
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
     *
     * <span class="token keyword">@return</span> /
     */</span>
    <span class="token annotation punctuation">@AliasFor</span><span class="token punctuation">(</span>annotation <span class="token operator">=</span> <span class="token class-name">SaCheckPermission</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">orRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¹‹åå°±å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥æ³¨è§£äº†ã€‚</p><h4 id="_6ã€åº”ç”¨æƒé™æ³¨è§£" tabindex="-1"><a class="header-anchor" href="#_6ã€åº”ç”¨æƒé™æ³¨è§£" aria-hidden="true">#</a> 6ã€åº”ç”¨æƒé™æ³¨è§£</h4><p>è®¤çœŸæ ¸å¯¹ä¸€éå„ä¸ªæ“ä½œæ¥å£çš„ä»£ç ã€ä»¥åŠæ¥å£è°ƒç”¨çš„ Service ä»£ç ï¼ŒåŒ…æ‹¬å›¾ç‰‡æ“ä½œ PictureController å’ŒPictureServiceã€ç©ºé—´æˆå‘˜æ“ä½œ SpaceUserController å’Œ SpaceUserServiceã€‚</p><p>1ï¼‰ç»™ Controller æ¥å£è¡¥å……ä¸Šåˆé€‚çš„æƒé™æ³¨è§£ï¼ŒPictureController å›¾ç‰‡æ¥å£ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é‡æ–°ä¸Šä¼ ï¼‰</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SaSpaceCheckPermission</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">SpaceUserPermissionConstant</span><span class="token punctuation">.</span><span class="token constant">PICTURE_UPLOAD</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PictureVO</span><span class="token punctuation">&gt;</span></span> <span class="token function">uploadPicture</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token comment">// é€šè¿‡ URL ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é‡æ–°ä¸Šä¼ ï¼‰</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload/url&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SaSpaceCheckPermission</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">SpaceUserPermissionConstant</span><span class="token punctuation">.</span><span class="token constant">PICTURE_UPLOAD</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PictureVO</span><span class="token punctuation">&gt;</span></span> <span class="token function">uploadPictureByUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token comment">// åˆ é™¤å›¾ç‰‡</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/delete&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SaSpaceCheckPermission</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">SpaceUserPermissionConstant</span><span class="token punctuation">.</span><span class="token constant">PICTURE_DELETE</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">deletePicture</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token comment">// ç¼–è¾‘å›¾ç‰‡ï¼ˆç»™ç”¨æˆ·ä½¿ç”¨ï¼‰</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/edit&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SaSpaceCheckPermission</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">SpaceUserPermissionConstant</span><span class="token punctuation">.</span><span class="token constant">PICTURE_EDIT</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">editPicture</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token comment">// æ ¹æ®é¢œè‰²æœç´¢å›¾ç‰‡</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/search/color&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SaSpaceCheckPermission</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">SpaceUserPermissionConstant</span><span class="token punctuation">.</span><span class="token constant">PICTURE_VIEW</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">PictureVO</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">searchPictureByColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token comment">// æ‰¹é‡ç¼–è¾‘å›¾ç‰‡</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/edit/batch&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SaSpaceCheckPermission</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">SpaceUserPermissionConstant</span><span class="token punctuation">.</span><span class="token constant">PICTURE_EDIT</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">editPictureByBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token comment">// åˆ›å»º AI æ‰©å›¾ä»»åŠ¡</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/out_painting/create_task&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SaSpaceCheckPermission</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">SpaceUserPermissionConstant</span><span class="token punctuation">.</span><span class="token constant">PICTURE_EDIT</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CreateOutPaintingTaskResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">createPictureOutPaintingTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>SpaceUserController æ¥å£ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// æ·»åŠ æˆå‘˜åˆ°ç©ºé—´</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/add&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SaSpaceCheckPermission</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">SpaceUserPermissionConstant</span><span class="token punctuation">.</span><span class="token constant">SPACE_USER_MANAGE</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">addSpaceUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token comment">// ä»ç©ºé—´ç§»é™¤æˆå‘˜</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/delete&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SaSpaceCheckPermission</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">SpaceUserPermissionConstant</span><span class="token punctuation">.</span><span class="token constant">SPACE_USER_MANAGE</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">deleteSpaceUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token comment">// æŸ¥è¯¢æŸä¸ªæˆå‘˜åœ¨æŸä¸ªç©ºé—´çš„ä¿¡æ¯</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/get&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SaSpaceCheckPermission</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">SpaceUserPermissionConstant</span><span class="token punctuation">.</span><span class="token constant">SPACE_USER_MANAGE</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpaceUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSpaceUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token comment">// æŸ¥è¯¢æˆå‘˜ä¿¡æ¯åˆ—è¡¨</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/list&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SaSpaceCheckPermission</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">SpaceUserPermissionConstant</span><span class="token punctuation">.</span><span class="token constant">SPACE_USER_MANAGE</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SpaceUserVO</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">listSpaceUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token comment">// ç¼–è¾‘æˆå‘˜ä¿¡æ¯ï¼ˆè®¾ç½®æƒé™ï¼‰</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/edit&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SaSpaceCheckPermission</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">SpaceUserPermissionConstant</span><span class="token punctuation">.</span><span class="token constant">SPACE_USER_MANAGE</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">editSpaceUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2ï¼‰ç§»é™¤è¿™äº›æ¥å£å’Œç›¸å…³æœåŠ¡åŸæœ¬çš„æƒé™æ ¡éªŒé€»è¾‘ï¼Œæ¯”å¦‚ <code>PictureService#checkPictureAuth</code>ï¼Œç¡®ä¿è¯¥æ–¹æ³•å˜æˆäº†ç°è‰²ï¼ˆæœªè¢«ä½¿ç”¨ï¼‰</p><p>è¿˜æœ‰ PictureServiceImpl çš„ uploadPicture æ–¹æ³•ä¸­çš„æƒé™æ ¡éªŒï¼Œä¹Ÿè¦æ³¨é‡Šæ‰ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>â–¼javaå¤åˆ¶ä»£ç <span class="token comment">//            // æ ¡éªŒæ˜¯å¦æœ‰ç©ºé—´çš„æƒé™ï¼Œä»…ç©ºé—´ç®¡ç†å‘˜æ‰èƒ½ä¸Šä¼ </span>
<span class="token comment">//            if (!loginUser.getId().equals(space.getUserId())) {</span>
<span class="token comment">//                throw new BusinessException(ErrorCode.NO_AUTH_ERROR, &quot;æ²¡æœ‰ç©ºé—´æƒé™&quot;);</span>
<span class="token comment">//            }</span>

<span class="token comment">//            // ä»…æœ¬äººæˆ–ç®¡ç†å‘˜å¯ç¼–è¾‘å›¾ç‰‡</span>
<span class="token comment">//            if (!oldPicture.getUserId().equals(loginUser.getId()) &amp;&amp; !userService.isAdmin(loginUser)) {</span>
<span class="token comment">//                throw new BusinessException(ErrorCode.NO_AUTH_ERROR);</span>
<span class="token comment">//            }</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3ï¼‰æ³¨æ„ï¼Œåªè¦åŠ ä¸Šäº† Sa-Token æ³¨è§£ï¼Œæ¡†æ¶å°±ä¼šå¼ºåˆ¶è¦æ±‚ç”¨æˆ·ç™»å½•ï¼Œæœªç™»å½•ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚æ‰€ä»¥é’ˆå¯¹æœªç™»å½•ä¹Ÿå¯ä»¥è°ƒç”¨çš„æ¥å£ï¼Œéœ€è¦æ”¹ä¸ºç¼–ç¨‹å¼æƒé™æ ¡éªŒï¼Œæ¯”å¦‚ getPictureVOById å’Œ listPictureVOByPage æ–¹æ³•ã€‚eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=58IUDBvyDy7G+gVMqAunJfAo72ZBX//2DD/nhaX54Xg=</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/get/vo&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PictureVO</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPictureVOById</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ThrowUtils</span><span class="token punctuation">.</span><span class="token function">throwIf</span><span class="token punctuation">(</span>id <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">PARAMS_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æŸ¥è¯¢æ•°æ®åº“</span>
    <span class="token class-name">Picture</span> picture <span class="token operator">=</span> pictureService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThrowUtils</span><span class="token punctuation">.</span><span class="token function">throwIf</span><span class="token punctuation">(</span>picture <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">NOT_FOUND_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ç©ºé—´çš„å›¾ç‰‡ï¼Œéœ€è¦æ ¡éªŒæƒé™</span>
    <span class="token class-name">Space</span> space <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> spaceId <span class="token operator">=</span> picture<span class="token punctuation">.</span><span class="token function">getSpaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>spaceId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> hasPermission <span class="token operator">=</span> <span class="token class-name">StpKit</span><span class="token punctuation">.</span><span class="token constant">SPACE</span><span class="token punctuation">.</span><span class="token function">hasPermission</span><span class="token punctuation">(</span><span class="token class-name">SpaceUserPermissionConstant</span><span class="token punctuation">.</span><span class="token constant">PICTURE_VIEW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThrowUtils</span><span class="token punctuation">.</span><span class="token function">throwIf</span><span class="token punctuation">(</span><span class="token operator">!</span>hasPermission<span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">NO_AUTH_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">PictureVO</span> pictureVO <span class="token operator">=</span> pictureService<span class="token punctuation">.</span><span class="token function">getPictureVO</span><span class="token punctuation">(</span>picture<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–å°è£…ç±»</span>
    <span class="token keyword">return</span> <span class="token class-name">ResultUtils</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>pictureVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/list/page/vo&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Page</span><span class="token punctuation">&lt;</span><span class="token class-name">PictureVO</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">listPictureVOByPage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">PictureQueryRequest</span> pictureQueryRequest<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> current <span class="token operator">=</span> pictureQueryRequest<span class="token punctuation">.</span><span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> size <span class="token operator">=</span> pictureQueryRequest<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// é™åˆ¶çˆ¬è™«</span>
    <span class="token class-name">ThrowUtils</span><span class="token punctuation">.</span><span class="token function">throwIf</span><span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">PARAMS_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ç©ºé—´æƒé™æ ¡éªŒ</span>
    <span class="token class-name">Long</span> spaceId <span class="token operator">=</span> pictureQueryRequest<span class="token punctuation">.</span><span class="token function">getSpaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å…¬å¼€å›¾åº“</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>spaceId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ™®é€šç”¨æˆ·é»˜è®¤åªèƒ½æŸ¥çœ‹å·²è¿‡å®¡çš„å…¬å¼€æ•°æ®</span>
        pictureQueryRequest<span class="token punctuation">.</span><span class="token function">setReviewStatus</span><span class="token punctuation">(</span><span class="token class-name">PictureReviewStatusEnum</span><span class="token punctuation">.</span><span class="token constant">PASS</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pictureQueryRequest<span class="token punctuation">.</span><span class="token function">setNullSpaceId</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> hasPermission <span class="token operator">=</span> <span class="token class-name">StpKit</span><span class="token punctuation">.</span><span class="token constant">SPACE</span><span class="token punctuation">.</span><span class="token function">hasPermission</span><span class="token punctuation">(</span><span class="token class-name">SpaceUserPermissionConstant</span><span class="token punctuation">.</span><span class="token constant">PICTURE_VIEW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThrowUtils</span><span class="token punctuation">.</span><span class="token function">throwIf</span><span class="token punctuation">(</span><span class="token operator">!</span>hasPermission<span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">NO_AUTH_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æŸ¥è¯¢æ•°æ®åº“</span>
    <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Picture</span><span class="token punctuation">&gt;</span></span> picturePage <span class="token operator">=</span> pictureService<span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">,</span> pictureService<span class="token punctuation">.</span><span class="token function">getQueryWrapper</span><span class="token punctuation">(</span>pictureQueryRequest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–å°è£…ç±»</span>
    <span class="token keyword">return</span> <span class="token class-name">ResultUtils</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>pictureService<span class="token punctuation">.</span><span class="token function">getPictureVOPage</span><span class="token punctuation">(</span>picturePage<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7ã€å…¨å±€å¼‚å¸¸å¤„ç†" tabindex="-1"><a class="header-anchor" href="#_7ã€å…¨å±€å¼‚å¸¸å¤„ç†" aria-hidden="true">#</a> 7ã€å…¨å±€å¼‚å¸¸å¤„ç†</h4><p>å¦‚æœ Sa-Token æ ¡éªŒç”¨æˆ·æ²¡æœ‰ç¬¦åˆè¦æ±‚çš„æƒé™ã€æˆ–è€…ç”¨æˆ·æœªç™»å½•ï¼Œå°±ä¼šæŠ›å‡ºå®ƒå®šä¹‰çš„å¼‚å¸¸ï¼Œ<a href="https://sa-token.cc/doc.html#/fun/exception-code?id=%E8%8E%B7%E5%8F%96%E5%BC%82%E5%B8%B8%E7%BB%86%E5%88%86%E7%8A%B6%E6%80%81%E7%A0%81" target="_blank" rel="noopener noreferrer">å‚è€ƒæ–‡æ¡£<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ã€‚</p><p>éœ€è¦å°†æ¡†æ¶çš„å¼‚å¸¸å…¨å±€å¤„ç†ä¸ºæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ä¸šåŠ¡å¼‚å¸¸ï¼Œåœ¨å…¨å±€å¼‚å¸¸å¤„ç†å™¨ä¸­æ·»åŠ ä»£ç ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">NotLoginException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">notLoginException</span><span class="token punctuation">(</span><span class="token class-name">NotLoginException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;NotLoginException&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">ResultUtils</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">NOT_LOGIN_ERROR</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">NotPermissionException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">notPermissionExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">NotPermissionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;NotPermissionException&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">ResultUtils</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">NO_AUTH_ERROR</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8ã€è¡¥å……è·å–æƒé™çš„æ¥å£" tabindex="-1"><a class="header-anchor" href="#_8ã€è¡¥å……è·å–æƒé™çš„æ¥å£" aria-hidden="true">#</a> 8ã€è¡¥å……è·å–æƒé™çš„æ¥å£</h4><p>å‰é¢å†™çš„éƒ½æ˜¯åç«¯æƒé™æ ¡éªŒçš„ä»£ç ï¼Œä½†å¯¹äºç”¨æˆ·æ¥è¯´ï¼Œå¦‚æœæ²¡æœ‰ç©ºé—´å›¾ç‰‡çš„ç¼–è¾‘æƒé™ï¼Œè¿›å…¥ç©ºé—´è¯¦æƒ…é¡µæ—¶ä¸åº”è¯¥èƒ½çœ‹åˆ°ç¼–è¾‘æŒ‰é’®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå‰ç«¯ä¹Ÿéœ€è¦æ ¹æ®ç”¨æˆ·çš„æƒé™æ¥è¿›è¡Œä¸€äº›é¡µé¢å†…å®¹çš„å±•ç¤ºå’Œéšè—ã€‚</p><p>å› æ­¤ï¼Œåç«¯éœ€è¦å°†ç”¨æˆ·å…·æœ‰çš„æƒé™è¿”å›ç»™å‰ç«¯ï¼Œå¸®åŠ©å‰ç«¯è¿›è¡Œåˆ¤æ–­ï¼Œè¿™æ ·å°±ä¸ç”¨è®©å‰ç«¯ç¼–å†™å¤æ‚çš„è§’è‰²å’Œæƒé™æ ¡éªŒé€»è¾‘äº†ã€‚</p><p>æ€è€ƒä¸‹å…·ä½“çš„ä½¿ç”¨åœºæ™¯ï¼šå¦‚æœæ˜¯å›¢é˜Ÿç©ºé—´ï¼ˆç©ºé—´è¯¦æƒ…é¡µï¼‰æˆ–å›¢é˜Ÿç©ºé—´çš„å›¾ç‰‡ï¼ˆå›¾ç‰‡è¯¦æƒ…é¡µï¼‰ï¼Œè¿”å›ç»™å‰ç«¯ç”¨æˆ·å…·æœ‰çš„æƒé™ï¼ˆæ¯”å¦‚èƒ½å¦ç¼–è¾‘ã€èƒ½å¦ä¸Šä¼ ã€èƒ½å¦åˆ é™¤ã€èƒ½å¦ç®¡ç†æˆå‘˜ï¼‰ã€‚4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=J+5o58b0kn/bTqd/50F76o1L2/PhqvQWrl14ca26WW0=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=</p><p>1ï¼‰æ¯”èµ·æ–°å†™ä¸€ä¸ªè·å–æƒé™çš„æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨è¿”å›å›¾ç‰‡æˆ–ç©ºé—´è¯¦æƒ…æ—¶ï¼Œé¢å¤–ä¼ é€’æƒé™åˆ—è¡¨ã€‚ç»™ SpaceVO å’Œ PictureVO æ–°å¢æƒé™åˆ—è¡¨å­—æ®µï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * æƒé™åˆ—è¡¨
 */</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> permissionList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2ï¼‰åœ¨ SpaceUserAuthManager ä¸­æ–°å¢è·å–æƒé™åˆ—è¡¨çš„æ–¹æ³•ï¼Œæ³¨æ„è¦åŒºåˆ†å…¬å…±å›¾åº“ã€ç§æœ‰ç©ºé—´å’Œå›¢é˜Ÿç©ºé—´ï¼Œå¯¹äºæœ‰æƒé™çš„æƒ…å†µï¼Œå¯ä»¥è¿”å› â€œç®¡ç†å‘˜æƒé™â€ åˆ—è¡¨ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPermissionList</span><span class="token punctuation">(</span><span class="token class-name">Space</span> space<span class="token punctuation">,</span> <span class="token class-name">User</span> loginUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loginUser <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ç®¡ç†å‘˜æƒé™</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token constant">ADMIN_PERMISSIONS</span> <span class="token operator">=</span> <span class="token function">getPermissionsByRole</span><span class="token punctuation">(</span><span class="token class-name">SpaceRoleEnum</span><span class="token punctuation">.</span><span class="token constant">ADMIN</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å…¬å…±å›¾åº“</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>space <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userService<span class="token punctuation">.</span><span class="token function">isAdmin</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant">ADMIN_PERMISSIONS</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">SpaceTypeEnum</span> spaceTypeEnum <span class="token operator">=</span> <span class="token class-name">SpaceTypeEnum</span><span class="token punctuation">.</span><span class="token function">getEnumByValue</span><span class="token punctuation">(</span>space<span class="token punctuation">.</span><span class="token function">getSpaceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>spaceTypeEnum <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ ¹æ®ç©ºé—´è·å–å¯¹åº”çš„æƒé™</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>spaceTypeEnum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token constant">PRIVATE</span><span class="token operator">:</span>
            <span class="token comment">// ç§æœ‰ç©ºé—´ï¼Œä»…æœ¬äººæˆ–ç®¡ç†å‘˜æœ‰æ‰€æœ‰æƒé™</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>space<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> userService<span class="token punctuation">.</span><span class="token function">isAdmin</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token constant">ADMIN_PERMISSIONS</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">case</span> <span class="token constant">TEAM</span><span class="token operator">:</span>
            <span class="token comment">// å›¢é˜Ÿç©ºé—´ï¼ŒæŸ¥è¯¢ SpaceUser å¹¶è·å–è§’è‰²å’Œæƒé™</span>
            <span class="token class-name">SpaceUser</span> spaceUser <span class="token operator">=</span> spaceUserService<span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SpaceUser</span><span class="token operator">::</span><span class="token function">getSpaceId</span><span class="token punctuation">,</span> space<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SpaceUser</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">,</span> loginUser<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>spaceUser <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">getPermissionsByRole</span><span class="token punctuation">(</span>spaceUser<span class="token punctuation">.</span><span class="token function">getSpaceRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3ï¼‰ä¿®æ”¹è·å–ç©ºé—´è¯¦æƒ…å’Œå›¾ç‰‡è¯¦æƒ…çš„æ¥å£ getSpaceVOByIdã€getPictureVOByIdï¼Œå¢åŠ è·å–æƒé™åˆ—è¡¨çš„é€»è¾‘ã€‚</p><p>è·å–ç©ºé—´è¯¦æƒ…æ¥å£ï¼šJ+5o58b0kn/bTqd/50F76o1L2/PhqvQWrl14ca26WW0=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=58IUDBvyDy7G+gVMqAunJfAo72ZBX//2DD/nhaX54Xg=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=J+5o58b0kn/bTqd/50F76o1L2/PhqvQWrl14ca26WW0=J+5o58b0kn/bTqd/50F76o1L2/PhqvQWrl14ca26WW0=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/get/vo&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpaceVO</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSpaceVOById</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ThrowUtils</span><span class="token punctuation">.</span><span class="token function">throwIf</span><span class="token punctuation">(</span>id <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">PARAMS_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æŸ¥è¯¢æ•°æ®åº“</span>
    <span class="token class-name">Space</span> space <span class="token operator">=</span> spaceService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThrowUtils</span><span class="token punctuation">.</span><span class="token function">throwIf</span><span class="token punctuation">(</span>space <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">NOT_FOUND_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SpaceVO</span> spaceVO <span class="token operator">=</span> spaceService<span class="token punctuation">.</span><span class="token function">getSpaceVO</span><span class="token punctuation">(</span>space<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> loginUser <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> permissionList <span class="token operator">=</span> spaceUserAuthManager<span class="token punctuation">.</span><span class="token function">getPermissionList</span><span class="token punctuation">(</span>space<span class="token punctuation">,</span> loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    spaceVO<span class="token punctuation">.</span><span class="token function">setPermissionList</span><span class="token punctuation">(</span>permissionList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–å°è£…ç±»</span>
    <span class="token keyword">return</span> <span class="token class-name">ResultUtils</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>spaceVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è·å–å›¾ç‰‡è¯¦æƒ…æ¥å£ï¼Œæ³¨æ„å³ä½¿ç©ºé—´ id ä¸å­˜åœ¨ï¼ˆå…¬å…±å›¾åº“ï¼‰ä¹Ÿè¦è·å–æƒé™åˆ—è¡¨ï¼Œç®¡ç†å‘˜ä¼šè·å–åˆ°å…¨éƒ¨æƒé™ï¼Œè¿™æ ·å‰ç«¯æ‰èƒ½é¡ºåˆ©å±•ç¤ºå‡ºæ“ä½œæŒ‰é’®ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/get/vo&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PictureVO</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPictureVOById</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ThrowUtils</span><span class="token punctuation">.</span><span class="token function">throwIf</span><span class="token punctuation">(</span>id <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">PARAMS_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æŸ¥è¯¢æ•°æ®åº“</span>
    <span class="token class-name">Picture</span> picture <span class="token operator">=</span> pictureService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThrowUtils</span><span class="token punctuation">.</span><span class="token function">throwIf</span><span class="token punctuation">(</span>picture <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">NOT_FOUND_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ç©ºé—´çš„å›¾ç‰‡ï¼Œéœ€è¦æ ¡éªŒæƒé™</span>
    <span class="token class-name">Space</span> space <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> spaceId <span class="token operator">=</span> picture<span class="token punctuation">.</span><span class="token function">getSpaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>spaceId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> hasPermission <span class="token operator">=</span> <span class="token class-name">StpKit</span><span class="token punctuation">.</span><span class="token constant">SPACE</span><span class="token punctuation">.</span><span class="token function">hasPermission</span><span class="token punctuation">(</span><span class="token class-name">SpaceUserPermissionConstant</span><span class="token punctuation">.</span><span class="token constant">PICTURE_VIEW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThrowUtils</span><span class="token punctuation">.</span><span class="token function">throwIf</span><span class="token punctuation">(</span><span class="token operator">!</span>hasPermission<span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">NO_AUTH_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        space <span class="token operator">=</span> spaceService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>spaceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThrowUtils</span><span class="token punctuation">.</span><span class="token function">throwIf</span><span class="token punctuation">(</span>space <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">NOT_FOUND_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;ç©ºé—´ä¸å­˜åœ¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è·å–æƒé™åˆ—è¡¨</span>
    <span class="token class-name">User</span> loginUser <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> permissionList <span class="token operator">=</span> spaceUserAuthManager<span class="token punctuation">.</span><span class="token function">getPermissionList</span><span class="token punctuation">(</span>space<span class="token punctuation">,</span> loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">PictureVO</span> pictureVO <span class="token operator">=</span> pictureService<span class="token punctuation">.</span><span class="token function">getPictureVO</span><span class="token punctuation">(</span>picture<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pictureVO<span class="token punctuation">.</span><span class="token function">setPermissionList</span><span class="token punctuation">(</span>permissionList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–å°è£…ç±»</span>
    <span class="token keyword">return</span> <span class="token class-name">ResultUtils</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>pictureVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9ã€æ¥å£æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_9ã€æ¥å£æµ‹è¯•" aria-hidden="true">#</a> 9ã€æ¥å£æµ‹è¯•</h4><p>ç»ˆäºå¼€å‘å®Œäº†ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œç»†èŠ‚å®åœ¨æ˜¯å¤ªå¤šäº†ï¼Œæ‰€ä»¥ <strong>ä¸€å®šè¦è¿›è¡Œä¸¥æ ¼çš„æµ‹è¯•ï¼ï¼ï¼</strong></p><p>ç”¨ä¸åŒæƒé™çš„ç”¨æˆ·å»éªŒè¯ä¸åŒçš„ç©ºé—´ç±»åˆ«ï¼ˆå…¬å…±å›¾åº“ã€ç§æœ‰ç©ºé—´ã€å›¢é˜Ÿç©ºé—´ï¼‰ã€‚</p><p>å¦‚ä½•æµ‹è¯•å‘¢ï¼Ÿ</p><p>å¤§å®¶ç”¨çš„æ¯”è¾ƒå¤šçš„å°±æ˜¯å•å…ƒæµ‹è¯•ï¼Œä½†æ˜¯å•å…ƒæµ‹è¯•æƒ³è¦æµ‹è¯•æºå¸¦ç™»å½•æ€çš„ Controller æ¥å£æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é‡‡ç”¨è‡ªåŠ¨åŒ–æ¥å£æµ‹è¯•ï¼Œæ¯”å¦‚ Postman ç­‰ã€‚</p><p>æ­¤å¤„ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ IDEA è‡ªå¸¦çš„ REST API æµ‹è¯•ï¼Œå¯ä»¥å°†æµ‹è¯•å‚æ•°å’Œæµ‹è¯•æ¥å£ä¿å­˜ä¸ºæ–‡ä»¶ï¼Œæ¯æ¬¡ä¿®æ”¹ä»£ç åï¼Œæ”¹æ”¹å‚æ•°ï¼Œæ‰§è¡Œæ–‡ä»¶å°±èƒ½æ•´ä½“æµ‹è¯•äº†ã€‚</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221432490.webp" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>ç”±äºè¦æµ‹è¯•çš„æƒ…å†µè¾ƒå¤šï¼Œå‡†å¤‡å¥½äº†æµ‹è¯•ä»£ç ï¼Œç›´æ¥ä¸‹è½½ä½¿ç”¨å³å¯ï¼š<a href="https://yuyuanweb.yuque.com/attachments/yuque/0/2024/zip/398476/1735475537929-926babdb-fe15-4718-a4bf-8cb1751ed754.zip" target="_blank" rel="noopener noreferrer">ğŸ“httpTest.zip<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>è‡³æ­¤ï¼Œç©ºé—´æˆå‘˜æƒé™æ§åˆ¶å¼€å‘å®Œæˆï¼Œå¤§å®¶ä¼šå‘ç°è¿˜æ˜¯æŒºéº»çƒ¦çš„ã€‚å…¶å®å¦‚æœæ²¡æœ‰å…¬å…±å›¾åº“çš„æ¦‚å¿µçš„è¯ï¼Œå¼€å‘èµ·æ¥å°±è½»æ¾å¾ˆå¤šã€‚å› æ­¤ Sa-Token ç­‰æƒé™æ¡†æ¶è¦æŒ‰éœ€ä½¿ç”¨ï¼Œæ›´é€‚åˆå¤æ‚çš„ã€ä¼ä¸šå†…éƒ¨çš„æƒé™ç®¡ç†ç³»ç»Ÿã€‚</p><p>å¦‚æœä½ æƒ³å¼€å‘èµ·æ¥æ›´è½»æ¾ä¸€äº›ï¼Œæ¨èå…¶ä»–çš„å®ç°æ–¹å¼ï¼š</p><ol><li>ç›´æ¥å°è£…æƒé™æ ¡éªŒæ–¹æ³•ï¼Œåœ¨ä¸šåŠ¡ä»£ç ä¸­è°ƒç”¨</li><li>å°†å›¢é˜Ÿç©ºé—´å›¾ç‰‡çš„å¢åˆ æ”¹æŸ¥æå–ä¸ºç‹¬ç«‹çš„æ¥å£ï¼Œå•ç‹¬è¿›è¡Œæƒé™æ ¡éªŒï¼Œä¸å½±å“å…¬å…±å›¾åº“</li></ol><h4 id="æ‰©å±•" tabindex="-1"><a class="header-anchor" href="#æ‰©å±•" aria-hidden="true">#</a> æ‰©å±•</h4><p>1ï¼‰å¯ä»¥ç»™ç©ºé—´æ“ä½œï¼ˆSpaceControllerï¼‰ã€ç©ºé—´åˆ†ææ“ä½œï¼ˆSpaceAnalyzeControllerï¼‰å¢åŠ ç»Ÿä¸€çš„æƒé™æ ¡éªŒ</p><h3 id="ç©ºé—´æ•°æ®ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#ç©ºé—´æ•°æ®ç®¡ç†" aria-hidden="true">#</a> ç©ºé—´æ•°æ®ç®¡ç†</h3><p>æ ¹æ®éœ€æ±‚å’Œæ–¹æ¡ˆè®¾è®¡ï¼Œæˆ‘ä»¬è¦å°†æ——èˆ°ç‰ˆå›¢é˜Ÿç©ºé—´çš„å›¾ç‰‡æ•°æ®è¿›è¡Œå•ç‹¬ç®¡ç†ï¼Œæ¯ä¸ªå›¢é˜Ÿç©ºé—´çš„å›¾ç‰‡æ•°æ®å­˜å‚¨åˆ°ä¸€å¼ å•ç‹¬çš„è¡¨ä¸­ï¼Œä¹Ÿå°±æ˜¯ <strong>åˆ†è¡¨</strong>ã€‚</p><h4 id="_1ã€ä»€ä¹ˆæ˜¯åˆ†åº“åˆ†è¡¨" tabindex="-1"><a class="header-anchor" href="#_1ã€ä»€ä¹ˆæ˜¯åˆ†åº“åˆ†è¡¨" aria-hidden="true">#</a> 1ã€ä»€ä¹ˆæ˜¯åˆ†åº“åˆ†è¡¨ï¼Ÿ</h4><p>åˆ†åº“åˆ†è¡¨æ˜¯ä¸€ç§å°†æ•°æ®æ‹†åˆ†åˆ°å¤šä¸ªæ•°æ®åº“æˆ–æ•°æ®è¡¨ä¸­çš„è®¾è®¡ç­–ç•¥ï¼Œä¸»è¦ç”¨äºè§£å†³éšç€ä¸šåŠ¡æ•°æ®é‡å’Œè®¿é—®é‡å¢é•¿å¸¦æ¥çš„æ•°æ®åº“æ€§èƒ½é—®é¢˜ã€‚LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=3n/Enp4sfaVRq/PFMJKPxPdBTxeNas/Bp33wsl/l9Wg=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=</p><p>é€šè¿‡åˆ†åº“åˆ†è¡¨ï¼Œå¯ä»¥å‡å°å•åº“æˆ–å•è¡¨çš„æ•°æ®é‡å’Œè®¿é—®å‹åŠ›ï¼Œä»è€Œæé«˜æŸ¥è¯¢å’Œå†™å…¥æ•ˆç‡ã€å¢å¼ºç³»ç»Ÿçš„é«˜å¹¶å‘èƒ½åŠ›ã€ä¼˜åŒ–å¤§æ•°æ®é‡ä¸‹çš„æ€§èƒ½è¡¨ç°ï¼›åŒæ—¶é™ä½å•ç‚¹æ•…éšœé£é™©ï¼Œå®ç°æ›´å¥½çš„ç³»ç»Ÿæ‰©å±•æ€§å’Œå®¹ç¾èƒ½åŠ›ã€‚</p><h4 id="_2ã€åˆ†åº“åˆ†è¡¨å®ç°" tabindex="-1"><a class="header-anchor" href="#_2ã€åˆ†åº“åˆ†è¡¨å®ç°" aria-hidden="true">#</a> 2ã€åˆ†åº“åˆ†è¡¨å®ç°</h4><p>å¦‚æœè®©æˆ‘ä»¬è‡ªå·±å®ç°åˆ†åº“åˆ†è¡¨ï¼Œåº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=</p><p>æ€è·¯ä¸»è¦æ˜¯åŸºäºä¸šåŠ¡éœ€æ±‚è®¾è®¡ <strong>æ•°æ®åˆ†ç‰‡è§„åˆ™</strong>ï¼Œå°†æ•°æ®æŒ‰ä¸€å®šç­–ç•¥ï¼ˆå¦‚å–æ¨¡ã€å“ˆå¸Œã€èŒƒå›´æˆ–æ—¶é—´ï¼‰åˆ†æ•£å­˜å‚¨åˆ°å¤šä¸ªåº“æˆ–è¡¨ä¸­ï¼ŒåŒæ—¶å¼€å‘è·¯ç”±é€»è¾‘æ¥å†³å®šæŸ¥è¯¢æˆ–å†™å…¥æ“ä½œçš„ç›®æ ‡åº“è¡¨ã€‚</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221432452.webp" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å°†æ•°æ®å†™åˆ°ä¸åŒçš„è¡¨ã€å¹¶ä¸”ä»ç›¸åŒçš„è¡¨è¯»å–æ•°æ®ï¼Œå…¶å®é€šè¿‡ç»™ SQL è¡¨åæ‹¼æ¥åŠ¨æ€å‚æ•°å°±èƒ½å®ç°ï¼š</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> table_${åˆ†ç‰‡å”¯ä¸€æ ‡è¯†}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä½†è¿™åªæ˜¯æœ€ç®€å•çš„æƒ…å†µï¼Œå®é™…ä¸Šï¼Œåˆ†åº“åˆ†è¡¨è¿˜æ¶‰åŠè·¨åº“è¡¨æŸ¥è¯¢ã€äº‹åŠ¡ä¸€è‡´æ€§ã€åˆ†é¡µèšåˆç­‰å¤æ‚åœºæ™¯ï¼Œè¿˜å¯èƒ½éœ€è¦é…å¥—è®¾è®¡ç›‘æ§ã€æ‰©å®¹å’Œè¿ç§»æ–¹æ¡ˆä»¥ç¡®ä¿ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚</p><p>æ‰€ä»¥ï¼Œä¸å»ºè®®è‡ªå·±å®ç°åˆ†åº“åˆ†è¡¨ã€‚æœ¬é¡¹ç›®ä¸­ï¼Œé±¼çš®å°†ä½¿ç”¨ä¸»æµçš„åˆ†åº“åˆ†è¡¨æ¡†æ¶ <a href="https://shardingsphere.apache.org/" target="_blank" rel="noopener noreferrer">Apache ShardingSphere<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> å¸¦å¤§å®¶å®ç°ã€‚LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=</p><h4 id="_3ã€shardingsphere-åˆ†åº“åˆ†è¡¨" tabindex="-1"><a class="header-anchor" href="#_3ã€shardingsphere-åˆ†åº“åˆ†è¡¨" aria-hidden="true">#</a> 3ã€ShardingSphere åˆ†åº“åˆ†è¡¨</h4><p>Apache ShardingSphere æä¾›äº†å¼€ç®±å³ç”¨çš„åˆ†ç‰‡ç­–ç•¥ã€çµæ´»çš„é…ç½®èƒ½åŠ›ä»¥åŠå¯¹è·¨åº“æŸ¥è¯¢ã€äº‹åŠ¡ä¸€è‡´æ€§ã€è¯»å†™åˆ†ç¦»ç­‰å¤æ‚åŠŸèƒ½çš„å…¨é¢æ”¯æŒã€‚</p><p>å®ƒåˆåˆ†ä¸º 2 å¤§æ ¸å¿ƒæ¨¡å— ShardingSphere-JDBC å’Œ ShardingSphere-Proxyï¼Œæˆ‘ç”¨ä¸€å¼ è¡¨æ ¼æ¥åˆ—ä¸¾ 2 è€…çš„åŒºåˆ«ï¼š</p><table><thead><tr><th>ç»´åº¦</th><th>ShardingSphere JDBC</th><th>ShardingSphere Proxy</th></tr></thead><tbody><tr><td>è¿è¡Œæ–¹å¼</td><td>åµŒå…¥å¼è¿è¡Œåœ¨åº”ç”¨å†…éƒ¨</td><td>ç‹¬ç«‹ä»£ç†ï¼Œè¿è¡Œåœ¨åº”ç”¨ä¸æ•°æ®åº“ä¹‹é—´</td></tr><tr><td>æ€§èƒ½</td><td>ä½ç½‘ç»œå¼€é”€ï¼Œæ€§èƒ½è¾ƒé«˜</td><td>å¼•å…¥ç½‘ç»œå¼€é”€ï¼Œæ€§èƒ½ç•¥ä½</td></tr><tr><td>æ”¯æŒè¯­è¨€</td><td>ä»…æ”¯æŒ Java</td><td>æ”¯æŒå¤šè¯­è¨€ï¼ˆJavaã€Pythonã€Go ç­‰ï¼‰</td></tr><tr><td>é…ç½®ç®¡ç†</td><td>åˆ†å¸ƒå¼é…ç½®è¾ƒå¤æ‚</td><td>æ”¯æŒé›†ä¸­é…ç½®å’ŒåŠ¨æ€ç®¡ç†</td></tr><tr><td>æ‰©å±•æ€§</td><td>éšç€åº”ç”¨æ‰©å±•ï¼Œéœ€å•ç‹¬è°ƒæ•´é…ç½®</td><td>ä»£ç†æœåŠ¡é›†ä¸­åŒ–ç®¡ç†ï¼Œæ‰©å±•æ€§å¼ºã€å¤šè¯­è¨€</td></tr><tr><td>é€‚ç”¨åœºæ™¯</td><td>å•ä½“æˆ–å°å‹ç³»ç»Ÿï¼Œå¯¹æ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯</td><td>å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–éœ€è¦ç»Ÿä¸€ç®¡ç†çš„åœºæ™¯</td></tr></tbody></table><p>å¯¹å¤§å¤šæ•° Java é¡¹ç›®æ¥è¯´ï¼Œé€‰æ‹© ShardingSphere-JDBC å°±è¶³å¤Ÿäº†ï¼›å¯¹äºè·¨è¯­è¨€çš„å¤§å‹åˆ†å¸ƒå¼é¡¹ç›®ã€æˆ–è€…å…¬å¸å†…æœ‰æŠ€æœ¯éƒ¨é—¨ç»Ÿä¸€ç®¡ç†åŸºç¡€è®¾æ–½çš„æƒ…å†µä¸‹ï¼Œå†è€ƒè™‘ä½¿ç”¨ ShardingSphere-Proxyã€‚</p><p>æœ¬é¡¹ç›®ä¹Ÿå°†ä½¿ç”¨ ShardingSphere-JDBCï¼Œåœ¨ä¾èµ–æ–‡ä»¶ä¸­å¼•å…¥ï¼šsh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- åˆ†åº“åˆ†è¡¨ --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>shardingsphere-jdbc-core-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4ã€åˆ†åº“åˆ†è¡¨ç­–ç•¥-é™æ€åˆ†è¡¨" tabindex="-1"><a class="header-anchor" href="#_4ã€åˆ†åº“åˆ†è¡¨ç­–ç•¥-é™æ€åˆ†è¡¨" aria-hidden="true">#</a> 4ã€åˆ†åº“åˆ†è¡¨ç­–ç•¥ - é™æ€åˆ†è¡¨</h4><p>åˆ†åº“åˆ†è¡¨çš„ç­–ç•¥æ€»ä½“åˆ†ä¸º 2 ç±»ï¼šé™æ€åˆ†è¡¨å’ŒåŠ¨æ€åˆ†è¡¨ï¼Œä¸‹é¢å…ˆè®²é™æ€åˆ†è¡¨ã€‚</p><p>åœ¨è®¾è®¡é˜¶æ®µï¼Œåˆ†è¡¨çš„æ•°é‡å’Œè§„åˆ™å°±æ˜¯å›ºå®šçš„ï¼Œä¸ä¼šæ ¹æ®ä¸šåŠ¡å¢é•¿åŠ¨æ€è°ƒæ•´ï¼Œæ¯”å¦‚ picture_0ã€picture_1ã€‚</p><p>åˆ†ç‰‡è§„åˆ™é€šå¸¸åŸºäºæŸä¸€å­—æ®µï¼ˆå¦‚å›¾ç‰‡ idï¼‰é€šè¿‡ç®€å•è§„åˆ™ï¼ˆå¦‚å–æ¨¡ã€èŒƒå›´ï¼‰æ¥å†³å®šæ•°æ®å­˜å‚¨åœ¨å“ªä¸ªè¡¨æˆ–åº“ä¸­ã€‚</p><p>è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹æ˜¯ç®€å•ã€å¥½ç†è§£ï¼›ç¼ºç‚¹æ˜¯ä¸åˆ©äºæ‰©å±•ï¼Œéšç€æ•°æ®é‡å¢é•¿ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨è°ƒæ•´åˆ†è¡¨æ•°é‡å¹¶è¿ç§»æ•°æ®ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå›¾ç‰‡è¡¨æŒ‰å›¾ç‰‡ id å¯¹ 4 å–æ¨¡æ‹†åˆ†ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> tableName <span class="token operator">=</span> <span class="token string">&quot;picture_&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>pictureId <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// picture_0 ~ picture_3</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>é™æ€åˆ†è¡¨çš„å®ç°å¾ˆç®€å•ï¼Œç›´æ¥åœ¨ <code>application.yml</code> ä¸­ç¼–å†™ ShardingSphere çš„é…ç½®å°±èƒ½å®Œæˆåˆ†åº“åˆ†è¡¨ï¼Œæ¯”å¦‚ï¼š</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token key atrule">sharding</span><span class="token punctuation">:</span>
    <span class="token key atrule">tables</span><span class="token punctuation">:</span>
      <span class="token key atrule">picture</span><span class="token punctuation">:</span>
        <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> ds0.picture_$<span class="token punctuation">{</span>0..2<span class="token punctuation">}</span> <span class="token comment"># 3å¼ åˆ†è¡¨ï¼špicture_0, picture_1, picture_2</span>
        <span class="token key atrule">tableStrategy</span><span class="token punctuation">:</span>
          <span class="token key atrule">standard</span><span class="token punctuation">:</span>
            <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> pictureId       <span class="token comment"># æŒ‰ pictureId åˆ†ç‰‡</span>
            <span class="token key atrule">shardingAlgorithmName</span><span class="token punctuation">:</span> pictureIdMod
    <span class="token key atrule">shardingAlgorithms</span><span class="token punctuation">:</span>
      <span class="token key atrule">pictureIdMod</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> INLINE
        <span class="token key atrule">props</span><span class="token punctuation">:</span>
          <span class="token key atrule">algorithm-expression</span><span class="token punctuation">:</span> picture_$<span class="token punctuation">{</span>pictureId % 3<span class="token punctuation">}</span> <span class="token comment"># åˆ†ç‰‡è¡¨è¾¾å¼</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½ ç”šè‡³ä¸éœ€è¦ä¿®æ”¹ä»»ä½•ä¸šåŠ¡ä»£ç ï¼Œåœ¨æŸ¥è¯¢ picture è¡¨ï¼ˆä¸€èˆ¬å«é€»è¾‘è¡¨ï¼‰æ—¶ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨å¸®ä½ ä¿®æ”¹ SQLï¼Œæ ¹æ® pictureId å°†æŸ¥è¯¢è¯·æ±‚è·¯ç”±åˆ°ä¸åŒçš„è¡¨ä¸­ã€‚å¦‚æœè¦è¿›è¡Œåˆ†é¡µå¤šæ¡æ•°æ®æŸ¥è¯¢ï¼Œä½ åªéœ€è¦å†™ä¸€æ¡æŸ¥è¯¢é€»è¾‘è¡¨çš„ SQL è¯­å¥å³å¯ï¼š</p><div class="language-plain line-numbers-mode" data-ext="plain"><pre class="language-plain"><code>SELECT * FROM picture;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å®é™…ä¸Šï¼ŒShardingSphere å°†æŸ¥è¯¢é€»è¾‘è¡¨ <code>picture</code> çš„è¯·æ±‚è‡ªåŠ¨è·¯ç”±åˆ°æ‰€æœ‰å®é™…åˆ†è¡¨ picture_1ã€picture_2 ... picture_Nï¼Œè·å–åˆ°æ•°æ®åï¼Œåœ¨ä¸­é—´ä»¶å±‚è‡ªåŠ¨åˆå¹¶ç»“æœå¹¶è¿”å›ç»™åº”ç”¨ç¨‹åºã€‚</p><h4 id="_5ã€åˆ†åº“åˆ†è¡¨ç­–ç•¥-åŠ¨æ€åˆ†è¡¨" tabindex="-1"><a class="header-anchor" href="#_5ã€åˆ†åº“åˆ†è¡¨ç­–ç•¥-åŠ¨æ€åˆ†è¡¨" aria-hidden="true">#</a> <strong>5ã€åˆ†åº“åˆ†è¡¨ç­–ç•¥ - åŠ¨æ€åˆ†è¡¨</strong></h4><p>åŠ¨æ€åˆ†è¡¨æ˜¯æŒ‡åˆ†è¡¨çš„æ•°é‡å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚æˆ–æ•°æ®é‡åŠ¨æ€å¢åŠ ï¼Œè¡¨çš„ç»“æ„å’Œè§„åˆ™æ˜¯è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆçš„ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæ ¹æ®æ—¶é—´åŠ¨æ€åˆ›å»º picture_2025_01ã€picture_2025_02ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> tableName <span class="token operator">=</span> <span class="token string">&quot;picture_&quot;</span> <span class="token operator">+</span> <span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
    <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy_MM&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ˜¾ç„¶ï¼ŒåŠ¨æ€åˆ†è¡¨æ›´çµæ´»ã€æ‰©å±•æ€§å¼ºï¼Œé€‚åˆæ•°æ®é‡å¿«é€Ÿå¢é•¿çš„åœºæ™¯ï¼›ä½†ç¼ºç‚¹æ˜¯å®ç°æ›´å¤æ‚ï¼Œéœ€è¦åŠ¨æ€ç”Ÿæˆè¡¨å¹¶ç»´æŠ¤è¡¨çš„å…ƒä¿¡æ¯ã€‚å¦‚æœæ²¡æœ‰æ§åˆ¶å¥½ï¼Œè¯´ä¸å®šåˆ†è¡¨ç‰¹åˆ«å¤šï¼Œåè€Œå½±å“äº†æ•°æ®åº“çš„æ€§èƒ½ã€‚</p><p>åŠ¨æ€åˆ†è¡¨çš„å®ç°å°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œé¦–å…ˆè¦è‡ªå®šä¹‰åˆ†è¡¨ç®—æ³•ç±»ï¼Œè¿˜è¦åœ¨ä»£ç ä¸­ç¼–å†™åŠ¨æ€åˆ›å»ºè¡¨çš„é€»è¾‘ã€‚</p><p>è‡ªå®šä¹‰åˆ†è¡¨ç®—æ³•ç±»ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PictureShardingAlgorithm</span> <span class="token keyword">implements</span> <span class="token class-name">StandardShardingAlgorithm</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">doSharding</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> availableTargetNames<span class="token punctuation">,</span> <span class="token class-name">PreciseShardingValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> preciseShardingValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç¼–å†™åˆ†è¡¨é€»è¾‘ï¼Œè¿”å›å®é™…è¦æŸ¥è¯¢çš„è¡¨å</span>
        <span class="token comment">// picture_0 ç‰©ç†è¡¨ï¼Œpicture é€»è¾‘è¡¨</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSharding</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> collection<span class="token punctuation">,</span> <span class="token class-name">RangeShardingValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> rangeShardingValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Properties</span> <span class="token function">getProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹äºæˆ‘ä»¬çš„é¡¹ç›®ï¼Œç”±äºç©ºé—´æ˜¯ç”¨æˆ·åŠ¨æ€åˆ›å»ºçš„ï¼Œæ˜¾ç„¶è¦ä½¿ç”¨åŠ¨æ€åˆ†è¡¨ï¼Œä¸‹é¢æ¥å®ç°ã€‚</p><h4 id="_6ã€åŠ¨æ€åˆ†è¡¨ç®—æ³•å¼€å‘" tabindex="-1"><a class="header-anchor" href="#_6ã€åŠ¨æ€åˆ†è¡¨ç®—æ³•å¼€å‘" aria-hidden="true">#</a> 6ã€åŠ¨æ€åˆ†è¡¨ç®—æ³•å¼€å‘</h4><p>æ ¹æ®éœ€æ±‚ï¼Œæˆ‘ä»¬å¸Œæœ›å°†æ¯ä¸ªæ——èˆ°ç‰ˆç©ºé—´çš„å›¾ç‰‡å•ç‹¬å­˜æ”¾åœ¨ä¸€èµ·ï¼Œæ˜¾ç„¶æ˜¯æŒ‰ç…§ <code>spaceId</code> åˆ†è¡¨ï¼Œé‚£ä¹ˆåˆ†è¡¨çš„åç§°è§„åˆ™ä¸º <code>picture_${spaceId}</code>ã€‚</p><p>1ï¼‰é¦–å…ˆç¼–å†™åŠ¨æ€åˆ†è¡¨çš„é…ç½®ï¼ŒåŒ…æ‹¬æ•°æ®åº“è¿æ¥ã€åˆ†è¡¨è§„åˆ™ã€åˆ†è¡¨ç®—æ³•ï¼šeSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=De2I4UrW20CPScxCcSU7uF8KCFatINtQxzkRHs4rQgs=3n/Enp4sfaVRq/PFMJKPxPdBTxeNas/Bp33wsl/l9Wg=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=J+5o58b0kn/bTqd/50F76o1L2/PhqvQWrl14ca26WW0=</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token comment"># ç©ºé—´å›¾ç‰‡åˆ†è¡¨</span>
  <span class="token key atrule">shardingsphere</span><span class="token punctuation">:</span>
    <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
      <span class="token key atrule">names</span><span class="token punctuation">:</span> yu_picture
      <span class="token key atrule">yu_picture</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource
        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/yu_picture
        <span class="token key atrule">username</span><span class="token punctuation">:</span> root
        <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>
    <span class="token key atrule">rules</span><span class="token punctuation">:</span>
      <span class="token key atrule">sharding</span><span class="token punctuation">:</span>
        <span class="token key atrule">tables</span><span class="token punctuation">:</span>
          <span class="token key atrule">picture</span><span class="token punctuation">:</span>
            <span class="token key atrule">actual-data-nodes</span><span class="token punctuation">:</span> yu_picture.picture  <span class="token comment"># åŠ¨æ€åˆ†è¡¨</span>
            <span class="token key atrule">table-strategy</span><span class="token punctuation">:</span>
              <span class="token key atrule">standard</span><span class="token punctuation">:</span>
                <span class="token key atrule">sharding-column</span><span class="token punctuation">:</span> spaceId
                <span class="token key atrule">sharding-algorithm-name</span><span class="token punctuation">:</span> picture_sharding_algorithm  <span class="token comment"># ä½¿ç”¨è‡ªå®šä¹‰åˆ†ç‰‡ç®—æ³•</span>
        <span class="token key atrule">sharding-algorithms</span><span class="token punctuation">:</span>
          <span class="token key atrule">picture_sharding_algorithm</span><span class="token punctuation">:</span>
            <span class="token key atrule">type</span><span class="token punctuation">:</span> CLASS_BASED
            <span class="token key atrule">props</span><span class="token punctuation">:</span>
              <span class="token key atrule">strategy</span><span class="token punctuation">:</span> standard
              <span class="token key atrule">algorithmClassName</span><span class="token punctuation">:</span> com.yupi.yupicturebackend.manager.sharding.PictureShardingAlgorithm
    <span class="token key atrule">props</span><span class="token punctuation">:</span>
      <span class="token key atrule">sql-show</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä¸­ï¼Œæœ‰å‡ ä¸ªç»†èŠ‚éœ€è¦æ³¨æ„ï¼š</p><ol><li><code>actual-data-nodes</code> ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯æŒ‡å®šä¸€æ®µåˆ†è¡¨çš„èŒƒå›´ï¼Œæ¯”å¦‚ <code>yu_picture.picture_${0..9999}</code> è¡¨ç¤ºæœ‰ picture_0 ~ picture_9999 è¿™ 10000 å¼ åˆ†è¡¨ã€‚ShardingSphere åœ¨æ‰§è¡Œåˆ†è¡¨æŸ¥è¯¢æ—¶ä¼šæ ¡éªŒè¦æŸ¥è¯¢çš„è¡¨ï¼ˆæ¯”å¦‚ picture_123456789ï¼‰æ˜¯å¦åœ¨ actual-data-nodes çš„é…ç½®èŒƒå›´å†…ã€‚ä½†æ˜¯ç”±äº spaceId æ˜¯é•¿æ•´å‹ï¼ŒèŒƒå›´å¤ªå¤§ï¼Œæ— æ³•é€šè¿‡æŒ‡å®šèŒƒå›´å°†æ‰€æœ‰åˆ†è¡¨åç§°åŒ…å«ï¼Œå¯¼è‡´æ— æ³•é€šè¿‡æ¡†æ¶å†…ç½®çš„æ ¡éªŒã€‚æ‰€ä»¥æ­¤å¤„å°† actual-data-nodes çš„å€¼è®¾ç½®ä¸ºé€»è¾‘è¡¨ <code>yu_picture.picture</code>ã€‚</li><li>æŒ‡å®šåˆ†è¡¨å­—æ®µä¸º spaceIdã€åˆ†è¡¨ç®—æ³•ä¸ºè‡ªå®šä¹‰çš„åˆ†ç‰‡ç®—æ³• <code>picture_sharding_algorithm</code>ã€‚</li><li>é…ç½®è‡ªå®šä¹‰åˆ†ç‰‡ç®—æ³•ï¼Œé‡‡ç”¨åŸºäºè‡ªå®šä¹‰ç±»çš„æ–¹å¼å®ç°ï¼Œç®—æ³•çš„ç±»åé…ç½®å¿…é¡»ä¸ºç±»çš„ç»å¯¹è·¯å¾„ã€‚</li></ol><p>2ï¼‰ç¼–å†™å›¾ç‰‡åˆ†è¡¨ç®—æ³•ç±»ï¼Œå¿…é¡»å®ç° <code>StandardShardingAlgorithm</code> æ¥å£ã€‚æ ¸å¿ƒæ˜¯ç¼–å†™ doSharding æ–¹æ³•ï¼Œæ ¹æ® spaceId è·å–åˆ°å®é™…è¦æŸ¥è¯¢çš„åˆ†è¡¨åï¼Œå¦‚æœ spaceId ä¸å­˜åœ¨åˆ†è¡¨ï¼ˆæ¯”å¦‚æ˜¯ç§æœ‰ç©ºé—´ï¼‰æˆ–è€… spaceId ä¸ºç©ºï¼ˆå…¬å…±å›¾åº“ï¼‰ï¼Œé‚£ä¹ˆå°±ä»åŸè¡¨ï¼ˆé€»è¾‘è¡¨ï¼‰picture æŸ¥è¯¢ã€‚</p><p>ä¹‹æ‰€ä»¥è¦åšå…¼å®¹ï¼Œæ˜¯å› ä¸ºè™½ç„¶æˆ‘ä»¬è®¾è®¡ä¸Šåªå¯¹å›¢é˜Ÿç©ºé—´è¿›è¡Œåˆ†åº“åˆ†è¡¨ï¼Œä½†æ˜¯ä¸€æ—¦å¼•å…¥äº†åˆ†åº“åˆ†è¡¨æ¡†æ¶ï¼ŒæŸ¥è¯¢ picture è¡¨æ—¶å°±ä¼šè§¦å‘åˆ†è¡¨é€»è¾‘ã€‚</p><p>åœ¨ <code>manager.sharding</code> åŒ…ä¸‹æ–°å»ºåˆ†è¡¨ç®—æ³•ç±»ï¼šeSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=Qa3v8kJfD9ydXDE4/vPOgwfYmrXA9YU8UYtmLbMMjzs=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=58IUDBvyDy7G+gVMqAunJfAo72ZBX//2DD/nhaX54Xg=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=eSasHSGfWfAWFdHk80qa2pFPfNtK5fDlnveBE/gAkZQ=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=sh73BCt3Qxf5JT1JjRCD/wiXC5EF5J2PadQ+z7zCgT0=4AeqD6wp8ZemHEHZXii0QseGHx9Ks4t5/a/SqKw4Xao=LeY+CMP/iVrjKScwdgoauOiyW1XV5gYPHt1Hp/RYkek=LRHaTWpO/TqfSq02pCgjgzFumTJ6kTTHTt+i9QKq4l0=</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PictureShardingAlgorithm</span> <span class="token keyword">implements</span> <span class="token class-name">StandardShardingAlgorithm</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">doSharding</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> availableTargetNames<span class="token punctuation">,</span> <span class="token class-name">PreciseShardingValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> preciseShardingValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> spaceId <span class="token operator">=</span> preciseShardingValue<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> logicTableName <span class="token operator">=</span> preciseShardingValue<span class="token punctuation">.</span><span class="token function">getLogicTableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// spaceId ä¸º null è¡¨ç¤ºæŸ¥è¯¢æ‰€æœ‰å›¾ç‰‡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>spaceId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> logicTableName<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// æ ¹æ® spaceId åŠ¨æ€ç”Ÿæˆåˆ†è¡¨å</span>
        <span class="token class-name">String</span> realTableName <span class="token operator">=</span> <span class="token string">&quot;picture_&quot;</span> <span class="token operator">+</span> spaceId<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>availableTargetNames<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>realTableName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> realTableName<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> logicTableName<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSharding</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> collection<span class="token punctuation">,</span> <span class="token class-name">RangeShardingValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> rangeShardingValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Properties</span> <span class="token function">getProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3ï¼‰å…‰æœ‰ä¸Šè¿°ä»£ç è¿˜ä¸èƒ½å®ŒæˆåŠ¨æ€åˆ†è¡¨ï¼Œå› ä¸º availableTargetNamesï¼ˆå¯ç”¨çš„åˆ†è¡¨ï¼‰å§‹ç»ˆä¸ºé€»è¾‘è¡¨å <code>picture</code>ï¼åŸå› åœ¨äº ShardingSphere åœ¨åˆ†ç‰‡é€»è¾‘åˆå§‹åŒ–æ—¶é»˜è®¤è·å–çš„æ˜¯é…ç½®çš„ <code>actual-data-nodes</code> ä¸­çš„ç›®æ ‡è¡¨åï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å†™çš„å›ºå®šå€¼ã€‚è¿™æ ·è¿˜æ˜¯æ— æ³•é€šè¿‡ ShardingSphere çš„æŸ¥è¯¢æ ¡éªŒï¼Œæˆ‘ä»¬ä¹Ÿæ²¡åŠæ³•åˆ¤æ–­ spaceId æ˜¯å¦è¦åˆ†è¡¨ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// availableTargetNames å§‹ç»ˆä¸º pictureï¼Œæ— æ³•è¿”å›çœŸå®çš„åˆ†è¡¨</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>availableTargetNames<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>realTableName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> realTableName<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> logicTableName<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ—¢ç„¶æ¡†æ¶è‡ªèº«ä¸æ”¯æŒåŠ¨æ€ç»´æŠ¤åˆ†è¡¨ï¼Œé‚£æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªåˆ†è¡¨ç®¡ç†å™¨ï¼Œè‡ªå·±æ¥ç»´æŠ¤åˆ†è¡¨åˆ—è¡¨ï¼Œå¹¶æ›´æ–°åˆ° ShardingSphere çš„ <code>actual-data-nodes</code> é…ç½®ä¸­ã€‚</p><p>åœ¨ <code>manager.sharding</code> åŒ…ä¸‹æ–°å»ºåˆ†è¡¨ç®¡ç†å™¨ç±»ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicShardingManager</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">SpaceService</span> spaceService<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">LOGIC_TABLE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;picture&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DATABASE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;logic_db&quot;</span><span class="token punctuation">;</span> <span class="token comment">// é…ç½®æ–‡ä»¶ä¸­çš„æ•°æ®åº“åç§°</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;åˆå§‹åŒ–åŠ¨æ€åˆ†è¡¨é…ç½®...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateShardingTableNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * è·å–æ‰€æœ‰åŠ¨æ€è¡¨åï¼ŒåŒ…æ‹¬åˆå§‹è¡¨ picture å’Œåˆ†è¡¨ picture_<span class="token punctuation">{</span>spaceId<span class="token punctuation">}</span>
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">fetchAllPictureTableNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œç›´æ¥å¯¹æ‰€æœ‰å›¢é˜Ÿç©ºé—´åˆ†è¡¨ï¼ˆå®é™…ä¸Šçº¿æ”¹ä¸ºä»…å¯¹æ——èˆ°ç‰ˆç”Ÿæ•ˆï¼‰</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> spaceIds <span class="token operator">=</span> spaceService<span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">Space</span><span class="token operator">::</span><span class="token function">getSpaceType</span><span class="token punctuation">,</span> <span class="token class-name">SpaceTypeEnum</span><span class="token punctuation">.</span><span class="token constant">TEAM</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Space</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> tableNames <span class="token operator">=</span> spaceIds<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>spaceId <span class="token operator">-&gt;</span> <span class="token constant">LOGIC_TABLE_NAME</span> <span class="token operator">+</span> <span class="token string">&quot;_&quot;</span> <span class="token operator">+</span> spaceId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tableNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">LOGIC_TABLE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ·»åŠ åˆå§‹é€»è¾‘è¡¨</span>
        <span class="token keyword">return</span> tableNames<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * æ›´æ–° ShardingSphere çš„ actual-data-nodes åŠ¨æ€è¡¨åé…ç½®
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateShardingTableNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> tableNames <span class="token operator">=</span> <span class="token function">fetchAllPictureTableNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> newActualDataNodes <span class="token operator">=</span> tableNames<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>tableName <span class="token operator">-&gt;</span> <span class="token string">&quot;yu_picture.&quot;</span> <span class="token operator">+</span> tableName<span class="token punctuation">)</span> <span class="token comment">// ç¡®ä¿å‰ç¼€åˆæ³•</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;åŠ¨æ€åˆ†è¡¨ actual-data-nodes é…ç½®: {}&quot;</span><span class="token punctuation">,</span> newActualDataNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ContextManager</span> contextManager <span class="token operator">=</span> <span class="token function">getContextManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ShardingSphereRuleMetaData</span> ruleMetaData <span class="token operator">=</span> contextManager<span class="token punctuation">.</span><span class="token function">getMetaDataContexts</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getMetaData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getDatabases</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">DATABASE_NAME</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getRuleMetaData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ShardingRule</span><span class="token punctuation">&gt;</span></span> shardingRule <span class="token operator">=</span> ruleMetaData<span class="token punctuation">.</span><span class="token function">findSingleRule</span><span class="token punctuation">(</span><span class="token class-name">ShardingRule</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shardingRule<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ShardingRuleConfiguration</span> ruleConfig <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ShardingRuleConfiguration</span><span class="token punctuation">)</span> shardingRule<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ShardingTableRuleConfiguration</span><span class="token punctuation">&gt;</span></span> updatedRules <span class="token operator">=</span> ruleConfig<span class="token punctuation">.</span><span class="token function">getTables</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>oldTableRule <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LOGIC_TABLE_NAME</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>oldTableRule<span class="token punctuation">.</span><span class="token function">getLogicTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">ShardingTableRuleConfiguration</span> newTableRuleConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShardingTableRuleConfiguration</span><span class="token punctuation">(</span><span class="token constant">LOGIC_TABLE_NAME</span><span class="token punctuation">,</span> newActualDataNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            newTableRuleConfig<span class="token punctuation">.</span><span class="token function">setDatabaseShardingStrategy</span><span class="token punctuation">(</span>oldTableRule<span class="token punctuation">.</span><span class="token function">getDatabaseShardingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            newTableRuleConfig<span class="token punctuation">.</span><span class="token function">setTableShardingStrategy</span><span class="token punctuation">(</span>oldTableRule<span class="token punctuation">.</span><span class="token function">getTableShardingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            newTableRuleConfig<span class="token punctuation">.</span><span class="token function">setKeyGenerateStrategy</span><span class="token punctuation">(</span>oldTableRule<span class="token punctuation">.</span><span class="token function">getKeyGenerateStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            newTableRuleConfig<span class="token punctuation">.</span><span class="token function">setAuditStrategy</span><span class="token punctuation">(</span>oldTableRule<span class="token punctuation">.</span><span class="token function">getAuditStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> newTableRuleConfig<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span> oldTableRule<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ruleConfig<span class="token punctuation">.</span><span class="token function">setTables</span><span class="token punctuation">(</span>updatedRules<span class="token punctuation">)</span><span class="token punctuation">;</span>
            contextManager<span class="token punctuation">.</span><span class="token function">alterRuleConfiguration</span><span class="token punctuation">(</span><span class="token constant">DATABASE_NAME</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singleton</span><span class="token punctuation">(</span>ruleConfig<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            contextManager<span class="token punctuation">.</span><span class="token function">reloadDatabase</span><span class="token punctuation">(</span><span class="token constant">DATABASE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;åŠ¨æ€åˆ†è¡¨è§„åˆ™æ›´æ–°æˆåŠŸï¼&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;æœªæ‰¾åˆ° ShardingSphere çš„åˆ†ç‰‡è§„åˆ™é…ç½®ï¼ŒåŠ¨æ€åˆ†è¡¨æ›´æ–°å¤±è´¥ã€‚&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * è·å– ShardingSphere ContextManager
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">ContextManager</span> <span class="token function">getContextManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ShardingSphereConnection</span> connection <span class="token operator">=</span> dataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token class-name">ShardingSphereConnection</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">getContextManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;è·å– ShardingSphere ContextManager å¤±è´¥&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ä»£ç è™½ç„¶çœ‹èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œä½†å…¶å®ä¸éš¾ç†è§£ï¼Œä¸»è¦åšäº†è¿™ä¹ˆå‡ ä»¶äº‹ï¼š</p><ol><li>å°†ç®¡ç†å™¨æ³¨å†Œä¸º Beanï¼Œé€šè¿‡ <code>@PostConstruct</code> æ³¨è§£ï¼Œåœ¨ Bean åŠ è½½åè·å–æ‰€æœ‰çš„åˆ†è¡¨å¹¶æ›´æ–°é…ç½®ã€‚</li><li>ç¼–å†™è·å–åˆ†è¡¨åˆ—è¡¨çš„æ–¹æ³•ï¼Œä»æ•°æ®åº“ä¸­æŸ¥è¯¢ç¬¦åˆè¦æ±‚çš„ç©ºé—´åˆ—è¡¨ï¼Œå†è¡¥å……ä¸Šé€»è¾‘è¡¨ï¼Œå°±å¾—åˆ°äº†å®Œæ•´çš„åˆ†è¡¨åˆ—è¡¨ã€‚</li><li>æ›´æ–° ShardingSphere çš„ actual-data-nodes åŠ¨æ€è¡¨åé…ç½®ã€‚è·å–åˆ° ShardingSphere çš„ ContextManagerï¼Œæ‰¾åˆ°é…ç½®æ–‡ä»¶ä¸­çš„é‚£æ¡è§„åˆ™è¿›è¡Œæ›´æ–°å³å¯ã€‚</li></ol><p>4ï¼‰åŠ¨æ€åˆ›å»ºåˆ†è¡¨</p><p>åœ¨åˆ†è¡¨ç®¡ç†å™¨ä¸­æ–°å¢åŠ¨æ€åˆ›å»ºåˆ†è¡¨çš„æ–¹æ³•ï¼Œé€šè¿‡æ‹¼æ¥ SQL çš„æ–¹å¼åˆ›å»ºå‡ºå’Œ picture è¡¨ç»“æ„ä¸€æ ·çš„åˆ†è¡¨ï¼Œåˆ›å»ºæ–°çš„åˆ†è¡¨åè®°å¾—æ›´æ–°åˆ†è¡¨èŠ‚ç‚¹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createSpacePictureTable</span><span class="token punctuation">(</span><span class="token class-name">Space</span> space<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åŠ¨æ€åˆ›å»ºåˆ†è¡¨</span>
    <span class="token comment">// ä»…ä¸ºæ——èˆ°ç‰ˆå›¢é˜Ÿç©ºé—´åˆ›å»ºåˆ†è¡¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>space<span class="token punctuation">.</span><span class="token function">getSpaceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">SpaceTypeEnum</span><span class="token punctuation">.</span><span class="token constant">TEAM</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> space<span class="token punctuation">.</span><span class="token function">getSpaceLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">SpaceLevelEnum</span><span class="token punctuation">.</span><span class="token constant">FLAGSHIP</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> spaceId <span class="token operator">=</span> space<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> tableName <span class="token operator">=</span> <span class="token string">&quot;picture_&quot;</span> <span class="token operator">+</span> spaceId<span class="token punctuation">;</span>
        <span class="token comment">// åˆ›å»ºæ–°è¡¨</span>
        <span class="token class-name">String</span> createTableSql <span class="token operator">=</span> <span class="token string">&quot;CREATE TABLE &quot;</span> <span class="token operator">+</span> tableName <span class="token operator">+</span> <span class="token string">&quot; LIKE picture&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">SqlRunner</span><span class="token punctuation">.</span><span class="token function">db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>createTableSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ›´æ–°åˆ†è¡¨</span>
            <span class="token function">updateShardingTableNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;åˆ›å»ºå›¾ç‰‡ç©ºé—´åˆ†è¡¨å¤±è´¥ï¼Œç©ºé—´ id = {}&quot;</span><span class="token punctuation">,</span> space<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„ï¼Œæƒ³è¦ä½¿ç”¨ MyBatis Plus çš„ SqlRunnerï¼Œå¿…é¡»è¦å¼€å¯é…ç½®ï¼š</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">mybatis-plus</span><span class="token punctuation">:</span>
  <span class="token key atrule">global-config</span><span class="token punctuation">:</span>
    <span class="token key atrule">enable-sql-runner</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶ååœ¨åˆ›å»ºç©ºé—´æ—¶ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// å¦‚æœæ˜¯å›¢é˜Ÿç©ºé—´ï¼Œå…³è”æ–°å¢å›¢é˜Ÿæˆå‘˜è®°å½•</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SpaceTypeEnum</span><span class="token punctuation">.</span><span class="token constant">TEAM</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> spaceAddRequest<span class="token punctuation">.</span><span class="token function">getSpaceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SpaceUser</span> spaceUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpaceUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    spaceUser<span class="token punctuation">.</span><span class="token function">setSpaceId</span><span class="token punctuation">(</span>space<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    spaceUser<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    spaceUser<span class="token punctuation">.</span><span class="token function">setSpaceRole</span><span class="token punctuation">(</span><span class="token class-name">SpaceRoleEnum</span><span class="token punctuation">.</span><span class="token constant">ADMIN</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> spaceUserService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>spaceUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThrowUtils</span><span class="token punctuation">.</span><span class="token function">throwIf</span><span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">OPERATION_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;åˆ›å»ºå›¢é˜Ÿæˆå‘˜è®°å½•å¤±è´¥&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// åˆ›å»ºåˆ†è¡¨</span>
dynamicShardingManager<span class="token punctuation">.</span><span class="token function">createSpacePictureTable</span><span class="token punctuation">(</span>space<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// è¿”å›æ–°å†™å…¥çš„æ•°æ® id</span>
<span class="token keyword">return</span> space<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è‡³æ­¤ï¼ŒåŠ¨æ€åˆ†è¡¨å°±å¼€å‘å®Œæˆäº†ã€‚</p><p>ğŸ’¡ å…¶å® ShardingSphere è¿˜æä¾›äº† <strong>hint å¼ºåˆ¶åˆ†è¡¨è·¯ç”±æœºåˆ¶</strong> æ¥å®ç°åŠ¨æ€åˆ†è¡¨ï¼Œå…è®¸åœ¨ä»£ç ä¸­å¼ºåˆ¶æŒ‡å®šå…·ä½“çš„ç‰©ç†è¡¨ï¼Œä»è€Œè§£å†³åŠ¨æ€åˆ†è¡¨é—®é¢˜ã€‚ä½†ç¼ºç‚¹æ˜¯éœ€è¦åœ¨æ¯æ¬¡æŸ¥è¯¢æˆ–è€…æ“ä½œæ•°æ®æ—¶éƒ½æ˜¾å¼è®¾ç½®è¡¨åï¼Œä¼šç»™ä»£ç å¢åŠ å¾ˆå¤šé¢å¤–é€»è¾‘ï¼Œä¸å¤Ÿä¼˜é›…ã€‚æ‰€ä»¥ä¸é‡‡ç”¨ï¼Œå¤§å®¶äº†è§£ä¸€ä¸‹å³å¯ã€‚</p><h4 id="_7ã€æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_7ã€æµ‹è¯•" aria-hidden="true">#</a> 7ã€æµ‹è¯•</h4><p>åˆ†è¡¨æ˜¯ä¸ªå¯¹ç³»ç»Ÿå½±å“å¾ˆå¤§çš„æ“ä½œï¼Œæ‰€ä»¥è¦è¿›è¡Œä¸¥æ ¼çš„æµ‹è¯•ã€‚</p><p>å¦‚æœå¯åŠ¨é¡¹ç›®æ—¶å‡ºç°äº†å¾ªç¯ä¾èµ–ï¼š</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221612634.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å¯ä»¥æ·»åŠ  Lazy æ³¨è§£è§£å†³ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token annotation punctuation">@Lazy</span>
<span class="token keyword">private</span> <span class="token class-name">DynamicShardingManager</span> dynamicShardingManager<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1ï¼‰å•ç‹¬æŸ¥è¯¢æŸä¸ªå›¾ç‰‡ï¼Œä¸æŒ‡å®š spaceId æŸ¥è¯¢æ¡ä»¶æ—¶ï¼Œä¼šè‡ªåŠ¨æŸ¥æ‰€æœ‰çš„ picture è¡¨ï¼š</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221612767.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å†å²æ•°æ®ä¼šè‡ªåŠ¨å…¼å®¹ï¼Œåªè¦æŸ¥åˆ°çš„ spaceId æ²¡æœ‰åˆ†è¡¨ï¼Œéƒ½ä¼šæŸ¥åŸæ¥çš„ picture è¡¨ã€‚åªæœ‰æŒ‡å®š spaceId ä¸”å­˜åœ¨åˆ†è¡¨æ—¶ï¼Œæ‰ä¼šæŸ¥è¯¢ç‰¹å®šçš„å•å¼ åˆ†è¡¨ã€‚</p><p>2ï¼‰æŸ¥è¯¢å›¾ç‰‡åˆ—è¡¨ï¼Œä¸æŒ‡å®š spaceId æˆ– nullSpaceIdï¼ˆæŸ¥è¯¢ spaceId ä¸º null çš„å€¼ï¼‰æ—¶ï¼Œä¼šè‡ªåŠ¨æŸ¥æ‰€æœ‰çš„ picture è¡¨ã€‚æ‰€ä»¥æŸ¥è¯¢æ—¶é—´ä¼šéšç€åˆ†è¡¨æ•°å¢åŠ ï¼š</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221612506.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>3ï¼‰æµ‹è¯•æ•°æ®æ’å…¥ã€‚æ’å…¥æ—¶å¦‚æœæƒ³å¾€å…¬å…±ç©ºé—´æ’å…¥ï¼ˆä¸æŒ‡å®š spaceIdï¼‰ï¼Œå°±ä¼šæŠ¥é”™ï¼Œå› ä¸º ShardingSphere ä¸çŸ¥é“è¦æŠŠæ•°æ®æ’å…¥åˆ°å“ªä¸ªè¡¨ä¸­ã€‚</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221613615.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><strong>è¿™å°±æ„å‘³ç€ï¼Œå¦‚æœä½ è¦ä½¿ç”¨åˆ†è¡¨ï¼ŒspaceId å¿…é¡»ä¸èƒ½ä¸º nullï¼</strong></p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ’å…¥æ—¶ä¸€å®šè¦æŒ‡å®š spaceIdï¼Œå¯ä»¥çº¦å®šå…¬å…±ç©ºé—´çš„ spaceId éƒ½ä¸º 0ï¼Œå¹¶ä¸”åœ¨æ’å…¥æ—¶ä¸º spaceId è®¾ç½®é»˜è®¤å€¼ 0ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// è¡¥å……ç©ºé—´ idï¼Œé»˜è®¤ä¸º 0</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>spaceId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    picture<span class="token punctuation">.</span><span class="token function">setSpaceId</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ³¨æ„ï¼Œå¢åˆ æ”¹æŸ¥æ—¶éƒ½è¦è¡¥å…… spaceIdï¼Œæ‰èƒ½é¿å…æŠ¥é”™å’Œå¤šè¡¨æŸ¥è¯¢å½±å“æ•ˆç‡ã€‚</strong></p><p>æ¯”å¦‚æŸ¥è¯¢å•ä¸ªå›¾ç‰‡ï¼Œæ”¹ä¸ºé€šè¿‡ QueryWrapper æŒ‡å®š spaceId æŸ¥è¯¢ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// æ„é€  QueryWrapper</span>
<span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Picture</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span>         <span class="token comment">// æ ¹æ®ä¸»é”® id æŸ¥è¯¢</span>
            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;spaceId&quot;</span><span class="token punctuation">,</span> spaceId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é™„åŠ  spaceId æ¡ä»¶</span>

<span class="token comment">// æ‰§è¡ŒæŸ¥è¯¢</span>
<span class="token class-name">Picture</span> picture <span class="token operator">=</span> pictureService<span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ„é€ å›¾ç‰‡åˆ†é¡µæŸ¥è¯¢æ¡ä»¶æ—¶ï¼Œå¦‚æœæŸ¥è¯¢å…¬å…±å›¾åº“ï¼ŒspaceId æ”¹ä¸º 0ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>â–¼javaå¤åˆ¶ä»£ç queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>nullSpaceId<span class="token punctuation">,</span> <span class="token string">&quot;spaceId&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// queryWrapper.isNull(nullSpaceId, &quot;spaceId&quot;);</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>æ›´æ–° / æ‰¹é‡æ›´æ–°å›¾ç‰‡æ—¶ï¼Œè®¾ç½® spaceId ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// æ„é€  UpdateWrapper</span>
<span class="token class-name">UpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Picture</span><span class="token punctuation">&gt;</span></span> updateWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
updateWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> picture<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// æŒ‡å®šä¸»é”®æ¡ä»¶ï¼Œæ‰¹é‡æ›´æ–°åˆ™ä½¿ç”¨ in ä¼ é€’å¤šæ¡</span>
             <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;spaceId&quot;</span><span class="token punctuation">,</span> xxx<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// è¡¥å……æ¡ä»¶ spaceId=xxx</span>

<span class="token comment">// æ‰§è¡Œæ›´æ–°</span>
<span class="token keyword">boolean</span> result <span class="token operator">=</span> pictureService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>picture<span class="token punctuation">,</span> updateWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ é™¤å›¾ç‰‡æ—¶ï¼Œè®¾ç½® spaceId ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// æ„é€  QueryWrapper</span>
<span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Picture</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span>         <span class="token comment">// æŒ‡å®šä¸»é”® ID</span>
            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;spaceId&quot;</span><span class="token punctuation">,</span> spaceId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é™„åŠ  spaceId æ¡ä»¶</span>

<span class="token comment">// æ‰§è¡Œåˆ é™¤</span>
<span class="token keyword">boolean</span> result <span class="token operator">=</span> pictureService<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ³¨æ„ï¼Œåˆ†è¡¨åï¼Œpicture çš„ spaceId å°†ä¸èƒ½ä¿®æ”¹ï¼ï¼ï¼</strong></p><p>ç»è¿‡å¼€å‘å’Œæµ‹è¯•ï¼Œä½ ä¼šå‘ç°åŠ¨æ€åˆ†åº“åˆ†è¡¨çš„å®ç°éå¸¸éº»çƒ¦ã€‚æŸäº›å•è¡¨çš„æŸ¥è¯¢æ€§èƒ½æ˜¯é«˜äº†ï¼Œä½†æ•´ä½“æŸ¥è¯¢çš„æ€§èƒ½å¯èƒ½ä¼šå‡å°‘ï¼Œæ‰€ä»¥åŸåˆ™ä¸Š <strong>éå¿…è¦ä¸åˆ†è¡¨</strong>ï¼Œä¸€å®šè¦æ‰¾åˆ°åˆé€‚çš„åº”ç”¨åœºæ™¯ã€‚</p><p>è€ƒè™‘åˆ°è®©æ›´å¤šåŒå­¦åç»­ç›´æ¥éƒ¨ç½²é¡¹ç›®ï¼Œé™ä½ç†è§£æˆæœ¬ï¼Œæ•™ç¨‹ä¸­å°±ä¸å¸¦å¤§å®¶å®é™…æ‰§è¡Œä¸Šè¿°æ”¹é€ ç»†èŠ‚äº†ï¼Œå¹¶ä¸”æˆ‘å†æ•™å¤§å®¶ä¸€ç§å¯ä»¥å…³é—­åˆ†åº“åˆ†è¡¨çš„æ–¹æ³•ã€‚</p><h4 id="_8ã€å…³é—­åˆ†åº“åˆ†è¡¨-å¯é€‰" tabindex="-1"><a class="header-anchor" href="#_8ã€å…³é—­åˆ†åº“åˆ†è¡¨-å¯é€‰" aria-hidden="true">#</a> 8ã€å…³é—­åˆ†åº“åˆ†è¡¨ï¼ˆå¯é€‰ï¼‰</h4><p>1ï¼‰å¯åŠ¨ç±»æ’é™¤ä¾èµ–ï¼ˆé…ç½®æ–‡ä»¶å¯ä»¥ä¸æ³¨é‡Šï¼‰ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">ShardingSphereAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>2ï¼‰æ³¨é‡Šæ‰åˆ†åº“åˆ†è¡¨ç®¡ç†å™¨ç»„ä»¶ DynamicShardingManagerï¼š</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503221432273.webp" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>3ï¼‰æ³¨é‡Šæ‰ä½¿ç”¨ DynamicShardingManager æ–¹æ³•çš„ä»£ç ï¼Œæ¯”å¦‚ç©ºé—´æœåŠ¡ä¸­å¯¹å…¶çš„å¼•ç”¨ã€åˆ›å»ºåˆ†è¡¨çš„ä»£ç ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// @Resource</span>
<span class="token comment">// @Lazy</span>
<span class="token comment">// private DynamicShardingManager dynamicShardingManager;</span>

<span class="token comment">// åˆ›å»ºåˆ†è¡¨</span>
<span class="token comment">// dynamicShardingManager.createSpacePictureTable(space);</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å‚è€ƒæ–‡ç« " tabindex="-1"><a class="header-anchor" href="#å‚è€ƒæ–‡ç« " aria-hidden="true">#</a> å‚è€ƒæ–‡ç« </h4><ul><li>å…³äºåŠ¨æ€æ›´æ–° actual-data-nodesï¼š<a href="https://www.yuque.com/linghengqian/meve2v/cgi5en" target="_blank" rel="noopener noreferrer">https://www.yuque.com/linghengqian/meve2v/cgi5en<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li>ç›¸å…³ issueï¼š<a href="https://github.com/apache/shardingsphere/issues/21503" target="_blank" rel="noopener noreferrer">https://github.com/apache/shardingsphere/issues/21503<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li>å¼€æºç¤¾åŒºçš„è®¨è®ºï¼š<a href="https://github.com/apache/shardingsphere/discussions/12258#discussioncomment-3917927" target="_blank" rel="noopener noreferrer">https://github.com/apache/shardingsphere/discussions/12258#discussioncomment-3917927<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/tim-qtp/blog/edit/main/demo/theme-docs/src/projectessay/practicalProjects/imageLibrary/10.Team Space.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: 2469100031@qq.com">tim-qtp</span><!--]--><!--]--></div></div></footer><nav class="page-nav"><a href="/blog/projectessay/practicalProjects/imageLibrary/9.Gallery%20Analysis.html" class="nav-link prev" aria-label="å›¾åº“åˆ†æ"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->å›¾åº“åˆ†æ</div></a><a href="/blog/projectessay/practicalProjects/imageLibrary/11.Collaborative%20photo%20editing.html" class="nav-link next" aria-label="å›¾ç‰‡ååŒç¼–è¾‘"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">å›¾ç‰‡ååŒç¼–è¾‘<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">é»˜è®¤é¡µè„š</div><div class="copyright">Copyright Â© 2025 tim-qtp</div></footer></div><!--]--><!----><!----><!----><!--]--></div>
    <script type="module" src="/blog/assets/app-ea5774d5.js" defer></script>
  </body>
</html>
