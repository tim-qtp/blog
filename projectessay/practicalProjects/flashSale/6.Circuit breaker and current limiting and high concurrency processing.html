<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.61" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://tim-qtp.github.io/blog/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html"><meta property="og:site_name" content="Qtp"><meta property="og:title" content="熔断限流+高并发处理"><meta property="og:description" content="1 Sentinel限流 ​ 随着微服务的流行，服务和服务之间的稳定性变得越来越重要。 Sentinel 以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。 1.1 Sentinel介绍 Sentinel 具有以下特征: ​ Sentinel 目前已经针对 Servlet、Dubbo、Spring Boot/Spring C..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-03-05T22:19:16.000Z"><meta property="article:author" content="tim-qtp"><meta property="article:modified_time" content="2025-03-05T22:19:16.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"熔断限流+高并发处理","image":[""],"dateModified":"2025-03-05T22:19:16.000Z","author":[{"@type":"Person","name":"tim-qtp","url":"https://github.com/tim-qtp/"}]}</script><link rel="manifest" href="/blog/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"><title>熔断限流+高并发处理 | Qtp</title><meta name="description" content="1 Sentinel限流 ​ 随着微服务的流行，服务和服务之间的稳定性变得越来越重要。 Sentinel 以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。 1.1 Sentinel介绍 Sentinel 具有以下特征: ​ Sentinel 目前已经针对 Servlet、Dubbo、Spring Boot/Spring C...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/blog/assets/style-dcdd17d8.css" as="style"><link rel="stylesheet" href="/blog/assets/style-dcdd17d8.css">
    <link rel="modulepreload" href="/blog/assets/app-5615fede.js"><link rel="modulepreload" href="/blog/assets/framework-6a3aa88c.js"><link rel="modulepreload" href="/blog/assets/6.Circuit breaker and current limiting and high concurrency processing.html-68442989.js"><link rel="modulepreload" href="/blog/assets/6.Circuit breaker and current limiting and high concurrency processing.html-0d7f4e54.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button type="button" class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/blog/" class="brand"><img class="logo" src="/blog/logo.svg" alt="Qtp"><!----><span class="site-name hide-in-pad">Qtp</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/blog/" class="nav-link" aria-label="主页"><span class="font-icon icon iconfont icon-home" style=""></span>主页<!----></a></div><div class="nav-item hide-in-mobile"><a href="/blog/intro/" class="nav-link" aria-label="笔记"><span class="font-icon icon iconfont icon-discover" style=""></span>笔记<!----></a></div><div class="nav-item hide-in-mobile"><a href="/blog/life/" class="nav-link" aria-label="生活"><span class="font-icon icon iconfont icon-life" style=""></span>生活<!----></a></div><div class="nav-item hide-in-mobile"><a href="/blog/about/" class="nav-link" aria-label="关于我"><span class="font-icon icon iconfont icon-about" style=""></span>关于我<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/tim-qtp/blog" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="placeholder">搜索</div><div class="key-hints"><kbd class="key">Ctrl</kbd><kbd class="key">K</kbd></div></button><!--]--><!--[--><!----><!--]--><button type="button" class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-computer" style=""></span><span class="title">一、计算机基础</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-vscode" style=""></span><span class="title">二、前端</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-java" style=""></span><span class="title">三、Java</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-rust" style=""></span><span class="title">四、Rust</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-framework" style=""></span><span class="title">五、框架</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-microservices" style=""></span><span class="title">六、微服务中间件</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-interview" style=""></span><span class="title">七、面试</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active" type="button"><span class="font-icon icon iconfont icon-essay" style=""></span><span class="title">八、项目随笔</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-experience" style=""></span><span class="title">技术细节</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active" type="button"><span class="font-icon icon iconfont icon-project3" style=""></span><span class="title">实战项目</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-shortlink" style=""></span><span class="title">短链接</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-imageLibrary" style=""></span><span class="title">智能图库</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-logistics" style=""></span><span class="title">神领物流</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-oj" style=""></span><span class="title">刷题OJ平台</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-onlineEducation" style=""></span><span class="title">学成在线</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active" type="button"><span class="font-icon icon iconfont icon-flashSale" style=""></span><span class="title">秒杀系统</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/blog/projectessay/practicalProjects/flashSale/1.Maintenance-of-flash-sale-products.html" class="nav-link sidebar-link sidebar-page" aria-label="批量插入ES+前端优化"><!---->批量插入ES+前端优化<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/flashSale/Sporadic%20knowledge%20points.html" class="nav-link sidebar-link sidebar-page" aria-label="琐碎知识点！"><!---->琐碎知识点！<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/flashSale/2.Data%20synchronization%20and%20access%20log%20real-time%20collection.html" class="nav-link sidebar-link sidebar-page" aria-label="数据同步和访问日志实时收集"><!---->数据同步和访问日志实时收集<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/flashSale/4.Hotspot%20isolation%20and%20order%20grabbing.html" class="nav-link sidebar-link sidebar-page" aria-label="热点隔离+抢单实现"><!---->热点隔离+抢单实现<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/flashSale/5.Distributed%20transactions%20and%20distributed%20locks.html" class="nav-link sidebar-link sidebar-page" aria-label="分布式事务+分布式锁"><!---->分布式事务+分布式锁<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="熔断限流+高并发处理"><!---->熔断限流+高并发处理<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_1-sentinel限流" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1 Sentinel限流"><!---->1 Sentinel限流<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_1-1-sentinel介绍" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.1 Sentinel介绍"><!---->1.1 Sentinel介绍<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_1-2-sentinel控制台安装" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.2 Sentinel控制台安装"><!---->1.2 Sentinel控制台安装<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_1-3-sentinel案例" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.3 Sentinel案例"><!---->1.3 Sentinel案例<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_1-4-微服务网关sentinel限流" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.4 微服务网关Sentinel限流"><!---->1.4 微服务网关Sentinel限流<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_2-nginx限流" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2 nginx限流"><!---->2 nginx限流<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_2-1-生活中限流对比" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.1 生活中限流对比"><!---->2.1 生活中限流对比<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_2-2-nginx的限流" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.2 nginx的限流"><!---->2.2 nginx的限流<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_2-3-秒杀nginx限流" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.3 秒杀Nginx限流"><!---->2.3 秒杀Nginx限流<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_3-lvs-nginx集群配置" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3 Lvs+Nginx集群配置"><!---->3 Lvs+Nginx集群配置<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_3-1-lvs介绍" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.1 Lvs介绍"><!---->3.1 Lvs介绍<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_3-2-lvs工作解析模式介绍" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.2 Lvs工作解析模式介绍"><!---->3.2 Lvs工作解析模式介绍<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_3-3-lvs-dr配置" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.3 Lvs-DR配置"><!---->3.3 Lvs-DR配置<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_4-压力测试" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4. 压力测试"><!---->4. 压力测试<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_4-1-测试网络拓扑图" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.1 测试网络拓扑图"><!---->4.1 测试网络拓扑图<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_4-2-测试服务器配置" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.2 测试服务器配置"><!---->4.2 测试服务器配置<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_4-3-测试方法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.3 测试方法"><!---->4.3 测试方法<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/blog/projectessay/practicalProjects/flashSale/3.Coupon%20Flash%20Sale.html" class="nav-link sidebar-link sidebar-page" aria-label="闪券-优惠券秒杀"><!---->闪券-优惠券秒杀<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-bug" style=""></span><span class="title">bug修复</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-rocket" style=""></span><span class="title">经验教训</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-scaffold" style=""></span><span class="title">脚手架</span><span class="arrow end"></span></button><!----></section></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-github" style=""></span><span class="title">九、开源推荐</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-xiayu" style=""></span><span class="title">十、技术琐碎</span><span class="arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->熔断限流+高并发处理</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://github.com/tim-qtp/" target="_blank" rel="noopener noreferrer">tim-qtp</a></span><span property="author" content="tim-qtp"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2025-03-05T22:19:16.000Z"></span><span class="page-pageview-info" aria-label="访问量🔢" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon eye-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="eye icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z"></path></svg><span class="waline-pageview-count" id="ArtalkPV" data-path="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html">...</span></span><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 28 分钟</span><meta property="timeRequired" content="PT28M"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><span class="page-category-item category5" role>秒杀</span><span class="page-category-item category2" role>项目</span><meta property="articleSection" content="秒杀,项目"></span><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_1-sentinel限流" class="router-link-active router-link-exact-active toc-link level2">1 Sentinel限流</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_1-1-sentinel介绍" class="router-link-active router-link-exact-active toc-link level3">1.1 Sentinel介绍</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_1-2-sentinel控制台安装" class="router-link-active router-link-exact-active toc-link level3">1.2 Sentinel控制台安装</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_1-3-sentinel案例" class="router-link-active router-link-exact-active toc-link level3">1.3 Sentinel案例</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_1-4-微服务网关sentinel限流" class="router-link-active router-link-exact-active toc-link level3">1.4 微服务网关Sentinel限流</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_2-nginx限流" class="router-link-active router-link-exact-active toc-link level2">2 nginx限流</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_2-1-生活中限流对比" class="router-link-active router-link-exact-active toc-link level3">2.1 生活中限流对比</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_2-2-nginx的限流" class="router-link-active router-link-exact-active toc-link level3">2.2 nginx的限流</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_2-3-秒杀nginx限流" class="router-link-active router-link-exact-active toc-link level3">2.3 秒杀Nginx限流</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_3-lvs-nginx集群配置" class="router-link-active router-link-exact-active toc-link level2">3 Lvs+Nginx集群配置</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_3-1-lvs介绍" class="router-link-active router-link-exact-active toc-link level3">3.1 Lvs介绍</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_3-2-lvs工作解析模式介绍" class="router-link-active router-link-exact-active toc-link level3">3.2 Lvs工作解析模式介绍</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_3-3-lvs-dr配置" class="router-link-active router-link-exact-active toc-link level3">3.3 Lvs-DR配置</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_4-压力测试" class="router-link-active router-link-exact-active toc-link level2">4. 压力测试</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_4-1-测试网络拓扑图" class="router-link-active router-link-exact-active toc-link level3">4.1 测试网络拓扑图</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_4-2-测试服务器配置" class="router-link-active router-link-exact-active toc-link level3">4.2 测试服务器配置</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/projectessay/practicalProjects/flashSale/6.Circuit%20breaker%20and%20current%20limiting%20and%20high%20concurrency%20processing.html#_4-3-测试方法" class="router-link-active router-link-exact-active toc-link level3">4.3 测试方法</a></li><!----><!--]--></ul></li><!--]--></ul></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h2 id="_1-sentinel限流" tabindex="-1"><a class="header-anchor" href="#_1-sentinel限流" aria-hidden="true">#</a> 1 Sentinel限流</h2><p>​ 随着微服务的流行，服务和服务之间的稳定性变得越来越重要。 Sentinel 以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。</p><h3 id="_1-1-sentinel介绍" tabindex="-1"><a class="header-anchor" href="#_1-1-sentinel介绍" aria-hidden="true">#</a> 1.1 Sentinel介绍</h3><p>Sentinel 具有以下特征:</p><div class="language-Plaintext line-numbers-mode" data-ext="Plaintext"><pre class="language-Plaintext"><code>1.丰富的应用场景： Sentinel 承接了阿里巴巴近 10 年的双十一大促销流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、实时熔断下游不可用应用等。

2.完备的实时监控： Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。

3.广泛的开源生态： Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。

4.完善的 SPI 扩展点： Sentinel 提供简单易用、完善的 SPI 扩展点。您可以通过实现扩展点，快速的定制逻辑。例如定制规则管理、适配数据源等。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​ Sentinel 目前已经针对 Servlet、Dubbo、Spring Boot/Spring Cloud、gRPC 等进行了适配，用户只需引入相应依赖并进行简单配置即可非常方便地享受 Sentinel 的高可用流量防护能力。Sentinel 还为 Service Mesh 提供了集群流量防护的能力。未来 Sentinel 还会对更多常用框架进行适配。</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559667.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Sentinel 分为两个部分:</p><ul><li>核心库（Java 客户端）不依赖任何框架/库，能够运行于所有 Java 运行时环境，同时对 Dubbo / Spring Cloud 等框架也有较好的支持。</li><li>控制台（Dashboard）基于 Spring Boot 开发，打包后可以直接运行，不需要额外的 Tomcat 等应用容器。</li></ul><p>Sentinel 的关注点在于：</p><ul><li>多样化的流量控制</li><li>熔断降级</li><li>系统负载保护</li><li>实时监控和控制台</li></ul><p>Sentinel和Hystrix对比：</p><table><thead><tr><th></th><th>Sentinel</th><th>Hystrix</th></tr></thead><tbody><tr><td>隔离策略</td><td>信号量隔离（并发线程数限流）</td><td>线程池隔离/信号量隔离</td></tr><tr><td>熔断降级策略</td><td>基于响应时间、异常比率、异常数</td><td>基于异常比率</td></tr><tr><td>实时指标实现</td><td>滑动窗口（LeapArray）</td><td>滑动窗口（基于 RxJava）</td></tr><tr><td>规则配置</td><td>支持多种数据源</td><td>支持多种数据源</td></tr><tr><td>扩展性</td><td>多个扩展点</td><td>插件的形式</td></tr><tr><td>基于注解的支持</td><td>支持</td><td>支持</td></tr><tr><td>调用链路信息</td><td>支持同步调用</td><td>不支持</td></tr><tr><td>限流</td><td>基于 QPS / 并发数，支持基于调用关系的限流</td><td>有限支持</td></tr><tr><td>流量整形</td><td>支持慢启动、匀速器模式</td><td>不支持</td></tr><tr><td>系统负载保护</td><td>支持</td><td>不支持</td></tr><tr><td>控制台</td><td>开箱即用，可配置规则、查看秒级监控、机器发现等</td><td>较为简单</td></tr><tr><td>常见框架的适配</td><td>Servlet、Spring Cloud、Dubbo、gRPC 等</td><td>Servlet、Spring Cloud Netflix</td></tr></tbody></table><h3 id="_1-2-sentinel控制台安装" tabindex="-1"><a class="header-anchor" href="#_1-2-sentinel控制台安装" aria-hidden="true">#</a> 1.2 Sentinel控制台安装</h3><p>​ Sentinel 提供一个轻量级的开源控制台，它提供机器发现以及健康情况管理、监控（单机和集群）、规则管理和推送的功能。<code>https://github.com/alibaba/Sentinel/wiki/%E6%8E%A7%E5%88%B6%E5%8F%B0</code></p><p>Sentinel 控制台包含如下功能:</p><ul><li><strong>查看机器列表以及健康情况</strong>：收集 Sentinel 客户端发送的心跳包，用于判断机器是否在线。</li><li><strong>监控</strong> (单机和集群聚合)：通过 Sentinel 客户端暴露的监控 API，定期拉取并且聚合应用监控信息，最终可以实现秒级的实时监控。</li><li><strong>规则管理和推送</strong>：统一管理推送规则。</li><li><strong>鉴权</strong>：生产环境中鉴权非常重要。这里每个开发者需要根据自己的实际情况进行定制。</li></ul><p>1)jar包运行方式安装</p><p>Sentinel控制台下载地址：<a href="https://github.com/alibaba/Sentinel/releases" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/Sentinel/releases<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>jar包下载后，直接启动即可，启动命令如下：</p><div class="language-Shell line-numbers-mode" data-ext="Shell"><pre class="language-Shell"><code>java -Dserver.port=8858 -Dcsp.sentinel.dashboard.server=localhost:8080 -Dproject.name=sentinel-dashboard -jar sentinel-dashboard-1.7.2.jar
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>控制台访问：<a href="http://localhost:8858" target="_blank" rel="noopener noreferrer">http://localhost:8858<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 效果如下：</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559595.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>登录的账号密码都是sentinel。</p><p>2)Docker安装</p><div class="language-Shell line-numbers-mode" data-ext="Shell"><pre class="language-Shell"><code>docker pull bladex/sentinel-dashboard

docker run --name sentinel -d -p 8858:8858 -d bladex/sentinel-dashboard
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>访问<a href="http://192.168.200.188:8858/" target="_blank" rel="noopener noreferrer">http://192.168.200.188:8858/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 登录后，效果如下：</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559570.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_1-3-sentinel案例" tabindex="-1"><a class="header-anchor" href="#_1-3-sentinel案例" aria-hidden="true">#</a> 1.3 Sentinel案例</h3><p>​ 我们基于SpringCloud工程集成Sentinel，实现限流操作。为了节省时间，我们可以直接把写好的半成品案例导入到IDEA中来，将<code>资料\sentinel</code>中的sentinel工程导入进来，分别有一个生产者一个消费者和一个微服务网关。</p><p>生产者：<code>provider</code></p><p>消费者：<code>consumer</code></p><p>微服务网关：<code>gateway</code></p><h4 id="_1-3-1-基于feign的服务降级" tabindex="-1"><a class="header-anchor" href="#_1-3-1-基于feign的服务降级" aria-hidden="true">#</a> 1.3.1 基于Feign的服务降级</h4><p>​ 因为我们项目中服务之间调用使用的是feign，因此这里只讲解基于feign的服务降级实现。</p><p>1)引入依赖包：</p><p>在消费者中引入sentinel的包。</p><div class="language-XML line-numbers-mode" data-ext="XML"><pre class="language-XML"><code>&lt;!-- spring cloud alibaba sentinel 依赖 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2)Sentinel配置</p><p>​ Sentinel 适配了 Feign 组件。如果想使用，除了引入 spring-cloud-starter-alibaba-sentinel 的依赖外还需要 开启Sentinel对feign的支持，并且配置控制台信息，我们可以在bootstrap.yml中配置，配置如下：</p><div class="language-Plaintext line-numbers-mode" data-ext="Plaintext"><pre class="language-Plaintext"><code>spring:
  cloud:
    #sentinel
    sentinel:
      transport:
        port: 8719
        dashboard: 192.168.200.188:8858

#Sentinel对feign的支持
feign:
  sentinel:
    enabled: true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3)配置服务降级方法</p><p>​ 服务降级的方法就是原来springcloud中的服务降级配置，这里的配置完全是feign的配置，所以不详细讲解了。</p><p>​ 创建服务降级处理工厂对象<code>com.itheima.feign.fallback.GoodsFeignFallback</code>，代码如下：</p><div class="language-Java line-numbers-mode" data-ext="Java"><pre class="language-Java"><code>@Component
public class GoodsFeignFallback implements FallbackFactory&lt;GoodsFeign&gt; {

    @Override
    public GoodsFeign create(Throwable throwable) {
        return max -&gt; &quot;服务降级&quot;;
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​ 在feign上添加fallbackFactory指向服务降级的工厂类对象，代码如下：</p><div class="language-Java line-numbers-mode" data-ext="Java"><pre class="language-Java"><code>@FeignClient(value = &quot;goods&quot;,fallbackFactory = GoodsFeignFallback.class)
public interface GoodsFeign {

    /***
     * 获取一件商品
     */
    @GetMapping(value = &quot;/goods/one/{max}&quot;)
    String one(@PathVariable(value = &quot;max&quot;)Integer max);
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-3-2-sentinel控制台使用" tabindex="-1"><a class="header-anchor" href="#_1-3-2-sentinel控制台使用" aria-hidden="true">#</a> 1.3.2 Sentinel控制台使用</h4><p>​ 我们接着启动生产者和消费者,并访问我们的控制台：<a href="http://192.168.200.188:8858/#/dashboard/home%EF%BC%8C%E6%95%88%E6%9E%9C%E5%A6%82%E4%B8%8B%EF%BC%9A" target="_blank" rel="noopener noreferrer">http://192.168.200.188:8858/#/dashboard/home，效果如下：<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559583.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><strong>指定方法流量实时监控：</strong></p><p>选择 实时监控，再输入被访问的方法名字，就会出现指定方法访问的流量报表，如下图：</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559651.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><strong>簇点链路</strong></p><p>这块主要是单个节点中所有资源以及实时的调用数据，如下图：</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559592.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h5 id="_1-3-2-1-流量控制" tabindex="-1"><a class="header-anchor" href="#_1-3-2-1-流量控制" aria-hidden="true">#</a> 1.3.2.1 流量控制</h5><p><strong>流控：</strong></p><p>​ 在上图中，针对每个资源都有3个操作按钮，其中流控主要用于做流量控制操作，其原理是监控应用流量的 QPS 或并发线程数等指标，当达到指定的阈值时对流量进行控制，以避免被瞬时的流量高峰冲垮，从而保障应用的高可用性。</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559226.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>讲解：</p><div class="language-Plaintext line-numbers-mode" data-ext="Plaintext"><pre class="language-Plaintext"><code>resource：资源名，即限流规则的作用对象
count: 限流阈值
grade: 限流阈值类型（QPS 或并发线程数）
limitApp: 流控针对的调用来源，若为 default 则不区分调用来源
strategy: 调用关系限流策略
controlBehavior: 流量控制效果（直接拒绝、Warm Up、匀速排队）
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>流控模式：</p><div class="language-Plaintext line-numbers-mode" data-ext="Plaintext"><pre class="language-Plaintext"><code>直接（默认）：接口达到限流条件时，开启限流
关联：当关联的资源达到限流条件时，开启限流，适合做应用让步。例如为一个查询的接口添加关联流控，关联资源为一个更新的接口，当更新的接口达到阈值时，开启查询接口的限流：为更新接口让步服务器资源。
链路： 当从某个接口过来的资源达到限流条件时，开启限流。它的功能有点类似于针对来源配置项，区别在于：针对来源是针对上级微服务，而链路流控是针对上级接口，也就是说它的粒度更细
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>流控效果：</p><div class="language-Plaintext line-numbers-mode" data-ext="Plaintext"><pre class="language-Plaintext"><code>快速失败：
        当QPS超过任何规则的阈值后，新的请求就会立即拒绝，拒绝方式为抛出FlowException . 这种方式适用于对系统处理能力确切已知的情况下，比如通过压测确定了系统的准确水位时。
        
Warm Up：
        当系统长期处理低水平的情况下，当流量突然增加时，直接把系统拉升到高水位可能瞬间把系统压垮。通过&quot;冷启动&quot;，让通过的流量缓慢增加，在一定时间内逐渐增加到阈值的上限，给系统一个预热的时间，避免冷系统被压垮。
        
排队等待：
        匀速排队严格控制请求通过的时间间隔，也即是让请求以均匀的速度通过，对应的是漏桶算法。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-3-2-2-降级规则" tabindex="-1"><a class="header-anchor" href="#_1-3-2-2-降级规则" aria-hidden="true">#</a> 1.3.2.2 降级规则</h5><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559165.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>RT（慢调用比例）：</p><p>当资源的响应时间超过最大RT（以ms为单位，最大RT即最大响应时间）之后，资源进入准降级状态。如果接下来1s内持续进入5个请求（最小请求数），它们的RT都持续超过这个阈值，那么在接下来的熔断时长之内，就会对这个方法进行服务降级。其中的“比例阈值”我设置发现无效，下次编辑会重置成1</p><p>异常比例：</p><p>当资源的每秒请求数大于等于最小请求数，并且异常总数占通过量的比例超过比例阈值时，资源进入降级状态。</p><p>异常数量：</p><p>当资源近1分钟的异常数目超过阈值（异常数）之后会进行服务降级。注意由于统计时间窗口是分钟级别的，若熔断时长小于60s，则结束熔断状态后仍可能再次进入熔断状态。</p><h5 id="_1-3-2-3-热点规则" tabindex="-1"><a class="header-anchor" href="#_1-3-2-3-热点规则" aria-hidden="true">#</a> 1.3.2.3 热点规则</h5><p>​ 热点即经常访问的数据。很多时候我们希望统计某个热点数据中访问频次最高的 Top K 数据，并对其访问进行限制。</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559236.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>参数说明：</p><p>!(<a href="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559376.png" target="_blank" rel="noopener noreferrer">https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559376.png<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>)</p><h5 id="_1-3-2-4-黑白名单" tabindex="-1"><a class="header-anchor" href="#_1-3-2-4-黑白名单" aria-hidden="true">#</a> 1.3.2.4 黑白名单</h5><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559298.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>参数说明：</p><table><thead><tr><th>Field</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td>resource</td><td>资源名，即限流规则的作用对象</td><td>-</td></tr><tr><td>limitApp</td><td>对应的黑名单/白名单，不同 origin 用 <code>,</code> 分隔，如 <code>appA,appB</code></td><td>default，代表不区分调用来源</td></tr><tr><td>strategy</td><td>限制模式，<code>AUTHORITY_WHITE</code> 为白名单模式，<code>AUTHORITY_BLACK</code> 为黑名单模式，默认为白名单模式</td><td>AUTHORITY_WHITE</td></tr></tbody></table><h3 id="_1-4-微服务网关sentinel限流" tabindex="-1"><a class="header-anchor" href="#_1-4-微服务网关sentinel限流" aria-hidden="true">#</a> 1.4 微服务网关Sentinel限流</h3><p>​ 在秒杀项目中，我们需要集成Sentinel进行限流操作，有些商品目前属于非热点商品，但也有可能存在部分商品会在中途突然增加抢购热度成为热点，成为热点有可能会导致瞬间的流量膨胀，这时候我们可以采用Sentinel做限流操作，以实现对后台微服务的保护。后台秒杀我们在微服务网关进行限流操作。</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559374.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>1)引入依赖</p><p>微服务网关集成Sentinel限流，确认引入如下依赖包：</p><div class="language-XML line-numbers-mode" data-ext="XML"><pre class="language-XML"><code>&lt;!--Sentinel--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-alibaba-sentinel-gateway&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;!-- spring cloud alibaba sentinel 依赖 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2)配置控制台信息</p><p>在bootstrap.yml中配置endpoint以及控制台信息，配置如下：</p><div class="language-YAML line-numbers-mode" data-ext="YAML"><pre class="language-YAML"><code>spring:
  cloud:
    #sentinel
    sentinel:
      transport:
        port: 8719
        dashboard: 192.168.211.137:8858
        
#endpoint
management:
  endpoints:
    web:
      exposure:
        include: &#39;*&#39;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在所有的集成就成功了，我们启动微服务网关，看看Sentinel控制台也会显示微服务网关的节点信息，并且可以在控制台配置限流策略。</p><h2 id="_2-nginx限流" tabindex="-1"><a class="header-anchor" href="#_2-nginx限流" aria-hidden="true">#</a> 2 nginx限流</h2><p>一般情况下，首页的并发量是比较大的，即使 有了多级缓存，当用户不停的刷新页面的时候，也是没有必要的，另外如果有恶意的请求 大量达到，也会对系统造成影响。</p><p>而限流就是保护措施之一。</p><h3 id="_2-1-生活中限流对比" tabindex="-1"><a class="header-anchor" href="#_2-1-生活中限流对比" aria-hidden="true">#</a> 2.1 生活中限流对比</h3><ul><li>水坝泄洪，通过闸口限制洪水流量（控制流量速度）。</li><li>办理银行业务：所有人先领号，各窗口叫号处理。每个窗口处理速度根据客户具体业务而定，所有人排队等待叫号即可。若快下班时，告知客户明日再来(拒绝流量)</li><li>火车站排队买票安检，通过排队的方式依次放入。（缓存等待处理任务）</li></ul><h3 id="_2-2-nginx的限流" tabindex="-1"><a class="header-anchor" href="#_2-2-nginx的限流" aria-hidden="true">#</a> 2.2 nginx的限流</h3><p>nginx提供两种限流的方式：</p><ul><li>一是控制速率</li><li>二是控制并发连接数</li></ul><h4 id="_2-2-1-控制速率" tabindex="-1"><a class="header-anchor" href="#_2-2-1-控制速率" aria-hidden="true">#</a> 2.2.1 控制速率</h4><p>控制速率的方式之一就是采用漏桶算法。</p><p>(1)漏桶算法实现控制速率限流</p><p>漏桶(Leaky Bucket)算法思路很简单，水(请求)先进入到漏桶里，漏桶以一定的速度出水(接口有响应速率)，当水流入速度过大会直接溢出(访问频率超过接口响应速率)，然后就拒绝请求，可以看出漏桶算法能强行限制数据的传输速率，示意图如下:</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559772.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>(2)nginx的配置</p><p>配置示意图如下：</p><p>修改<code>/usr/local/openresty/nginx/conf/nginx.conf</code>:</p><div class="language-Nginx line-numbers-mode" data-ext="Nginx"><pre class="language-Nginx"><code>#限流设置   binary_remote_addr:根据请求IP进行限流  contentRateLimit:缓存空间名称 10m:缓存空间
#rate=2r/s:每秒钟允许有2个请求被处理
limit_req_zone $binary_remote_addr zone=contentRateLimit:10m rate=2r/s;

server {
    ......
    #静态页
    location /items/ {
      #限流
      limit_req zone=contentRateLimit;
      try_files $uri @np;
        } 
    ......
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置说明：</p><div class="language-Plaintext line-numbers-mode" data-ext="Plaintext"><pre class="language-Plaintext"><code>binary_remote_addr 是一种key，表示基于 remote_addr(客户端IP) 来做限流，binary_ 的目的是压缩内存占用量。
zone：定义共享内存区来存储访问信息， contentRateLimit:10m 表示一个大小为10M，名字为contentRateLimit的内存区域。1M能存储16000 IP地址的访问信息，10M可以存储16W IP地址访问信息。
rate 用于设置最大访问速率，rate=10r/s 表示每秒最多处理10个请求。Nginx 实际上以毫秒为粒度来跟踪请求信息，因此 10r/s 实际上是限制：每100毫秒处理一个请求。这意味着，自上一个请求处理完后，若后续100毫秒内又有请求到达，将拒绝处理该请求.我们这里设置成2 方便测试。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试：</p><p>重新加载配置文件</p><div class="language-Plaintext line-numbers-mode" data-ext="Plaintext"><pre class="language-Plaintext"><code>cd /usr/local/openresty/nginx/sbin

./nginx -s reload
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>访问页面：<code>http://192.168.211.137/web/items/S1235433012716498944.html</code>，连续刷新会直接报错。</p><p>(3)处理突发流量</p><p>上面例子限制 2r/s，如果有时正常流量突然增大，超出的请求将被拒绝，无法处理突发流量，可以结合 <strong>burst</strong> 参数使用来解决该问题。</p><p>配置如下：</p><div class="language-Nginx line-numbers-mode" data-ext="Nginx"><pre class="language-Nginx"><code>limit_req_zone $binary_remote_addr zone=contentRateLimit:10m rate=2r/s;
server {
    ......
    #静态页
    location /items/ {
      #限流
      limit_req zone=contentRateLimit burst=4;
      try_files $uri @np;
        } 
    ......
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>burst 译为突发、爆发，表示在超过设定的处理速率后能额外处理的请求数,当 rate=10r/s 时，将1s拆成10份，即每100ms可处理1个请求。</p><p>此处，**burst=4 **，若同时有4个请求到达，Nginx 会处理第一个请求，剩余3个请求将放入队列，然后每隔500ms从队列中获取一个请求进行处理。若请求数大于4，将拒绝处理多余的请求，直接返回503.</p><p>不过，单独使用 burst 参数并不实用。假设 burst=50 ，rate依然为10r/s，排队中的50个请求虽然每100ms会处理一个，但第50个请求却需要等待 50 * 100ms即 5s，这么长的处理时间自然难以接受。</p><p>如果请求不添加nodelay参数，服务器会对请求进行延时处理，请求过多时会有大量的tcp连接请求等待。因此，burst 往往结合 nodelay 一起使用。</p><p>配置如下：</p><div class="language-Nginx line-numbers-mode" data-ext="Nginx"><pre class="language-Nginx"><code>limit_req_zone $binary_remote_addr zone=contentRateLimit:10m rate=2r/s;
server {
    ......
    #静态页
    location /items/ {
      #限流
      limit_req zone=contentRateLimit burst=4 nodelay;
      try_files $uri @np;
        } 
    ......
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如上表示：</p><p>平均每秒允许不超过2个请求，突发不超过4个请求，并且处理突发4个请求的时候，没有延迟，等到完成之后，按照正常的速率处理。</p><p>如上两种配置结合就达到了速率稳定，但突然流量也能正常处理的效果。</p><h4 id="_2-2-2-控制并发量" tabindex="-1"><a class="header-anchor" href="#_2-2-2-控制并发量" aria-hidden="true">#</a> 2.2.2 控制并发量</h4><p>ngx_http_limit_conn_module 提供了限制连接数的能力。主要是利用limit_conn_zone和limit_conn两个指令。</p><p>利用连接数限制 某一个用户的ip连接的数量来控制流量。</p><p>注意：并非所有连接都被计算在内 只有当服务器正在处理请求并且已经读取了整个请求头时，才会计算有效连接。此处忽略测试。</p><p>配置语法：</p><div class="language-Plaintext line-numbers-mode" data-ext="Plaintext"><pre class="language-Plaintext"><code>Syntax:        limit_conn zone number;
Default: —;
Context: http, server, location;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(1)配置限制固定连接数</p><p>配置如下：</p><div class="language-Nginx line-numbers-mode" data-ext="Nginx"><pre class="language-Nginx"><code>#根据IP地址来限制，存储内存大小10M
limit_conn_zone $binary_remote_addr zone=addr:10m;

server{
   #测试
        location /user/ {
         limit_conn addr 2;
         proxy_pass http://172.16.0.235:18083;
        } 
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>表示：</p><div class="language-Plaintext line-numbers-mode" data-ext="Plaintext"><pre class="language-Plaintext"><code>limit_conn_zone $binary_remote_addr zone=addr:10m;  表示限制根据用户的IP地址来显示，设置存储地址为的内存大小10M

limit_conn addr 2;   表示 同一个地址只允许连接2次。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(2)限制每个客户端IP与服务器的连接数，同时限制与虚拟服务器的连接总数</p><p>配置如下：</p><div class="language-Nginx line-numbers-mode" data-ext="Nginx"><pre class="language-Nginx"><code>limit_conn_zone $binary_remote_addr zone=addr:10m;
limit_conn_zone $server_name zone=serv:10m; 

server{
        #测试
        location /user/ {
         limit_conn addr 2; #单个客户端ip与服务器的连接数．
         limit_conn perserver 100; #限制与服务器的总连接数
         proxy_pass http://172.16.0.235:18083;
        } 
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-秒杀nginx限流" tabindex="-1"><a class="header-anchor" href="#_2-3-秒杀nginx限流" aria-hidden="true">#</a> 2.3 秒杀Nginx限流</h3><p>​ 秒杀抢单，需要在抢单的入口进行限流，限流根据每个IP和总的并发量进行配置，配置如下：</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559770.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="_3-lvs-nginx集群配置" tabindex="-1"><a class="header-anchor" href="#_3-lvs-nginx集群配置" aria-hidden="true">#</a> 3 Lvs+Nginx集群配置</h2><h3 id="_3-1-lvs介绍" tabindex="-1"><a class="header-anchor" href="#_3-1-lvs介绍" aria-hidden="true">#</a> 3.1 Lvs介绍</h3><p>​ LVS（Linux Virtual Server）即Linux虚拟服务器，是由章文嵩博士主导的开源负载均衡项目，目前LVS已经被集成到Linux内核模块中。该项目在Linux内核中实现了基于IP的数据请求负载均衡调度方案，其体系结构如图1所示，终端互联网用户从外部访问公司的外部负载均衡服务器，终端用户的Web请求会发送给LVS调度器，调度器根据自己预设的算法决定将该请求发送给后端的某台Web服务器，比如，轮询算法可以将外部的请求平均分发给后端的所有服务器，终端用户访问LVS调度器虽然会被转发到后端真实的服务器，但如果真实服务器连接的是相同的存储，提供的服务也是相同的服务，最终用户不管是访问哪台真实服务器，得到的服务内容都是一样的，整个集群对用户而言都是透明的。</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559914.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>工作中采用Lvs集群模式：</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559886.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_3-2-lvs工作解析模式介绍" tabindex="-1"><a class="header-anchor" href="#_3-2-lvs工作解析模式介绍" aria-hidden="true">#</a> 3.2 Lvs工作解析模式介绍</h3><p>**NAT模式：**即网络地址转换</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559999.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>访问步骤：</p><div class="language-Plaintext line-numbers-mode" data-ext="Plaintext"><pre class="language-Plaintext"><code>1.用户通过互联网DNS服务器解析到公司负载均衡设备上面的外网地址，相对于真实服务器而言，LVS外网IP又称VIP（Virtual IP Address），用户通过访问VIP，即可连接后端的真实服务器（Real Server），而这一切对用户而言都是透明的，用户以为自己访问的就是真实服务器，但他并不知道自己访问的VIP仅仅是一个调度器，也不清楚后端的真实服务器到底在哪里、有多少真实服务器。

2.用户将请求发送至124.126.147.168，此时LVS将根据预设的算法选择后端的一台真实服务器（192.168.0.1~192.168.0.3），将数据请求包转发给真实服务器，并且在转发之前LVS会修改数据包中的目标地址以及目标端口，目标地址与目标端口将被修改为选出的真实服务器IP地址以及相应的端口。

3.真实的服务器将响应数据包返回给LVS调度器，调度器在得到响应的数据包后会将源地址和源端口修改为VIP及调度器相应的端口，修改完成后，由调度器将响应数据包发送回终端用户，另外，由于LVS调度器有一个连接Hash表，该表中会记录连接请求及转发信息，当同一个连接的下一个数据包发送给调度器时，从该Hash表中可以直接找到之前的连接记录，并根据记录信息选出相同的真实服务器及端口信息。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>TUN负载均衡模式（IP隧道）：</strong></p><p>​ 在LVS（NAT）模式的集群环境中，由于所有的数据请求及响应的数据包都需要经过LVS调度器转发，如果后端服务器的数量大于10台，则调度器就会成为整个集群环境的瓶颈。我们知道，数据请求包往往远小于响应数据包的大小。因为响应数据包中包含有客户需要的具体数据，所以LVS（TUN）的思路就是将请求与响应数据分离，让调度器仅处理数据请求，而让真实服务器响应数据包直接返回给客户端。VS/TUN工作模式拓扑结构如图3所示。其中，IP隧道（IP tunning）是一种数据包封装技术，它可以将原始数据包封装并添加新的包头（内容包括新的源地址及端口、目标地址及端口），从而实现将一个目标为调度器的VIP地址的数据包封装，通过隧道转发给后端的真实服务器（Real Server），通过将客户端发往调度器的原始数据包封装，并在其基础上添加新的数据包头（修改目标地址为调度器选择出来的真实服务器的IP地址及对应端口），LVS（TUN）模式要求真实服务器可以直接与外部网络连接，真实服务器在收到请求数据包后直接给客户端主机响应数据。</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559035.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><strong>DR负载均衡模式（推荐：直接路由模式）：</strong></p><p>​ 在LVS（TUN）模式下，由于需要在LVS调度器与真实服务器之间创建隧道连接，这同样会增加服务器的负担。与LVS（TUN）类似，DR模式也叫直接路由模式，其体系结构如图4所示，该模式中LVS依然仅承担数据的入站请求以及根据算法选出合理的真实服务器，最终由后端真实服务器负责将响应数据包发送返回给客户端。与隧道模式不同的是，直接路由模式（DR模式）要求调度器与后端服务器必须在同一个局域网内，VIP地址需要在调度器与后端所有的服务器间共享，因为最终的真实服务器给客户端回应数据包时需要设置源IP为VIP地址，目标IP为客户端IP，这样客户端访问的是调度器的VIP地址，回应的源地址也依然是该VIP地址（真实服务器上的VIP），客户端是感觉不到后端服务器存在的。由于多台计算机都设置了同样一个VIP地址，所以在直接路由模式中要求调度器的VIP地址是对外可见的，客户端需要将请求数据包发送到调度器主机，而所有的真实服务器的VIP地址必须配置在Non-ARP的网络设备上，也就是该网络设备并不会向外广播自己的MAC及对应的IP地址，真实服务器的VIP对外界是不可见的，但真实服务器却可以接受目标地址VIP的网络请求，并在回应数据包时将源地址设置为该VIP地址。调度器根据算法在选出真实服务器后，在不修改数据报文的情况下，将数据帧的MAC地址修改为选出的真实服务器的MAC地址，通过交换机将该数据帧发给真实服务器。整个过程中，真实服务器的VIP不需要对外界可见。</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559349.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_3-3-lvs-dr配置" tabindex="-1"><a class="header-anchor" href="#_3-3-lvs-dr配置" aria-hidden="true">#</a> 3.3 Lvs-DR配置</h3><p>​ 综合上面分析，我们可以得出结论，DR模式性能效率比较高，安全性很高，因此一般公司都推荐使用DR模式。我们这里也配置DR模式实现Lvs+Nginx集群。</p><p>参考：修改ip的命令：</p><div class="language-Bash line-numbers-mode" data-ext="Bash"><pre class="language-Bash"><code># 修改网卡配置
vi /etc/sysconfig/network-scripts/ifcfg-ens33

# 修改内容
# IPADDR=&quot;192.168.200.128&quot;
# 改为
# IPADDR=&quot;192.168.200.158&quot;

# 重启生效
systemctl restart network
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>准备3台 CentOS 7.6 的计算机，IP为： 192.168.200.156 192.168.200.157 192.168.200.158</p><p>准备使用的VIP为： 192.168.200.160</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559342.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_3-3-1-vip配置" tabindex="-1"><a class="header-anchor" href="#_3-3-1-vip配置" aria-hidden="true">#</a> 3.3.1 Vip配置</h4><p>关闭网络配置管理器(每台机器都要做)</p><div class="language-Plaintext line-numbers-mode" data-ext="Plaintext"><pre class="language-Plaintext"><code>systemctl stop NetworkManager
systemctl disable NetworkManager
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>配置虚拟IP(VIP)</p><p>在<code>192.168.200.156</code>(负载均衡调度器)的<code>/etc/sysconfig/network-scripts</code>创建文件<code>ifcfg-ens33:1</code>：</p><div class="language-Bash line-numbers-mode" data-ext="Bash"><pre class="language-Bash"><code># 创建并添加文件：
vi /etc/sysconfig/network-scripts/ifcfg-ens33:1

# 添加如下内容：
BOOTPROTO=static
DEVICE=ens33:1
ONBOOT=yes
IPADDR=192.168.200.160
NETMASK=255.255.255.0

# 重启网络服务
systemctl restart network
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以使用<code>ip addr</code>命令看到ens33网卡上面添加了一个虚拟IP 192.168.200.160：</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559460.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>同时需要对<code>192.168.200.157</code>、<code>192.168.200.158</code>构建虚拟机IP，但只是用于返回数据，而不能被用户访问到，这时候需要操作<code>ifcfg-lo</code>。</p><p>IPADDR=127.0.0.1，这里127.0.0.1属于本地回环地址，不属于任何一个有类别地址类。它代表设备的本地虚拟接口，所以默认被看作是永远不会宕掉的接口。</p><p>对<code>192.168.200.157和192.168.200.158</code>(两个应用服务器均要修改)的<code>/etc/sysconfig/network-scripts</code>中创建文件<code>ifcfg-lo:1</code>：</p><div class="language-Bash line-numbers-mode" data-ext="Bash"><pre class="language-Bash"><code># 创建并编辑文件：
vi /etc/sysconfig/network-scripts/ifcfg-lo:1

# 添加如下内容：
DEVICE=lo:1
IPADDR=192.168.200.160
NETMASK=255.255.255.255
NETWORK=127.0.0.0
BROADCAST=127.255.255.255
ONBOOT=yes
NAME=loopback

# 刷新lo，使其生效：
ifup lo
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以使用<code>ip addr</code>命令看到在lo网卡上面添加了一个虚拟IP 192.168.200.160：</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559671.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_3-3-2-lvs集群管理工具安装" tabindex="-1"><a class="header-anchor" href="#_3-3-2-lvs集群管理工具安装" aria-hidden="true">#</a> 3.3.2 LVS集群管理工具安装</h4><p>ipvsadm用于对lvs集群进行管理，需要手动安装。</p><p>在<code>192.168.200.156</code>(负载均衡调度器)中执行安装命令：</p><div class="language-Bash line-numbers-mode" data-ext="Bash"><pre class="language-Bash"><code># 安装命令：
yum install -y ipvsadm

# 查看版本：
ipvsadm -Ln
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>效果如下：</p><p>!(<a href="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559638.png" target="_blank" rel="noopener noreferrer">https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559638.png<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>)</p><p>查看集群管理命令的相关参数：<code>ipvsadm -h</code></p><h4 id="_3-3-3-arp配置-地址解析协议" tabindex="-1"><a class="header-anchor" href="#_3-3-3-arp配置-地址解析协议" aria-hidden="true">#</a> 3.3.3 ARP配置（地址解析协议）</h4><p>arp_ignore和arp_announce参数都和ARP协议相关，主要用于控制系统返回arp响应和发送arp请求时的动作。这两个参数很重要，特别是在LVS的DR场景下，它们的配置直接影响到DR转发是否正常。</p><p>arp-ignore：arp_ignore参数的作用是控制系统在收到外部的arp请求时，是否要返回arp响应（0~8，2-8用的很少）</p><ul><li>0：只要本机配置了IP，就能响应请求。</li><li>1：请求的目标地址到达对应的网络接口，才能响应对应请求</li></ul><p>arp-announce：ARP通告行为：</p><ul><li>0：本机上任何网络接口都向外通告（也就是任何请求都对用户进行响应），所有网卡都能接收通告</li><li>1：尽可能避免本网卡与不匹配的目标进行通告</li><li>2：只在本网卡进行通告（推荐）</li></ul><p>对<code>192.168.200.157和192.168.200.158</code>(两个应用服务器均要修改)的配置文件：<code>/etc/sysctl.conf</code>，添加配置信息：</p><div class="language-Bash line-numbers-mode" data-ext="Bash"><pre class="language-Bash"><code># 修改配置文件：
vi /etc/sysctl.conf

# 在配置文件最底部，添加内容：
net.ipv4.conf.all.arp_ignore = 1
net.ipv4.conf.default.arp_ignore = 1
net.ipv4.conf.lo.arp_ignore = 1
net.ipv4.conf.all.arp_announce = 2
net.ipv4.conf.default.arp_announce = 2
net.ipv4.conf.lo.arp_announce = 2

# 刷新配置
sysctl -p

# 安装路由工具
yum install -y net-tools

# 添加路由：
route add -host 192.168.200.160 dev lo
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>添加完host后，可以查看一下：<code>route -n</code>,效果如下：</p><p>!(<a href="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559802.png" target="_blank" rel="noopener noreferrer">https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559802.png<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>)</p><h4 id="_3-3-4-集群配置" tabindex="-1"><a class="header-anchor" href="#_3-3-4-集群配置" aria-hidden="true">#</a> 3.3.4 集群配置</h4><p>ipvsadm命令介绍：</p><ul><li>ipvsadm -A:用于创建集群</li><li>ipvsadm -E:用于修改集群</li><li>ipvsadm -D:用于删除集群</li><li>ipvsadm -C:用于清除集群数据</li><li>ipvsadm -R:用于重置集群配置规则</li><li>ipvsadm -S:用于保存修改的集群规则</li><li>ipvsadm -a:用于添加一个rs节点</li><li>ipvsadm -e:用于修改一个rs节点</li><li>ipvsadm -d:用于删除一个rs节点</li></ul><p>在<code>192.168.200.156</code>(负载均衡调度器)中进行集群管理配置：</p><div class="language-Bash line-numbers-mode" data-ext="Bash"><pre class="language-Bash"><code># 添加集群TCP服务地址：（外部请求由该配置指定的VIP处理）
ipvsadm -A -t 192.168.200.160:80 -s rr
#参数说明：
# -A：添加集群配置
# -t：TCP请求地址(VIP)
# -s：负载均衡算法


# 配置应用服务器rs(2个)节点：
ipvsadm -a -t 192.168.200.160:80 -r 192.168.200.157:80 -g
ipvsadm -a -t 192.168.200.160:80 -r 192.168.200.158:80 -g
# 参数说明：
# -a：给集群添加一个节点
# -t：指定VIP地址
# -r：指定real server地址
# -g：表示LVS的模式为dr模式
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>负载均衡算法：</p><table><thead><tr><th>算法</th><th>说明</th></tr></thead><tbody><tr><td>rr</td><td>轮询算法，它将请求依次分配给不同的rs节点，也就是RS节点中均摊分配。这种算法简单，但只适合于RS节点处理性能差不多的情况</td></tr><tr><td>wrr</td><td>加权轮训调度，它将依据不同RS的权值分配任务。权值较高的RS将优先获得任务，并且分配到的连接数将比权值低的RS更多。相同权值的RS得到相同数目的连接数。</td></tr><tr><td>Wlc</td><td>加权最小连接数调度，假设各台RS的全职依次为Wi，当前tcp连接数依次为Ti，依次去Ti/Wi为最小的RS作为下一个分配的RS</td></tr><tr><td>Dh</td><td>目的地址哈希调度（destination hashing）以目的地址为关键字查找一个静态hash表来获得需要的RS</td></tr><tr><td>SH</td><td>源地址哈希调度（source hashing）以源地址为关键字查找一个静态hash表来获得需要的RS</td></tr><tr><td>Lc</td><td>最小连接数调度（least-connection）,IPVS表存储了所有活动的连接。LB会比较将连接请求发送到当前连接最少的RS.</td></tr><tr><td>Lblc</td><td>基于地址的最小连接数调度（locality-based least-connection）：将来自同一个目的地址的请求分配给同一台RS，此时这台服务器是尚未满负荷的。否则就将这个请求分配给连接数最小的RS，并以它作为下一次分配的首先考虑。</td></tr></tbody></table><p>添加了节点后，我们可以通过<code>ipvsadm -Ln</code>查看，看到多了2个节点。</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559897.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>lvs有一个用户请求持久化操作，会将用户请求的数据持久化，下次请求的时候，会从持久化数据中取出来，如果有持久化数据，就按持久化数据中进行访问，没有则轮询。因此我们需要配置持久化时间。</p><p>在<code>192.168.200.156</code>(负载均衡调度器)中进行设置：(真正的lvs配置实用，不要进行如下命令执行，此处只是为了能够更快的测试效果)</p><div class="language-Bash line-numbers-mode" data-ext="Bash"><pre class="language-Bash"><code># -p 3 表示设置持久化时间为3秒
ipvsadm -E -t 192.168.200.160:80 -s rr -p 3

#设置tcp
ipvsadm --set 2 2 2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-5-效果测试" tabindex="-1"><a class="header-anchor" href="#_3-3-5-效果测试" aria-hidden="true">#</a> 3.3.5 效果测试</h4><p>参考前面课程的内容，安装Nginx，用来测试lvs的效果。</p><p>对<code>192.168.200.157和192.168.200.158</code>(两个应用服务器均要修改)执行安装命令：</p><div class="language-Bash line-numbers-mode" data-ext="Bash"><pre class="language-Bash"><code># 安装环境
yum -y install pcre-devel openssl-devel gcc curl

# 上传OpenRestry

# 解压
tar -xf openresty-1.11.2.5.tar.gz

# 进入到解压目录
cd openresty-1.11.2.5

# 安装
./configure --prefix=/usr/local/openresty \
--with-luajit \
--without-http_redis2_module \
--with-http_stub_status_module \
--with-http_v2_module \
--with-http_gzip_static_module \
--with-http_sub_module

# 编译并安装
make &amp;&amp; make install

# 修改Nginx主页，以区分不同的服务器,便于演示测试效果
vi /usr/local/openresty/nginx/html/index.html
# 在index.html中添加本机的ip地址，例如： &lt;h3&gt;192.168.200.157&lt;/h3&gt;

# 启动nginx
/usr/local/openresty/nginx/sbin/nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在浏览器中访问虚拟IP 192.168.200.160，进行访问测试。</p><p>注意：测试的时候注意间隔足够的时间，否则看不到负载均衡的效果，因为会缓存路由信息。</p><p>在<code>192.168.200.156</code>(负载均衡调度器)中，查看缓存的路由命令是<code>ipvsadm -Lnc</code> ，可以查看路由数据消失的时间：</p><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559081.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>上图中的 00:34 表示34秒之后自动消失</p><h2 id="_4-压力测试" tabindex="-1"><a class="header-anchor" href="#_4-压力测试" aria-hidden="true">#</a> 4. 压力测试</h2><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559391.jpeg" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_4-1-测试网络拓扑图" tabindex="-1"><a class="header-anchor" href="#_4-1-测试网络拓扑图" aria-hidden="true">#</a> 4.1 测试网络拓扑图</h3><figure><img src="https://qtp-1324720525.cos.ap-shanghai.myqcloud.com/blog/202503060559335.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_4-2-测试服务器配置" tabindex="-1"><a class="header-anchor" href="#_4-2-测试服务器配置" aria-hidden="true">#</a> 4.2 测试服务器配置</h3><table><thead><tr><th>性能测试环境</th><th></th></tr></thead><tbody><tr><td>Jdk版本</td><td>Jdk1.8</td></tr><tr><td>测试工具</td><td>Jmeter5.4.1</td></tr><tr><td>Jmeter负载服务器主机</td><td>2台32核64G</td></tr><tr><td>Jmeter负载服务器从机</td><td>10台16核32G</td></tr><tr><td>监控机</td><td>1台8核16G</td></tr></tbody></table><table><thead><tr><th>服务器部署环境</th><th></th></tr></thead><tbody><tr><td>Nginx服务器</td><td>4台16核32G</td></tr><tr><td>Redis服务器</td><td>1台8核16G</td></tr><tr><td>Kafka服务器</td><td>1台8核16G</td></tr><tr><td>热点订单服务器</td><td>9台8核16G</td></tr><tr><td>Mysql存储服务器</td><td>与热点订单服务器共用</td></tr><tr><td>公共微服务部署服务器</td><td>1台4核8G</td></tr></tbody></table><h3 id="_4-3-测试方法" tabindex="-1"><a class="header-anchor" href="#_4-3-测试方法" aria-hidden="true">#</a> 4.3 测试方法</h3><ol><li>正常测试：</li><li><strong>商品种类</strong>：100种</li><li><strong>商品数量</strong>：1亿个/每种，保证商品数量足够</li><li><strong>测试条件</strong>：总计5台压力机测试，每台发压200万。此时未达到秒杀系统的最大处理能力</li><li>测试目的：测试正常情况的处理情况。</li><li>前端极限测试：</li><li><strong>商品种类</strong>：100种</li><li><strong>商品数量</strong>：1000个/每种，商品数量不足</li><li><strong>测试条件</strong>：总计10台压力机测试，每台发压400万。此时达到秒杀系统的前端最大处理能力，但后端压力不大</li><li><strong>测试目的</strong>：测试大流量下，前端的处理情况。</li><li>前后端整体极限测试：</li><li><strong>商品种类</strong>：100种</li><li><strong>商品数量</strong>：1亿个/每种，商品数量足够</li><li><strong>测试条件</strong>：总计10台压力机测试，每台发压800万。此时达到秒杀系统的前后端整体的极限处理能力</li><li><strong>测试目的</strong>：测试大流量下，极端情况下的系统整体表现。</li></ol></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/tim-qtp/blog/edit/main/demo/theme-docs/src/projectessay/practicalProjects/flashSale/6.Circuit breaker and current limiting and high concurrency processing.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 2469100031@qq.com">tim-qtp</span><!--]--><!--]--></div></div></footer><nav class="page-nav"><a href="/blog/projectessay/practicalProjects/flashSale/5.Distributed%20transactions%20and%20distributed%20locks.html" class="nav-link prev" aria-label="分布式事务+分布式锁"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->分布式事务+分布式锁</div></a><a href="/blog/projectessay/practicalProjects/flashSale/3.Coupon%20Flash%20Sale.html" class="nav-link next" aria-label="闪券-优惠券秒杀"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">闪券-优惠券秒杀<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">默认页脚</div><div class="copyright">Copyright © 2025 tim-qtp</div></footer></div><!--]--><!----><!----><!----><!--]--></div>
    <script type="module" src="/blog/assets/app-5615fede.js" defer></script>
  </body>
</html>
